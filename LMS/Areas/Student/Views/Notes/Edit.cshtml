@model StudentNoteEditViewModel
@{
    ViewData["Title"] = Html.T("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "Edit Note");
}

@section Styles {
<style>
    .edit-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .lesson-context {
        background: #eff6ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 24px;
        border-right: 4px solid #3b82f6;
    }
    
    .edit-card {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-control, .form-textarea {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px 16px;
        transition: all 0.3s ease;
        font-size: 15px;
    }
    
    .form-control:focus, .form-textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    .form-textarea {
        min-height: 250px;
        resize: vertical;
        line-height: 1.8;
        font-family: 'Cairo', sans-serif;
    }
    
    .color-picker {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .color-option {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .color-option:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .color-option.selected {
        border-color: #1f2937;
        transform: scale(1.15);
    }
    
    .color-option.selected::after {
        content: "âœ“";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: 700;
        font-size: 20px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .color-yellow { background: #fbbf24; }
    .color-green { background: #10b981; }
    .color-blue { background: #3b82f6; }
    .color-purple { background: #8b5cf6; }
    .color-pink { background: #ec4899; }
    .color-orange { background: #f97316; }
    .color-red { background: #ef4444; }
    .color-gray { background: #6b7280; }
    
    .timestamp-input-group {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .timestamp-input {
        max-width: 150px;
    }
    
    .timestamp-help {
        color: #6b7280;
        font-size: 13px;
        margin-top: 4px;
    }
    
    .pin-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f9fafb;
        padding: 16px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb;
    }
    
    .pin-toggle:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .pin-toggle.active {
        background: #fef3c7;
        border-color: #fbbf24;
    }
    
    .pin-icon {
        font-size: 24px;
        color: #6b7280;
        transition: color 0.3s ease;
    }
    
    .pin-toggle.active .pin-icon {
        color: #f59e0b;
    }
    
    .toolbar {
        display: flex;
        gap: 8px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .toolbar-btn {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }
    
    .toolbar-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        padding: 14px 36px;
        font-weight: 600;
        border-radius: 10px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        color: white;
    }
    
    .btn-delete {
        background: #fef2f2;
        border: 2px solid #fee2e2;
        color: #dc2626;
        padding: 14px 36px;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .btn-delete:hover {
        background: #dc2626;
        border-color: #dc2626;
        color: white;
    }
    
    .note-meta {
        background: #f9fafb;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 24px;
        font-size: 14px;
        color: #6b7280;
    }
    
    .version-history {
        background: #f0f9ff;
        border-radius: 10px;
        padding: 16px;
        margin-top: 24px;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="edit-header">
    <div class="d-flex align-items-center">
        <i class="feather-edit" style="font-size: 36px; margin-left: 16px;"></i>
        <div>
            <h2 class="mb-2">@Html.T("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "Edit Note")</h2>
            <p class="mb-0 opacity-75">@Html.T("Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ÙˆØªØ­Ø³ÙŠÙ† Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ", "Update and improve your notes")</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="edit-card">
            <!-- Lesson Context -->
            <div class="lesson-context">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <i class="feather-book text-info" style="font-size: 24px;"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-info mb-1">@Html.T("Ø§Ù„Ø¯Ø±Ø³", "Lesson")</h6>
                        <p class="mb-1"><strong>@Model.LessonTitle</strong></p>
                        <p class="mb-0 text-muted small">
                            <i class="feather-folder me-1"></i>
                            @Model.CourseTitle
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Note Metadata -->
            <div class="note-meta">
                <div class="row g-3">
                    <div class="col-md-6">
                        <i class="feather-calendar me-2"></i>
                        <strong>@Html.T("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:", "Created:")</strong> @DateTime.Now.ToString("dd MMM yyyy")
                    </div>
                    <div class="col-md-6">
                        <i class="feather-clock me-2"></i>
                        <strong>@Html.T("Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„:", "Last modified:")</strong> @DateTime.Now.ToString("dd MMM yyyy")
                    </div>
                </div>
            </div>
            
            <!-- Edit Form -->
            <form asp-action="Edit" asp-controller="Notes" method="post" id="editNoteForm">
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="LessonId" />
                
                <!-- Note Content -->
                <div class="mb-4">
                    <label asp-for="Content" class="form-label">
                        <i class="feather-file-text text-primary"></i>
                        @Html.T("Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© *", "Note content *")
                    </label>
                    
                    <!-- Text Formatting Toolbar -->
                    <div class="toolbar">
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('ğŸ“Œ')" title="@Html.T("Ø¯Ø¨ÙˆØ³", "Pin")">ğŸ“Œ</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('âœ“')" title="@Html.T("ØµØ­", "Check")">âœ“</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('âœ—')" title="@Html.T("Ø®Ø·Ø£", "Cross")">âœ—</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('â†’')" title="@Html.T("Ø³Ù‡Ù…", "Arrow")">â†’</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('â˜…')" title="@Html.T("Ù†Ø¬Ù…Ø©", "Star")">â˜…</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('ğŸ’¡')" title="@Html.T("ÙÙƒØ±Ø©", "Idea")">ğŸ’¡</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('â“')" title="@Html.T("Ø³Ø¤Ø§Ù„", "Question")">â“</button>
                        <button type="button" class="toolbar-btn" onclick="insertSymbol('âš ï¸')" title="@Html.T("ØªØ­Ø°ÙŠØ±", "Warning")">âš ï¸</button>
                    </div>
                    
                    <textarea asp-for="Content" 
                              class="form-control form-textarea" 
                              id="noteContent"
                              required></textarea>
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>
                
                <!-- Video Timestamp -->
                <div class="mb-4">
                    <label asp-for="VideoTimestamp" class="form-label">
                        <i class="feather-clock text-info"></i>
                        @Html.T("Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", "Video time (optional)")
                    </label>
                    <div class="timestamp-input-group">
                        <input asp-for="VideoTimestamp" 
                               type="number" 
                               class="form-control timestamp-input" 
                               placeholder="@Html.T("Ø«ÙˆØ§Ù†ÙŠ", "seconds")"
                               min="0"
                               id="timestampInput">
                        <span class="text-muted">@Html.T("Ø«Ø§Ù†ÙŠØ©", "sec")</span>
                        @if (Model.VideoTimestamp.HasValue)
                        {
                            <span class="badge bg-info">
                                @TimeSpan.FromSeconds(Model.VideoTimestamp.Value).ToString(@"mm\:ss")
                            </span>
                        }
                    </div>
                    <div class="timestamp-help">
                        <i class="feather-info me-1"></i>
                        @Html.T("Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¬Ø²Ø¡ Ù…Ø¹ÙŠÙ† Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Time in seconds to link note to a specific part of the video")
                    </div>
                    <span asp-validation-for="VideoTimestamp" class="text-danger"></span>
                </div>
                
                <!-- Highlight Color -->
                <div class="mb-4">
                    <label asp-for="HighlightColor" class="form-label">
                        <i class="feather-droplet text-warning"></i>
                        @Html.T("Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", "Highlight color (optional)")
                    </label>
                    <div class="color-picker">
                        <input type="hidden" asp-for="HighlightColor" id="highlightColorInput" value="@Model.HighlightColor">
                        <div class="color-option color-yellow @(Model.HighlightColor == "Yellow" ? "selected" : "")" data-color="Yellow" onclick="selectColor(this, 'Yellow')"></div>
                        <div class="color-option color-green @(Model.HighlightColor == "Green" ? "selected" : "")" data-color="Green" onclick="selectColor(this, 'Green')"></div>
                        <div class="color-option color-blue @(Model.HighlightColor == "Blue" || string.IsNullOrEmpty(Model.HighlightColor) ? "selected" : "")" data-color="Blue" onclick="selectColor(this, 'Blue')"></div>
                        <div class="color-option color-purple @(Model.HighlightColor == "Purple" ? "selected" : "")" data-color="Purple" onclick="selectColor(this, 'Purple')"></div>
                        <div class="color-option color-pink @(Model.HighlightColor == "Pink" ? "selected" : "")" data-color="Pink" onclick="selectColor(this, 'Pink')"></div>
                        <div class="color-option color-orange @(Model.HighlightColor == "Orange" ? "selected" : "")" data-color="Orange" onclick="selectColor(this, 'Orange')"></div>
                        <div class="color-option color-red @(Model.HighlightColor == "Red" ? "selected" : "")" data-color="Red" onclick="selectColor(this, 'Red')"></div>
                        <div class="color-option color-gray @(Model.HighlightColor == "Gray" ? "selected" : "")" data-color="Gray" onclick="selectColor(this, 'Gray')"></div>
                    </div>
                    <span asp-validation-for="HighlightColor" class="text-danger"></span>
                </div>
                
                <!-- Pin Note -->
                <div class="mb-4">
                    <label class="pin-toggle @(Model.IsPinned ? "active" : "")" id="pinToggle" onclick="togglePin()">
                        <input type="checkbox" asp-for="IsPinned" id="isPinnedInput" style="display: none;">
                        <div class="pin-icon">
                            <i class="feather-thumbtack"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">@Html.T("ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "Pin note")</h6>
                            <small class="text-muted">@Html.T("Ø§Ø¬Ø¹Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø§Ø¦Ù…Ø§Ù‹", "Keep this note at the top")</small>
                        </div>
                    </label>
                    <span asp-validation-for="IsPinned" class="text-danger"></span>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-save flex-grow-1">
                        <i class="feather-save me-2"></i>
                        @Html.T("Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª", "Save changes")
                    </button>
                    <a href="@Url.Action("Index", "Notes", new { lessonId = Model.LessonId })" class="btn btn-outline-secondary">
                        <i class="feather-x me-2"></i>
                        @Html.T("Ø¥Ù„ØºØ§Ø¡", "Cancel")
                    </a>
                </div>
            </form>
            
            <!-- Delete Button (Separate Form) -->
            <form asp-action="Delete" asp-controller="Notes" method="post" id="deleteForm" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="button" class="btn btn-delete w-100" onclick="confirmDelete()">
                    <i class="feather-trash-2 me-2"></i>
                    @Html.T("Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "Delete note")
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Stats -->
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="feather-bar-chart-2 text-info me-2"></i>
                    @Html.T("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©", "Note info")
                </h6>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">@Html.T("Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:", "Words:")</span>
                    <strong id="wordCount">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">@Html.T("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù:", "Characters:")</span>
                    <strong id="charCount">0</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">@Html.T("Ø§Ù„Ø­Ø§Ù„Ø©:", "Status:")</span>
                    <span class="badge bg-success">@Html.T("Ù…Ø­ÙÙˆØ¸Ø©", "Saved")</span>
                </div>
            </div>
        </div>
        
        <!-- Tips -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="feather-lightbulb text-warning me-2"></i>
                    @Html.T("Ù†ØµØ§Ø¦Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„", "Edit tips")
                </h6>
                <ul class="mb-0 small">
                    <li class="mb-2">@Html.T("Ø±Ø§Ø¬Ø¹ ÙˆØ­Ø³Ù‘Ù† Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ù…", "Review and improve your notes regularly")</li>
                    <li class="mb-2">@Html.T("Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø© ØªØ¹Ù„Ù…ØªÙ‡Ø§", "Add new details you learned")</li>
                    <li class="mb-2">@Html.T("ØºÙŠÙ‘Ø± Ø§Ù„Ù„ÙˆÙ† Ù„ØªÙ†Ø¸ÙŠÙ… Ø£ÙØ¶Ù„", "Change color for better organization")</li>
                    <li class="mb-2">@Html.T("Ø«Ø¨Ù‘Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©", "Pin important notes")</li>
                    <li>@Html.T("Ø§Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙÙŠØ¯Ø©", "Delete unhelpful notes")</li>
                </ul>
            </div>
        </div>
        
        <!-- Shortcuts -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="feather-command text-primary me-2"></i>
                    @Html.T("Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­", "Keyboard shortcuts")
                </h6>
                <table class="table table-sm mb-0">
                    <tr>
                        <td><kbd>Ctrl</kbd> + <kbd>S</kbd></td>
                        <td>@Html.T("Ø­ÙØ¸", "Save")</td>
                    </tr>
                    <tr>
                        <td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td>
                        <td>@Html.T("ØªØ±Ø§Ø¬Ø¹", "Undo")</td>
                    </tr>
                    <tr>
                        <td><kbd>Esc</kbd></td>
                        <td>@Html.T("Ø¥Ù„ØºØ§Ø¡", "Cancel")</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
<script>
    const textarea = document.getElementById('noteContent');
    const originalValue = textarea.value;
    let formChanged = false;
    
    // Color selection
    function selectColor(element, color) {
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        document.getElementById('highlightColorInput').value = color;
        formChanged = true;
    }
    
    // Pin toggle
    function togglePin() {
        const toggle = document.getElementById('pinToggle');
        const input = document.getElementById('isPinnedInput');
        
        toggle.classList.toggle('active');
        input.checked = !input.checked;
        formChanged = true;
    }
    
    // Insert symbol at cursor position
    function insertSymbol(symbol) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        
        textarea.value = text.substring(0, start) + symbol + ' ' + text.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + symbol.length + 1;
        formChanged = true;
        updateStats();
    }
    
    // Update word and character count
    function updateStats() {
        const text = textarea.value;
        document.getElementById('charCount').textContent = text.length;
        document.getElementById('wordCount').textContent = text.trim().split(/\s+/).filter(w => w.length > 0).length;
    }
    
    // Initialize stats
    updateStats();
    
    // Listen for changes
    textarea.addEventListener('input', () => {
        formChanged = textarea.value !== originalValue;
        updateStats();
    });
    
    // Confirm delete
    function confirmDelete() {
        if (confirm('@Html.Raw(Html.T("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.", "Are you sure you want to delete this note?\nThis action cannot be undone.").Replace("'", "\\'").Replace("\n", "\\n"))')) {
            document.getElementById('deleteForm').submit();
        }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('editNoteForm').submit();
        }
        
        // Esc to cancel
        if (e.key === 'Escape') {
            if (!formChanged || confirm('@Html.Raw(Html.T("Ù„Ø¯ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ", "You have unsaved changes. Do you want to continue?").Replace("'", "\\'"))')) {
                window.location.href = '@Url.Action("Index", "Notes", new { lessonId = Model.LessonId })';
            }
        }
    });
    
    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    document.getElementById('editNoteForm').addEventListener('submit', () => {
        formChanged = false;
    });
    
    document.getElementById('deleteForm').addEventListener('submit', () => {
        formChanged = false;
    });
</script>
}
