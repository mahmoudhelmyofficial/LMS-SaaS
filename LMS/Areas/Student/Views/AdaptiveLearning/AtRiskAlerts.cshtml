@model List<LMS.Services.Interfaces.AtRiskAlert>
@{
    ViewData["Title"] = Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±", "At-Risk Alerts");
}

<style>
    .alert-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-right: 6px solid;
        transition: all 0.3s ease;
    }
    
    .alert-card:hover {
        transform: translateX(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    
    .alert-card.critical { border-color: #ef4444; background: linear-gradient(to left, white 0%, #fef2f2 100%); }
    .alert-card.high { border-color: #f97316; background: linear-gradient(to left, white 0%, #fff7ed 100%); }
    .alert-card.medium { border-color: #fbbf24; background: linear-gradient(to left, white 0%, #fef3c7 100%); }
    .alert-card.low { border-color: #3b82f6; background: linear-gradient(to left, white 0%, #dbeafe 100%); }
    
    .risk-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin-left: auto;
    }
    
    .risk-icon.critical { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .risk-icon.high { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .risk-icon.medium { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
    .risk-icon.low { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    
    .stat-mini {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #f9fafb;
        border-radius: 20px;
        margin-left: 8px;
        font-size: 13px;
    }
    
    .progress-mini {
        height: 6px;
        background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
    }
    
    .no-alerts {
        text-align: center;
        padding: 80px 20px;
    }
    
    .action-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .timeline-item {
        position: relative;
        padding-right: 40px;
        padding-bottom: 24px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        right: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    .timeline-dot {
        position: absolute;
        right: 6px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .filter-chip {
        display: inline-block;
        padding: 8px 16px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    
    .filter-chip:hover {
        border-color: #667eea;
        background: #f3f4f6;
    }
    
    .filter-chip.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>

<!-- Page Header -->
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="mb-2">
                <i class="feather-alert-triangle text-danger me-2"></i>
                @Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±", "At-Risk Alerts")
            </h3>
            <p class="text-muted mb-0">@Html.T("ØªØ­Ø°ÙŠØ±Ø§Øª Ù…Ø¨ÙƒØ±Ø© Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­", "Early warnings to help you stay on track")</p>
        </div>
        <div>
            <button class="btn btn-outline-primary" onclick="refreshAlerts()">
                <i class="feather-refresh-cw me-2"></i>
                @Html.T("ØªØ­Ø¯ÙŠØ«", "Refresh")
            </button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="d-flex flex-wrap">
        <span class="filter-chip active" data-filter="all">
            <i class="feather-list me-1"></i> @Html.T("Ø§Ù„ÙƒÙ„", "All") (@Model.Count)
        </span>
        <span class="filter-chip" data-filter="critical">
            <i class="feather-x-circle me-1"></i> @Html.T("Ø­Ø±Ø¬", "Critical") (@Model.Count(a => a.Severity == "Critical"))
        </span>
        <span class="filter-chip" data-filter="high">
            <i class="feather-alert-circle me-1"></i> @Html.T("Ø¹Ø§Ù„ÙŠ", "High") (@Model.Count(a => a.Severity == "High"))
        </span>
        <span class="filter-chip" data-filter="medium">
            <i class="feather-info me-1"></i> @Html.T("Ù…ØªÙˆØ³Ø·", "Medium") (@Model.Count(a => a.Severity == "Medium"))
        </span>
        <span class="filter-chip" data-filter="low">
            <i class="feather-check-circle me-1"></i> @Html.T("Ù…Ù†Ø®ÙØ¶", "Low") (@Model.Count(a => a.Severity == "Low"))
        </span>
    </div>
</div>

@if (Model == null || !Model.Any())
{
    <!-- No Alerts State -->
    <div class="no-alerts">
        <div class="mb-4">
            <div style="font-size: 120px; line-height: 1;">ğŸ‰</div>
        </div>
        <h3 class="mb-3">@Html.T("Ù…Ù…ØªØ§Ø²! Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", "Great! No alerts")</h3>
        <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
            @Html.T("Ø£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ±Ø§ØªÙƒ. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø§Ø¦Ø¹!", "You're on track in all your courses. Keep up the great work!")
        </p>
        <a href="@Url.Action("Index", "Courses")" class="btn btn-primary">
            <i class="feather-arrow-right me-2"></i>
            @Html.T("ØªØµÙØ­ Ø¯ÙˆØ±Ø§ØªÙŠ", "Browse my courses")
        </a>
    </div>
}
else
{
    <!-- Summary Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-danger" style="border-width: 2px; border-radius: 12px;">
                <div class="card-body text-center">
                    <i class="feather-alert-octagon text-danger mb-2" style="font-size: 32px;"></i>
                    <h3 class="text-danger mb-1">@Model.Count(a => a.Severity == "Critical")</h3>
                    <p class="text-muted small mb-0">@Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø±Ø¬Ø©", "Critical alerts")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning" style="border-width: 2px; border-radius: 12px;">
                <div class="card-body text-center">
                    <i class="feather-alert-triangle text-warning mb-2" style="font-size: 32px;"></i>
                    <h3 class="text-warning mb-1">@Model.Count(a => a.Severity == "High")</h3>
                    <p class="text-muted small mb-0">@Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ù„ÙŠØ©", "High alerts")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary" style="border-width: 2px; border-radius: 12px;">
                <div class="card-body text-center">
                    <i class="feather-info text-primary mb-2" style="font-size: 32px;"></i>
                    <h3 class="text-primary mb-1">@Model.Count(a => a.Severity == "Medium")</h3>
                    <p class="text-muted small mb-0">@Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ØªÙˆØ³Ø·Ø©", "Medium alerts")</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info" style="border-width: 2px; border-radius: 12px;">
                <div class="card-body text-center">
                    <i class="feather-check-circle text-info mb-2" style="font-size: 32px;"></i>
                    <h3 class="text-info mb-1">@Model.Count(a => a.Severity == "Low")</h3>
                    <p class="text-muted small mb-0">@Html.T("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©", "Low alerts")</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alerts List -->
    <div class="alerts-container">
        @foreach (var alert in Model.OrderByDescending(a => a.Severity))
        {
            var severityClass = alert.Severity.ToLower();
            var severityIcon = alert.Severity == "Critical" ? "x-circle" :
                              alert.Severity == "High" ? "alert-circle" :
                              alert.Severity == "Medium" ? "info" : "check-circle";
            var severityColor = alert.Severity == "Critical" ? "#ef4444" :
                               alert.Severity == "High" ? "#f97316" :
                               alert.Severity == "Medium" ? "#fbbf24" : "#3b82f6";
            
            <div class="alert-card @severityClass" data-severity="@severityClass">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <!-- Alert Header -->
                        <div class="d-flex align-items-start mb-3">
                            <div class="me-3">
                                <div class="risk-icon @severityClass">
                                    <i class="feather-@severityIcon text-white"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="mb-0 me-2">@alert.CourseName</h5>
                                    <span class="badge" style="background: @severityColor;">@alert.Severity</span>
                                </div>
                                <p class="text-muted mb-0">@alert.Message</p>
                            </div>
                        </div>
                        
                        <!-- Alert Details -->
                        <div class="mb-3">
                            <div class="d-flex flex-wrap gap-2">
                                @if (alert.DaysInactive > 0)
                                {
                                    <span class="stat-mini">
                                        <i class="feather-calendar text-danger me-2"></i>
                                        @alert.DaysInactive @Html.T("Ø£ÙŠØ§Ù… Ø¨Ø¯ÙˆÙ† Ù†Ø´Ø§Ø·", "days inactive")
                                    </span>
                                }
                                @if (alert.MissedDeadlines > 0)
                                {
                                    <span class="stat-mini">
                                        <i class="feather-clock text-warning me-2"></i>
                                        @alert.MissedDeadlines @Html.T("Ù…ÙˆØ¹Ø¯ ÙØ§Ø¦Øª", "missed deadline(s)")
                                    </span>
                                }
                                @if (alert.LowQuizScores > 0)
                                {
                                    <span class="stat-mini">
                                        <i class="feather-trending-down text-danger me-2"></i>
                                        @alert.LowQuizScores @Html.T("Ø§Ø®ØªØ¨Ø§Ø± Ø¶Ø¹ÙŠÙ", "low quiz score(s)")
                                    </span>
                                }
                                <span class="stat-mini">
                                    <i class="feather-activity text-primary me-2"></i>
                                    @Html.T("ØªÙ‚Ø¯Ù…:", "Progress:") @alert.ProgressPercentage%
                                </span>
                            </div>
                            <div class="progress-mini">
                                <div style="width: @alert.ProgressPercentage%; background: @severityColor; height: 100%;"></div>
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        @if (alert.Recommendations != null && alert.Recommendations.Any())
                        {
                            <div class="mb-3">
                                <h6 class="mb-2">
                                    <i class="feather-lightbulb text-warning me-2"></i>
                                    @Html.T("ØªÙˆØµÙŠØ§Øª Ù„Ù„ØªØ­Ø³ÙŠÙ†:", "Improvement recommendations:")
                                </h6>
                                <ul class="list-unstyled mb-0">
                                    @foreach (var recommendation in alert.Recommendations)
                                    {
                                        <li class="mb-1">
                                            <i class="feather-chevron-left text-primary me-2"></i>
                                            @recommendation
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        
                        <!-- Actions -->
                        <div class="d-flex flex-wrap gap-2">
                            <a href="@Url.Action("Details", "Courses", new { id = alert.EnrollmentId })" class="btn btn-sm btn-primary action-btn">
                                <i class="feather-eye me-2"></i>
                                @Html.T("Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±Ø©", "View course")
                            </a>
                            <a href="@Url.Action("CourseAnalytics", "AdaptiveLearning", new { enrollmentId = alert.EnrollmentId })" class="btn btn-sm btn-outline-primary action-btn">
                                <i class="feather-bar-chart-2 me-2"></i>
                                @Html.T("ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡", "Performance analytics")
                            </a>
                            <button class="btn btn-sm btn-outline-success action-btn" onclick="createStudyPlan(@alert.EnrollmentId)">
                                <i class="feather-calendar me-2"></i>
                                @Html.T("Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¯Ø±Ø§Ø³ÙŠØ©", "Create study plan")
                            </button>
                            <button class="btn btn-sm btn-outline-secondary action-btn" onclick="dismissAlert(@alert.AlertId)">
                                <i class="feather-x me-2"></i>
                                @Html.T("ØªØ¬Ø§Ù‡Ù„", "Dismiss")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Action Panel -->
    <div class="row g-4 mt-4">
        <div class="col-lg-4">
            <div class="card" style="border-radius: 16px; border: 2px solid #667eea;">
                <div class="card-body text-center p-4">
                    <i class="feather-book-open text-primary mb-3" style="font-size: 48px;"></i>
                    <h5 class="mb-2">@Html.T("Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯Ø©", "Get help")</h5>
                    <p class="text-muted small mb-3">@Html.T("ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹Ù…", "Contact the course instructor for support")</p>
                    <button class="btn btn-primary w-100">
                        <i class="feather-message-circle me-2"></i>
                        @Html.T("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©", "Send message")
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card" style="border-radius: 16px; border: 2px solid #22c55e;">
                <div class="card-body text-center p-4">
                    <i class="feather-users text-success mb-3" style="font-size: 48px;"></i>
                    <h5 class="mb-2">@Html.T("Ø§Ù†Ø¶Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¯Ø±Ø§Ø³ÙŠØ©", "Join a study group")</h5>
                    <p class="text-muted small mb-3">@Html.T("ØªØ¹Ù„Ù… Ù…Ø¹ Ø·Ù„Ø§Ø¨ Ø¢Ø®Ø±ÙŠÙ† ÙÙŠ Ù†ÙØ³ ÙˆØ¶Ø¹Ùƒ", "Learn with other students in your situation")</p>
                    <button class="btn btn-success w-100">
                        <i class="feather-plus me-2"></i>
                        @Html.T("Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù…ÙˆØ¹Ø©", "Find a group")
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card" style="border-radius: 16px; border: 2px solid #fbbf24;">
                <div class="card-body text-center p-4">
                    <i class="feather-target text-warning mb-3" style="font-size: 48px;"></i>
                    <h5 class="mb-2">@Html.T("Ø­Ø¯Ø¯ Ø£Ù‡Ø¯Ø§ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø©", "Set new goals")</h5>
                    <p class="text-muted small mb-3">@Html.T("Ø¶Ø¹ Ø®Ø·Ø© ÙˆØ§Ø¶Ø­Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¦Ùƒ", "Create a clear plan to improve your performance")</p>
                    <button class="btn btn-warning w-100">
                        <i class="feather-edit me-2"></i>
                        @Html.T("Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø©", "Create plan")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    // Filter functionality
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            // Filter alerts
            document.querySelectorAll('.alert-card').forEach(card => {
                if (filter === 'all' || card.dataset.severity === filter) {
                    card.style.display = 'block';
                    setTimeout(() => card.style.opacity = '1', 10);
                } else {
                    card.style.opacity = '0';
                    setTimeout(() => card.style.display = 'none', 300);
                }
            });
        });
    });
    
    function refreshAlerts() {
        location.reload();
    }
    
    function dismissAlert(alertId) {
        if (confirm('@Html.Raw(Html.T("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ØŸ", "Are you sure you want to dismiss this alert?").Replace("'", "\\'"))')) {
            // AJAX call to dismiss alert
            fetch(`/Student/AdaptiveLearning/DismissAlert/${alertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }
    
    function createStudyPlan(enrollmentId) {
        window.location.href = `/Student/StudyPlanner/GeneratePlan?enrollmentId=${enrollmentId}`;
    }
</script>
}
