@model LMS.Domain.Entities.Social.StudyGroup
@{
    ViewData["Title"] = Model.Name;
    var isMember = (bool)(ViewBag.IsMember ?? false);
    var isCreator = (bool)(ViewBag.IsCreator ?? false);
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="avatar-text avatar-xl bg-soft-success text-success">
                        <i class="feather-users"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-1">@Model.Name</h3>
                        <p class="text-muted mb-0">
                            <i class="feather-book-open me-1"></i>
                            @Model.Course?.Title
                        </p>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="text-muted">@Model.Description</p>
                }
            </div>
            <div class="col-lg-4 text-lg-end">
                @if (isMember && !isCreator)
                {
                    <form asp-action="Leave" method="post" class="d-inline">
                        <input type="hidden" name="groupId" value="@Model.Id" />
                        <button type="submit" class="btn btn-outline-danger" 
                                onclick="return confirm('@Html.Raw(Html.T("هل تريد مغادرة هذه المجموعة؟", "Do you want to leave this group?").ToString().Replace("'", "\\'"))')">
                            <i class="feather-log-out me-2"></i>
                            @Html.T("مغادرة المجموعة", "Leave group")
                        </button>
                    </form>
                }
                else if (!isMember)
                {
                    <form asp-action="Join" method="post" class="d-inline">
                        <input type="hidden" name="groupId" value="@Model.Id" />
                        <button type="submit" class="btn btn-primary">
                            <i class="feather-user-plus me-2"></i>
                            @Html.T("انضمام", "Join")
                        </button>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<!-- Group Info -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card stretch stretch-full">
            <div class="card-body text-center">
                <div class="avatar-text avatar-lg bg-soft-primary text-primary mx-auto mb-3">
                    <i class="feather-users"></i>
                </div>
                <h3 class="fw-bold mb-0">@Model.Members.Count</h3>
                <p class="text-muted mb-0">@Html.T("عضو", "Member")</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stretch stretch-full">
            <div class="card-body text-center">
                <div class="avatar-text avatar-lg bg-soft-success text-success mx-auto mb-3">
                    <i class="feather-user"></i>
                </div>
                <h6 class="fw-bold mb-0">@Model.Creator?.FullName</h6>
                <p class="text-muted mb-0">@Html.T("المنشئ", "Creator")</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stretch stretch-full">
            <div class="card-body text-center">
                <div class="avatar-text avatar-lg bg-soft-warning text-warning mx-auto mb-3">
                    <i class="feather-calendar"></i>
                </div>
                <h6 class="fw-bold mb-0">@Model.CreatedAt.ToString("dd/MM/yyyy")</h6>
                <p class="text-muted mb-0">@Html.T("تاريخ الإنشاء", "Created on")</p>
            </div>
        </div>
    </div>
</div>

<!-- Members List -->
<div class="card stretch stretch-full">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="feather-users text-primary me-2"></i>
            @Html.T("الأعضاء", "Members") (@Model.Members.Count)
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            @foreach (var member in Model.Members.OrderBy(m => m.JoinedAt))
            {
                <div class="col-lg-4 col-md-6">
                    <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
                        <div class="avatar-text avatar-md bg-soft-primary text-primary">
                            @if (!string.IsNullOrEmpty(member.User?.ProfilePictureUrl))
                            {
                                <img src="@member.User.ProfilePictureUrl" class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;" />
                            }
                            else
                            {
                                <i class="feather-user"></i>
                            }
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-0">@member.User?.FullName</h6>
                            <small class="text-muted">
                                @(member.Role == GroupRole.Admin || member.Role == GroupRole.Owner ? Html.T("مسؤول", "Admin") : Html.T("عضو", "Member"))
                            </small>
                        </div>
                        @if (member.Role == GroupRole.Admin || member.Role == GroupRole.Owner)
                        {
                            <span class="badge bg-warning text-dark">@Html.T("مسؤول", "Admin")</span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-action="Index" class="btn btn-outline-primary">
        <i class="feather-arrow-right me-2"></i>
        @Html.T("العودة للمجموعات", "Back to groups")
    </a>
</div>

