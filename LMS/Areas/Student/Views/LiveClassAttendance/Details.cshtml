@model LMS.Domain.Entities.LiveSessions.LiveClassAttendance
@{
    ViewData["Title"] = Html.T("تفاصيل الحضور", "Attendance Details");
    var isPresent = Model.IsPresent;
    var durationMinutes = Model.DurationMinutes;
    var attendancePercentage = Model.LiveClass.Duration.TotalMinutes > 0 ? (durationMinutes * 100.0 / Model.LiveClass.Duration.TotalMinutes) : 0;
}

@section Styles {
<style>
    .detail-header {
        background: linear-gradient(135deg, @(isPresent ? "#10b981 0%, #059669" : "#ef4444 0%, #dc2626") 100%);
        border-radius: 12px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    .detail-header::before {
        content: '@(isPresent ? "✓" : "✗")';
        position: absolute;
        left: -30px;
        top: -30px;
        font-size: 250px;
        opacity: 0.1;
    }
    
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        height: 100%;
    }
    
    .timeline-item {
        padding: 20px;
        background: white;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-right: 4px solid #667eea;
    }
    
    .recording-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    .recording-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .progress-ring {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 15px solid #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        position: relative;
        background: white;
    }
    .progress-ring.success {
        border-color: #10b981;
        border-top-color: #f3f4f6;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Page Header -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <a href="@Url.Action("Index")" class="btn btn-sm btn-light me-3">
                <i class="feather-arrow-right me-1"></i>
                @Html.T("رجوع", "Back")
            </a>
            <div>
                <h3 class="fw-bold mb-1">
                    <i class="feather-file-text text-primary me-2"></i>
                    @Html.T("تفاصيل سجل الحضور", "Attendance Record Details")
                </h3>
                <p class="text-muted mb-0">@Html.T("معلومات كاملة عن حضورك في الجلسة المباشرة", "Complete information about your live session attendance")</p>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Header -->
<div class="detail-header">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-3">
                <div class="avatar-text avatar-xl bg-white bg-opacity-25 text-white me-3">
                    <i class="feather-@(isPresent ? "check" : "x")-circle"></i>
                </div>
                <div>
                    <h1 class="text-white fw-bold mb-2">@(isPresent ? Html.T("حضور مؤكد ✓", "Confirmed Attendance ✓") : Html.T("غياب", "Absent"))</h1>
                    <h4 class="text-white opacity-75 mb-0">@Model.LiveClass.Title</h4>
                </div>
            </div>
            <p class="text-white opacity-75 fs-5 mb-0">
                <i class="feather-calendar me-2"></i>
                @Model.LiveClass.ScheduledStartTime.ToString("dddd, dd MMMM yyyy")
            </p>
        </div>
        <div class="col-lg-4 text-center">
            @if (isPresent)
            {
                <div class="progress-ring success mx-auto">
                    <h2 class="fw-bold mb-0 text-success">@durationMinutes</h2>
                    <small class="text-muted">@Html.T("دقيقة", "minutes")</small>
                </div>
            }
            else
            {
                <div class="bg-white bg-opacity-25 rounded-circle p-4 d-inline-block">
                    <i class="feather-x-circle text-white" style="font-size: 80px;"></i>
                </div>
            }
        </div>
    </div>
</div>

<!-- Main Info -->
<div class="row g-4 mb-4">
    <!-- Class Info -->
    <div class="col-lg-8">
        <div class="info-card mb-4">
            <h5 class="fw-bold mb-4">
                <i class="feather-video text-primary me-2"></i>
                @Html.T("معلومات الجلسة", "Session Information")
            </h5>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-start mb-3">
                        <div class="avatar-text avatar-md bg-soft-primary text-primary me-3">
                            <i class="feather-book"></i>
                        </div>
                        <div>
                            <label class="text-muted small d-block mb-1">@Html.T("الدورة", "Course")</label>
                            <h6 class="fw-bold mb-0">@Model.LiveClass.Course.Title</h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="d-flex align-items-start mb-3">
                        <div class="avatar-text avatar-md bg-soft-success text-success me-3">
                            <i class="feather-user"></i>
                        </div>
                        <div>
                            <label class="text-muted small d-block mb-1">@Html.T("المدرب", "Instructor")</label>
                            <h6 class="fw-bold mb-0">@Model.LiveClass.Instructor.FullName</h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="d-flex align-items-start mb-3">
                        <div class="avatar-text avatar-md bg-soft-warning text-warning me-3">
                            <i class="feather-calendar"></i>
                        </div>
                        <div>
                            <label class="text-muted small d-block mb-1">@Html.T("التاريخ", "Date")</label>
                            <h6 class="fw-bold mb-0">@Model.LiveClass.ScheduledStartTime.ToString("dd/MM/yyyy")</h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="d-flex align-items-start mb-3">
                        <div class="avatar-text avatar-md bg-soft-info text-info me-3">
                            <i class="feather-clock"></i>
                        </div>
                        <div>
                            <label class="text-muted small d-block mb-1">@Html.T("الوقت", "Time")</label>
                            <h6 class="fw-bold mb-0">
                                @Model.LiveClass.ScheduledStartTime.ToString("HH:mm") - 
                                @Model.LiveClass.ScheduledEndTime.ToString("HH:mm")
                            </h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="alert alert-info mb-0">
                        <div class="d-flex align-items-center">
                            <i class="feather-info fs-4 me-3"></i>
                            <div>
                                <strong>@Html.T("مدة الجلسة:", "Session Duration:")</strong> @Model.LiveClass.Duration @Html.T("دقيقة", "minutes")
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Description -->
        @if (!string.IsNullOrEmpty(Model.LiveClass.Description))
        {
            <div class="info-card">
                <h5 class="fw-bold mb-3">
                    <i class="feather-file-text text-primary me-2"></i>
                    @Html.T("وصف الجلسة", "Session Description")
                </h5>
                <p class="text-muted mb-0">@Model.LiveClass.Description</p>
            </div>
        }
    </div>
    
    <!-- Attendance Stats -->
    <div class="col-lg-4">
        @if (isPresent)
        {
            <div class="info-card mb-4">
                <h5 class="fw-bold mb-4">
                    <i class="feather-bar-chart text-success me-2"></i>
                    @Html.T("إحصائيات الحضور", "Attendance Statistics")
                </h5>
                
                <div class="text-center mb-4">
                    <div class="mb-3">
                        <h2 class="fw-bold text-success mb-0">@attendancePercentage.ToString("F1")%</h2>
                        <small class="text-muted">@Html.T("نسبة الحضور", "Attendance Rate")</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: @attendancePercentage%"></div>
                    </div>
                </div>
                
                <div class="timeline-item">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="feather-log-in text-success me-2"></i>
                            <strong>@Html.T("وقت الانضمام", "Join Time")</strong>
                        </div>
                        <span class="text-muted">
                            @(Model.JoinedAt?.ToString("HH:mm") ?? "—")
                        </span>
                    </div>
                </div>
                
                <div class="timeline-item">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="feather-log-out text-danger me-2"></i>
                            <strong>@Html.T("وقت المغادرة", "Leave Time")</strong>
                        </div>
                        <span class="text-muted">
                            @(Model.LeftAt?.ToString("HH:mm") ?? "—")
                        </span>
                    </div>
                </div>
                
                <div class="timeline-item">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="feather-clock text-info me-2"></i>
                            <strong>@Html.T("مدة الحضور", "Attendance Duration")</strong>
                        </div>
                        <span class="badge bg-soft-info text-info">
                            @durationMinutes @Html.T("دقيقة", "minutes")
                        </span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="info-card mb-4">
                <div class="text-center py-4">
                    <div class="avatar-text avatar-xl bg-soft-danger text-danger mx-auto mb-3">
                        <i class="feather-x-circle"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@Html.T("لم تحضر هذه الجلسة", "You did not attend this session")</h5>
                    <p class="text-muted mb-0">@Html.T("لم يتم تسجيل حضورك في هذه الجلسة المباشرة", "Your attendance was not recorded for this live session")</p>
                </div>
            </div>
        }
        
        <!-- Quick Actions -->
        <div class="info-card">
            <h6 class="fw-bold mb-3">@Html.T("إجراءات سريعة", "Quick Actions")</h6>
            
            <a href="@Url.Action("Details", "LiveClasses", new { area = "Student", id = Model.LiveClassId })" 
               class="btn btn-outline-primary w-100 mb-2">
                <i class="feather-video me-2"></i>
                @Html.T("تفاصيل الجلسة", "Session Details")
            </a>
            
            <a href="@Url.Action("Details", "Courses", new { id = Model.LiveClass.CourseId })" 
               class="btn btn-outline-secondary w-100 mb-2">
                <i class="feather-book me-2"></i>
                @Html.T("الذهاب للدورة", "Go to Course")
            </a>
            
            @if (isPresent)
            {
                <a href="@Url.Action("Certificate", new { id = Model.Id })" 
                   class="btn btn-outline-success w-100">
                    <i class="feather-download me-2"></i>
                    @Html.T("شهادة الحضور", "Attendance Certificate")
                </a>
            }
        </div>
    </div>
</div>

<!-- Notes Section -->
@if (isPresent && !string.IsNullOrEmpty(Model.Notes))
{
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="info-card">
                <h5 class="fw-bold mb-3">
                    <i class="feather-file-text text-info me-2"></i>
                    @Html.T("ملاحظات إضافية", "Additional Notes")
                </h5>
                <div class="alert alert-light border mb-0">
                    <p class="mb-0">@Model.Notes</p>
                </div>
            </div>
        </div>
    </div>
}

<!-- Recordings Section -->
@if (Model.LiveClass.Recordings.Any())
{
    <div class="row g-4">
        <div class="col-12">
            <div class="info-card">
                <h5 class="fw-bold mb-4">
                    <i class="feather-play-circle text-primary me-2"></i>
                    @Html.T("تسجيلات الجلسة", "Session Recordings") (@Model.LiveClass.Recordings.Count)
                </h5>
                
                <div class="row g-3">
                    @foreach (var recording in Model.LiveClass.Recordings)
                    {
                        <div class="col-lg-6">
                            <div class="recording-card">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="avatar-text avatar-lg bg-soft-primary text-primary me-3">
                                        <i class="feather-video"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">@Html.T("تسجيل الجلسة", "Session Recording")</h6>
                                        <small class="text-muted">
                                            @recording.Duration @Html.T("دقيقة", "minutes")
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="@recording.VideoUrl" target="_blank" class="btn btn-primary flex-grow-1">
                                        <i class="feather-play me-2"></i>
                                        @Html.T("مشاهدة", "Watch")
                                    </a>
                                    <a href="@recording.VideoUrl" download class="btn btn-outline-primary">
                                        <i class="feather-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else if (isPresent)
{
    <div class="row g-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="feather-alert-circle fs-3 me-3"></i>
                    <div>
                        <strong>@Html.T("لا توجد تسجيلات متاحة", "No recordings available")</strong>
                        <p class="mb-0">@Html.T("لم يتم رفع تسجيل لهذه الجلسة بعد", "No recording has been uploaded for this session yet")</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
