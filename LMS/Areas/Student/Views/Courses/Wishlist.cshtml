@model List<LMS.Domain.Entities.Learning.WishlistItem>
@{
    ViewData["Title"] = Html.T("قائمة الأمنيات", "Wishlist");
}

@section Styles {
<style>
    .wishlist-header {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        color: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 30px;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 12px;
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 14px;
    }
    
    .wishlist-container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .course-wishlist-item {
        display: flex;
        gap: 20px;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #f3f4f6;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }
    
    .course-wishlist-item:hover {
        border-color: #ec4899;
        box-shadow: 0 4px 16px rgba(236, 72, 153, 0.1);
    }
    
    .course-thumbnail {
        width: 200px;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        flex-shrink: 0;
    }
    
    .course-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .course-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
        line-height: 1.4;
    }
    
    .course-title:hover {
        color: #ec4899;
    }
    
    .course-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 12px;
        font-size: 14px;
        color: #6b7280;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .course-description {
        color: #6b7280;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 12px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .course-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }
    
    .course-price {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .price-current {
        font-size: 24px;
        font-weight: 700;
        color: #ec4899;
    }
    
    .price-old {
        font-size: 16px;
        color: #9ca3af;
        text-decoration: line-through;
    }
    
    .price-discount {
        background: #fef2f2;
        color: #dc2626;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .course-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-enroll {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-enroll:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
        color: white;
    }
    
    .btn-remove {
        background: #fef2f2;
        color: #dc2626;
        border: 2px solid #fee2e2;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-remove:hover {
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    }
    
    .rating-stars {
        color: #fbbf24;
    }
    
    .level-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .level-beginner { background: #dbeafe; color: #1e40af; }
    .level-intermediate { background: #fef3c7; color: #92400e; }
    .level-advanced { background: #fce7f3; color: #9f1239; }
    
    .empty-state {
        text-align: center;
        padding: 80px 20px;
    }
    
    .empty-state i {
        font-size: 80px;
        color: #d1d5db;
        margin-bottom: 24px;
    }
    
    .filter-sort-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .sort-dropdown {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px 16px;
        background: white;
        cursor: pointer;
    }
    
    .bulk-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .select-all-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #ec4899;
    }
    
    .item-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #ec4899;
        margin-left: 12px;
    }
    
    .added-badge {
        background: #f0fdf4;
        color: #15803d;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .price-alert {
        background: #fef3c7;
        border: 2px solid #fbbf24;
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        font-size: 13px;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="wishlist-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">
                <i class="feather-heart me-2"></i>
                @Html.T("قائمة الأمنيات", "Wishlist")
            </h1>
            <p class="mb-0 opacity-75">@Html.T("الدورات التي تهتم بها وتريد الالتحاق بها لاحقاً", "Courses you're interested in and want to enroll in later")</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <a href="@Url.Action("Index", "Home")" class="btn btn-light btn-lg">
                <i class="feather-plus me-2"></i>
                @Html.T("استعراض الدورات", "Browse Courses")
            </a>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="feather-heart"></i>
        </div>
        <div class="stat-value">@Model.Count</div>
        <div class="stat-label">@Html.T("دورة في القائمة", "Courses in List")</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="feather-dollar-sign"></i>
        </div>
        <div class="stat-value">@Model.Sum(w => w.Course.DiscountPrice ?? w.Course.Price).ToEGP()</div>
        <div class="stat-label">@Html.T("القيمة الإجمالية", "Total Value")</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="feather-tag"></i>
        </div>
        <div class="stat-value">@Model.Count(w => w.Course.DiscountPrice.HasValue)</div>
        <div class="stat-label">@Html.T("دورات بخصم", "Discounted Courses")</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="feather-clock"></i>
        </div>
        <div class="stat-value">@Model.Sum(w => (double)w.Course.DurationHours).ToString("F0")</div>
        <div class="stat-label">@Html.T("ساعات تعلم", "Learning Hours")</div>
    </div>
</div>

<!-- Wishlist Container -->
<div class="wishlist-container">
    <!-- Filter and Sort Bar -->
    <div class="filter-sort-bar">
        <div class="bulk-actions">
            <input type="checkbox" class="select-all-checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll" style="cursor: pointer; user-select: none;">@Html.T("تحديد الكل", "Select All")</label>
            <button class="btn btn-outline-danger btn-sm ms-3" onclick="removeSelected()" id="removeSelectedBtn" style="display: none;">
                <i class="feather-trash-2 me-2"></i>
                @Html.T("حذف المحدد", "Remove Selected")
            </button>
        </div>
        
        <div class="d-flex gap-2">
            <select class="sort-dropdown" onchange="sortWishlist(this.value)">
                <option value="recent">@Html.T("الأحدث", "Newest")</option>
                <option value="price-low">@Html.T("السعر: من الأقل", "Price: Low to High")</option>
                <option value="price-high">@Html.T("السعر: من الأعلى", "Price: High to Low")</option>
                <option value="rating">@Html.T("التقييم", "Rating")</option>
                <option value="popular">@Html.T("الأكثر شعبية", "Most Popular")</option>
            </select>
        </div>
    </div>
    
    @if (!Model.Any())
    {
        <div class="empty-state">
            <i class="feather-heart"></i>
            <h4 class="mb-3">@Html.T("قائمة الأمنيات فارغة", "Wishlist is Empty")</h4>
            <p class="text-muted mb-4">@Html.T("لم تقم بإضافة أي دورات إلى قائمة الأمنيات بعد", "You haven't added any courses to your wishlist yet")</p>
            <a href="@Url.Action("Index", "Home")" class="btn btn-primary btn-lg">
                <i class="feather-search me-2"></i>
                @Html.T("استعراض الدورات", "Browse Courses")
            </a>
        </div>
    }
    else
    {
        <div id="wishlistItems">
            @foreach (var item in Model.OrderByDescending(w => w.AddedAt))
            {
                var course = item.Course;
                var hasDiscount = course.DiscountPrice.HasValue;
                var discountPercent = hasDiscount ? (int)((course.Price - course.DiscountPrice.Value) / course.Price * 100) : 0;
                
                <div class="course-wishlist-item" data-course-id="@course.Id">
                    <input type="checkbox" class="item-checkbox" onchange="updateBulkActions()">
                    
                    <img src="@(course.ThumbnailUrl ?? "/assets/images/course-default.jpg")" 
                         alt="@course.Title" 
                         class="course-thumbnail"
                         onerror="this.src='/assets/images/course-default.jpg'">
                    
                    <div class="course-content">
                        <a href="@Url.Action("Details", "Courses", new { area = "", id = course.Id })" class="course-title">
                            @course.Title
                        </a>
                        
                        <div class="course-meta">
                            <div class="meta-item">
                                <i class="feather-user"></i>
                                @course.Instructor.FullName
                            </div>
                            <div class="meta-item">
                                <div class="rating-stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= course.AverageRating)
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star"></i>
                                        }
                                    }
                                </div>
                                <span>@course.AverageRating.ToString("F1")</span>
                                <span class="text-muted">(@course.TotalReviews)</span>
                            </div>
                            <div class="meta-item">
                                <i class="feather-clock"></i>
                                @course.DurationHours.ToString("F1") @Html.T("ساعة", "hours")
                            </div>
                            <div class="meta-item">
                                <span class="level-badge level-@course.Level.ToString().ToLower()">
                                    @switch (course.Level)
                                    {
                                        case LMS.Domain.Enums.CourseLevel.Beginner: @Html.T("مبتدئ", "Beginner")
                                        break;
                                        case LMS.Domain.Enums.CourseLevel.Intermediate: @Html.T("متوسط", "Intermediate")
                                        break;
                                        case LMS.Domain.Enums.CourseLevel.Advanced: @Html.T("متقدم", "Advanced")
                                        break;
                                    }
                                </span>
                            </div>
                        </div>
                        
                        <p class="course-description">@course.Description</p>
                        
                        <div class="course-footer">
                            <div class="course-price">
                                @if (hasDiscount)
                                {
                                    <span class="price-current">@course.DiscountPrice.Value.ToEGP()</span>
                                    <span class="price-old">@course.Price.ToEGP()</span>
                                    <span class="price-discount">@Html.T("خصم", "Discount") @discountPercent%</span>
                                }
                                else if (course.Price == 0)
                                {
                                    <span class="price-current">@Html.T("مجاني", "Free")</span>
                                }
                                else
                                {
                                    <span class="price-current">@course.Price.ToEGP()</span>
                                }
                            </div>
                            
                            <div class="course-actions">
                                <a href="@Url.Action("Details", "Courses", new { area = "", id = course.Id })" class="btn btn-enroll">
                                    <i class="feather-shopping-cart me-2"></i>
                                    @Html.T("التسجيل الآن", "Enroll Now")
                                </a>
                                <button class="btn btn-remove" onclick="removeFromWishlist(@course.Id)">
                                    <i class="feather-x"></i>
                                </button>
                            </div>
                        </div>
                        
                        @if (hasDiscount)
                        {
                            <div class="price-alert">
                                <i class="feather-zap me-2 text-warning"></i>
                                <strong>@Html.T("عرض محدود!", "Limited Offer!")</strong> @Html.T("وفر", "Save") @((course.Price - course.DiscountPrice.Value).ToEGP()) @Html.T("على هذه الدورة", "on this course")
                            </div>
                        }
                    </div>
                    
                    <div class="d-flex flex-column gap-2 align-items-end">
                        <span class="added-badge">
                            <i class="feather-calendar me-1"></i>
                            @item.AddedAt.ToString("dd MMM")
                        </span>
                        @if (course.TotalStudents > 1000)
                        {
                            <span class="badge bg-info">
                                <i class="feather-trending-up me-1"></i>
                                @Html.T("شائع", "Popular")
                            </span>
                        }
                        @if (course.IsNew)
                        {
                            <span class="badge bg-success">
                                <i class="feather-star me-1"></i>
                                @Html.T("جديد", "New")
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
        
        <!-- Bulk Actions Footer -->
        <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
            <div>
                <strong>@Model.Count</strong> @Html.T("دورة في القائمة", "courses in list")
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="clearWishlist()">
                    <i class="feather-trash-2 me-2"></i>
                    @Html.T("مسح القائمة", "Clear List")
                </button>
                <button class="btn btn-primary ms-2" onclick="enrollInAll()">
                    <i class="feather-shopping-cart me-2"></i>
                    @Html.T("التسجيل في الكل", "Enroll in All")
                </button>
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateBulkActions();
    }
    
    function updateBulkActions() {
        const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
        const removeBtn = document.getElementById('removeSelectedBtn');
        removeBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
        
        // Update select all checkbox
        const totalCheckboxes = document.querySelectorAll('.item-checkbox').length;
        const selectAll = document.getElementById('selectAll');
        selectAll.checked = checkedCount === totalCheckboxes && totalCheckboxes > 0;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < totalCheckboxes;
    }
    
    function removeFromWishlist(courseId) {
        if (confirm('@Html.Raw(Html.T("هل تريد إزالة هذه الدورة من قائمة الأمنيات؟", "Do you want to remove this course from your wishlist?").Replace("'", "\\'"))')) {
            fetch('@Url.Action("RemoveFromWishlist", "Courses")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ courseId: courseId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const item = document.querySelector(`[data-course-id="${courseId}"]`);
                    item.style.transition = 'all 0.3s ease';
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        item.remove();
                        if (document.querySelectorAll('.course-wishlist-item').length === 0) {
                            location.reload();
                        }
                    }, 300);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('@Html.Raw(Html.T("حدث خطأ أثناء الإزالة من القائمة", "An error occurred while removing from the list").Replace("'", "\\'"))');
            });
        }
    }
    
    function removeSelected() {
        const selected = Array.from(document.querySelectorAll('.item-checkbox:checked'))
            .map(cb => parseInt(cb.closest('.course-wishlist-item').dataset.courseId));
        
        if (selected.length === 0) return;
        
        if (confirm(`@Html.T("هل تريد إزالة", "Do you want to remove") ${selected.length} @Html.T("دورة من قائمة الأمنيات؟", "course(s) from your wishlist?")`)) {
            selected.forEach(courseId => removeFromWishlist(courseId));
        }
    }
    
    function clearWishlist() {
        if (confirm('@Html.Raw(Html.T("هل تريد مسح جميع الدورات من قائمة الأمنيات؟\nلا يمكن التراجع عن هذا الإجراء.", "Do you want to clear all courses from your wishlist?\nThis action cannot be undone.").Replace("'", "\\'").Replace("\n", "\\n"))')) {
            const allCourses = Array.from(document.querySelectorAll('.course-wishlist-item'))
                .map(item => parseInt(item.dataset.courseId));
            allCourses.forEach(courseId => removeFromWishlist(courseId));
        }
    }
    
    function enrollInAll() {
        alert('@Html.Raw(Html.T("سيتم فتح صفحة الدفع للتسجيل في جميع الدورات", "The payment page will open to enroll in all courses").Replace("'", "\\'"))');
        // TODO: Implement bulk enrollment
    }
    
    function sortWishlist(sortBy) {
        const container = document.getElementById('wishlistItems');
        const items = Array.from(container.querySelectorAll('.course-wishlist-item'));
        
        items.sort((a, b) => {
            // TODO: Implement sorting logic based on sortBy
            return 0;
        });
        
        items.forEach(item => container.appendChild(item));
    }
    
    // Price drop notifications
    function notifyPriceDrops() {
        // TODO: Check for price drops and notify user
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        notifyPriceDrops();
    });
</script>
}

