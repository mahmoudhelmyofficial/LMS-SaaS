@model List<LMS.Domain.Entities.Learning.Enrollment>
@{
    ViewData["Title"] = Html.T("الدورات المكتملة", "Completed Courses");
    var totalStudyHours = Model.Sum(e => e.TotalWatchTimeMinutes) / 60;
    var avgGrade = Model.Any(e => e.FinalGrade.HasValue) ? Model.Where(e => e.FinalGrade.HasValue).Average(e => e.FinalGrade!.Value) : 0;
    var certificateCount = Model.Count(e => e.HasCertificate);
}

@section Styles {
<style>
    .completed-course-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .completed-course-card::before {
        content: '✓';
        position: absolute;
        top: -10px;
        left: -10px;
        font-size: 100px;
        color: rgba(34, 197, 94, 0.05);
        font-weight: bold;
    }
    .completed-course-card:hover {
        border-color: #22c55e;
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.2);
        transform: translateY(-5px);
    }
    .certificate-badge {
        position: absolute;
        top: 20px;
        left: 20px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3);
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Page Header (modern card-based) -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
            <div>
                <h3 class="fw-bold mb-2">
                    <i class="feather-award text-primary me-2"></i>
                    @Html.T("الدورات المكتملة", "Completed Courses")
                </h3>
                <p class="text-muted mb-0">@Html.T("احتفل بإنجازاتك واستعرض شهاداتك", "Celebrate your achievements and view your certificates")</p>
            </div>
            <div class="border rounded-3 p-4 bg-soft-success text-center text-lg-end flex-shrink-0">
                <div class="text-muted small mb-1">@Html.T("إجمالي الدورات المكتملة", "Total Completed Courses")</div>
                <h2 class="fw-bold text-success mb-0">@Model.Count <small class="fs-5 fw-normal text-muted">@Html.T("دورات", "courses")</small></h2>
            </div>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-success text-success mx-auto mb-3">
                    <i class="feather-check-circle"></i>
                </div>
                <h3 class="fw-bold mb-1">@Model.Count</h3>
                <p class="text-muted mb-0">@Html.T("دورات مكتملة", "Completed Courses")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-warning text-warning mx-auto mb-3">
                    <i class="feather-award"></i>
                </div>
                <h3 class="fw-bold mb-1">@certificateCount</h3>
                <p class="text-muted mb-0">@Html.T("شهادات محصلة", "Certificates Earned")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-primary text-primary mx-auto mb-3">
                    <i class="feather-clock"></i>
                </div>
                <h3 class="fw-bold mb-1">@totalStudyHours</h3>
                <p class="text-muted mb-0">@Html.T("ساعة تعلم", "Learning Hours")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-info text-info mx-auto mb-3">
                    <i class="feather-star"></i>
                </div>
                <h3 class="fw-bold mb-1">@avgGrade.ToString("F1")</h3>
                <p class="text-muted mb-0">@Html.T("متوسط التقييم", "Average Rating")</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <div class="row align-items-center g-3">
            <div class="col-md-4">
                <select class="form-select" id="categoryFilter">
                    <option value="">@Html.T("جميع الفئات", "All Categories")</option>
                    @foreach (var category in Model.Where(e => e.Course?.Category != null).Select(e => e.Course!.Category!.Name).Distinct())
                    {
                        <option value="@category">@category</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="sortFilter">
                    <option value="newest">@Html.T("الترتيب: الأحدث", "Sort: Newest")</option>
                    <option value="oldest">@Html.T("الأقدم", "Oldest")</option>
                    <option value="highest">@Html.T("الأعلى تقييماً", "Highest Rated")</option>
                </select>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="feather-search"></i>
                    </span>
                    <input type="text" class="form-control border-start-0 ps-0" id="searchCourse" placeholder="@Html.T("بحث في الدورات...", "Search courses...")" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Completed Courses Grid -->
<div class="row g-4" id="coursesGrid">
    @if (Model.Any())
    {
        foreach (var enrollment in Model)
        {
            <div class="col-lg-6 course-item" data-category="@(enrollment.Course?.Category?.Name ?? "")" data-title="@(enrollment.Course?.Title ?? "")">
                <div class="completed-course-card">
                    @if (enrollment.HasCertificate)
                    {
                        <div class="certificate-badge">
                            <i class="feather-award me-1"></i>
                            @Html.T("شهادة معتمدة", "Certified")
                        </div>
                    }
                    <div class="row">
                        <div class="col-md-4">
                            <img src="@(enrollment.Course?.ThumbnailUrl ?? "/assets/images/placeholder-course.png")" alt="@enrollment.Course?.Title" class="img-fluid rounded" style="height: 150px; width: 100%; object-fit: cover;" />
                        </div>
                        <div class="col-md-8">
                            <div class="mb-2">
                                <span class="badge bg-soft-primary text-primary">@(enrollment.Course?.Category?.Name ?? Html.T("غير مصنف", "Uncategorized"))</span>
                            </div>
                            <h5 class="fw-bold mb-2">@enrollment.Course?.Title</h5>
                            <p class="text-muted small mb-3">@(enrollment.Course?.Instructor != null ? $"{enrollment.Course.Instructor.FirstName} {enrollment.Course.Instructor.LastName}" : Html.T("غير محدد", "Unknown"))</p>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">@Html.T("تاريخ الإكمال", "Completion Date")</small>
                                    <strong>@(enrollment.CompletedAt?.ToString("dd MMMM yyyy") ?? Html.T("غير محدد", "Unknown"))</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">@Html.T("النتيجة النهائية", "Final Grade")</small>
                                    <strong class="@(enrollment.FinalGrade >= 80 ? "text-success" : enrollment.FinalGrade >= 60 ? "text-warning" : "text-secondary")">
                                        @(enrollment.FinalGrade?.ToString("F0") ?? "-")%
                                    </strong>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                @if (enrollment.HasCertificate)
                                {
                                    <a asp-controller="Certificates" asp-action="View" asp-route-enrollmentId="@enrollment.Id" class="btn btn-sm btn-primary flex-grow-1">
                                        <i class="feather-award me-1"></i>
                                        @Html.T("عرض الشهادة", "View Certificate")
                                    </a>
                                    <a asp-controller="Certificates" asp-action="Download" asp-route-enrollmentId="@enrollment.Id" class="btn btn-sm btn-outline-secondary flex-grow-1">
                                        <i class="feather-download me-1"></i>
                                        @Html.T("تحميل", "Download")
                                    </a>
                                }
                                else if (enrollment.Course?.HasCertificate == true)
                                {
                                    <form asp-controller="Certificates" asp-action="RequestCertificate" asp-route-enrollmentId="@enrollment.Id" method="post" class="flex-grow-1">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-warning w-100">
                                            <i class="feather-award me-1"></i>
                                            @Html.T("إصدار الشهادة", "Get Certificate")
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary flex-grow-1" disabled>
                                        <i class="feather-award me-1"></i>
                                        @Html.T("لا توجد شهادة", "No Certificate")
                                    </button>
                                    <a asp-controller="Learning" asp-action="Continue" asp-route-enrollmentId="@enrollment.Id" class="btn btn-sm btn-outline-primary flex-grow-1">
                                        <i class="feather-repeat me-1"></i>
                                        @Html.T("إعادة الدراسة", "Re-study")
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-12">
            <div class="card stretch stretch-full">
                <div class="card-body text-center py-5">
                    <div class="avatar-text avatar-xl bg-soft-secondary text-secondary mx-auto mb-4">
                        <i class="feather-book-open fs-1"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@Html.T("لا توجد دورات مكتملة بعد", "No completed courses yet")</h5>
                    <p class="text-muted mb-4">@Html.T("ابدأ رحلة التعلم الآن وأكمل دورتك الأولى!", "Start your learning journey now and complete your first course!")</p>
                    <a asp-action="Index" class="btn btn-primary">
                        <i class="feather-book me-2"></i>
                        @Html.T("تصفح الدورات", "Browse Courses")
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@if (Model.Any())
{
    var shareMessage = string.Format(Html.T("أكملت {0} دورات تعليمية!", "I completed {0} educational courses!").ToString(), Model.Count);
    var shareMessageEncoded = System.Net.WebUtility.UrlEncode(shareMessage);
    <!-- Share Achievements -->
    <div class="card stretch stretch-full mt-4">
        <div class="card-body text-center py-5">
            <div class="avatar-text avatar-xl bg-soft-success text-success mx-auto mb-3">
                <i class="feather-share-2 fs-1"></i>
            </div>
            <h4 class="fw-bold mb-2">@Html.T("شارك إنجازاتك!", "Share Your Achievements!")</h4>
            <p class="text-muted mb-4">@Html.T("أخبر أصدقاءك عن الدورات التي أكملتها", "Tell your friends about the courses you've completed")</p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="https://twitter.com/intent/tweet?text=@shareMessageEncoded" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary">
                    <i class="feather-twitter me-2"></i>
                    @Html.T("تويتر", "Twitter")
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?quote=@shareMessageEncoded" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary">
                    <i class="feather-facebook me-2"></i>
                    @Html.T("فيسبوك", "Facebook")
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary">
                    <i class="feather-linkedin me-2"></i>
                    @Html.T("لينكد إن", "LinkedIn")
                </a>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    $(document).ready(function() {
        // Search functionality
        $('#searchCourse').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('.course-item').filter(function() {
                $(this).toggle($(this).data('title').toLowerCase().indexOf(value) > -1);
            });
        });
        
        // Category filter
        $('#categoryFilter').on('change', function() {
            var value = $(this).val();
            if (value === '') {
                $('.course-item').show();
            } else {
                $('.course-item').filter(function() {
                    $(this).toggle($(this).data('category') === value);
                });
            }
        });
    });
</script>
}
