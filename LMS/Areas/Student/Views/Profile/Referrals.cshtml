@model ReferralProgramViewModel
@{
    ViewData["Title"] = Html.T("برنامج الإحالة", "Referral Program");
}

@section Styles {
<style>
    .referral-header {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 12px;
        padding: 50px 40px;
        color: white;
        margin-bottom: 30px;
    }
    .referral-code-box {
        background: white;
        border: 3px dashed #fbbf24;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
    }
    .referral-code {
        font-size: 32px;
        font-weight: bold;
        color: #f59e0b;
        letter-spacing: 4px;
        font-family: 'Courier New', monospace;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Referral Header -->
<div class="referral-header">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="fw-bold text-white mb-3">
                <i class="feather-gift me-3"></i>
                @Html.T("برنامج الإحالة", "Referral Program")
            </h1>
            <p class="text-white opacity-75 fs-5 mb-0">@Html.T("اربح مكافآت عند دعوة أصدقائك للانضمام!", "Earn rewards when you invite your friends to join!")</p>
        </div>
        <div class="col-lg-4 text-end">
            <div class="bg-white bg-opacity-25 rounded-3 p-4 d-inline-block">
                <div class="text-white opacity-75 mb-2">@Html.T("إجمالي الأرباح", "Total Earnings")</div>
                <h2 class="fw-bold text-white mb-0">
                    @Model.EarnedPoints
                    <small class="fs-5">@Html.T("نقطة", "Points")</small>
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- How It Works -->
<div class="card stretch stretch-full mb-4">
    <div class="card-header">
        <h5 class="fw-bold mb-0">
            <i class="feather-help-circle text-primary me-2"></i>
            @Html.T("كيف يعمل البرنامج؟", "How Does the Program Work?")
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-4 text-center">
                <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-3">
                    <i class="feather-share-2 fs-1"></i>
                </div>
                <h6 class="fw-bold mb-2">@Html.T("1. شارك رمزك", "1. Share Your Code")</h6>
                <p class="text-muted small mb-0">@Html.T("أرسل رمز الإحالة الخاص بك لأصدقائك", "Send your referral code to your friends")</p>
            </div>
            <div class="col-md-4 text-center">
                <div class="avatar-text avatar-xl bg-soft-success text-success mx-auto mb-3">
                    <i class="feather-user-plus fs-1"></i>
                </div>
                <h6 class="fw-bold mb-2">@Html.T("2. انضمام الأصدقاء", "2. Friends Join")</h6>
                <p class="text-muted small mb-0">@Html.T("عندما يسجلون باستخدام رمزك", "When they register using your code")</p>
            </div>
            <div class="col-md-4 text-center">
                <div class="avatar-text avatar-xl bg-soft-warning text-warning mx-auto mb-3">
                    <i class="feather-gift fs-1"></i>
                </div>
                <h6 class="fw-bold mb-2">@Html.T("3. احصل على المكافآت", "3. Get Rewards")</h6>
                <p class="text-muted small mb-0">@Html.T("اربح نقاطاً وخصومات لكل إحالة ناجحة", "Earn points and discounts for every successful referral")</p>
            </div>
        </div>
    </div>
</div>

<!-- Your Referral Code -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card stretch stretch-full">
            <div class="card-header">
                <h5 class="fw-bold mb-0">
                    <i class="feather-tag text-warning me-2"></i>
                    @Html.T("رمز الإحالة الخاص بك", "Your Referral Code")
                </h5>
            </div>
            <div class="card-body">
                <div class="referral-code-box mb-3">
                    <small class="text-muted d-block mb-2">@Html.T("رمزك الفريد", "Your Unique Code")</small>
                    <div class="referral-code mb-3">@Model.ReferralCode</div>
                    <button class="btn btn-warning" onclick="copyCode()">
                        <i class="feather-copy me-2"></i>
                        @Html.T("نسخ الرمز", "Copy Code")
                    </button>
                </div>
                <div class="alert alert-info border-0 bg-soft-info">
                    <small><strong>@Html.T("نصيحة:", "Tip:")</strong> @Html.T("شارك هذا الرمز مع أصدقائك ليحصلوا على خصم 10% على أول دورة!", "Share this code with your friends to get a 10% discount on their first course!")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card stretch stretch-full">
            <div class="card-header">
                <h5 class="fw-bold mb-0">
                    <i class="feather-link text-primary me-2"></i>
                    @Html.T("رابط الإحالة", "Referral Link")
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">@Html.T("رابطك الشخصي", "Your Personal Link")</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="@Model.ReferralLink" id="referralLink" readonly />
                        <button class="btn btn-primary" onclick="copyLink()">
                            <i class="feather-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary flex-grow-1" onclick="shareOn('whatsapp')">
                        <i class="feather-message-circle me-2"></i>
                        @Html.T("واتساب", "WhatsApp")
                    </button>
                    <button class="btn btn-outline-primary flex-grow-1" onclick="shareOn('facebook')">
                        <i class="feather-facebook me-2"></i>
                        @Html.T("فيسبوك", "Facebook")
                    </button>
                    <button class="btn btn-outline-primary flex-grow-1" onclick="shareOn('twitter')">
                        <i class="feather-twitter me-2"></i>
                        @Html.T("تويتر", "Twitter")
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-primary text-primary mx-auto mb-3">
                    <i class="feather-users"></i>
                </div>
                <h3 class="fw-bold mb-1">@Model.TotalReferrals</h3>
                <p class="text-muted mb-0">@Html.T("إحالة ناجحة", "Successful Referrals")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-warning text-warning mx-auto mb-3">
                    <i class="feather-star"></i>
                </div>
                <h3 class="fw-bold mb-1">@Model.EarnedPoints</h3>
                <p class="text-muted mb-0">@Html.T("نقطة مكتسبة", "Points Earned")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-success text-success mx-auto mb-3">
                    <i class="feather-check-circle"></i>
                </div>
                <h3 class="fw-bold mb-1">@Model.ActiveReferrals</h3>
                <p class="text-muted mb-0">@Html.T("مسجلين نشطين", "Active Registrations")</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full text-center">
            <div class="card-body">
                <div class="avatar-text avatar-lg bg-soft-info text-info mx-auto mb-3">
                    <i class="feather-trending-up"></i>
                </div>
                <h3 class="fw-bold mb-1">@Model.ConversionRate%</h3>
                <p class="text-muted mb-0">@Html.T("معدل التحويل", "Conversion Rate")</p>
            </div>
        </div>
    </div>
</div>

<!-- Referral History -->
<div class="card stretch stretch-full">
    <div class="card-header">
        <h5 class="fw-bold mb-0">
            <i class="feather-list text-info me-2"></i>
            @Html.T("سجل الإحالات", "Referral History")
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>@Html.T("التاريخ", "Date")</th>
                        <th>@Html.T("الحالة", "Status")</th>
                        <th>@Html.T("النقاط المكتسبة", "Points Earned")</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.ReferralsList.Any())
                    {
                        foreach (var referral in Model.ReferralsList.OrderByDescending(r => r.JoinedDate))
                        {
                            <tr>
                                <td>@referral.JoinedDate.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo(System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "ar" ? "ar-SA" : "en-US"))</td>
                                <td><span class="badge bg-success">@Html.T("مكتمل", "Completed")</span></td>
                                <td><strong class="text-success">+50 @Html.T("نقطة", "Points")</strong></td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" class="text-center text-muted py-4">
                                <i class="feather-users fs-3 mb-2 d-block"></i>
                                @Html.T("لا توجد إحالات بعد - شارك رمزك مع أصدقائك!", "No referrals yet - share your code with your friends!")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function copyCode() {
        navigator.clipboard.writeText('@Model.ReferralCode');
        alert('@Html.Raw(Html.T("تم نسخ الرمز بنجاح!", "Code copied successfully!").Replace("'", "\\'"))');
    }

    function copyLink() {
        const link = document.getElementById('referralLink').value;
        navigator.clipboard.writeText(link);
        alert('@Html.Raw(Html.T("تم نسخ الرابط بنجاح!", "Link copied successfully!").Replace("'", "\\'"))');
    }

    function shareOn(platform) {
        const link = '@Model.ReferralLink';
        const text = '@Html.Raw(Html.T("انضم إلى منصة LMS واحصل على خصم 10%!", "Join the LMS platform and get a 10% discount!"))';
        
        let url = '';
        switch(platform) {
            case 'whatsapp':
                url = `https://wa.me/?text=${encodeURIComponent(text + ' ' + link)}`;
                break;
            case 'facebook':
                url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
                break;
            case 'twitter':
                url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(link)}`;
                break;
        }
        
        if(url) {
            window.open(url, '_blank', 'width=600,height=400');
        }
    }
</script>
}

