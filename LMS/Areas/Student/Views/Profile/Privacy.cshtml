@model LMS.Areas.Student.ViewModels.PrivacySettingsViewModel
@{
    ViewData["Title"] = Html.T("إعدادات الخصوصية", "Privacy Settings");
    // Calculate privacy score based on current settings
    var privacyScore = 0;
    var totalPoints = 6;
    if (Model.ProfileVisibility == "Private") privacyScore += 2;
    else if (Model.ProfileVisibility == "FriendsOnly") privacyScore += 1;
    if (!Model.ShowEmailPublicly) privacyScore += 1;
    if (!Model.ShowProgressPublicly) privacyScore += 1;
    if (Model.ShowBadgesPublicly) privacyScore += 0; // Public is ok for badges
    if (Model.ShowCertificatesPublicly) privacyScore += 0; // Public is ok for certs
    if (Model.AllowMessages) privacyScore += 1;
    
    var privacyPercentage = (privacyScore * 100) / totalPoints;
    var privacyLevel = privacyPercentage >= 80 ? Html.T("عالي", "High") : (privacyPercentage >= 50 ? Html.T("متوسط", "Medium") : Html.T("منخفض", "Low"));
    var privacyColor = privacyPercentage >= 80 ? "success" : (privacyPercentage >= 50 ? "warning" : "danger");
}

@section Styles {
<style>
    .privacy-card {
        border-right: 4px solid transparent;
        transition: all 0.2s ease;
    }
    .privacy-card:hover {
        border-right-color: var(--bs-primary);
        transform: translateX(-5px);
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <h3 class="fw-bold mb-2">
            <i class="feather-lock text-primary me-2"></i>
            @Html.T("إعدادات الخصوصية", "Privacy Settings")
        </h3>
        <p class="text-muted mb-0">@Html.T("تحكم في من يمكنه رؤية معلوماتك", "Control who can see your information")</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <form asp-action="UpdatePrivacySettings" method="post">
            @Html.AntiForgeryToken()
            
            <!-- Profile Visibility -->
            <div class="card privacy-card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="feather-eye me-2"></i>
                        @Html.T("ظهور الملف الشخصي", "Profile Visibility")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">@Html.T("من يمكنه رؤية ملفك الشخصي؟", "Who can see your profile?")</label>
                        <select name="ProfileVisibility" class="form-select">
                            <option value="Public" selected="@(Model.ProfileVisibility == "Public")">@Html.T("عام - يمكن لأي شخص رؤيته", "Public - Anyone can see it")</option>
                            <option value="FriendsOnly" selected="@(Model.ProfileVisibility == "FriendsOnly")">@Html.T("الأصدقاء فقط", "Friends Only")</option>
                            <option value="Private" selected="@(Model.ProfileVisibility == "Private")">@Html.T("خاص - أنا فقط", "Private - Only Me")</option>
                        </select>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="ShowEmailPublicly" id="showEmail" @(Model.ShowEmailPublicly ? "checked" : "")>
                        <label class="form-check-label" for="showEmail">
                            @Html.T("إظهار البريد الإلكتروني في الملف الشخصي", "Show email on profile")
                        </label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ShowProgressPublicly" id="showProgress" @(Model.ShowProgressPublicly ? "checked" : "")>
                        <label class="form-check-label" for="showProgress">
                            @Html.T("إظهار تقدمي في الدورات", "Show my course progress")
                        </label>
                    </div>
                </div>
            </div>

            <!-- Activity Visibility -->
            <div class="card privacy-card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="feather-activity me-2"></i>
                        @Html.T("ظهور النشاط", "Activity Visibility")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="ShowCertificatesPublicly" id="showCertificates" @(Model.ShowCertificatesPublicly ? "checked" : "")>
                        <label class="form-check-label" for="showCertificates">
                            @Html.T("إظهار الشهادات الحاصل عليها", "Show earned certificates")
                        </label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ShowBadgesPublicly" id="showBadges" @(Model.ShowBadgesPublicly ? "checked" : "")>
                        <label class="form-check-label" for="showBadges">
                            @Html.T("إظهار الأوسمة والإنجازات", "Show medals and achievements")
                        </label>
                    </div>
                </div>
            </div>

            <!-- Communication Settings -->
            <div class="card privacy-card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="feather-message-circle me-2"></i>
                        @Html.T("إعدادات التواصل", "Communication Settings")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="AllowMessages" id="allowMessages" @(Model.AllowMessages ? "checked" : "")>
                        <label class="form-check-label" for="allowMessages">
                            @Html.T("السماح للآخرين بمراسلتي", "Allow others to message me")
                        </label>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="feather-save me-2"></i>
                            @Html.T("حفظ التغييرات", "Save Changes")
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="feather-x me-2"></i>
                            @Html.T("إلغاء", "Cancel")
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Privacy Score -->
        <div class="card stretch stretch-full mb-4">
            <div class="card-header">
                <h6 class="fw-bold mb-0">
                    <i class="feather-shield me-2"></i>
                    @Html.T("مستوى الخصوصية", "Privacy Level")
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h2 class="fw-bold text-@privacyColor mb-0">@privacyLevel</h2>
                    <p class="text-muted mb-0">@Html.T("درجة الخصوصية", "Privacy Score")</p>
                </div>
                <div class="progress ht-10 mb-3">
                    <div class="progress-bar bg-@privacyColor" style="width: @privacyPercentage%"></div>
                </div>
                <p class="text-muted fs-12 mb-0">
                    <i class="feather-info me-1"></i>
                    @if (privacyPercentage < 50)
                    {
                        <span>@Html.T("لتحسين خصوصيتك، قم بتقييد من يمكنه رؤية معلوماتك", "To improve your privacy, restrict who can see your information")</span>
                    }
                    else if (privacyPercentage < 80)
                    {
                        <span>@Html.T("خصوصيتك جيدة. يمكنك تحسينها أكثر بجعل الملف الشخصي خاصاً", "Your privacy is good. You can improve it further by making your profile private")</span>
                    }
                    else
                    {
                        <span>@Html.T("خصوصيتك ممتازة! معلوماتك محمية بشكل جيد", "Your privacy is excellent! Your information is well protected")</span>
                    }
                </p>
            </div>
        </div>

        <!-- Data Download -->
        <div class="card stretch stretch-full mb-4">
            <div class="card-header">
                <h6 class="fw-bold mb-0">
                    <i class="feather-download me-2"></i>
                    @Html.T("تحميل بياناتك", "Download Your Data")
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-3">@Html.T("يمكنك تحميل نسخة من جميع بياناتك", "You can download a copy of all your data")</p>
                <form asp-controller="Profile" asp-action="DownloadData" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="feather-download me-2"></i>
                        @Html.T("طلب تحميل البيانات", "Request Data Download")
                    </button>
                </form>
            </div>
        </div>

        <!-- Delete Account -->
        <div class="card stretch stretch-full">
            <div class="card-header">
                <h6 class="fw-bold text-danger mb-0">
                    <i class="feather-alert-triangle me-2"></i>
                    @Html.T("منطقة الخطر", "Danger Zone")
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">@Html.T("حذف حسابك بشكل دائم", "Permanently delete your account")</p>
                <button class="btn btn-danger w-100" onclick="confirmDelete()">
                    <i class="feather-trash-2 me-2"></i>
                    @Html.T("حذف الحساب", "Delete Account")
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function confirmDelete() {
        if (confirm('@Html.Raw(Html.T("هل أنت متأكد من رغبتك في حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه!", "Are you sure you want to delete your account? This action cannot be undone!").Replace("'", "\\'"))')) {
            // Show password confirmation modal
            const password = prompt('@Html.Raw(Html.T("يرجى إدخال كلمة المرور للتأكيد:", "Please enter your password to confirm:").Replace("'", "\\'"))');
            if (password) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteAccount", "Settings")';
                
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
                form.appendChild(tokenInput);
                
                const passwordInput = document.createElement('input');
                passwordInput.type = 'hidden';
                passwordInput.name = 'password';
                passwordInput.value = password;
                form.appendChild(passwordInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    }
</script>
}
