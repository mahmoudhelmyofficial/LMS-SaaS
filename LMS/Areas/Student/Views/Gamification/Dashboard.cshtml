@model LMS.Areas.Student.ViewModels.GamificationDashboardViewModel
@using LMS.Services.Interfaces
@inject IPlatformSettingsService PlatformSettings
@{
    ViewData["Title"] = Html.T("Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø´Ø§Ø±Ø§Øª", "Achievements & Badges");
    
    // UI settings
    var lockedBadgesLimit = await PlatformSettings.GetIntSettingAsync("UI.LockedBadges.Limit", 12);
}

@section Styles {
<style>
    .badge-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .badge-card:hover {
        transform: scale(1.05);
    }
    .badge-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 48px;
    }
    .badge-locked {
        opacity: 0.4;
        filter: grayscale(100%);
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="card stretch stretch-full mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body py-5">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h2 class="text-white fw-bold mb-2">
                    <i class="feather-award me-2"></i>
                    @Html.T("Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ ÙˆØ´Ø§Ø±Ø§ØªÙƒ", "Your achievements & badges")
                </h2>
                <p class="text-white opacity-75 mb-0">@Html.T("Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª", "Earn new badges by completing challenges")</p>
            </div>
            <div class="col-lg-4">
                <div class="row g-3">
                    <div class="col-6 text-center">
                        <h1 class="text-white fw-bold mb-0">@Model.TotalBadges</h1>
                        <p class="text-white opacity-75 mb-0">@Html.T("Ø´Ø§Ø±Ø© Ù…Ø­ØµÙ„Ø©", "Badge earned")</p>
                    </div>
                    <div class="col-6 text-center">
                        <h1 class="text-white fw-bold mb-0">@Model.CurrentPoints.ToString("N0")</h1>
                        <p class="text-white opacity-75 mb-0">@Html.T("Ù†Ù‚Ø·Ø©", "points")</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="text-muted mb-1">@Html.T("Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ", "Current level")</p>
                        <h3 class="fw-bold mb-0">@Model.CurrentLevel</h3>
                        <small class="text-primary">@Model.PointsToNextLevel @Html.T("Ù†Ù‚Ø·Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¯Ù…", "points to next level")</small>
                    </div>
                    <div class="avatar-text avatar-lg bg-soft-primary text-primary">
                        <i class="feather-trending-up"></i>
                    </div>
                </div>
                <div class="progress ht-5 mt-3">
                    <div class="progress-bar bg-primary" style="width: @Model.ProgressToNextLevel.ToString("F0")%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="text-muted mb-1">@Html.T("Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", "Completed courses")</p>
                        <h3 class="fw-bold mb-0">@Model.CompletedCourses</h3>
                    </div>
                    <div class="avatar-text avatar-lg bg-soft-success text-success">
                        <i class="feather-book-open"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="text-muted mb-1">@Html.T("Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…", "Learning hours")</p>
                        <h3 class="fw-bold mb-0">@Model.TotalStudyHours</h3>
                    </div>
                    <div class="avatar-text avatar-lg bg-soft-warning text-warning">
                        <i class="feather-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="text-muted mb-1">@Html.T("Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¥ØµØ±Ø§Ø±", "Streak")</p>
                        <h3 class="fw-bold mb-0">@Model.CurrentStreak</h3>
                        <small class="text-info">@Html.T("Ø§Ù„Ø£Ø·ÙˆÙ„:", "Longest:") @Model.LongestStreak @Html.T("ÙŠÙˆÙ…", "days")</small>
                    </div>
                    <div class="avatar-text avatar-lg bg-soft-danger text-danger">
                        <i class="feather-zap"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Badges Grid -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center justify-content-between">
            <h5 class="fw-bold mb-0">
                <i class="feather-star text-warning me-2"></i>
                @Html.T("Ø´Ø§Ø±Ø§ØªÙŠ Ø§Ù„Ù…Ø­ØµÙ„Ø©", "My earned badges") (@Model.EarnedBadges.Count)
            </h5>
            <a asp-action="PointsHistory" class="btn btn-sm btn-light-brand">
                <i class="feather-list me-2"></i>
                @Html.T("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‚Ø§Ø·", "Points history")
            </a>
        </div>
    </div>
    
    @if (Model.EarnedBadges.Any())
    {
        @foreach (var badge in Model.EarnedBadges)
        {
            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                <div class="card badge-card stretch stretch-full text-center">
                    <div class="card-body">
                        <div class="badge-icon bg-soft-@(GetBadgeColor(badge.Badge.Rarity)) text-@(GetBadgeColor(badge.Badge.Rarity))">
                            @if (!string.IsNullOrEmpty(badge.Badge.IconUrl))
                            {
                                <img src="@badge.Badge.IconUrl" alt="@badge.Badge.Name" style="width: 50px; height: 50px;" />
                            }
                            else
                            {
                                <text>ğŸ†</text>
                            }
                        </div>
                        <h6 class="fw-bold mb-1">@badge.Badge.Name</h6>
                        <small class="text-muted">@badge.Badge.Description</small>
                        <div class="mt-2">
                            <span class="badge badge-sm bg-soft-success text-success">
                                @badge.AwardedAt.ToString("dd/MM/yyyy")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="feather-info me-2"></i>
                Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Ø§Øª!
            </div>
        </div>
    }
</div>

<!-- Locked Badges -->
<div class="row g-4">
    <div class="col-12">
        <h5 class="fw-bold mb-3">
            <i class="feather-lock text-muted me-2"></i>
            @Html.T("Ø´Ø§Ø±Ø§Øª Ù„Ù… ØªØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯", "Badges not yet earned") (@Model.LockedBadges.Count)
        </h5>
    </div>
    
    @if (Model.LockedBadges.Any())
    {
        @foreach (var badge in Model.LockedBadges.Take(lockedBadgesLimit))
        {
            var progress = CalculateBadgeProgress(badge, Model);
            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                <div class="card badge-card badge-locked stretch stretch-full text-center">
                    <div class="card-body">
                        <div class="badge-icon bg-soft-secondary text-secondary">
                            @if (!string.IsNullOrEmpty(badge.IconUrl))
                            {
                                <img src="@badge.IconUrl" alt="@badge.Name" style="width: 50px; height: 50px; opacity: 0.3;" />
                            }
                            else
                            {
                                <i class="feather-lock"></i>
                            }
                        </div>
                        <h6 class="fw-bold mb-1">@badge.Name</h6>
                        <small class="text-muted">@badge.Description</small>
                        @if (progress.current > 0)
                        {
                            <div class="progress ht-5 mt-2">
                                <div class="progress-bar bg-primary" style="width: @((progress.current / (double)progress.target * 100).ToString("F0"))%"></div>
                            </div>
                            <small class="text-primary">@progress.current/@progress.target</small>
                        }
                        else
                        {
                            <div class="mt-2">
                                <small class="text-muted">@badge.RequiredPoints @Html.T("Ù†Ù‚Ø·Ø© Ù…Ø·Ù„ÙˆØ¨Ø©", "points required")</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="col-12">
            <div class="alert alert-success text-center">
                <i class="feather-award me-2"></i>
                @Html.T("Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©!", "Great! You've earned all available badges!")
            </div>
        </div>
    }
</div>

@functions {
    string GetBadgeColor(LMS.Domain.Enums.BadgeRarity rarity)
    {
        return rarity switch
        {
            LMS.Domain.Enums.BadgeRarity.Common => "secondary",
            LMS.Domain.Enums.BadgeRarity.Rare => "info",
            LMS.Domain.Enums.BadgeRarity.Epic => "primary",
            LMS.Domain.Enums.BadgeRarity.Legendary => "warning",
            _ => "secondary"
        };
    }

    (int current, int target) CalculateBadgeProgress(LMS.Domain.Entities.Gamification.Badge badge, GamificationDashboardViewModel model)
    {
        // Simple progress calculation based on points
        var current = Math.Min(model.CurrentPoints, badge.RequiredPoints);
        return (current, badge.RequiredPoints);
    }
}

