@model LMS.Areas.Student.ViewModels.SubscriptionCancelViewModel
@{
    ViewData["Title"] = Html.T("إلغاء الاشتراك", "Cancel Subscription");
}

@section Styles {
<style>
    .cancel-container {
        max-width: 700px;
        margin: 0 auto;
    }
    
    .warning-header {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .warning-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2.5rem;
    }
    
    .benefit-item {
        padding: 1rem;
        border-radius: 8px;
        background: #fef3c7;
        border: 1px solid #fcd34d;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .benefit-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .reason-option {
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0.75rem;
    }
    
    .reason-option:hover {
        border-color: #667eea;
        background: #f9fafb;
    }
    
    .reason-option input[type="radio"] {
        width: 20px;
        height: 20px;
    }
    
    .reason-option.selected {
        border-color: #667eea;
        background: #eff6ff;
    }
    
    .cancel-option-card {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .cancel-option-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
    }
    
    .cancel-option-card.selected {
        border-color: #667eea;
        background: #eff6ff;
    }
    
    .cancel-option-card input[type="radio"] {
        width: 20px;
        height: 20px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
    }
    
    .alternative-plan {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .alternative-plan:hover {
        border-color: #22c55e;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<div class="cancel-container">
    <!-- Breadcrumb -->
    <div class="d-flex align-items-center gap-2 mb-4">
        <a asp-action="Details" asp-route-id="@Model.Id" class="text-muted">
            <i class="feather-arrow-right me-2"></i>
            @Html.T("العودة لتفاصيل الاشتراك", "Back to subscription details")
        </a>
    </div>

    <!-- Warning Header -->
    <div class="warning-header">
        <div class="warning-icon">
            <i class="feather-alert-triangle"></i>
        </div>
        <h2 class="text-white fw-bold mb-2">@Html.T("هل أنت متأكد من إلغاء الاشتراك؟", "Are you sure you want to cancel your subscription?")</h2>
        <p class="text-white opacity-75 mb-0">@Html.T("سنفتقدك! نأمل أن تعود قريباً", "We'll miss you! We hope to see you again soon")</p>
    </div>

    <!-- Your Progress -->
    <div class="card stretch stretch-full mb-4">
        <div class="card-header">
            <h5 class="fw-bold mb-0">
                <i class="feather-trending-up text-primary me-2"></i>
                @Html.T("إنجازاتك معنا", "Your progress with us")
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3 class="fw-bold mb-2">@Model.Stats?.CoursesCompleted ?? 0</h3>
                        <p class="mb-0 opacity-75">@Html.T("دورة مكتملة", "Course completed")</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3 class="fw-bold mb-2">@Model.Stats?.LearningHours ?? 0</h3>
                        <p class="mb-0 opacity-75">@Html.T("ساعة تعلم", "Learning hours")</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h3 class="fw-bold mb-2">@Model.Stats?.CertificatesEarned ?? 0</h3>
                        <p class="mb-0 opacity-75">@Html.T("شهادة معتمدة", "Certificates earned")</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- What You'll Lose -->
    <div class="card stretch stretch-full mb-4">
        <div class="card-header">
            <h5 class="fw-bold mb-0">
                <i class="feather-x-circle text-danger me-2"></i>
                @Html.T("ما الذي ستفقده عند الإلغاء", "What you'll lose by cancelling")
            </h5>
        </div>
        <div class="card-body">
            <div class="benefit-item">
                <div class="benefit-icon">
                    <i class="feather-book"></i>
                </div>
                <div>
                    <strong>@Html.T("وصول غير محدود لآلاف الدورات", "Unlimited access to thousands of courses")</strong>
                    <p class="mb-0 text-muted small">@Html.T("لن تتمكن من الوصول إلى محتوى الدورات المتميزة", "You won't be able to access premium course content")</p>
                </div>
            </div>

            <div class="benefit-item">
                <div class="benefit-icon">
                    <i class="feather-award"></i>
                </div>
                <div>
                    <strong>@Html.T("الشهادات المعتمدة", "Certified certificates")</strong>
                    <p class="mb-0 text-muted small">@Html.T("لن تتمكن من الحصول على شهادات جديدة عند إتمام الدورات", "You won't be able to earn new certificates when completing courses")</p>
                </div>
            </div>

            <div class="benefit-item">
                <div class="benefit-icon">
                    <i class="feather-video"></i>
                </div>
                <div>
                    <strong>@Html.T("الجلسات المباشرة مع المدربين", "Live sessions with instructors")</strong>
                    <p class="mb-0 text-muted small">@Html.T("ستفقد إمكانية حضور الجلسات التفاعلية المباشرة", "You'll lose access to live interactive sessions")</p>
                </div>
            </div>

            <div class="benefit-item">
                <div class="benefit-icon">
                    <i class="feather-headphones"></i>
                </div>
                <div>
                    <strong>@Html.T("الدعم الفني المتميز", "Premium support")</strong>
                    <p class="mb-0 text-muted small">@Html.T("ستفقد الوصول للدعم الفني على مدار الساعة", "You'll lose 24/7 support access")</p>
                </div>
            </div>

            <div class="benefit-item">
                <div class="benefit-icon">
                    <i class="feather-download"></i>
                </div>
                <div>
                    <strong>@Html.T("تحميل المواد التعليمية", "Download learning materials")</strong>
                    <p class="mb-0 text-muted small">@Html.T("لن تتمكن من تحميل الموارد والملفات التعليمية", "You won't be able to download resources and learning files")</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alternative Offer -->
    <div class="card stretch stretch-full mb-4" style="border: 2px solid #22c55e;">
        <div class="card-body">
            <div class="text-center mb-4">
                <div class="avatar-text avatar-xl bg-success-subtle text-success mx-auto mb-3">
                    <i class="feather-gift"></i>
                </div>
                <h4 class="fw-bold mb-2">@Html.T("عرض خاص قبل المغادرة!", "Special offer before you go!")</h4>
                <p class="text-muted">@Html.T("احصل على", "Get") <strong class="text-success">@Html.T("خصم 30%", "30% off")</strong> @Html.T("على أي خطة للأشهر الثلاثة القادمة", "on any plan for the next three months")</p>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="alternative-plan">
                        <h6 class="fw-bold mb-2">@Html.T("خطة شهرية بخصم", "Discounted monthly plan")</h6>
                        <div class="mb-3">
                            <span class="text-decoration-line-through text-muted">$49</span>
                            <span class="fs-4 fw-bold text-success ms-2">$34</span>
                            <small class="text-muted">/@Html.T("شهر", "month")</small>
                        </div>
                        <button class="btn btn-outline-success btn-sm w-100">
                            @Html.T("احصل على العرض", "Get the offer")
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alternative-plan">
                        <h6 class="fw-bold mb-2">@Html.T("خطة سنوية بخصم", "Discounted yearly plan")</h6>
                        <div class="mb-3">
                            <span class="text-decoration-line-through text-muted">$469</span>
                            <span class="fs-4 fw-bold text-success ms-2">$328</span>
                            <small class="text-muted">/@Html.T("سنة", "year")</small>
                        </div>
                        <button class="btn btn-success btn-sm w-100">
                            @Html.T("احصل على العرض", "Get the offer")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancellation Reasons -->
    <form asp-action="CancelConfirm" method="post" id="cancelForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />

        <div class="card stretch stretch-full mb-4">
            <div class="card-header">
                <h5 class="fw-bold mb-0">
                    <i class="feather-message-circle text-primary me-2"></i>
                    @Html.T("ساعدنا في التحسين - لماذا تريد الإلغاء؟", "Help us improve - why do you want to cancel?")
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="too_expensive" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("السعر مرتفع للغاية", "Price is too high")</strong>
                                <p class="mb-0 text-muted small">@Html.T("لا يتناسب السعر مع ميزانيتي", "The price doesn't fit my budget")</p>
                            </div>
                        </div>
                    </label>

                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="not_using" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("لا أستخدم المنصة كثيراً", "I don't use the platform much")</strong>
                                <p class="mb-0 text-muted small">@Html.T("ليس لدي الوقت الكافي حالياً", "I don't have enough time right now")</p>
                            </div>
                        </div>
                    </label>

                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="missing_content" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("المحتوى غير مناسب", "Content not suitable")</strong>
                                <p class="mb-0 text-muted small">@Html.T("لا أجد الدورات التي أبحث عنها", "I can't find the courses I'm looking for")</p>
                            </div>
                        </div>
                    </label>

                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="technical_issues" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("مشاكل تقنية", "Technical issues")</strong>
                                <p class="mb-0 text-muted small">@Html.T("أواجه صعوبات في استخدام المنصة", "I'm having trouble using the platform")</p>
                            </div>
                        </div>
                    </label>

                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="found_alternative" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("وجدت بديل أفضل", "Found a better alternative")</strong>
                                <p class="mb-0 text-muted small">@Html.T("أستخدم منصة أخرى", "I'm using another platform")</p>
                            </div>
                        </div>
                    </label>

                    <label class="reason-option">
                        <div class="d-flex align-items-center gap-3">
                            <input type="radio" name="CancellationReason" value="other" asp-for="CancellationReason">
                            <div class="flex-grow-1">
                                <strong>@Html.T("سبب آخر", "Other reason")</strong>
                            </div>
                        </div>
                    </label>
                </div>

                <div class="mb-3">
                    <label class="form-label">@Html.T("تفاصيل إضافية (اختياري)", "Additional details (optional)")</label>
                    <textarea class="form-control" name="AdditionalFeedback" rows="3" 
                              placeholder="@Html.T("نقدر ملاحظاتك التي تساعدنا في التحسين...", "We value your feedback to help us improve...")"></textarea>
                </div>
            </div>
        </div>

        <!-- Cancellation Options -->
        <div class="card stretch stretch-full mb-4">
            <div class="card-header">
                <h5 class="fw-bold mb-0">
                    <i class="feather-settings text-warning me-2"></i>
                    @Html.T("متى تريد إلغاء الاشتراك؟", "When do you want to cancel?")
                </h5>
            </div>
            <div class="card-body">
                <label class="cancel-option-card selected">
                    <div class="d-flex align-items-start gap-3">
                        <input type="radio" name="CancelAtPeriodEnd" value="true" checked asp-for="CancelAtPeriodEnd">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="feather-clock text-primary"></i>
                                <strong>@Html.T("الإلغاء في نهاية الفترة الحالية", "Cancel at end of current period")</strong>
                                <span class="badge bg-success">@Html.T("موصى به", "Recommended")</span>
                            </div>
                            <p class="text-muted mb-2">
                                @Html.T("ستحتفظ بالوصول الكامل للمنصة حتى", "You'll keep full access until") <strong>@Model.CurrentPeriodEnd.ToString("dd MMMM yyyy")</strong>
                            </p>
                            <div class="alert alert-info mb-0">
                                <small>
                                    <i class="feather-info-circle me-1"></i>
                                    @Html.T("استفد من باقي أيام اشتراكك ولن يتم خصم أي رسوم إضافية", "Use the rest of your subscription days; no additional charges will be made")
                                </small>
                            </div>
                        </div>
                    </div>
                </label>

                <label class="cancel-option-card">
                    <div class="d-flex align-items-start gap-3">
                        <input type="radio" name="CancelAtPeriodEnd" value="false" asp-for="CancelAtPeriodEnd">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="feather-x-circle text-danger"></i>
                                <strong>@Html.T("الإلغاء الفوري", "Cancel immediately")</strong>
                            </div>
                            <p class="text-muted mb-2">
                                @Html.T("سيتم إلغاء اشتراكك فوراً وستفقد الوصول للمنصة", "Your subscription will be cancelled immediately and you'll lose platform access")
                            </p>
                            <div class="alert alert-warning mb-0">
                                <small>
                                    <i class="feather-alert-triangle me-1"></i>
                                    @Html.T("لن يتم استرداد المبلغ المدفوع عن الفترة الحالية", "No refund for the current period")
                                </small>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Important Notice -->
        <div class="alert alert-warning">
            <div class="d-flex align-items-start gap-2">
                <i class="feather-info fs-5 mt-1"></i>
                <div>
                    <strong>@Html.T("معلومات مهمة:", "Important information:")</strong>
                    <ul class="mb-0 mt-2">
                        <li>@Html.T("بعد الإلغاء، لن تتمكن من الوصول إلى الدورات المدفوعة", "After cancellation, you won't have access to paid courses")</li>
                        <li>@Html.T("سيتم الاحتفاظ بتقدمك وشهاداتك في حسابك", "Your progress and certificates will remain in your account")</li>
                        <li>@Html.T("يمكنك إعادة الاشتراك في أي وقت للاستمرار من حيث توقفت", "You can resubscribe anytime to continue where you left off")</li>
                        <li>@Html.T("سيتم إرسال بريد إلكتروني بتأكيد الإلغاء", "A confirmation email will be sent")</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-danger btn-lg" id="confirmCancelBtn">
                        <i class="feather-x-circle me-2"></i>
                        @Html.T("تأكيد إلغاء الاشتراك", "Confirm cancellation")
                    </button>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary btn-lg">
                        <i class="feather-arrow-right me-2"></i>
                        @Html.T("الاحتفاظ بالاشتراك", "Keep subscription")
                    </a>
                </div>
            </div>
        </div>
    </form>

    <!-- Contact Support -->
    <div class="text-center mt-4 mb-4">
        <p class="text-muted mb-2">@Html.T("هل تواجه مشكلة يمكننا مساعدتك بها؟", "Having an issue we can help with?")</p>
        <a asp-action="Index" asp-controller="Support" class="btn btn-link">
            <i class="feather-help-circle me-2"></i>
            @Html.T("تواصل مع الدعم الفني", "Contact support")
        </a>
    </div>
</div>

@section Scripts {
<script>
    window.__T = window.__T || {};
    window.__T.PleaseSelectReason = '@Html.Raw(Html.T("يرجى اختيار سبب الإلغاء", "Please select a cancellation reason").ToString().Replace("'", "\\'"))';
    window.__T.ConfirmCancelSubscription = '@Html.Raw(Html.T("هل أنت متأكد من رغبتك في إلغاء الاشتراك؟ نأمل أن نراك مرة أخرى قريباً!", "Are you sure you want to cancel? We hope to see you again soon!").ToString().Replace("'", "\\'"))';
    window.__T.Cancelling = '@Html.Raw(Html.T("جاري الإلغاء...", "Cancelling...").ToString().Replace("'", "\\'"))';
    // Handle reason option selection
    document.querySelectorAll('.reason-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.reason-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
        });
    });

    // Handle cancel option selection
    document.querySelectorAll('.cancel-option-card').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.cancel-option-card').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
        });
    });

    // Confirm cancellation
    document.getElementById('cancelForm').addEventListener('submit', function(e) {
        const confirmBtn = document.getElementById('confirmCancelBtn');
        const selectedReason = document.querySelector('input[name="CancellationReason"]:checked');
        const T = window.__T || {};

        if (!selectedReason) {
            e.preventDefault();
            alert(T.PleaseSelectReason || 'Please select a cancellation reason');
            return;
        }

        const confirmed = confirm(T.ConfirmCancelSubscription || 'Are you sure you want to cancel? We hope to see you again soon!');
        
        if (confirmed) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (T.Cancelling || 'Cancelling...');
        } else {
            e.preventDefault();
        }
    });
</script>
}

