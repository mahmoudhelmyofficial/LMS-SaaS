@model CompareAttemptsViewModel
@{
    ViewData["Title"] = Html.T("مقارنة المحاولات", "Compare Attempts");
}

@section Styles {
<style>
    .compare-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        height: 100%;
    }
    .improvement {
        color: #22c55e;
    }
    .decline {
        color: #ef4444;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <h3 class="fw-bold mb-2">
            <i class="feather-git-compare text-primary me-2"></i>
            @Html.T("مقارنة المحاولات", "Compare attempts")
        </h3>
        <p class="text-muted mb-0">@Model.Quiz.Title</p>
    </div>
</div>

<!-- Attempts Selection -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label">@Html.T("المحاولة الأولى", "First attempt")</label>
                <select name="attempt1Id" class="form-select" onchange="this.form.submit()">
                    @foreach (var attempt in Model.Attempts)
                    {
                        <option value="@attempt.Id" selected="@(attempt.Id == Model.Attempt1?.Id)">
                            المحاولة #@attempt.AttemptNumber - @attempt.ScorePercentage% (@attempt.CompletedAt.ToString("yyyy/MM/dd"))
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2 text-center">
                <i class="feather-arrow-right" style="font-size: 24px;"></i>
            </div>

            <div class="col-md-5">
                <label class="form-label">@Html.T("المحاولة الثانية", "Second attempt")</label>
                <select name="attempt2Id" class="form-select" onchange="this.form.submit()">
                    @foreach (var attempt in Model.Attempts)
                    {
                        <option value="@attempt.Id" selected="@(attempt.Id == Model.Attempt2?.Id)">
                            المحاولة #@attempt.AttemptNumber - @attempt.ScorePercentage% (@attempt.CompletedAt.ToString("yyyy/MM/dd"))
                        </option>
                    }
                </select>
            </div>
        </form>
    </div>
</div>

@if (Model.Attempt1 != null && Model.Attempt2 != null)
{
    <!-- Score Comparison -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="compare-card text-center">
                <h6 class="text-muted mb-3">@Html.T("الدرجة", "Score")</h6>
                <div class="d-flex justify-content-around align-items-center">
                    <div>
                        <h3 class="fw-bold">@Model.Attempt1.ScorePercentage%</h3>
                        <small class="text-muted">@Html.T("المحاولة 1", "Attempt 1")</small>
                    </div>
                    <div>
                        @{
                            var scoreDiff = Model.Attempt2.ScorePercentage - Model.Attempt1.ScorePercentage;
                        }
                        @if (scoreDiff > 0)
                        {
                            <div class="improvement">
                                <i class="feather-arrow-up"></i>
                                +@scoreDiff.ToString("F1")%
                            </div>
                        }
                        else if (scoreDiff < 0)
                        {
                            <div class="decline">
                                <i class="feather-arrow-down"></i>
                                @scoreDiff.ToString("F1")%
                            </div>
                        }
                        else
                        {
                            <div class="text-muted">
                                <i class="feather-minus"></i>
                                0%
                            </div>
                        }
                    </div>
                    <div>
                        <h3 class="fw-bold">@Model.Attempt2.ScorePercentage%</h3>
                        <small class="text-muted">@Html.T("المحاولة 2", "Attempt 2")</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="compare-card text-center">
                <h6 class="text-muted mb-3">@Html.T("الإجابات الصحيحة", "Correct answers")</h6>
                <div class="d-flex justify-content-around align-items-center">
                    <div>
                        <h3 class="fw-bold">@Model.Attempt1Correct</h3>
                        <small class="text-muted">@Html.T("من", "of") @Model.TotalQuestions</small>
                    </div>
                    <div>
                        @{
                            var correctDiff = Model.Attempt2Correct - Model.Attempt1Correct;
                        }
                        @if (correctDiff > 0)
                        {
                            <div class="improvement">
                                <i class="feather-arrow-up"></i>
                                +@correctDiff
                            </div>
                        }
                        else if (correctDiff < 0)
                        {
                            <div class="decline">
                                <i class="feather-arrow-down"></i>
                                @correctDiff
                            </div>
                        }
                        else
                        {
                            <div class="text-muted">
                                <i class="feather-minus"></i>
                                0
                            </div>
                        }
                    </div>
                    <div>
                        <h3 class="fw-bold">@Model.Attempt2Correct</h3>
                        <small class="text-muted">@Html.T("من", "of") @Model.TotalQuestions</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="compare-card text-center">
                <h6 class="text-muted mb-3">@Html.T("الوقت المستغرق", "Time taken")</h6>
                <div class="d-flex justify-content-around align-items-center">
                    <div>
                        <h3 class="fw-bold">@((int)Model.Attempt1Time.TotalMinutes)</h3>
                        <small class="text-muted">@Html.T("دقيقة", "min")</small>
                    </div>
                    <div>
                        @{
                            var timeDiff = Model.Attempt1Time - Model.Attempt2Time;
                            var timeDiffMinutes = (int)timeDiff.TotalMinutes;
                        }
                        @if (timeDiffMinutes > 0)
                        {
                            <div class="improvement">
                                <i class="feather-arrow-down"></i>
                                -@timeDiffMinutes @Html.T("دقيقة", "min")
                            </div>
                        }
                        else if (timeDiffMinutes < 0)
                        {
                            <div class="decline">
                                <i class="feather-arrow-up"></i>
                                +@Math.Abs(timeDiffMinutes) @Html.T("دقيقة", "min")
                            </div>
                        }
                        else
                        {
                            <div class="text-muted">
                                <i class="feather-minus"></i>
                                0 @Html.T("دقيقة", "min")
                            </div>
                        }
                    </div>
                    <div>
                        <h3 class="fw-bold">@((int)Model.Attempt2Time.TotalMinutes)</h3>
                        <small class="text-muted">@Html.T("دقيقة", "min")</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Comparison -->
    <div class="card stretch stretch-full mb-4">
        <div class="card-body">
            <h5 class="fw-bold mb-4">
                <i class="feather-bar-chart text-primary me-2"></i>
                @Html.T("المقارنة حسب التصنيف", "Comparison by category")
            </h5>
            
            <canvas id="categoryComparisonChart" height="80"></canvas>
        </div>
    </div>

    <!-- Overall Assessment -->
    <div class="card stretch stretch-full">
        <div class="card-body">
            <h5 class="fw-bold mb-4">
                <i class="feather-info text-info me-2"></i>
                @Html.T("التقييم الشامل", "Overall assessment")
            </h5>
            
            @{
                var overallImprovement = Model.Attempt2.ScorePercentage - Model.Attempt1.ScorePercentage;
            }
            
            @if (overallImprovement > 0)
            {
                <div class="alert alert-success">
                    <h6 class="fw-bold mb-2">
                        <i class="feather-trending-up me-2"></i>
                        @Html.T("تحسن ملحوظ!", "Notable improvement!") (+@overallImprovement.ToString("F1")%)
                    </h6>
                    <p class="mb-0">@Html.T("أداؤك تحسن في المحاولة الثانية. استمر في هذا المستوى الرائع!", "Your performance improved on the second attempt. Keep up the great work!")</p>
                </div>
            }
            else if (overallImprovement < 0)
            {
                <div class="alert alert-warning">
                    <h6 class="fw-bold mb-2">
                        <i class="feather-trending-down me-2"></i>
                        @Html.T("انخفاض في الأداء", "Performance decline") (@overallImprovement.ToString("F1")%)
                    </h6>
                    <p class="mb-0">@Html.T("أداؤك انخفض قليلاً. راجع المواد وحاول التركيز أكثر في المحاولة القادمة.", "Your performance dropped slightly. Review the material and try to focus more on the next attempt.")</p>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <h6 class="fw-bold mb-2">
                        <i class="feather-activity me-2"></i>
                        @Html.T("أداء ثابت", "Steady performance")
                    </h6>
                    <p class="mb-0">@Html.T("حصلت على نفس الدرجة في المحاولتين.", "You got the same score on both attempts.")</p>
                </div>
            }
        </div>
    </div>

    @section Scripts {
    <script>
        (function(){ window.__T = window.__T || {}; window.__T.Attempt1 = '@Html.Raw(Html.T("المحاولة 1", "Attempt 1").Replace("\\", "\\\\").Replace("'", "\\'"))'; window.__T.Attempt2 = '@Html.Raw(Html.T("المحاولة 2", "Attempt 2").Replace("\\", "\\\\").Replace("'", "\\'"))'; })();
        const ctx = document.getElementById('categoryComparisonChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.CategoryComparison.Select(c => c.CategoryName))),
                datasets: [
                    {
                        label: (window.__T && window.__T.Attempt1) || 'Attempt 1',
                        data: @Html.Raw(Json.Serialize(Model.CategoryComparison.Select(c => c.Attempt1Score))),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)'
                    },
                    {
                        label: (window.__T && window.__T.Attempt2) || 'Attempt 2',
                        data: @Html.Raw(Json.Serialize(Model.CategoryComparison.Select(c => c.Attempt2Score))),
                        backgroundColor: 'rgba(34, 197, 94, 0.8)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    </script>
    }
}
else
{
    <div class="alert alert-info">
        <i class="feather-info me-2"></i>
        @Html.T("اختر محاولتين للمقارنة", "Select two attempts to compare")
    </div>
}
