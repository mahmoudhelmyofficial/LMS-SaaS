@model List<LMS.Areas.Student.ViewModels.InvoiceDisplayViewModel>
@{
    ViewData["Title"] = Html.T("الفواتير", "Invoices");
    var currentPage = ViewBag.Page as int? ?? 1;
}

@section Styles {
<style>
    .invoice-card {
        transition: all 0.2s ease;
    }
    .invoice-card:hover {
        background-color: #f9fafb;
    }
    .table-responsive { -webkit-overflow-scrolling: touch; max-width: 100%; }
    .invoice-mobile-card {
        border-radius: 12px;
        border: 1px solid var(--border-color-light, #f1f5f9);
        transition: all 0.2s ease;
    }
    .invoice-mobile-card:hover {
        background-color: #f9fafb;
    }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<!-- Header -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h3 class="fw-bold mb-2">
                    <i class="feather-file-text text-primary me-2"></i>
                    @Html.T("فواتيري", "My invoices")
                </h3>
                <p class="text-muted mb-0">@Html.T("تاريخ مشترياتك وفواتيرك", "Your purchase and invoice history")</p>
            </div>
        </div>
    </div>
</div>

<!-- Invoices List -->
<div class="card stretch stretch-full">
    <div class="card-body p-0">
        @if (Model != null && Model.Any())
        {
            <!-- Mobile: card list (visible on small screens only) -->
            <div class="d-md-none p-3">
                @foreach (var invoice in Model)
                {
                    var statusClass = invoice.Status?.ToLower() switch
                    {
                        "paid" => "success",
                        "pending" => "warning",
                        "overdue" => "danger",
                        "cancelled" => "secondary",
                        _ => "secondary"
                    };
                    var statusText = invoice.Status?.ToLower() switch
                    {
                        "paid" => Html.T("مدفوعة", "Paid").ToString(),
                        "pending" => Html.T("قيد الانتظار", "Pending").ToString(),
                        "overdue" => Html.T("متأخرة", "Overdue").ToString(),
                        "cancelled" => Html.T("ملغاة", "Cancelled").ToString(),
                        _ => Html.T("غير معروف", "Unknown").ToString()
                    };
                    <div class="invoice-mobile-card card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong class="text-primary">#@invoice.InvoiceNumber</strong>
                                <span class="badge bg-@statusClass">@statusText</span>
                            </div>
                            <p class="mb-1"><strong>@(invoice.CourseName ?? Html.T("دورة", "Course").ToString())</strong></p>
                            <p class="text-muted fs-12 mb-2">@invoice.IssuedDate.ToString("dd/MM/yyyy")</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-@(invoice.Status?.ToLower() == "paid" ? "success" : "muted")">@invoice.TotalAmount.ToEGP(2)</strong>
                                <div class="d-flex gap-2">
                                    <a asp-action="View" asp-route-id="@invoice.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="feather-eye"></i>
                                    </a>
                                    <a asp-action="Download" asp-route-id="@invoice.Id" class="btn btn-sm btn-outline-secondary">
                                        <i class="feather-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <!-- Desktop: table (hidden on small screens) -->
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>@Html.T("رقم الفاتورة", "Invoice number")</th>
                                <th>@Html.T("التاريخ", "Date")</th>
                                <th>@Html.T("الوصف", "Description")</th>
                                <th class="text-center">@Html.T("الحالة", "Status")</th>
                                <th class="text-end">@Html.T("المبلغ", "Amount")</th>
                                <th class="text-center">@Html.T("الإجراءات", "Actions")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in Model)
                            {
                                var statusClass = invoice.Status?.ToLower() switch
                                {
                                    "paid" => "success",
                                    "pending" => "warning",
                                    "overdue" => "danger",
                                    "cancelled" => "secondary",
                                    _ => "secondary"
                                };
                                var statusText = invoice.Status?.ToLower() switch
                                {
                                    "paid" => Html.T("مدفوعة", "Paid").ToString(),
                                    "pending" => Html.T("قيد الانتظار", "Pending").ToString(),
                                    "overdue" => Html.T("متأخرة", "Overdue").ToString(),
                                    "cancelled" => Html.T("ملغاة", "Cancelled").ToString(),
                                    _ => Html.T("غير معروف", "Unknown").ToString()
                                };
                                <tr class="invoice-card">
                                    <td>
                                        <strong class="text-primary">#@invoice.InvoiceNumber</strong>
                                    </td>
                                    <td>
                                        <span class="text-muted">@invoice.IssuedDate.ToString("dd/MM/yyyy")</span>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@(invoice.CourseName ?? Html.T("دورة", "Course").ToString())</strong>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-@statusClass">@statusText</span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-@(invoice.Status?.ToLower() == "paid" ? "success" : "muted")">@invoice.TotalAmount.ToEGP(2)</strong>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex gap-2 justify-content-center">
                                            <a asp-action="View" asp-route-id="@invoice.Id" class="btn btn-sm btn-icon btn-outline-primary" title="@Html.T("عرض", "View")">
                                                <i class="feather-eye"></i>
                                            </a>
                                            <a asp-action="Download" asp-route-id="@invoice.Id" class="btn btn-sm btn-icon btn-outline-secondary" title="@Html.T("تحميل", "Download")">
                                                <i class="feather-download"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-3">
                    <i class="feather-file-text"></i>
                </div>
                <h5 class="fw-bold">@Html.T("لا توجد فواتير", "No invoices")</h5>
                <p class="text-muted">@Html.T("لم تقم بأي عمليات شراء بعد", "You haven't made any purchases yet")</p>
                <a asp-area="Student" asp-controller="Courses" asp-action="Browse" class="btn btn-primary">
                    <i class="feather-search me-2"></i>
                    @Html.T("تصفح الدورات", "Browse courses")
                </a>
            </div>
        }
    </div>
</div>

