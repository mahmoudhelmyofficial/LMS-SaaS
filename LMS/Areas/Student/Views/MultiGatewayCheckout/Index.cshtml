@model LMS.Areas.Student.ViewModels.MultiGatewayCheckoutViewModel
@using LMS.Domain.Enums
@{
    ViewData["Title"] = Html.T("Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡", "Complete Purchase");
    Layout = "_StudentLayout";
}

<div class="container py-5">
    <div class="row">
        <!-- Order Summary -->
        <div class="col-lg-4 order-lg-2">
            <div class="card shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        @Html.T("Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨", "Order summary")
                    </h5>
                </div>
                <div class="card-body">
                    @foreach (var item in Model.Cart.Items)
                    {
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-0">@item.Title</h6>
                                <small class="text-muted">
                                    @(item.Type == ProductType.Course ? Html.T("Ø¯ÙˆØ±Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©", "Course") : Html.T("ÙƒØªØ§Ø¨", "Book"))
                                </small>
                            </div>
                            <div class="text-end">
                                @if (item.DiscountAmount > 0)
                                {
                                    <span class="text-decoration-line-through text-muted small">@item.OriginalPrice.ToString("N2")</span>
                                }
                                <div class="fw-bold">@item.Price.ToEGP(2)</div>
                            </div>
                        </div>
                    }

                    <hr />

                    <div class="d-flex justify-content-between mb-2">
                        <span>@Html.T("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ", "Subtotal")</span>
                        <span>@Model.Cart.SubTotal.ToEGP(2)</span>
                    </div>

                    @if (Model.Cart.DiscountAmount > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>
                                <i class="fas fa-tag me-1"></i>
                                @Html.T("Ø§Ù„Ø®ØµÙ…", "Discount")
                                @if (Model.Cart.AppliedCoupon != null)
                                {
                                    <small>(@Model.Cart.AppliedCoupon.Code)</small>
                                }
                            </span>
                            <span>- @Model.Cart.DiscountAmount.ToEGP(2)</span>
                        </div>
                    }

                    <hr />

                    <div class="d-flex justify-content-between fs-5 fw-bold">
                        <span>@Html.T("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Total")</span>
                        <span class="text-primary">@Model.Cart.TotalAmount.ToEGP(2)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="col-lg-8 order-lg-1">
            <h2 class="mb-4">
                <i class="fas fa-credit-card text-primary me-2"></i>
                @Html.T("Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹", "Choose payment method")
            </h2>

            @if (!Model.AvailablePaymentMethods.Any())
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @Html.T("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.", "No payment methods available at the moment. Please contact support.")
                </div>
            }
            else
            {
                <form id="paymentForm">
                    @Html.AntiForgeryToken()

                    <!-- Payment Methods Grid -->
                    <div class="row g-3 mb-4">
                        @foreach (var method in Model.AvailablePaymentMethods.OrderBy(m => m.DisplayOrder))
                        {
                            var isRecommended = method.GatewayType == Model.RecommendedGateway;
                            var cardClass = isRecommended ? "border-primary border-2" : "";

                            <div class="col-md-6">
                                <div class="card h-100 payment-method-card @cardClass" data-gateway="@method.GatewayType">
                                    @if (isRecommended)
                                    {
                                        <div class="position-absolute top-0 end-0">
                                            <span class="badge bg-primary rounded-0 rounded-bottom-start">
                                                <i class="fas fa-star me-1"></i>
                                                @Html.T("Ù…ÙˆØµÙ‰ Ø¨Ù‡", "Recommended")
                                            </span>
                                        </div>
                                    }

                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="SelectedGateway"
                                                   id="gateway_@method.GatewayType" value="@method.GatewayType"
                                                   @(isRecommended ? "checked" : "")>
                                            <label class="form-check-label w-100" for="gateway_@method.GatewayType">
                                                <div class="d-flex align-items-center gap-3">
                                                    @if (!string.IsNullOrEmpty(method.IconUrl))
                                                    {
                                                        <img src="@method.IconUrl" alt="@method.DisplayName"
                                                             style="height: 40px; width: auto;">
                                                    }
                                                    else
                                                    {
                                                        <div class="avatar-text bg-primary text-white rounded"
                                                             style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                            @GetGatewayIcon(method.GatewayType)
                                                        </div>
                                                    }
                                                    <div>
                                                        <h6 class="mb-0">@(method.DisplayNameAr ?? method.DisplayName)</h6>
                                                        <small class="text-muted">@(method.DescriptionAr ?? method.Description)</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Payment method features -->
                                        <div class="mt-3 d-flex flex-wrap gap-1">
                                            @if (method.SupportsCards)
                                            {
                                                <span class="badge bg-light text-dark"><i class="fas fa-credit-card me-1"></i>@Html.T("Ø¨Ø·Ø§Ù‚Ø§Øª", "Cards")</span>
                                            }
                                            @if (method.SupportsWallets)
                                            {
                                                <span class="badge bg-light text-dark"><i class="fas fa-wallet me-1"></i>@Html.T("Ù…Ø­Ø§ÙØ¸", "Wallets")</span>
                                            }
                                            @if (method.SupportsCash)
                                            {
                                                <span class="badge bg-light text-dark"><i class="fas fa-money-bill me-1"></i>@Html.T("Ù†Ù‚Ø¯ÙŠ", "Cash")</span>
                                            }
                                            @if (method.SupportsInstallments)
                                            {
                                                <span class="badge bg-success"><i class="fas fa-calendar me-1"></i>@Html.T("ØªÙ‚Ø³ÙŠØ·", "Installments")</span>
                                            }
                                        </div>

                                        <!-- Fees info -->
                                        @if (method.FeePercentage > 0 || method.FixedFee > 0)
                                        {
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    @Html.T("Ø±Ø³ÙˆÙ…:", "Fees:")
                                                    @if (method.FeePercentage > 0)
                                                    {
                                                        <span>@method.FeePercentage%</span>
                                                    }
                                                    @if (method.FixedFee > 0)
                                                    {
                                                        <span>+ @method.FixedFee.ToEGP(2)</span>
                                                    }
                                                    (@method.FeePayer == "Customer" ? Html.T("ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Paid by customer") : Html.T("ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ø¨Ø§Ø¦Ø¹", "Paid by seller"))
                                                </small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Billing Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                @Html.T("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "Billing information")
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">@Html.T("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", "Full name")</label>
                                    <input type="text" name="BillingName" value="@Model.BillingName"
                                           class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">@Html.T("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "Email")</label>
                                    <input type="email" name="BillingEmail" value="@Model.BillingEmail"
                                           class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">@Html.T("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "Phone number")</label>
                                    <input type="tel" name="BillingPhone" value="@Model.BillingPhone"
                                           class="form-control" placeholder="@Html.T("01xxxxxxxxx", "01xxxxxxxxx")">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">@Html.T("Ø§Ù„Ø¯ÙˆÙ„Ø©", "Country")</label>
                                    <select name="UserCountry" class="form-select">
                                        <option value="EG" selected="@(Model.UserCountry == "EG")">ğŸ‡ªğŸ‡¬ @Html.T("Ù…ØµØ±", "Egypt")</option>
                                        <option value="SA" selected="@(Model.UserCountry == "SA")">ğŸ‡¸ğŸ‡¦ @Html.T("Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", "Saudi Arabia")</option>
                                        <option value="AE" selected="@(Model.UserCountry == "AE")">ğŸ‡¦ğŸ‡ª @Html.T("Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª", "UAE")</option>
                                        <option value="KW" selected="@(Model.UserCountry == "KW")">ğŸ‡°ğŸ‡¼ @Html.T("Ø§Ù„ÙƒÙˆÙŠØª", "Kuwait")</option>
                                        <option value="BH" selected="@(Model.UserCountry == "BH")">ğŸ‡§ğŸ‡­ @Html.T("Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†", "Bahrain")</option>
                                        <option value="QA" selected="@(Model.UserCountry == "QA")">ğŸ‡¶ğŸ‡¦ @Html.T("Ù‚Ø·Ø±", "Qatar")</option>
                                        <option value="OM" selected="@(Model.UserCountry == "OM")">ğŸ‡´ğŸ‡² @Html.T("Ø¹Ù…Ø§Ù†", "Oman")</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Card Option -->
                    <div class="form-check mb-4" id="saveCardOption" style="display: none;">
                        <input class="form-check-input" type="checkbox" name="SavePaymentMethod" id="savePaymentMethod">
                        <label class="form-check-label" for="savePaymentMethod">
                            <i class="fas fa-save me-1"></i>
                            @Html.T("Ø­ÙØ¸ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", "Save payment method for future purchases")
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="payButton">
                            <i class="fas fa-lock me-2"></i>
                            <span id="payButtonText">@Html.T("Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†", "Pay now") - @Model.Cart.TotalAmount.ToEGP(2)</span>
                            <span id="payButtonSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt text-success me-1"></i>
                            @Html.T("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø´ÙØ±Ø© ÙˆØ¢Ù…Ù†Ø© 100%", "All transactions are 100% encrypted and secure")
                        </small>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

@functions {
    string GetGatewayIcon(PaymentGatewayType gateway)
    {
        return gateway switch
        {
            PaymentGatewayType.Stripe => "<i class='fab fa-stripe-s'></i>",
            PaymentGatewayType.PayPal => "<i class='fab fa-paypal'></i>",
            PaymentGatewayType.Fawry => "<i class='fas fa-store'></i>",
            PaymentGatewayType.BankTransfer => "<i class='fas fa-university'></i>",
            PaymentGatewayType.VodafoneCash or
            PaymentGatewayType.OrangeCash or
            PaymentGatewayType.EtisalatCash => "<i class='fas fa-mobile-alt'></i>",
            _ => "<i class='fas fa-credit-card'></i>"
        };
    }
}

@section Scripts {
    <script>
        window.__T = window.__T || {};
        window.__T.Processing = '@Html.Raw(Html.T("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...", "Processing...").ToString().Replace("'", "\\'"))';
        window.__T.PaymentError = '@Html.Raw(Html.T("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹", "An error occurred while processing payment").ToString().Replace("'", "\\'"))';
        window.__T.PayNow = '@Html.Raw(Html.T("Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†", "Pay now").ToString().Replace("'", "\\'"))';
        window.__T.UnexpectedError = '@Html.Raw(Html.T("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "An unexpected error occurred. Please try again.").ToString().Replace("'", "\\'"))';
        window.__T.PaymentStarted = '@Html.Raw(Html.T("ØªÙ… Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­", "Payment process started successfully").ToString().Replace("'", "\\'"))';
        $(document).ready(function() {
            // Handle payment method selection
            $('.payment-method-card').on('click', function() {
                var radio = $(this).find('input[type="radio"]');
                radio.prop('checked', true);
                
                $('.payment-method-card').removeClass('border-primary border-2');
                $(this).addClass('border-primary border-2');
                
                // Show/hide save card option
                var gateway = radio.val();
                var supportsSaveCard = ['Stripe', 'Paymob', 'Tap'].includes(gateway);
                $('#saveCardOption').toggle(supportsSaveCard);
            });

            // Handle form submission
            $('#paymentForm').on('submit', function(e) {
                e.preventDefault();
                
                var form = $(this);
                var button = $('#payButton');
                var buttonText = $('#payButtonText');
                var spinner = $('#payButtonSpinner');
                
                // Disable button and show spinner
                button.prop('disabled', true);
                buttonText.text((window.__T && window.__T.Processing) || 'Processing...');
                spinner.show();
                
                $.ajax({
                    url: '@Url.Action("ProcessPayment")',
                    method: 'POST',
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            if (response.requiresRedirect && response.redirectUrl) {
                                // Redirect to payment page
                                window.location.href = response.redirectUrl;
                            } else if (response.isFawry) {
                                // Redirect to Fawry reference page
                                window.location.href = response.redirectUrl;
                            } else if (response.isBankTransfer) {
                                // Redirect to bank transfer instructions
                                window.location.href = response.redirectUrl;
                            } else if (response.clientSecret) {
                                // Handle Stripe client-side
                                handleStripePayment(response.clientSecret);
                            } else {
                                window.location.href = response.redirectUrl || '@Url.Action("Success")';
                            }
                        } else {
                            alert('âŒ ' + (response.message || (window.__T && window.__T.PaymentError) || 'An error occurred while processing payment'));
                            button.prop('disabled', false);
                            buttonText.text((window.__T && window.__T.PayNow || 'Pay now') + ' - @Model.Cart.TotalAmount.ToEGP(2)');
                            spinner.hide();
                        }
                    },
                    error: function() {
                        alert('âŒ ' + ((window.__T && window.__T.UnexpectedError) || 'An unexpected error occurred. Please try again.'));
                        button.prop('disabled', false);
                        buttonText.text((window.__T && window.__T.PayNow || 'Pay now') + ' - @Model.Cart.TotalAmount.ToEGP(2)');
                        spinner.hide();
                    }
                });
            });
            
            // Function to handle Stripe payment (if using Stripe.js)
            function handleStripePayment(clientSecret) {
                // This would use Stripe.js to confirm the payment
                // For now, redirect to success page
                alert('âœ… ' + ((window.__T && window.__T.PaymentStarted) || 'Payment process started successfully'));
                window.location.href = '@Url.Action("Success")';
            }
        });
    </script>
}

<style>
    .payment-method-card {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .payment-method-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .payment-method-card.border-primary {
        background-color: rgba(13, 110, 253, 0.05);
    }
</style>

