@model LMS.Areas.Student.ViewModels.BookDownloadViewModel
@using LMS.Domain.Enums
@using LMS.Services.Interfaces
@inject IPlatformSettingsService PlatformSettings
@{
    ViewData["Title"] = Html.T("تحميل الكتاب", "Download Book");
    
    // Download threshold settings
    var downloadHighUsageThreshold = await PlatformSettings.GetIntSettingAsync("Threshold.Download.HighUsage", 80);
    var downloadMediumUsageThreshold = await PlatformSettings.GetIntSettingAsync("Threshold.Download.MediumUsage", 50);
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<nav aria-label="@Html.T("مسار التنقل", "Breadcrumb")" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="Student" asp-controller="Dashboard" asp-action="Index">@Html.T("الرئيسية", "Home")</a></li>
        <li class="breadcrumb-item"><a asp-area="Student" asp-controller="Books" asp-action="Index">@Html.T("الكتب", "Books")</a></li>
        <li class="breadcrumb-item"><a asp-area="Student" asp-controller="Books" asp-action="MyLibrary">@Html.T("مكتبتي", "My Library")</a></li>
        <li class="breadcrumb-item active text-truncate" style="max-width: 200px;">@Model.BookTitle</li>
    </ol>
</nav>
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        @if (!string.IsNullOrEmpty(Model.CoverImageUrl))
                        {
                            <img src="@Model.CoverImageUrl" alt="@Model.BookTitle" 
                                 class="img-fluid rounded shadow mb-4" style="max-height: 200px;">
                        }
                        <h4>@Model.BookTitle</h4>
                    </div>

                    <!-- Download Status -->
                    <div class="bg-light rounded p-4 mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">@Html.T("التحميلات المستخدمة:", "Downloads used:")</span>
                            <span class="fw-bold">@Model.DownloadCount / @Model.MaxDownloads</span>
                        </div>
                        
                        <div class="progress mb-3" style="height: 10px;">
                            @{
                                var progressPercentage = (Model.DownloadCount / (double)Model.MaxDownloads) * 100;
                                var progressClass = progressPercentage > downloadHighUsageThreshold ? "bg-danger" : progressPercentage > downloadMediumUsageThreshold ? "bg-warning" : "bg-success";
                            }
                            <div class="progress-bar @progressClass" style="width: @progressPercentage%"></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">@Html.T("التحميلات المتبقية:", "Downloads remaining:")</span>
                            <span class="badge @(Model.RemainingDownloads > 0 ? "bg-success" : "bg-danger") fs-6">
                                @Model.RemainingDownloads
                            </span>
                        </div>

                        @if (Model.LastDownloadedAt.HasValue)
                        {
                            <div class="mt-3 pt-3 border-top">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    @Html.T("آخر تحميل:", "Last download:") @Model.LastDownloadedAt.Value.ToString("dd/MM/yyyy hh:mm tt")
                                </small>
                            </div>
                        }
                    </div>

                    @if (Model.CanDownload)
                    {
                        <h6 class="mb-3">@Html.T("اختر تنسيق التحميل:", "Choose download format:")</h6>
                        
                        <div class="d-grid gap-2">
                            @if ((Model.AvailableFormats & BookFormat.PDF) != 0)
                            {
                                <form asp-action="ExecuteDownload" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="purchaseId" value="@Model.PurchaseId">
                                    <input type="hidden" name="format" value="@BookFormat.PDF">
                                    <button type="submit" class="btn btn-lg btn-danger w-100">
                                        <i class="fas fa-file-pdf me-2"></i>
                                        @Html.T("تحميل PDF", "Download PDF")
                                    </button>
                                </form>
                            }
                            
                            @if ((Model.AvailableFormats & BookFormat.EPUB) != 0)
                            {
                                <form asp-action="ExecuteDownload" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="purchaseId" value="@Model.PurchaseId">
                                    <input type="hidden" name="format" value="@BookFormat.EPUB">
                                    <button type="submit" class="btn btn-lg btn-success w-100">
                                        <i class="fas fa-book me-2"></i>
                                        @Html.T("تحميل EPUB", "Download EPUB")
                                    </button>
                                </form>
                            }
                            
                            @if ((Model.AvailableFormats & BookFormat.MOBI) != 0)
                            {
                                <form asp-action="ExecuteDownload" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="purchaseId" value="@Model.PurchaseId">
                                    <input type="hidden" name="format" value="@BookFormat.MOBI">
                                    <button type="submit" class="btn btn-lg btn-warning w-100">
                                        <i class="fab fa-amazon me-2"></i>
                                        @Html.T("تحميل MOBI (Kindle)", "Download MOBI (Kindle)")
                                    </button>
                                </form>
                            }
                        </div>

                        <div class="alert alert-info mt-4 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>
                                @Html.T("كل تحميل يُحتسب من رصيد التحميلات المتاح. تأكد من حفظ الملف بعد التحميل.", "Each download counts against your download quota. Make sure to save the file after downloading.")
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger text-center mb-0">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p class="mb-0">
                                @Html.T("لقد استنفدت عدد التحميلات المسموح لهذا الكتاب.", "You have used all allowed downloads for this book.")
                                <br>
                                @Html.T("للمساعدة،", "For help,") <a href="@Url.Action("Index", "Support", new { area = "" })">@Html.T("تواصل مع الدعم الفني", "contact support")</a>.
                            </p>
                        </div>
                    }
                </div>
                
                <div class="card-footer bg-white text-center py-3">
                    <a href="@Url.Action("MyLibrary")" class="text-decoration-none">
                        <i class="fas fa-arrow-right me-1"></i>
                        @Html.T("العودة لمكتبتي", "Back to my library")
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

