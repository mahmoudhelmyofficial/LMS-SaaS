@model LMS.Areas.Student.ViewModels.BookDetailsStudentViewModel
@using LMS.Domain.Enums
@{
    ViewData["Title"] = Model.Title;
    var formatCount = ((Model.AvailableFormats & BookFormat.PDF) != 0 ? 1 : 0) + ((Model.AvailableFormats & BookFormat.EPUB) != 0 ? 1 : 0) + ((Model.AvailableFormats & BookFormat.MOBI) != 0 ? 1 : 0);
}

@section Styles {
<style>
    .glass-banner { position: relative; border-radius: 20px; padding: 24px 28px; margin-bottom: 1.5rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); transition: all 0.4s cubic-bezier(0.16,1,0.3,1); }
    .glass-banner::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); }
    .glass-banner:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,74,173,0.2); }
    .glass-banner-welcome { background: linear-gradient(135deg, rgba(0,74,173,0.85) 0%, rgba(0,102,204,0.75) 50%, rgba(26,92,185,0.8) 100%); box-shadow: 0 8px 32px rgba(0,74,173,0.25), 0 4px 16px rgba(0,74,173,0.15), inset 0 1px 0 rgba(255,255,255,0.2); }
    .glass-banner-welcome::after { content: ''; position: absolute; top: -50%; right: -20%; width: 60%; height: 200%; background: radial-gradient(ellipse, rgba(255,255,255,0.15) 0%, transparent 60%); pointer-events: none; }
    .glass-banner .banner-icon { width: 64px; height: 64px; border-radius: 16px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; border: 1px solid rgba(255,255,255,0.25); }
    .glass-banner h4, .glass-banner h5 { color: white; font-weight: 700; margin-bottom: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .glass-banner p { color: rgba(255,255,255,0.9); margin: 0; font-size: 15px; }
    .stats-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease; height: auto; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .stats-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    .stats-icon.primary { background: linear-gradient(135deg, #004aad 0%, #0066cc 50%, #3385d6 100%); color: white; }
    .stats-icon.success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
    .stats-icon.warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; }
    .stats-icon.info { background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%); color: white; }
    .stats-number { font-size: 32px; font-weight: 700; margin: 12px 0 4px; color: #1f2937; }
    .stats-label { color: #6b7280; font-size: 14px; margin-bottom: 8px; }
    .content-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: auto; }
</style>
}

<!-- Alert Messages -->
@await Html.PartialAsync("_AlertMessage")

<nav aria-label="@Html.T("مسار التنقل", "Breadcrumb")" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="Student" asp-controller="Dashboard" asp-action="Index">@Html.T("الرئيسية", "Home")</a></li>
        <li class="breadcrumb-item"><a asp-area="Student" asp-controller="Books" asp-action="Index">@Html.T("الكتب", "Books")</a></li>
        <li class="breadcrumb-item active text-truncate" style="max-width: 200px;">@Model.Title</li>
    </ol>
</nav>
<div class="container-fluid py-4 books-details-page">
    <div class="row align-items-start">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Glass Hero -->
            <div class="glass-banner glass-banner-welcome mb-4">
                <div class="d-flex align-items-start">
                    <div class="banner-icon flex-shrink-0 me-3">
                        @if (!string.IsNullOrEmpty(Model.CoverImageUrl))
                        {
                            <img src="@Model.CoverImageUrl" class="rounded" style="width:64px;height:64px;object-fit:cover;" alt="@Html.T("غلاف الكتاب", "Book cover")" />
                        }
                        else
                        {
                            <i class="feather-book text-white"></i>
                        }
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                            @if (Model.IsFree) { <span class="badge bg-white bg-opacity-25 text-white">@Html.T("مجاني", "Free")</span> }
                            @if (Model.IsNew) { <span class="badge bg-white bg-opacity-25 text-white">@Html.T("جديد", "New")</span> }
                            @if (Model.IsBestseller) { <span class="badge bg-white bg-opacity-25 text-white">@Html.T("الأكثر مبيعاً", "Bestseller")</span> }
                            @if (Model.IsFeatured) { <span class="badge bg-white bg-opacity-25 text-white">@Html.T("مميز", "Featured")</span> }
                        </div>
                        <h4 class="text-white mb-1">@Model.Title</h4>
                        @if (!string.IsNullOrEmpty(Model.Author))
                        {
                            <p class="mb-0 d-flex align-items-center">
                                <i class="feather-user me-1 text-white"></i>
                                <span class="text-white">@Model.Author</span>
                            </p>
                        }
                        <p class="mt-1 mb-0 opacity-75">@Model.CategoryName · @(Model.Language == "ar" ? Html.T("العربية", "Arabic") : Model.Language == "en" ? Html.T("الإنجليزية", "English") : Model.Language)</p>
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="stats-label mb-0">@Html.T("التقييم", "Rating")</p>
                                <h2 class="stats-number mb-0">@Model.AverageRating.ToString("N1")</h2>
                                <small class="text-muted">@Model.TotalReviews @Html.T("تقييم", "reviews")</small>
                            </div>
                            <div class="stats-icon warning"><i class="feather-star"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="stats-label mb-0">@Html.T("الصفحات", "Pages")</p>
                                <h2 class="stats-number mb-0">@(Model.PageCount?.ToString() ?? "-")</h2>
                            </div>
                            <div class="stats-icon info"><i class="feather-file-text"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="stats-label mb-0">@Html.T("مبيعات", "Sales")</p>
                                <h2 class="stats-number mb-0">@Model.TotalSales</h2>
                            </div>
                            <div class="stats-icon success"><i class="feather-trending-up"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="stats-label mb-0">@Html.T("التنسيقات", "Formats")</p>
                                <h2 class="stats-number mb-0">@formatCount</h2>
                            </div>
                            <div class="stats-icon primary"><i class="feather-book"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Book Info + Cover + Actions -->
            <div class="content-card mb-4">
                <div class="row">
                    <div class="col-md-4 mb-3 mb-md-0 text-center">
                        @if (!string.IsNullOrEmpty(Model.CoverImageUrl))
                        {
                            <img src="@Model.CoverImageUrl" class="img-fluid rounded shadow" alt="@Model.Title" style="max-height:320px;object-fit:contain;">
                        }
                        else
                        {
                            <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" style="height: 280px; width: 100%; max-width: 220px;">
                                <i class="feather-book text-muted" style="font-size: 4rem;"></i>
                            </div>
                        }
                    </div>
                    <div class="col-md-8">
                        @if (!string.IsNullOrEmpty(Model.ShortDescription))
                        {
                            <p class="lead mb-3">@Model.ShortDescription</p>
                        }
                        <div class="mb-3">
                            <span class="text-muted small">@Html.T("التنسيقات المتاحة:", "Available formats:")</span>
                            <div class="d-flex gap-2 mt-1 flex-wrap">
                                @if ((Model.AvailableFormats & BookFormat.PDF) != 0) { <span class="badge bg-danger"><i class="feather-file-text me-1"></i> @Html.T("PDF", "PDF")</span> }
                                @if ((Model.AvailableFormats & BookFormat.EPUB) != 0) { <span class="badge bg-success"><i class="feather-book me-1"></i> @Html.T("EPUB", "EPUB")</span> }
                                @if ((Model.AvailableFormats & BookFormat.MOBI) != 0) { <span class="badge bg-warning text-dark"><i class="feather-book me-1"></i> @Html.T("MOBI", "MOBI")</span> }
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.PreviewPdfUrl))
                        {
                            <a href="@Url.Action("Preview", "Books", new { area = "Student", id = Model.Id, slug = Model.Slug })" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="feather-eye me-1"></i>
                                @Html.T("معاينة مجانية", "Free preview")
                            </a>
                        }
                    </div>
                </div>
            </div>

            <!-- Description -->
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="content-card mb-4">
                    <h5 class="mb-3">
                        <i class="feather-align-left text-primary me-2"></i>
                        @Html.T("نبذة عن الكتاب", "About the book")
                    </h5>
                    @Html.Raw(Model.Description)
                </div>
            }

            <!-- Table of Contents -->
            @if (Model.Chapters.Any())
            {
                <div class="content-card mb-4">
                    <h5 class="mb-3">
                        <i class="feather-list text-primary me-2"></i>
                        @Html.T("محتويات الكتاب", "Table of contents")
                    </h5>
                    <ul class="list-group list-group-flush p-0 mb-0">
                        @foreach (var chapter in Model.Chapters)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                <div>
                                    <i class="feather-bookmark text-primary me-2"></i>
                                    @chapter.Title
                                    @if (chapter.ReadingTimeMinutes.HasValue)
                                    {
                                        <small class="text-muted ms-2">
                                            <i class="feather-clock me-1"></i>
                                            @chapter.ReadingTimeMinutes @Html.T("دقيقة", "min")
                                        </small>
                                    }
                                </div>
                                @if (chapter.PageNumber.HasValue)
                                {
                                    <span class="badge bg-light text-dark">@Html.T("صفحة", "Page") @chapter.PageNumber</span>
                                }
                            </li>
                        }
                    </ul>
                </div>
            }

            <!-- Reviews -->
            <div class="content-card mb-4">
                <h5 class="mb-3">
                    <i class="feather-message-circle text-primary me-2"></i>
                    @Html.T("التقييمات", "Reviews") (@Model.TotalReviews)
                </h5>
                <div>
                    @if (Model.Reviews.Any())
                    {
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2"
                                             style="width: 40px; height: 40px;">
                                            @review.StudentName[0]
                                        </div>
                                        <div>
                                            <span class="fw-medium">@review.StudentName</span>
                                            @if (review.IsVerifiedPurchase)
                                            {
                                                <span class="badge bg-success-soft text-success ms-2">
                                                    <i class="feather-check-circle me-1"></i>
                                                    @Html.T("مشتري موثق", "Verified purchaser")
                                                </span>
                                            }
                                            <div>
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fas fa-star small @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                                </div>
                                @if (!string.IsNullOrEmpty(review.Comment))
                                {
                                    <p class="mb-2">@review.Comment</p>
                                }
                                @if (!string.IsNullOrEmpty(review.InstructorResponse))
                                {
                                    <div class="bg-light rounded p-3 mt-2">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="feather-corner-down-right text-primary me-2"></i>
                                            <strong>@Html.T("رد المدرس", "Instructor reply")</strong>
                                        </div>
                                        <p class="mb-0">@review.InstructorResponse</p>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="feather-message-circle text-muted mb-3" style="font-size: 3rem;"></i>
                            <p class="text-muted">@Html.T("لا توجد تقييمات بعد", "No reviews yet")</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Related Books -->
            @if (Model.RelatedBooks.Any())
            {
                <div class="content-card mb-4">
                    <h5 class="mb-3">
                        <i class="feather-book text-primary me-2"></i>
                        @Html.T("كتب مشابهة", "Similar books")
                    </h5>
                    <div>
                        <div class="row g-3">
                            @foreach (var book in Model.RelatedBooks)
                            {
                                <div class="col-md-3 col-6">
                                    <a href="@Url.Action("Details", "Books", new { area = "Student", slug = book.Slug })" class="text-decoration-none">
                                        <div class="card border-0 h-100">
                                            @if (!string.IsNullOrEmpty(book.CoverImageUrl))
                                            {
                                                <img src="@book.CoverImageUrl" class="card-img-top" 
                                                     style="height: 150px; object-fit: cover;">
                                            }
                                            <div class="card-body p-2">
                                                <h6 class="card-title small text-dark mb-1 text-truncate">@book.Title</h6>
                                                <small class="text-muted">@book.FinalPrice.ToEGP(2)</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Purchase Card -->
            <div class="content-card mb-4 sticky-top" style="top: 80px;">
                <div class="text-center">
                    <!-- Price -->
                    <div class="mb-3">
                        @if (Model.IsFree)
                        {
                            <h2 class="text-success mb-0">@Html.T("مجاني", "Free")</h2>
                        }
                        else if (Model.DiscountPrice.HasValue)
                        {
                            <span class="text-decoration-line-through text-muted h5">@Model.Price.ToEGP(2)</span>
                            <h2 class="text-success mb-0">@Model.DiscountPrice.Value.ToEGP(2)</h2>
                            <span class="badge bg-danger">@Html.T("وفر", "Save") @Model.DiscountPercentage%</span>
                        }
                        else
                        {
                            <h2 class="text-primary mb-0">@Model.Price.ToEGP(2)</h2>
                        }
                    </div>

                    <!-- Actions -->
                    @if (Model.IsPurchased)
                    {
                        <a href="@Url.Action("Download", "Books", new { area = "Student", id = Model.Id })" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="feather-download me-2"></i>
                            @Html.T("تحميل الكتاب", "Download book")
                        </a>
                        <p class="text-success small mb-0">
                            <i class="feather-check-circle me-1"></i>
                            @Html.T("لديك هذا الكتاب", "You have this book")
                        </p>
                    }
                    else if (Model.IsInCart && !(Model.IsFree || Model.FinalPrice == 0))
                    {
                        <a href="@Url.Action("Cart", "Checkout", new { area = "Student" })" class="btn btn-outline-primary btn-lg w-100 mb-2">
                            <i class="feather-shopping-cart me-2"></i>
                            @Html.T("الذهاب للسلة", "Go to cart")
                        </a>
                        <p class="text-muted small mb-0">@Html.T("الكتاب في سلة التسوق", "Book is in cart")</p>
                    }
                    else if (Model.IsFree || Model.FinalPrice == 0)
                    {
                        <a href="@Url.Action("FreeDownload", "Books", new { area = "Student", id = Model.Id })" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="feather-download me-2"></i>
                            @Html.T("تحميل مجاني", "Download free")
                        </a>
                        <p class="text-success small mb-0">
                            <i class="feather-check-circle me-1"></i>
                            @Html.T("لا حاجة للسلة أو الدفع", "No cart or payment required")
                        </p>
                    }
                    else
                    {
                        <form asp-action="AddBookToCartPost" asp-controller="Checkout" asp-area="Student" method="post" class="mb-2">
                            <input type="hidden" name="bookId" value="@Model.Id">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="feather-shopping-cart me-2"></i>
                                @Html.T("أضف للسلة", "Add to cart")
                            </button>
                        </form>
                    }

                    <hr class="my-3">

                    <!-- Guarantee -->
                    <div class="text-start">
                        <div class="d-flex align-items-center mb-2">
                            <i class="feather-shield text-success me-2"></i>
                            <small>@Html.T("ضمان استرداد الأموال لمدة 30 يوم", "30-day money-back guarantee")</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="feather-download-cloud text-primary me-2"></i>
                            <small>@Html.T("تحميل فوري بعد الشراء", "Instant download after purchase")</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="feather-refresh-cw text-info me-2"></i>
                            <small>@Html.T("وصول مدى الحياة", "Lifetime access")</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructor Card -->
            <div class="content-card mb-4">
                <h6 class="mb-3">@Html.T("عن المدرس", "About the instructor")</h6>
                <div>
                    <div class="d-flex align-items-center mb-3">
                        @if (!string.IsNullOrEmpty(Model.InstructorImageUrl))
                        {
                            <img src="@Model.InstructorImageUrl" class="rounded-circle me-3" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                 style="width: 60px; height: 60px;">
                                @Model.InstructorName[0]
                            </div>
                        }
                        <div>
                            <h6 class="mb-1">@Model.InstructorName</h6>
                            <small class="text-muted">
                                @Model.InstructorBookCount @Html.T("كتاب", "books") | @Model.InstructorCourseCount @Html.T("دورة", "courses")
                            </small>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.InstructorBio))
                    {
                        <p class="small text-muted mb-3">@Model.InstructorBio</p>
                    }
                    <a href="@Url.Action("Index", "Books", new { area = "Student", instructorId = Model.InstructorId })" 
                       class="btn btn-outline-primary btn-sm w-100">
                        @Html.T("عرض جميع كتب المدرس", "View all instructor books")
                    </a>
                </div>
            </div>

            <!-- Book Details Card -->
            <div class="content-card mb-4">
                <h6 class="mb-3">@Html.T("تفاصيل الكتاب", "Book details")</h6>
                <div>
                    <table class="table table-sm table-borderless mb-0">
                        @if (!string.IsNullOrEmpty(Model.ISBN))
                        {
                            <tr>
                                <td class="text-muted">@Html.T("الرقم الدولي:", "ISBN:")</td>
                                <td>@Model.ISBN</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.Publisher))
                        {
                            <tr>
                                <td class="text-muted">@Html.T("الناشر:", "Publisher:")</td>
                                <td>@Model.Publisher</td>
                            </tr>
                        }
                        @if (Model.PublicationDate.HasValue)
                        {
                            <tr>
                                <td class="text-muted">@Html.T("تاريخ النشر:", "Publication date:")</td>
                                <td>@Model.PublicationDate.Value.ToString("yyyy")</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.Edition))
                        {
                            <tr>
                                <td class="text-muted">@Html.T("الطبعة:", "Edition:")</td>
                                <td>@Model.Edition</td>
                            </tr>
                        }
                        @if (Model.PageCount.HasValue)
                        {
                            <tr>
                                <td class="text-muted">@Html.T("الصفحات:", "Pages:")</td>
                                <td>@Model.PageCount</td>
                            </tr>
                        }
                        <tr>
                            <td class="text-muted">@Html.T("اللغة:", "Language:")</td>
                            <td>@(Model.Language == "ar" ? Html.T("العربية", "Arabic") : Model.Language == "en" ? Html.T("الإنجليزية", "English") : Model.Language)</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Related Course -->
            @if (Model.RelatedCourseId.HasValue)
            {
                <div class="content-card mb-4 border border-primary">
                    <div>
                        <h6 class="text-primary mb-2">
                            <i class="feather-award me-1"></i>
                            @Html.T("دورة مرتبطة", "Related course")
                        </h6>
                        <p class="mb-2">@Model.RelatedCourseName</p>
                        @if (Model.IncludedWithCourse)
                        {
                            <span class="badge bg-success">@Html.T("مجاني مع الدورة", "Free with course")</span>
                        }
                        <a href="@Url.Action("Details", "Courses", new { area = "Student", id = Model.RelatedCourseId })" 
                           class="btn btn-outline-primary btn-sm w-100 mt-2">
                            @Html.T("عرض الدورة", "View course")
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

