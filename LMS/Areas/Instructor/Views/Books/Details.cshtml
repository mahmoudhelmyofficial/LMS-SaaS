@model LMS.Areas.Instructor.ViewModels.BookDetailsViewModel
@using LMS.Helpers
@using LMS.Domain.Enums
@using LMS.Domain.Entities.Books

@{
    ViewData["Title"] = Model.Title;
    ViewData["Subtitle"] = Html.T("تفاصيل الكتاب", "Book details");

    var recentPurchases = ViewBag.RecentPurchases as List<BookPurchase>;
    var recentReviews = ViewBag.RecentReviews as List<BookReview>;
    var currencySymbol = ViewBag.DefaultCurrencySymbol as string ?? "ج.م";
    var currencyCode = ViewBag.DefaultCurrencyCode as string ?? "EGP";

    var editUrl = Url.Action("Edit", new { id = Model.Id });
    var indexUrl = Url.Action("Index");

    var statusBadge = Model.Status switch
    {
        BookStatus.Draft => ("bg-soft-secondary text-secondary", "مسودة"),
        BookStatus.PendingReview => ("bg-soft-warning text-warning", "قيد المراجعة"),
        BookStatus.Published => ("bg-soft-success text-success", "منشور"),
        BookStatus.Rejected => ("bg-soft-danger text-danger", "مرفوض"),
        BookStatus.Suspended => ("bg-soft-dark text-dark", "معلق"),
        _ => ("bg-soft-secondary text-secondary", "غير معروف")
    };
}

@{
    var headerButtons = new System.Text.StringBuilder();
    headerButtons.Append("<a href='" + editUrl + "' class='btn btn-primary'><i class='feather-edit me-2'></i>تعديل الكتاب</a>");

    if (Model.Status == BookStatus.Draft || Model.Status == BookStatus.Rejected)
    {
        var submitUrl = Url.Action("SubmitForReview");
        headerButtons.Append("<form action='" + submitUrl + "' method='post' class='d-inline' id='submitForReviewForm'>");
        headerButtons.Append(Html.AntiForgeryToken().ToString());
        headerButtons.Append("<input type='hidden' name='id' value='" + Model.Id + "'>");
        headerButtons.Append("<button type='submit' class='btn btn-success' id='submitForReviewBtn'>");
        headerButtons.Append("<span class='btn-text'><i class='feather-send me-2'></i>إرسال للمراجعة</span>");
        headerButtons.Append("<span class='btn-loading d-none'><span class='spinner-border spinner-border-sm me-1' role='status' aria-hidden='true'></span>جاري الإرسال...</span>");
        headerButtons.Append("</button></form>");
    }

    if (Model.Status == BookStatus.Published)
    {
        var unpublishUrl = Url.Action("Unpublish");
        headerButtons.Append("<form action='" + unpublishUrl + "' method='post' class='d-inline'>");
        headerButtons.Append(Html.AntiForgeryToken().ToString());
        headerButtons.Append("<input type='hidden' name='id' value='" + Model.Id + "'>");
        headerButtons.Append("<button type='submit' class='btn btn-warning' onclick=\"return confirm('هل تريد إلغاء نشر الكتاب؟')\">");
        headerButtons.Append("<i class='feather-eye-off me-2'></i>إلغاء النشر</button></form>");
    }

    headerButtons.Append("<div class='dropdown'>");
    headerButtons.Append("<button class='btn btn-light dropdown-toggle' type='button' data-bs-toggle='dropdown'><i class='feather-more-vertical'></i></button>");
    headerButtons.Append("<ul class='dropdown-menu dropdown-menu-end'>");
    headerButtons.Append("<li><a class='dropdown-item' href='" + indexUrl + "'><i class='feather-arrow-right me-2'></i>العودة للقائمة</a></li>");
    headerButtons.Append("</ul></div>");
}

@await Html.PartialAsync("_PageHeader", ViewDataDictionaryHelper.CreateWith(
    ViewData,
    "ActionButtons",
    Html.Raw(headerButtons.ToString())
))

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Rejection Alert -->
    @if (Model.Status == BookStatus.Rejected && !string.IsNullOrEmpty(Model.RejectionReason))
    {
        <div class="alert alert-danger d-flex align-items-start mb-4">
            <div class="me-3">
                <i class="feather-alert-triangle fs-4"></i>
            </div>
            <div>
                <h6 class="alert-heading fw-bold mb-1">@Html.T("تم رفض الكتاب", "Book rejected")</h6>
                <p class="mb-0">@Model.RejectionReason</p>
            </div>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4 g-3">
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", ViewDataDictionaryHelper.CreateWith(
                ViewData,
                ("Label", Html.T("إجمالي المبيعات", "Total sales")),
                ("Value", Model.TotalSales),
                ("Icon", "shopping-bag"),
                ("Color", "primary")
            ))
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", ViewDataDictionaryHelper.CreateWith(
                ViewData,
                ("Label", Html.T("الأرباح", "Earnings")),
                ("Value", $"{Model.TotalEarnings:N2} {currencyCode}"),
                ("Icon", "dollar-sign"),
                ("Color", "success")
            ))
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", ViewDataDictionaryHelper.CreateWith(
                ViewData,
                ("Label", Html.T("التحميلات", "Downloads")),
                ("Value", Model.TotalDownloads),
                ("Icon", "download"),
                ("Color", "info")
            ))
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", ViewDataDictionaryHelper.CreateWith(
                ViewData,
                ("Label", Html.T("التقييم", "Rating")),
                ("Value", $"{Model.AverageRating:N1} ({Model.TotalReviews} " + Html.T("تقييم", "reviews") + ")"),
                ("Icon", "star"),
                ("Color", "warning")
            ))
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-xxl-8 col-xl-7">
            <!-- This Month -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-trending-up me-2"></i>
                        @Html.T("هذا الشهر", "This month")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="bg-soft-primary rounded p-3 text-center">
                                <div class="fw-bold fs-4 text-primary mb-1">@Model.SalesThisMonth</div>
                                <div class="fs-12 text-muted">@Html.T("المبيعات", "Sales")</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-soft-success rounded p-3 text-center">
                                <div class="fw-bold fs-4 text-success mb-1">@Model.RevenueThisMonth.ToString("N2")</div>
                                <div class="fs-12 text-muted">@Html.T("الإيرادات", "Revenue") (@currencyCode)</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-soft-info rounded p-3 text-center">
                                <div class="fw-bold fs-4 text-info mb-1">@Model.DownloadsThisMonth</div>
                                <div class="fs-12 text-muted">@Html.T("التحميلات", "Downloads")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-align-left me-2"></i>
                        @Html.T("الوصف", "Description")
                    </h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ShortDescription))
                    {
                        <p class="lead text-muted mb-3">@Model.ShortDescription</p>
                        <hr>
                    }
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="fs-14">
                            @Html.Raw(Model.Description)
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">@Html.T("لم يتم إضافة وصف بعد", "No description added yet")</p>
                    }
                </div>
            </div>

            <!-- Chapters -->
            @if (Model.Chapters != null && Model.Chapters.Any())
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-list me-2"></i>
                            @Html.T("الفصول", "Chapters") (@Model.Chapters.Count)
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            @foreach (var chapter in Model.Chapters)
                            {
                                <div class="list-group-item d-flex align-items-center justify-content-between">
                                    <div>
                                        <span class="fw-medium">@chapter.Title</span>
                                        @if (chapter.PageNumber.HasValue)
                                        {
                                            <small class="text-muted ms-2">
                                                @Html.T("صفحة", "Page") @chapter.PageNumber
                                                @if (chapter.EndPageNumber.HasValue)
                                                {
                                                    <span>- @chapter.EndPageNumber</span>
                                                }
                                            </small>
                                        }
                                    </div>
                                    @if (chapter.IsPreviewable)
                                    {
                                        <span class="badge bg-soft-info text-info">@Html.T("قابل للمعاينة", "Previewable")</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Recent Reviews -->
            @if (recentReviews?.Any() == true)
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-message-square me-2"></i>
                            @Html.T("آخر التقييمات", "Recent reviews")
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var review in recentReviews)
                        {
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="d-flex align-items-center">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="feather-star @(i <= review.Rating ? "text-warning" : "text-muted")" style="font-size: 14px;"></i>
                                            }
                                        </div>
                                        <span class="fw-medium">@review.Student?.FullName</span>
                                    </div>
                                    <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                                </div>
                                @if (!string.IsNullOrEmpty(review.Comment))
                                {
                                    <p class="mb-2 fs-14">@review.Comment</p>
                                }
                                @if (string.IsNullOrEmpty(review.InstructorResponse))
                                {
                                    <form asp-action="RespondToReview" method="post" class="mt-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="bookId" value="@Model.Id">
                                        <input type="hidden" name="reviewId" value="@review.Id">
                                        <div class="input-group input-group-sm">
                                            <input type="text" name="response" class="form-control" placeholder="@Html.T("اكتب رداً...", "Write a reply...")">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="feather-send"></i>
                                            </button>
                                        </div>
                                    </form>
                                }
                                else
                                {
                                    <div class="bg-soft-primary rounded p-3 mt-2">
                                        <small class="text-muted fw-medium">@Html.T("ردك:", "Your reply:")</small>
                                        <p class="mb-0 fs-13">@review.InstructorResponse</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Right Column -->
        <div class="col-xxl-4 col-xl-5">
            <!-- Cover Image -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-body p-0">
                    @if (!string.IsNullOrEmpty(Model.CoverImageUrl))
                    {
                        <img src="@Model.CoverImageUrl" class="img-fluid w-100" alt="@Model.Title" style="border-radius: 12px;">
                    }
                    else
                    {
                        <div class="bg-soft-primary d-flex align-items-center justify-content-center" style="height: 300px; border-radius: 12px;">
                            <i class="feather-book" style="font-size: 80px; opacity: 0.3;"></i>
                        </div>
                    }
                </div>
            </div>

            <!-- Status Badge -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-body text-center">
                    <span class="badge @statusBadge.Item1 fs-13 px-3 py-2">
                        @statusBadge.Item2
                    </span>
                    <span class="badge bg-soft-primary text-primary fs-13 px-3 py-2 ms-2">
                        @Model.CategoryName
                    </span>
                </div>
            </div>

            <!-- Price Card -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("السعر", "Price")</h5>
                </div>
                <div class="card-body text-center">
                    @if (Model.IsFree)
                    {
                        <h3 class="text-success fw-bold mb-0">@Html.T("مجاني", "Free")</h3>
                    }
                    else
                    {
                        @if (Model.DiscountPrice.HasValue)
                        {
                            <span class="text-decoration-line-through text-muted fs-14">@Model.Price.ToString("N2") @currencySymbol</span>
                            <h3 class="text-success fw-bold mb-0">@Model.DiscountPrice.Value.ToString("N2") @currencySymbol</h3>
                        }
                        else
                        {
                            <h3 class="text-primary fw-bold mb-0">@Model.Price.ToString("N2") @currencySymbol</h3>
                        }
                    }
                    @if (Model.HasPhysicalCopy && Model.PhysicalPrice.HasValue)
                    {
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex align-items-center justify-content-center gap-2">
                                <i class="feather-package text-primary"></i>
                                <span class="text-muted fs-12">نسخة ورقية:</span>
                                <span class="fw-bold">@Model.PhysicalPrice.Value.ToString("N2") @currencySymbol</span>
                            </div>
                            @if (Model.PhysicalStock.HasValue)
                            {
                                <small class="text-muted">المخزون: @Model.PhysicalStock</small>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Book Info -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات الكتاب", "Book info")</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Author))
                    {
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">
                                <i class="feather-user me-2"></i>المؤلف
                            </span>
                            <span class="fw-medium">@Model.Author</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.ISBN))
                    {
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">
                                <i class="feather-hash me-2"></i>ISBN
                            </span>
                            <span class="fw-medium">@Model.ISBN</span>
                        </div>
                    }
                    @if (Model.PageCount.HasValue)
                    {
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">
                                <i class="feather-file-text me-2"></i>الصفحات
                            </span>
                            <span class="fw-medium">@Model.PageCount</span>
                        </div>
                    }
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">
                            <i class="feather-globe me-2"></i>اللغة
                        </span>
                        <span class="fw-medium">@(Model.Language == "ar" ? "العربية" : Model.Language == "en" ? "English" : Model.Language)</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Publisher))
                    {
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">
                                <i class="feather-home me-2"></i>الناشر
                            </span>
                            <span class="fw-medium">@Model.Publisher</span>
                        </div>
                    }
                    @if (Model.PublicationDate.HasValue)
                    {
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <span class="text-muted">
                                <i class="feather-calendar me-2"></i>تاريخ النشر
                            </span>
                            <span class="fw-medium">@Model.PublicationDate.Value.ToString("dd/MM/yyyy")</span>
                        </div>
                    }
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">
                            <i class="feather-eye me-2"></i>المشاهدات
                        </span>
                        <span class="fw-medium">@Model.ViewCount</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="text-muted">
                            <i class="feather-clock me-2"></i>تاريخ الإنشاء
                        </span>
                        <span class="fw-medium">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
            </div>

            <!-- Available Formats -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("التنسيقات المتاحة", "Available formats")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        @if ((Model.AvailableFormats & BookFormat.PDF) != 0)
                        {
                            <span class="badge bg-soft-danger text-danger fs-12 px-3 py-2">
                                <i class="feather-file me-1"></i> PDF
                            </span>
                        }
                        @if ((Model.AvailableFormats & BookFormat.EPUB) != 0)
                        {
                            <span class="badge bg-soft-success text-success fs-12 px-3 py-2">
                                <i class="feather-book me-1"></i> EPUB
                            </span>
                        }
                        @if ((Model.AvailableFormats & BookFormat.MOBI) != 0)
                        {
                            <span class="badge bg-soft-warning text-warning fs-12 px-3 py-2">
                                <i class="feather-book me-1"></i> MOBI
                            </span>
                        }
                    </div>
                    @if (Model.HasPhysicalCopy)
                    {
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex align-items-center gap-2">
                                <i class="feather-package text-primary"></i>
                                <span class="fw-medium">نسخة ورقية متوفرة</span>
                            </div>
                            @if (Model.PhysicalPrice.HasValue)
                            {
                                <small class="text-muted d-block mt-1">السعر: @Model.PhysicalPrice.Value.ToString("N2") @currencySymbol</small>
                            }
                            @if (Model.PhysicalStock.HasValue)
                            {
                                <small class="text-muted d-block">المخزون: @Model.PhysicalStock وحدة</small>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("إجراءات سريعة", "Quick actions")</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="@editUrl" class="btn btn-light-brand">
                            <i class="feather-edit me-2"></i>
                            تعديل الكتاب
                        </a>
                        @if (Model.Status == BookStatus.Draft || Model.Status == BookStatus.Rejected)
                        {
                            <form asp-action="SubmitForReview" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id">
                                <button type="submit" class="btn btn-light-brand w-100">
                                    <i class="feather-send me-2"></i>
                                    إرسال للمراجعة
                                </button>
                            </form>
                        }
                        @if (Model.Status == BookStatus.Published)
                        {
                            <form asp-action="Unpublish" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id">
                                <button type="submit" class="btn btn-light-brand w-100" onclick="return confirm('هل تريد إلغاء نشر الكتاب؟')">
                                    <i class="feather-eye-off me-2"></i>
                                    إلغاء النشر
                                </button>
                            </form>
                        }
                        <a href="@indexUrl" class="btn btn-light-brand">
                            <i class="feather-arrow-right me-2"></i>
                            العودة للقائمة
                        </a>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            @if (Model.Status == BookStatus.Draft && Model.TotalSales == 0)
            {
                <div class="card stretch stretch-full mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title text-white">
                            <i class="feather-alert-triangle me-2"></i>
                            منطقة الخطر
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="fs-13 text-muted mb-3">حذف الكتاب نهائياً. هذا الإجراء لا يمكن التراجع عنه.</p>
                        <form asp-action="Delete" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id">
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('هل أنت متأكد من حذف هذا الكتاب نهائياً؟ هذا الإجراء لا يمكن التراجع عنه.')">
                                <i class="feather-trash-2 me-2"></i>
                                حذف الكتاب
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/instructor-book-forms.js" asp-append-version="true"></script>
}
