@using Microsoft.AspNetCore.Identity
@using LMS.Services.Interfaces
@using LMS.Helpers
@inject SignInManager<LMS.Domain.Entities.Users.ApplicationUser> SignInManager
@inject UserManager<LMS.Domain.Entities.Users.ApplicationUser> UserManager
@inject INotificationService NotificationService
@inject ICurrentUserService CurrentUserService
@inject IPlatformSettingsService PlatformSettings

@{
    LMS.Domain.Entities.Users.ApplicationUser? user = null;
    var userName = Html.T("المدرس", "Instructor");
    var userId = "";
    var unreadNotifications = new List<LMS.Domain.Entities.Notifications.Notification>();
    var unreadCount = 0;
    var unreadMessages = 0;
    var notificationDisplayLimit = await PlatformSettings.GetIntSettingAsync("UI.NotificationDisplay.Limit", 5);
    
    try
    {
        user = await UserManager.GetUserAsync(User);
        userName = user != null ? $"{user.FirstName} {user.LastName}" : Html.T("المدرس", "Instructor");
        userId = CurrentUserService.UserId ?? "";
        
        // Get notifications using service (cached)
        if (!string.IsNullOrEmpty(userId))
        {
            try
            {
                unreadCount = await NotificationService.GetUnreadCountAsync(userId);
                unreadNotifications = await NotificationService.GetUnreadNotificationsAsync(userId, 5);
            }
            catch
            {
                // Notifications table might not exist or other DB error
            }
            
            try
            {
                // Keep direct query for messages as it's simple
                @* TODO: Move to a MessageService *@
                unreadMessages = 0; // Will be replaced with service call
            }
            catch
            {
                // DirectMessages table might not exist or other DB error
            }
        }
    }
    catch
    {
        // User manager failed, use defaults
    }
}

<header class="nxl-header">
    <div class="header-wrapper">
        <!--! [Start] Header Left !-->
        <div class="header-left d-flex align-items-center gap-4">
            <!--! [Start] Mobile Toggler !-->
            <a href="javascript:void(0);" class="nxl-head-mobile-toggler" id="mobile-collapse">
                <div class="hamburger hamburger--arrowturn">
                    <div class="hamburger-box">
                        <div class="hamburger-inner"></div>
                    </div>
                </div>
            </a>
            <!--! [End] Mobile Toggler !-->
            <!--! [Start] Navigation Toggle - Hidden on large screens, sidebar always open !-->
            <div class="nxl-navigation-toggle d-none">
                <a href="javascript:void(0);" id="menu-mini-button">
                    <i class="feather-align-right"></i>
                </a>
                <a href="javascript:void(0);" id="menu-expend-button" style="display: none">
                    <i class="feather-arrow-left"></i>
                </a>
            </div>
            <!--! [End] Navigation Toggle !-->
        </div>
        <!--! [End] Header Left !-->
        
        <!--! [Start] Header Right !-->
        <div class="header-right ms-auto">
            <div class="d-flex align-items-center">
                <!--! [Start] Search Dropdown !-->
                <div class="dropdown nxl-h-item nxl-header-search">
                    <a href="javascript:void(0);" class="header-dropdown-toggle" id="searchDropdownToggle">
                        <i class="feather-search"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-start nxl-h-dropdown nxl-search-dropdown">
                        <div class="input-group search-form">
                            <span class="input-group-text">
                                <i class="feather-search fs-6 text-muted"></i>
                            </span>
                            <input type="text" class="form-control search-input-field" placeholder="@Html.T("بحث...", "Search...")">
                            <span class="input-group-text">
                                <button type="button" class="btn-close"></button>
                            </span>
                        </div>
                        <div class="dropdown-divider mt-0"></div>
                        <div class="search-items-wrapper">
                            <div class="searching-for px-4 py-2">
                                <p class="fs-11 fw-medium text-muted">@Html.T("البحث السريع عن...", "Quick search for...")</p>
                                <div class="d-flex flex-wrap gap-1">
                                    <a asp-area="Instructor" asp-controller="Courses" asp-action="Index" class="flex-fill border rounded py-1 px-2 text-center fs-11 fw-semibold">@Html.T("دوراتي", "My Courses")</a>
                                    <a asp-area="Instructor" asp-controller="Students" asp-action="Index" class="flex-fill border rounded py-1 px-2 text-center fs-11 fw-semibold">@Html.T("الطلاب", "Students")</a>
                                    <a asp-area="Instructor" asp-controller="Analytics" asp-action="Index" class="flex-fill border rounded py-1 px-2 text-center fs-11 fw-semibold">@Html.T("التحليلات", "Analytics")</a>
                                    <a asp-area="Instructor" asp-controller="Messages" asp-action="Index" class="flex-fill border rounded py-1 px-2 text-center fs-11 fw-semibold">@Html.T("الرسائل", "Messages")</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--! [End] Search Dropdown !-->
                
                <!--! [Start] Messages !-->
                @if (unreadMessages > 0)
                {
                    <div class="nxl-h-item">
                        <a asp-area="Instructor" asp-controller="Messages" asp-action="Index" class="header-dropdown-toggle" title="@Html.T("الرسائل", "Messages")">
                            <i class="feather-mail"></i>
                            <span class="badge bg-success nxl-h-badge">@(unreadMessages > 99 ? "99+" : unreadMessages.ToString())</span>
                        </a>
                    </div>
                }
                <!--! [End] Messages !-->
                
                <!--! [Start] Notifications Dropdown !-->
                <div class="dropdown nxl-h-item">
                    <a href="javascript:void(0);" class="header-dropdown-toggle" id="notificationsDropdownToggle">
                        <i class="feather-bell"></i>
                        <span class="badge bg-danger nxl-h-badge" id="unread-notifications-badge" style="@(unreadCount == 0 ? "display:none" : "")">
                            @(unreadCount > 99 ? "99+" : unreadCount.ToString())
                        </span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-start nxl-h-dropdown nxl-notifications-menu" id="notifications-dropdown">
                        <div class="d-flex justify-content-between align-items-center notifications-head">
                            <h6 class="fw-bold text-dark mb-0">
                                @Html.T("الإشعارات", "Notifications") 
                                <span class="badge bg-danger ms-1" id="dropdown-unread-count" style="@(unreadCount == 0 ? "display:none" : "")">
                                    @unreadCount
                                </span>
                            </h6>
                            @if (unreadCount > 0)
                            {
                                <form asp-area="Instructor" asp-controller="Notifications" asp-action="MarkAllAsRead" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-link fs-11 text-success text-end p-0">
                                        <i class="feather-check me-1"></i>
                                        <span>@Html.T("تمييز الكل كمقروء", "Mark All as Read")</span>
                                    </button>
                                </form>
                            }
                        </div>
                        <div id="notifications-list">
                            @if (unreadNotifications.Any())
                            {
                                @foreach (var notification in unreadNotifications.Take(notificationDisplayLimit))
                                {
                                    var (iconClass, iconColor, typeLabel) = NotificationHelper.GetTypeInfo(notification.Type);
                                    var timeAgo = NotificationHelper.GetTimeAgo(notification.CreatedAt);
                                    
                                    <div class="notifications-item" data-notification-id="@notification.Id">
                                        <div class="avatar-text avatar-sm bg-soft-@iconColor text-@iconColor">
                                            <i class="@iconClass"></i>
                                        </div>
                                        <div class="notifications-desc">
                                            <a href="@(notification.ActionUrl ?? Url.Action("Index", "Notifications", new { area = "Instructor" }))" 
                                               class="font-body text-truncate-2-line">
                                                <span class="fw-semibold text-dark">@notification.Title</span>
                                                <span class="text-muted">@notification.Message</span>
                                            </a>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="notifications-date text-muted border-bottom border-bottom-dashed">
                                                    @timeAgo
                                                </div>
                                                @if (notification.Priority >= 4)
                                                {
                                                    <span class="badge bg-@NotificationHelper.GetPriorityColor(notification.Priority)" style="font-size: 9px;">
                                                        @NotificationHelper.GetPriorityLabel(notification.Priority)
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="p-4 text-center text-muted" id="no-notifications-message">
                                    <i class="feather-bell-off fs-24 mb-2"></i>
                                    <p class="mb-0">@Html.T("لا توجد إشعارات جديدة", "No new notifications")</p>
                                </div>
                            }
                        </div>
                        <div class="text-center notifications-footer">
                            <a asp-area="Instructor" asp-controller="Notifications" asp-action="Index" class="fs-13 fw-semibold text-dark">
                                <i class="feather-list me-1"></i>
                                @Html.T("عرض جميع الإشعارات", "View All Notifications")
                            </a>
                        </div>
                    </div>
                </div>
                <!--! [End] Notifications Dropdown !-->
                
                <!--! [Start] User Profile Dropdown !-->
                <div class="dropdown nxl-h-item">
                    <a href="javascript:void(0);" class="header-dropdown-toggle" id="profileDropdownToggle">
                        <div class="avatar-text avatar-md bg-success text-white">
                            @if (user != null && !string.IsNullOrEmpty(user.FirstName))
                            {
                                <span>@(user.FirstName.Length > 0 ? user.FirstName.Substring(0, 1) : "")@(user.LastName?.Length > 0 ? user.LastName.Substring(0, 1) : "")</span>
                            }
                            else
                            {
                                <i class="feather-user"></i>
                            }
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-start nxl-h-dropdown nxl-user-dropdown">
                        <div class="dropdown-header p-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <div class="avatar-text avatar-md bg-success text-white">
                                    @if (user != null && !string.IsNullOrEmpty(user.FirstName))
                                    {
                                        <span>@(user.FirstName.Length > 0 ? user.FirstName.Substring(0, 1) : "")@(user.LastName?.Length > 0 ? user.LastName.Substring(0, 1) : "")</span>
                                    }
                                    else
                                    {
                                        <i class="feather-user"></i>
                                    }
                                </div>
                                <div class="ms-3">
                                    <h6 class="text-dark mb-0">@userName</h6>
                                    <span class="fs-12 fw-medium text-muted">@Html.T("مدرس", "Instructor")</span>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-body">
                            <a asp-area="Instructor" asp-controller="Profile" asp-action="Index" class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <i class="feather-user"></i>
                                <span>@Html.T("الملف الشخصي", "Profile")</span>
                            </a>
                            <a asp-area="Instructor" asp-controller="Courses" asp-action="Index" class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <i class="feather-book-open"></i>
                                <span>@Html.T("دوراتي", "My Courses")</span>
                            </a>
                            <a asp-area="Instructor" asp-controller="Analytics" asp-action="Index" class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <i class="feather-bar-chart-2"></i>
                                <span>@Html.T("التحليلات", "Analytics")</span>
                            </a>
                            <a asp-area="Instructor" asp-controller="Profile" asp-action="Settings" class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <i class="feather-settings"></i>
                                <span>@Html.T("الإعدادات", "Settings")</span>
                            </a>
                            <a asp-area="Instructor" asp-controller="Help" asp-action="Index" class="dropdown-item d-flex align-items-center gap-2 py-2">
                                <i class="feather-help-circle"></i>
                                <span>@Html.T("مركز المساعدة", "Help Center")</span>
                            </a>
                            <partial name="~/Views/Shared/_LanguageSwitcher.cshtml" />
                            <div class="dropdown-divider"></div>
                            <form asp-area="" asp-controller="Account" asp-action="Logout" method="post" id="logoutForm">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="dropdown-item d-flex align-items-center gap-2 py-2 text-danger">
                                    <i class="feather-log-out"></i>
                                    <span>@Html.T("تسجيل الخروج", "Logout")</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <!--! [End] User Profile Dropdown !-->
            </div>
        </div>
        <!--! [End] Header Right !-->
    </div>
</header>

<!-- Real-time Notification Toast Container -->
<div class="position-fixed" style="top: 80px; left: 20px; z-index: 9999;" id="notification-toast-container"></div>

<script>
    // Store current user ID for SignalR
    var currentUserId = '@userId';
</script>
