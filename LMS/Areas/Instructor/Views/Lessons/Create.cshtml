@model LMS.Areas.Instructor.ViewModels.LessonCreateViewModel
@inject IPlatformSettingsService PlatformSettings

@{
    ViewData["Title"] = Html.T("Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯", "Add New Lesson");
    ViewData["Subtitle"] = Html.T("Ø£Ø¶Ù Ù…Ø­ØªÙˆÙ‰ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¬Ø¯ÙŠØ¯", "Add new lesson content");
    
    // Load platform settings
    var defaultDurationMinutes = await PlatformSettings.GetIntSettingAsync("Lesson.DefaultDurationMinutes", 15);
    var defaultQuestions = await PlatformSettings.GetIntSettingAsync("Lesson.DefaultQuestions", 10);
    var defaultPassingScore = await PlatformSettings.GetIntSettingAsync("Quiz.DefaultPassingScore", 70);
    var minWatchPercent = await PlatformSettings.GetIntSettingAsync("Lesson.MinWatchPercent", 80);
    var maxResourceSizeMB = await PlatformSettings.GetIntSettingAsync("Media.MaxResourceSizeMB", 50);
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Create" method="post" enctype="multipart/form-data" id="lessonForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="ModuleId" />

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Lesson Type Selection -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø³", "Lesson Type")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeVideo" value="Video" checked onchange="toggleLessonType('Video')">
                                <label class="btn btn-outline-primary w-100 py-3" for="typeVideo">
                                    <i class="feather-video fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("Ø¯Ø±Ø³ ÙÙŠØ¯ÙŠÙˆ", "Video lesson")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeText" value="Text" onchange="toggleLessonType('Text')">
                                <label class="btn btn-outline-info w-100 py-3" for="typeText">
                                    <i class="feather-file-text fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("Ø¯Ø±Ø³ Ù†ØµÙŠ", "Text lesson")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeArticle" value="Article" onchange="toggleLessonType('Article')">
                                <label class="btn btn-outline-success w-100 py-3" for="typeArticle">
                                    <i class="feather-book-open fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("Ù…Ù‚Ø§Ù„", "Article")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typePDF" value="PDF" onchange="toggleLessonType('PDF')">
                                <label class="btn btn-outline-danger w-100 py-3" for="typePDF">
                                    <i class="feather-file fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("Ù…Ù„Ù PDF", "PDF file")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeAudio" value="Audio" onchange="toggleLessonType('Audio')">
                                <label class="btn btn-outline-secondary w-100 py-3" for="typeAudio">
                                    <i class="feather-headphones fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("ØµÙˆØªÙŠ", "Audio")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeQuiz" value="Quiz" onchange="toggleLessonType('Quiz')">
                                <label class="btn btn-outline-warning w-100 py-3" for="typeQuiz">
                                    <i class="feather-help-circle fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("Ø§Ø®ØªØ¨Ø§Ø±", "Quiz")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeAssignment" value="Assignment" onchange="toggleLessonType('Assignment')">
                                <label class="btn btn-outline-dark w-100 py-3" for="typeAssignment">
                                    <i class="feather-edit-3 fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("ØªÙƒÙ„ÙŠÙ", "Assignment")</span>
                                </label>
                            </div>
                            <div class="col-md-3 col-6">
                                <input type="radio" class="btn-check" name="Type" id="typeDownload" value="Download" onchange="toggleLessonType('Download')">
                                <label class="btn btn-outline-primary w-100 py-3" for="typeDownload">
                                    <i class="feather-download fs-2 d-block mb-2"></i>
                                    <span class="fw-bold fs-12">@Html.T("ØªØ­Ù…ÙŠÙ„", "Download")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "Basic Information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³", "Lesson title") <span class="text-danger">*</span></label>
                                <input asp-for="Title" class="form-control" placeholder="@Html.T("Ù…Ø«Ø§Ù„: Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©", "e.g. Introduction to Programming")" required>
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ø§Ù„ÙˆØµÙ", "Description") <span class="text-danger">*</span></label>
                                <textarea asp-for="Description" class="form-control" rows="4" placeholder="@Html.T("ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³", "Brief description of lesson content")" required></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)", "Duration (minutes)") <span class="text-danger">*</span></label>
                                <input asp-for="DurationMinutes" type="number" class="form-control" min="1" placeholder="@defaultDurationMinutes" required>
                                <span asp-validation-for="DurationMinutes" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±Ø³", "Lesson order")</label>
                                <input asp-for="OrderIndex" type="number" class="form-control" min="1" value="1">
                                <span asp-validation-for="OrderIndex" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Video Content -->
                <div id="videoContent" class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Video content")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Video type")</label>
                                <select class="form-select" id="videoSourceType" onchange="toggleVideoSource()">
                                    <option value="library">@Html.T("Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·", "From media library")</option>
                                    <option value="youtube">@Html.T("Ø±Ø§Ø¨Ø· YouTube", "YouTube link")</option>
                                    <option value="vimeo">@Html.T("Ø±Ø§Ø¨Ø· Vimeo", "Vimeo link")</option>
                                    <option value="url">@Html.T("Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±", "Direct link")</option>
                                </select>
                            </div>

                            <div class="col-lg-12" id="videoLibrary">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "VideoUrlLibrary" },
                                    { "FieldId", "videoUrlPicker" },
                                    { "Label", Html.T("ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³", "Lesson video") },
                                    { "MediaType", "Video" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("Ø§Ø®ØªØ± ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ù…ÙƒØªØ¨ØªÙƒ Ø£Ùˆ Ø§Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯", "Choose a video from your library or upload a new one") },
                                    { "AspectRatio", "16/9" }
                                })
                            </div>

                            <div class="col-lg-12" id="videoUrl" style="display: none;">
                                <label class="form-label">@Html.T("Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Video URL")</label>
                                <input class="form-control" placeholder="https://..." id="videoUrlInput">
                                <span asp-validation-for="VideoUrl" class="text-danger"></span>
                                <div class="form-text" id="videoUrlHelp">@Html.T("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Enter video URL")</div>
                            </div>
                            
                            <input type="hidden" name="VideoUrl" id="finalVideoUrl" value="" />
                        </div>
                    </div>
                </div>

                <!-- Text Content (for Text & Article types) -->
                <div id="textContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØµÙŠ", "Text content")</h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">@Html.T("Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³", "Lesson content") <span class="text-danger">*</span></label>
                        <textarea asp-for="HtmlContent" id="textContentEditor" class="form-control" rows="10"></textarea>
                        <span asp-validation-for="HtmlContent" class="text-danger"></span>
                    </div>
                </div>

                <!-- PDF Content -->
                <div id="pdfContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ù…Ù„Ù PDF", "PDF file")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø±", "Source type")</label>
                                <select class="form-select" id="pdfSourceType" onchange="togglePdfSource()">
                                    <option value="library">@Html.T("Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·", "From media library")</option>
                                    <option value="url">@Html.T("Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±", "Direct link")</option>
                                </select>
                            </div>
                            <div class="col-lg-12" id="pdfLibrary">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "PdfUrlLibrary" },
                                    { "FieldId", "pdfUrlPicker" },
                                    { "Label", Html.T("Ù…Ù„Ù PDF", "PDF file") },
                                    { "MediaType", "Document" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("Ø§Ø®ØªØ± Ù…Ù„Ù PDF Ù…Ù† Ù…ÙƒØªØ¨ØªÙƒ", "Choose a PDF file from your library") }
                                })
                            </div>
                            <div class="col-lg-12" id="pdfUrl" style="display: none;">
                                <label class="form-label">@Html.T("Ø±Ø§Ø¨Ø· Ù…Ù„Ù PDF", "PDF file URL")</label>
                                <input class="form-control" placeholder="https://..." id="pdfUrlInput">
                                <div class="form-text">@Html.T("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù…Ù„Ù PDF", "Enter direct link to PDF file")</div>
                            </div>
                            <input type="hidden" name="FileUrl" id="finalPdfUrl" value="" />
                        </div>
                    </div>
                </div>

                <!-- Audio Content -->
                <div id="audioContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ù…Ø­ØªÙˆÙ‰ ØµÙˆØªÙŠ", "Audio content")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø±", "Source type")</label>
                                <select class="form-select" id="audioSourceType" onchange="toggleAudioSource()">
                                    <option value="library">@Html.T("Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·", "From media library")</option>
                                    <option value="url">@Html.T("Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±", "Direct link")</option>
                                </select>
                            </div>
                            <div class="col-lg-12" id="audioLibrary">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "AudioUrlLibrary" },
                                    { "FieldId", "audioUrlPicker" },
                                    { "Label", Html.T("Ù…Ù„Ù ØµÙˆØªÙŠ", "Audio file") },
                                    { "MediaType", "Audio" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("Ø§Ø®ØªØ± Ù…Ù„Ù ØµÙˆØªÙŠ Ù…Ù† Ù…ÙƒØªØ¨ØªÙƒ", "Choose an audio file from your library") }
                                })
                            </div>
                            <div class="col-lg-12" id="audioUrl" style="display: none;">
                                <label class="form-label">@Html.T("Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ", "Audio file URL")</label>
                                <input class="form-control" placeholder="https://..." id="audioUrlInput">
                                <div class="form-text">@Html.T("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ (MP3, WAV, etc.)", "Enter direct link to audio file (MP3, WAV, etc.)")</div>
                            </div>
                            <input type="hidden" name="AudioUrl" id="finalAudioUrl" value="" />
                        </div>
                    </div>
                </div>

                <!-- Quiz Content -->
                <div id="quizContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", "Quiz settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-soft-info">
                            <i class="feather-info me-2"></i>
                            @Html.T("Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³", "You will be directed to create questions after saving the lesson")
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", "Number of questions")</label>
                                <input asp-for="QuizQuestionsCount" type="number" class="form-control" min="1" value="@defaultQuestions">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)", "Passing score (%)")</label>
                                <input asp-for="QuizPassingScore" type="number" class="form-control" min="0" max="100" value="@defaultPassingScore">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assignment Content -->
                <div id="assignmentContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙƒÙ„ÙŠÙ", "Assignment settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-soft-info mb-4">
                            <i class="feather-info me-2"></i>
                            @Html.T("Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³", "You will be directed to set up assignment details after saving the lesson")
                        </div>
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label">@Html.T("ÙˆØµÙ Ø§Ù„ØªÙƒÙ„ÙŠÙ", "Assignment description")</label>
                                <textarea class="form-control" name="AssignmentDescription" rows="4" placeholder="@Html.T("Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„ØªÙƒÙ„ÙŠÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨", "Write a detailed description of the assignment required from the student")"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰", "Maximum grade")</label>
                                <input type="number" class="form-control" name="AssignmentMaxPoints" min="1" max="100" value="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø£ÙŠØ§Ù…)", "Submission deadline (days)")</label>
                                <input type="number" class="form-control" name="AssignmentDeadlineDays" min="1" value="7">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="AssignmentAllowLate" id="allowLate">
                                    <label class="form-check-label" for="allowLate">
                                        @Html.T("Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªØ£Ø®Ø±", "Allow late submission")
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Content -->
                <div id="downloadContent" class="card stretch stretch-full mb-4 lesson-type-content" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„", "Downloadable file")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø±", "Source type")</label>
                                <select class="form-select" id="downloadSourceType" onchange="toggleDownloadSource()">
                                    <option value="library">@Html.T("Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·", "From media library")</option>
                                    <option value="url">@Html.T("Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±", "Direct link")</option>
                                </select>
                            </div>
                            <div class="col-lg-12" id="downloadLibrary">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "DownloadUrlLibrary" },
                                    { "FieldId", "downloadUrlPicker" },
                                    { "Label", Html.T("Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„", "Downloadable file") },
                                    { "MediaType", "All" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("Ø§Ø®ØªØ± Ù…Ù„Ù Ù…Ù† Ù…ÙƒØªØ¨ØªÙƒ (PDF, ZIP, DOC, etc.)", "Choose a file from your library (PDF, ZIP, DOC, etc.)") }
                                })
                            </div>
                            <div class="col-lg-12" id="downloadUrl" style="display: none;">
                                <label class="form-label">@Html.T("Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù", "File URL")</label>
                                <input class="form-control" placeholder="https://..." id="downloadUrlInput">
                                <div class="form-text">@Html.T("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ù", "Enter direct link to file")</div>
                            </div>
                            <input type="hidden" name="DownloadFileUrl" id="finalDownloadUrl" value="" />
                        </div>
                    </div>
                </div>

                <!-- Resources -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-paperclip me-2 text-primary"></i>
                            @Html.T("Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯", "Attachments & resources")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-soft-info mb-4">
                            <i class="feather-info me-2"></i>
                            @Html.T("ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDFØŒ Ù…Ø³ØªÙ†Ø¯Ø§Øª WordØŒ Ù…Ù„ÙØ§Øª Ù…Ø¶ØºÙˆØ·Ø©ØŒ Ø£Ùˆ Ø£ÙŠ Ù…ÙˆØ§Ø±Ø¯ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯Ø±Ø³", "You can add PDF files, Word documents, zip files, or any additional resources for the lesson")
                        </div>
                        <div id="resourcesContainer">
                            <!-- Resource rows will be added here -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addResource()">
                            <i class="feather-plus me-2"></i>
                            @Html.T("Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯", "Add new resource")
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publishing Options -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø±", "Publishing options")</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input asp-for="IsFree" class="form-check-input" type="checkbox" id="isFree">
                            <label class="form-check-label" for="isFree">@Html.T("Ø¯Ø±Ø³ Ù…Ø¬Ø§Ù†ÙŠ (Ù…Ø¹Ø§ÙŠÙ†Ø©)", "Free lesson (preview)")</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input asp-for="IsPublished" class="form-check-input" type="checkbox" id="isPublished" checked>
                            <label class="form-check-label" for="isPublished">@Html.T("Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³", "Publish lesson")</label>
                        </div>

                        <div class="form-check form-switch">
                            <input asp-for="AllowDownload" class="form-check-input" type="checkbox" id="allowDownload">
                            <label class="form-check-label" for="allowDownload">@Html.T("Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„", "Allow download")</label>
                        </div>
                    </div>
                </div>

                <!-- Additional Settings -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©", "Additional settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">@Html.T("Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (%)", "Required watch percentage (%)")</label>
                            <input asp-for="MinimumWatchPercentage" type="number" class="form-control" min="0" max="100" value="@minWatchPercent">
                            <div class="form-text">@Html.T("Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³", "Percentage required to complete the lesson")</div>
                        </div>

                        <div class="form-check">
                            <input asp-for="PreventSkipping" class="form-check-input" type="checkbox" id="preventSkipping">
                            <label class="form-check-label" for="preventSkipping">
                                @Html.T("Ù…Ù†Ø¹ ØªØ®Ø·ÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "Prevent video skipping")
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Content Scheduling -->
                <div class="card stretch stretch-full mb-4" id="contentDripCard">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-clock me-2 text-info"></i>
                            @Html.T("Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰", "Content scheduling")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©", "Schedule type")</label>
                            <select class="form-select" name="ContentDripType" id="contentDripType" onchange="toggleDripFields()">
                                <option value="Immediate">@Html.T("Ù…ØªØ§Ø­ ÙÙˆØ±Ø§Ù‹", "Available immediately")</option>
                                <option value="DaysAfterEnrollment">@Html.T("Ø¨Ø¹Ø¯ Ø£ÙŠØ§Ù… Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "Days after enrollment")</option>
                                <option value="AfterPreviousCompletion">@Html.T("Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø³Ø§Ø¨Ù‚", "After previous lesson completion")</option>
                                <option value="SpecificDate">@Html.T("ÙÙŠ ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯", "On a specific date")</option>
                            </select>
                        </div>
                        <div id="dripDaysField" style="display: none;" class="mb-3">
                            <label class="form-label">@Html.T("Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "Days after enrollment")</label>
                            <input type="number" class="form-control" name="AvailableAfterDays" min="1" placeholder="@Html.T("Ù…Ø«Ø§Ù„: 7", "e.g. 7")">
                        </div>
                        <div id="dripPrerequisiteField" style="display: none;" class="mb-3">
                            <label class="form-label">@Html.T("Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù…ØªØ·Ù„Ø¨", "Prerequisite lesson")</label>
                            <select class="form-select" name="PrerequisiteLessonId">
                                <option value="">@Html.T("Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø³Ø§Ø¨Ù‚", "Select previous lesson")</option>
                            </select>
                            <div class="form-text">@Html.T("Ø³ÙŠØªÙ… Ø¥ØªØ§Ø­Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù…Ø­Ø¯Ø¯", "This lesson will be available after completing the specified lesson")</div>
                        </div>
                        <div id="dripDateField" style="display: none;" class="mb-3">
                            <label class="form-label">@Html.T("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØªØ§Ø­Ø©", "Availability date")</label>
                            <input type="datetime-local" class="form-control" name="AvailableFrom">
                        </div>
                    </div>
                </div>

                <!-- Help -->
                <div class="card stretch stretch-full">
                    <div class="card-body bg-soft-info">
                        <h6 class="fw-bold mb-3">ğŸ’¡ @Html.T("Ù†ØµÙŠØ­Ø©", "Tip")</h6>
                        <p class="fs-13 mb-0">
                            @Html.T("Ø§Ø¬Ø¹Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ ÙˆØ§Ø¶Ø­Ø§Ù‹ ÙˆÙ…Ø®ØªØµØ±Ø§Ù‹. ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙˆØ¶ÙˆØ­ Ø§Ù„ØµÙˆØª.", "Keep the lesson title clear and concise. Ensure video quality and clear audio.")
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <a href="@Url.Action("Index", new { moduleId = Model.ModuleId })" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("Ø¥Ù„ØºØ§Ø¡", "Cancel")
                            </a>
                            <div class="d-flex gap-2">
                                <button type="submit" name="saveAction" value="draft" class="btn btn-light">
                                    <i class="feather-save me-2"></i>
                                    @Html.T("Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©", "Save as draft")
                                </button>
                                <button type="submit" name="saveAction" value="publish" class="btn btn-primary">
                                    <i class="feather-check me-2"></i>
                                    @Html.T("Ø­ÙØ¸ ÙˆÙ†Ø´Ø±", "Save and publish")
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("_TinyMCEScripts")
    <script>
        window.__lessonCreateI18n = {
            videoHelpYoutube: @Html.Raw(Json.Serialize(Html.T("Ù…Ø«Ø§Ù„: https://youtube.com/watch?v=dQw4w9WgXcQ", "e.g. https://youtube.com/watch?v=...").ToString())),
            videoHelpVimeo: @Html.Raw(Json.Serialize(Html.T("Ù…Ø«Ø§Ù„: https://vimeo.com/123456789", "e.g. https://vimeo.com/123456789").ToString())),
            videoHelpUrl: @Html.Raw(Json.Serialize(Html.T("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±", "Enter direct video URL").ToString())),
            resourceTitlePlaceholder: @Html.Raw(Json.Serialize(Html.T("Ù…Ø«Ø§Ù„: Ù…Ù„Ù PDF Ù„Ù„Ø¯Ø±Ø³", "e.g. PDF file for lesson").ToString())),
            resourceLibraryPlaceholder: @Html.Raw(Json.Serialize(Html.T("Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©", "Click to select file from library").ToString())),
            resourceChoose: @Html.Raw(Json.Serialize(Html.T("Ø§Ø®ØªÙŠØ§Ø±", "Choose").ToString())),
            resourceLabel: @Html.Raw(Json.Serialize(Html.T("Ù…ÙˆØ±Ø¯", "Resource").ToString())),
            resourceTitleLabel: @Html.Raw(Json.Serialize(Html.T("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯", "Resource title").ToString())),
            resourceTypeLabel: @Html.Raw(Json.Serialize(Html.T("Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù", "File type").ToString())),
            resourceLibraryOption: @Html.Raw(Json.Serialize(Html.T("Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·", "Select from media library").ToString())),
            resourceUploadOption: @Html.Raw(Json.Serialize(Html.T("Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯", "Upload new file").ToString())),
            resourceUrlOption: @Html.Raw(Json.Serialize(Html.T("Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ", "External link").ToString())),
            maxSizeLabel: @Html.Raw(Json.Serialize(Html.T("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰", "Max").ToString())),
            directLinkLabel: @Html.Raw(Json.Serialize(Html.T("Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ù (Google Drive, Dropbox, Ø¥Ù„Ø®)", "Direct link to file (Google Drive, Dropbox, etc.)").ToString()))
        };
        // Initialize TinyMCE for text content
        initTinyMCE('#textContentEditor', { height: 500, plugins: 'lists link image code table' });

        // Toggle lesson type content - show/hide based on selected type
        function toggleLessonType(type) {
            // Hide all content sections first
            document.querySelectorAll('.lesson-type-content').forEach(el => el.style.display = 'none');
            document.getElementById('videoContent').style.display = 'none';
            
            // Show relevant content section based on type
            switch(type) {
                case 'Video':
                    document.getElementById('videoContent').style.display = 'block';
                    break;
                case 'Text':
                case 'Article':
                    document.getElementById('textContent').style.display = 'block';
                    break;
                case 'PDF':
                    document.getElementById('pdfContent').style.display = 'block';
                    break;
                case 'Audio':
                    document.getElementById('audioContent').style.display = 'block';
                    break;
                case 'Quiz':
                    document.getElementById('quizContent').style.display = 'block';
                    break;
                case 'Assignment':
                    document.getElementById('assignmentContent').style.display = 'block';
                    break;
                case 'Download':
                    document.getElementById('downloadContent').style.display = 'block';
                    break;
            }
        }
        
        // Toggle PDF source (library vs URL)
        function togglePdfSource() {
            const sourceType = document.getElementById('pdfSourceType').value;
            document.getElementById('pdfLibrary').style.display = sourceType === 'library' ? 'block' : 'none';
            document.getElementById('pdfUrl').style.display = sourceType === 'url' ? 'block' : 'none';
            syncPdfUrl();
        }
        
        function syncPdfUrl() {
            const sourceType = document.getElementById('pdfSourceType').value;
            const pdfPicker = document.getElementById('pdfUrlPicker');
            const pdfInput = document.getElementById('pdfUrlInput');
            const finalPdf = document.getElementById('finalPdfUrl');
            
            if (finalPdf) {
                finalPdf.value = sourceType === 'library' ? (pdfPicker?.value || '') : (pdfInput?.value || '');
            }
        }
        
        // Toggle Audio source (library vs URL)
        function toggleAudioSource() {
            const sourceType = document.getElementById('audioSourceType').value;
            document.getElementById('audioLibrary').style.display = sourceType === 'library' ? 'block' : 'none';
            document.getElementById('audioUrl').style.display = sourceType === 'url' ? 'block' : 'none';
            syncAudioUrl();
        }
        
        function syncAudioUrl() {
            const sourceType = document.getElementById('audioSourceType').value;
            const audioPicker = document.getElementById('audioUrlPicker');
            const audioInput = document.getElementById('audioUrlInput');
            const finalAudio = document.getElementById('finalAudioUrl');
            
            if (finalAudio) {
                finalAudio.value = sourceType === 'library' ? (audioPicker?.value || '') : (audioInput?.value || '');
            }
        }
        
        // Toggle Download source (library vs URL)
        function toggleDownloadSource() {
            const sourceType = document.getElementById('downloadSourceType').value;
            document.getElementById('downloadLibrary').style.display = sourceType === 'library' ? 'block' : 'none';
            document.getElementById('downloadUrl').style.display = sourceType === 'url' ? 'block' : 'none';
            syncDownloadUrl();
        }
        
        function syncDownloadUrl() {
            const sourceType = document.getElementById('downloadSourceType').value;
            const downloadPicker = document.getElementById('downloadUrlPicker');
            const downloadInput = document.getElementById('downloadUrlInput');
            const finalDownload = document.getElementById('finalDownloadUrl');
            
            if (finalDownload) {
                finalDownload.value = sourceType === 'library' ? (downloadPicker?.value || '') : (downloadInput?.value || '');
            }
        }

        // Toggle video source
        function toggleVideoSource() {
            const sourceType = document.getElementById('videoSourceType').value;
            const videoLibrary = document.getElementById('videoLibrary');
            const videoUrl = document.getElementById('videoUrl');
            const videoUrlHelp = document.getElementById('videoUrlHelp');
            const videoUrlInput = document.getElementById('videoUrlInput');
            const videoPickerInput = document.getElementById('videoUrlPicker');
            
            if (sourceType === 'library') {
                videoLibrary.style.display = 'block';
                videoUrl.style.display = 'none';
                if (videoUrlInput) videoUrlInput.value = '';
            } else {
                videoLibrary.style.display = 'none';
                videoUrl.style.display = 'block';
                if (videoPickerInput) videoPickerInput.value = '';
                
                const input = document.getElementById('videoUrlInput');
                var i18n = window.__lessonCreateI18n || {};
                if (sourceType === 'youtube') {
                    input.placeholder = 'https://youtube.com/watch?v=...';
                    videoUrlHelp.textContent = i18n.videoHelpYoutube || 'e.g. https://youtube.com/watch?v=...';
                } else if (sourceType === 'vimeo') {
                    input.placeholder = 'https://vimeo.com/...';
                    videoUrlHelp.textContent = i18n.videoHelpVimeo || 'e.g. https://vimeo.com/123456789';
                } else {
                    input.placeholder = 'https://...';
                    videoUrlHelp.textContent = i18n.videoHelpUrl || 'Enter direct video URL';
                }
            }
            
            syncVideoUrl();
        }
        
        function syncVideoUrl() {
            const sourceType = document.getElementById('videoSourceType').value;
            const videoPickerInput = document.getElementById('videoUrlPicker');
            const videoUrlInput = document.getElementById('videoUrlInput');
            const finalVideoUrl = document.getElementById('finalVideoUrl');
            
            if (finalVideoUrl) {
                if (sourceType === 'library') {
                    finalVideoUrl.value = videoPickerInput ? videoPickerInput.value : '';
                } else {
                    finalVideoUrl.value = videoUrlInput ? videoUrlInput.value : '';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const videoUrlInput = document.getElementById('videoUrlInput');
            const videoPickerInput = document.getElementById('videoUrlPicker');
            
            if (videoUrlInput) {
                videoUrlInput.addEventListener('input', syncVideoUrl);
                videoUrlInput.addEventListener('change', syncVideoUrl);
            }
            
            if (videoPickerInput) {
                const observer = new MutationObserver(syncVideoUrl);
                observer.observe(videoPickerInput, { attributes: true, attributeFilter: ['value'] });
                videoPickerInput.addEventListener('change', syncVideoUrl);
            }
            
            // Add event listeners for PDF inputs
            const pdfUrlInput = document.getElementById('pdfUrlInput');
            const pdfPickerInput = document.getElementById('pdfUrlPicker');
            if (pdfUrlInput) {
                pdfUrlInput.addEventListener('input', syncPdfUrl);
                pdfUrlInput.addEventListener('change', syncPdfUrl);
            }
            if (pdfPickerInput) {
                pdfPickerInput.addEventListener('change', syncPdfUrl);
            }
            
            // Add event listeners for Audio inputs
            const audioUrlInput = document.getElementById('audioUrlInput');
            const audioPickerInput = document.getElementById('audioUrlPicker');
            if (audioUrlInput) {
                audioUrlInput.addEventListener('input', syncAudioUrl);
                audioUrlInput.addEventListener('change', syncAudioUrl);
            }
            if (audioPickerInput) {
                audioPickerInput.addEventListener('change', syncAudioUrl);
            }
            
            // Add event listeners for Download inputs
            const downloadUrlInput = document.getElementById('downloadUrlInput');
            const downloadPickerInput = document.getElementById('downloadUrlPicker');
            if (downloadUrlInput) {
                downloadUrlInput.addEventListener('input', syncDownloadUrl);
                downloadUrlInput.addEventListener('change', syncDownloadUrl);
            }
            if (downloadPickerInput) {
                downloadPickerInput.addEventListener('change', syncDownloadUrl);
            }
            
            const form = document.getElementById('lessonForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    syncVideoUrl();
                    syncPdfUrl();
                    syncAudioUrl();
                    syncDownloadUrl();
                });
            }
        });

        // Resources management
        let resourceIndex = 0;
        
        function addResource() {
            const container = document.getElementById('resourcesContainer');
            const uniqueId = 'resource_' + resourceIndex + '_' + Date.now();
            const i18n = window.__lessonCreateI18n || {};
            const resourceLabel = i18n.resourceLabel || 'Resource';
            const resourceTitleLabel = i18n.resourceTitleLabel || 'Resource title';
            const resourceTitlePh = i18n.resourceTitlePlaceholder || 'e.g. PDF file for lesson';
            const resourceTypeLabel = i18n.resourceTypeLabel || 'File type';
            const libOpt = i18n.resourceLibraryOption || 'Select from media library';
            const uploadOpt = i18n.resourceUploadOption || 'Upload new file';
            const urlOpt = i18n.resourceUrlOption || 'External link';
            const libraryPh = i18n.resourceLibraryPlaceholder || 'Click to select file from library';
            const chooseBtn = i18n.resourceChoose || 'Choose';
            const maxSizeLabel = i18n.maxSizeLabel || 'Max';
            const directLinkLabel = i18n.directLinkLabel || 'Direct link to file (Google Drive, Dropbox, etc.)';
            
            const html = `
                <div class="resource-item card bg-light mb-3" data-index="${resourceIndex}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">
                                <i class="feather-file me-2"></i>
                                ${resourceLabel} #${resourceIndex + 1}
                            </h6>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeResource(this)">
                                <i class="feather-trash-2"></i>
                            </button>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">${resourceTitleLabel}</label>
                                <input type="text" class="form-control" name="Resources[${resourceIndex}].Title" 
                                       placeholder="${resourceTitlePh.replace(/"/g, '&quot;')}" id="${uniqueId}_title">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">${resourceTypeLabel}</label>
                                <select class="form-select" id="${uniqueId}_type" onchange="toggleResourceSource('${uniqueId}')">
                                    <option value="library">${libOpt}</option>
                                    <option value="upload">${uploadOpt}</option>
                                    <option value="url">${urlOpt}</option>
                                </select>
                            </div>
                            
                            <!-- Library Selection -->
                            <div class="col-12" id="${uniqueId}_library">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="${uniqueId}_libraryDisplay" 
                                           placeholder="${libraryPh.replace(/"/g, '&quot;')}" readonly>
                                    <input type="hidden" name="Resources[${resourceIndex}].FileUrl" id="${uniqueId}_fileUrl">
                                    <button type="button" class="btn btn-outline-primary" onclick="openResourceMediaPicker('${uniqueId}', ${resourceIndex})">
                                        <i class="feather-folder me-1"></i>
                                        ${chooseBtn}
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearResourceMedia('${uniqueId}')" 
                                            id="${uniqueId}_clearBtn" style="display: none;">
                                        <i class="feather-x"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- File Upload -->
                            <div class="col-12" id="${uniqueId}_upload" style="display: none;">
                                <input type="file" class="form-control" name="Resources[${resourceIndex}].File" 
                                       accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.txt,.mp3,.mp4">
                                <div class="form-text">${maxSizeLabel}: @(maxResourceSizeMB)MB</div>
                            </div>
                            
                            <!-- External URL -->
                            <div class="col-12" id="${uniqueId}_url" style="display: none;">
                                <input type="url" class="form-control" name="Resources[${resourceIndex}].ExternalUrl" 
                                       placeholder="https://example.com/file.pdf">
                                <div class="form-text">${directLinkLabel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
            resourceIndex++;
        }

        function removeResource(btn) {
            btn.closest('.resource-item').remove();
            updateResourceNumbers();
        }
        
        function updateResourceNumbers() {
            const items = document.querySelectorAll('.resource-item');
            items.forEach((item, index) => {
                item.querySelector('h6').innerHTML = `<i class="feather-file me-2"></i>Ù…ÙˆØ±Ø¯ #${index + 1}`;
            });
        }
        
        function toggleResourceSource(uniqueId) {
            const type = document.getElementById(uniqueId + '_type').value;
            const library = document.getElementById(uniqueId + '_library');
            const upload = document.getElementById(uniqueId + '_upload');
            const url = document.getElementById(uniqueId + '_url');
            
            library.style.display = type === 'library' ? 'block' : 'none';
            upload.style.display = type === 'upload' ? 'block' : 'none';
            url.style.display = type === 'url' ? 'block' : 'none';
        }
        
        // Store current resource picker context
        let currentResourcePickerId = null;
        let currentResourceIndex = null;
        
        function openResourceMediaPicker(uniqueId, index) {
            currentResourcePickerId = uniqueId;
            currentResourceIndex = index;
            
            // Create a temporary picker element for MediaPicker integration
            const tempPickerId = 'resourcePicker_' + uniqueId;
            let tempPicker = document.getElementById('mediaPicker_' + tempPickerId);
            
            if (!tempPicker) {
                tempPicker = document.createElement('div');
                tempPicker.id = 'mediaPicker_' + tempPickerId;
                tempPicker.className = 'media-picker-wrapper d-none';
                tempPicker.setAttribute('data-field-id', uniqueId + '_fileUrl');
                tempPicker.setAttribute('data-media-type', 'All');
                document.body.appendChild(tempPicker);
            }
            
            // Store original select handler
            const originalConfirmSelection = MediaPicker.confirmSelection;
            
            // Override selection to handle resource picker
            MediaPicker.confirmSelection = function() {
                if (currentResourcePickerId && window.MediaPicker) {
                    // Get selected media from MediaPicker's internal state
                    const selectedUrl = document.querySelector('.media-item.selected')?.dataset?.url;
                    const selectedTitle = document.querySelector('.media-item.selected .card-title')?.textContent;
                    
                    if (selectedUrl) {
                        document.getElementById(currentResourcePickerId + '_libraryDisplay').value = selectedTitle || selectedUrl;
                        document.getElementById(currentResourcePickerId + '_fileUrl').value = selectedUrl;
                        document.getElementById(currentResourcePickerId + '_clearBtn').style.display = 'inline-block';
                        
                        const titleInput = document.getElementById(currentResourcePickerId + '_title');
                        if (titleInput && !titleInput.value) {
                            titleInput.value = selectedTitle || '';
                        }
                    }
                    
                    currentResourcePickerId = null;
                    currentResourceIndex = null;
                }
                
                // Call original handler
                originalConfirmSelection.call(MediaPicker);
                
                // Restore original handler
                MediaPicker.confirmSelection = originalConfirmSelection;
            };
            
            // Use MediaPicker's singleton modal
            MediaPicker.openLibrary(tempPickerId);
        }
        
        function clearResourceMedia(uniqueId) {
            document.getElementById(uniqueId + '_libraryDisplay').value = '';
            document.getElementById(uniqueId + '_fileUrl').value = '';
            document.getElementById(uniqueId + '_clearBtn').style.display = 'none';
        }

        // Content Drip toggle
        function toggleDripFields() {
            const dripType = document.getElementById('contentDripType').value;
            const dripDaysField = document.getElementById('dripDaysField');
            const dripPrerequisiteField = document.getElementById('dripPrerequisiteField');
            const dripDateField = document.getElementById('dripDateField');

            dripDaysField.style.display = 'none';
            dripPrerequisiteField.style.display = 'none';
            dripDateField.style.display = 'none';

            switch (dripType) {
                case 'DaysAfterEnrollment':
                    dripDaysField.style.display = 'block';
                    break;
                case 'AfterPreviousCompletion':
                    dripPrerequisiteField.style.display = 'block';
                    break;
                case 'SpecificDate':
                    dripDateField.style.display = 'block';
                    break;
            }
        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

