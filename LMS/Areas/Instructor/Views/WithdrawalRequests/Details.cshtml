@model LMS.Domain.Entities.Financial.WithdrawalRequest

@{
    ViewData["Title"] = Html.T("تفاصيل طلب السحب", "Withdrawal Request Details");
    ViewData["Subtitle"] = $"طلب رقم #{Model.Id}";
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw($"<a href='{Url.Action("Index")}' class='btn btn-light'><i class='feather-arrow-right me-2'></i>{Html.T("العودة", "Back")}</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <div class="row">
        <div class="col-lg-8">
            <!-- Status Alert -->
            <div class="card mb-4 border-0 
                @(Model.Status == LMS.Domain.Enums.WithdrawalStatus.Completed ? "bg-soft-success" : 
                  Model.Status == LMS.Domain.Enums.WithdrawalStatus.Rejected ? "bg-soft-danger" :
                  Model.Status == LMS.Domain.Enums.WithdrawalStatus.Pending ? "bg-soft-warning" : "bg-soft-info")">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-lg 
                            @(Model.Status == LMS.Domain.Enums.WithdrawalStatus.Completed ? "bg-success" : 
                              Model.Status == LMS.Domain.Enums.WithdrawalStatus.Rejected ? "bg-danger" :
                              Model.Status == LMS.Domain.Enums.WithdrawalStatus.Pending ? "bg-warning" : "bg-info")
                            text-white">
                            <i class="feather-@(Model.Status == LMS.Domain.Enums.WithdrawalStatus.Completed ? "check-circle" : 
                                              Model.Status == LMS.Domain.Enums.WithdrawalStatus.Rejected ? "x-circle" :
                                              Model.Status == LMS.Domain.Enums.WithdrawalStatus.Pending ? "clock" : "loader")"></i>
                        </div>
                        <div>
                            <h5 class="fw-bold mb-1">
                                @switch (Model.Status)
                                {
                                    case LMS.Domain.Enums.WithdrawalStatus.Pending:
                                        @Html.T("طلب قيد المراجعة", "Request pending review")
                                        break;
                                    case LMS.Domain.Enums.WithdrawalStatus.Approved:
                                        @Html.T("تمت الموافقة على الطلب", "Request approved")
                                        break;
                                    case LMS.Domain.Enums.WithdrawalStatus.Processing:
                                        @Html.T("الطلب قيد المعالجة", "Request being processed")
                                        break;
                                    case LMS.Domain.Enums.WithdrawalStatus.Completed:
                                        @Html.T("تم إكمال الطلب", "Request completed")
                                        break;
                                    case LMS.Domain.Enums.WithdrawalStatus.Rejected:
                                        @Html.T("تم رفض الطلب", "Request rejected")
                                        break;
                                    case LMS.Domain.Enums.WithdrawalStatus.Cancelled:
                                        @Html.T("تم إلغاء الطلب", "Request cancelled")
                                        break;
                                }
                            </h5>
                            <p class="mb-0">@Model.StatusNote</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تفاصيل الطلب", "Request Details")</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-soft-primary rounded">
                                <div class="text-muted fs-12 mb-1">@Html.T("المبلغ المطلوب", "Requested Amount")</div>
                                <div class="fs-24 fw-bold text-primary">@Model.Amount.ToString("N2") @Model.Currency</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-soft-success rounded">
                                <div class="text-muted fs-12 mb-1">@Html.T("المبلغ الصافي", "Net Amount")</div>
                                <div class="fs-24 fw-bold text-success">@Model.NetAmount.ToString("N2") @Model.Currency</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tr>
                                        <td class="fw-medium">@Html.T("المبلغ المطلوب:", "Requested Amount:")</td>
                                        <td class="text-end">@Model.Amount.ToString("N2") @Model.Currency</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-medium">@Html.T("الرسوم:", "Fees:")</td>
                                        <td class="text-end text-danger">- @Model.Fee.ToString("N2") @Model.Currency</td>
                                    </tr>
                                    <tr class="border-top">
                                        <td class="fw-bold">@Html.T("المبلغ الصافي:", "Net Amount:")</td>
                                        <td class="text-end fw-bold text-success fs-18">@Model.NetAmount.ToString("N2") @Model.Currency</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Method -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("طريقة السحب", "Withdrawal Method")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="avatar-text avatar-lg bg-info text-white">
                            <i class="feather-credit-card"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">@Model.WithdrawalMethod?.Name</h6>
                            <p class="text-muted mb-0">@Model.WithdrawalMethod?.Description</p>
                        </div>
                    </div>
                    <div class="alert alert-info border-0">
                        <strong>@Html.T("تفاصيل الحساب:", "Account Details:")</strong>
                        <div class="mt-2">@Model.AccountDetails</div>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            @if (!string.IsNullOrEmpty(Model.InstructorNotes) || !string.IsNullOrEmpty(Model.AdminNotes))
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الملاحظات", "Notes")</h5>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.InstructorNotes))
                        {
                            <div class="mb-3">
                                <h6 class="fw-bold mb-2">@Html.T("ملاحظاتك:", "Your notes:")</h6>
                                <p class="text-muted mb-0">@Model.InstructorNotes</p>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.AdminNotes))
                        {
                            <div class="alert alert-warning border-0">
                                <h6 class="fw-bold mb-2">@Html.T("ملاحظات الإدارة:", "Admin notes:")</h6>
                                <p class="mb-0">@Model.AdminNotes</p>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions -->
            @if (Model.Status == LMS.Domain.Enums.WithdrawalStatus.Pending)
            {
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="post" asp-action="Cancel" asp-route-id="@Model.Id" onsubmit="return confirm('@Html.Raw(Html.T("هل أنت متأكد من إلغاء هذا الطلب؟", "Are you sure you want to cancel this request?").Replace("'", "\\'"))')">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء الطلب", "Cancel Request")
                            </button>
                        </form>
                    </div>
                </div>
            }
            @if (Model.Status == LMS.Domain.Enums.WithdrawalStatus.Approved)
            {
                <div class="card mb-4 border-success">
                    <div class="card-body">
                        <p class="text-muted small mb-3">@Html.T("بعد استلامك المبلغ في حسابك، اضغط لتأكيد الاستلام.", "After you receive the amount in your account, click to confirm receipt.")</p>
                        <form method="post" asp-action="ConfirmReceived" asp-route-id="@Model.Id" onsubmit="return confirm('@Html.Raw(Html.T("هل استلمت المبلغ فعلاً؟", "Have you received the amount?").Replace("'", "\\'"))')">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success w-100">
                                <i class="feather-check-circle me-2"></i>
                                @Html.T("تأكيد استلام المبلغ", "Confirm I received the amount")
                            </button>
                        </form>
                    </div>
                </div>
            }

            <!-- Timeline -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title">@Html.T("سجل الطلب", "Request Log")</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <div class="d-flex align-items-start gap-2">
                                <i class="feather-circle text-primary mt-1"></i>
                                <div>
                                    <div class="fw-medium">@Html.T("تم إنشاء الطلب", "Request created")</div>
                                    <small class="text-muted">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                            </div>
                        </li>
                        @if (Model.ApprovedAt.HasValue)
                        {
                            <li class="mb-3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="feather-check text-success mt-1"></i>
                                    <div>
                                        <div class="fw-medium">@Html.T("تمت الموافقة", "Approved")</div>
                                        <small class="text-muted">@Model.ApprovedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            </li>
                        }
                        @if (Model.ProcessedAt.HasValue)
                        {
                            <li class="mb-3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="feather-check-circle text-success mt-1"></i>
                                    <div>
                                        <div class="fw-medium">@Html.T("تمت المعالجة", "Processed")</div>
                                        <small class="text-muted">@Model.ProcessedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                        @if (Model.ProcessedBy != null)
                                        {
                                            <div><small class="text-muted">@Html.T("بواسطة:", "By:") @Model.ProcessedBy.FullName</small></div>
                                        }
                                    </div>
                                </div>
                            </li>
                        }
                        @if (Model.RejectedAt.HasValue)
                        {
                            <li class="mb-3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="feather-x-circle text-danger mt-1"></i>
                                    <div>
                                        <div class="fw-medium">@Html.T("تم الرفض", "Rejected")</div>
                                        <small class="text-muted">@Model.RejectedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            </li>
                        }
                        @if (Model.InstructorConfirmedReceivedAt.HasValue)
                        {
                            <li class="mb-3">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="feather-check-circle text-success mt-1"></i>
                                    <div>
                                        <div class="fw-medium">@Html.T("تم تأكيد الاستلام", "Receipt confirmed")</div>
                                        <small class="text-muted">@Model.InstructorConfirmedReceivedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            </li>
                        }
                        @if (Model.CancelledAt.HasValue)
                        {
                            <li>
                                <div class="d-flex align-items-start gap-2">
                                    <i class="feather-slash text-secondary mt-1"></i>
                                    <div>
                                        <div class="fw-medium">@Html.T("تم الإلغاء", "Cancelled")</div>
                                        <small class="text-muted">@Model.CancelledAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>

            <!-- Request Info -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title">@Html.T("معلومات الطلب", "Request Information")</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="py-2 border-bottom">
                            <small class="text-muted">@Html.T("رقم الطلب", "Request number")</small>
                            <div class="fw-bold">#@Model.Id</div>
                        </li>
                        <li class="py-2 border-bottom">
                            <small class="text-muted">@Html.T("تاريخ الإنشاء", "Created at")</small>
                            <div class="fw-medium">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                        </li>
                        <li class="py-2">
                            <small class="text-muted">@Html.T("آخر تحديث", "Last updated")</small>
                            <div class="fw-medium">@(Model.LastModifiedAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

