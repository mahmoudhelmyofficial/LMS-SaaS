@model LMS.Areas.Instructor.ViewModels.AnnouncementEditViewModel

@{
    ViewData["Title"] = Html.T("تعديل الإعلان", "Edit Announcement");
    ViewData["Subtitle"] = Html.T("تحديث معلومات وإعدادات الإعلان", "Update announcement details and settings");
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="announcementForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="CourseId" />
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2 text-primary"></i>
                            معلومات الإعلان
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">الدورة <span class="text-danger">*</span></label>
                                <select asp-for="CourseId" class="form-select" disabled>
                                    @foreach (var course in ViewBag.Courses as List<LMS.Domain.Entities.Courses.Course>)
                                    {
                                        <option value="@course.Id" selected="@(Model.CourseId == course.Id)">@course.Title</option>
                                    }
                                </select>
                                <span asp-validation-for="CourseId" class="text-danger"></span>
                                <div class="form-text text-muted">
                                    <i class="feather-lock me-1"></i>
                                    لا يمكن تغيير الدورة بعد إنشاء الإعلان
                                </div>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">عنوان الإعلان <span class="text-danger">*</span></label>
                                <input asp-for="Title" class="form-control" placeholder="@Html.T("مثال: تحديث هام على محتوى الدورة", "e.g. Important update on course content")" required>
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">محتوى الإعلان <span class="text-danger">*</span></label>
                                <textarea asp-for="Content" class="form-control" rows="8" required></textarea>
                                <span asp-validation-for="Content" class="text-danger"></span>
                                <div class="form-text">
                                    يمكنك استخدام Markdown للتنسيق المتقدم
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-settings me-2 text-primary"></i>
                            الإعدادات المتقدمة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">نوع الإعلان</label>
                                <select asp-for="AnnouncementType" class="form-select">
                                    <option value="@LMS.Domain.Enums.AnnouncementType.General">عام</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.CourseUpdate">تحديث الدورة</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.Assignment">تكليف جديد</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.LiveClass">حصة مباشرة</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.Assessment">تقييم</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.Deadline">موعد نهائي</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementType.Reminder">تذكير</option>
                                </select>
                                <span asp-validation-for="AnnouncementType" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">الأولوية</label>
                                <select asp-for="Priority" class="form-select">
                                    <option value="@LMS.Domain.Enums.AnnouncementPriority.Low">منخفضة</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementPriority.Normal">عادية</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementPriority.High">عالية</option>
                                    <option value="@LMS.Domain.Enums.AnnouncementPriority.Urgent">عاجلة</option>
                                </select>
                                <span asp-validation-for="Priority" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">رابط خارجي (اختياري)</label>
                                <input asp-for="ExternalLink" type="url" class="form-control" placeholder="https://example.com">
                                <span asp-validation-for="ExternalLink" class="text-danger"></span>
                                <div class="form-text">رابط لمحتوى إضافي أو موارد خارجية</div>
                            </div>

                            <div class="col-md-6">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "AttachmentUrl" },
                                    { "FieldId", "attachmentUrl" },
                                    { "Label", "المرفق (اختياري)" },
                                    { "MediaType", "All" },
                                    { "CurrentValue", Model.AttachmentUrl },
                                    { "Required", false },
                                    { "HelpText", "اختر ملف من المكتبة أو ارفع ملف جديد (PDF، صورة، مستند، إلخ)" }
                                })
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">تاريخ انتهاء الصلاحية (اختياري)</label>
                                <input asp-for="ExpiresAt" type="datetime-local" class="form-control">
                                <span asp-validation-for="ExpiresAt" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-alert-circle me-1"></i>
                                    سيتم إخفاء الإعلان تلقائياً بعد هذا التاريخ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit History -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-clock me-2 text-primary"></i>
                            معلومات إضافية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-3 bg-soft-primary rounded">
                                    <i class="feather-calendar fs-4 text-primary me-3"></i>
                                    <div>
                                        <small class="text-muted d-block">تاريخ الإنشاء</small>
                                        <strong id="createdDate">-</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-3 bg-soft-success rounded">
                                    <i class="feather-edit fs-4 text-success me-3"></i>
                                    <div>
                                        <small class="text-muted d-block">آخر تحديث</small>
                                        <strong id="updatedDate">-</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publishing Options -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-send me-2 text-primary"></i>
                            خيارات النشر
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsPublished" class="form-check-input" type="checkbox" id="publishSwitch">
                                <label class="form-check-label" for="publishSwitch">
                                    <strong>منشور</strong>
                                    <p class="text-muted small mb-0">الإعلان مرئي للطلاب</p>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsPinned" class="form-check-input" type="checkbox" id="pinnedSwitch">
                                <label class="form-check-label" for="pinnedSwitch">
                                    <strong>مثبت</strong>
                                    <p class="text-muted small mb-0">يظهر في أعلى قائمة الإعلانات</p>
                                </label>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h6 class="mb-3">
                            <i class="feather-bell me-2"></i>
                            الإشعارات
                        </h6>

                        <div class="alert alert-light-warning border-0">
                            <div class="d-flex">
                                <i class="feather-alert-circle fs-5 me-2"></i>
                                <div>
                                    <small class="d-block mb-1"><strong>ملاحظة:</strong></small>
                                    <small>لا يمكن إعادة إرسال الإشعارات للإعلانات المنشورة سابقاً</small>
                                </div>
                            </div>
                        </div>

                        @if (!Model.IsPublished)
                        {
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="SendEmail" class="form-check-input" type="checkbox" id="emailSwitch">
                                    <label class="form-check-label" for="emailSwitch">
                                        <strong>إرسال بريد إلكتروني</strong>
                                        <p class="text-muted small mb-0">عند نشر الإعلان</p>
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="SendPushNotification" class="form-check-input" type="checkbox" id="pushSwitch">
                                    <label class="form-check-label" for="pushSwitch">
                                        <strong>إشعار فوري</strong>
                                        <p class="text-muted small mb-0">عند نشر الإعلان</p>
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Preview Card -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-eye me-2 text-primary"></i>
                            معاينة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="announcement-preview border rounded p-3">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-text avatar-sm bg-soft-primary text-primary me-2">
                                    <i class="feather-bell"></i>
                                </div>
                                <div class="flex-1">
                                    <h6 class="mb-0" id="previewTitle">@Model.Title</h6>
                                    <small class="text-muted">محدّث</small>
                                </div>
                            </div>
                            <div id="previewContent" class="text-muted">
                                <!-- Content rendered via marked.js in script below -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="feather-save me-2"></i>
                            حفظ التعديلات
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-light w-100 mb-2">
                            <i class="feather-x me-2"></i>
                            إلغاء
                        </a>
                        
                        <hr class="my-3">
                        
                        <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="feather-trash-2 me-2"></i>
                            حذف الإعلان
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-alert-triangle text-danger me-2"></i>
                    تأكيد الحذف
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">هل أنت متأكد من حذف هذا الإعلان؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="feather-trash-2 me-2"></i>
                        حذف نهائي
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        // Live preview
        const titleInput = document.getElementById('Title');
        const contentInput = document.getElementById('Content');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');

        function updatePreview() {
            if (titleInput.value) {
                previewTitle.textContent = titleInput.value;
            } else {
                previewTitle.textContent = 'عنوان الإعلان';
            }

            if (contentInput.value) {
                previewContent.innerHTML = marked.parse(contentInput.value);
            } else {
                previewContent.textContent = 'محتوى الإعلان سيظهر هنا...';
            }
        }

        titleInput?.addEventListener('input', updatePreview);
        contentInput?.addEventListener('input', updatePreview);

        // Form validation
        document.getElementById('announcementForm').addEventListener('submit', function(e) {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || title.length < 5) {
                e.preventDefault();
                alert('يرجى إدخال عنوان صحيح (5 أحرف على الأقل)');
                return false;
            }

            if (!content || content.length < 10) {
                e.preventDefault();
                alert('يرجى إدخال محتوى صحيح (10 أحرف على الأقل)');
                return false;
            }

            return true;
        });

        // Priority badge colors
        const prioritySelect = document.getElementById('Priority');
        prioritySelect?.addEventListener('change', function() {
            const preview = document.querySelector('.announcement-preview');
            preview.classList.remove('border-primary', 'border-warning', 'border-danger');
            
            switch(this.value) {
                case '@LMS.Domain.Enums.AnnouncementPriority.High':
                    preview.classList.add('border-warning');
                    break;
                case '@LMS.Domain.Enums.AnnouncementPriority.Urgent':
                    preview.classList.add('border-danger');
                    break;
                default:
                    preview.classList.add('border-primary');
            }
        });

        // Format dates
        const createdDate = '@ViewBag.CreatedAt';
        const updatedDate = '@ViewBag.UpdatedAt';
        
        if (createdDate) {
            document.getElementById('createdDate').textContent = new Date(createdDate).toLocaleDateString('ar-SA', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }
        
        if (updatedDate) {
            document.getElementById('updatedDate').textContent = new Date(updatedDate).toLocaleDateString('ar-SA', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        // Initialize
        updatePreview();
    </script>
    
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

