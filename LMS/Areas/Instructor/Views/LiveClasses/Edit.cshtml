@model LMS.Areas.Instructor.ViewModels.LiveClassEditViewModel
@inject IPlatformSettingsService PlatformSettings

@{
    ViewData["Title"] = Html.T("تعديل البث المباشر", "Edit Live Session");
    ViewData["Subtitle"] = Model.Title;
    var detailsUrl = Url.Action("Details", new { id = Model.Id });
    var indexUrl = Url.Action("Index");
    
    // Load platform settings
    var minDuration = await PlatformSettings.GetIntSettingAsync("LiveClass.DurationMinutes.Min", 15);
    var maxDuration = await PlatformSettings.GetIntSettingAsync("LiveClass.DurationMinutes.Max", 480);
    var reminderOptions = await PlatformSettings.GetSettingAsync("LiveClass.ReminderOptions", "5,10,15,30,60,120,1440");
}

<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-4">
    <div>
        <h4 class="mb-1">@ViewData["Title"]</h4>
        <p class="text-muted mb-0">@ViewData["Subtitle"]</p>
    </div>
    <div class="d-flex gap-2">
        <a href="@detailsUrl" class="btn btn-light">
            <i class="feather-eye me-2"></i>
            @Html.T("عرض التفاصيل", "View Details")
        </a>
        <a href="@indexUrl" class="btn btn-light">
            <i class="feather-arrow-right me-2"></i>
            @Html.T("العودة للقائمة", "Back to List")
        </a>
    </div>
</div>

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("المعلومات الأساسية", "Basic Information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="CourseId">@Html.T("الدورة", "Course") <span class="text-danger">*</span></label>
                                <select asp-for="CourseId" class="form-select" required>
                                    <option value="">-- @Html.T("اختر الدورة", "Select Course") --</option>
                                    @if (ViewBag.Courses != null)
                                    {
                                        foreach (var course in ViewBag.Courses as Microsoft.AspNetCore.Mvc.Rendering.SelectList)
                                        {
                                            <option value="@course.Value" selected="@(course.Selected)">@course.Text</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CourseId" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Title">@Html.T("عنوان الجلسة", "Session Title") <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="Title" required />
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Description">@Html.T("الوصف", "Description")</label>
                                <textarea class="form-control" asp-for="Description" rows="4"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Agenda">@Html.T("جدول الأعمال", "Agenda")</label>
                                <textarea class="form-control" asp-for="Agenda" rows="5"></textarea>
                                <span asp-validation-for="Agenda" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الجدولة", "Schedule")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label" asp-for="ScheduledStartTime">@Html.T("تاريخ ووقت البدء", "Start Date & Time") <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" asp-for="ScheduledStartTime" required />
                                <span asp-validation-for="ScheduledStartTime" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="ScheduledEndTime">@Html.T("تاريخ ووقت الانتهاء", "End Date & Time") <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" asp-for="ScheduledEndTime" required />
                                <span asp-validation-for="ScheduledEndTime" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="DurationMinutes">@Html.T("المدة (بالدقائق)", "Duration (minutes)") <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" asp-for="DurationMinutes" min="15" max="480" required />
                                <span asp-validation-for="DurationMinutes" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="MaxParticipants">@Html.T("الحد الأقصى للمشاركين", "Max Participants")</label>
                                <input type="number" class="form-control" asp-for="MaxParticipants" min="1" />
                                <span asp-validation-for="MaxParticipants" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meeting Details -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("معلومات الاجتماع", "Meeting Information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="Platform">@Html.T("المنصة", "Platform") <span class="text-danger">*</span></label>
                                <select class="form-select" asp-for="Platform" required>
                                    <option value="Zoom">Zoom</option>
                                    <option value="GoogleMeet">Google Meet</option>
                                    <option value="MicrosoftTeams">Microsoft Teams</option>
                                    <option value="Webex">Webex</option>
                                    <option value="Other">@Html.T("أخرى", "Other")</option>
                                </select>
                                <span asp-validation-for="Platform" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="MeetingUrl">@Html.T("رابط الاجتماع", "Meeting URL") <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" asp-for="MeetingUrl" required />
                                <span asp-validation-for="MeetingUrl" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="MeetingId">@Html.T("معرف الاجتماع", "Meeting ID")</label>
                                <input type="text" class="form-control" asp-for="MeetingId" />
                                <span asp-validation-for="MeetingId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="Password">@Html.T("كلمة المرور", "Password")</label>
                                <input type="text" class="form-control" asp-for="Password" />
                                <span asp-validation-for="Password" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الحالة", "Status")</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-@(Model.Status == LMS.Domain.Enums.LiveClassStatus.Scheduled ? "warning" : 
                            Model.Status == LMS.Domain.Enums.LiveClassStatus.Live ? "danger" : 
                            Model.Status == LMS.Domain.Enums.LiveClassStatus.Completed ? "success" : "secondary") border-0 mb-0">
                            <i class="feather-info me-2"></i>
                            @Html.T("الحالة الحالية:", "Current Status:") <strong>
                                @switch (Model.Status)
                                {
                                    case LMS.Domain.Enums.LiveClassStatus.Scheduled:
                                        @Html.T("مجدولة", "Scheduled")
                                        break;
                                    case LMS.Domain.Enums.LiveClassStatus.Live:
                                        @Html.T("مباشرة الآن", "Live Now")
                                        break;
                                    case LMS.Domain.Enums.LiveClassStatus.Completed:
                                        @Html.T("مكتملة", "Completed")
                                        break;
                                    case LMS.Domain.Enums.LiveClassStatus.Cancelled:
                                        @Html.T("ملغية", "Cancelled")
                                        break;
                                }
                            </strong>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الإعدادات", "Settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" asp-for="AllowReplay" id="allowReplay" />
                            <label class="form-check-label" for="allowReplay">
                                @Html.T("السماح بإعادة المشاهدة", "Allow Replay")
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" asp-for="IsFreeForAll" id="isFreeForAll" />
                            <label class="form-check-label" for="isFreeForAll">
                                @Html.T("متاح للجميع", "Available for All")
                            </label>
                        </div>

                        <hr />

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" asp-for="SendReminder" id="sendReminder" />
                            <label class="form-check-label" for="sendReminder">
                                @Html.T("إرسال تذكير للطلاب", "Send Reminder to Students")
                            </label>
                        </div>

                        <div class="reminder-settings" style="@(Model.SendReminder ? "" : "display:none;")">
                            <label class="form-label" asp-for="ReminderMinutesBefore">@Html.T("التذكير قبل (دقائق)", "Remind Before (minutes)")</label>
                            <select class="form-select" asp-for="ReminderMinutesBefore">
                                @foreach (var option in reminderOptions.Split(','))
                                {
                                    var minutes = int.Parse(option.Trim());
                                    var label = minutes < 60 ? $"{minutes} {Html.T("دقيقة", "minutes")}" : 
                                               minutes == 60 ? Html.T("ساعة واحدة", "One hour") : 
                                               minutes == 120 ? Html.T("ساعتين", "Two hours") : 
                                               minutes >= 1440 ? Html.T("يوم واحد", "One day") : $"{minutes/60} {Html.T("ساعات", "hours")}";
                                    <option value="@minutes">@label</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Warning Card -->
                @if (Model.Status == LMS.Domain.Enums.LiveClassStatus.Live)
                {
                    <div class="card bg-soft-danger border-0 mb-4">
                        <div class="card-body">
                            <h6 class="fw-bold mb-2 text-danger">
                                <i class="feather-alert-triangle me-2"></i>
                                @Html.T("تحذير", "Warning")
                            </h6>
                            <p class="fs-13 mb-0">
                                @Html.T("الجلسة مباشرة الآن. يرجى توخي الحذر عند التعديل.", "The session is currently live. Please be careful when editing.")
                            </p>
                        </div>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="feather-save me-2"></i>
                            @Html.T("حفظ التعديلات", "Save Changes")
                        </button>
                        <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-light w-100">
                            <i class="feather-x me-2"></i>
                            @Html.T("إلغاء", "Cancel")
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Toggle reminder settings
            $('#sendReminder').change(function() {
                $('.reminder-settings').toggle(this.checked);
            });

            // Calculate end time when start time or duration changes
            $('#ScheduledStartTime, #DurationMinutes').change(function() {
                var startTime = new Date($('#ScheduledStartTime').val());
                var duration = parseInt($('#DurationMinutes').val());
                
                if (startTime && duration) {
                    var endTime = new Date(startTime.getTime() + duration * 60000);
                    var endTimeStr = endTime.toISOString().slice(0, 16);
                    $('#ScheduledEndTime').val(endTimeStr);
                }
            });
        });
    </script>
}
