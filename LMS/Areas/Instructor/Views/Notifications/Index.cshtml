@using LMS.Services.Interfaces
@using LMS.Helpers
@using System.Globalization
@model PaginatedResult<LMS.Domain.Entities.Notifications.Notification>

@{
    ViewData["Title"] = Html.T("الإشعارات", "Notifications");
    ViewData["Subtitle"] = Html.T("عرض وإدارة جميع الإشعارات", "View and manage all notifications");
    var currentCulture = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;

    var stats = ViewBag.Stats as NotificationStatsDto ?? new NotificationStatsDto();
    var filter = ViewBag.Filter as NotificationFilterDto ?? new NotificationFilterDto();
    var unreadOnly = ViewBag.UnreadOnly as bool? ?? false;
    var currentType = ViewBag.Type as LMS.Domain.Enums.NotificationType?;
    var search = ViewBag.Search as string;
    var page = ViewBag.Page as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 0;
}

@{
    var indexUrl = Url.Action("Index");
    var unreadUrl = Url.Action("Index", new { unreadOnly = true });
    var actionButtonsHtml = "";

    if (stats.UnreadCount > 0)
    {
        actionButtonsHtml += "<form action='" + Url.Action("MarkAllAsRead") + "' method='post' style='display:inline;'>" +
            Html.AntiForgeryToken().ToHtmlString() +
            "<button type='submit' class='btn btn-success'>" +
            "<i class='feather-check-circle me-2'></i>" +
            Html.T("تحديد الكل كمقروء", "Mark all as read") +
            "</button>" +
            "</form>";
    }

    actionButtonsHtml += "<div class='dropdown ms-2'>" +
        "<button class='btn btn-light dropdown-toggle' type='button' data-bs-toggle='dropdown'>" +
        "<i class='feather-filter me-2'></i>" + Html.T("تصفية", "Filter") +
        "</button>" +
        "<ul class='dropdown-menu dropdown-menu-end'>" +
        "<li><a class='dropdown-item " + (!unreadOnly && currentType == null ? "active" : "") + "' href='" + indexUrl + "'>" + Html.T("جميع الإشعارات", "All notifications") + "</a></li>" +
        "<li><a class='dropdown-item " + (unreadOnly ? "active" : "") + "' href='" + unreadUrl + "'>" + Html.T("غير المقروءة فقط", "Unread only") + "</a></li>" +
        "<li><hr class='dropdown-divider'></li>";

    foreach (var typeInfo in NotificationHelper.GetFilterableTypes(currentCulture))
    {
        var isActive = currentType == typeInfo.Type;
        var typeUrl = Url.Action("Index", new { type = typeInfo.Type });
        actionButtonsHtml += $"<li><a class='dropdown-item {(isActive ? "active" : "")}' href='{typeUrl}'>{typeInfo.Label}</a></li>";
    }

    actionButtonsHtml += "</ul></div>";
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw(actionButtonsHtml) }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي الإشعارات", "Total notifications") },
                { "Value", stats.TotalCount },
                { "Icon", "bell" },
                { "Color", "primary" }
            })
        </div>
        <div class="col-md-6 col-lg-3">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("غير مقروءة", "Unread") },
                { "Value", stats.UnreadCount },
                { "Icon", "bell" },
                { "Color", stats.UnreadCount > 0 ? "danger" : "success" }
            })
        </div>
        <div class="col-md-6 col-lg-3">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("مقروءة", "Read") },
                { "Value", stats.ReadCount },
                { "Icon", "check-circle" },
                { "Color", "success" }
            })
        </div>
        <div class="col-md-6 col-lg-3">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("مهمة", "Important") },
                { "Value", stats.HighPriorityCount },
                { "Icon", "alert-triangle" },
                { "Color", stats.HighPriorityCount > 0 ? "warning" : "info" }
            })
        </div>
    </div>

    <div class="alert alert-light border mb-4 d-flex align-items-center justify-content-between flex-wrap gap-2" role="region" aria-label="@Html.T("إشعارات الجوال", "Mobile notifications")" id="lms-push-promo">
        <span class="text-muted">@Html.T("تفعيل إشعارات الجوال لتلقي الإشعارات حتى عند إغلاق التبويب", "Enable mobile notifications to receive alerts even when the tab is closed")</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="lms-instructor-enable-push">
            <i class="feather-bell me-1"></i>@Html.T("تفعيل إشعارات الجوال", "Enable mobile notifications")
        </button>
    </div>

    <!-- Search and Filter Bar -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <form asp-action="Index" method="get" class="row g-3 align-items-center">
                <div class="col-lg-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="feather-search text-muted"></i>
                        </span>
                        <input type="text" name="search" class="form-control border-start-0" 
                               placeholder="@Html.T("البحث في الإشعارات...", "Search notifications...")" value="@search">
                    </div>
                </div>
                <div class="col-lg-3">
                    <select name="type" class="form-select">
                        <option value="">@Html.T("جميع الأنواع", "All types")</option>
                        @foreach (var typeInfo in NotificationHelper.GetFilterableTypes(currentCulture))
                        {
                            <option value="@((int)typeInfo.Type)" selected="@(currentType == typeInfo.Type)">@typeInfo.Label</option>
                        }
                    </select>
                </div>
                <div class="col-lg-3">
                    <select name="priority" class="form-select">
                        <option value="">@Html.T("جميع الأولويات", "All priorities")</option>
                        <option value="5">@Html.T("عاجل", "Urgent")</option>
                        <option value="4">@Html.T("مهم", "Important")</option>
                        <option value="3">@Html.T("عادي", "Normal")</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="feather-search me-1"></i> @Html.T("بحث", "Search")
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary" title="@Html.T("إعادة تعيين", "Reset")">
                            <i class="feather-x"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="card stretch stretch-full">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center w-100">
                <h5 class="card-title mb-0">
                    <i class="feather-bell me-2 text-primary"></i>
                    @if (unreadOnly)
                    {
                        <span>@Html.T("الإشعارات غير المقروءة", "Unread notifications")</span>
                    }
                    else if (currentType.HasValue)
                    {
                        <span>@Html.T("إشعارات", "Notifications") @NotificationHelper.GetLabel(currentType.Value, currentCulture)</span>
                    }
                    else
                    {
                        <span>@Html.T("جميع الإشعارات", "All notifications")</span>
                    }
                    <span class="badge bg-soft-primary text-primary ms-2">@Model.TotalCount</span>
                </h5>
                @if (Model.Items.Any(n => n.IsRead))
                {
                    <form asp-action="DeleteAllRead" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                onclick="return confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف جميع الإشعارات المقروءة؟", "Are you sure you want to delete all read notifications?").Replace("'", "\\'"))')">
                            <i class="feather-trash-2 me-1"></i>
@Html.T("حذف المقروءة", "Delete read")
                                        </button>
                    </form>
                }
            </div>
        </div>
        <div class="card-body p-0">
            @if (Model.Items.Any())
            {
                <div class="list-group list-group-flush" id="notifications-list">
                    @{
                        var groupedNotifications = Model.Items
                            .GroupBy(n => NotificationHelper.GetDateGroup(n.CreatedAt, currentCulture))
                            .OrderBy(g => g.Min(n => n.CreatedAt));
                    }

                    @foreach (var group in groupedNotifications)
                    {
                        <div class="list-group-item bg-light py-2 px-4">
                            <small class="fw-semibold text-muted">@group.Key</small>
                        </div>

                        @foreach (var notification in group)
                        {
                            var isUnread = !notification.IsRead;
                            var timeAgo = NotificationHelper.GetTimeAgo(notification.CreatedAt, currentCulture);
                            var (iconClass, iconColor, typeLabel) = NotificationHelper.GetTypeInfo(notification.Type, currentCulture);
                            var priorityColor = NotificationHelper.GetPriorityColor(notification.Priority);
                            var isImportant = NotificationHelper.IsImportant(notification.Type, notification.Priority);
                            
                            <div class="list-group-item notification-item @(isUnread ? "bg-soft-primary" : "") @(isImportant ? "border-start border-4 border-" + priorityColor : "")"
                                 data-notification-id="@notification.Id">
                                <div class="d-flex align-items-start gap-3 flex-wrap">
                                    <!-- Icon -->
                                    <div class="avatar-text avatar-md bg-soft-@iconColor text-@iconColor flex-shrink-0">
                                        <i class="@iconClass"></i>
                                    </div>
                                    
                                    <!-- Content -->
                                    <div class="flex-grow-1 min-width-0">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <div class="flex-grow-1 min-width-0">
                                                <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                                                    @if (isUnread)
                                                    {
                                                        <span class="badge bg-danger" style="font-size: 9px;">@Html.T("جديد", "New")</span>
                                                    }
                                                    @if (notification.Priority >= 4)
                                                    {
                                                        <span class="badge bg-@priorityColor" style="font-size: 9px;">
                                                            @NotificationHelper.GetPriorityLabel(notification.Priority, currentCulture)
                                                        </span>
                                                    }
                                                    <span class="badge bg-soft-@iconColor text-@iconColor" style="font-size: 9px;">
                                                        @typeLabel
                                                    </span>
                                                </div>
                                                <h6 class="fw-bold mb-1 @(isUnread ? "" : "text-muted") text-truncate">
                                                    @notification.Title
                                                </h6>
                                                <p class="text-muted mb-0 fs-13 text-truncate-2">@notification.Message</p>
                                            </div>
                                            <div class="text-end flex-shrink-0 ms-3">
                                                <small class="text-muted d-block">@timeAgo</small>
                                                <small class="text-muted d-block">@notification.CreatedAt.ToString("HH:mm")</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div class="d-flex gap-2 mt-2">
                                            @if (!string.IsNullOrEmpty(notification.ActionUrl))
                                            {
                                                <form asp-action="MarkAsRead" asp-route-id="@notification.Id" method="post" style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="feather-external-link me-1"></i>
                                                        @(notification.ActionText ?? Html.T("عرض", "View"))
                                                    </button>
                                                </form>
                                            }
                                            else if (isUnread)
                                            {
                                                <form asp-action="MarkAsRead" asp-route-id="@notification.Id" method="post" style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm btn-outline-success">
                                                        <i class="feather-check me-1"></i>
                                                        @Html.T("تحديد كمقروء", "Mark as read")
                                                    </button>
                                                </form>
                                            }
                                            
                                            <form asp-action="Delete" asp-route-id="@notification.Id" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        onclick="return confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذا الإشعار؟", "Are you sure you want to delete this notification?").Replace("'", "\\'"))')">
                                                    <i class="feather-trash-2"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="@Html.T("تنقل الصفحات", "Page navigation")">
                            <ul class="pagination justify-content-center mb-0">
                                @if (page > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { page = page - 1, unreadOnly = unreadOnly, type = currentType, search = search })">
                                            <i class="feather-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                                
                                @for (int i = Math.Max(1, page - 2); i <= Math.Min(totalPages, page + 2); i++)
                                {
                                    <li class="page-item @(i == page ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("Index", new { page = i, unreadOnly = unreadOnly, type = currentType, search = search })">@i</a>
                                    </li>
                                }
                                
                                @if (page < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { page = page + 1, unreadOnly = unreadOnly, type = currentType, search = search })">
                                            <i class="feather-chevron-left"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                @(string.Format(Html.T("عرض {0} - {1} من {2} إشعار", "Showing {0} - {1} of {2} notifications"), (page - 1) * 20 + 1, Math.Min(page * 20, Model.TotalCount), Model.TotalCount))
                            </small>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="p-5 text-center">
                    <div class="avatar-text avatar-xl bg-soft-secondary text-secondary mb-4 mx-auto">
                        <i class="feather-bell-off"></i>
                    </div>
                    <h5 class="fw-bold mb-2">
                        @if (unreadOnly)
                        {
                            <span>@Html.T("لا توجد إشعارات غير مقروءة", "No unread notifications")</span>
                        }
                        else if (!string.IsNullOrEmpty(search))
                        {
                            <span>@Html.T("لا توجد نتائج للبحث", "No results for search") "@search"</span>
                        }
                        else
                        {
                            <span>@Html.T("لا توجد إشعارات", "No notifications")</span>
                        }
                    </h5>
                    <p class="text-muted mb-4">@Html.T("ستظهر هنا الإشعارات الجديدة عند وصولها", "New notifications will appear here when they arrive")</p>
                    @if (unreadOnly || !string.IsNullOrEmpty(search) || currentType.HasValue)
                    {
                        <a href="@Url.Action("Index")" class="btn btn-outline-primary">
                            <i class="feather-list me-2"></i>
                            @Html.T("عرض جميع الإشعارات", "View all notifications")
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

<style>
    .notification-item {
        transition: all 0.2s ease;
    }
    
    .notification-item:hover {
        background-color: #f8f9fa !important;
    }
    
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .min-width-0 {
        min-width: 0;
    }
    
    .border-orange {
        border-color: #f97316 !important;
    }
    
    .bg-soft-orange {
        background-color: rgba(249, 115, 22, 0.1) !important;
    }
    
    .text-orange {
        color: #f97316 !important;
    }
    
    .border-teal {
        border-color: #14b8a6 !important;
    }
    
    .bg-soft-teal {
        background-color: rgba(20, 184, 166, 0.1) !important;
    }
    
    .text-teal {
        color: #14b8a6 !important;
    }
    
    .border-cyan {
        border-color: #06b6d4 !important;
    }
    
    .bg-soft-cyan {
        background-color: rgba(6, 182, 212, 0.1) !important;
    }
    
    .text-cyan {
        color: #06b6d4 !important;
    }
    
    .border-purple {
        border-color: #8b5cf6 !important;
    }
    
    .bg-soft-purple {
        background-color: rgba(139, 92, 246, 0.1) !important;
    }
    
    .text-purple {
        color: #8b5cf6 !important;
    }
</style>

@section Scripts {
    <!-- SignalR and notification-hub.js are loaded in _Layout.cshtml -->
    <!-- Page-specific initialization (if any) -->
}
