@model LMS.Domain.Entities.Courses.ContentDripRule

@{
    ViewData["Title"] = Html.T("تفاصيل قاعدة الجدولة", "Scheduling Rule Details");
    ViewData["Subtitle"] = Html.T("معلومات قاعدة جدولة المحتوى", "Content scheduling rule details");
    var editUrl = Url.Action("Edit", new { id = Model.Id });
    var indexUrl = Url.Action("Index");
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw("<a href='" + editUrl + "' class='btn btn-primary'><i class='feather-edit me-2'></i>" + Html.T("تعديل", "Edit") + "</a><a href='" + indexUrl + "' class='btn btn-light'><i class='feather-arrow-right me-2'></i>" + Html.T("العودة للقائمة", "Back to list") + "</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Status Alert -->
    @if (!Model.IsActive)
    {
        <div class="alert alert-warning mb-4">
            <div class="d-flex align-items-center">
                <i class="feather-alert-triangle fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">@Html.T("القاعدة غير نشطة", "Rule is inactive")</h6>
                    <p class="mb-0">@Html.T("هذه قاعدة الجدولة معطلة حالياً ولا تطبق على المحتوى.", "This scheduling rule is currently disabled and does not apply to content.")</p>
                </div>
            </div>
        </div>
    }

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Rule Details -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2 text-primary"></i>
                        معلومات القاعدة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <label class="text-muted small mb-2">الدورة</label>
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-text avatar-lg bg-soft-primary text-primary">
                                    <i class="feather-book"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-0">@Model.Course?.Title</h5>
                                </div>
                            </div>
                        </div>

                        @if (Model.Module != null)
                        {
                            <div class="col-md-6">
                                <label class="text-muted small mb-2">الوحدة</label>
                                <p class="mb-0">
                                    <i class="feather-folder text-muted me-2"></i>
                                    @Model.Module.Title
                                </p>
                            </div>
                        }

                        @if (Model.Lesson != null)
                        {
                            <div class="col-md-6">
                                <label class="text-muted small mb-2">الدرس</label>
                                <p class="mb-0">
                                    <i class="feather-file-text text-muted me-2"></i>
                                    @Model.Lesson.Title
                                </p>
                            </div>
                        }

                        @if (Model.Module == null && Model.Lesson == null)
                        {
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="feather-info me-2"></i>
                                    هذه القاعدة تطبق على الدورة بالكامل
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Drip Configuration -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-clock me-2 text-primary"></i>
                        إعدادات الجدولة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="text-muted small mb-2">نوع الجدولة</label>
                            <div>
                                @switch (Model.DripType)
                                {
                                    case LMS.Domain.Enums.ContentDripType.AllAtOnce:
                                        <span class="badge bg-soft-success text-success fs-6">
                                            <i class="feather-zap"></i> كل المحتوى فوراً
                                        </span>
                                        break;
                                    case LMS.Domain.Enums.ContentDripType.DaysAfterEnrollment:
                                        <span class="badge bg-soft-primary text-primary fs-6">
                                            <i class="feather-calendar"></i> بعد أيام من التسجيل
                                        </span>
                                        break;
                                    case LMS.Domain.Enums.ContentDripType.SpecificDate:
                                        <span class="badge bg-soft-info text-info fs-6">
                                            <i class="feather-clock"></i> تاريخ محدد
                                        </span>
                                        break;
                                    case LMS.Domain.Enums.ContentDripType.Weekly:
                                        <span class="badge bg-soft-warning text-warning fs-6">
                                            <i class="feather-repeat"></i> أسبوعياً
                                        </span>
                                        break;
                                    case LMS.Domain.Enums.ContentDripType.Monthly:
                                        <span class="badge bg-soft-danger text-danger fs-6">
                                            <i class="feather-calendar"></i> شهرياً
                                        </span>
                                        break;
                                }
                            </div>
                        </div>

                        @if (Model.DaysAfterEnrollment.HasValue)
                        {
                            <div class="col-md-6">
                                <label class="text-muted small mb-2">عدد الأيام</label>
                                <h4 class="fw-bold text-primary mb-0">@Model.DaysAfterEnrollment يوم</h4>
                            </div>
                        }

                        @if (Model.SpecificDate.HasValue)
                        {
                            <div class="col-md-6">
                                <label class="text-muted small mb-2">التاريخ المحدد</label>
                                <p class="mb-0">
                                    <i class="feather-calendar text-muted me-2"></i>
                                    @Model.SpecificDate.Value.ToString("dd/MM/yyyy hh:mm tt")
                                </p>
                            </div>
                        }

                        @if (Model.DayOfWeek.HasValue)
                        {
                            var arabicDayNames = new Dictionary<int, string> {
                                {0, "الأحد"}, {1, "الإثنين"}, {2, "الثلاثاء"},
                                {3, "الأربعاء"}, {4, "الخميس"}, {5, "الجمعة"}, {6, "السبت"}
                            };
                            <div class="col-md-6">
                                <label class="text-muted small mb-2">يوم الأسبوع</label>
                                <p class="mb-0">
                                    <i class="feather-calendar text-muted me-2"></i>
                                    @(arabicDayNames.ContainsKey(Model.DayOfWeek.Value) ? arabicDayNames[Model.DayOfWeek.Value] : "غير محدد")
                                </p>
                            </div>
                        }

                        <div class="col-md-6">
                            <label class="text-muted small mb-2">ساعة الإطلاق</label>
                            <p class="mb-0">
                                <i class="feather-clock text-muted me-2"></i>
                                @Model.ReleaseHour:00
                            </p>
                        </div>

                        <div class="col-md-6">
                            <label class="text-muted small mb-2">المنطقة الزمنية</label>
                            <p class="mb-0">
                                <i class="feather-globe text-muted me-2"></i>
                                @(Model.TimeZone ?? "Africa/Cairo")
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            @if (Model.SendNotification)
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-bell me-2 text-primary"></i>
                            إعدادات الإشعارات
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-4">
                            <i class="feather-check-circle me-2"></i>
                            الإشعارات مفعّلة - سيتم إرسال إشعار للطلاب عند إطلاق المحتوى
                        </div>

                        @if (!string.IsNullOrEmpty(Model.NotificationTitle))
                        {
                            <div class="mb-4">
                                <label class="text-muted small mb-2">عنوان الإشعار</label>
                                <p class="fw-bold mb-0">@Model.NotificationTitle</p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(Model.NotificationMessage))
                        {
                            <div>
                                <label class="text-muted small mb-2">رسالة الإشعار</label>
                                <div class="alert alert-light mb-0">
                                    @Model.NotificationMessage
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-body">
                        <div class="alert alert-secondary mb-0">
                            <i class="feather-bell-off me-2"></i>
                            الإشعارات معطلة - لن يتم إرسال إشعارات للطلاب
                        </div>
                    </div>
                </div>
            }

            <!-- Timeline Preview -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-trending-up me-2 text-primary"></i>
                        جدول الإطلاق الزمني
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.DripType == LMS.Domain.Enums.ContentDripType.AllAtOnce)
                    {
                        <div class="alert alert-success">
                            <i class="feather-zap me-2"></i>
                            <strong>فوري:</strong> سيكون المحتوى متاحاً فور تسجيل الطالب
                        </div>
                    }
                    else if (Model.DripType == LMS.Domain.Enums.ContentDripType.DaysAfterEnrollment && Model.DaysAfterEnrollment.HasValue)
                    {
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <p class="mb-1"><strong>اليوم 0:</strong> تسجيل الطالب</p>
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <p class="mb-1"><strong>اليوم @Model.DaysAfterEnrollment:</strong> إطلاق المحتوى</p>
                                </div>
                            </div>
                        </div>
                    }
                    else if (Model.DripType == LMS.Domain.Enums.ContentDripType.SpecificDate && Model.SpecificDate.HasValue)
                    {
                        var daysUntil = (Model.SpecificDate.Value - DateTime.UtcNow).Days;
                        <div class="alert @(daysUntil > 0 ? "alert-info" : "alert-warning")">
                            <i class="feather-calendar me-2"></i>
                            @if (daysUntil > 0)
                            {
                                <text>سيتم إطلاق المحتوى بعد <strong>@daysUntil يوم</strong></text>
                            }
                            else
                            {
                                <text>تاريخ الإطلاق في الماضي</text>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("حالة القاعدة", "Rule status")</h5>
                </div>
                <div class="card-body text-center">
                    <div class="avatar-text avatar-xl @(Model.IsActive ? "bg-soft-success text-success" : "bg-soft-secondary text-secondary") mb-3 mx-auto">
                        <i class="feather-@(Model.IsActive ? "check-circle" : "pause-circle")"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@(Model.IsActive ? "نشطة" : "غير نشطة")</h5>
                    <p class="text-muted mb-0">
                        @if (Model.IsActive)
                        {
                            <text>القاعدة تعمل حالياً</text>
                        }
                        else
                        {
                            <text>القاعدة معطلة مؤقتاً</text>
                        }
                    </p>
                </div>
            </div>

            <!-- Affected Content -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("المحتوى المتأثر", "Affected content")</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <span class="text-muted">الدورة:</span>
                            <span class="fw-medium">@Model.Course?.Title</span>
                        </div>
                        @if (Model.Module != null)
                        {
                            <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                <span class="text-muted">الوحدة:</span>
                                <span class="fw-medium">@Model.Module.Title</span>
                            </div>
                        }
                        @if (Model.Lesson != null)
                        {
                            <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                <span class="text-muted">الدرس:</span>
                                <span class="fw-medium">@Model.Lesson.Title</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("الإجراءات", "Actions")</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-primary">
                            <i class="feather-edit me-2"></i>
                            @Html.T("تعديل القاعدة", "Edit rule")
                        </a>
                        
                        <form asp-action="ToggleActive" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-@(Model.IsActive ? "warning" : "success") w-100">
                                <i class="feather-power me-2"></i>
                                @(Model.IsActive ? Html.T("تعطيل", "Disable") : Html.T("تفعيل", "Enable")) @Html.T("القاعدة", "rule")
                            </button>
                        </form>

                        <hr />

                        <button class="btn btn-danger" onclick="confirmDelete('@Url.Action("Delete", new { id = Model.Id })', '@Html.Raw(Html.T("هل أنت متأكد من حذف قاعدة الجدولة؟", "Are you sure you want to delete this scheduling rule?").Replace("'", "\\'"))')">
                            <i class="feather-trash-2 me-2"></i>
                            @Html.T("حذف القاعدة", "Delete rule")
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card stretch stretch-full mb-4 bg-soft-info">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="feather-info me-2"></i>
                        @Html.T("معلومات إضافية", "Additional information")
                    </h6>
                    <small class="text-muted">
                        @Html.T("جدولة المحتوى تساعدك على التحكم في توقيت إطلاق المحتوى للطلاب، مما يسمح بتجربة تعلم منظمة ومتدرجة.", "Content scheduling helps you control when content is released to students, enabling an organized and progressive learning experience.")
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_DeleteModal")

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            position: relative;
            padding-right: 40px;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            right: 0;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px currentColor;
        }
        
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            right: 9px;
            top: 20px;
            bottom: -20px;
            width: 2px;
            background: #e5e7eb;
        }
    </style>
}

