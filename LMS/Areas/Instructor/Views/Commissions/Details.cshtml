@model LMS.Domain.Entities.Financial.InstructorEarning

@{
    ViewData["Title"] = Html.T("تفاصيل العمولة", "Commission Details");
    ViewData["Subtitle"] = Html.T("المعاملة", "Transaction") + " #" + Model.Id;
}

@{
    var indexUrl = Url.Action("Index");
    var actionButtonsHtml = "<a href='" + indexUrl + "' class='btn btn-light'>" +
        "<i class='feather-arrow-right me-2'></i>" +
        Html.T("العودة للقائمة", "Back to list") +
        "</a>" +
        "<button class='btn btn-primary' onclick='window.print()'>" +
            "<i class='feather-printer me-2'></i>" +
            Html.T("طباعة", "Print") +
        "</button>";
}
@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw(actionButtonsHtml) }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <div class="row">
        <!-- Main Content -->
        <div class="col-xxl-8 col-xl-7">
            <!-- Transaction Details -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تفاصيل المعاملة", "Transaction details")</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-4 bg-soft-primary rounded">
                                <div class="fs-12 text-muted mb-2">@Html.T("المبلغ الإجمالي", "Gross amount")</div>
                                <div class="fs-2 fw-bold text-primary">@Model.GrossAmount.ToEGP()</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-4 bg-soft-success rounded">
                                <div class="fs-12 text-muted mb-2">@Html.T("صافي ربحك", "Your net profit")</div>
                                <div class="fs-2 fw-bold text-success">@Model.NetAmount.ToEGP()</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-top">
                        <h6 class="fw-bold mb-3">@Html.T("تفاصيل الحساب", "Account details")</h6>
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <td class="text-muted">@Html.T("المبلغ الإجمالي", "Gross amount")</td>
                                    <td class="text-end fw-bold">@Model.GrossAmount.ToEGP()</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">@Html.T("عمولة المنصة", "Platform commission") (@Model.PlatformCommissionRate%)</td>
                                    <td class="text-end text-danger fw-medium">-@Model.PlatformCommission.ToEGP()</td>
                                </tr>
                                <tr class="border-top">
                                    <td class="fw-bold">@Html.T("صافي الربح", "Net profit")</td>
                                    <td class="text-end fw-bold text-success fs-5">@Model.NetAmount.ToEGP()</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Information -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات الدورة", "Course information")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="avatar-image avatar-xl">
                            <img src="@(Model.Course?.ThumbnailUrl ?? "/assets/images/general/placeholder.png")" alt="@Model.Course?.Title" class="img-fluid">
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">@Model.Course?.Title</h6>
                            <div class="fs-13 text-muted">@Model.Course?.Category?.Name</div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between p-3 bg-soft-light rounded">
                                <span class="text-muted">@Html.T("سعر الدورة", "Course price")</span>
                                <span class="fw-bold">@(Model.Course?.Price ?? 0).ToEGP()</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between p-3 bg-soft-light rounded">
                                <span class="text-muted">@Html.T("التقييم", "Rating")</span>
                                <span class="fw-bold">
                                    <i class="feather-star text-warning"></i>
                                    @(Model.Course?.AverageRating.ToString("F1") ?? "0.0")
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="@Url.Action("Details", "Courses", new { id = Model.CourseId })" class="btn btn-light-brand w-100">
                            <i class="feather-eye me-2"></i>
                            @Html.T("عرض تفاصيل الدورة", "View course details")
                        </a>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات الدفع", "Payment information")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("رقم المعاملة", "Transaction number")</span>
                        <span class="fw-medium">#@Model.PaymentId</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("طريقة الدفع", "Payment method")</span>
                        <span class="fw-medium">@Model.Payment?.PaymentMethod</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("حالة الدفع", "Payment status")</span>
                        <span class="badge bg-soft-success text-success">@Model.Payment?.Status</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">@Html.T("تاريخ الدفع", "Payment date")</span>
                        <span class="fw-medium">@Model.Payment?.PaidAt?.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="col-xxl-4 col-xl-5">
            <!-- Student Information -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات الطالب", "Student information")</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-text avatar-xl bg-soft-primary text-primary mb-3 mx-auto">
                            @(Model.Payment?.Student?.FullName?.Substring(0, 1) ?? "؟")
                        </div>
                        <h6 class="fw-bold mb-1">@Model.Payment?.Student?.FullName</h6>
                        <p class="text-muted fs-13 mb-0">@Model.Payment?.Student?.Email</p>
                    </div>

                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("رقم الهاتف", "Phone number")</span>
                        <span class="fw-medium">@Model.Payment?.Student?.PhoneNumber</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">@Html.T("تاريخ الانضمام", "Join date")</span>
                        <span class="fw-medium">@Model.Payment?.Student?.CreatedAt.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
            </div>

            <!-- Transaction Timeline -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("الجدول الزمني", "Timeline")</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="fw-bold">@Html.T("تم الدفع", "Paid")</div>
                                <div class="fs-11 text-muted">@Model.Payment?.PaidAt?.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <div class="fw-bold">@Html.T("تم احتساب العمولة", "Commission calculated")</div>
                                <div class="fs-11 text-muted">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <div class="fw-bold">@Html.T("الحالة", "Status")</div>
                                <div class="fs-11 text-muted">
                                    @if (Model.Status == "pending")
                                    {
                                        <span class="badge bg-soft-warning text-warning">@Html.T("قيد الانتظار", "Pending")</span>
                                    }
                                    else if (Model.Status == "available")
                                    {
                                        <span class="badge bg-soft-success text-success">@Html.T("متاح للسحب", "Available for withdrawal")</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-primary text-primary">@Html.T("تم السحب", "Withdrawn")</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Commission Breakdown -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تفصيل العمولة", "Commission breakdown")</h5>
                </div>
                <div class="card-body">
                    <canvas id="commissionChart" height="200"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar-text avatar-xs bg-success"></div>
                                <span class="fs-13">@Html.T("ربحك", "Your profit")</span>
                            </div>
                            <span class="fw-bold">@((Model.GrossAmount > 0 ? Model.NetAmount / Model.GrossAmount * 100 : 0).ToString("F0"))%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar-text avatar-xs bg-danger"></div>
                                <span class="fs-13">@Html.T("عمولة المنصة", "Platform commission")</span>
                            </div>
                            <span class="fw-bold">@Model.PlatformCommissionRate%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Commission Breakdown Chart
        const ctx = document.getElementById('commissionChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ربحك', 'عمولة المنصة'],
                datasets: [{
                    data: [@Model.NetAmount, @Model.PlatformCommission],
                    backgroundColor: ['#10b981', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
}

<style>
    .timeline {
        position: relative;
        padding-right: 20px;
    }
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
        padding-right: 30px;
    }
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 7px;
        top: 20px;
        width: 2px;
        height: calc(100% - 10px);
        background: #e5e7eb;
    }
    .timeline-marker {
        position: absolute;
        right: 0;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #e5e7eb;
    }
</style>

