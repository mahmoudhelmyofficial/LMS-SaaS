@model IEnumerable<LMS.Domain.Entities.Marketing.CourseBundle>
@inject IPlatformSettingsService PlatformSettings

@{
    ViewData["Title"] = Html.T("إدارة الباقات", "Bundles Management");
    ViewData["Subtitle"] = Html.T("عرض وإدارة باقات الدورات التعليمية", "View and manage course bundles");
    
    // Load platform settings
    var defaultPageSize = await PlatformSettings.GetIntSettingAsync("UI.PageSize.Default", 20);
}

<div class="page-header">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">@ViewData["Title"]</h5>
            <p class="fs-12 fw-medium text-muted mb-0">@ViewData["Subtitle"]</p>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">@Html.T("الرئيسية", "Home")</a></li>
            <li class="breadcrumb-item active">@Html.T("الباقات", "Bundles")</li>
        </ul>
    </div>
    <div class="page-header-right ms-auto">
        <div class="d-flex align-items-center gap-2">
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="feather-plus me-2"></i>
                @Html.T("إنشاء باقة جديدة", "Create new bundle")
            </a>
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="feather-filter me-2"></i>
                    @Html.T("تصفية", "Filter")
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="@Url.Action("Index")">@Html.T("جميع الباقات", "All bundles")</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("Index", new { isActive = true })">@Html.T("النشطة", "Active")</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("Index", new { isActive = false })">@Html.T("غير النشطة", "Inactive")</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي الباقات", "Total bundles") },
                { "Value", ViewBag.TotalBundles ?? 0 },
                { "Icon", "package" },
                { "Color", "primary" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("الباقات النشطة", "Active bundles") },
                { "Value", ViewBag.ActiveBundles ?? 0 },
                { "Icon", "check-circle" },
                { "Color", "success" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي المبيعات", "Total sales") },
                { "Value", ViewBag.TotalSales ?? 0 },
                { "Icon", "shopping-cart" },
                { "Color", "info" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي الإيرادات", "Total revenue") },
                { "Value", ((decimal)(ViewBag.TotalRevenue ?? 0m)).ToEGP() },
                { "Icon", "dollar-sign" },
                { "Color", "warning" }
            })
        </div>
    </div>

    <!-- Bundles List -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("قائمة الباقات", "Bundles list")</h5>
                    <div class="card-header-action">
                        <div class="card-header-btn">
                            <div data-bs-toggle="tooltip" title="@Html.T("تحديث", "Refresh")">
                                <a href="@Url.Action("Index")" class="avatar-text avatar-xs bg-warning">
                                    <i class="feather-refresh-cw"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body custom-card-action p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="d-md-none p-3">
                            @foreach (var bundle in Model)
                            {
                                <div class="card mb-3 border">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start gap-2">
                                            <img src="@(bundle.ThumbnailUrl ?? "/assets/images/general/placeholder.png")" alt="@bundle.Name" class="rounded flex-shrink-0" style="width: 56px; height: 56px; object-fit: cover;">
                                            <div class="min-w-0 flex-grow-1">
                                                <a href="@Url.Action("Details", new { id = bundle.Id })" class="fw-bold text-dark text-break">@bundle.Name</a>
                                                <p class="fs-12 text-muted mb-1">@bundle.CoursesCount @Html.T("دورات", "courses") · @bundle.Price.ToEGP()</p>
                                                <span class="badge @(bundle.IsActive ? "bg-soft-success text-success" : "bg-soft-secondary text-secondary")">@(bundle.IsActive ? Html.T("نشطة", "Active") : Html.T("غير نشطة", "Inactive"))</span>
                                            </div>
                                            <a href="@Url.Action("Details", new { id = bundle.Id })" class="btn btn-sm btn-outline-primary flex-shrink-0"><i class="feather-eye"></i></a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="d-none d-md-block">
                            <div class="table-responsive" style="-webkit-overflow-scrolling: touch; max-width: 100%;">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th class="wd-30">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                                </div>
                                            </th>
                                            <th>@Html.T("الباقة", "Bundle")</th>
                                        <th>@Html.T("عدد الدورات", "Courses count")</th>
                                        <th>@Html.T("السعر", "Price")</th>
                                        <th>@Html.T("التوفير", "Savings")</th>
                                        <th>@Html.T("المبيعات", "Sales")</th>
                                        <th>@Html.T("الحالة", "Status")</th>
                                        <th>@Html.T("الصلاحية", "Validity")</th>
                                        <th class="text-end">@Html.T("الإجراءات", "Actions")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var bundle in Model)
                                    {
                                        <tr>
                                            <td>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="@bundle.Id">
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="avatar-image avatar-lg">
                                                        <img src="@(bundle.ThumbnailUrl ?? "/assets/images/general/placeholder.png")" alt="@bundle.Name" class="img-fluid">
                                                    </div>
                                                    <div>
                                                        <a href="@Url.Action("Details", new { id = bundle.Id })" class="fw-bold text-dark">@bundle.Name</a>
                                                        <p class="fs-12 text-muted mb-0">@(bundle.ShortDescription != null && bundle.ShortDescription.Length > 50 ? bundle.ShortDescription.Substring(0, 50) + "..." : bundle.ShortDescription)</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="feather-book text-muted"></i>
                                                    <span class="fw-medium">@bundle.CoursesCount @Html.T("دورات", "courses")</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <span class="fw-bold text-success">@bundle.Price.ToEGP()</span>
                                                    @if (bundle.OriginalPrice > bundle.Price)
                                                    {
                                                        <br />
                                                        <span class="text-muted text-decoration-line-through fs-11">@bundle.OriginalPrice.ToEGP()</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-soft-success text-success">
                                                    <i class="feather-arrow-down"></i>
                                                    @bundle.SavingsPercentage.ToString("F0")%
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="feather-shopping-cart text-muted"></i>
                                                    <span class="fw-medium">@bundle.SalesCount</span>
                                                    @if (bundle.MaxSales.HasValue)
                                                    {
                                                        <span class="text-muted fs-11">/ @bundle.MaxSales</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                @if (bundle.IsActive)
                                                {
                                                    <span class="badge bg-soft-success text-success">@Html.T("نشطة", "Active")</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-soft-secondary text-secondary">@Html.T("غير نشطة", "Inactive")</span>
                                                }
                                                @if (bundle.IsFeatured)
                                                {
                                                    <br />
                                                    <span class="badge bg-soft-warning text-warning mt-1">@Html.T("مميزة", "Featured")</span>
                                                }
                                            </td>
                                            <td>
                                                @if (bundle.ValidFrom.HasValue && bundle.ValidTo.HasValue)
                                                {
                                                    <span class="fs-11 text-muted">
                                                        @bundle.ValidFrom.Value.ToString("dd/MM/yyyy")
                                                        <br />
                                                        @Html.T("إلى", "To") @bundle.ValidTo.Value.ToString("dd/MM/yyyy")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@Html.T("غير محدد", "Not set")</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="hstack gap-2 justify-content-end">
                                                    <a href="@Url.Action("Details", new { id = bundle.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("عرض", "View")">
                                                        <i class="feather-eye"></i>
                                                    </a>
                                                    <a href="@Url.Action("Edit", new { id = bundle.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("تعديل", "Edit")">
                                                        <i class="feather-edit"></i>
                                                    </a>
                                                    <a href="@Url.Action("Statistics", new { id = bundle.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("الإحصائيات", "Statistics")">
                                                        <i class="feather-bar-chart-2"></i>
                                                    </a>
                                                    <div class="dropdown">
                                                        <a href="javascript:void(0)" class="avatar-text avatar-md" data-bs-toggle="dropdown">
                                                            <i class="feather-more-horizontal"></i>
                                                        </a>
                                                        <ul class="dropdown-menu dropdown-menu-end">
                                                            <li>
                                                                <a class="dropdown-item" href="@Url.Action("Statistics", new { id = bundle.Id })">
                                                                    <i class="feather-bar-chart-2 me-3"></i>
                                                                    <span>@Html.T("الإحصائيات", "Statistics")</span>
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a class="dropdown-item" href="javascript:void(0)" onclick="duplicateBundle(@bundle.Id)">
                                                                    <i class="feather-copy me-3"></i>
                                                                    <span>@Html.T("نسخ الباقة", "Duplicate bundle")</span>
                                                                </a>
                                                            </li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li>
                                                                <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="confirmDelete('@Url.Action("Delete", new { id = bundle.Id })', '@Html.Raw((Html.T("هل أنت متأكد من حذف الباقة: ", "Are you sure you want to delete the bundle: ") + (bundle.Name ?? "").Replace("'", "\\'") + "؟").Replace("'", "\\'"))')">
                                                                    <i class="feather-trash-2 me-3"></i>
                                                                    <span>@Html.T("حذف", "Delete")</span>
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        </div>

                        <!-- Pagination -->
                        @await Html.PartialAsync("_Pagination", ViewDataDictionaryHelper.CreateWith(
                            ViewData,
                            ("CurrentPage", ViewBag.Page ?? 1),
                            ("TotalPages", ViewBag.TotalPages ?? 1),
                            ("TotalItems", ViewBag.TotalItems ?? 0),
                            ("PageSize", defaultPageSize),
                            ("Action", "Index"),
                            ("Controller", "Bundles")
                        ))
                    }
                    else
                    {
                        <div class="p-5 text-center">
                            <div class="avatar-text avatar-xl bg-soft-primary text-primary mb-4 mx-auto">
                                <i class="feather-package"></i>
                            </div>
                            <h5 class="fw-bold mb-2">@Html.T("لا توجد باقات بعد", "No bundles yet")</h5>
                            <p class="text-muted mb-4">@Html.T("ابدأ بإنشاء أول باقة دورات تعليمية لتوفير قيمة أفضل لطلابك", "Start creating your first course bundle to offer better value to your students")</p>
                            <a href="@Url.Action("Create")" class="btn btn-primary">
                                <i class="feather-plus me-2"></i>
                                @Html.T("إنشاء باقة جديدة", "Create new bundle")
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_DeleteModal")

@section Scripts {
    <script>
        $(document).ready(function () {
            // Select all checkbox
            $('#selectAll').on('change', function () {
                $('tbody input[type="checkbox"]').prop('checked', this.checked);
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        function duplicateBundle(id) {
            if (confirm('@Html.Raw(Html.T("هل تريد إنشاء نسخة من هذه الباقة؟", "Do you want to create a copy of this bundle?").Replace("'", "\\'"))')) {
                window.location.href = '@Url.Action("Duplicate")/' + id;
            }
        }
    </script>
}

