@model LMS.Domain.Entities.Marketing.CourseBundle
@using LMS.Common
@inject IPlatformSettingsService PlatformSettings

@{
    ViewData["Title"] = Html.T("إحصائيات الباقة", "Bundle Statistics");
    ViewData["Subtitle"] = Model.Name;
    
    // Load platform settings
    var defaultCommissionRate = await PlatformSettings.GetDecimalSettingAsync("Platform.CommissionRate", 30m);
    
    // Get dynamic data from ViewBag
    var totalRevenue = ViewBag.TotalRevenue as decimal? ?? 0;
    var totalSales = ViewBag.TotalSales as int? ?? Model.SalesCount;
    var conversionRate = ViewBag.ConversionRate as double? ?? 0;
    var viewsCount = ViewBag.ViewsCount as int? ?? 0;
    var salesChange = ViewBag.SalesChange as int? ?? 0;
    var revenueChange = ViewBag.RevenueChange as int? ?? 0;
    var grossRevenue = ViewBag.GrossRevenue as decimal? ?? 0;
    var platformCommission = ViewBag.PlatformCommission as decimal? ?? 0;
    var netRevenue = ViewBag.NetRevenue as decimal? ?? 0;
    var avgTimeToPurchase = ViewBag.AvgTimeToPurchase as decimal? ?? 0m;
    var platformCommissionRate = ViewBag.PlatformCommissionRate as decimal? ?? defaultCommissionRate;
    
    var chartLabels = ViewBag.ChartLabels as List<string> ?? new List<string>();
    var salesChartData = ViewBag.SalesChartData as List<int> ?? new List<int>();
    var revenueChartData = ViewBag.RevenueChartData as List<decimal> ?? new List<decimal>();
    var courseStats = ViewBag.CourseStats as dynamic;
    
    var directSales = int.TryParse(ViewBag.DirectSalesPercent as string, out var ds) ? ds : 0;
    var searchSales = int.TryParse(ViewBag.SearchSalesPercent as string, out var ss) ? ss : 0;
    var socialSales = int.TryParse(ViewBag.SocialSalesPercent as string, out var sos) ? sos : 0;
    var referralSales = int.TryParse(ViewBag.ReferralSalesPercent as string, out var rs) ? rs : 0;
    
    var salesChangePrefix = salesChange >= 0 ? "+" : "";
    var revenueChangePrefix = revenueChange >= 0 ? "+" : "";
}

<div class="page-header">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">@ViewData["Title"]</h5>
            <p class="fs-12 fw-medium text-muted mb-0">@ViewData["Subtitle"]</p>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">@Html.T("الرئيسية", "Home")</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index")">@Html.T("الباقات", "Bundles")</a></li>
            <li class="breadcrumb-item active">@Html.T("الإحصائيات", "Statistics")</li>
        </ul>
    </div>
    <div class="page-header-right ms-auto">
        <div class="d-flex align-items-center gap-2">
            <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-light">
                <i class="feather-arrow-right me-2"></i>
                العودة للتفاصيل
            </a>
            <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-primary">
                <i class="feather-edit me-2"></i>
                تعديل الباقة
            </a>
        </div>
    </div>
</div>

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", "إجمالي المبيعات" },
                { "Value", totalSales },
                { "Icon", "shopping-cart" },
                { "Color", "primary" },
                { "Change", salesChange != 0 ? $"{salesChangePrefix}{salesChange}" : "" },
                { "ChangeText", salesChange != 0 ? "هذا الشهر" : "" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", "إجمالي الإيرادات" },
                { "Value", totalRevenue.ToEGP() },
                { "Icon", "dollar-sign" },
                { "Color", "success" },
                { "Change", revenueChange != 0 ? $"{revenueChangePrefix}{revenueChange}%" : "" },
                { "ChangeText", revenueChange != 0 ? "هذا الشهر" : "" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", "التوفير للطلاب" },
                { "Value", $"{Model.SavingsPercentage:F0}%" },
                { "Icon", "arrow-down" },
                { "Color", "warning" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", "معدل التحويل" },
                { "Value", $"{conversionRate:F1}%" },
                { "Icon", "trending-up" },
                { "Color", "info" }
            })
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-xxl-8 col-xl-7">
            <!-- Sales Trend Chart -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("اتجاه المبيعات", "Sales trend")</h5>
                    <div class="card-header-action">
                        <span class="badge bg-soft-primary text-primary">@Html.T("آخر 6 أشهر", "Last 6 months")</span>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="salesTrendChart" height="300"></canvas>
                </div>
            </div>

            <!-- Revenue Breakdown -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تفصيل الإيرادات", "Revenue breakdown")</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-soft-success rounded">
                                <div class="fs-12 text-muted mb-1">@Html.T("إجمالي الإيرادات", "Total revenue")</div>
                                <div class="fs-4 fw-bold text-success">@grossRevenue.ToEGP()</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-soft-warning rounded">
                                <div class="fs-12 text-muted mb-1">@Html.T("عمولة المنصة", "Platform commission") (@platformCommissionRate.ToString("F0")%)</div>
                                <div class="fs-4 fw-bold text-warning">@platformCommission.ToEGP()</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-soft-primary rounded">
                                <div class="fs-12 text-muted mb-1">@Html.T("صافي الربح", "Net profit")</div>
                                <div class="fs-4 fw-bold text-primary">@netRevenue.ToEGP()</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses Performance -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("أداء الدورات في الباقة", "Bundle courses performance")</h5>
                </div>
                <div class="card-body">
                    @if (Model.BundleCourses != null && Model.BundleCourses.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var bundleCourse in Model.BundleCourses.OrderBy(bc => bc.DisplayOrder))
                            {
                                var courseCompletionRate = bundleCourse.Course?.Enrollments != null && bundleCourse.Course.Enrollments.Any()
                                    ? bundleCourse.Course.Enrollments.Count(e => e.Status == LMS.Domain.Enums.EnrollmentStatus.Completed) * 100.0 / bundleCourse.Course.Enrollments.Count
                                    : 0;
                                <div class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar-image avatar-md">
                                                <img src="@(bundleCourse.Course?.ThumbnailUrl ?? "/assets/images/general/placeholder.png")" alt="@bundleCourse.Course?.Title" class="img-fluid">
                                            </div>
                                            <div>
                                                <div class="fw-bold">@bundleCourse.Course?.Title</div>
                                                <div class="fs-11 text-muted">
                                                    <i class="feather-users me-1"></i>
                                                    @(bundleCourse.Course?.TotalStudents ?? 0) @Html.T("طالب", "students")
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold">@((bundleCourse.Course?.DiscountPrice ?? bundleCourse.Course?.Price ?? 0).ToEGP())</div>
                                            <div class="fs-11 text-muted">
                                                <i class="feather-star text-warning"></i>
                                                @(bundleCourse.Course?.AverageRating.ToString("F1") ?? "0.0")
                                            </div>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: @courseCompletionRate%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="fs-11 text-muted">@Html.T("معدل الإكمال", "Completion rate")</span>
                                        <span class="fs-11 fw-medium">@courseCompletionRate.ToString("F0")%</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="feather-book-open fs-1 mb-2"></i>
                            <p>@Html.T("لا توجد دورات في هذه الباقة", "No courses in this bundle")</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-xxl-4 col-xl-5">
            <!-- Bundle Overview -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("نظرة عامة", "Overview")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("عدد الدورات", "Number of courses")</span>
                        <span class="fw-bold">@Model.CoursesCount</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("السعر الأصلي", "Original price")</span>
                        <span class="fw-medium text-decoration-line-through">@Model.OriginalPrice.ToEGP()</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("سعر الباقة", "Bundle price")</span>
                        <span class="fw-bold text-success">@Model.Price.ToEGP()</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("نسبة التوفير", "Savings")</span>
                        <span class="badge bg-soft-success text-success">@Model.SavingsPercentage.ToString("F0")%</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("عدد المشاهدات", "Views")</span>
                        <span class="fw-bold">@viewsCount</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">@Html.T("الحالة", "Status")</span>
                        @if (Model.IsActive)
                        {
                            <span class="badge bg-soft-success text-success">@Html.T("نشطة", "Active")</span>
                        }
                        else
                        {
                            <span class="badge bg-soft-secondary text-secondary">@Html.T("غير نشطة", "Inactive")</span>
                        }
                    </div>
                    @if (Model.MaxSales.HasValue)
                    {
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">@Html.T("المبيعات المتبقية", "Remaining sales")</span>
                            <span class="fw-bold">@(Model.MaxSales.Value - Model.SalesCount)</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Sales Distribution -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("توزيع المبيعات", "Sales distribution")</h5>
                </div>
                <div class="card-body">
                    <canvas id="salesDistributionChart" height="250"></canvas>
                </div>
            </div>

            <!-- Performance Insights -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("رؤى الأداء", "Performance insights")</h5>
                </div>
                <div class="card-body">
                    @if (totalSales > 0)
                    {
                        @if (revenueChange > 10)
                        {
                            <div class="alert alert-success mb-3">
                                <i class="feather-trending-up me-2"></i>
                                <strong>أداء ممتاز!</strong> المبيعات في ارتفاع مستمر
                            </div>
                        }
                        else if (revenueChange >= 0)
                        {
                            <div class="alert alert-info mb-3">
                                <i class="feather-activity me-2"></i>
                                <strong>أداء مستقر!</strong> المبيعات ثابتة
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="feather-trending-down me-2"></i>
                                <strong>تنبيه!</strong> المبيعات في انخفاض
                            </div>
                        }
                    }
                    <div class="alert alert-info mb-3">
                        <i class="feather-clock me-2"></i>
                        متوسط الوقت للشراء: @avgTimeToPurchase.ToString("F1") يوم
                    </div>
                    @if (conversionRate < 5)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="feather-alert-circle me-2"></i>
                            معدل التحويل منخفض - حاول تحسين وصف الباقة
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">
                            <i class="feather-check-circle me-2"></i>
                            معدل التحويل جيد - استمر!
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Sales Trend Chart
        const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
        new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(chartLabels)),
                datasets: [{
                    label: 'المبيعات',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(salesChartData)),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'الإيرادات (بالآلاف)',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenueChartData)),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Sales Distribution Chart
        const distCtx = document.getElementById('salesDistributionChart').getContext('2d');
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['مباشر', 'بحث', 'وسائل التواصل', 'إحالات'],
                datasets: [{
                    data: [@directSales, @searchSales, @socialSales, @referralSales],
                    backgroundColor: @Html.Raw(Json.Serialize(Constants.ChartColors.Primary))
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
}

