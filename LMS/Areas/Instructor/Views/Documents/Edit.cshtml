@model LMS.Areas.Instructor.ViewModels.DocumentViewModel

@{
    ViewData["Title"] = Html.T("تعديل المستند", "Edit Document");
    ViewData["Subtitle"] = Html.T("تحديث معلومات وإعدادات المستند", "Update document info and settings");
    var detailsUrl = Url.Action("Details", new { id = Model.Id });
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw("<a href='" + detailsUrl + "' class='btn btn-light'><i class='feather-arrow-right me-2'></i>" + Html.T("العودة", "Back") + "</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تعديل معلومات المستند", "Edit document info")</h5>
                    <p class="text-muted mb-0 fs-12">@Html.T("الملف:", "File:") @Model.OriginalFileName</p>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" asp-route-id="@Model.Id" method="post">
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.Id)

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Title -->
                        <div class="mb-4">
                            <label asp-for="Title" class="form-label required">@Html.T("عنوان المستند", "Document title")</label>
                            <input asp-for="Title" class="form-control" placeholder="@Html.T("أدخل عنوان واضح للمستند", "Enter a clear title for the document")" required />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">@Html.T("الوصف", "Description")</label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="@Html.T("وصف مختصر عن محتوى المستند...", "Brief description of the document content...")"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- Related Entity -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="RelatedEntityType" class="form-label">@Html.T("نوع الكيان المرتبط", "Related entity type")</label>
                                <select asp-for="RelatedEntityType" class="form-select" id="entityType">
                                    <option value="">-- @Html.T("غير مرتبط", "Not linked") --</option>
                                    <option value="Course">@Html.T("دورة", "Course")</option>
                                    <option value="Assignment">@Html.T("واجب", "Assignment")</option>
                                </select>
                                <span asp-validation-for="RelatedEntityType" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="RelatedEntityId" class="form-label">@Html.T("اختر الكيان", "Choose entity")</label>
                                <select asp-for="RelatedEntityId" class="form-select" id="entityId">
                                    <option value="">-- اختر --</option>
                                </select>
                                <span asp-validation-for="RelatedEntityId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">@Html.T("إعدادات الوصول والمشاركة", "Access & sharing settings")</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsPublic" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsPublic" class="form-check-label">
                                                <strong>مستند عام</strong>
                                                <span class="d-block text-muted fs-11">يمكن لجميع الطلاب الوصول إليه</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsDownloadable" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsDownloadable" class="form-check-label">
                                                <strong>قابل للتحميل</strong>
                                                <span class="d-block text-muted fs-11">السماح للطلاب بتحميل الملف</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-check me-2"></i>
                                حفظ التعديلات
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            var courses = @Html.Raw(Json.Serialize(ViewBag.Courses ?? new List<object>()));
            var assignments = @Html.Raw(Json.Serialize(ViewBag.Assignments ?? new List<object>()));
            var currentEntityType = '@Model.RelatedEntityType';
            var currentEntityId = @(Model.RelatedEntityId ?? 0);

            function populateEntityDropdown() {
                var entityType = $('#entityType').val();
                var $entityId = $('#entityId');

                $entityId.empty();
                $entityId.append('<option value="">-- اختر --</option>');

                if (entityType === 'Course') {
                    courses.forEach(function (course) {
                        var selected = (currentEntityId == course.value) ? 'selected' : '';
                        $entityId.append('<option value="' + course.value + '" ' + selected + '>' + course.text + '</option>');
                    });
                    $entityId.prop('disabled', false);
                } else if (entityType === 'Assignment') {
                    assignments.forEach(function (assignment) {
                        var selected = (currentEntityId == assignment.value) ? 'selected' : '';
                        $entityId.append('<option value="' + assignment.value + '" ' + selected + '>' + assignment.text + '</option>');
                    });
                    $entityId.prop('disabled', false);
                } else {
                    $entityId.prop('disabled', true);
                }
            }

            // Initial population
            if (currentEntityType) {
                populateEntityDropdown();
            }

            $('#entityType').change(function () {
                currentEntityId = 0; // Reset selection
                populateEntityDropdown();
            });
        });
    </script>
}

