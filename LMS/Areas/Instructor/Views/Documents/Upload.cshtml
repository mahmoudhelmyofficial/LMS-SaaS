@model LMS.Areas.Instructor.ViewModels.DocumentUploadViewModel

@{
    ViewData["Title"] = Html.T("رفع مستند جديد", "Upload New Document");
    ViewData["Subtitle"] = Html.T("رفع ومشاركة المستندات مع الطلاب", "Upload and share documents with students");
    var indexUrl = Url.Action("Index");
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw("<a href='" + indexUrl + "' class='btn btn-light'><i class='feather-arrow-right me-2'></i>" + Html.T("العودة", "Back") + "</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("رفع مستند جديد", "Upload new document")</h5>
                    <p class="text-muted mb-0 fs-13">@Html.T("الأنواع المدعومة: PDF, Word, Excel, PowerPoint, وغيرها (الحد الأقصى: 50 MB)", "Supported types: PDF, Word, Excel, PowerPoint, etc. (Max: 50 MB)")</p>
                </div>
                <div class="card-body">
                    <form asp-action="Upload" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label asp-for="File" class="form-label required">@Html.T("اختر الملف", "Choose file")</label>
                            <input asp-for="File" type="file" class="form-control" required accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf,.odt,.ods,.odp" />
                            <div class="form-text">
                                @Html.T("الحد الأقصى لحجم الملف: 50 MB", "Max file size: 50 MB")
                            </div>
                            <span asp-validation-for="File" class="text-danger"></span>
                        </div>

                        <!-- Title -->
                        <div class="mb-4">
                            <label asp-for="Title" class="form-label required">@Html.T("عنوان المستند", "Document title")</label>
                            <input asp-for="Title" class="form-control" placeholder="@Html.T("أدخل عنوان واضح للمستند", "Enter a clear title for the document")" required />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">@Html.T("الوصف", "Description")</label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="@Html.T("وصف مختصر عن محتوى المستند...", "Brief description of the document content...")"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- Related Entity -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="RelatedEntityType" class="form-label">@Html.T("نوع الكيان المرتبط", "Related entity type")</label>
                                <select asp-for="RelatedEntityType" class="form-select" id="entityType">
                                    <option value="">-- @Html.T("غير مرتبط", "Not linked") --</option>
                                    <option value="Course">@Html.T("دورة", "Course")</option>
                                    <option value="Assignment">@Html.T("واجب", "Assignment")</option>
                                </select>
                                <span asp-validation-for="RelatedEntityType" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="RelatedEntityId" class="form-label">@Html.T("اختر الكيان", "Choose entity")</label>
                                <select asp-for="RelatedEntityId" class="form-select" id="entityId" disabled>
                                    <option value="">-- @Html.T("اختر نوع الكيان أولاً", "Choose entity type first") --</option>
                                </select>
                                <span asp-validation-for="RelatedEntityId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">@Html.T("إعدادات الوصول والمشاركة", "Access and sharing settings")</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsPublic" class="form-check-input" type="checkbox" />
                                            <label asp-for="IsPublic" class="form-check-label">
                                                <strong>مستند عام</strong>
                                                <span class="d-block text-muted fs-11">يمكن لجميع الطلاب الوصول إليه</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsDownloadable" class="form-check-input" type="checkbox" checked />
                                            <label asp-for="IsDownloadable" class="form-check-label">
                                                <strong>قابل للتحميل</strong>
                                                <span class="d-block text-muted fs-11">السماح للطلاب بتحميل الملف</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Index")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-upload me-2"></i>
                                رفع المستند
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="feather-info text-primary me-2"></i>
                        معلومات هامة
                    </h6>
                    <ul class="mb-0">
                        <li class="mb-2">الأنواع المدعومة: PDF, Word, Excel, PowerPoint, Text, وغيرها</li>
                        <li class="mb-2">الحد الأقصى لحجم الملف: 50 MB</li>
                        <li class="mb-2">يمكنك ربط المستند بدورة أو واجب محدد</li>
                        <li>يمكنك التحكم في من يمكنه الوصول للمستند وتحميله</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            var courses = @Html.Raw(Json.Serialize(ViewBag.Courses ?? new List<object>()));
            var assignments = @Html.Raw(Json.Serialize(ViewBag.Assignments ?? new List<object>()));

            $('#entityType').change(function () {
                var entityType = $(this).val();
                var $entityId = $('#entityId');

                $entityId.empty();
                $entityId.append('<option value="">-- اختر --</option>');

                if (entityType === 'Course') {
                    courses.forEach(function (course) {
                        $entityId.append('<option value="' + course.value + '">' + course.text + '</option>');
                    });
                    $entityId.prop('disabled', false);
                } else if (entityType === 'Assignment') {
                    assignments.forEach(function (assignment) {
                        $entityId.append('<option value="' + assignment.value + '">' + assignment.text + '</option>');
                    });
                    $entityId.prop('disabled', false);
                } else {
                    $entityId.prop('disabled', true);
                }
            });

            // File input validation
            $('input[type="file"]').change(function () {
                var fileSize = this.files[0].size / 1024 / 1024; // in MB
                if (fileSize > 50) {
                    alert('حجم الملف يتجاوز الحد الأقصى المسموح (50 MB)');
                    $(this).val('');
                }
            });
        });
    </script>
}

