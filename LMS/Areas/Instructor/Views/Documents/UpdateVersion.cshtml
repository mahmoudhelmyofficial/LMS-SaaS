@model LMS.Areas.Instructor.ViewModels.DocumentVersionViewModel

@{
    ViewData["Title"] = Html.T("رفع إصدار جديد", "Upload New Version");
    ViewData["Subtitle"] = Html.T("تحديث المستند بإصدار أحدث", "Update document with newer version");
    var document = ViewBag.Document as LMS.Domain.Entities.Content.Document;
    var detailsUrl = Url.Action("Details", new { id = Model.DocumentId });
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw($@"
        <a href='{detailsUrl}' class='btn btn-light'>
            <i class='feather-arrow-right me-2'></i>
            العودة
        </a>
    ") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Current Version Info -->
            <div class="card bg-soft-info mb-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="feather-info text-info me-2"></i>
                        الإصدار الحالي
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>العنوان:</strong> @document?.Title</p>
                            <p class="mb-1"><strong>الملف:</strong> @document?.OriginalFileName</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>الإصدار:</strong> v@document?.Version</p>
                            <p class="mb-1"><strong>الحجم:</strong> @((document?.FileSize / 1024.0 / 1024.0)?.ToString("F2")) MB</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload New Version Form -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("رفع إصدار جديد", "Upload new version")</h5>
                    <p class="text-muted mb-0 fs-13">سيتم إنشاء إصدار جديد برقم: v@(document?.Version + 1)</p>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateVersion" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.DocumentId)

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- File Upload -->
                        <div class="mb-4">
                            <label asp-for="NewFile" class="form-label required">اختر الملف الجديد</label>
                            <input asp-for="NewFile" type="file" class="form-control" required accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.rtf,.odt,.ods,.odp" />
                            <div class="form-text">
                                الحد الأقصى لحجم الملف: 50 MB
                            </div>
                            <span asp-validation-for="NewFile" class="text-danger"></span>
                        </div>

                        <!-- Info Alert -->
                        <div class="alert alert-warning mb-4">
                            <i class="feather-alert-triangle me-2"></i>
                            <strong>ملاحظة:</strong> سيتم إنشاء مستند جديد برقم إصدار محدّث، والاحتفاظ بالإصدار القديم للرجوع إليه عند الحاجة.
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Details", new { id = Model.DocumentId })" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-upload me-2"></i>
                                رفع الإصدار الجديد
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="feather-help-circle text-info me-2"></i>
                        كيف تعمل الإصدارات؟
                    </h6>
                    <ul class="mb-0">
                        <li class="mb-2">عند رفع إصدار جديد، يتم إنشاء مستند منفصل برقم إصدار محدّث</li>
                        <li class="mb-2">الإصدار القديم يبقى محفوظاً ويمكن الرجوع إليه</li>
                        <li class="mb-2">الإصدار الجديد يرث نفس العنوان والوصف والإعدادات</li>
                        <li>الطلاب سيشاهدون الإصدار الجديد تلقائياً</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            // File input validation
            $('input[type="file"]').change(function () {
                if (this.files.length > 0) {
                    var fileSize = this.files[0].size / 1024 / 1024; // in MB
                    if (fileSize > 50) {
                        alert('حجم الملف يتجاوز الحد الأقصى المسموح (50 MB)');
                        $(this).val('');
                    }
                }
            });
        });
    </script>
}

