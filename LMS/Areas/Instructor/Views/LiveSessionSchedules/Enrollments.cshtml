@model LMS.Domain.Entities.LiveSessions.LiveSessionSchedule

@{
    ViewData["Title"] = Html.T("المشتركون في جدول الحصص", "Schedule Subscribers");
    ViewData["Subtitle"] = Model.Title;
    var detailsUrl = Url.Action("Details", new { id = Model.Id });
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw("<a href='" + detailsUrl + "' class='btn btn-light'><i class='feather-arrow-right me-2'></i>" + Html.T("العودة للتفاصيل", "Back to Details") + "</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي المشتركين", "Total Subscribers") },
                { "Value", Model.Enrollments.Count },
                { "Icon", "users" },
                { "Color", "primary" }
            })
        </div>
        <div class="col-md-4">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("المشتركون النشطون", "Active Subscribers") },
                { "Value", Model.Enrollments.Count(e => e.Status == LMS.Domain.Enums.ScheduleEnrollmentStatus.Active) },
                { "Icon", "check-circle" },
                { "Color", "success" }
            })
        </div>
        <div class="col-md-4">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي المدفوعات", "Total Payments") },
                { "Value", Model.Enrollments.Sum(e => e.PaidAmount).ToString("N0") + " " + Html.T("ج.م", "EGP") },
                { "Icon", "dollar-sign" },
                { "Color", "warning" }
            })
        </div>
    </div>

    <!-- Enrollments Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">@Html.T("قائمة المشتركين", "Subscribers List")</h5>
        </div>
        <div class="card-body custom-card-action p-0">
            @if (Model.Enrollments.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>@Html.T("الطالب", "Student")</th>
                                <th>@Html.T("تاريخ الاشتراك", "Enrollment Date")</th>
                                <th>@Html.T("المبلغ المدفوع", "Paid Amount")</th>
                                <th>@Html.T("كوبون", "Coupon")</th>
                                <th>@Html.T("الخصم", "Discount")</th>
                                <th>@Html.T("الحالة", "Status")</th>
                                <th>@Html.T("تاريخ الانتهاء", "Expiry Date")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ var num = 0; }
                            @foreach (var enrollment in Model.Enrollments.OrderByDescending(e => e.EnrolledAt))
                            {
                                num++;
                                <tr>
                                    <td>@num</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar-text">@(enrollment.Student?.FirstName?.Substring(0, 1) ?? "?")</div>
                                            <div>
                                                <div class="fw-medium">@(enrollment.Student?.FullName ?? Html.T("غير معروف", "Unknown"))</div>
                                                <div class="fs-12 text-muted">@(enrollment.Student?.Email ?? "-")</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@enrollment.EnrolledAt.ToString("dd/MM/yyyy hh:mm tt")</td>
                                    <td>
                                        <span class="fw-bold text-success">@enrollment.PaidAmount.ToString("N0") @enrollment.Currency</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(enrollment.CouponCode))
                                        {
                                            <span class="badge bg-soft-info text-info">@enrollment.CouponCode</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (enrollment.DiscountAmount > 0)
                                        {
                                            <span class="text-danger">-@enrollment.DiscountAmount.ToString("N0")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @switch (enrollment.Status)
                                        {
                                            case LMS.Domain.Enums.ScheduleEnrollmentStatus.Active:
                                                <span class="badge bg-soft-success text-success">@Html.T("نشط", "Active")</span>
                                                break;
                                            case LMS.Domain.Enums.ScheduleEnrollmentStatus.Cancelled:
                                                <span class="badge bg-soft-danger text-danger">@Html.T("ملغي", "Cancelled")</span>
                                                break;
                                            case LMS.Domain.Enums.ScheduleEnrollmentStatus.Expired:
                                                <span class="badge bg-soft-secondary text-secondary">@Html.T("منتهي", "Expired")</span>
                                                break;
                                            case LMS.Domain.Enums.ScheduleEnrollmentStatus.Refunded:
                                                <span class="badge bg-soft-warning text-warning">@Html.T("مسترد", "Refunded")</span>
                                                break;
                                        }
                                    </td>
                                    <td>@(enrollment.ExpiresAt?.ToString("dd/MM/yyyy") ?? Html.T("غير محدد", "Not specified"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="p-5 text-center">
                    <div class="avatar-text avatar-xl bg-soft-primary text-primary mb-4 mx-auto">
                        <i class="feather-users"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@Html.T("لا يوجد مشتركون", "No Subscribers")</h5>
                    <p class="text-muted">@Html.T("لم يشترك أي طالب في هذا الجدول بعد", "No students have subscribed to this schedule yet")</p>
                </div>
            }
        </div>
    </div>
</div>
