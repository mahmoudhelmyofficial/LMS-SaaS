@model LMS.Areas.Instructor.ViewModels.CourseWizardViewModel

<div class="step-4-media">
    <!-- Thumbnail Section -->
    <div class="form-section">
        <h5 class="form-section-title">
            <i class="feather-image"></i>
            صورة الدورة
            <span class="badge bg-soft-danger text-danger ms-2">مطلوب</span>
        </h5>
        <p class="text-muted mb-4">صورة جذابة تظهر في قوائم الدورات ونتائج البحث. يُفضل أبعاد 1280×720 بكسل.</p>

        <div class="row">
            <div class="col-lg-12">
                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                    { "FieldName", "ThumbnailUrl" },
                    { "FieldId", "wizardThumbnailUrl" },
                    { "Label", "صورة الدورة المصغرة" },
                    { "MediaType", "Image" },
                    { "CurrentValue", Model.ThumbnailUrl },
                    { "Required", true },
                    { "HelpText", "الحجم الموصى به: 1280x720 بكسل. PNG, JPG, WEBP (حد أقصى 5MB)" },
                    { "AspectRatio", "16/9" }
                })
            </div>
        </div>
    </div>

    <!-- Preview Video Section -->
    <div class="form-section">
        <h5 class="form-section-title">
            <i class="feather-video"></i>
            فيديو المعاينة
            <span class="badge bg-soft-secondary text-secondary ms-2">اختياري ولكن يُنصح به</span>
        </h5>
        <p class="text-muted mb-4">فيديو تعريفي قصير (1-3 دقائق) يعرض محتوى الدورة ويجذب الطلاب للتسجيل.</p>

        <div class="row g-4">
            <div class="col-lg-12">
                <label class="form-label fw-bold">مصدر الفيديو</label>
                <select asp-for="PreviewVideoProvider" class="form-select" id="videoProviderSelect" onchange="toggleVideoFields()">
                    <option value="">اختر المصدر...</option>
                    <option value="Library">من مكتبة الوسائط</option>
                    <option value="YouTube">YouTube</option>
                    <option value="Vimeo">Vimeo</option>
                    <option value="URL">رابط مباشر</option>
                </select>
            </div>

            <!-- Media Library Option -->
            <div class="col-12" id="videoLibraryPicker" style="display: none;">
                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                    { "FieldName", "PreviewVideoUrl" },
                    { "FieldId", "wizardPreviewVideoUrl" },
                    { "Label", "فيديو المعاينة" },
                    { "MediaType", "Video" },
                    { "CurrentValue", Model.PreviewVideoUrl },
                    { "Required", false },
                    { "HelpText", "اختر فيديو من مكتبتك أو ارفع فيديو جديد" },
                    { "AspectRatio", "16/9" }
                })
            </div>

            <!-- URL Input Option -->
            <div class="col-12" id="videoUrlInput" style="display: none;">
                <label class="form-label fw-bold">رابط الفيديو</label>
                <input asp-for="PreviewVideoUrl" 
                       type="url" 
                       class="form-control" 
                       placeholder="https://youtube.com/watch?v=..."
                       id="videoUrlField">
                <small class="text-muted" id="videoUrlHint">أدخل رابط الفيديو الكامل</small>
            </div>

            <!-- Video Preview -->
            <div class="col-12" id="videoPreviewContainer" style="display: none;">
                <label class="form-label fw-bold">معاينة الفيديو</label>
                <div class="video-preview rounded-3 overflow-hidden bg-dark" style="aspect-ratio: 16/9; max-height: 400px;">
                    <iframe id="videoPreviewFrame" 
                            class="w-100 h-100" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Tips Section -->
    <div class="form-section">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card border-0 bg-soft-primary h-100">
                    <div class="card-body">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="feather-image me-2"></i>
                            نصائح لصورة مميزة
                        </h6>
                        <ul class="list-unstyled mb-0 text-muted fs-12">
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                استخدم صورة عالية الجودة (1280×720 بكسل)
                            </li>
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                تأكد من وضوح النص في الصورة
                            </li>
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                استخدم ألوان جذابة تعكس محتوى الدورة
                            </li>
                            <li>
                                <i class="feather-check text-success me-2"></i>
                                تجنب النصوص الكثيرة في الصورة
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-soft-info h-100">
                    <div class="card-body">
                        <h6 class="fw-bold text-info mb-3">
                            <i class="feather-video me-2"></i>
                            نصائح لفيديو المعاينة
                        </h6>
                        <ul class="list-unstyled mb-0 text-muted fs-12">
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                اجعله قصيراً (1-3 دقائق)
                            </li>
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                قدّم نفسك ومحتوى الدورة بوضوح
                            </li>
                            <li class="mb-2">
                                <i class="feather-check text-success me-2"></i>
                                أظهر عينة من المحتوى الفعلي
                            </li>
                            <li>
                                <i class="feather-check text-success me-2"></i>
                                استخدم جودة صوت وصورة عالية
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .form-section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    
    .bg-soft-primary {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    .bg-soft-info {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }
    
    .bg-soft-danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .bg-soft-secondary {
        background-color: rgba(108, 117, 125, 0.1) !important;
    }

    .video-preview {
        border-radius: 12px;
    }

    .card {
        border-radius: 12px;
    }
</style>

<script>
    // Video provider change
    function toggleVideoFields() {
        const provider = document.getElementById('videoProviderSelect').value;
        const libraryPicker = document.getElementById('videoLibraryPicker');
        const urlInput = document.getElementById('videoUrlInput');
        const urlField = document.getElementById('videoUrlField');
        const hint = document.getElementById('videoUrlHint');

        // Hide all first
        libraryPicker.style.display = 'none';
        urlInput.style.display = 'none';

        switch (provider) {
            case 'Library':
                libraryPicker.style.display = 'block';
                break;
            case 'YouTube':
                urlInput.style.display = 'block';
                urlField.placeholder = 'https://youtube.com/watch?v=XXXXX';
                hint.textContent = 'مثال: https://youtube.com/watch?v=dQw4w9WgXcQ';
                break;
            case 'Vimeo':
                urlInput.style.display = 'block';
                urlField.placeholder = 'https://vimeo.com/XXXXXXX';
                hint.textContent = 'مثال: https://vimeo.com/123456789';
                break;
            case 'URL':
                urlInput.style.display = 'block';
                urlField.placeholder = 'رابط الفيديو المباشر';
                hint.textContent = 'أدخل رابط الفيديو المباشر';
                break;
        }

        // Try to preview video
        previewVideo();
    }

    // Preview video
    function previewVideo() {
        const provider = document.getElementById('videoProviderSelect').value;
        const url = document.getElementById('videoUrlField')?.value;
        const container = document.getElementById('videoPreviewContainer');
        const frame = document.getElementById('videoPreviewFrame');

        if (!url || provider === 'Library' || provider === '') {
            container.style.display = 'none';
            return;
        }

        let embedUrl = '';

        if (provider === 'YouTube') {
            const videoId = extractYouTubeId(url);
            if (videoId) {
                embedUrl = `https://www.youtube.com/embed/${videoId}`;
            }
        } else if (provider === 'Vimeo') {
            const videoId = extractVimeoId(url);
            if (videoId) {
                embedUrl = `https://player.vimeo.com/video/${videoId}`;
            }
        } else if (provider === 'URL') {
            embedUrl = url;
        }

        if (embedUrl) {
            frame.src = embedUrl;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function extractYouTubeId(url) {
        const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }

    function extractVimeoId(url) {
        const regex = /vimeo\.com\/(\d+)/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize video fields based on existing provider
        const provider = document.getElementById('videoProviderSelect').value;
        if (provider) {
            toggleVideoFields();
        }

        // Add event listener for video URL change
        const videoUrlField = document.getElementById('videoUrlField');
        if (videoUrlField) {
            videoUrlField.addEventListener('change', previewVideo);
            videoUrlField.addEventListener('input', debounce(previewVideo, 500));
        }
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>

