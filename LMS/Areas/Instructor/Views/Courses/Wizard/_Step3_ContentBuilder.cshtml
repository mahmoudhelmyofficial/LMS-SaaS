@model LMS.Areas.Instructor.ViewModels.CourseWizardViewModel

@{
    var courseId = Model.Id ?? 0;
    var enableDrip = Model.EnableContentDrip;
}

<div class="step-3-content-builder">
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="form-section-title mb-0">
                    <i class="feather-layers"></i>
                    @Html.T("بناء محتوى الدورة", "Course Content Builder")
                </h5>
                <p class="text-muted mb-0 mt-2">@Html.T("أضف الوحدات والدروس لبناء هيكل دورتك التعليمية", "Add modules and lessons to build your course structure")</p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-soft-primary text-primary fs-12">
                    <i class="feather-folder me-1"></i>
                    @Model.TotalModulesCount @Html.T("وحدة", "modules")
                </span>
                <span class="badge bg-soft-success text-success fs-12">
                    <i class="feather-file-text me-1"></i>
                    @Model.TotalLessonsCount @Html.T("درس", "lessons")
                </span>
            </div>
        </div>

        @if (!Model.Id.HasValue)
        {
            <div class="alert alert-info d-flex align-items-center">
                <i class="feather-info me-3 fs-4"></i>
                <div>
                    <strong>@Html.T("ملاحظة:", "Note:")</strong> @Html.T("يجب حفظ معلومات الدورة الأساسية أولاً قبل إضافة المحتوى.", "You must save the basic course information first before adding content.")
                    <br>
                    <small class="text-muted">@Html.T("انقر على \"الخطوة التالية\" لحفظ البيانات ثم العودة لإضافة المحتوى.", "Click \"Next step\" to save the data then return to add content.")</small>
                </div>
            </div>
        }
        else
        {
            <!-- Add Module Button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModuleModal">
                    <i class="feather-plus me-2"></i>
                    @Html.T("إضافة وحدة جديدة", "Add New Module")
                </button>

                @if (Model.TotalLessonsCount < 3)
                {
                    <div class="alert alert-warning py-2 px-3 mb-0 d-flex align-items-center">
                        <i class="feather-alert-triangle me-2"></i>
                        <small>@Html.T("تحتاج إلى", "You need") @(3 - Model.TotalLessonsCount) @Html.T("دروس إضافية للنشر", "more lessons to publish")</small>
                    </div>
                }
            </div>

            <!-- Modules List -->
            <div id="modulesContainer" class="modules-list">
                @if (Model.Modules != null && Model.Modules.Any())
                {
                    foreach (var module in Model.Modules.OrderBy(m => m.OrderIndex))
                    {
                        <div class="module-card card mb-3 border" data-module-id="@module.Id">
                            <div class="card-header bg-light d-flex align-items-center py-3">
                                <span class="drag-handle me-3 cursor-move text-muted">
                                    <i class="feather-menu"></i>
                                </span>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 fw-bold">@module.Title</h6>
                                    @if (!string.IsNullOrEmpty(module.Description))
                                    {
                                        <small class="text-muted">@module.Description</small>
                                    }
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-soft-primary text-primary">
                                        @module.LessonsCount @Html.T("درس", "lessons")
                                    </span>
                                    @if (enableDrip)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-info content-drip-btn" onclick="showModuleDripSettings(@module.Id, this)" title="@Html.T("جدولة المحتوى", "Content scheduling")">
                                            <i class="feather-clock me-1"></i>@Html.T("جدولة", "Schedule")
                                        </button>
                                    }
                                    <div class="dropdown">
                                        <button type="button" class="btn btn-sm btn-light" data-bs-toggle="dropdown">
                                            <i class="feather-more-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="editModule(@module.Id)">
                                                    <i class="feather-edit me-2"></i>@Html.T("تعديل", "Edit")
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="javascript:void(0)" onclick="showAddLessonModal(@module.Id)">
                                                    <i class="feather-plus me-2"></i>@Html.T("إضافة درس", "Add lesson")
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteModule(@module.Id)">
                                                    <i class="feather-trash-2 me-2"></i>@Html.T("حذف", "Delete")
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="lessons-list" data-module-id="@module.Id">
                                    @if (module.Lessons != null && module.Lessons.Any())
                                    {
                                        foreach (var lesson in module.Lessons.OrderBy(l => l.OrderIndex))
                                        {
                                            <div class="lesson-row d-flex align-items-center p-3 border-bottom" data-lesson-id="@lesson.Id">
                                                <span class="drag-handle me-3 cursor-move text-muted">
                                                    <i class="feather-menu"></i>
                                                </span>
                                                <div class="lesson-icon me-3">
                                                    <span class="avatar-text avatar-sm @GetLessonTypeColor(lesson.Type)">
                                                        <i class="feather-@lesson.TypeIcon"></i>
                                                    </span>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-medium">@lesson.Title</div>
                                                    <small class="text-muted">
                                                        @lesson.TypeName
                                                        @if (lesson.DurationSeconds > 0)
                                                        {
                                                            <span>• @(lesson.DurationSeconds / 60) @Html.T("دقيقة", "min")</span>
                                                        }
                                                    </small>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    @if (lesson.IsPreviewable)
                                                    {
                                                        <span class="badge bg-soft-info text-info">@Html.T("معاينة", "Preview")</span>
                                                    }
                                                    <button type="button" class="btn btn-sm btn-light"
                                                            onclick="showEditLessonModal(@lesson.Id)"
                                                            title="@Html.T("تعديل الدرس", "Edit lesson")">
                                                        <i class="feather-edit-2"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-light text-danger"
                                                            onclick="deleteLesson(@lesson.Id)"
                                                            title="@Html.T("حذف الدرس", "Delete lesson")">
                                                        <i class="feather-trash-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center py-4 empty-lessons">
                                            <i class="feather-inbox text-muted fs-1 mb-2 d-block"></i>
                                            <p class="text-muted mb-2">@Html.T("لا توجد دروس في هذه الوحدة", "No lessons in this module")</p>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="showAddLessonModal(@module.Id)">
                                                <i class="feather-plus me-1"></i>
                                                @Html.T("إضافة أول درس", "Add first lesson")
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                                            <div class="card-footer bg-light py-2">
                                <button type="button" class="btn btn-sm btn-light w-100" onclick="showAddLessonModal(@module.Id)">
                                    <i class="feather-plus me-2"></i>
                                    @Html.T("إضافة درس", "Add lesson")
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5" id="emptyModulesState">
                        <div class="avatar-text avatar-xl bg-soft-primary text-primary mb-3 mx-auto">
                            <i class="feather-layers"></i>
                        </div>
                        <h5 class="fw-bold mb-2">@Html.T("ابدأ ببناء محتوى دورتك", "Start building your course content")</h5>
                        <p class="text-muted mb-4">@Html.T("أضف وحدات ودروس لإنشاء هيكل تعليمي منظم", "Add modules and lessons to create an organized structure")</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModuleModal">
                            <i class="feather-plus me-2"></i>
                            @Html.T("إضافة أول وحدة", "Add first module")
                        </button>
                    </div>
                }
            </div>

            <!-- Quick Link to Full Content Manager -->
            <div class="mt-4 p-3 bg-soft-info rounded-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="fw-bold text-info mb-1">@Html.T("إدارة المحتوى المتقدمة", "Advanced Content Management")</h6>
                        <small class="text-muted">@Html.T("لإضافة اختبارات وتكليفات ومرفقات، استخدم صفحة إدارة المحتوى التفصيلية", "To add quizzes, assignments and attachments, use the detailed content management page")</small>
                    </div>
                    <a href="@Url.Action("Index", "Modules", new { courseId = Model.Id })" class="btn btn-info">
                        <i class="feather-external-link me-2"></i>
                        @Html.T("فتح الإدارة المتقدمة", "Open advanced management")
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<!-- Add Module Modal -->
<div class="modal fade" id="addModuleModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-folder-plus me-2 text-primary"></i>
                    @Html.T("إضافة وحدة جديدة", "Add New Module")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Html.T("إغلاق", "Close")"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("عنوان الوحدة", "Module title") <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newModuleTitle" placeholder="@Html.T("مثال: المقدمة وأساسيات الدورة", "e.g. Introduction and basics")">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("وصف الوحدة", "Module description")</label>
                    <textarea class="form-control" id="newModuleDescription" rows="3" placeholder="@Html.T("وصف مختصر للمحتوى...", "Brief description of content...")"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                <button type="button" class="btn btn-primary" onclick="addModule()">
                    <i class="feather-plus me-2"></i>
                    @Html.T("إضافة الوحدة", "Add Module")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Lesson Modal (Two-Step) -->
<div class="modal fade" id="addLessonModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" id="addLessonModalDialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLessonModalTitle">
                    <i class="feather-file-plus me-2 text-primary"></i>
                    <span id="lessonModalTitleText">@Html.T("اختر نوع الدرس", "Choose lesson type")</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Html.T("إغلاق", "Close")"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="newLessonModuleId">
                <input type="hidden" id="selectedLessonType" value="">

                <!-- ========== STEP 1: Lesson Type Selector ========== -->
                <div id="lessonStep1">
                    <!-- Progress indicator -->
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-indicator active">
                            <span class="step-number">1</span>
                            <span class="step-label">@Html.T("نوع الدرس", "Lesson type")</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-indicator">
                            <span class="step-number">2</span>
                            <span class="step-label">@Html.T("تفاصيل الدرس", "Lesson details")</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-indicator">
                            <span class="step-number">3</span>
                            <span class="step-label">@Html.T("إعداد متقدم", "Advanced settings")</span>
                        </div>
                    </div>

                    <!-- CONTENT Group -->
                    <div class="mb-4">
                        <h6 class="text-muted fw-bold mb-3">
                            <i class="feather-play-circle me-2"></i>@Html.T("محتوى", "Content")
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Video" onclick="selectLessonType('Video')">
                                    <div class="ltc-icon text-primary"><i class="feather-video"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("فيديو", "Video")</div>
                                        <div class="ltc-desc">@Html.T("درس فيديو تعليمي", "Educational video lesson")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Article" onclick="selectLessonType('Article')">
                                    <div class="ltc-icon text-info"><i class="feather-book-open"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("مقال", "Article")</div>
                                        <div class="ltc-desc">@Html.T("محتوى نصي منسق", "Formatted text content")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Text" onclick="selectLessonType('Text')">
                                    <div class="ltc-icon text-info"><i class="feather-file-text"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("نص", "Text")</div>
                                        <div class="ltc-desc">@Html.T("درس نصي بسيط", "Simple text lesson")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="PDF" onclick="selectLessonType('PDF')">
                                    <div class="ltc-icon text-danger"><i class="feather-file"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("ملف PDF", "PDF file")</div>
                                        <div class="ltc-desc">@Html.T("عرض ملف PDF تفاعلي", "Interactive PDF viewer")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Audio" onclick="selectLessonType('Audio')">
                                    <div class="ltc-icon text-purple"><i class="feather-headphones"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("صوتي", "Audio")</div>
                                        <div class="ltc-desc">@Html.T("محتوى صوتي أو بودكاست", "Audio content or podcast")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ASSESSMENT Group -->
                    <div class="mb-4">
                        <h6 class="text-muted fw-bold mb-3">
                            <i class="feather-check-square me-2"></i>@Html.T("تقييم", "Assessment")
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Quiz" onclick="selectLessonType('Quiz')">
                                    <div class="ltc-icon text-warning"><i class="feather-help-circle"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("اختبار", "Quiz")</div>
                                        <div class="ltc-desc">@Html.T("أسئلة وتقييم تلقائي", "Questions and auto grading")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Assignment" onclick="selectLessonType('Assignment')">
                                    <div class="ltc-icon text-success"><i class="feather-edit-3"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("تكليف", "Assignment")</div>
                                        <div class="ltc-desc">@Html.T("واجب يرسله الطالب", "Student-submitted assignment")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- INTERACTIVE Group -->
                    <div class="mb-0">
                        <h6 class="text-muted fw-bold mb-3">
                            <i class="feather-zap me-2"></i>@Html.T("تفاعلي", "Interactive")
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="LiveClass" onclick="selectLessonType('LiveClass')">
                                    <div class="ltc-icon text-danger"><i class="feather-play-circle"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("بث مباشر", "Live session")</div>
                                        <div class="ltc-desc">@Html.T("حصة مباشرة مع الطلاب", "Live class with students")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="Download" onclick="selectLessonType('Download')">
                                    <div class="ltc-icon text-secondary"><i class="feather-download"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("ملف للتحميل", "Downloadable file")</div>
                                        <div class="ltc-desc">@Html.T("ملف يحمّله الطالب", "File for student download")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6">
                                <div class="lesson-type-card" data-type="ExternalLink" onclick="selectLessonType('ExternalLink')">
                                    <div class="ltc-icon text-info"><i class="feather-external-link"></i></div>
                                    <div class="ltc-body">
                                        <div class="ltc-title">@Html.T("رابط خارجي", "External link")</div>
                                        <div class="ltc-desc">@Html.T("رابط لموقع أو أداة خارجية", "Link to external site or tool")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== STEP 2: Type-Specific Form ========== -->
                <div id="lessonStep2" style="display: none;">
                    <!-- Progress indicator -->
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-indicator completed">
                            <span class="step-number"><i class="feather-check"></i></span>
                            <span class="step-label">@Html.T("نوع الدرس", "Lesson type")</span>
                        </div>
                        <div class="step-line active"></div>
                        <div class="step-indicator active">
                            <span class="step-number">2</span>
                            <span class="step-label">@Html.T("تفاصيل الدرس", "Lesson details")</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-indicator">
                            <span class="step-number">3</span>
                            <span class="step-label">@Html.T("إعداد متقدم", "Advanced settings")</span>
                        </div>
                    </div>

                    <!-- Selected type badge -->
                    <div class="mb-4 d-flex align-items-center gap-2">
                        <span class="badge bg-soft-primary text-primary fs-12" id="selectedTypeBadge">
                            <i class="me-1" id="selectedTypeIcon"></i>
                            <span id="selectedTypeName"></span>
                        </span>
                    </div>

                    <!-- Common fields for ALL types -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">@Html.T("عنوان الدرس", "Lesson title") <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newLessonTitle" placeholder="@Html.T("مثال: مقدمة عن Python", "e.g. Introduction to Python")">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">@Html.T("وصف الدرس", "Lesson description") <small class="text-muted fw-normal">(@Html.T("اختياري", "optional"))</small></label>
                            <textarea class="form-control" id="newLessonDescription" rows="2" placeholder="@Html.T("وصف مختصر عن محتوى الدرس...", "Brief description of lesson content...")"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">@Html.T("المدة (بالدقائق)", "Duration (minutes)")</label>
                            <input type="number" class="form-control" id="newLessonDuration" min="0" placeholder="10">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="newLessonPreview">
                                <label class="form-check-label" for="newLessonPreview">
                                    @Html.T("السماح بالمعاينة المجانية", "Allow free preview")
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ===== VIDEO FIELDS ===== -->
                    <div id="videoFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">@Html.T("مصدر الفيديو", "Video source")</label>
                                        <select class="form-select" id="newLessonVideoSource" onchange="toggleVideoSourceFields()">
                                            <option value="Library">@Html.T("من مكتبة الوسائط", "From media library")</option>
                                            <option value="YouTube">@Html.T("رابط YouTube", "YouTube link")</option>
                                            <option value="Vimeo">@Html.T("رابط Vimeo", "Vimeo link")</option>
                                            <option value="URL">@Html.T("رابط مباشر", "Direct link")</option>
                                        </select>
                                    </div>

                                    <!-- Media Library Picker -->
                                    <div class="col-12" id="videoLibraryField" style="display: none;">
                                        <label class="form-label fw-bold">@Html.T("اختر فيديو من المكتبة", "Choose video from library")</label>
                                        <input type="hidden" id="lessonVideoUrlHidden" value="">
                                        <div class="media-picker-preview rounded-3 border position-relative mb-3"
                                             style="aspect-ratio: 16/9; background: #f8f9fa; overflow: hidden;"
                                             id="lessonVideoPreview">
                                            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" id="lessonVideoPlaceholder">
                                                <i class="feather-video fs-1 mb-2"></i>
                                                <span>@Html.T("لا يوجد فيديو محدد", "No video selected")</span>
                                            </div>
                                            <img src="" alt="" class="w-100 h-100 object-fit-cover d-none" id="lessonVideoPreviewImage">
                                            <video src="" class="w-100 h-100 object-fit-cover d-none" id="lessonVideoPreviewVideo" controls></video>
                                            <button type="button" class="btn btn-sm btn-danger position-absolute d-none" style="top: 8px; left: 8px; z-index: 10;"
                                                    onclick="clearLessonVideo()" title="@Html.T("إزالة", "Remove")" id="lessonVideoClearBtn">
                                                <i class="feather-x"></i>
                                            </button>
                                        </div>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-primary flex-fill" onclick="openLessonMediaLibrary()">
                                                <i class="feather-folder me-2"></i>
                                                @Html.T("اختر من المكتبة", "Choose from library")
                                            </button>
                                            <button type="button" class="btn btn-outline-primary flex-fill" onclick="openLessonMediaUpload()">
                                                <i class="feather-upload me-2"></i>
                                                @Html.T("رفع جديد", "Upload new")
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-2">
                                            <i class="feather-info me-1"></i>
                                            @Html.T("اختر فيديو من مكتبتك أو ارفع فيديو جديد", "Choose from your library or upload a new video")
                                        </small>
                                    </div>

                                    <!-- Video URL Input -->
                                    <div class="col-12" id="videoUrlField" style="display: none;">
                                        <label class="form-label fw-bold">@Html.T("رابط الفيديو", "Video URL")</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newLessonVideoUrl"
                                                   placeholder="https://youtube.com/watch?v=..."
                                                   oninput="debouncePreviewVideo()">
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearLessonVideoUrl()" title="@Html.T("مسح", "Clear")">
                                                <i class="feather-x"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted" id="videoUrlHint">@Html.T("YouTube, Vimeo, أو رابط مباشر", "YouTube, Vimeo, or direct link")</small>
                                    </div>

                                    <!-- Video Preview -->
                                    <div class="col-12" id="videoPreviewContainer" style="display: none;">
                                        <label class="form-label fw-bold">@Html.T("معاينة الفيديو", "Video preview")</label>
                                        <div class="border rounded-3 overflow-hidden" style="aspect-ratio: 16/9; background: #000;">
                                            <iframe id="videoPreviewFrame"
                                                    class="w-100 h-100"
                                                    frameborder="0"
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                    allowfullscreen>
                                            </iframe>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TEXT / ARTICLE FIELDS ===== -->
                    <div id="textFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-body">
                                <label class="form-label fw-bold">@Html.T("محتوى الدرس", "Lesson content")</label>
                                <textarea class="form-control" id="newLessonHtmlContent" rows="6"
                                          placeholder="@Html.T("أدخل النص أو المحتوى HTML للدرس...", "Enter text or HTML content for the lesson...")"></textarea>
                                <small class="text-muted mt-1 d-block">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("المحرر المتقدم متاح في صفحة تعديل الدرس", "Advanced editor is available on the lesson edit page")
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- ===== FILE FIELDS (PDF / AUDIO / DOWNLOAD) ===== -->
                    <div id="fileFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-body">
                                <label class="form-label fw-bold" id="fileFieldLabel">@Html.T("رابط الملف", "File URL")</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="newLessonFileUrl"
                                           placeholder="@Html.T("https://... أو اختر من المكتبة", "https://... or choose from library")">
                                    <button type="button" class="btn btn-outline-primary" onclick="openLessonFileLibrary()" title="@Html.T("اختر من المكتبة", "Choose from library")">
                                        <i class="feather-folder"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="lessonFileUrlHidden" value="">
                                <small class="text-muted" id="fileFieldHint">@Html.T("أدخل رابط الملف أو اختر من مكتبة الوسائط", "Enter file URL or choose from media library")</small>
                                <div class="form-check mt-2" id="fileDownloadableCheckbox" style="display: none;">
                                    <input class="form-check-input" type="checkbox" id="newLessonDownloadable" checked>
                                    <label class="form-check-label" for="newLessonDownloadable">@Html.T("السماح للطالب بتحميل الملف", "Allow student to download file")</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== EXTERNAL LINK FIELDS ===== -->
                    <div id="externalLinkFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-body">
                                <label class="form-label fw-bold">@Html.T("الرابط الخارجي", "External link") <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="feather-link"></i></span>
                                    <input type="url" class="form-control" id="newLessonExternalUrl"
                                           placeholder="https://example.com" dir="ltr">
                                </div>
                                <div id="externalUrlValidation" class="invalid-feedback">@Html.T("يرجى إدخال رابط صحيح يبدأ بـ https://", "Please enter a valid URL starting with https://")</div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== QUIZ SETTINGS ===== -->
                    <div id="quizFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-header bg-soft-warning">
                                <h6 class="card-title mb-0">
                                    <i class="feather-help-circle me-2 text-warning"></i>
                                    @Html.T("إعدادات الاختبار", "Quiz settings")
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">@Html.T("درجة النجاح (%)", "Passing score (%)")</label>
                                        <input type="range" class="form-range" id="quizPassingScore" min="0" max="100" value="70"
                                               oninput="document.getElementById('quizPassingScoreValue').textContent = this.value + '%'">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">0%</small>
                                            <span class="badge bg-soft-primary text-primary" id="quizPassingScoreValue">70%</span>
                                            <small class="text-muted">100%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">@Html.T("مدة الاختبار (دقائق)", "Quiz duration (minutes)")</label>
                                        <input type="number" class="form-control" id="quizTimeLimit" min="0" placeholder="@Html.T("بدون حد زمني", "No time limit")">
                                        <small class="text-muted">@Html.T("اتركه فارغاً لعدم تحديد مدة", "Leave empty for no limit")</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">@Html.T("عدد المحاولات", "Number of attempts")</label>
                                        <input type="number" class="form-control" id="quizMaxAttempts" min="0" placeholder="@Html.T("غير محدود", "Unlimited")">
                                        <small class="text-muted">@Html.T("اتركه فارغاً لمحاولات غير محدودة", "Leave empty for unlimited attempts")</small>
                                    </div>
                                    <div class="col-md-6"></div>

                                    <!-- Quiz toggles -->
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="quizShuffleQuestions">
                                            <label class="form-check-label" for="quizShuffleQuestions">@Html.T("خلط الأسئلة", "Shuffle questions")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="quizShowCorrectAnswers" checked>
                                            <label class="form-check-label" for="quizShowCorrectAnswers">@Html.T("عرض الإجابات الصحيحة", "Show correct answers")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="quizAllowBackNavigation" checked>
                                            <label class="form-check-label" for="quizAllowBackNavigation">@Html.T("العودة للأسئلة السابقة", "Allow back navigation")</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Proctoring section -->
                                <div class="mt-4">
                                    <div class="d-flex align-items-center cursor-pointer" data-bs-toggle="collapse" data-bs-target="#proctoringSection">
                                        <i class="feather-shield me-2 text-danger"></i>
                                        <h6 class="mb-0 fw-bold">@Html.T("إعدادات المراقبة", "Proctoring settings")</h6>
                                        <i class="feather-chevron-down ms-auto"></i>
                                    </div>
                                    <div class="collapse mt-3" id="proctoringSection">
                                        <div class="card bg-light border-0">
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="proctoringEnabled">
                                                            <label class="form-check-label" for="proctoringEnabled">@Html.T("تفعيل المراقبة", "Enable proctoring")</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="proctoringPreventTabSwitch">
                                                            <label class="form-check-label" for="proctoringPreventTabSwitch">@Html.T("منع تبديل التبويبات", "Prevent tab switching")</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="proctoringPreventCopyPaste">
                                                            <label class="form-check-label" for="proctoringPreventCopyPaste">@Html.T("منع النسخ واللصق", "Prevent copy/paste")</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="proctoringRequireFullscreen">
                                                            <label class="form-check-label" for="proctoringRequireFullscreen">@Html.T("إجبار وضع ملء الشاشة", "Require fullscreen")</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="proctoringRequireWebcam">
                                                            <label class="form-check-label" for="proctoringRequireWebcam">@Html.T("تفعيل كاميرا الويب", "Require webcam")</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Info box -->
                                <div class="alert alert-soft-info mt-3 mb-0 d-flex align-items-center">
                                    <i class="feather-info me-3 fs-4"></i>
                                    <div>
                                        <strong>@Html.T("ملاحظة:", "Note:")</strong> @Html.T("بعد الحفظ، يمكنك إضافة الأسئلة والاستيراد من بنك الأسئلة.", "After saving, you can add questions and import from the question bank.")
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== ASSIGNMENT SETTINGS ===== -->
                    <div id="assignmentFields" class="type-fields" style="display: none;">
                        <div class="card stretch stretch-full mb-3">
                            <div class="card-header bg-soft-success">
                                <h6 class="card-title mb-0">
                                    <i class="feather-edit-3 me-2 text-success"></i>
                                    @Html.T("إعدادات التكليف", "Assignment settings")
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">@Html.T("الدرجة القصوى", "Maximum score")</label>
                                        <input type="number" class="form-control" id="assignmentMaxPoints" min="1" max="1000" value="100">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">@Html.T("مهلة التسليم (أيام)", "Submission deadline (days)")</label>
                                        <input type="number" class="form-control" id="assignmentDueDays" min="1" value="7">
                                    </div>

                                    <!-- Assignment toggles -->
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="assignmentAllowLate" onchange="toggleAssignmentLateFields()">
                                            <label class="form-check-label" for="assignmentAllowLate">@Html.T("السماح بالتسليم المتأخر", "Allow late submission")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="assignmentAllowTextSubmission" checked>
                                            <label class="form-check-label" for="assignmentAllowTextSubmission">@Html.T("السماح بتسليم نصي", "Allow text submission")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="assignmentAllowFileUpload" checked onchange="toggleAssignmentFileFields()">
                                            <label class="form-check-label" for="assignmentAllowFileUpload">@Html.T("السماح برفع ملفات", "Allow file upload")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="assignmentAllowResubmission">
                                            <label class="form-check-label" for="assignmentAllowResubmission">@Html.T("السماح بإعادة التسليم", "Allow resubmission")</label>
                                        </div>
                                    </div>

                                    <!-- Late penalty (shown when Allow Late is checked) -->
                                    <div class="col-md-6" id="latePenaltyField" style="display: none;">
                                        <label class="form-label fw-bold">@Html.T("نسبة الخصم للتسليم المتأخر (%)", "Late submission penalty (%)")</label>
                                        <input type="number" class="form-control" id="assignmentLatePenalty" min="0" max="100" value="10">
                                    </div>

                                    <!-- File upload settings (shown when Allow File Upload is checked) -->
                                    <div class="col-12" id="fileUploadSettings">
                                        <div class="card bg-light border-0 mt-2">
                                            <div class="card-body">
                                                <h6 class="fw-bold mb-3">
                                                    <i class="feather-upload me-2"></i>
                                                    @Html.T("إعدادات رفع الملفات", "File upload settings")
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-12">
                                                        <label class="form-label">@Html.T("أنواع الملفات المقبولة", "Accepted file types")</label>
                                                        <input type="text" class="form-control" id="assignmentAcceptedFileTypes"
                                                               value=".pdf,.doc,.docx,.zip,.rar" placeholder=".pdf,.doc,.docx,.zip">
                                                        <small class="text-muted">@Html.T("افصل بين الأنواع بفواصل", "Separate types with commas")</small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">@Html.T("الحد الأقصى لحجم الملف (MB)", "Max file size (MB)")</label>
                                                        <input type="number" class="form-control" id="assignmentMaxFileSize" min="1" value="50">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">@Html.T("الحد الأقصى لعدد الملفات", "Max number of files")</label>
                                                        <input type="number" class="form-control" id="assignmentMaxFiles" min="1" value="5">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== LIVE CLASS PLACEHOLDER ===== -->
                    <div id="liveClassFields" class="type-fields" style="display: none;">
                        <div class="alert alert-info mb-3 d-flex align-items-center">
                            <i class="feather-info me-3 fs-4"></i>
                            <div>
                                <strong>@Html.T("ملاحظة:", "Note:")</strong> @Html.T("سيتم إنشاء الدرس الآن. يمكنك إعداد تفاصيل البث المباشر من صفحة تعديل الدرس بعد الحفظ.", "The lesson will be created now. You can configure live session details from the lesson edit page after saving.")
                            </div>
                        </div>
                    </div>

                    <!-- ===== CONTENT SCHEDULING (Drip) ===== -->
                    @if (enableDrip)
                    {
                        <div class="mt-3">
                            <div class="d-flex align-items-center cursor-pointer" data-bs-toggle="collapse" data-bs-target="#contentDripSection">
                                <i class="feather-clock me-2 text-info"></i>
                                <h6 class="mb-0 fw-bold">@Html.T("جدولة المحتوى", "Content scheduling")</h6>
                                <i class="feather-chevron-down ms-auto"></i>
                            </div>
                            <div class="collapse mt-3" id="contentDripSection">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">@Html.T("نوع الجدولة", "Schedule type")</label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dripType" id="dripImmediate" value="Immediate" checked onchange="toggleDripModalFields()">
                                                    <label class="form-check-label" for="dripImmediate">@Html.T("متاح فوراً", "Available immediately")</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dripType" id="dripDaysAfter" value="DaysAfterEnrollment" onchange="toggleDripModalFields()">
                                                    <label class="form-check-label" for="dripDaysAfter">@Html.T("بعد أيام من التسجيل", "Days after enrollment")</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dripType" id="dripAfterPrevious" value="AfterPreviousCompletion" onchange="toggleDripModalFields()">
                                                    <label class="form-check-label" for="dripAfterPrevious">@Html.T("بعد إكمال الدرس السابق", "After previous lesson completion")</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="dripType" id="dripSpecificDate" value="SpecificDate" onchange="toggleDripModalFields()">
                                                    <label class="form-check-label" for="dripSpecificDate">@Html.T("في تاريخ محدد", "On specific date")</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="dripDaysField" style="display: none;" class="mb-3">
                                            <label class="form-label">@Html.T("عدد الأيام بعد التسجيل", "Days after enrollment")</label>
                                            <input type="number" class="form-control" id="dripDaysValue" min="1" placeholder="@Html.T("مثال: 7", "e.g. 7")">
                                        </div>
                                        <div id="dripDateField" style="display: none;" class="mb-3">
                                            <label class="form-label">@Html.T("تاريخ الإتاحة", "Availability date")</label>
                                            <input type="datetime-local" class="form-control" id="dripDateValue">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- ========== STEP 3: Advanced Setup ========== -->
                <div id="lessonStep3" style="display: none;">
                    <!-- Progress indicator -->
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-indicator completed">
                            <span class="step-number"><i class="feather-check"></i></span>
                            <span class="step-label">@Html.T("نوع الدرس", "Lesson type")</span>
                        </div>
                        <div class="step-line active"></div>
                        <div class="step-indicator completed">
                            <span class="step-number"><i class="feather-check"></i></span>
                            <span class="step-label">@Html.T("تفاصيل الدرس", "Lesson details")</span>
                        </div>
                        <div class="step-line active"></div>
                        <div class="step-indicator active">
                            <span class="step-number">3</span>
                            <span class="step-label">@Html.T("إعداد متقدم", "Advanced settings")</span>
                        </div>
                    </div>

                    <!-- Dynamic content area populated by loadStep3Content() -->
                    <div id="step3Content">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">@Html.T("جارٍ التحميل...", "Loading...")</span>
                            </div>
                            <p class="text-muted mt-3">@Html.T("جارٍ تحميل الإعدادات المتقدمة...", "Loading advanced settings...")</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="modal-footer" id="lessonModalFooter">
                <!-- Step 1 footer (hidden, step 1 navigates by clicking type cards) -->
                <div id="step1Footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                </div>
                <!-- Step 2 footer -->
                <div id="step2Footer" style="display: none;" class="d-flex justify-content-between w-100 align-items-center">
                    <button type="button" class="btn btn-light" onclick="goToStep1()">
                        <i class="feather-arrow-right me-2"></i>
                        @Html.T("رجوع", "Back")
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" id="goToStep3Btn" style="display: none;" onclick="goToStep3FromEdit()">
                            <i class="feather-settings me-2"></i>
                            @Html.T("إعداد متقدم", "Advanced settings")
                        </button>
                        <button type="button" class="btn btn-primary" onclick="addLesson()" id="saveLessonBtn">
                            <i class="feather-plus me-2"></i>
                            @Html.T("حفظ الدرس", "Save lesson")
                        </button>
                    </div>
                </div>
                <!-- Step 3 footer -->
                <div id="step3Footer" style="display: none;" class="d-flex justify-content-between w-100">
                    <button type="button" class="btn btn-light" onclick="skipStep3AndFinish()">
                        <i class="feather-skip-forward me-2"></i>
                        @Html.T("تخطي والإنهاء", "Skip and finish")
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveStep3AndFinish()" id="saveStep3Btn">
                        <i class="feather-check me-2"></i>
                        @Html.T("حفظ والإنهاء", "Save and finish")
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="liveToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="feather-check-circle text-success me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">@Html.T("نجاح", "Success")</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="@Html.T("إغلاق", "Close")"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<style>
    .module-card {
        transition: all 0.3s ease;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .module-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .lesson-row {
        transition: background-color 0.2s ease;
    }

    .lesson-row:hover {
        background-color: #f9fafb;
    }

    .cursor-move {
        cursor: move;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .drag-handle:hover {
        color: #004aad !important;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: #004aad !important;
    }

    .sortable-chosen {
        box-shadow: 0 4px 20px rgba(0, 74, 173, 0.3);
    }

    .empty-lessons {
        background: #f9fafb;
        border-radius: 8px;
    }

    .modal-content {
        border-radius: 12px;
    }

    .btn-primary {
        background: var(--gradient-primary, linear-gradient(135deg, #004aad 0%, #0066cc 50%, #3385d6 100%));
        border: none;
    }

    .btn-primary:hover {
        box-shadow: 0 4px 12px rgba(0, 74, 173, 0.3);
    }

    /* Step indicator */
    .step-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .step-indicator.active .step-number {
        background: linear-gradient(135deg, #004aad 0%, #0066cc 100%);
        color: #fff;
    }

    .step-indicator.completed .step-number {
        background: #28a745;
        color: #fff;
    }

    .step-label {
        font-size: 13px;
        color: #6c757d;
        font-weight: 500;
    }

    .step-indicator.active .step-label {
        color: #004aad;
        font-weight: 600;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background: #e9ecef;
        margin: 0 16px;
        transition: all 0.3s ease;
    }

    .step-line.active {
        background: linear-gradient(90deg, #28a745, #004aad);
    }

    /* Lesson Type Cards */
    .lesson-type-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fff;
        position: relative;
        overflow: hidden;
    }

    .lesson-type-card::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        transition: all 0.3s ease;
    }

    .lesson-type-card[data-type="Video"]::before { background: #004aad; }
    .lesson-type-card[data-type="Article"]::before { background: #17a2b8; }
    .lesson-type-card[data-type="Text"]::before { background: #17a2b8; }
    .lesson-type-card[data-type="PDF"]::before { background: #dc3545; }
    .lesson-type-card[data-type="Audio"]::before { background: #6f42c1; }
    .lesson-type-card[data-type="Quiz"]::before { background: #ffc107; }
    .lesson-type-card[data-type="Assignment"]::before { background: #28a745; }
    .lesson-type-card[data-type="LiveClass"]::before { background: #dc3545; }
    .lesson-type-card[data-type="Download"]::before { background: #6c757d; }
    .lesson-type-card[data-type="ExternalLink"]::before { background: #17a2b8; }

    .lesson-type-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: transparent;
    }

    .lesson-type-card:active {
        transform: translateY(-1px);
    }

    .ltc-icon {
        font-size: 28px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .ltc-body {
        flex: 1;
        min-width: 0;
    }

    .ltc-title {
        font-weight: 700;
        font-size: 14px;
        color: #1a1a2e;
        margin-bottom: 2px;
    }

    .ltc-desc {
        font-size: 12px;
        color: #6c757d;
        line-height: 1.3;
    }

    /* Step transition animation */
    #lessonStep1, #lessonStep2, #lessonStep3 {
        animation: stepFadeIn 0.3s ease;
    }

    @@keyframes stepFadeIn {
        from {
            opacity: 0;
            transform: translateX(10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Alert soft variant */
    .alert-soft-info {
        background-color: rgba(23, 162, 184, 0.1);
        border: none;
        color: #17a2b8;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .bg-soft-purple {
        background-color: rgba(111, 66, 193, 0.1) !important;
    }

    /* ===== Step 3 Advanced Setup Styles ===== */
    .quiz-questions-list .question-item {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 10px;
        background: #fff;
        transition: all 0.2s ease;
    }

    .quiz-questions-list .question-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: #dee2e6;
    }

    .question-type-badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 6px;
    }

    .difficulty-stars .star {
        color: #e9ecef;
        font-size: 12px;
    }

    .difficulty-stars .star.active {
        color: #ffc107;
    }

    .option-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fafafa;
    }

    .option-row .form-control {
        flex: 1;
    }

    .matching-pair-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .bank-question-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 14px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .bank-question-item:hover {
        background-color: #f8f9fa;
    }

    .bank-question-item .form-check-input:checked ~ .form-check-label {
        color: #004aad;
        font-weight: 600;
    }

    .step3-section-card {
        border-radius: 12px;
        border: 1px solid #e9ecef;
        overflow: hidden;
    }

    .step3-section-card .card-header {
        padding: 12px 16px;
    }

    .resource-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #fff;
    }

    .resource-item:hover {
        background-color: #f8f9fa;
    }

    /* Content drip module button */
    .content-drip-btn {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 6px;
    }

    .drip-rule-item {
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13px;
    }

    #step3Content .nav-tabs .nav-link {
        font-size: 13px;
        padding: 8px 16px;
    }

    #step3Content .nav-tabs .nav-link.active {
        font-weight: 600;
        color: #004aad;
        border-bottom-color: #004aad;
    }

    .empty-questions-state {
        padding: 40px 20px;
        text-align: center;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
    }
</style>

<script>
    const courseId = @courseId;
    const enableContentDrip = @(enableDrip ? "true" : "false");
    const antiForgeryToken = document.querySelector('[name="__RequestVerificationToken"]')?.value || '';
    const i18nStep3 = {
        saveChanges: '@Html.Raw(Html.T("حفظ التعديلات", "Save changes").Replace("'", "\\'"))',
        saveLesson: '@Html.Raw(Html.T("حفظ الدرس", "Save lesson").Replace("'", "\\'"))',
        saving: '@Html.Raw(Html.T("جارٍ الحفظ...", "Saving...").Replace("'", "\\'"))'
    };

    // ========== TOAST NOTIFICATION ==========
    function showToast(title, message, type) {
        const toastEl = document.getElementById('liveToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastBody = document.getElementById('toastBody');
        const toastIcon = document.getElementById('toastIcon');

        toastTitle.textContent = title;
        toastBody.textContent = message;

        // Reset classes
        toastIcon.className = 'me-2';

        if (type === 'success') {
            toastIcon.classList.add('feather-check-circle', 'text-success');
        } else if (type === 'error') {
            toastIcon.classList.add('feather-x-circle', 'text-danger');
        } else if (type === 'warning') {
            toastIcon.classList.add('feather-alert-triangle', 'text-warning');
        } else {
            toastIcon.classList.add('feather-info', 'text-info');
        }

        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
    }

    // ========== TWO-STEP MODAL LOGIC ==========
    const lessonTypeConfig = {
        'Video':        { icon: 'feather-video',         name: 'فيديو',       color: 'primary' },
        'Article':      { icon: 'feather-book-open',     name: 'مقال',        color: 'info' },
        'Text':         { icon: 'feather-file-text',     name: 'نص',          color: 'info' },
        'PDF':          { icon: 'feather-file',          name: 'ملف PDF',     color: 'danger' },
        'Audio':        { icon: 'feather-headphones',    name: 'صوتي',        color: 'secondary' },
        'Quiz':         { icon: 'feather-help-circle',   name: 'اختبار',      color: 'warning' },
        'Assignment':   { icon: 'feather-edit-3',        name: 'تكليف',       color: 'success' },
        'LiveClass':    { icon: 'feather-play-circle',   name: 'بث مباشر',    color: 'danger' },
        'Download':     { icon: 'feather-download',      name: 'ملف للتحميل', color: 'secondary' },
        'ExternalLink': { icon: 'feather-external-link', name: 'رابط خارجي',  color: 'info' }
    };

    function selectLessonType(type) {
        document.getElementById('selectedLessonType').value = type;

        const config = lessonTypeConfig[type];
        document.getElementById('selectedTypeIcon').className = config.icon + ' me-1';
        document.getElementById('selectedTypeName').textContent = config.name;
        document.getElementById('selectedTypeBadge').className = `badge bg-soft-${config.color} text-${config.color} fs-12`;
        document.getElementById('lessonModalTitleText').textContent = `إضافة ${config.name} جديد`;

        // Expand modal for Quiz/Assignment
        const dialog = document.getElementById('addLessonModalDialog');
        if (type === 'Quiz' || type === 'Assignment') {
            dialog.classList.remove('modal-lg');
            dialog.classList.add('modal-xl');
        } else {
            dialog.classList.remove('modal-xl');
            dialog.classList.add('modal-lg');
        }

        // Hide all type-specific fields
        document.querySelectorAll('.type-fields').forEach(el => el.style.display = 'none');

        // Show relevant fields
        switch (type) {
            case 'Video':
                document.getElementById('videoFields').style.display = 'block';
                toggleVideoSourceFields();
                break;
            case 'Text':
            case 'Article':
                document.getElementById('textFields').style.display = 'block';
                break;
            case 'PDF':
                document.getElementById('fileFields').style.display = 'block';
                document.getElementById('fileFieldLabel').textContent = 'رابط ملف PDF';
                document.getElementById('fileFieldHint').textContent = 'أدخل رابط ملف PDF أو اختر من مكتبة الوسائط';
                document.getElementById('fileDownloadableCheckbox').style.display = 'block';
                break;
            case 'Audio':
                document.getElementById('fileFields').style.display = 'block';
                document.getElementById('fileFieldLabel').textContent = 'رابط الملف الصوتي';
                document.getElementById('fileFieldHint').textContent = 'أدخل رابط الملف الصوتي أو اختر من مكتبة الوسائط';
                document.getElementById('fileDownloadableCheckbox').style.display = 'none';
                break;
            case 'Download':
                document.getElementById('fileFields').style.display = 'block';
                document.getElementById('fileFieldLabel').textContent = 'رابط الملف';
                document.getElementById('fileFieldHint').textContent = 'أدخل رابط الملف للتحميل أو اختر من مكتبة الوسائط';
                document.getElementById('fileDownloadableCheckbox').style.display = 'block';
                break;
            case 'ExternalLink':
                document.getElementById('externalLinkFields').style.display = 'block';
                break;
            case 'Quiz':
                document.getElementById('quizFields').style.display = 'block';
                break;
            case 'Assignment':
                document.getElementById('assignmentFields').style.display = 'block';
                toggleAssignmentFileFields();
                break;
            case 'LiveClass':
                document.getElementById('liveClassFields').style.display = 'block';
                break;
        }

        // Transition to step 2
        document.getElementById('lessonStep1').style.display = 'none';
        document.getElementById('lessonStep3').style.display = 'none';
        document.getElementById('lessonStep2').style.display = 'block';
        document.getElementById('step1Footer').style.display = 'none';
        document.getElementById('step3Footer').style.display = 'none';
        document.getElementById('step2Footer').style.display = 'flex';

        // Focus title
        setTimeout(() => {
            document.getElementById('newLessonTitle').focus();
        }, 300);
    }

    function goToStep1() {
        document.getElementById('lessonStep2').style.display = 'none';
        document.getElementById('lessonStep3').style.display = 'none';
        document.getElementById('lessonStep1').style.display = 'block';
        document.getElementById('step2Footer').style.display = 'none';
        document.getElementById('step3Footer').style.display = 'none';
        document.getElementById('step1Footer').style.display = 'block';
        document.getElementById('lessonModalTitleText').textContent = 'اختر نوع الدرس';

        // Reset dialog size
        const dialog = document.getElementById('addLessonModalDialog');
        dialog.classList.remove('modal-xl');
        dialog.classList.add('modal-lg');
    }

    function showAddLessonModal(moduleId) {
        document.getElementById('newLessonModuleId').value = moduleId;
        // Reset edit mode
        window._editingLessonId = null;
        window._isEditModeStep3 = false;
        const goToStep3Btn = document.getElementById('goToStep3Btn');
        if (goToStep3Btn) goToStep3Btn.style.display = 'none';
        const saveBtn = document.getElementById('saveLessonBtn');
        saveBtn.innerHTML = '<i class="feather-plus me-2"></i>' + i18nStep3.saveLesson;
        saveBtn.onclick = function() { addLesson(); };

        // Reset all form fields
        document.getElementById('selectedLessonType').value = '';
        document.getElementById('newLessonTitle').value = '';
        document.getElementById('newLessonDescription').value = '';
        document.getElementById('newLessonDuration').value = '10';
        document.getElementById('newLessonPreview').checked = false;

        // Reset video fields
        document.getElementById('newLessonVideoSource').value = 'Library';
        document.getElementById('newLessonVideoUrl').value = '';
        document.getElementById('lessonVideoUrlHidden').value = '';
        clearLessonVideo();
        const videoPreview = document.getElementById('videoPreviewContainer');
        if (videoPreview) videoPreview.style.display = 'none';

        // Reset text fields
        const htmlContent = document.getElementById('newLessonHtmlContent');
        if (htmlContent) htmlContent.value = '';

        // Reset file fields
        const fileUrl = document.getElementById('newLessonFileUrl');
        if (fileUrl) fileUrl.value = '';
        const fileHidden = document.getElementById('lessonFileUrlHidden');
        if (fileHidden) fileHidden.value = '';
        const downloadable = document.getElementById('newLessonDownloadable');
        if (downloadable) downloadable.checked = true;

        // Reset external link
        const extUrl = document.getElementById('newLessonExternalUrl');
        if (extUrl) extUrl.value = '';

        // Reset quiz fields
        document.getElementById('quizPassingScore').value = 70;
        document.getElementById('quizPassingScoreValue').textContent = '70%';
        document.getElementById('quizTimeLimit').value = '';
        document.getElementById('quizMaxAttempts').value = '';
        document.getElementById('quizShuffleQuestions').checked = false;
        document.getElementById('quizShowCorrectAnswers').checked = true;
        document.getElementById('quizAllowBackNavigation').checked = true;
        document.getElementById('proctoringEnabled').checked = false;
        document.getElementById('proctoringPreventTabSwitch').checked = false;
        document.getElementById('proctoringPreventCopyPaste').checked = false;
        document.getElementById('proctoringRequireFullscreen').checked = false;
        document.getElementById('proctoringRequireWebcam').checked = false;

        // Reset assignment fields
        document.getElementById('assignmentMaxPoints').value = 100;
        document.getElementById('assignmentDueDays').value = 7;
        document.getElementById('assignmentAllowLate').checked = false;
        document.getElementById('assignmentAllowTextSubmission').checked = true;
        document.getElementById('assignmentAllowFileUpload').checked = true;
        document.getElementById('assignmentAllowResubmission').checked = false;
        document.getElementById('assignmentLatePenalty').value = 10;
        document.getElementById('latePenaltyField').style.display = 'none';
        document.getElementById('assignmentAcceptedFileTypes').value = '.pdf,.doc,.docx,.zip,.rar';
        document.getElementById('assignmentMaxFileSize').value = 50;
        document.getElementById('assignmentMaxFiles').value = 5;

        // Reset drip
        if (enableContentDrip) {
            document.getElementById('dripImmediate').checked = true;
            toggleDripModalFields();
        }

        // Reset step 3
        document.getElementById('lessonStep3').style.display = 'none';
        document.getElementById('step3Footer').style.display = 'none';
        document.getElementById('step3Content').innerHTML = '';
        window._createdLessonId = null;
        window._createdQuizId = null;
        window._createdAssignmentId = null;
        window._createdLessonType = null;
        step3QuizQuestions = [];
        step3LessonResources = [];

        // Start at step 1
        goToStep1();

        new bootstrap.Modal(document.getElementById('addLessonModal')).show();
    }

    // ========== EDIT LESSON MODAL ==========
    window._editingLessonId = null;

    async function showEditLessonModal(lessonId) {
        // Prevent any form submission that might occur
        if (event) { event.preventDefault(); event.stopPropagation(); }
        try {
            const response = await fetch(`/Instructor/Courses/QuickGetLesson?id=${lessonId}`);
            const result = await response.json();

            if (!result.success) {
                showToast('خطأ', result.message || 'فشل تحميل بيانات الدرس', 'error');
                return;
            }

            const lesson = result.lesson;

            // Reset form first
            document.getElementById('selectedLessonType').value = lesson.type;
            document.getElementById('newLessonModuleId').value = lesson.moduleId;
            document.getElementById('newLessonTitle').value = lesson.title || '';
            document.getElementById('newLessonDescription').value = lesson.description || '';
            document.getElementById('newLessonDuration').value = Math.floor((lesson.durationSeconds || 0) / 60) || 10;
            document.getElementById('newLessonPreview').checked = lesson.isPreviewable || false;

            // Set type-specific fields
            if (lesson.videoUrl) {
                const videoUrlEl = document.getElementById('newLessonVideoUrl');
                if (videoUrlEl) videoUrlEl.value = lesson.videoUrl;
                const videoHidden = document.getElementById('lessonVideoUrlHidden');
                if (videoHidden) videoHidden.value = lesson.videoUrl;
            }
            const htmlContent = document.getElementById('newLessonHtmlContent');
            if (htmlContent && lesson.htmlContent) htmlContent.value = lesson.htmlContent;

            const fileUrl = document.getElementById('newLessonFileUrl');
            if (fileUrl && lesson.fileUrl) fileUrl.value = lesson.fileUrl;
            const fileHidden = document.getElementById('lessonFileUrlHidden');
            if (fileHidden && lesson.fileUrl) fileHidden.value = lesson.fileUrl;
            const downloadable = document.getElementById('newLessonDownloadable');
            if (downloadable) downloadable.checked = lesson.isDownloadable || false;

            // Store editing state
            window._editingLessonId = lessonId;

            // Always set quiz/assignment IDs from API so they are never stale when switching between lessons
            window._createdQuizId = result.quizId ?? null;
            window._createdAssignmentId = result.assignmentId ?? null;

            // Show type-specific fields
            document.querySelectorAll('.type-fields').forEach(el => el.style.display = 'none');
            const config = lessonTypeConfig[lesson.type];
            if (config) {
                switch (lesson.type) {
                    case 'Video': document.getElementById('videoFields').style.display = 'block'; break;
                    case 'Text': case 'Article': document.getElementById('textFields').style.display = 'block'; break;
                    case 'PDF': case 'Audio': case 'Download': document.getElementById('fileFields').style.display = 'block'; break;
                    case 'ExternalLink': document.getElementById('externalLinkFields').style.display = 'block'; break;
                    case 'Quiz': document.getElementById('quizFields').style.display = 'block'; break;
                    case 'Assignment': document.getElementById('assignmentFields').style.display = 'block'; break;
                    case 'LiveClass': document.getElementById('liveClassFields').style.display = 'block'; break;
                }

                // Set type badge
                document.getElementById('selectedTypeIcon').className = config.icon + ' me-1';
                document.getElementById('selectedTypeName').textContent = config.name;
                document.getElementById('selectedTypeBadge').className = `badge bg-soft-${config.color} text-${config.color} fs-12`;
            }

            // Update modal title for edit mode
            document.getElementById('lessonModalTitleText').textContent = `تعديل الدرس`;

            // Expand modal for Quiz/Assignment
            const dialog = document.getElementById('addLessonModalDialog');
            if (lesson.type === 'Quiz' || lesson.type === 'Assignment') {
                dialog.classList.remove('modal-lg');
                dialog.classList.add('modal-xl');
            } else {
                dialog.classList.remove('modal-xl');
                dialog.classList.add('modal-lg');
            }

            // Reset step 3
            document.getElementById('lessonStep3').style.display = 'none';
            document.getElementById('step3Footer').style.display = 'none';

            // Show step 2 directly (skip type selection since type is known)
            document.getElementById('lessonStep1').style.display = 'none';
            document.getElementById('lessonStep2').style.display = 'block';
            document.getElementById('step1Footer').style.display = 'none';
            document.getElementById('step3Footer').style.display = 'none';
            document.getElementById('step2Footer').style.display = 'flex';

            // Update save button for edit mode and show Advanced button
            const saveBtn = document.getElementById('saveLessonBtn');
            saveBtn.innerHTML = '<i class="feather-check me-2"></i>' + i18nStep3.saveChanges;
            saveBtn.onclick = function() { editLesson(); };
            window._isEditModeStep3 = false;
            const goToStep3Btn = document.getElementById('goToStep3Btn');
            if (goToStep3Btn) goToStep3Btn.style.display = 'inline-block';

            new bootstrap.Modal(document.getElementById('addLessonModal')).show();
        } catch (error) {
            console.error('Error loading lesson for edit:', error);
            showToast('خطأ', 'حدث خطأ أثناء تحميل بيانات الدرس', 'error');
        }
    }

    /**
     * From edit mode (step 2): save step 2 then transition to step 3 (advanced settings) without closing the modal.
     */
    async function goToStep3FromEdit() {
        const lessonId = window._editingLessonId;
        if (!lessonId) { showToast('خطأ', 'معرف الدرس غير موجود', 'error'); return; }

        const title = document.getElementById('newLessonTitle').value.trim();
        if (!title) { showToast('تنبيه', 'يرجى إدخال عنوان الدرس', 'warning'); return; }

        const description = document.getElementById('newLessonDescription').value.trim();
        const type = document.getElementById('selectedLessonType').value;
        const duration = parseInt(document.getElementById('newLessonDuration').value) || 0;
        const isPreviewable = document.getElementById('newLessonPreview').checked;
        const isDownloadable = document.getElementById('newLessonDownloadable')?.checked || false;

        let videoUrl = null;
        let htmlContent = null;
        let fileUrl = null;
        if (type === 'Video') {
            videoUrl = (document.getElementById('lessonVideoUrlHidden')?.value || '').trim() ||
                       (document.getElementById('newLessonVideoUrl')?.value || '').trim();
        }
        if (type === 'Text' || type === 'Article') {
            htmlContent = document.getElementById('newLessonHtmlContent')?.value || '';
        }
        if (type === 'PDF' || type === 'Audio' || type === 'Download') {
            fileUrl = (document.getElementById('lessonFileUrlHidden')?.value || '').trim() ||
                      (document.getElementById('newLessonFileUrl')?.value || '').trim();
        }
        if (type === 'ExternalLink') {
            fileUrl = (document.getElementById('newLessonExternalUrl')?.value || '').trim();
        }

        const goToStep3Btn = document.getElementById('goToStep3Btn');
        if (goToStep3Btn) goToStep3Btn.disabled = true;

        try {
            const response = await fetch('/Instructor/Courses/QuickEditLesson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    id: lessonId,
                    title: title,
                    description: description || null,
                    videoUrl: videoUrl,
                    htmlContent: htmlContent,
                    fileUrl: fileUrl,
                    durationSeconds: duration * 60,
                    isPreviewable: isPreviewable,
                    isDownloadable: isDownloadable
                })
            });

            const result = await response.json();
            if (!result.success) {
                showToast('خطأ', result.message || 'فشل تحديث الدرس', 'error');
                return;
            }

            showToast('نجاح', 'تم حفظ التفاصيل', 'success');

            window._createdLessonId = window._editingLessonId;
            window._createdLessonType = type;
            window._isEditModeStep3 = true;

            document.getElementById('lessonStep1').style.display = 'none';
            document.getElementById('lessonStep2').style.display = 'none';
            document.getElementById('step1Footer').style.display = 'none';
            document.getElementById('step2Footer').style.display = 'none';
            document.getElementById('lessonStep3').style.display = 'block';
            document.getElementById('step3Footer').style.display = 'flex';

            const config = lessonTypeConfig[type];
            document.getElementById('lessonModalTitleText').textContent = config ? `إعداد متقدم - ${config.name}` : 'إعداد متقدم';

            const dialog = document.getElementById('addLessonModalDialog');
            dialog.classList.remove('modal-lg');
            dialog.classList.add('modal-xl');

            loadStep3Content(type, window._createdLessonId, window._createdQuizId, window._createdAssignmentId);
        } catch (error) {
            console.error('Error going to step 3 from edit:', error);
            showToast('خطأ', 'حدث خطأ أثناء الانتقال للإعداد المتقدم', 'error');
        } finally {
            if (goToStep3Btn) goToStep3Btn.disabled = false;
        }
    }

    async function editLesson() {
        const lessonId = window._editingLessonId;
        if (!lessonId) { showToast('خطأ', 'معرف الدرس غير موجود', 'error'); return; }

        const title = document.getElementById('newLessonTitle').value.trim();
        if (!title) { showToast('تنبيه', 'يرجى إدخال عنوان الدرس', 'warning'); return; }

        const description = document.getElementById('newLessonDescription').value.trim();
        const type = document.getElementById('selectedLessonType').value;
        const duration = parseInt(document.getElementById('newLessonDuration').value) || 0;
        const isPreviewable = document.getElementById('newLessonPreview').checked;
        const isDownloadable = document.getElementById('newLessonDownloadable')?.checked || false;

        // Collect type-specific data
        let videoUrl = null;
        let htmlContent = null;
        let fileUrl = null;

        if (type === 'Video') {
            videoUrl = (document.getElementById('lessonVideoUrlHidden')?.value || '').trim() ||
                       (document.getElementById('newLessonVideoUrl')?.value || '').trim();
        }
        if (type === 'Text' || type === 'Article') {
            htmlContent = document.getElementById('newLessonHtmlContent')?.value || '';
        }
        if (type === 'PDF' || type === 'Audio' || type === 'Download') {
            fileUrl = (document.getElementById('lessonFileUrlHidden')?.value || '').trim() ||
                      (document.getElementById('newLessonFileUrl')?.value || '').trim();
        }
        if (type === 'ExternalLink') {
            fileUrl = (document.getElementById('newLessonExternalUrl')?.value || '').trim();
        }

        const saveBtn = document.getElementById('saveLessonBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + i18nStep3.saving;

        try {
            const response = await fetch('/Instructor/Courses/QuickEditLesson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    id: lessonId,
                    title: title,
                    description: description || null,
                    videoUrl: videoUrl,
                    htmlContent: htmlContent,
                    fileUrl: fileUrl,
                    durationSeconds: duration * 60,
                    isPreviewable: isPreviewable,
                    isDownloadable: isDownloadable
                })
            });

            const result = await response.json();
            if (result.success) {
                showToast('نجاح', result.message || 'تم تحديث الدرس بنجاح', 'success');
                // Stay on step 2 so user can continue to Advanced or close manually
            } else {
                showToast('خطأ', result.message || 'فشل تحديث الدرس', 'error');
            }
        } catch (error) {
            console.error('Error editing lesson:', error);
            showToast('خطأ', 'حدث خطأ أثناء تحديث الدرس', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="feather-check me-2"></i>' + i18nStep3.saveChanges;
        }
    }

    // ========== ASSIGNMENT CONDITIONAL FIELDS ==========
    function toggleAssignmentLateFields() {
        const allowLate = document.getElementById('assignmentAllowLate').checked;
        document.getElementById('latePenaltyField').style.display = allowLate ? 'block' : 'none';
    }

    function toggleAssignmentFileFields() {
        const allowFile = document.getElementById('assignmentAllowFileUpload').checked;
        document.getElementById('fileUploadSettings').style.display = allowFile ? 'block' : 'none';
    }

    // ========== CONTENT DRIP MODAL FIELDS ==========
    function toggleDripModalFields() {
        if (!enableContentDrip) return;
        const selected = document.querySelector('input[name="dripType"]:checked');
        if (!selected) return;

        const dripDays = document.getElementById('dripDaysField');
        const dripDate = document.getElementById('dripDateField');

        if (dripDays) dripDays.style.display = 'none';
        if (dripDate) dripDate.style.display = 'none';

        switch (selected.value) {
            case 'DaysAfterEnrollment':
                if (dripDays) dripDays.style.display = 'block';
                break;
            case 'SpecificDate':
                if (dripDate) dripDate.style.display = 'block';
                break;
        }
    }

    // ========== VIDEO FUNCTIONS ==========
    let lessonVideoFromLibrary = false;
    let lessonVideoUrl = '';

    function toggleVideoSourceFields() {
        const source = document.getElementById('newLessonVideoSource').value;
        const videoLibraryField = document.getElementById('videoLibraryField');
        const videoUrlField = document.getElementById('videoUrlField');
        const videoPreviewContainer = document.getElementById('videoPreviewContainer');
        const videoUrlInput = document.getElementById('newLessonVideoUrl');
        const videoUrlHint = document.getElementById('videoUrlHint');

        videoLibraryField.style.display = 'none';
        videoUrlField.style.display = 'none';
        videoPreviewContainer.style.display = 'none';
        lessonVideoFromLibrary = false;

        switch (source) {
            case 'Library':
                videoLibraryField.style.display = 'block';
                lessonVideoFromLibrary = true;
                break;
            case 'YouTube':
                videoUrlField.style.display = 'block';
                videoUrlInput.placeholder = 'https://youtube.com/watch?v=...';
                videoUrlHint.textContent = 'مثال: https://youtube.com/watch?v=dQw4w9WgXcQ أو https://youtu.be/dQw4w9WgXcQ';
                break;
            case 'Vimeo':
                videoUrlField.style.display = 'block';
                videoUrlInput.placeholder = 'https://vimeo.com/...';
                videoUrlHint.textContent = 'مثال: https://vimeo.com/123456789';
                break;
            case 'URL':
                videoUrlField.style.display = 'block';
                videoUrlInput.placeholder = 'https://...';
                videoUrlHint.textContent = 'أدخل رابط الفيديو المباشر';
                break;
        }
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        const patterns = [
            /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,
            /youtube\.com\/watch\?v=([^"&?\/\s]{11})/,
            /youtu\.be\/([^"&?\/\s]{11})/,
            /youtube\.com\/embed\/([^"&?\/\s]{11})/
        ];
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match && match[1]) return match[1];
        }
        return null;
    }

    function extractVimeoId(url) {
        if (!url) return null;
        const match = url.match(/vimeo\.com\/(\d+)/);
        return match ? match[1] : null;
    }

    function previewLessonVideo() {
        const source = document.getElementById('newLessonVideoSource').value;
        const url = document.getElementById('newLessonVideoUrl').value.trim();
        const container = document.getElementById('videoPreviewContainer');
        const frame = document.getElementById('videoPreviewFrame');

        if (!url || source === 'Library' || source === '') {
            container.style.display = 'none';
            return;
        }

        let embedUrl = '';
        try {
            if (source === 'YouTube') {
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else {
                    container.style.display = 'none';
                    return;
                }
            } else if (source === 'Vimeo') {
                const videoId = extractVimeoId(url);
                if (videoId) {
                    embedUrl = `https://player.vimeo.com/video/${videoId}`;
                } else {
                    container.style.display = 'none';
                    return;
                }
            } else if (source === 'URL') {
                if (url.match(/\.(mp4|webm|ogg|mov)(\?|$)/i)) {
                    embedUrl = url;
                } else {
                    container.style.display = 'none';
                    return;
                }
            }

            if (embedUrl) {
                frame.src = embedUrl;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        } catch (error) {
            console.error('Error previewing video:', error);
            container.style.display = 'none';
        }
    }

    let videoPreviewTimer = null;
    function debouncePreviewVideo() {
        clearTimeout(videoPreviewTimer);
        videoPreviewTimer = setTimeout(previewLessonVideo, 800);
    }

    function clearLessonVideoUrl() {
        document.getElementById('newLessonVideoUrl').value = '';
        document.getElementById('videoPreviewContainer').style.display = 'none';
    }

    function clearLessonVideo() {
        lessonVideoFromLibrary = false;
        lessonVideoUrl = '';
        const urlInput = document.getElementById('newLessonVideoUrl');
        if (urlInput) urlInput.value = '';
        const hiddenInput = document.getElementById('lessonVideoUrlHidden');
        if (hiddenInput) hiddenInput.value = '';
        const placeholder = document.getElementById('lessonVideoPlaceholder');
        if (placeholder) placeholder.style.display = 'flex';
        const previewImage = document.getElementById('lessonVideoPreviewImage');
        if (previewImage) previewImage.classList.add('d-none');
        const previewVideo = document.getElementById('lessonVideoPreviewVideo');
        if (previewVideo) previewVideo.classList.add('d-none');
        const clearBtn = document.getElementById('lessonVideoClearBtn');
        if (clearBtn) clearBtn.classList.add('d-none');
    }

    // ========== MEDIA PICKER INTEGRATION ==========
    let lessonVideoPickerId = null;
    let hiddenInputChangeHandler = null;

    function handleMediaSelection() {
        const hiddenInput = document.getElementById('lessonVideoUrlHidden');
        const videoUrl = hiddenInput ? hiddenInput.value : '';
        if (videoUrl) {
            document.getElementById('newLessonVideoUrl').value = videoUrl;
            updateLessonVideoPreview(videoUrl);
            lessonVideoFromLibrary = true;
        }
    }

    function setupMediaSelectionListener() {
        const hiddenInput = document.getElementById('lessonVideoUrlHidden');
        if (!hiddenInput) return;

        if (hiddenInputChangeHandler) {
            hiddenInput.removeEventListener('change', hiddenInputChangeHandler);
            hiddenInput.removeEventListener('input', hiddenInputChangeHandler);
        }

        hiddenInputChangeHandler = function () {
            handleMediaSelection();
        };

        hiddenInput.addEventListener('change', hiddenInputChangeHandler);
        hiddenInput.addEventListener('input', hiddenInputChangeHandler);

        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    handleMediaSelection();
                }
            });
        });
        observer.observe(hiddenInput, { attributes: true });
        return observer;
    }

    function openLessonMediaLibrary() {
        if (typeof MediaPicker === 'undefined') {
            showToast('خطأ', 'مكتبة الوسائط غير متاحة. يرجى التأكد من تحميل الملفات المطلوبة.', 'error');
            return;
        }
        if (!lessonVideoPickerId) {
            lessonVideoPickerId = 'lessonVideo_' + Date.now();
            const tempPicker = document.createElement('div');
            tempPicker.id = 'mediaPicker_' + lessonVideoPickerId;
            tempPicker.className = 'media-picker-wrapper d-none';
            tempPicker.setAttribute('data-field-id', 'lessonVideoUrlHidden');
            tempPicker.setAttribute('data-media-type', 'Video');
            document.body.appendChild(tempPicker);
        }
        setupMediaSelectionListener();
        const modal = document.getElementById('mediaPickerModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                setTimeout(handleMediaSelection, 100);
            }, { once: true });
        }
        MediaPicker.openLibrary(lessonVideoPickerId);
    }

    let lessonFilePickerId = null;
    function openLessonFileLibrary() {
        if (typeof MediaPicker === 'undefined') {
            showToast('خطأ', 'مكتبة الوسائط غير متاحة. يرجى إدخال رابط الملف يدوياً.', 'error');
            return;
        }
        if (!lessonFilePickerId) {
            lessonFilePickerId = 'lessonFile_' + Date.now();
            const tempPicker = document.createElement('div');
            tempPicker.id = 'mediaPicker_' + lessonFilePickerId;
            tempPicker.className = 'media-picker-wrapper d-none';
            tempPicker.setAttribute('data-field-id', 'lessonFileUrlHidden');
            tempPicker.setAttribute('data-media-type', 'Document');
            document.body.appendChild(tempPicker);
        }
        const hiddenInput = document.getElementById('lessonFileUrlHidden');
        if (hiddenInput) {
            const syncFileUrl = function () {
                const url = hiddenInput.value || '';
                if (url) document.getElementById('newLessonFileUrl').value = url;
            };
            hiddenInput.addEventListener('change', syncFileUrl, { once: true });
            hiddenInput.addEventListener('input', syncFileUrl, { once: true });
        }
        const modal = document.getElementById('mediaPickerModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                setTimeout(function () {
                    const h = document.getElementById('lessonFileUrlHidden');
                    if (h && h.value) document.getElementById('newLessonFileUrl').value = h.value;
                }, 100);
            }, { once: true });
        }
        MediaPicker.openLibrary(lessonFilePickerId);
    }

    function openLessonMediaUpload() {
        if (typeof MediaPicker === 'undefined') {
            showToast('خطأ', 'مكتبة الوسائط غير متاحة.', 'error');
            return;
        }
        if (!lessonVideoPickerId) {
            lessonVideoPickerId = 'lessonVideo_' + Date.now();
            const tempPicker = document.createElement('div');
            tempPicker.id = 'mediaPicker_' + lessonVideoPickerId;
            tempPicker.className = 'media-picker-wrapper d-none';
            tempPicker.setAttribute('data-field-id', 'lessonVideoUrlHidden');
            tempPicker.setAttribute('data-media-type', 'Video');
            document.body.appendChild(tempPicker);
        }
        setupMediaSelectionListener();
        const modal = document.getElementById('mediaPickerModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                setTimeout(handleMediaSelection, 100);
            }, { once: true });
        }
        MediaPicker.openUpload(lessonVideoPickerId);
    }

    function updateLessonVideoPreview(url) {
        if (!url) return;
        const placeholder = document.getElementById('lessonVideoPlaceholder');
        const previewImage = document.getElementById('lessonVideoPreviewImage');
        const previewVideo = document.getElementById('lessonVideoPreviewVideo');
        const clearBtn = document.getElementById('lessonVideoClearBtn');

        if (url.match(/\.(mp4|webm|ogg|mov)(\?|$)/i)) {
            placeholder.style.display = 'none';
            previewImage.classList.add('d-none');
            previewVideo.src = url;
            previewVideo.classList.remove('d-none');
            clearBtn.classList.remove('d-none');
        } else if (url.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)) {
            placeholder.style.display = 'none';
            previewVideo.classList.add('d-none');
            previewImage.src = url;
            previewImage.classList.remove('d-none');
            clearBtn.classList.remove('d-none');
        } else {
            const youtubeId = extractYouTubeId(url);
            if (youtubeId) {
                placeholder.style.display = 'none';
                previewVideo.classList.add('d-none');
                previewImage.src = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
                previewImage.classList.remove('d-none');
                clearBtn.classList.remove('d-none');
            } else {
                placeholder.style.display = 'flex';
                previewImage.classList.add('d-none');
                previewVideo.classList.add('d-none');
                clearBtn.classList.add('d-none');
            }
        }
    }

    // ========== ADD MODULE ==========
    async function addModule() {
        const title = document.getElementById('newModuleTitle').value.trim();
        const description = document.getElementById('newModuleDescription').value.trim();

        if (!title) {
            showToast('تنبيه', 'يرجى إدخال عنوان الوحدة', 'warning');
            return;
        }

        try {
            const response = await fetch('/Instructor/Courses/QuickAddModule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    courseId: courseId,
                    title: title,
                    description: description
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('نجاح', 'تمت إضافة الوحدة بنجاح', 'success');
                setTimeout(() => location.reload(), 800);
            } else {
                showToast('خطأ', result.message || 'فشل إضافة الوحدة', 'error');
            }
        } catch (error) {
            console.error('Error adding module:', error);
            showToast('خطأ', 'حدث خطأ أثناء إضافة الوحدة', 'error');
        }
    }

    // ========== EDIT MODULE ==========
    async function editModule(moduleId) {
        // Load module data
        try {
            const moduleCard = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (!moduleCard) return;

            const titleEl = moduleCard.querySelector('.card-header h6');
            const descEl = moduleCard.querySelector('.card-header small');

            const currentTitle = titleEl ? titleEl.textContent.trim() : '';
            const currentDesc = descEl ? descEl.textContent.trim() : '';

            // Reuse the add module modal for editing
            document.getElementById('newModuleTitle').value = currentTitle;
            document.getElementById('newModuleDescription').value = currentDesc;

            // Change modal title and button
            const modalTitle = document.querySelector('#addModuleModal .modal-title');
            const modalBtn = document.querySelector('#addModuleModal .modal-footer .btn-primary');

            if (modalTitle) modalTitle.innerHTML = '<i class="feather-edit me-2 text-primary"></i>تعديل الوحدة';
            if (modalBtn) {
                modalBtn.innerHTML = '<i class="feather-check me-2"></i>' + i18nStep3.saveChanges;
                modalBtn.onclick = function() { updateModule(moduleId); };
            }

            new bootstrap.Modal(document.getElementById('addModuleModal')).show();
        } catch (error) {
            console.error('Error editing module:', error);
            showToast('خطأ', 'حدث خطأ أثناء تعديل الوحدة', 'error');
        }
    }

    async function updateModule(moduleId) {
        const title = document.getElementById('newModuleTitle').value.trim();
        const description = document.getElementById('newModuleDescription').value.trim();

        if (!title) {
            showToast('تنبيه', 'يرجى إدخال عنوان الوحدة', 'warning');
            return;
        }

        try {
            const response = await fetch('/Instructor/Courses/QuickEditModule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    id: moduleId,
                    title: title,
                    description: description
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('نجاح', 'تم تعديل الوحدة بنجاح', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('خطأ', result.message || 'فشل تعديل الوحدة', 'error');
            }
        } catch (error) {
            console.error('Error updating module:', error);
            showToast('خطأ', 'حدث خطأ أثناء تعديل الوحدة', 'error');
        }

        // Reset modal back to "add" mode
        const modal = bootstrap.Modal.getInstance(document.getElementById('addModuleModal'));
        if (modal) modal.hide();
        resetModuleModal();
    }

    function resetModuleModal() {
        document.getElementById('newModuleTitle').value = '';
        document.getElementById('newModuleDescription').value = '';

        const modalTitle = document.querySelector('#addModuleModal .modal-title');
        const modalBtn = document.querySelector('#addModuleModal .modal-footer .btn-primary');

        if (modalTitle) modalTitle.innerHTML = '<i class="feather-folder-plus me-2 text-primary"></i>إضافة وحدة جديدة';
        if (modalBtn) {
            modalBtn.innerHTML = '<i class="feather-plus me-2"></i>إضافة الوحدة';
            modalBtn.onclick = addModule;
        }
    }

    // ========== ADD LESSON ==========
    async function addLesson() {
        const moduleId = document.getElementById('newLessonModuleId').value;
        const title = document.getElementById('newLessonTitle').value.trim();
        const description = document.getElementById('newLessonDescription').value.trim();
        const type = document.getElementById('selectedLessonType').value;
        const duration = parseInt(document.getElementById('newLessonDuration').value) || 0;
        const isPreviewable = document.getElementById('newLessonPreview').checked;

        if (!title) {
            showToast('تنبيه', 'يرجى إدخال عنوان الدرس', 'warning');
            return;
        }

        if (!type) {
            showToast('تنبيه', 'يرجى اختيار نوع الدرس', 'warning');
            return;
        }

        const validTypes = ['Video', 'Text', 'Article', 'Quiz', 'Assignment', 'Download', 'Audio', 'PDF', 'LiveClass', 'Interactive', 'ExternalLink'];
        if (!validTypes.includes(type)) {
            showToast('خطأ', 'نوع الدرس غير صحيح', 'error');
            return;
        }

        // Collect type-specific data
        let videoUrl = null;
        let videoProvider = null;
        let htmlContent = null;
        let fileUrl = null;
        let isDownloadable = false;

        // VIDEO
        if (type === 'Video') {
            const source = document.getElementById('newLessonVideoSource').value;
            if (source === 'Library') {
                videoUrl = (document.getElementById('lessonVideoUrlHidden').value || '').trim() ||
                           (document.getElementById('newLessonVideoUrl').value || '').trim();
                if (!videoUrl) {
                    showToast('تنبيه', 'يرجى اختيار فيديو من المكتبة أو إدخال رابط فيديو', 'warning');
                    return;
                }
                videoProvider = 'Local';
            } else {
                videoUrl = (document.getElementById('newLessonVideoUrl').value || '').trim();
                if (!videoUrl) {
                    showToast('تنبيه', 'يرجى إدخال رابط الفيديو', 'warning');
                    return;
                }
                if (source === 'YouTube') {
                    if (!extractYouTubeId(videoUrl)) {
                        showToast('خطأ', 'رابط YouTube غير صحيح', 'error');
                        return;
                    }
                    videoProvider = 'YouTube';
                } else if (source === 'Vimeo') {
                    if (!extractVimeoId(videoUrl)) {
                        showToast('خطأ', 'رابط Vimeo غير صحيح', 'error');
                        return;
                    }
                    videoProvider = 'Vimeo';
                } else {
                    try { new URL(videoUrl); } catch (e) {
                        showToast('خطأ', 'رابط الفيديو غير صحيح', 'error');
                        return;
                    }
                    videoProvider = 'Local';
                }
            }
        }

        // TEXT / ARTICLE
        if (type === 'Text' || type === 'Article') {
            const htmlEl = document.getElementById('newLessonHtmlContent');
            if (htmlEl && htmlEl.value.trim()) {
                htmlContent = htmlEl.value.trim();
            }
        }

        // FILE-BASED (PDF, Audio, Download)
        if (type === 'PDF' || type === 'Audio' || type === 'Download') {
            fileUrl = (document.getElementById('lessonFileUrlHidden')?.value || '').trim() ||
                      (document.getElementById('newLessonFileUrl')?.value || '').trim();
            if (!fileUrl) {
                const msg = type === 'Audio' ? 'يرجى إدخال رابط الملف الصوتي' : 'يرجى إدخال رابط الملف';
                showToast('تنبيه', msg, 'warning');
                return;
            }
            if (type === 'Download' || type === 'PDF') {
                const dlEl = document.getElementById('newLessonDownloadable');
                isDownloadable = dlEl ? dlEl.checked : false;
            }
        }

        // EXTERNAL LINK
        if (type === 'ExternalLink') {
            const extUrl = (document.getElementById('newLessonExternalUrl')?.value || '').trim();
            if (!extUrl) {
                showToast('تنبيه', 'يرجى إدخال الرابط الخارجي', 'warning');
                return;
            }
            try { new URL(extUrl); } catch (e) {
                showToast('خطأ', 'الرابط الخارجي غير صحيح', 'error');
                return;
            }
            fileUrl = extUrl;
        }

        // Build request data
        const requestData = {
            moduleId: parseInt(moduleId),
            title: title,
            type: type,
            durationSeconds: duration * 60,
            isPreviewable: isPreviewable,
            isDownloadable: isDownloadable
        };

        if (description) requestData.description = description;
        if (videoUrl) requestData.videoUrl = videoUrl;
        if (videoProvider) requestData.videoProvider = videoProvider;
        if (htmlContent) requestData.htmlContent = htmlContent;
        if (fileUrl) requestData.fileUrl = fileUrl;

        // Quiz settings - send as nested object matching backend QuizSettingsDto
        if (type === 'Quiz') {
            const quizSettings = {
                passingScore: parseInt(document.getElementById('quizPassingScore').value) || 70,
                shuffleQuestions: document.getElementById('quizShuffleQuestions').checked,
                showCorrectAnswers: document.getElementById('quizShowCorrectAnswers').checked,
                allowBackNavigation: document.getElementById('quizAllowBackNavigation').checked
            };
            const timeLimit = parseInt(document.getElementById('quizTimeLimit').value);
            if (timeLimit > 0) quizSettings.timeLimitMinutes = timeLimit;
            const maxAttempts = parseInt(document.getElementById('quizMaxAttempts').value);
            if (maxAttempts > 0) quizSettings.maxAttempts = maxAttempts;
            requestData.quizSettings = quizSettings;

            // Proctoring - send as nested object matching backend ProctoringSettingsDto
            const proctoringEnabled = document.getElementById('proctoringEnabled').checked;
            if (proctoringEnabled) {
                requestData.proctoringSettings = {
                    isEnabled: true,
                    preventTabSwitch: document.getElementById('proctoringPreventTabSwitch').checked,
                    preventCopyPaste: document.getElementById('proctoringPreventCopyPaste').checked,
                    requireFullscreen: document.getElementById('proctoringRequireFullscreen').checked,
                    requireWebcam: document.getElementById('proctoringRequireWebcam').checked
                };
            }
        }

        // Assignment settings - send as nested object matching backend AssignmentSettingsDto
        if (type === 'Assignment') {
            const assignmentSettings = {
                maxPoints: parseInt(document.getElementById('assignmentMaxPoints').value) || 100,
                dueDateDays: parseInt(document.getElementById('assignmentDueDays').value) || 7,
                allowLateSubmission: document.getElementById('assignmentAllowLate').checked,
                allowTextSubmission: document.getElementById('assignmentAllowTextSubmission').checked,
                allowFileUpload: document.getElementById('assignmentAllowFileUpload').checked,
                allowResubmission: document.getElementById('assignmentAllowResubmission').checked
            };

            if (assignmentSettings.allowLateSubmission) {
                assignmentSettings.latePenaltyPercentage = parseInt(document.getElementById('assignmentLatePenalty').value) || 0;
            }
            if (assignmentSettings.allowFileUpload) {
                assignmentSettings.acceptedFileTypes = document.getElementById('assignmentAcceptedFileTypes').value;
                assignmentSettings.maxFileSizeMB = parseInt(document.getElementById('assignmentMaxFileSize').value) || 50;
                assignmentSettings.maxFiles = parseInt(document.getElementById('assignmentMaxFiles').value) || 5;
            }
            requestData.assignmentSettings = assignmentSettings;
        }

        // Content drip settings
        if (enableContentDrip) {
            const dripRadio = document.querySelector('input[name="dripType"]:checked');
            if (dripRadio) {
                const dripSettings = { dripType: dripRadio.value };
                if (dripRadio.value === 'DaysAfterEnrollment') {
                    const days = parseInt(document.getElementById('dripDaysValue')?.value);
                    if (days > 0) dripSettings.availableAfterDays = days;
                } else if (dripRadio.value === 'SpecificDate') {
                    const dateVal = document.getElementById('dripDateValue')?.value;
                    if (dateVal) dripSettings.availableFrom = dateVal;
                } else if (dripRadio.value === 'AfterPreviousCompletion') {
                    // No additional fields needed; controller will handle prerequisite
                }
                requestData.contentDripSettings = dripSettings;
            }
        }

        // Disable save button
        const saveBtn = document.getElementById('saveLessonBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + i18nStep3.saving;

        try {
            if (!moduleId || moduleId === '0') {
                showToast('خطأ', 'معرف الوحدة غير صحيح', 'error');
                return;
            }
            if (!antiForgeryToken) {
                showToast('خطأ', 'خطأ في الأمان. يرجى تحديث الصفحة.', 'error');
                return;
            }

            console.log('Sending lesson data:', requestData);

            const response = await fetch('/Instructor/Courses/QuickAddLesson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                let errorMessage = 'حدث خطأ في الخادم';
                try {
                    const errorResult = await response.json();
                    errorMessage = errorResult.message || errorMessage;
                } catch {
                    const errorText = await response.text();
                    console.error('Server error (non-JSON):', response.status, errorText);
                }
                showToast('خطأ', errorMessage, 'error');
                return;
            }

            const result = await response.json();
            console.log('addLesson response:', JSON.stringify({ success: result.success, lessonId: result.lesson?.id, quizId: result.quizId, assignmentId: result.assignmentId }));

            if (result.success) {
                showToast('نجاح', 'تمت إضافة الدرس بنجاح', 'success');

                // Store created lesson data for Step 3
                window._createdLessonId = result.lesson?.id;
                window._createdQuizId = result.quizId;
                window._createdAssignmentId = result.assignmentId;
                window._createdLessonType = type;

                // Verify quizId was returned for Quiz type
                if (type === 'Quiz' && !result.quizId) {
                    console.warn('Warning: Quiz lesson created but no quizId returned!');
                }

                // Transition to Step 3: Advanced Setup
                document.getElementById('lessonStep1').style.display = 'none';
                document.getElementById('lessonStep2').style.display = 'none';
                document.getElementById('step1Footer').style.display = 'none';
                document.getElementById('step2Footer').style.display = 'none';
                document.getElementById('lessonStep3').style.display = 'block';
                document.getElementById('step3Footer').style.display = 'flex';

                // Update modal title
                const config = lessonTypeConfig[type];
                document.getElementById('lessonModalTitleText').textContent = `إعداد متقدم - ${config.name}`;

                // Make modal XL for step 3
                const dialog = document.getElementById('addLessonModalDialog');
                dialog.classList.remove('modal-lg');
                dialog.classList.add('modal-xl');

                // Load step 3 content
                loadStep3Content(type, result.lesson?.id, result.quizId, result.assignmentId);
            } else {
                showToast('خطأ', result.message || 'فشل إضافة الدرس', 'error');
            }
        } catch (error) {
            console.error('Error adding lesson:', error);
            showToast('خطأ', 'حدث خطأ أثناء إضافة الدرس: ' + (error.message || 'خطأ غير معروف'), 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="feather-plus me-2"></i>' + i18nStep3.saveLesson;
        }
    }

    // ========== DELETE MODULE ==========
    async function deleteModule(moduleId) {
        if (!confirm('هل أنت متأكد من حذف هذه الوحدة؟')) return;

        try {
            const response = await fetch('/Instructor/Courses/QuickDeleteModule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(moduleId)
            });

            const result = await response.json();

            if (result.success) {
                document.querySelector(`[data-module-id="${moduleId}"]`).remove();
                showToast('نجاح', 'تم حذف الوحدة بنجاح', 'success');
            } else {
                showToast('خطأ', result.message || 'فشل حذف الوحدة', 'error');
            }
        } catch (error) {
            console.error('Error deleting module:', error);
            showToast('خطأ', 'حدث خطأ أثناء حذف الوحدة', 'error');
        }
    }

    // ========== DELETE LESSON ==========
    async function deleteLesson(lessonId) {
        if (event) { event.preventDefault(); event.stopPropagation(); }
        if (!confirm('هل أنت متأكد من حذف هذا الدرس؟')) return;

        try {
            const response = await fetch('/Instructor/Courses/QuickDeleteLesson', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(lessonId)
            });

            const result = await response.json();

            if (result.success) {
                document.querySelector(`[data-lesson-id="${lessonId}"]`).remove();
                showToast('نجاح', 'تم حذف الدرس بنجاح', 'success');
            } else {
                showToast('خطأ', result.message || 'فشل حذف الدرس', 'error');
            }
        } catch (error) {
            console.error('Error deleting lesson:', error);
            showToast('خطأ', 'حدث خطأ أثناء حذف الدرس', 'error');
        }
    }

    // ========== STEP 3: ADVANCED SETUP FUNCTIONS ==========

    // Step 3 state
    let step3QuizQuestions = [];
    let step3LessonResources = [];

    function skipStep3AndFinish() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('addLessonModal'));
        if (modal) modal.hide();
        const isEdit = window._isEditModeStep3 === true;
        showToast('نجاح', isEdit ? 'تم تحديث الدرس' : 'تمت إضافة الدرس بنجاح', 'success');
        if (isEdit) window._isEditModeStep3 = false;
        setTimeout(() => location.reload(), 800);
    }

    async function saveStep3AndFinish() {
        const btn = document.getElementById('saveStep3Btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الحفظ...';

        try {
            const type = window._createdLessonType;
            const lessonId = window._createdLessonId;

            // Save type-specific Step 3 data
            if (type === 'Video' || type === 'Text' || type === 'Article' || type === 'PDF' || type === 'Audio' || type === 'Download') {
                // No additional save needed, resources are saved inline
            }
            if (type === 'Quiz') {
                // Quiz questions are saved inline via QuickAddQuizQuestion calls.
                // Verify at least one question exists
                const quizId = window._createdQuizId;
                if (quizId && step3QuizQuestions.length === 0) {
                    // Reload questions to check if any were saved
                    try {
                        const resp = await fetch(`/Instructor/Courses/GetQuizQuestions?quizId=${quizId}`);
                        const data = await resp.json();
                        if (data.success && data.questions && data.questions.length > 0) {
                            step3QuizQuestions = data.questions;
                        }
                    } catch (e) {
                        console.warn('Could not verify quiz questions:', e);
                    }
                }
                // Questions are already persisted, nothing extra to save
            }
            if (type === 'Assignment') {
                // Assignment settings were saved during lesson creation in Step 2
                // Additional resources are saved inline
            }
            if (type === 'LiveClass') {
                await saveLiveClassStep3(lessonId);
            }
            if (type === 'ExternalLink') {
                await saveExternalLinkStep3(lessonId);
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('addLessonModal'));
            if (modal) modal.hide();
            const isEdit = window._isEditModeStep3 === true;
            showToast('نجاح', isEdit ? 'تم تحديث الدرس بنجاح' : 'تم الحفظ بنجاح', 'success');
            if (isEdit) window._isEditModeStep3 = false;
            setTimeout(() => location.reload(), 800);
        } catch (error) {
            console.error('Error saving Step 3:', error);
            showToast('خطأ', 'حدث خطأ أثناء الحفظ', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="feather-check me-2"></i>حفظ والإنهاء';
        }
    }

    function loadStep3Content(type, lessonId, quizId, assignmentId) {
        const container = document.getElementById('step3Content');

        switch (type) {
            case 'Quiz':
                container.innerHTML = buildQuizStep3Html(quizId);
                initQuizStep3(quizId);
                break;
            case 'Assignment':
                container.innerHTML = buildAssignmentStep3Html(lessonId, assignmentId);
                break;
            case 'Video':
                container.innerHTML = buildVideoStep3Html(lessonId);
                loadLessonResources(lessonId);
                break;
            case 'Text':
            case 'Article':
                container.innerHTML = buildTextStep3Html(lessonId, type);
                loadLessonResources(lessonId);
                break;
            case 'PDF':
            case 'Audio':
            case 'Download':
                container.innerHTML = buildFileStep3Html(lessonId, type);
                loadLessonResources(lessonId);
                break;
            case 'LiveClass':
                container.innerHTML = buildLiveClassStep3Html(lessonId);
                break;
            case 'ExternalLink':
                container.innerHTML = buildExternalLinkStep3Html(lessonId);
                break;
            default:
                container.innerHTML = `<div class="alert alert-info"><i class="feather-info me-2"></i>لا توجد إعدادات متقدمة لهذا النوع.</div>`;
        }

        // Re-initialize feather icons
        if (typeof feather !== 'undefined') feather.replace();
    }

    // ========== QUIZ STEP 3 ==========
    function buildQuizStep3Html(quizId) {
        return `
            <div class="row g-3">
                <!-- Questions List Panel -->
                <div class="col-12">
                    <div class="card step3-section-card mb-3">
                        <div class="card-header bg-soft-warning d-flex align-items-center justify-content-between">
                            <h6 class="mb-0 fw-bold"><i class="feather-list me-2 text-warning"></i>@Html.T("أسئلة الاختبار", "Quiz questions")</h6>
                            <span class="badge bg-warning text-dark" id="quizQuestionsCount">0 @Html.T("سؤال", "questions")</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="quizQuestionsList" class="quiz-questions-list p-3">
                                <div class="empty-questions-state" id="emptyQuestionsState">
                                    <i class="feather-help-circle text-muted d-block mb-3" style="font-size: 48px;"></i>
                                    <h6 class="fw-bold text-muted">@Html.T("لا توجد أسئلة بعد", "No questions yet")</h6>
                                    <p class="text-muted mb-0">@Html.T("أضف أسئلة جديدة أو استورد من بنك الأسئلة", "Add new questions or import from question bank")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Question Tabs -->
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="quizAddTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="createQuestionTab" data-bs-toggle="tab" data-bs-target="#createQuestionPane" type="button" role="tab">
                                        <i class="feather-plus-circle me-1"></i>@Html.T("إنشاء سؤال جديد", "Create new question")
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="importBankTab" data-bs-toggle="tab" data-bs-target="#importBankPane" type="button" role="tab">
                                        <i class="feather-download me-1"></i>@Html.T("استيراد من بنك الأسئلة", "Import from question bank")
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="randomImportTab" data-bs-toggle="tab" data-bs-target="#randomImportPane" type="button" role="tab">
                                        <i class="feather-shuffle me-1"></i>@Html.T("استيراد عشوائي", "Random import")
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="quizAddTabContent">
                                <!-- Tab 1: Create New Question -->
                                <div class="tab-pane fade show active" id="createQuestionPane" role="tabpanel">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">@Html.T("نوع السؤال", "Question type") <span class="text-danger">*</span></label>
                                            <select class="form-select" id="newQuestionType" onchange="toggleQuestionTypeFields()">
                                                <option value="1">@Html.T("اختيار واحد", "Single choice")</option>
                                                <option value="2">@Html.T("اختيارات متعددة", "Multiple choice")</option>
                                                <option value="3">@Html.T("صح أو خطأ", "True/False")</option>
                                                <option value="4">@Html.T("إجابة قصيرة", "Short answer")</option>
                                                <option value="5">@Html.T("إجابة مقالية", "Essay")</option>
                                                <option value="6">@Html.T("ملء الفراغات", "Fill in blanks")</option>
                                                <option value="7">@Html.T("مطابقة", "Matching")</option>
                                                <option value="8">@Html.T("ترتيب", "Ordering")</option>
                                                <option value="9">@Html.T("رفع ملف", "File upload")</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("الدرجات", "Points")</label>
                                            <input type="number" class="form-control" id="newQuestionPoints" min="1" value="1">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("الصعوبة", "Difficulty")</label>
                                            <select class="form-select" id="newQuestionDifficulty">
                                                <option value="">@Html.T("غير محدد", "Not set")</option>
                                                <option value="1">@Html.T("سهل جداً", "Very easy")</option>
                                                <option value="2">@Html.T("سهل", "Easy")</option>
                                                <option value="3">@Html.T("متوسط", "Medium")</option>
                                                <option value="4">@Html.T("صعب", "Hard")</option>
                                                <option value="5">@Html.T("صعب جداً", "Very hard")</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label fw-bold">@Html.T("نص السؤال", "Question text") <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="newQuestionText" rows="3" placeholder="@Html.T("أدخل نص السؤال...", "Enter question text...")"></textarea>
                                        </div>

                                        <!-- Dynamic options area -->
                                        <div class="col-12" id="questionOptionsArea">
                                            <!-- SingleChoice / MultipleChoice options -->
                                            <div id="choiceOptionsContainer">
                                                <label class="form-label fw-bold">@Html.T("الخيارات", "Options") <span class="text-danger">*</span></label>
                                                <div id="choiceOptionsList">
                                                    <div class="option-row" data-index="0">
                                                        <input type="radio" name="correctOption" value="0" class="form-check-input" title="@Html.T("الإجابة الصحيحة", "Correct answer")">
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("الخيار 1", "Option 1")" data-option-text>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoiceOption(this)" title="@Html.T("حذف", "Delete")"><i class="feather-x"></i></button>
                                                    </div>
                                                    <div class="option-row" data-index="1">
                                                        <input type="radio" name="correctOption" value="1" class="form-check-input" title="@Html.T("الإجابة الصحيحة", "Correct answer")">
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("الخيار 2", "Option 2")" data-option-text>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoiceOption(this)" title="@Html.T("حذف", "Delete")"><i class="feather-x"></i></button>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addChoiceOption()">
                                                    <i class="feather-plus me-1"></i>@Html.T("إضافة خيار", "Add option")
                                                </button>
                                            </div>

                                            <!-- True/False -->
                                            <div id="trueFalseContainer" style="display: none;">
                                                <label class="form-label fw-bold">@Html.T("الإجابة الصحيحة", "Correct answer")</label>
                                                <div class="d-flex gap-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="trueFalseAnswer" id="tfTrue" value="true" checked>
                                                        <label class="form-check-label" for="tfTrue">@Html.T("صحيح", "True")</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="trueFalseAnswer" id="tfFalse" value="false">
                                                        <label class="form-check-label" for="tfFalse">@Html.T("خطأ", "False")</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Short Answer -->
                                            <div id="shortAnswerContainer" style="display: none;">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">@Html.T("الإجابة الصحيحة", "Correct answer")</label>
                                                    <input type="text" class="form-control" id="shortAnswerCorrect" placeholder="@Html.T("الإجابة المتوقعة", "Expected answer")">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">@Html.T("كلمات مفتاحية (مفصولة بفواصل)", "Keywords (comma separated)")</label>
                                                    <input type="text" class="form-control" id="shortAnswerKeywords" placeholder="keyword1, keyword2, keyword3">
                                                </div>
                                            </div>

                                            <!-- Essay -->
                                            <div id="essayContainer" style="display: none;">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">@Html.T("الحد الأدنى للكلمات", "Minimum words")</label>
                                                        <input type="number" class="form-control" id="essayMinWords" min="0" placeholder="50">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">@Html.T("الحد الأقصى للكلمات", "Maximum words")</label>
                                                        <input type="number" class="form-control" id="essayMaxWords" min="0" placeholder="500">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Fill In Blanks -->
                                            <div id="fillBlanksContainer" style="display: none;">
                                                <label class="form-label fw-bold">@Html.T("النص مع الفراغات", "Text with blanks")</label>
                                                <textarea class="form-control" id="fillBlanksText" rows="3" placeholder="@Html.T("استخدم [blank] لتحديد الفراغات. مثال: عاصمة مصر هي [blank]", "Use [blank] for each blank. Example: The capital of Egypt is [blank]")"></textarea>
                                                <small class="text-muted">@Html.T("استخدم [blank] لتحديد مكان كل فراغ", "Use [blank] to mark each blank")</small>
                                                <div id="fillBlanksAnswers" class="mt-3"></div>
                                            </div>

                                            <!-- Matching -->
                                            <div id="matchingContainer" style="display: none;">
                                                <label class="form-label fw-bold">@Html.T("أزواج المطابقة", "Matching pairs")</label>
                                                <div id="matchingPairsList">
                                                    <div class="matching-pair-row">
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر الأيمن", "Left item")" data-match-left>
                                                        <i class="feather-arrow-left text-muted"></i>
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر الأيسر", "Right item")" data-match-right>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMatchingPair(this)"><i class="feather-x"></i></button>
                                                    </div>
                                                    <div class="matching-pair-row">
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر الأيمن", "Left item")" data-match-left>
                                                        <i class="feather-arrow-left text-muted"></i>
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر الأيسر", "Right item")" data-match-right>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMatchingPair(this)"><i class="feather-x"></i></button>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addMatchingPair()">
                                                    <i class="feather-plus me-1"></i>@Html.T("إضافة زوج", "Add pair")
                                                </button>
                                            </div>

                                            <!-- Ordering -->
                                            <div id="orderingContainer" style="display: none;">
                                                <label class="form-label fw-bold">@Html.T("العناصر بالترتيب الصحيح", "Items in correct order")</label>
                                                <div id="orderingItemsList">
                                                    <div class="option-row" data-index="0">
                                                        <span class="badge bg-primary rounded-pill">1</span>
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر 1", "Item 1")" data-order-text>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderingItem(this)"><i class="feather-x"></i></button>
                                                    </div>
                                                    <div class="option-row" data-index="1">
                                                        <span class="badge bg-primary rounded-pill">2</span>
                                                        <input type="text" class="form-control form-control-sm" placeholder="@Html.T("العنصر 2", "Item 2")" data-order-text>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderingItem(this)"><i class="feather-x"></i></button>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addOrderingItem()">
                                                    <i class="feather-plus me-1"></i>@Html.T("إضافة عنصر", "Add item")
                                                </button>
                                            </div>

                                            <!-- File Upload -->
                                            <div id="fileUploadQuestionContainer" style="display: none;">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">@Html.T("أنواع الملفات المقبولة", "Accepted file types")</label>
                                                        <input type="text" class="form-control" id="fuAcceptedTypes" value=".pdf,.doc,.docx" placeholder=".pdf,.doc,.docx">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">@Html.T("الحجم الأقصى (MB)", "Max size (MB)")</label>
                                                        <input type="number" class="form-control" id="fuMaxSize" min="1" value="10">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Explanation & Hint -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">@Html.T("تفسير الإجابة (اختياري)", "Answer explanation (optional)")</label>
                                            <textarea class="form-control" id="newQuestionExplanation" rows="2" placeholder="@Html.T("تفسير يظهر بعد الإجابة...", "Explanation shown after answering...")"></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">@Html.T("تلميح (اختياري)", "Hint (optional)")</label>
                                            <textarea class="form-control" id="newQuestionHint" rows="2" placeholder="@Html.T("تلميح يساعد الطالب...", "Hint to help the student...")"></textarea>
                                        </div>

                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary" onclick="addQuizQuestion()" id="addQuestionBtn">
                                                <i class="feather-plus-circle me-2"></i>@Html.T("إضافة السؤال", "Add question")
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tab 2: Import from Question Bank -->
                                <div class="tab-pane fade" id="importBankPane" role="tabpanel">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">@Html.T("بنك الأسئلة", "Question bank")</label>
                                            <select class="form-select" id="bankSelector" onchange="loadBankQuestions()">
                                                <option value="">-- @Html.T("اختر بنك أسئلة", "Choose question bank") --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("نوع السؤال", "Question type")</label>
                                            <select class="form-select" id="bankFilterType">
                                                <option value="">@Html.T("الكل", "All")</option>
                                                <option value="1">@Html.T("اختيار واحد", "Single choice")</option>
                                                <option value="2">@Html.T("اختيارات متعددة", "Multiple choice")</option>
                                                <option value="3">@Html.T("صح أو خطأ", "True/False")</option>
                                                <option value="4">@Html.T("إجابة قصيرة", "Short answer")</option>
                                                <option value="5">@Html.T("مقالية", "Essay")</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("الصعوبة", "Difficulty")</label>
                                            <select class="form-select" id="bankFilterDifficulty">
                                                <option value="">@Html.T("الكل", "All")</option>
                                                <option value="1">@Html.T("سهل جداً", "Very easy")</option>
                                                <option value="2">@Html.T("سهل", "Easy")</option>
                                                <option value="3">@Html.T("متوسط", "Medium")</option>
                                                <option value="4">@Html.T("صعب", "Hard")</option>
                                                <option value="5">@Html.T("صعب جداً", "Very hard")</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="loadBankQuestions()">
                                                <i class="feather-filter me-1"></i>@Html.T("تصفية", "Filter")
                                            </button>
                                        </div>
                                        <div class="col-12">
                                            <div id="bankQuestionsList" class="border rounded-3 p-3" style="max-height: 300px; overflow-y: auto;">
                                                <p class="text-muted text-center mb-0">@Html.T("اختر بنك أسئلة لعرض الأسئلة", "Choose a question bank to view questions")</p>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary" onclick="importSelectedBankQuestions()" id="importSelectedBtn" disabled>
                                                <i class="feather-download me-2"></i>استيراد المحدد
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tab 3: Random Import -->
                                <div class="tab-pane fade" id="randomImportPane" role="tabpanel">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">@Html.T("بنك الأسئلة", "Question bank")</label>
                                            <select class="form-select" id="randomBankSelector">
                                                <option value="">-- @Html.T("اختر بنك أسئلة", "Choose question bank") --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label fw-bold">@Html.T("العدد", "Count")</label>
                                            <input type="number" class="form-control" id="randomCount" min="1" value="5">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("نوع السؤال", "Question type")</label>
                                            <select class="form-select" id="randomFilterType">
                                                <option value="">@Html.T("الكل", "All")</option>
                                                <option value="1">@Html.T("اختيار واحد", "Single choice")</option>
                                                <option value="2">@Html.T("اختيارات متعددة", "Multiple choice")</option>
                                                <option value="3">@Html.T("صح أو خطأ", "True/False")</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">@Html.T("الصعوبة", "Difficulty")</label>
                                            <select class="form-select" id="randomFilterDifficulty">
                                                <option value="">@Html.T("الكل", "All")</option>
                                                <option value="1">@Html.T("سهل جداً", "Very easy")</option>
                                                <option value="2">@Html.T("سهل", "Easy")</option>
                                                <option value="3">@Html.T("متوسط", "Medium")</option>
                                                <option value="4">@Html.T("صعب", "Hard")</option>
                                                <option value="5">@Html.T("صعب جداً", "Very hard")</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary" onclick="randomImportBankQuestions()">
                                                <i class="feather-shuffle me-2"></i>@Html.T("استيراد عشوائي", "Random import")
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Settings Review (Collapsible) -->
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-header bg-light d-flex align-items-center cursor-pointer" data-bs-toggle="collapse" data-bs-target="#quizSettingsReview">
                            <i class="feather-settings me-2 text-muted"></i>
                            <h6 class="mb-0 fw-bold">@Html.T("مراجعة إعدادات الاختبار", "Quiz settings review")</h6>
                            <i class="feather-chevron-down ms-auto"></i>
                        </div>
                        <div class="collapse" id="quizSettingsReview">
                            <div class="card-body">
                                <div class="row g-3" id="quizSettingsReviewContent">
                                    <div class="col-md-4"><span class="text-muted">@Html.T("درجة النجاح:", "Passing score:")</span> <strong id="reviewPassingScore"></strong></div>
                                    <div class="col-md-4"><span class="text-muted">@Html.T("المدة:", "Duration:")</span> <strong id="reviewTimeLimit"></strong></div>
                                    <div class="col-md-4"><span class="text-muted">@Html.T("المحاولات:", "Attempts:")</span> <strong id="reviewMaxAttempts"></strong></div>
                                    <div class="col-md-4"><span class="text-muted">@Html.T("خلط الأسئلة:", "Shuffle:")</span> <strong id="reviewShuffle"></strong></div>
                                    <div class="col-md-4"><span class="text-muted">@Html.T("المراقبة:", "Proctoring:")</span> <strong id="reviewProctoring"></strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function initQuizStep3(quizId) {
        // Populate quiz settings review
        const passingScore = document.getElementById('quizPassingScore')?.value || '70';
        const timeLimit = document.getElementById('quizTimeLimit')?.value;
        const maxAttempts = document.getElementById('quizMaxAttempts')?.value;
        const shuffle = document.getElementById('quizShuffleQuestions')?.checked;
        const proctoring = document.getElementById('proctoringEnabled')?.checked;

        const reviewPassingScore = document.getElementById('reviewPassingScore');
        const reviewTimeLimit = document.getElementById('reviewTimeLimit');
        const reviewMaxAttempts = document.getElementById('reviewMaxAttempts');
        const reviewShuffle = document.getElementById('reviewShuffle');
        const reviewProctoring = document.getElementById('reviewProctoring');

        if (reviewPassingScore) reviewPassingScore.textContent = passingScore + '%';
        if (reviewTimeLimit) reviewTimeLimit.textContent = timeLimit ? timeLimit + ' دقيقة' : 'بدون حد';
        if (reviewMaxAttempts) reviewMaxAttempts.textContent = maxAttempts ? maxAttempts + ' محاولات' : 'غير محدود';
        if (reviewShuffle) reviewShuffle.textContent = shuffle ? 'نعم' : 'لا';
        if (reviewProctoring) reviewProctoring.textContent = proctoring ? 'مفعلة' : 'غير مفعلة';

        // Load question banks for import tabs
        loadQuestionBanks();

        // Load existing questions only when quizId is valid
        if (quizId && quizId > 0) {
            loadQuizQuestions(quizId);
        } else {
            step3QuizQuestions = [];
            renderQuizQuestionsList();
        }

        // Initialize question type fields
        toggleQuestionTypeFields();
    }

    // Question Type Dynamic Fields
    function toggleQuestionTypeFields() {
        const type = parseInt(document.getElementById('newQuestionType')?.value || '1');

        // Hide all type-specific containers
        const containers = ['choiceOptionsContainer', 'trueFalseContainer', 'shortAnswerContainer',
            'essayContainer', 'fillBlanksContainer', 'matchingContainer', 'orderingContainer', 'fileUploadQuestionContainer'];
        containers.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });

        // Show appropriate container
        switch (type) {
            case 1: // SingleChoice
                document.getElementById('choiceOptionsContainer').style.display = 'block';
                // Switch to radio buttons
                document.querySelectorAll('#choiceOptionsList input[type="checkbox"]').forEach(cb => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'correctOption';
                    radio.value = cb.value;
                    radio.className = 'form-check-input';
                    radio.title = 'الإجابة الصحيحة';
                    radio.checked = cb.checked;
                    cb.replaceWith(radio);
                });
                break;
            case 2: // MultipleChoice
                document.getElementById('choiceOptionsContainer').style.display = 'block';
                // Switch to checkboxes
                document.querySelectorAll('#choiceOptionsList input[type="radio"][name="correctOption"]').forEach(radio => {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'form-check-input';
                    cb.title = 'إجابة صحيحة';
                    cb.checked = radio.checked;
                    cb.dataset.correctOption = 'true';
                    radio.replaceWith(cb);
                });
                break;
            case 3:
                document.getElementById('trueFalseContainer').style.display = 'block';
                break;
            case 4:
                document.getElementById('shortAnswerContainer').style.display = 'block';
                break;
            case 5:
                document.getElementById('essayContainer').style.display = 'block';
                break;
            case 6:
                document.getElementById('fillBlanksContainer').style.display = 'block';
                break;
            case 7:
                document.getElementById('matchingContainer').style.display = 'block';
                break;
            case 8:
                document.getElementById('orderingContainer').style.display = 'block';
                break;
            case 9:
                document.getElementById('fileUploadQuestionContainer').style.display = 'block';
                break;
        }

        if (typeof feather !== 'undefined') feather.replace();
    }

    // Choice Options Management
    function addChoiceOption() {
        const list = document.getElementById('choiceOptionsList');
        const index = list.querySelectorAll('.option-row').length;
        const type = parseInt(document.getElementById('newQuestionType')?.value || '1');
        const inputType = type === 2 ? 'checkbox' : 'radio';
        const nameAttr = type === 2 ? '' : 'name="correctOption"';
        const extraAttr = type === 2 ? 'data-correct-option="true"' : '';

        const row = document.createElement('div');
        row.className = 'option-row';
        row.dataset.index = index;
        row.innerHTML = `
            <input type="${inputType}" ${nameAttr} value="${index}" class="form-check-input" title="الإجابة الصحيحة" ${extraAttr}>
            <input type="text" class="form-control form-control-sm" placeholder="الخيار ${index + 1}" data-option-text>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoiceOption(this)" title="حذف"><i class="feather-x"></i></button>
        `;
        list.appendChild(row);
        if (typeof feather !== 'undefined') feather.replace();
    }

    function removeChoiceOption(btn) {
        const list = document.getElementById('choiceOptionsList');
        if (list.querySelectorAll('.option-row').length <= 2) {
            showToast('تنبيه', 'يجب أن يكون هناك خياران على الأقل', 'warning');
            return;
        }
        btn.closest('.option-row').remove();
    }

    // Matching Pairs Management
    function addMatchingPair() {
        const list = document.getElementById('matchingPairsList');
        const row = document.createElement('div');
        row.className = 'matching-pair-row';
        row.innerHTML = `
            <input type="text" class="form-control form-control-sm" placeholder="العنصر الأيمن" data-match-left>
            <i class="feather-arrow-left text-muted"></i>
            <input type="text" class="form-control form-control-sm" placeholder="العنصر الأيسر" data-match-right>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMatchingPair(this)"><i class="feather-x"></i></button>
        `;
        list.appendChild(row);
        if (typeof feather !== 'undefined') feather.replace();
    }

    function removeMatchingPair(btn) {
        const list = document.getElementById('matchingPairsList');
        if (list.querySelectorAll('.matching-pair-row').length <= 2) {
            showToast('تنبيه', 'يجب أن يكون هناك زوجان على الأقل', 'warning');
            return;
        }
        btn.closest('.matching-pair-row').remove();
    }

    // Ordering Items Management
    function addOrderingItem() {
        const list = document.getElementById('orderingItemsList');
        const index = list.querySelectorAll('.option-row').length;
        const row = document.createElement('div');
        row.className = 'option-row';
        row.dataset.index = index;
        row.innerHTML = `
            <span class="badge bg-primary rounded-pill">${index + 1}</span>
            <input type="text" class="form-control form-control-sm" placeholder="العنصر ${index + 1}" data-order-text>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderingItem(this)"><i class="feather-x"></i></button>
        `;
        list.appendChild(row);
        if (typeof feather !== 'undefined') feather.replace();
    }

    function removeOrderingItem(btn) {
        const list = document.getElementById('orderingItemsList');
        if (list.querySelectorAll('.option-row').length <= 2) {
            showToast('تنبيه', 'يجب أن يكون هناك عنصران على الأقل', 'warning');
            return;
        }
        btn.closest('.option-row').remove();
        // Re-number badges
        list.querySelectorAll('.option-row').forEach((row, i) => {
            row.querySelector('.badge').textContent = i + 1;
        });
    }

    // Add Quiz Question via AJAX
    async function addQuizQuestion() {
        const quizId = window._createdQuizId;
        if (!quizId) { showToast('خطأ', 'معرف الاختبار غير موجود', 'error'); return; }

        const questionText = document.getElementById('newQuestionText')?.value?.trim();
        if (!questionText) { showToast('تنبيه', 'يرجى إدخال نص السؤال', 'warning'); return; }

        const type = parseInt(document.getElementById('newQuestionType')?.value || '1');
        const points = parseInt(document.getElementById('newQuestionPoints')?.value) || 1;
        const difficulty = document.getElementById('newQuestionDifficulty')?.value || null;
        const explanation = document.getElementById('newQuestionExplanation')?.value?.trim() || null;
        const hint = document.getElementById('newQuestionHint')?.value?.trim() || null;

        // Collect type-specific data
        let options = [];
        let sampleAnswer = null;
        let answerKeywords = null;
        let minWordCount = null;
        let maxWordCount = null;

        switch (type) {
            case 1: { // SingleChoice
                const rows = document.querySelectorAll('#choiceOptionsList .option-row');
                const selectedRadio = document.querySelector('#choiceOptionsList input[type="radio"]:checked');
                rows.forEach((row, i) => {
                    const text = row.querySelector('[data-option-text]')?.value?.trim();
                    if (text) {
                        options.push({ optionText: text, isCorrect: selectedRadio?.value == i.toString(), orderIndex: i });
                    }
                });
                if (options.length < 2) { showToast('تنبيه', 'أضف خيارين على الأقل', 'warning'); return; }
                if (!options.some(o => o.isCorrect)) { showToast('تنبيه', 'حدد الإجابة الصحيحة', 'warning'); return; }
                break;
            }
            case 2: { // MultipleChoice
                const rows = document.querySelectorAll('#choiceOptionsList .option-row');
                rows.forEach((row, i) => {
                    const text = row.querySelector('[data-option-text]')?.value?.trim();
                    const isCorrect = row.querySelector('input[type="checkbox"]')?.checked || false;
                    if (text) {
                        options.push({ optionText: text, isCorrect: isCorrect, orderIndex: i });
                    }
                });
                if (options.length < 2) { showToast('تنبيه', 'أضف خيارين على الأقل', 'warning'); return; }
                if (!options.some(o => o.isCorrect)) { showToast('تنبيه', 'حدد إجابة صحيحة واحدة على الأقل', 'warning'); return; }
                break;
            }
            case 3: { // TrueFalse
                const isTrue = document.querySelector('input[name="trueFalseAnswer"]:checked')?.value === 'true';
                options = [
                    { optionText: 'صحيح', isCorrect: isTrue, orderIndex: 0 },
                    { optionText: 'خطأ', isCorrect: !isTrue, orderIndex: 1 }
                ];
                break;
            }
            case 4: { // ShortAnswer
                sampleAnswer = document.getElementById('shortAnswerCorrect')?.value?.trim() || null;
                answerKeywords = document.getElementById('shortAnswerKeywords')?.value?.trim() || null;
                break;
            }
            case 5: { // Essay
                minWordCount = parseInt(document.getElementById('essayMinWords')?.value) || null;
                maxWordCount = parseInt(document.getElementById('essayMaxWords')?.value) || null;
                break;
            }
            case 6: { // FillInBlanks
                const blanksText = document.getElementById('fillBlanksText')?.value?.trim();
                if (!blanksText || !blanksText.includes('[blank]')) {
                    showToast('تنبيه', 'يرجى إدخال النص مع [blank] للفراغات', 'warning'); return;
                }
                sampleAnswer = blanksText;
                // Collect answers for blanks
                const blankAnswers = document.querySelectorAll('#fillBlanksAnswers input');
                answerKeywords = Array.from(blankAnswers).map(el => el.value.trim()).filter(v => v).join('|');
                break;
            }
            case 7: { // Matching
                const pairs = document.querySelectorAll('#matchingPairsList .matching-pair-row');
                pairs.forEach((pair, i) => {
                    const left = pair.querySelector('[data-match-left]')?.value?.trim();
                    const right = pair.querySelector('[data-match-right]')?.value?.trim();
                    if (left && right) {
                        options.push({ optionText: `${left}|||${right}`, isCorrect: true, orderIndex: i });
                    }
                });
                if (options.length < 2) { showToast('تنبيه', 'أضف زوجين مطابقة على الأقل', 'warning'); return; }
                break;
            }
            case 8: { // Ordering
                const items = document.querySelectorAll('#orderingItemsList [data-order-text]');
                items.forEach((item, i) => {
                    const text = item.value?.trim();
                    if (text) {
                        options.push({ optionText: text, isCorrect: true, orderIndex: i });
                    }
                });
                if (options.length < 2) { showToast('تنبيه', 'أضف عنصرين على الأقل', 'warning'); return; }
                break;
            }
            case 9: { // FileUpload
                const acceptedTypes = document.getElementById('fuAcceptedTypes')?.value?.trim() || '.pdf,.doc,.docx';
                const maxSize = parseInt(document.getElementById('fuMaxSize')?.value) || 10;
                sampleAnswer = JSON.stringify({ acceptedTypes, maxSize });
                break;
            }
        }

        const requestData = {
            quizId: quizId,
            questionText: questionText,
            type: type,
            points: points,
            difficultyLevel: difficulty,
            explanation: explanation,
            hint: hint,
            options: options,
            sampleAnswer: sampleAnswer,
            answerKeywords: answerKeywords,
            minWordCount: minWordCount,
            maxWordCount: maxWordCount
        };

        const btn = document.getElementById('addQuestionBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الإضافة...';

        try {
            const response = await fetch('/Instructor/Courses/QuickAddQuizQuestion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.success) {
                showToast('نجاح', result.message || 'تمت إضافة السؤال', 'success');
                // Add to list
                step3QuizQuestions.push(result.question);
                renderQuizQuestionsList();
                resetQuestionForm();
            } else {
                showToast('خطأ', result.message || 'فشل إضافة السؤال', 'error');
            }
        } catch (error) {
            console.error('Error adding question:', error);
            showToast('خطأ', 'حدث خطأ أثناء إضافة السؤال', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="feather-plus-circle me-2"></i>إضافة السؤال';
            if (typeof feather !== 'undefined') feather.replace();
        }
    }

    function resetQuestionForm() {
        document.getElementById('newQuestionText').value = '';
        document.getElementById('newQuestionPoints').value = '1';
        document.getElementById('newQuestionDifficulty').value = '';
        document.getElementById('newQuestionExplanation').value = '';
        document.getElementById('newQuestionHint').value = '';
        document.getElementById('shortAnswerCorrect') && (document.getElementById('shortAnswerCorrect').value = '');
        document.getElementById('shortAnswerKeywords') && (document.getElementById('shortAnswerKeywords').value = '');

        // Reset choice options to 2 empty
        const choiceList = document.getElementById('choiceOptionsList');
        if (choiceList) {
            choiceList.innerHTML = `
                <div class="option-row" data-index="0">
                    <input type="radio" name="correctOption" value="0" class="form-check-input" title="الإجابة الصحيحة">
                    <input type="text" class="form-control form-control-sm" placeholder="الخيار 1" data-option-text>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoiceOption(this)" title="حذف"><i class="feather-x"></i></button>
                </div>
                <div class="option-row" data-index="1">
                    <input type="radio" name="correctOption" value="1" class="form-check-input" title="الإجابة الصحيحة">
                    <input type="text" class="form-control form-control-sm" placeholder="الخيار 2" data-option-text>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChoiceOption(this)" title="حذف"><i class="feather-x"></i></button>
                </div>
            `;
        }
        if (typeof feather !== 'undefined') feather.replace();
    }

    function renderQuizQuestionsList() {
        const list = document.getElementById('quizQuestionsList');
        const countBadge = document.getElementById('quizQuestionsCount');
        const emptyState = document.getElementById('emptyQuestionsState');

        if (!list) return;

        countBadge.textContent = step3QuizQuestions.length + ' سؤال';

        if (step3QuizQuestions.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';

        // Remove existing question items (keep empty state)
        list.querySelectorAll('.question-item').forEach(el => el.remove());

        const typeNames = { 1: 'اختيار واحد', 2: 'اختيارات متعددة', 3: 'صح/خطأ', 4: 'إجابة قصيرة', 5: 'مقالية', 6: 'ملء فراغات', 7: 'مطابقة', 8: 'ترتيب', 9: 'رفع ملف' };
        const typeColors = { 1: 'primary', 2: 'info', 3: 'success', 4: 'warning', 5: 'secondary', 6: 'danger', 7: 'purple', 8: 'info', 9: 'dark' };

        step3QuizQuestions.forEach((q, idx) => {
            const typeNum = typeof q.type === 'string' ? parseInt(q.type) : q.type;
            const typeName = typeNames[typeNum] || 'غير محدد';
            const typeColor = typeColors[typeNum] || 'secondary';
            const diffLevel = parseInt(q.difficulty || q.difficultyLevel || '0');
            const stars = Array.from({ length: 5 }, (_, i) =>
                `<i class="feather-star star ${i < diffLevel ? 'active' : ''}" style="font-size: 11px;"></i>`
            ).join('');

            const item = document.createElement('div');
            item.className = 'question-item d-flex align-items-center';
            item.innerHTML = `
                <span class="badge bg-light text-dark me-3 fw-bold">${idx + 1}</span>
                <div class="flex-grow-1 min-width-0">
                    <div class="fw-medium text-truncate">${escapeHtml(q.text || q.questionText || '')}</div>
                    <div class="d-flex align-items-center gap-2 mt-1">
                        <span class="question-type-badge badge bg-soft-${typeColor} text-${typeColor}">${typeName}</span>
                        <span class="text-muted" style="font-size: 12px;">${q.points || 1} درجة</span>
                        <span class="difficulty-stars">${stars}</span>
                    </div>
                </div>
                <div class="d-flex gap-1 ms-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteQuizQuestion(${q.id})" title="حذف"><i class="feather-trash-2"></i></button>
                </div>
            `;
            list.appendChild(item);
        });

        if (typeof feather !== 'undefined') feather.replace();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function deleteQuizQuestion(questionId) {
        if (!confirm('هل أنت متأكد من حذف هذا السؤال؟')) return;

        try {
            const response = await fetch('/Instructor/Courses/QuickDeleteQuizQuestion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({ questionId: questionId })
            });

            const result = await response.json();
            if (result.success) {
                step3QuizQuestions = step3QuizQuestions.filter(q => q.id !== questionId);
                renderQuizQuestionsList();
                showToast('نجاح', 'تم حذف السؤال', 'success');
            } else {
                showToast('خطأ', result.message || 'فشل حذف السؤال', 'error');
            }
        } catch (error) {
            console.error('Error deleting question:', error);
            showToast('خطأ', 'حدث خطأ أثناء حذف السؤال', 'error');
        }
    }

    async function loadQuizQuestions(quizId) {
        try {
            const response = await fetch(`/Instructor/Courses/GetQuizQuestions?quizId=${quizId}`);
            const result = await response.json();
            if (result.success && result.questions) {
                step3QuizQuestions = result.questions;
                renderQuizQuestionsList();
            }
        } catch (error) {
            console.error('Error loading quiz questions:', error);
        }
    }

    async function loadQuestionBanks() {
        try {
            const response = await fetch('/Instructor/QuestionBank/GetBanksForSelect');
            const result = await response.json();
            // The endpoint returns { results: [...] } in Select2 format
            const banks = result.results || result.banks || (Array.isArray(result) ? result : []);
            const bankSelector = document.getElementById('bankSelector');
            const randomBankSelector = document.getElementById('randomBankSelector');

            [bankSelector, randomBankSelector].forEach(sel => {
                if (!sel) return;
                sel.innerHTML = '<option value="">-- اختر بنك أسئلة --</option>';
                banks.forEach(bank => {
                    sel.innerHTML += `<option value="${bank.id}">${escapeHtml(bank.text || bank.name || '')} (${bank.questionsCount || 0} سؤال)</option>`;
                });
            });
        } catch (error) {
            console.error('Error loading question banks:', error);
        }
    }

    async function loadBankQuestions() {
        const bankId = document.getElementById('bankSelector')?.value;
        const container = document.getElementById('bankQuestionsList');
        if (!bankId) {
            container.innerHTML = '<p class="text-muted text-center mb-0">اختر بنك أسئلة لعرض الأسئلة</p>';
            return;
        }

        container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> جارٍ التحميل...</div>';

        try {
            const typeFilter = document.getElementById('bankFilterType')?.value || '';
            const diffFilter = document.getElementById('bankFilterDifficulty')?.value || '';
            let url = `/Instructor/QuestionBank/GetBankQuestions?bankId=${bankId}`;
            if (typeFilter) url += `&type=${typeFilter}`;
            if (diffFilter) url += `&difficulty=${diffFilter}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.success && result.questions && result.questions.length > 0) {
                container.innerHTML = '';
                result.questions.forEach(q => {
                    container.innerHTML += `
                        <div class="bank-question-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${q.id}" id="bankQ${q.id}" onchange="updateImportSelectedBtn()">
                                <label class="form-check-label" for="bankQ${q.id}">
                                    <span class="fw-medium">${escapeHtml(q.text || q.questionText || '')}</span>
                                    <small class="text-muted d-block">${q.typeName || q.questionType || ''} • ${q.points || q.defaultPoints || 1} درجة</small>
                                </label>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p class="text-muted text-center mb-0 py-3">لا توجد أسئلة في هذا البنك</p>';
            }
        } catch (error) {
            console.error('Error loading bank questions:', error);
            container.innerHTML = '<p class="text-danger text-center mb-0">حدث خطأ أثناء التحميل</p>';
        }

        document.getElementById('importSelectedBtn').disabled = true;
    }

    function updateImportSelectedBtn() {
        const selected = document.querySelectorAll('#bankQuestionsList input[type="checkbox"]:checked');
        document.getElementById('importSelectedBtn').disabled = selected.length === 0;
    }

    async function importSelectedBankQuestions() {
        const quizId = window._createdQuizId;
        const bankId = document.getElementById('bankSelector')?.value;
        const selected = Array.from(document.querySelectorAll('#bankQuestionsList input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));

        // Anti-forgery token required for POST
        if (!antiForgeryToken) {
            showToast('فشل الاستيراد', 'جلسة غير صالحة. يرجى تحديث الصفحة والمحاولة مرة أخرى.', 'error');
            return;
        }
        // Validate inputs
        if (!quizId || quizId <= 0) {
            console.error('Import failed: quizId is invalid:', quizId);
            showToast('فشل الاستيراد', 'معرف الاختبار غير موجود. يرجى حفظ الدرس أولاً ثم المحاولة مرة أخرى.', 'error');
            return;
        }
        if (!bankId) {
            showToast('تنبيه', 'اختر بنك أسئلة أولاً', 'warning');
            return;
        }
        if (!selected.length || selected.some(id => isNaN(id))) {
            showToast('تنبيه', 'اختر أسئلة صالحة للاستيراد', 'warning');
            return;
        }

        const btn = document.getElementById('importSelectedBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الاستيراد...';

        const requestBody = { quizId: quizId, questionBankId: parseInt(bankId), questionBankItemIds: selected };
        console.log('Importing questions - request:', requestBody);

        try {
            const response = await fetch('/Instructor/QuestionBank/ImportToQuiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Import response status:', response.status);

            if (!response.ok) {
                let errorMessage = 'حدث خطأ في الخادم (الحالة: ' + response.status + ')';
                try {
                    const errorResult = await response.json();
                    errorMessage = errorResult.message || errorMessage;
                } catch {
                    const errorText = await response.text();
                    console.error('Import error (non-JSON):', response.status, errorText.substring(0, 500));
                }
                showToast('فشل الاستيراد', errorMessage, 'error');
                return;
            }

            const result = await response.json();
            console.log('Import result:', result);

            if (result.success) {
                showToast('نجاح', result.message || 'تم استيراد الأسئلة بنجاح', 'success');
                await loadQuizQuestions(quizId);
            } else {
                showToast('فشل الاستيراد', result.message || 'فشل الاستيراد', 'error');
            }
        } catch (error) {
            console.error('Error importing questions:', error);
            showToast('فشل الاستيراد', 'حدث خطأ أثناء الاستيراد: ' + (error.message || 'خطأ غير معروف'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="feather-download me-2"></i>استيراد المحدد';
            if (typeof feather !== 'undefined') feather.replace();
        }
    }

    async function randomImportBankQuestions() {
        const quizId = window._createdQuizId;
        const bankId = document.getElementById('randomBankSelector')?.value;
        const count = parseInt(document.getElementById('randomCount')?.value) || 5;
        const typeFilter = document.getElementById('randomFilterType')?.value || null;
        const diffFilter = document.getElementById('randomFilterDifficulty')?.value || null;

        // Validate inputs
        if (!quizId || quizId <= 0) {
            console.error('Random import failed: quizId is invalid:', quizId);
            showToast('خطأ', 'معرف الاختبار غير موجود. يرجى حفظ الدرس أولاً ثم المحاولة مرة أخرى.', 'error');
            return;
        }
        if (!bankId) { showToast('تنبيه', 'اختر بنك أسئلة', 'warning'); return; }

        const requestBody = {
            quizId: quizId,
            questionBankId: parseInt(bankId),
            count: count,
            questionType: typeFilter,
            difficultyLevel: diffFilter
        };
        console.log('Random import - request:', requestBody);

        try {
            const response = await fetch('/Instructor/QuestionBank/RandomImportToQuiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Random import response status:', response.status);

            if (!response.ok) {
                let errorMessage = 'حدث خطأ في الخادم (الحالة: ' + response.status + ')';
                try {
                    const errorResult = await response.json();
                    errorMessage = errorResult.message || errorMessage;
                } catch {
                    const errorText = await response.text();
                    console.error('Random import error (non-JSON):', response.status, errorText.substring(0, 500));
                }
                showToast('خطأ', errorMessage, 'error');
                return;
            }

            const result = await response.json();
            console.log('Random import result:', result);

            if (result.success) {
                showToast('نجاح', result.message || 'تم الاستيراد العشوائي بنجاح', 'success');
                await loadQuizQuestions(quizId);
            } else {
                showToast('خطأ', result.message || 'فشل الاستيراد', 'error');
            }
        } catch (error) {
            console.error('Error random importing:', error);
            showToast('خطأ', 'حدث خطأ أثناء الاستيراد: ' + (error.message || 'خطأ غير معروف'), 'error');
        }
    }

    // ========== ASSIGNMENT STEP 3 ==========
    function buildAssignmentStep3Html(lessonId, assignmentId) {
        return `
            <div class="row g-3">
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-header bg-soft-success">
                            <h6 class="mb-0 fw-bold"><i class="feather-edit-3 me-2 text-success"></i>تعليمات التكليف</h6>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="assignmentInstructions" rows="6" placeholder="أدخل تعليمات التكليف التفصيلية للطلاب..."></textarea>
                            <small class="text-muted mt-1 d-block"><i class="feather-info me-1"></i>يمكنك استخدام HTML لتنسيق التعليمات</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card step3-section-card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold"><i class="feather-settings me-2 text-muted"></i>ملخص الإعدادات</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="feather-award me-2 text-primary"></i>الدرجة القصوى: <strong>${document.getElementById('assignmentMaxPoints')?.value || 100}</strong></li>
                                <li class="mb-2"><i class="feather-clock me-2 text-warning"></i>مهلة التسليم: <strong>${document.getElementById('assignmentDueDays')?.value || 7} أيام</strong></li>
                                <li class="mb-2"><i class="feather-file-text me-2 text-info"></i>تسليم نصي: <strong>${document.getElementById('assignmentAllowTextSubmission')?.checked ? 'نعم' : 'لا'}</strong></li>
                                <li class="mb-0"><i class="feather-upload me-2 text-success"></i>رفع ملفات: <strong>${document.getElementById('assignmentAllowFileUpload')?.checked ? 'نعم' : 'لا'}</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card step3-section-card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 fw-bold"><i class="feather-file me-2 text-muted"></i>قيود الملفات</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="feather-paperclip me-2 text-muted"></i>الأنواع المقبولة: <strong>${document.getElementById('assignmentAcceptedFileTypes')?.value || '.pdf,.doc,.docx'}</strong></li>
                                <li class="mb-2"><i class="feather-hard-drive me-2 text-muted"></i>الحجم الأقصى: <strong>${document.getElementById('assignmentMaxFileSize')?.value || 50} MB</strong></li>
                                <li class="mb-0"><i class="feather-layers me-2 text-muted"></i>عدد الملفات: <strong>${document.getElementById('assignmentMaxFiles')?.value || 5}</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ========== VIDEO STEP 3 ==========
    function buildVideoStep3Html(lessonId) {
        const videoUrl = document.getElementById('lessonVideoUrlHidden')?.value || document.getElementById('newLessonVideoUrl')?.value || '';
        const source = document.getElementById('newLessonVideoSource')?.value || 'Library';

        let previewHtml = '';
        if (videoUrl) {
            if (source === 'YouTube' || videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                const ytId = extractYouTubeId(videoUrl);
                if (ytId) previewHtml = `<iframe class="w-100 rounded-3" style="aspect-ratio:16/9;" src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe>`;
            } else if (source === 'Vimeo' || videoUrl.includes('vimeo.com')) {
                const vId = extractVimeoId(videoUrl);
                if (vId) previewHtml = `<iframe class="w-100 rounded-3" style="aspect-ratio:16/9;" src="https://player.vimeo.com/video/${vId}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                previewHtml = `<video class="w-100 rounded-3" style="aspect-ratio:16/9;" src="${escapeHtml(videoUrl)}" controls></video>`;
            }
        }

        return `
            <div class="row g-3">
                ${previewHtml ? `<div class="col-12"><div class="card step3-section-card"><div class="card-header bg-soft-primary"><h6 class="mb-0 fw-bold"><i class="feather-video me-2 text-primary"></i>معاينة الفيديو</h6></div><div class="card-body">${previewHtml}</div></div></div>` : ''}
                <div class="col-12">
                    ${buildResourcesPanelHtml(lessonId)}
                </div>
            </div>
        `;
    }

    // ========== TEXT/ARTICLE STEP 3 ==========
    function buildTextStep3Html(lessonId, type) {
        const typeName = type === 'Article' ? 'المقال' : 'النص';
        return `
            <div class="row g-3">
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-header bg-soft-info">
                            <h6 class="mb-0 fw-bold"><i class="feather-file-text me-2 text-info"></i>محتوى ${typeName}</h6>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="step3HtmlContent" rows="8" placeholder="أدخل المحتوى HTML المحسّن...">${escapeHtml(document.getElementById('newLessonHtmlContent')?.value || '')}</textarea>
                            <small class="text-muted mt-1 d-block"><i class="feather-info me-1"></i>يمكنك استخدام HTML لتنسيق المحتوى</small>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    ${buildResourcesPanelHtml(lessonId)}
                </div>
            </div>
        `;
    }

    // ========== FILE STEP 3 (PDF/Audio/Download) ==========
    function buildFileStep3Html(lessonId, type) {
        const fileUrl = document.getElementById('lessonFileUrlHidden')?.value || document.getElementById('newLessonFileUrl')?.value || '';
        const typeNames = { 'PDF': 'ملف PDF', 'Audio': 'الملف الصوتي', 'Download': 'ملف التحميل' };
        const typeIcons = { 'PDF': 'file', 'Audio': 'headphones', 'Download': 'download' };

        let previewHtml = '';
        if (fileUrl) {
            if (type === 'PDF') {
                previewHtml = `<iframe class="w-100 rounded-3" style="height: 400px;" src="${escapeHtml(fileUrl)}" frameborder="0"></iframe>`;
            } else if (type === 'Audio') {
                previewHtml = `<audio class="w-100" src="${escapeHtml(fileUrl)}" controls></audio>`;
            } else {
                previewHtml = `<a href="${escapeHtml(fileUrl)}" class="btn btn-outline-primary" target="_blank"><i class="feather-download me-2"></i>تحميل الملف</a>`;
            }
        }

        return `
            <div class="row g-3">
                ${previewHtml ? `<div class="col-12"><div class="card step3-section-card"><div class="card-header bg-light"><h6 class="mb-0 fw-bold"><i class="feather-${typeIcons[type]} me-2 text-muted"></i>معاينة ${typeNames[type]}</h6></div><div class="card-body">${previewHtml}</div></div></div>` : ''}
                <div class="col-12">
                    ${buildResourcesPanelHtml(lessonId)}
                </div>
            </div>
        `;
    }

    // ========== LIVE CLASS STEP 3 ==========
    function buildLiveClassStep3Html(lessonId) {
        return `
            <div class="row g-3">
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-header bg-soft-danger">
                            <h6 class="mb-0 fw-bold"><i class="feather-video me-2 text-danger"></i>إعدادات البث المباشر</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">مزود الخدمة</label>
                                    <select class="form-select" id="liveClassProvider">
                                        <option value="Zoom">Zoom</option>
                                        <option value="Teams">Microsoft Teams</option>
                                        <option value="GoogleMeet">Google Meet</option>
                                        <option value="Other">أخرى</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">رابط الاجتماع</label>
                                    <input type="url" class="form-control" id="liveClassMeetingUrl" placeholder="https://zoom.us/j/..." dir="ltr">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">تاريخ ووقت البث</label>
                                    <input type="datetime-local" class="form-control" id="liveClassSchedule">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">المدة (بالدقائق)</label>
                                    <input type="number" class="form-control" id="liveClassDuration" min="15" value="60" placeholder="60">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function saveLiveClassStep3(lessonId) {
        const meetingUrl = document.getElementById('liveClassMeetingUrl')?.value?.trim();
        const schedule = document.getElementById('liveClassSchedule')?.value;
        const duration = parseInt(document.getElementById('liveClassDuration')?.value) || 60;
        const provider = document.getElementById('liveClassProvider')?.value || 'Other';

        if (meetingUrl || schedule) {
            await fetch('/Instructor/Courses/QuickUpdateLessonContent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    lessonId: lessonId,
                    videoUrl: meetingUrl,
                    videoProvider: provider,
                    durationSeconds: duration * 60,
                    scheduledAt: schedule || null
                })
            });
        }
    }

    // ========== EXTERNAL LINK STEP 3 ==========
    function buildExternalLinkStep3Html(lessonId) {
        const extUrl = document.getElementById('newLessonExternalUrl')?.value || '';
        return `
            <div class="row g-3">
                <div class="col-12">
                    <div class="card step3-section-card">
                        <div class="card-header bg-soft-info">
                            <h6 class="mb-0 fw-bold"><i class="feather-external-link me-2 text-info"></i>إعدادات الرابط الخارجي</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">الرابط</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="feather-link"></i></span>
                                    <input type="text" class="form-control" value="${escapeHtml(extUrl)}" readonly dir="ltr">
                                    <a href="${escapeHtml(extUrl)}" class="btn btn-outline-primary" target="_blank"><i class="feather-external-link"></i></a>
                                </div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-bold">سلوك الفتح</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="extLinkBehavior" id="extNewTab" value="newTab" checked>
                                        <label class="form-check-label" for="extNewTab">فتح في تبويب جديد</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="extLinkBehavior" id="extIframe" value="iframe">
                                        <label class="form-check-label" for="extIframe">عرض داخل إطار</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function saveExternalLinkStep3(lessonId) {
        const behavior = document.querySelector('input[name="extLinkBehavior"]:checked')?.value || 'newTab';
        await fetch('/Instructor/Courses/QuickUpdateLessonContent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': antiForgeryToken,
                'RequestVerificationToken': antiForgeryToken
            },
            body: JSON.stringify({
                lessonId: lessonId,
                isDownloadable: behavior === 'iframe' // reuse field: true = iframe, false = new tab
            })
        });
    }

    // ========== LESSON RESOURCES PANEL ==========
    function buildResourcesPanelHtml(lessonId) {
        return `
            <div class="card step3-section-card">
                <div class="card-header bg-light d-flex align-items-center justify-content-between">
                    <h6 class="mb-0 fw-bold"><i class="feather-paperclip me-2 text-muted"></i>مرفقات الدرس</h6>
                    <span class="badge bg-secondary" id="resourcesCount">0</span>
                </div>
                <div class="card-body">
                    <div id="lessonResourcesList" class="mb-3">
                        <p class="text-muted text-center mb-0" id="emptyResourcesMsg">لا توجد مرفقات بعد</p>
                    </div>
                    <div class="border rounded-3 p-3 bg-light">
                        <h6 class="fw-bold mb-3"><i class="feather-plus me-2"></i>إضافة مرفق جديد</h6>
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="newResourceTitle" placeholder="عنوان المرفق">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="newResourceUrl" placeholder="رابط الملف أو URL" dir="ltr">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-primary w-100" onclick="addLessonResource(${lessonId})">
                                    <i class="feather-plus me-1"></i>إضافة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadLessonResources(lessonId) {
        try {
            const response = await fetch(`/Instructor/Courses/GetLessonResources?lessonId=${lessonId}`);
            const result = await response.json();
            if (result.success && result.resources) {
                step3LessonResources = result.resources;
                renderLessonResources();
            }
        } catch (error) {
            console.error('Error loading resources:', error);
        }
    }

    function renderLessonResources() {
        const list = document.getElementById('lessonResourcesList');
        const countBadge = document.getElementById('resourcesCount');
        const emptyMsg = document.getElementById('emptyResourcesMsg');

        if (!list) return;

        if (countBadge) countBadge.textContent = step3LessonResources.length;

        if (step3LessonResources.length === 0) {
            if (emptyMsg) emptyMsg.style.display = 'block';
            list.querySelectorAll('.resource-item').forEach(el => el.remove());
            return;
        }

        if (emptyMsg) emptyMsg.style.display = 'none';
        list.querySelectorAll('.resource-item').forEach(el => el.remove());

        step3LessonResources.forEach(r => {
            const item = document.createElement('div');
            item.className = 'resource-item';
            item.innerHTML = `
                <i class="feather-file text-muted"></i>
                <div class="flex-grow-1">
                    <div class="fw-medium">${escapeHtml(r.title)}</div>
                    <small class="text-muted text-truncate d-block" style="max-width: 300px;" dir="ltr">${escapeHtml(r.url || r.fileUrl || '')}</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteLessonResource(${r.id})" title="حذف"><i class="feather-trash-2"></i></button>
            `;
            list.appendChild(item);
        });

        if (typeof feather !== 'undefined') feather.replace();
    }

    async function addLessonResource(lessonId) {
        const title = document.getElementById('newResourceTitle')?.value?.trim();
        const url = document.getElementById('newResourceUrl')?.value?.trim();

        if (!title || !url) {
            showToast('تنبيه', 'يرجى إدخال العنوان والرابط', 'warning');
            return;
        }

        try {
            const response = await fetch('/Instructor/Courses/QuickAddLessonResource', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({ lessonId: lessonId, title: title, resourceUrl: url })
            });

            const result = await response.json();
            if (result.success) {
                step3LessonResources.push(result.resource);
                renderLessonResources();
                document.getElementById('newResourceTitle').value = '';
                document.getElementById('newResourceUrl').value = '';
                showToast('نجاح', 'تمت إضافة المرفق', 'success');
            } else {
                showToast('خطأ', result.message || 'فشل إضافة المرفق', 'error');
            }
        } catch (error) {
            console.error('Error adding resource:', error);
            showToast('خطأ', 'حدث خطأ أثناء إضافة المرفق', 'error');
        }
    }

    async function deleteLessonResource(resourceId) {
        if (!confirm('هل أنت متأكد من حذف هذا المرفق؟')) return;

        try {
            const response = await fetch('/Instructor/Courses/QuickDeleteLessonResource', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({ resourceId: resourceId })
            });

            const result = await response.json();
            if (result.success) {
                step3LessonResources = step3LessonResources.filter(r => r.id !== resourceId);
                renderLessonResources();
                showToast('نجاح', 'تم حذف المرفق', 'success');
            } else {
                showToast('خطأ', result.message || 'فشل حذف المرفق', 'error');
            }
        } catch (error) {
            console.error('Error deleting resource:', error);
            showToast('خطأ', 'حدث خطأ أثناء الحذف', 'error');
        }
    }

    // ========== CONTENT DRIP MODULE FUNCTIONS ==========
    async function showModuleDripSettings(moduleId, btn) {
        // Check if popover already exists
        const existing = document.getElementById(`drip-popover-${moduleId}`);
        if (existing) { existing.remove(); return; }

        // Remove other popovers
        document.querySelectorAll('.drip-popover-container').forEach(el => el.remove());

        const popover = document.createElement('div');
        popover.id = `drip-popover-${moduleId}`;
        popover.className = 'drip-popover-container card shadow-lg border position-absolute';
        popover.style.cssText = 'z-index: 1050; width: 380px; right: 0; top: 100%;';
        popover.innerHTML = `
            <div class="card-header bg-soft-info py-2 d-flex align-items-center justify-content-between">
                <h6 class="mb-0 fw-bold" style="font-size: 13px;"><i class="feather-clock me-2 text-info"></i>جدولة المحتوى</h6>
                <button type="button" class="btn-close" style="font-size: 10px;" onclick="this.closest('.drip-popover-container').remove()"></button>
            </div>
            <div class="card-body p-3">
                <div id="dripRulesList-${moduleId}" class="mb-3">
                    <div class="text-center py-2"><span class="spinner-border spinner-border-sm"></span></div>
                </div>
                <hr class="my-2">
                <h6 class="fw-bold mb-2" style="font-size: 12px;">@Html.T("إضافة قاعدة جديدة", "Add new rule")</h6>
                <div class="mb-2">
                    <select class="form-select form-select-sm" id="dripTypeSelect-${moduleId}" onchange="toggleModuleDripFields(${moduleId})">
                        <option value="0">كل المحتوى فوراً</option>
                        <option value="1">بعد أيام من التسجيل</option>
                        <option value="3">في تاريخ محدد</option>
                        <option value="4">أسبوعياً</option>
                    </select>
                </div>
                <div id="dripDaysInput-${moduleId}" style="display: none;" class="mb-2">
                    <input type="number" class="form-control form-control-sm" id="dripDaysVal-${moduleId}" min="1" placeholder="عدد الأيام">
                </div>
                <div id="dripDateInput-${moduleId}" style="display: none;" class="mb-2">
                    <input type="datetime-local" class="form-control form-control-sm" id="dripDateVal-${moduleId}">
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="dripNotify-${moduleId}" checked>
                    <label class="form-check-label" for="dripNotify-${moduleId}" style="font-size: 12px;">إرسال إشعار</label>
                </div>
                <button type="button" class="btn btn-sm btn-primary w-100" onclick="saveModuleDripRule(${moduleId})">
                    <i class="feather-save me-1"></i>حفظ القاعدة
                </button>
            </div>
        `;

        btn.closest('.d-flex').style.position = 'relative';
        btn.closest('.d-flex').appendChild(popover);

        if (typeof feather !== 'undefined') feather.replace();

        // Load existing rules
        await loadModuleDripRules(moduleId);
    }

    function toggleModuleDripFields(moduleId) {
        const type = document.getElementById(`dripTypeSelect-${moduleId}`)?.value;
        const daysInput = document.getElementById(`dripDaysInput-${moduleId}`);
        const dateInput = document.getElementById(`dripDateInput-${moduleId}`);

        if (daysInput) daysInput.style.display = type === '1' ? 'block' : 'none';
        if (dateInput) dateInput.style.display = type === '3' ? 'block' : 'none';
    }

    async function loadModuleDripRules(moduleId) {
        const container = document.getElementById(`dripRulesList-${moduleId}`);
        if (!container) return;

        try {
            const response = await fetch(`/Instructor/Courses/GetContentDripRules?courseId=${courseId}`);
            const result = await response.json();
            if (result.success && result.rules) {
                const moduleRules = result.rules.filter(r => r.moduleId === moduleId);
                if (moduleRules.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center mb-0" style="font-size: 12px;">لا توجد قواعد جدولة</p>';
                } else {
                    const dripTypeNames = { 0: 'كل المحتوى فوراً', 1: 'بعد أيام من التسجيل', 3: 'تاريخ محدد', 4: 'أسبوعياً', 6: 'شهرياً', 7: 'متسلسل' };
                    container.innerHTML = moduleRules.map(r => `
                        <div class="drip-rule-item d-flex align-items-center justify-content-between">
                            <span><i class="feather-clock me-1 text-info"></i>${dripTypeNames[r.dripType] || 'غير محدد'}${r.daysAfterEnrollment ? ' (' + r.daysAfterEnrollment + ' يوم)' : ''}${r.specificDate ? ' (' + new Date(r.specificDate).toLocaleDateString('ar') + ')' : ''}</span>
                            <span class="badge ${r.isActive ? 'bg-success' : 'bg-secondary'}">${r.isActive ? 'نشط' : 'غير نشط'}</span>
                        </div>
                    `).join('');
                }
            } else {
                container.innerHTML = '<p class="text-muted text-center mb-0" style="font-size: 12px;">لا توجد قواعد جدولة</p>';
            }
        } catch (error) {
            container.innerHTML = '<p class="text-danger text-center mb-0" style="font-size: 12px;">خطأ في التحميل</p>';
        }

        if (typeof feather !== 'undefined') feather.replace();
    }

    async function saveModuleDripRule(moduleId) {
        const dripType = parseInt(document.getElementById(`dripTypeSelect-${moduleId}`)?.value || '0');
        const days = parseInt(document.getElementById(`dripDaysVal-${moduleId}`)?.value) || null;
        const dateVal = document.getElementById(`dripDateVal-${moduleId}`)?.value || null;
        const notify = document.getElementById(`dripNotify-${moduleId}`)?.checked || false;

        try {
            const response = await fetch('/Instructor/Courses/QuickAddContentDripRule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken,
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({
                    courseId: courseId,
                    moduleId: moduleId,
                    dripType: dripType,
                    daysAfterEnrollment: days,
                    specificDate: dateVal,
                    sendNotification: notify
                })
            });

            const result = await response.json();
            if (result.success) {
                showToast('نجاح', 'تم حفظ قاعدة الجدولة', 'success');
                await loadModuleDripRules(moduleId);
            } else {
                showToast('خطأ', result.message || 'فشل الحفظ', 'error');
            }
        } catch (error) {
            console.error('Error saving drip rule:', error);
            showToast('خطأ', 'حدث خطأ أثناء الحفظ', 'error');
        }
    }

    // ========== SORTABLE INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof Sortable !== 'undefined') {
            const modulesContainer = document.getElementById('modulesContainer');
            if (modulesContainer) {
                new Sortable(modulesContainer, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: async function (evt) {
                        const items = Array.from(modulesContainer.querySelectorAll('.module-card'))
                            .map((el, index) => ({
                                id: parseInt(el.dataset.moduleId),
                                order: index + 1
                            }));

                        await fetch('/Instructor/Courses/ReorderModules', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': antiForgeryToken,
                                'RequestVerificationToken': antiForgeryToken
                            },
                            body: JSON.stringify({ items: items })
                        });
                    }
                });
            }

            document.querySelectorAll('.lessons-list').forEach(lessonsList => {
                new Sortable(lessonsList, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: async function (evt) {
                        const items = Array.from(lessonsList.querySelectorAll('.lesson-row'))
                            .map((el, index) => ({
                                id: parseInt(el.dataset.lessonId),
                                order: index + 1
                            }));

                        await fetch('/Instructor/Courses/ReorderLessons', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': antiForgeryToken,
                                'RequestVerificationToken': antiForgeryToken
                            },
                            body: JSON.stringify({ items: items })
                        });
                    }
                });
            });
        }

        // Initialize feather icons if available
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
</script>

@functions {
    string GetLessonTypeColor(LMS.Domain.Enums.LessonType type)
    {
        return type switch
        {
            LMS.Domain.Enums.LessonType.Video => "bg-soft-primary text-primary",
            LMS.Domain.Enums.LessonType.Text => "bg-soft-info text-info",
            LMS.Domain.Enums.LessonType.Article => "bg-soft-info text-info",
            LMS.Domain.Enums.LessonType.Quiz => "bg-soft-warning text-warning",
            LMS.Domain.Enums.LessonType.Assignment => "bg-soft-success text-success",
            LMS.Domain.Enums.LessonType.Download => "bg-soft-secondary text-secondary",
            LMS.Domain.Enums.LessonType.LiveClass => "bg-soft-danger text-danger",
            LMS.Domain.Enums.LessonType.Audio => "bg-soft-purple text-purple",
            LMS.Domain.Enums.LessonType.PDF => "bg-soft-secondary text-secondary",
            LMS.Domain.Enums.LessonType.Interactive => "bg-soft-success text-success",
            LMS.Domain.Enums.LessonType.ExternalLink => "bg-soft-info text-info",
            _ => "bg-soft-primary text-primary"
        };
    }
}
