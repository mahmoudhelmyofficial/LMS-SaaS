@model LMS.Areas.Instructor.ViewModels.CourseWizardViewModel

<div class="step-1-basic-info">
    <div class="form-section">
        <h5 class="form-section-title">
            <i class="feather-info"></i>
            @Html.T("المعلومات الأساسية", "Basic Information")
        </h5>

        <div class="row g-4">
            <!-- Course Title -->
            <div class="col-12">
                <label class="form-label fw-bold">
                    @Html.T("عنوان الدورة", "Course Title")
                    <span class="text-danger">*</span>
                </label>
                <input asp-for="Title" 
                       class="form-control form-control-lg" 
                       placeholder="@Html.T("مثال: تعلم البرمجة بلغة Python من الصفر للاحتراف", "Example: Learn Python Programming from Zero to Pro")"
                       maxlength="300"
                       data-autosave="true" />
                <span asp-validation-for="Title" class="text-danger"></span>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">@Html.T("اختر عنواناً واضحاً وجذاباً يصف محتوى الدورة", "Choose a clear and attractive title that describes the course content")</small>
                    <small class="character-count" data-target="Title">
                        <span id="titleCount">0</span>/300
                    </small>
                </div>
            </div>

            <!-- Short Description -->
            <div class="col-12">
                <label class="form-label fw-bold">
                    @Html.T("الوصف المختصر", "Short Description")
                    <span class="text-danger">*</span>
                </label>
                <textarea asp-for="ShortDescription" 
                          class="form-control" 
                          rows="3"
                          placeholder="@Html.T("وصف قصير وجذاب يظهر في نتائج البحث وصفحات الدورات...", "A short and attractive description that appears in search results and course pages...")"
                          maxlength="500"
                          data-autosave="true"></textarea>
                <span asp-validation-for="ShortDescription" class="text-danger"></span>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">@Html.T("هذا الوصف يظهر في نتائج البحث (20-500 حرف)", "This description appears in search results (20-500 characters)")</small>
                    <small class="character-count" data-target="ShortDescription">
                        <span id="shortDescCount">0</span>/500
                    </small>
                </div>
            </div>

            <!-- Full Description (Rich Text) -->
            <div class="col-12">
                <label class="form-label fw-bold">
                    @Html.T("الوصف التفصيلي", "Detailed Description")
                    <span class="text-danger">*</span>
                </label>
                <div id="descriptionEditor" class="border rounded bg-white" style="min-height: 300px; direction: ltr;"></div>
                <input type="hidden" asp-for="Description" id="Description" />
                <span asp-validation-for="Description" class="text-danger"></span>
                <small class="text-muted d-block mt-2">@Html.T("وصف شامل يتضمن أهداف الدورة والمحتوى المقدم (100 حرف على الأقل)", "Comprehensive description including course objectives and content (at least 100 characters)")</small>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h5 class="form-section-title">
            <i class="feather-folder"></i>
            @Html.T("التصنيف والمستوى", "Category and Level")
        </h5>

        <div class="row g-4">
            <!-- Category -->
            <div class="col-md-6">
                <label class="form-label fw-bold">
                    @Html.T("التصنيف الرئيسي", "Main Category")
                    <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                    <select asp-for="CategoryId" 
                            class="form-select" 
                            asp-items="ViewBag.Categories"
                            id="categorySelect"
                            data-autosave="true">
                        <option value="">@Html.T("اختر التصنيف...", "Select Category...")</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="@Html.T("إضافة تصنيف جديد", "Add New Category")">
                        <i class="feather-plus"></i>
                    </button>
                </div>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>

            <!-- Subcategory (Optional) -->
            <div class="col-md-6">
                <label class="form-label fw-bold">
                    @Html.T("التصنيف الفرعي", "Subcategory")
                    <span class="text-muted">@Html.T("(اختياري)", "(Optional)")</span>
                </label>
                <div class="input-group">
                    <select asp-for="SubCategoryId" 
                            class="form-select" 
                            id="subcategorySelect"
                            data-autosave="true">
                        <option value="">@Html.T("-- بدون تصنيف فرعي --", "-- No Subcategory --")</option>
                        @if (ViewBag.SubCategories != null)
                        {
                            foreach (var item in (IEnumerable<SelectListItem>)ViewBag.SubCategories)
                            {
                                <option value="@item.Value" selected="@(item.Value == Model.SubCategoryId?.ToString())">@item.Text</option>
                            }
                        }
                    </select>
                    <button type="button" class="btn btn-outline-secondary" id="addSubcategoryBtn" data-bs-toggle="modal" data-bs-target="#addSubcategoryModal" title="@Html.T("إضافة تصنيف فرعي", "Add Subcategory")" disabled>
                        <i class="feather-plus"></i>
                    </button>
                </div>
                <small class="text-muted d-block mt-1">@Html.T("اختر التصنيف الرئيسي أولاً لإظهار التصنيفات الفرعية", "Select the main category first to show subcategories")</small>
            </div>

            <!-- Level -->
            <div class="col-md-6">
                <label class="form-label fw-bold">
                    @Html.T("المستوى", "Level")
                    <span class="text-danger">*</span>
                </label>
                <select asp-for="Level" class="form-select" asp-items="ViewBag.Levels" data-autosave="true">
                </select>
                <span asp-validation-for="Level" class="text-danger"></span>
                <small class="text-muted d-block mt-2">@Html.T("حدد مستوى الصعوبة المناسب للجمهور المستهدف", "Set the appropriate difficulty level for the target audience")</small>
            </div>

            <!-- Language -->
            <div class="col-md-6">
                <label class="form-label fw-bold">
                    @Html.T("لغة الدورة", "Course Language")
                    <span class="text-danger">*</span>
                </label>
                <select asp-for="Language" class="form-select" asp-items="ViewBag.Languages" data-autosave="true">
                </select>
                <span asp-validation-for="Language" class="text-danger"></span>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-folder-plus me-2 text-primary"></i>
                    @Html.T("إضافة تصنيف جديد", "Add New Category")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("اسم التصنيف", "Category Name") <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newCategoryName" placeholder="@Html.T("مثال: البرمجة والتطوير", "Example: Programming and Development")" maxlength="100">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("وصف التصنيف", "Category Description")</label>
                    <textarea class="form-control" id="newCategoryDescription" rows="2" placeholder="@Html.T("وصف مختصر للتصنيف...", "Brief description of the category...")" maxlength="500"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("أيقونة التصنيف", "Category Icon")</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="feather-book" id="categoryIconPreview"></i></span>
                        <input type="text" class="form-control" id="newCategoryIcon" placeholder="book" value="book">
                    </div>
                    <small class="text-muted">@Html.T("اختر أيقونة من", "Choose an icon from") <a href="https://feathericons.com/" target="_blank">Feather Icons</a></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                <button type="button" class="btn btn-primary" onclick="addNewCategory()">
                    <i class="feather-plus me-2"></i>
                    @Html.T("إضافة التصنيف", "Add Category")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Subcategory Modal -->
<div class="modal fade" id="addSubcategoryModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-folder-plus me-2 text-secondary"></i>
                    @Html.T("إضافة تصنيف فرعي", "Add Subcategory")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("التصنيف الرئيسي", "Main Category")</label>
                    <input type="text" class="form-control" id="parentCategoryName" readonly>
                    <input type="hidden" id="parentCategoryId">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("اسم التصنيف الفرعي", "Subcategory Name") <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newSubcategoryName" placeholder="@Html.T("مثال: تطوير الويب", "Example: Web Development")" maxlength="100">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">@Html.T("وصف التصنيف الفرعي", "Subcategory Description")</label>
                    <textarea class="form-control" id="newSubcategoryDescription" rows="2" placeholder="@Html.T("وصف مختصر...", "Brief description...")" maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                <button type="button" class="btn btn-primary" onclick="addNewSubcategory()">
                    <i class="feather-plus me-2"></i>
                    @Html.T("إضافة التصنيف الفرعي", "Add Subcategory")
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Character counters
        function updateCharCount(input, counterId) {
            const counter = document.getElementById(counterId);
            if (counter && input) {
                counter.textContent = input.value.length;
                
                const parent = counter.closest('.character-count');
                if (parent) {
                    parent.classList.remove('warning', 'error');
                    const max = parseInt(input.maxLength);
                    if (input.value.length > max * 0.9) {
                        parent.classList.add('warning');
                    }
                    if (input.value.length >= max) {
                        parent.classList.add('error');
                    }
                }
            }
        }

        const titleInput = document.getElementById('Title');
        const shortDescInput = document.getElementById('ShortDescription');

        if (titleInput) {
            updateCharCount(titleInput, 'titleCount');
            titleInput.addEventListener('input', () => updateCharCount(titleInput, 'titleCount'));
        }

        if (shortDescInput) {
            updateCharCount(shortDescInput, 'shortDescCount');
            shortDescInput.addEventListener('input', () => updateCharCount(shortDescInput, 'shortDescCount'));
        }

        // Subcategory dynamic loading
        const categorySelect = document.getElementById('categorySelect');
        const subcategorySelect = document.getElementById('subcategorySelect');
        const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');

        if (categorySelect && subcategorySelect) {
            categorySelect.addEventListener('change', async function() {
                const categoryId = this.value;
                const selectedOption = this.options[this.selectedIndex];
                
                // Update parent category info for subcategory modal
                document.getElementById('parentCategoryId').value = categoryId;
                document.getElementById('parentCategoryName').value = selectedOption.text;
                
                // Enable/disable add subcategory button
                addSubcategoryBtn.disabled = !categoryId;

                // Clear and show loading
                subcategorySelect.innerHTML = '<option value="">@Html.T("جاري التحميل...", "Loading...")</option>';

                if (!categoryId) {
                    subcategorySelect.innerHTML = '<option value="">@Html.T("-- بدون تصنيف فرعي --", "-- No Subcategory --")</option>';
                    return;
                }

                try {
                    const response = await fetch(`/Instructor/Courses/GetSubcategories?categoryId=${categoryId}`);
                    const subcategories = await response.json();

                    subcategorySelect.innerHTML = '<option value="">@Html.T("-- بدون تصنيف فرعي --", "-- No Subcategory --")</option>';
                    
                    if (subcategories && subcategories.length > 0) {
                        subcategories.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub.id;
                            option.textContent = sub.name;
                            subcategorySelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading subcategories:', error);
                    subcategorySelect.innerHTML = '<option value="">@Html.T("-- بدون تصنيف فرعي --", "-- No Subcategory --")</option>';
                }
            });
            
            // Trigger change if category is already selected
            if (categorySelect.value) {
                categorySelect.dispatchEvent(new Event('change'));
            }
        }

        // Icon preview
        const iconInput = document.getElementById('newCategoryIcon');
        const iconPreview = document.getElementById('categoryIconPreview');
        
        if (iconInput && iconPreview) {
            iconInput.addEventListener('input', function() {
                iconPreview.className = 'feather-' + (this.value || 'book');
            });
        }
    });

    // Add new category
    async function addNewCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        const description = document.getElementById('newCategoryDescription').value.trim();
        const icon = document.getElementById('newCategoryIcon').value.trim() || 'book';

        if (!name) {
            alert('@Html.T("يرجى إدخال اسم التصنيف", "Please enter the category name")');
            return;
        }

        const antiForgeryToken = document.querySelector('[name="__RequestVerificationToken"]').value;

        try {
            const response = await fetch('/Instructor/Courses/AddCategory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    icon: icon
                })
            });

            const result = await response.json();

            if (result.success) {
                // Add new option to category select
                const categorySelect = document.getElementById('categorySelect');
                const option = document.createElement('option');
                option.value = result.category.id;
                option.textContent = result.category.name;
                categorySelect.appendChild(option);
                
                // Select the new category
                categorySelect.value = result.category.id;
                categorySelect.dispatchEvent(new Event('change'));
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                document.getElementById('newCategoryName').value = '';
                document.getElementById('newCategoryDescription').value = '';
                document.getElementById('newCategoryIcon').value = 'book';
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('@Html.T("تم إضافة التصنيف بنجاح", "Category added successfully")', 'success');
                }
            } else {
                alert(result.message || '@Html.T("فشل إضافة التصنيف", "Failed to add category")');
            }
        } catch (error) {
            console.error('Error adding category:', error);
            alert('@Html.T("حدث خطأ أثناء إضافة التصنيف", "An error occurred while adding the category")');
        }
    }

    // Add new subcategory
    async function addNewSubcategory() {
        const parentId = document.getElementById('parentCategoryId').value;
        const name = document.getElementById('newSubcategoryName').value.trim();
        const description = document.getElementById('newSubcategoryDescription').value.trim();

        if (!parentId) {
            alert('@Html.T("يرجى اختيار التصنيف الرئيسي أولاً", "Please select the main category first")');
            return;
        }

        if (!name) {
            alert('@Html.T("يرجى إدخال اسم التصنيف الفرعي", "Please enter the subcategory name")');
            return;
        }

        const antiForgeryToken = document.querySelector('[name="__RequestVerificationToken"]').value;

        try {
            const response = await fetch('/Instructor/Courses/AddSubcategory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': antiForgeryToken
                },
                body: JSON.stringify({
                    parentCategoryId: parseInt(parentId),
                    name: name,
                    description: description
                })
            });

            const result = await response.json();

            if (result.success) {
                // Add new option to subcategory select
                const subcategorySelect = document.getElementById('subcategorySelect');
                const option = document.createElement('option');
                option.value = result.subcategory.id;
                option.textContent = result.subcategory.name;
                subcategorySelect.appendChild(option);
                
                // Select the new subcategory
                subcategorySelect.value = result.subcategory.id;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('addSubcategoryModal')).hide();
                document.getElementById('newSubcategoryName').value = '';
                document.getElementById('newSubcategoryDescription').value = '';
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('@Html.T("تم إضافة التصنيف الفرعي بنجاح", "Subcategory added successfully")', 'success');
                }
            } else {
                alert(result.message || '@Html.T("فشل إضافة التصنيف الفرعي", "Failed to add subcategory")');
            }
        } catch (error) {
            console.error('Error adding subcategory:', error);
            alert('@Html.T("حدث خطأ أثناء إضافة التصنيف الفرعي", "An error occurred while adding the subcategory")');
        }
    }
</script>
