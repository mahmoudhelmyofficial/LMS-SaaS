@model LMS.Areas.Instructor.ViewModels.CourseCreateViewModel

@{
    ViewData["Title"] = Html.T("إنشاء دورة جديدة", "Create New Course");
    ViewData["Subtitle"] = Html.T("أضف دورة تعليمية جديدة إلى منصتك", "Add a new course to your platform");
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Create" method="post" enctype="multipart/form-data" id="courseForm">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2 text-primary"></i>
                            @Html.T("المعلومات الأساسية", "Basic information")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("عنوان الدورة", "Course title") <span class="text-danger">*</span></label>
                                <input asp-for="Title" class="form-control" placeholder="@Html.T("مثال: تطوير تطبيقات الويب باستخدام ASP.NET Core", "e.g. Building web applications with ASP.NET Core")">
                                <span asp-validation-for="Title" class="text-danger"></span>
                                <div class="form-text">@Html.T("اختر عنواناً واضحاً وجذاباً يصف محتوى الدورة", "Choose a clear, attractive title that describes the course")</div>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("نبذة مختصرة", "Short description") <span class="text-danger">*</span></label>
                                <textarea asp-for="ShortDescription" class="form-control" rows="3" placeholder="@Html.T("وصف مختصر عن الدورة", "Brief description of the course")"></textarea>
                                <span asp-validation-for="ShortDescription" class="text-danger"></span>
                                <div class="form-text">@Html.T("وصف قصير يظهر في نتائج البحث (حتى 200 حرف)", "Short text for search results (up to 200 chars)")</div>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("الوصف التفصيلي", "Full description") <span class="text-danger">*</span></label>
                                <textarea asp-for="Description" class="form-control" rows="6" id="descriptionEditor"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                                <div class="form-text">@Html.T("وصف شامل يتضمن أهداف الدورة والمحتوى المقدم", "Full description including course objectives and content")</div>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("التصنيف", "Category") <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.Categories" id="categorySelect">
                                        <option value="">@Html.T("اختر التصنيف", "Choose category")</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="@Html.T("إضافة تصنيف جديد", "Add new category")">
                                        <i class="feather-plus"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("التصنيف الفرعي", "Subcategory")</label>
                                <div class="input-group">
                                    <select asp-for="SubCategoryId" class="form-select" id="subcategorySelect">
                                        <option value="">-- @Html.T("بدون تصنيف فرعي", "No subcategory") --</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" id="addSubcategoryBtn" data-bs-toggle="modal" data-bs-target="#addSubcategoryModal" title="@Html.T("إضافة تصنيف فرعي", "Add subcategory")" disabled>
                                        <i class="feather-plus"></i>
                                    </button>
                                </div>
                                <small class="text-muted">@Html.T("اختر التصنيف الرئيسي أولاً", "Choose category first")</small>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("المستوى", "Level") <span class="text-danger">*</span></label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">@Html.T("اختر المستوى", "Choose level")</option>
                                    <option value="Beginner">@Html.T("مبتدئ", "Beginner")</option>
                                    <option value="Intermediate">@Html.T("متوسط", "Intermediate")</option>
                                    <option value="Advanced">@Html.T("متقدم", "Advanced")</option>
                                    <option value="AllLevels">@Html.T("جميع المستويات", "All levels")</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("اللغة", "Language") <span class="text-danger">*</span></label>
                                <select asp-for="Language" class="form-select">
                                    <option value="Arabic">@Html.T("العربية", "Arabic")</option>
                                    <option value="English">@Html.T("الإنجليزية", "English")</option>
                                    <option value="French">@Html.T("الفرنسية", "French")</option>
                                </select>
                                <span asp-validation-for="Language" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("مدة الدورة (بالساعات)", "Course duration (hours)")</label>
                                <input asp-for="DurationHours" type="number" class="form-control" min="0" step="0.5" placeholder="5">
                                <span asp-validation-for="DurationHours" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Content -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-book-open me-2 text-primary"></i>
                            @Html.T("ما ستتعلمه في هذه الدورة", "What you'll learn")
                        </h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">@Html.T("نقاط التعلم الرئيسية", "Key learning points")</label>
                        <div id="learningPointsContainer">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" name="LearningPoints[0]" placeholder="@Html.T("مثال: فهم أساسيات البرمجة", "e.g. Understand programming basics")">
                                <button class="btn btn-outline-danger" type="button" onclick="removeLearningPoint(this)">
                                    <i class="feather-x"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-light" onclick="addLearningPoint()">
                            <i class="feather-plus me-2"></i>
                            @Html.T("إضافة نقطة جديدة", "Add new point")
                        </button>
                    </div>
                </div>

                <!-- Requirements -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-check-square me-2 text-primary"></i>
                            @Html.T("المتطلبات الأساسية", "Prerequisites")
                        </h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">@Html.T("ما يحتاجه الطالب قبل البدء", "What the student needs before starting")</label>
                        <div id="requirementsContainer">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" name="Requirements[0]" placeholder="@Html.T("مثال: معرفة أساسية بالكمبيوتر", "e.g. Basic computer knowledge")">
                                <button class="btn btn-outline-danger" type="button" onclick="removeRequirement(this)">
                                    <i class="feather-x"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-light" onclick="addRequirement()">
                            <i class="feather-plus me-2"></i>
                            @Html.T("إضافة متطلب جديد", "Add new requirement")
                        </button>
                    </div>
                </div>

                <!-- Media -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-image me-2 text-primary"></i>
                            @Html.T("الصور والوسائط", "Images & media")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "ThumbnailUrl" },
                                    { "FieldId", "thumbnailUrl" },
                                    { "Label", Html.T("صورة الدورة المصغرة", "Course thumbnail") },
                                    { "MediaType", "Image" },
                                    { "CurrentValue", "" },
                                    { "Required", true },
                                    { "HelpText", Html.T("الحجم الموصى به: 1280x720 بكسل", "Recommended size: 1280x720 px") },
                                    { "AspectRatio", "16/9" }
                                })
                            </div>

                            <div class="col-lg-12">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "IntroVideoUrl" },
                                    { "FieldId", "introVideoUrl" },
                                    { "Label", Html.T("فيديو تعريفي (اختياري)", "Intro video (optional)").ToString() },
                                    { "MediaType", "Video" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("فيديو قصير 1-3 دقائق يعرض محتوى الدورة", "Short 1-3 min video presenting the course").ToString() },
                                    { "AspectRatio", "16/9" }
                                })
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publishing Options -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("خيارات النشر", "Publishing options")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">@Html.T("الحالة", "Status")</label>
                            <select asp-for="Status" class="form-select">
                                <option value="Draft">@Html.T("مسودة", "Draft")</option>
                                <option value="PendingReview">@Html.T("جاهز للمراجعة", "Ready for review")</option>
                                <option value="Published">@Html.T("نشر مباشرة", "Publish now")</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("السعر", "Pricing")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">@Html.T("نوع الدورة", "Course type")</label>
                            <select class="form-select" id="courseType" onchange="togglePricing()">
                                <option value="paid">@Html.T("مدفوعة", "Paid")</option>
                                <option value="free">@Html.T("مجانية", "Free")</option>
                            </select>
                        </div>

                        <div id="pricingSection">
                            <div class="mb-4">
                                <label class="form-label">@Html.T("السعر", "Price") <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input asp-for="Price" type="number" class="form-control" min="0" step="0.01" placeholder="99.00">
                                    <span class="input-group-text">ر.س</span>
                                </div>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">@Html.T("سعر الخصم (اختياري)", "Discount price (optional)")</label>
                                <div class="input-group">
                                    <input asp-for="DiscountPrice" type="number" class="form-control" min="0" step="0.01" placeholder="79.00">
                                    <span class="input-group-text">ر.س</span>
                                </div>
                                <span asp-validation-for="DiscountPrice" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEO Settings -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("تحسين محركات البحث (SEO)", "SEO")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">@Html.T("عنوان SEO", "SEO title")</label>
                            <input asp-for="MetaTitle" class="form-control" placeholder="@Html.T("عنوان يظهر في محركات البحث", "Title shown in search engines")">
                            <span asp-validation-for="MetaTitle" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">@Html.T("وصف SEO", "SEO description")</label>
                            <textarea asp-for="MetaDescription" class="form-control" rows="3" placeholder="@Html.T("وصف قصير يظهر في نتائج البحث", "Short description shown in search results")"></textarea>
                            <span asp-validation-for="MetaDescription" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">@Html.T("الكلمات المفتاحية", "Keywords")</label>
                            <input asp-for="MetaKeywords" class="form-control" placeholder="@Html.T("برمجة, تطوير, ويب", "programming, development, web")">
                            <span asp-validation-for="MetaKeywords" class="text-danger"></span>
                            <div class="form-text">@Html.T("افصل الكلمات بفاصلة", "Separate with commas")</div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الإعدادات", "Settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input asp-for="IsPublic" class="form-check-input" type="checkbox" id="isPublic" checked>
                            <label class="form-check-label" for="isPublic">@Html.T("دورة عامة (يمكن البحث عنها)", "Public course (searchable)")</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input asp-for="AllowDiscussions" class="form-check-input" type="checkbox" id="allowDiscussions" checked>
                            <label class="form-check-label" for="allowDiscussions">@Html.T("السماح بالمناقشات", "Allow discussions")</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input asp-for="EnableCertificate" class="form-check-input" type="checkbox" id="enableCertificate">
                            <label class="form-check-label" for="enableCertificate">@Html.T("إصدار شهادة عند الإكمال", "Issue certificate on completion")</label>
                        </div>

                        <div class="form-check form-switch">
                            <input asp-for="EnableDrip" class="form-check-input" type="checkbox" id="enableDrip">
                            <label class="form-check-label" for="enableDrip">@Html.T("تفعيل المحتوى التدريجي", "Enable content drip")</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <a href="@Url.Action("Index")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء", "Cancel")
                            </a>
                            <div class="d-flex gap-2">
                                <button type="submit" name="saveAction" value="draft" class="btn btn-light">
                                    <i class="feather-save me-2"></i>
                                    @Html.T("حفظ كمسودة", "Save as draft")
                                </button>
                                <button type="submit" name="saveAction" value="publish" class="btn btn-primary">
                                    <i class="feather-check me-2"></i>
                                    @Html.T("حفظ ونشر", "Save and publish")
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@* Category Modals for On-the-Fly Creation *@
@await Html.PartialAsync("_CategoryModals")

@section Scripts {
    <script src="~/js/instructor-category-manager.js"></script>
    @await Html.PartialAsync("_TinyMCEScripts")
    <script>
        // Initialize TinyMCE for description editor
        initTinyMCE('#descriptionEditor', { height: 400 });

        // Initialize Category Manager for on-the-fly category creation
        document.addEventListener('DOMContentLoaded', function() {
            InstructorCategoryManager.init({
                categorySelectId: 'categorySelect',
                subcategorySelectId: 'subcategorySelect',
                addSubcategoryBtnId: 'addSubcategoryBtn',
                apiBaseUrl: '/Instructor/Courses'
            });
        });

        // Learning Points management
        let learningPointIndex = 1;
        function addLearningPoint() {
            const container = document.getElementById('learningPointsContainer');
            const html = `
                <div class="input-group mb-3">
                    <input type="text" class="form-control" name="LearningPoints[${learningPointIndex}]" placeholder="@Html.T("أضف نقطة تعلم جديدة", "Add learning point")">
                    <button class="btn btn-outline-danger" type="button" onclick="removeLearningPoint(this)">
                        <i class="feather-x"></i>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            learningPointIndex++;
        }

        function removeLearningPoint(btn) {
            btn.closest('.input-group').remove();
        }

        // Requirements management
        let requirementIndex = 1;
        function addRequirement() {
            const container = document.getElementById('requirementsContainer');
            const html = `
                <div class="input-group mb-3">
                    <input type="text" class="form-control" name="Requirements[${requirementIndex}]" placeholder="@Html.T("أضف متطلب جديد", "Add requirement")">
                    <button class="btn btn-outline-danger" type="button" onclick="removeRequirement(this)">
                        <i class="feather-x"></i>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            requirementIndex++;
        }

        function removeRequirement(btn) {
            btn.closest('.input-group').remove();
        }

        // Pricing toggle
        function togglePricing() {
            const courseType = document.getElementById('courseType').value;
            const pricingSection = document.getElementById('pricingSection');
            if (courseType === 'free') {
                pricingSection.style.display = 'none';
                document.querySelector('[name="Price"]').value = '0';
            } else {
                pricingSection.style.display = 'block';
            }
        }

        // Thumbnail preview
        function previewThumbnail(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('thumbnailPreview');
                    preview.querySelector('img').src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Form validation
        document.getElementById('courseForm').addEventListener('submit', function(e) {
            const title = document.querySelector('[name="Title"]').value;
            const description = tinymce.get('descriptionEditor').getContent();
            
            if (!title || !description) {
                e.preventDefault();
                alert('@Html.Raw(Html.T("يرجى ملء جميع الحقول المطلوبة", "Please fill all required fields").Replace("'", "\\'"))');
                return false;
            }
        });
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

