@model LMS.Areas.Instructor.ViewModels.LearningPathCreateViewModel

@{
    ViewData["Title"] = Html.T("إنشاء مسار تعلم جديد", "Create New Learning Path");
    ViewData["Subtitle"] = Html.T("أضف مسار تعلم لتجميع دوراتك بطريقة منظمة", "Add learning path to organize your courses");
    var indexUrl = Url.Action("Index");
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw($@"
        <a href='{indexUrl}' class='btn btn-light'>
            <i class='feather-arrow-right me-2'></i>
            " + Html.T("العودة", "Back") + @"
        </a>
    ") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <div class="d-flex align-items-start">
                <i class="feather-alert-circle me-3 mt-1 fs-4"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading fw-bold mb-2">@Html.T("يرجى تصحيح الأخطاء التالية:", "Please correct the following errors:")</h6>
                    <ul class="mb-0 ps-3">
                        @foreach (var modelState in ViewData.ModelState.Values)
                        {
                            foreach (var error in modelState.Errors)
                            {
                                <li>@error.ErrorMessage</li>
                            }
                        }
                    </ul>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="@Html.T("إغلاق", "Close")"></button>
        </div>
    }

    <form asp-action="Create" method="post" id="learningPathForm" data-msg-select-course="@Html.T("يرجى اختيار دورة واحدة على الأقل", "Please select at least one course")" data-msg-enter-price="@Html.T("يرجى إدخال سعر صحيح أو اختيار \"مسار مجاني\"", "Please enter a valid price or select \"Free path\"")" data-currency-suffix="@(ViewBag.DefaultCurrencySymbol ?? Html.T("ر.س", "SAR"))">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2 text-primary"></i>
                            @Html.T("المعلومات الأساسية", "Basic Information")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("اسم المسار", "Path name") <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="@Html.T("مثال: مسار تطوير تطبيقات الويب الكامل", "e.g. Full-stack web development path")">
                                <span asp-validation-for="Name" class="text-danger"></span>
                                <div class="form-text">@Html.T("اختر اسماً واضحاً وجذاباً للمسار", "Choose a clear and attractive name for the path")</div>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("نبذة مختصرة", "Short description") <span class="text-danger">*</span></label>
                                <textarea asp-for="ShortDescription" class="form-control" rows="3" placeholder="@Html.T("وصف مختصر عن المسار", "Brief description of the path")"></textarea>
                                <span asp-validation-for="ShortDescription" class="text-danger"></span>
                                <div class="form-text">@Html.T("وصف قصير يظهر في البطاقة (حتى 200 حرف)", "Short description shown on the card (up to 200 characters)")</div>
                            </div>

                            <div class="col-lg-12">
                                <label class="form-label">@Html.T("الوصف التفصيلي", "Full description")</label>
                                <textarea asp-for="Description" class="form-control" rows="6" placeholder="@Html.T("وصف شامل عن المسار، ماذا سيتعلم الطالب، والفوائد المتوقعة", "Full description of the path, what the student will learn, and expected benefits")"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                                <div class="form-text">@Html.T("وصف شامل يوضح محتويات المسار وفوائده", "Full description of the path contents and benefits")</div>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("المستوى", "Level") <span class="text-danger">*</span></label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">-- @Html.T("اختر المستوى", "Select level") --</option>
                                    <option value="Beginner">@Html.T("مبتدئ", "Beginner")</option>
                                    <option value="Intermediate">@Html.T("متوسط", "Intermediate")</option>
                                    <option value="Advanced">@Html.T("متقدم", "Advanced")</option>
                                    <option value="AllLevels">@Html.T("جميع المستويات", "All levels")</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>

                            <div class="col-lg-6">
                                <label class="form-label">@Html.T("ترتيب العرض", "Display order")</label>
                                <input asp-for="DisplayOrder" type="number" class="form-control" placeholder="0">
                                <span asp-validation-for="DisplayOrder" class="text-danger"></span>
                                <div class="form-text">@Html.T("الترتيب في صفحة مسارات التعلم (الأقل أولاً)", "Order on the learning paths page (lowest first)")</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Courses Selection -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-book me-2 text-primary"></i>
                            @Html.T("الدورات المتضمنة", "Included Courses")
                        </h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">@Html.T("اختر الدورات", "Select courses") <span class="text-danger">*</span></label>
                        <select asp-for="CourseIds" class="form-select" asp-items="ViewBag.Courses" multiple size="10">
                        </select>
                        <span asp-validation-for="CourseIds" class="text-danger"></span>
                        <div class="form-text">
                            <i class="feather-info me-1"></i>
                            @Html.T("اختر دورة واحدة على الأقل. استخدم Ctrl/Cmd للاختيار المتعدد. سيتم ترتيب الدورات حسب اختيارك.", "Select at least one course. Use Ctrl/Cmd for multiple selection. Courses will be ordered as you selected.")
                        </div>

                        <div id="selectedCoursesPreview" class="mt-4" style="display: none;">
                            <h6 class="fw-bold mb-3">@Html.T("الدورات المختارة (بالترتيب):", "Selected courses (in order):")</h6>
                            <div id="selectedCoursesList" class="list-group"></div>
                            <div class="alert alert-info mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>@Html.T("عدد الدورات:", "Number of courses:")</span>
                                    <span class="fw-bold" id="totalCoursesCount">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>@Html.T("الوقت المقدر الإجمالي:", "Total estimated time:")</span>
                                    <span class="fw-bold" id="totalEstimatedHours">0 @Html.T("ساعة", "hours")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-image me-2 text-primary"></i>
                            @Html.T("الصور", "Images")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "ThumbnailUrl" },
                                    { "FieldId", "thumbnailUrl" },
                                    { "Label", Html.T("الصورة المصغرة", "Thumbnail") },
                                    { "MediaType", "Image" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("الحجم الموصى به: 400x300 بكسل", "Recommended size: 400x300 pixels") },
                                    { "AspectRatio", "4/3" }
                                })
                            </div>

                            <div class="col-lg-6">
                                @await Html.PartialAsync("_MediaPicker", new ViewDataDictionary(ViewData) {
                                    { "FieldName", "BannerUrl" },
                                    { "FieldId", "bannerUrl" },
                                    { "Label", Html.T("صورة البانر", "Banner image") },
                                    { "MediaType", "Image" },
                                    { "CurrentValue", "" },
                                    { "Required", false },
                                    { "HelpText", Html.T("الحجم الموصى به: 1920x600 بكسل", "Recommended size: 1920x600 pixels") },
                                    { "AspectRatio", "16/5" }
                                })
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Pricing -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            @{ ViewBag.CurrencyIconClass = "me-2 text-success"; }
                            @await Html.PartialAsync("_CurrencyIcon")
                            @Html.T("التسعير", "Pricing")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-4">
                            <input asp-for="IsFree" class="form-check-input" type="checkbox" id="isFreeSwitch">
                            <label class="form-check-label" for="isFreeSwitch">
                                @Html.T("مسار مجاني", "Free path")
                            </label>
                        </div>

                        <div id="pricingFields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">@Html.T("السعر الأصلي", "Original price") <span class="text-danger">*</span></label>
                                <input asp-for="Price" type="number" step="0.01" class="form-control" placeholder="0.00">
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@Html.T("السعر بعد الخصم", "Price after discount")</label>
                                <input asp-for="DiscountedPrice" type="number" step="0.01" class="form-control" placeholder="0.00">
                                <span asp-validation-for="DiscountedPrice" class="text-danger"></span>
                                <div class="form-text">@Html.T("اتركه فارغاً إذا لم يكن هناك خصم", "Leave empty if there is no discount")</div>
                            </div>

                            <div id="savingsDisplay" class="alert alert-success" style="display: none;">
                                <div class="d-flex justify-content-between">
                                    <span>@Html.T("نسبة الخصم:", "Discount percentage:")</span>
                                    <span class="fw-bold" id="discountPercentage">0%</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>@Html.T("قيمة التوفير:", "Savings amount:")</span>
                                    <span class="fw-bold" id="savingsAmount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Publishing -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-eye me-2 text-info"></i>
                            @Html.T("النشر", "Publishing")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input asp-for="IsPublished" class="form-check-input" type="checkbox" id="isPublishedSwitch">
                            <label class="form-check-label" for="isPublishedSwitch">
                                @Html.T("نشر المسار فوراً", "Publish path immediately")
                            </label>
                        </div>
                        <div class="form-text mt-2">
                            <i class="feather-info me-1"></i>
                            @Html.T("إذا لم يتم النشر، سيبقى المسار كمسودة", "If not published, the path will remain as draft")
                        </div>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card stretch stretch-full mb-4 bg-soft-primary">
                    <div class="card-body">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="feather-help-circle me-2"></i>
                            @Html.T("نصائح", "Tips")
                        </h6>
                        <ul class="list-unstyled mb-0 fs-13">
                            <li class="mb-2">
                                <i class="feather-check me-2 text-success"></i>
                                @Html.T("اختر دورات مترابطة ومتسلسلة", "Choose related and sequential courses")
                            </li>
                            <li class="mb-2">
                                <i class="feather-check me-2 text-success"></i>
                                @Html.T("رتب الدورات من الأسهل للأصعب", "Order courses from easiest to hardest")
                            </li>
                            <li class="mb-2">
                                <i class="feather-check me-2 text-success"></i>
                                @Html.T("حدد سعراً أقل من مجموع الدورات", "Set a price lower than the sum of courses")
                            </li>
                            <li class="mb-0">
                                <i class="feather-check me-2 text-success"></i>
                                @Html.T("اكتب وصفاً واضحاً للفائدة المتوقعة", "Write a clear description of expected benefits")
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="feather-save me-2"></i>
                            @Html.T("إنشاء المسار", "Create Path")
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-light w-100">
                            <i class="feather-x me-2"></i>
                            @Html.T("إلغاء", "Cancel")
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            // Toggle pricing fields based on IsFree checkbox
            function togglePricingFields() {
                if ($('#isFreeSwitch').is(':checked')) {
                    $('#pricingFields').slideUp();
                    $('#Price').val('0');
                    $('#DiscountedPrice').val('');
                } else {
                    $('#pricingFields').slideDown();
                }
            }

            $('#isFreeSwitch').on('change', togglePricingFields);
            togglePricingFields();

            // Calculate discount percentage and savings
            function calculateDiscount() {
                const price = parseFloat($('#Price').val()) || 0;
                const discountedPrice = parseFloat($('#DiscountedPrice').val()) || 0;

                if (price > 0 && discountedPrice > 0 && discountedPrice < price) {
                    const savingsAmount = price - discountedPrice;
                    const discountPercentage = ((savingsAmount / price) * 100).toFixed(0);

                    $('#discountPercentage').text(discountPercentage + '%');
                    $('#savingsAmount').text(savingsAmount.toFixed(2) + ' ' + ($('#learningPathForm').data('currency-suffix') || ''));
                    $('#savingsDisplay').slideDown();
                } else {
                    $('#savingsDisplay').slideUp();
                }
            }

            $('#Price, #DiscountedPrice').on('input', calculateDiscount);

            // Show selected courses preview
            $('select[name="CourseIds"]').on('change', function() {
                const selectedOptions = $(this).find(':selected');
                
                if (selectedOptions.length > 0) {
                    $('#selectedCoursesPreview').slideDown();
                    $('#selectedCoursesList').empty();
                    $('#totalCoursesCount').text(selectedOptions.length);

                    selectedOptions.each(function(index) {
                        const courseName = $(this).text();
                        $('#selectedCoursesList').append(`
                            <div class="list-group-item">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-dark">${index + 1}</span>
                                    <span>${courseName}</span>
                                </div>
                            </div>
                        `);
                    });
                } else {
                    $('#selectedCoursesPreview').slideUp();
                }
            });

            // Form validation
            $('#learningPathForm').on('submit', function(e) {
                const courseIds = $('select[name="CourseIds"]').val();
                
                if (!courseIds || courseIds.length === 0) {
                    e.preventDefault();
                    alert($('#learningPathForm').data('msg-select-course'));
                    return false;
                }

                if (!$('#isFreeSwitch').is(':checked')) {
                    const price = parseFloat($('#Price').val()) || 0;
                    if (price <= 0) {
                        e.preventDefault();
                        alert($('#learningPathForm').data('msg-enter-price'));
                        return false;
                    }
                }
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
}

