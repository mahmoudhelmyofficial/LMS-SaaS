@{
    ViewData["Title"] = Html.T("إحصائيات الأفلييت", "Affiliate Statistics");
    ViewData["Subtitle"] = Html.T("تحليل شامل لأداء روابط الأفلييت", "Comprehensive analysis of affiliate link performance");
    
    // Get dynamic data from ViewBag
    var totalLinks = ViewBag.TotalLinks as int? ?? 0;
    var activeLinks = ViewBag.ActiveLinks as int? ?? 0;
    var totalClicks = ViewBag.TotalClicks as int? ?? 0;
    var totalConversions = ViewBag.TotalConversions as int? ?? 0;
    var conversionRate = ViewBag.ConversionRate as decimal? ?? 0;
    var totalEarnings = ViewBag.TotalEarnings as decimal? ?? 0;
    var pendingEarnings = ViewBag.PendingEarnings as decimal? ?? 0;
    var paidEarnings = ViewBag.PaidEarnings as decimal? ?? 0;
    var newLinksChange = ViewBag.NewLinksChange as int? ?? 0;
    var earningsChange = ViewBag.EarningsChange as decimal? ?? 0;
    
    var topLinks = ViewBag.TopLinks as dynamic;
    var chartLabels = ViewBag.ChartLabels as List<string> ?? new List<string>();
    var clicksChartData = ViewBag.ClicksChartData as List<int> ?? new List<int>();
    var conversionsChartData = ViewBag.ConversionsChartData as List<int> ?? new List<int>();
    
    var linksChangePrefix = newLinksChange >= 0 ? "+" : "";
    var earningsChangePrefix = earningsChange >= 0 ? "+" : "";
}

<div class="page-header">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">@ViewData["Title"]</h5>
            <p class="fs-12 fw-medium text-muted mb-0">@ViewData["Subtitle"]</p>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">@Html.T("الرئيسية", "Home")</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index")">@Html.T("روابط الأفلييت", "Affiliate links")</a></li>
            <li class="breadcrumb-item active">@Html.T("إحصائيات", "Statistics")</li>
        </ul>
    </div>
    <div class="page-header-right ms-auto">
        <div class="d-flex align-items-center gap-2">
            <a href="@Url.Action("Index")" class="btn btn-light">
                <i class="feather-arrow-right me-2"></i>
                @Html.T("العودة للقائمة", "Back to list")
            </a>
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="feather-plus me-2"></i>
                @Html.T("إنشاء رابط جديد", "Create new link")
            </a>
        </div>
    </div>
</div>

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <!-- Main Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي الروابط", "Total links") },
                { "Value", totalLinks },
                { "Icon", "link" },
                { "Color", "primary" },
                { "Change", newLinksChange != 0 ? $"{linksChangePrefix}{newLinksChange}" : "" },
                { "ChangeText", newLinksChange != 0 ? Html.T("هذا الشهر", "this month") : "" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("الروابط النشطة", "Active links") },
                { "Value", activeLinks },
                { "Icon", "check-circle" },
                { "Color", "success" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي النقرات", "Total clicks") },
                { "Value", totalClicks.ToString("N0") },
                { "Icon", "mouse-pointer" },
                { "Color", "info" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("إجمالي الأرباح", "Total earnings") },
                { "Value", totalEarnings.ToEGP() },
                { "Icon", "dollar-sign" },
                { "Color", "warning" },
                { "Change", earningsChange != 0 ? $"{earningsChangePrefix}{earningsChange:F1}%" : "" },
                { "ChangeText", earningsChange != 0 ? Html.T("مقارنة بالشهر الماضي", "vs last month") : "" }
            })
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("التحويلات", "Conversions") },
                { "Value", totalConversions },
                { "Icon", "shopping-cart" },
                { "Color", "success" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("معدل التحويل", "Conversion rate") },
                { "Value", $"{conversionRate:F2}%" },
                { "Icon", "trending-up" },
                { "Color", "info" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("الأرباح المعلقة", "Pending earnings") },
                { "Value", pendingEarnings.ToEGP() },
                { "Icon", "clock" },
                { "Color", "warning" }
            })
        </div>
        <div class="col-xxl-3 col-md-6">
            @await Html.PartialAsync("_StatCard", new ViewDataDictionary(ViewData)
            {
                { "Label", Html.T("الأرباح المدفوعة", "Paid earnings") },
                { "Value", paidEarnings.ToEGP() },
                { "Icon", "check-circle" },
                { "Color", "primary" }
            })
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("أداء الأفلييت", "Affiliate performance")</h5>
                    <div class="card-header-action">
                        <span class="badge bg-soft-primary text-primary">@Html.T("آخر 6 أشهر", "Last 6 months")</span>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="affiliatePerformanceChart" height="80"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("توزيع الأرباح", "Earnings distribution")</h5>
                </div>
                <div class="card-body">
                    <canvas id="earningsDistributionChart"></canvas>
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-soft-primary text-primary">●</span>
                                <span class="text-muted">@Html.T("مدفوعة", "Paid")</span>
                            </div>
                            <span class="fw-bold">@paidEarnings.ToEGP()</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-soft-warning text-warning">●</span>
                                <span class="text-muted">@Html.T("معلقة", "Pending")</span>
                            </div>
                            <span class="fw-bold">@pendingEarnings.ToEGP()</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performing Links -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("أفضل الروابط أداءً", "Top performing links")</h5>
                    <div class="card-header-action">
                        <a href="@Url.Action("Index")" class="btn btn-sm btn-primary">
                            @Html.T("عرض جميع الروابط", "View all links")
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (topLinks != null && ((IEnumerable<dynamic>)topLinks).Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>@Html.T("الترتيب", "Rank")</th>
                                        <th>@Html.T("الحملة", "Campaign")</th>
                                        <th>@Html.T("النقرات", "Clicks")</th>
                                        <th>@Html.T("التحويلات", "Conversions")</th>
                                        <th>@Html.T("معدل التحويل", "Conversion rate")</th>
                                        <th>@Html.T("الأرباح", "Earnings")</th>
                                        <th class="text-end">@Html.T("الإجراءات", "Actions")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var rankColors = Constants.RankColors.Colors;
                                        var rank = 0;
                                    }
                                    @foreach (var link in topLinks)
                                    {
                                        rank++;
                                        var colorIndex = (rank - 1) % rankColors.Length;
                                        var linkConversionRate = (double)link.ConversionRate;
                                        var progressClass = linkConversionRate >= 10 ? "success" : linkConversionRate >= 5 ? "warning" : "danger";
                                        <tr>
                                            <td>
                                                <div class="avatar-text avatar-sm bg-soft-@rankColors[colorIndex] text-@rankColors[colorIndex]">
                                                    @rank
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <span class="fw-bold">@link.CampaignName</span>
                                                    <p class="fs-12 text-muted mb-0">@link.CourseName</p>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="feather-mouse-pointer text-muted"></i>
                                                    <span class="fw-medium">@((int)link.ClickCount)</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="feather-shopping-cart text-success"></i>
                                                    <span class="fw-medium">@((int)link.ConversionCount)</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 8px; min-width: 100px;">
                                                    <div class="progress-bar bg-@progressClass" role="progressbar" style="width: @Math.Min(linkConversionRate, 100)%"></div>
                                                </div>
                                                <span class="fs-11 text-muted">@linkConversionRate.ToString("F1")%</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success">@((decimal)link.TotalEarnings).ToEGP()</span>
                                            </td>
                                            <td>
                                                <div class="hstack gap-2 justify-content-end">
                                                    <a href="@Url.Action("Details", new { id = (int)link.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("عرض", "View")">
                                                        <i class="feather-eye"></i>
                                                    </a>
                                                    <a href="@Url.Action("Edit", new { id = (int)link.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("تعديل", "Edit")">
                                                        <i class="feather-edit"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="avatar-text avatar-xl bg-soft-primary text-primary mb-3 mx-auto">
                                <i class="feather-link"></i>
                            </div>
                            <h6 class="fw-bold mb-2">@Html.T("لا توجد روابط أفلييت بعد", "No affiliate links yet")</h6>
                            <p class="text-muted mb-4">@Html.T("ابدأ بإنشاء رابط أفلييت لتتبع حملاتك التسويقية", "Start creating an affiliate link to track your marketing campaigns")</p>
                            <a href="@Url.Action("Create")" class="btn btn-primary">
                                <i class="feather-plus me-2"></i>
                                @Html.T("إنشاء رابط جديد", "Create new link")
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Performance Chart
        const performanceCtx = document.getElementById('affiliatePerformanceChart').getContext('2d');
        new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(chartLabels)),
                datasets: [
                    {
                        label: '@Html.Raw(Html.T("النقرات", "Clicks").Replace("'", "\\'"))',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(clicksChartData)),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: '@Html.Raw(Html.T("التحويلات", "Conversions").Replace("'", "\\'"))',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(conversionsChartData)),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            borderDash: [5, 5]
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Earnings Distribution Chart
        const earningsCtx = document.getElementById('earningsDistributionChart').getContext('2d');
        new Chart(earningsCtx, {
            type: 'doughnut',
            data: {
                labels: ['@Html.Raw(Html.T("مدفوعة", "Paid").Replace("'", "\\'"))', '@Html.Raw(Html.T("معلقة", "Pending").Replace("'", "\\'"))'],
                datasets: [{
                    data: [@paidEarnings, @pendingEarnings],
                    backgroundColor: @Html.Raw(Json.Serialize(new[] { Constants.ChartColors.Primary[0], Constants.ChartColors.Primary[2] })),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                cutout: '70%'
            }
        });

        // Initialize tooltips
        $(document).ready(function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
}
