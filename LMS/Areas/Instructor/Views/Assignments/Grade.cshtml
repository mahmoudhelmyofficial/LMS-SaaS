@model LMS.Areas.Instructor.ViewModels.GradeSubmissionViewModel
@inject IPlatformSettingsService PlatformSettings

@{
    ViewData["Title"] = Html.T("تقييم التسليم", "Grade Submission");
    var submission = ViewBag.Submission as LMS.Domain.Entities.Assessments.AssignmentSubmission;
    var maxGrade = ViewBag.MaxGrade as decimal?;
    ViewData["Subtitle"] = $"تقييم تكليف: {submission?.Assignment?.Title}";
    var detailsUrl = Url.Action("ViewSubmission", new { id = Model.SubmissionId });
    var indexUrl = Url.Action("Submissions");
    
    // Load platform settings
    var thresholdExcellent = await PlatformSettings.GetIntSettingAsync("Threshold.Grade.Excellent", 90);
    var thresholdVeryGood = await PlatformSettings.GetIntSettingAsync("Threshold.Grade.VeryGood", 80);
    var thresholdGood = await PlatformSettings.GetIntSettingAsync("Threshold.Grade.Good", 70);
}

@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw("<a href='" + detailsUrl + "' class='btn btn-light'><i class='feather-eye me-2'></i>عرض التفاصيل</a><a href='" + indexUrl + "' class='btn btn-light'><i class='feather-arrow-right me-2'></i>العودة للقائمة</a>") }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Grade" asp-route-id="@Model.SubmissionId" method="post" id="gradeForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="SubmissionId" />
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Student & Assignment Info -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2 text-primary"></i>
                            معلومات التسليم
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (submission != null)
                        {
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="text-muted small mb-2">الطالب</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="avatar-text avatar-md bg-soft-primary text-primary">
                                            <i class="feather-user"></i>
                                        </div>
                                        <h5 class="fw-bold mb-0">@submission.Student?.FullName</h5>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="text-muted small mb-2">تاريخ التسليم</label>
                                    <p class="mb-0">
                                        <i class="feather-calendar text-muted me-2"></i>
                                        @(submission.SubmittedAt != default(DateTime) ? submission.SubmittedAt.ToString("dd/MM/yyyy hh:mm tt") : "لم يتم التسليم بعد")
                                    </p>
                                </div>

                                <div class="col-md-12">
                                    <label class="text-muted small mb-2">التكليف</label>
                                    <h6 class="fw-bold mb-0">@submission.Assignment?.Title</h6>
                                </div>

                                <div class="col-md-12">
                                    <label class="text-muted small mb-2">الدورة</label>
                                    <p class="mb-0">@submission.Assignment?.Lesson?.Module?.Course?.Title</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Submission Content -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-file-text me-2 text-primary"></i>
                            المحتوى المرسل
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (submission != null)
                        {
                            @if (!string.IsNullOrEmpty(submission.TextSubmission))
                            {
                                <div class="mb-4">
                                    <label class="text-muted small mb-2">النص المرسل</label>
                                    <div class="bg-light rounded p-4" style="max-height: 400px; overflow-y: auto;">
                                        <div style="white-space: pre-wrap;">@submission.TextSubmission</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(submission.AttachmentUrls))
                            {
                                <div>
                                    <label class="text-muted small mb-2">المرفقات</label>
                                    <div class="list-group">
                                        @foreach (var url in submission.AttachmentUrls.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                        {
                                            <a href="@url.Trim()" target="_blank" class="list-group-item list-group-item-action">
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="avatar-text avatar-md bg-soft-info text-info">
                                                        <i class="feather-file"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">@System.IO.Path.GetFileName(url.Trim())</h6>
                                                        <small class="text-muted">انقر لعرض/تحميل الملف</small>
                                                    </div>
                                                    <i class="feather-external-link text-primary"></i>
                                                </div>
                                            </a>
                                        }
                                    </div>
                                </div>
                            }

                            @if (string.IsNullOrEmpty(submission.TextSubmission) && string.IsNullOrEmpty(submission.AttachmentUrls))
                            {
                                <div class="alert alert-warning">
                                    <i class="feather-alert-triangle me-2"></i>
                                    لا يوجد محتوى مرسل
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Grading Form -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0 text-white">
                            <i class="feather-edit-3 me-2"></i>
                            التقييم والملاحظات
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-12">
                                <label class="form-label">الدرجة <span class="text-danger">*</span></label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="input-group input-group-lg">
                                            <input asp-for="Grade" type="number" class="form-control form-control-lg" 
                                                   min="0" max="@maxGrade" step="0.5" 
                                                   placeholder="0" id="gradeInput" required>
                                            <span class="input-group-text">/ @maxGrade</span>
                                        </div>
                                        <span asp-validation-for="Grade" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center h-100 gap-3">
                                            <div id="gradePercentage" class="badge bg-soft-secondary text-secondary fs-4 px-3 py-2">
                                                0%
                                            </div>
                                            <div id="gradeStatus"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <label class="form-label small text-muted">اختيارات سريعة:</label>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-light" onclick="setGrade(0)">0</button>
                                        <button type="button" class="btn btn-sm btn-light" onclick="setGrade(@(maxGrade * 0.25m))">25%</button>
                                        <button type="button" class="btn btn-sm btn-light" onclick="setGrade(@(maxGrade * 0.50m))">50%</button>
                                        <button type="button" class="btn btn-sm btn-light" onclick="setGrade(@(maxGrade * 0.75m))">75%</button>
                                        <button type="button" class="btn btn-sm btn-light" onclick="setGrade(@maxGrade)">100%</button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">ملاحظات وتعليقات</label>
                                <textarea asp-for="Feedback" class="form-control" rows="8" 
                                          placeholder="اكتب ملاحظاتك وتعليقاتك على عمل الطالب..." 
                                          id="feedbackEditor"></textarea>
                                <span asp-validation-for="Feedback" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    قدم ملاحظات بناءة تساعد الطالب على التحسين
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (submission?.Grade.HasValue == true)
                {
                    <div class="card stretch stretch-full mb-4 border-warning">
                        <div class="card-header bg-soft-warning">
                            <h6 class="card-title mb-0">
                                <i class="feather-clock me-2"></i>
                                التقييم السابق
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="text-muted small">الدرجة السابقة</label>
                                    <p class="fw-bold mb-0">@submission.Grade.Value / @maxGrade</p>
                                </div>
                                <div class="col-md-8">
                                    <label class="text-muted small">الملاحظات السابقة</label>
                                    <p class="mb-0">@(submission.Feedback ?? "لا توجد ملاحظات")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Grading Guide -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">دليل التقييم</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">معايير التقييم:</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">الدرجة القصوى:</span>
                                <span class="fw-bold">@maxGrade نقطة</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">درجة النجاح:</span>
                                <span class="fw-bold">@(submission?.Assignment?.PassingScore ?? 60)%</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">مستويات الأداء:</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-soft-success text-success">ممتاز</span>
                                        <span class="small">90% - 100%</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-soft-info text-info">جيد جداً</span>
                                        <span class="small">80% - 89%</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-soft-primary text-primary">جيد</span>
                                        <span class="small">70% - 79%</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-soft-warning text-warning">مقبول</span>
                                        <span class="small">60% - 69%</span>
                                    </div>
                                </div>
                                <div class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-soft-danger text-danger">ضعيف</span>
                                        <span class="small">أقل من 60%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-light mb-0">
                            <small class="text-muted">
                                <i class="feather-lightbulb me-2"></i>
                                <strong>نصيحة:</strong> قدم ملاحظات محددة وبناءة تساعد الطالب على فهم نقاط القوة والضعف في عمله.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Quick Templates -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">قوالب سريعة</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">انقر لإضافة قالب إلى الملاحظات:</p>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-sm btn-light text-start" onclick="addTemplate('excellent')">
                                <i class="feather-star text-success me-2"></i>
                                عمل ممتاز
                            </button>
                            <button type="button" class="btn btn-sm btn-light text-start" onclick="addTemplate('good')">
                                <i class="feather-thumbs-up text-info me-2"></i>
                                عمل جيد
                            </button>
                            <button type="button" class="btn btn-sm btn-light text-start" onclick="addTemplate('needswork')">
                                <i class="feather-alert-circle text-warning me-2"></i>
                                يحتاج تحسين
                            </button>
                            <button type="button" class="btn btn-sm btn-light text-start" onclick="addTemplate('resubmit')">
                                <i class="feather-repeat text-danger me-2"></i>
                                يحتاج إعادة تسليم
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Preview -->
                <div class="card stretch stretch-full mb-4 bg-soft-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="card-title mb-0 text-white">
                            <i class="feather-eye me-2"></i>
                            معاينة
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <h2 class="fw-bold mb-1" id="previewGrade">-- / @maxGrade</h2>
                            <span class="badge bg-white text-primary fs-5" id="previewPercent">--%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <a href="@Url.Action("ViewSubmission", new { id = Model.SubmissionId })" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="feather-check me-2"></i>
                                حفظ التقييم وإرسال للطالب
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const maxGrade = @(maxGrade ?? 100);
        const passingScore = @(submission?.Assignment?.PassingScore ?? 60);

        $(document).ready(function() {
            @if (submission?.Grade.HasValue == true)
            {
                <text>
                $('#gradeInput').val(@submission.Grade.Value);
                updateGradeDisplay();
                </text>
            }

            $('#gradeInput').on('input', function() {
                updateGradeDisplay();
            });

            $('#gradeForm').on('submit', function(e) {
                const grade = parseFloat($('#gradeInput').val());
                
                if (isNaN(grade) || grade < 0 || grade > maxGrade) {
                    e.preventDefault();
                    alert('يرجى إدخال درجة صحيحة بين 0 و ' + maxGrade);
                    return false;
                }

                return confirm('هل أنت متأكد من حفظ التقييم وإرساله للطالب؟');
            });
        });

        function updateGradeDisplay() {
            const grade = parseFloat($('#gradeInput').val()) || 0;
            const percentage = (grade / maxGrade * 100).toFixed(1);
            const thresholdExcellent = @thresholdExcellent;
            const thresholdVeryGood = @thresholdVeryGood;
            const thresholdGood = @thresholdGood;
            
            $('#gradePercentage').text(percentage + '%');
            
            let statusHtml = '';
            
            if (percentage >= thresholdExcellent) {
                statusHtml = '<span class="badge bg-soft-success text-success fs-5"><i class="feather-award"></i> ممتاز</span>';
            } else if (percentage >= thresholdVeryGood) {
                statusHtml = '<span class="badge bg-soft-info text-info fs-5"><i class="feather-star"></i> جيد جداً</span>';
            } else if (percentage >= thresholdGood) {
                statusHtml = '<span class="badge bg-soft-primary text-primary fs-5"><i class="feather-check"></i> جيد</span>';
            } else if (percentage >= passingScore) {
                statusHtml = '<span class="badge bg-soft-warning text-warning fs-5"><i class="feather-check-circle"></i> مقبول</span>';
            } else {
                statusHtml = '<span class="badge bg-soft-danger text-danger fs-5"><i class="feather-x-circle"></i> ضعيف</span>';
            }
            
            $('#gradeStatus').html(statusHtml);
            
            if (percentage >= passingScore) {
                $('#gradePercentage').removeClass('bg-soft-danger text-danger').addClass('bg-soft-success text-success');
            } else {
                $('#gradePercentage').removeClass('bg-soft-success text-success').addClass('bg-soft-danger text-danger');
            }
            
            updatePreview();
        }

        function updatePreview() {
            const grade = parseFloat($('#gradeInput').val()) || 0;
            const percentage = (grade / maxGrade * 100).toFixed(1);
            
            $('#previewGrade').text(grade.toFixed(1) + ' / ' + maxGrade);
            $('#previewPercent').text(percentage + '%');
            
            if (percentage >= passingScore) {
                $('#previewPercent').removeClass('bg-white text-danger').addClass('bg-white text-success');
            } else {
                $('#previewPercent').removeClass('bg-white text-success').addClass('bg-white text-danger');
            }
        }

        function setGrade(value) {
            $('#gradeInput').val(value);
            updateGradeDisplay();
        }

        function addTemplate(type) {
            const feedback = $('#feedbackEditor');
            let template = '';
            
            switch(type) {
                case 'excellent':
                    template = '\n\nعمل ممتاز! لقد أظهرت فهماً عميقاً للمحتوى وقدمت حلاً متميزاً. استمر في هذا المستوى الرائع.';
                    break;
                case 'good':
                    template = '\n\nعمل جيد! أظهرت فهماً جيداً للمحتوى. هناك بعض النقاط التي يمكن تحسينها:';
                    break;
                case 'needswork':
                    template = '\n\nهناك بعض النقاط الجيدة في عملك، لكن يحتاج إلى مزيد من التحسين في:\n- \n- \n- ';
                    break;
                case 'resubmit':
                    template = '\n\nيحتاج هذا العمل إلى إعادة تسليم. يرجى مراجعة النقاط التالية:\n- \n- \n- ';
                    break;
            }
            
            feedback.val(feedback.val() + template);
        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

