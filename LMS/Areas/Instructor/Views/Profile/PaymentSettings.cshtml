@model LMS.Areas.Instructor.ViewModels.InstructorPaymentSettingsViewModel

@{
    ViewData["Title"] = Html.T("إعدادات الدفع", "Payment Settings");
    ViewData["Subtitle"] = Html.T("قم بتكوين طرق استلام أرباحك", "Configure how you receive earnings");
}

@{
    var indexUrl = Url.Action("Index");
    var actionButtonsHtml = "<a href='" + indexUrl + "' class='btn btn-light'>" +
        "<i class='feather-arrow-right me-2'></i>" +
        (Html.T("العودة للملف الشخصي", "Back to profile")) +
        "</a>";
}
@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw(actionButtonsHtml) }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="PaymentSettings" method="post" id="paymentSettingsForm">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Payment Method Selection -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-credit-card me-2 text-primary"></i>
                            @Html.T("طريقة استلام الأرباح", "Earnings payout method")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-start">
                                <i class="feather-info fs-18 me-3"></i>
                                <div>
                                    <strong>@Html.T("مهم:", "Important:")</strong> @Html.T("اختر طريقة واحدة لاستلام أرباحك. تأكد من صحة البيانات المدخلة لتجنب أي تأخير في معالجة طلبات السحب.", "Choose one method to receive earnings. Ensure data is correct to avoid withdrawal delays.")
                                </div>
                            </div>
                        </div>

                        <label class="form-label">@Html.T("اختر طريقة الدفع المفضلة", "Choose preferred payout method") <span class="text-danger">*</span></label>
                        
                        <div class="payment-methods-grid mb-4">
                            <!-- Bank Transfer -->
                            <div class="payment-method-card" data-method="BankTransfer">
                                <input type="radio" name="PayoutMethod" value="BankTransfer" id="methodBank" 
                                       @(Model.PayoutMethod == "BankTransfer" ? "checked" : "") />
                                <label for="methodBank" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-primary text-primary">
                                        <i class="feather-briefcase fs-24"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("تحويل بنكي", "Bank transfer")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("التحويل المباشر إلى حسابك البنكي", "Direct transfer to your bank account")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>

                            <!-- PayPal -->
                            <div class="payment-method-card" data-method="PayPal">
                                <input type="radio" name="PayoutMethod" value="PayPal" id="methodPayPal"
                                       @(Model.PayoutMethod == "PayPal" ? "checked" : "") />
                                <label for="methodPayPal" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-info text-info">
                                        @{ ViewBag.CurrencyIconStyle = "font-size: 20px; font-weight: bold;"; }
                                        @await Html.PartialAsync("_CurrencyIcon")
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("باي بال", "PayPal")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("استلام الأموال عبر PayPal", "Receive funds via PayPal")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>

                            <!-- Vodafone Cash -->
                            <div class="payment-method-card" data-method="VodafoneCash">
                                <input type="radio" name="PayoutMethod" value="VodafoneCash" id="methodVodafone"
                                       @(Model.PayoutMethod == "VodafoneCash" ? "checked" : "") />
                                <label for="methodVodafone" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-danger text-danger">
                                        <i class="feather-smartphone fs-24"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("فودافون كاش", "Vodafone Cash")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("المحفظة الإلكترونية (مصر)", "Mobile wallet (Egypt)")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>

                            <!-- InstaPay -->
                            <div class="payment-method-card" data-method="InstaPay">
                                <input type="radio" name="PayoutMethod" value="InstaPay" id="methodInstaPay"
                                       @(Model.PayoutMethod == "InstaPay" ? "checked" : "") />
                                <label for="methodInstaPay" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-success text-success">
                                        <i class="feather-zap fs-24"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("انستاباي", "InstaPay")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("التحويل الفوري (مصر)", "Instant transfer (Egypt)")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>

                            <!-- Stripe -->
                            <div class="payment-method-card" data-method="Stripe">
                                <input type="radio" name="PayoutMethod" value="Stripe" id="methodStripe"
                                       @(Model.PayoutMethod == "Stripe" ? "checked" : "") />
                                <label for="methodStripe" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-purple text-purple">
                                        <i class="feather-credit-card fs-24"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("Stripe Connect", "Stripe Connect")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("منصة المدفوعات العالمية", "Global payments platform")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>

                            <!-- Wise -->
                            <div class="payment-method-card" data-method="Wise">
                                <input type="radio" name="PayoutMethod" value="Wise" id="methodWise"
                                       @(Model.PayoutMethod == "Wise" ? "checked" : "") />
                                <label for="methodWise" class="payment-method-label">
                                    <div class="payment-method-icon bg-soft-warning text-warning">
                                        <i class="feather-globe fs-24"></i>
                                    </div>
                                    <div class="payment-method-info">
                                        <h6 class="mb-1">@Html.T("وايز", "Wise")</h6>
                                        <p class="fs-13 text-muted mb-0">@Html.T("تحويلات دولية بأقل رسوم", "International transfers with low fees")</p>
                                    </div>
                                    <div class="payment-method-check">
                                        <i class="feather-check-circle"></i>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <span asp-validation-for="PayoutMethod" class="text-danger"></span>
                    </div>
                </div>

                <!-- Bank Transfer Details -->
                <div class="card stretch stretch-full mb-4 payment-details-section" id="bankTransferSection" style="display: none;">
                    <div class="card-header bg-soft-primary">
                        <h5 class="card-title text-primary">
                            <i class="feather-briefcase me-2"></i>
                            @Html.T("تفاصيل الحساب البنكي", "Bank account details")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label" asp-for="BankName">
                                    @Html.T("اسم البنك", "Bank name") <span class="text-danger">*</span>
                                </label>
                                <select asp-for="BankName" class="form-select">
                                    <option value="">-- @Html.T("اختر البنك", "Choose bank") --</option>
                                    <optgroup label="@Html.T("البنوك المصرية", "Egyptian banks")">
                                        <option value="البنك الأهلي المصري">البنك الأهلي المصري</option>
                                        <option value="بنك مصر">بنك مصر</option>
                                        <option value="بنك القاهرة">بنك القاهرة</option>
                                        <option value="البنك التجاري الدولي CIB">البنك التجاري الدولي (CIB)</option>
                                        <option value="بنك الإسكندرية">بنك الإسكندرية</option>
                                        <option value="البنك العربي الأفريقي">البنك العربي الأفريقي</option>
                                        <option value="بنك فيصل الإسلامي">بنك فيصل الإسلامي</option>
                                        <option value="بنك QNB الأهلي">بنك QNB الأهلي</option>
                                    </optgroup>
                                    <optgroup label="@Html.T("البنوك السعودية", "Saudi banks")">
                                        <option value="البنك الأهلي السعودي">البنك الأهلي السعودي</option>
                                        <option value="بنك الراجحي">بنك الراجحي</option>
                                        <option value="بنك الرياض">بنك الرياض</option>
                                        <option value="البنك السعودي الفرنسي">البنك السعودي الفرنسي</option>
                                        <option value="البنك السعودي البريطاني">البنك السعودي البريطاني (ساب)</option>
                                        <option value="بنك البلاد">بنك البلاد</option>
                                    </optgroup>
                                    <optgroup label="@Html.T("البنوك الإماراتية", "UAE banks")">
                                        <option value="بنك الإمارات دبي الوطني">بنك الإمارات دبي الوطني</option>
                                        <option value="بنك أبوظبي الأول">بنك أبوظبي الأول</option>
                                        <option value="بنك دبي الإسلامي">بنك دبي الإسلامي</option>
                                        <option value="بنك المشرق">بنك المشرق</option>
                                        <option value="بنك رأس الخيمة الوطني">بنك رأس الخيمة الوطني</option>
                                    </optgroup>
                                    <option value="أخرى">@Html.T("بنك آخر", "Other bank")</option>
                                </select>
                                <span asp-validation-for="BankName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="BankAccountName">
                                    @Html.T("اسم صاحب الحساب", "Account holder name") <span class="text-danger">*</span>
                                </label>
                                <input asp-for="BankAccountName" class="form-control" placeholder="@Html.T("الاسم كما يظهر في البطاقة البنكية", "Name as it appears on the bank card")" />
                                <span asp-validation-for="BankAccountName" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-alert-circle me-1"></i>
                                    @Html.T("يجب أن يطابق الاسم المسجل في البنك", "Must match the name registered at the bank")
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="BankAccountNumber">
                                    @Html.T("رقم الحساب البنكي", "Bank account number") <span class="text-danger">*</span>
                                </label>
                                <input asp-for="BankAccountNumber" class="form-control" placeholder="123456789012" maxlength="100" />
                                <span asp-validation-for="BankAccountNumber" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="IBAN">
                                    @Html.T("رمز IBAN (إن وجد)", "IBAN (if applicable)")
                                </label>
                                <input asp-for="IBAN" class="form-control" placeholder="EG123456789012345678901234" maxlength="50" />
                                <span asp-validation-for="IBAN" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("مطلوب للتحويلات الدولية", "Required for international transfers")
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="SwiftCode">
                                    @Html.T("رمز SWIFT/BIC (للتحويلات الدولية)", "SWIFT/BIC code (for international transfers)")
                                </label>
                                <input asp-for="SwiftCode" class="form-control" placeholder="NBEGEGCXXXX" maxlength="20" />
                                <span asp-validation-for="SwiftCode" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("8-11 حرف (مطلوب للتحويلات الدولية)", "8-11 characters (required for international transfers)")
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-4 mb-0">
                            <div class="d-flex align-items-start">
                                <i class="feather-alert-triangle fs-18 me-3"></i>
                                <div>
                                    <strong>@Html.T("تنبيه مهم:", "Important notice:")</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>@Html.T("تأكد من صحة جميع البيانات قبل الحفظ", "Verify all data before saving")</li>
                                        <li>@Html.T("قد يستغرق التحويل البنكي من 3 إلى 5 أيام عمل", "Bank transfer may take 3 to 5 business days")</li>
                                        <li>@Html.T("قد تُطبق رسوم بنكية على التحويلات", "Bank fees may apply to transfers")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PayPal Details -->
                <div class="card stretch stretch-full mb-4 payment-details-section" id="payPalSection" style="display: none;">
                    <div class="card-header bg-soft-info">
                        <h5 class="card-title text-info">
                            @{ ViewBag.CurrencyIconClass = "me-2"; ViewBag.CurrencyIconStyle = "font-weight: bold;"; }
                            @await Html.PartialAsync("_CurrencyIcon")
                            <span class="me-2">@Html.T("تفاصيل حساب PayPal", "PayPal account details")</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="PayPalEmail">
                                    @Html.T("البريد الإلكتروني المسجل في PayPal", "Email registered with PayPal") <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="feather-mail"></i>
                                    </span>
                                    <input asp-for="PayPalEmail" type="email" class="form-control" placeholder="your-email@example.com" />
                                </div>
                                <span asp-validation-for="PayPalEmail" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("تأكد من أن هذا البريد مسجل في حساب PayPal نشط", "Ensure this email is registered with an active PayPal account")
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden fields for other payment methods (excluding MobileWalletNumber and MobileWalletProvider to avoid conflicts) -->
                        <input type="hidden" asp-for="WiseEmail" />
                        <input type="hidden" asp-for="StripeAccountId" />

                        <div class="alert alert-info mt-4 mb-0">
                            <div class="d-flex align-items-start">
                                <i class="feather-info fs-18 me-3"></i>
                                <div>
                                    <strong>@Html.T("ملاحظات PayPal:", "PayPal notes:")</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>@Html.T("يجب أن يكون لديك حساب PayPal مفعّل ومحقق", "You must have an active and verified PayPal account")</li>
                                        <li>@Html.T("التحويل يتم خلال 1-2 يوم عمل", "Transfer within 1-2 business days")</li>
                                        <li>@Html.T("رسوم PayPal: 2.9% + رسوم ثابتة حسب العملة", "PayPal fees: 2.9% + fixed fee per currency")</li>
                                        <li>@Html.T("يمكنك سحب الأموال من PayPal إلى بنكك المحلي", "You can withdraw from PayPal to your local bank")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mobile Wallet Details (Vodafone Cash / InstaPay) -->
                <div class="card stretch stretch-full mb-4 payment-details-section" id="mobileWalletSection" style="display: none;">
                    <div class="card-header bg-soft-success">
                        <h5 class="card-title text-success">
                            <i class="feather-smartphone me-2"></i>
                            @Html.T("تفاصيل المحفظة الإلكترونية", "Mobile wallet details")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label" asp-for="MobileWalletProvider">
                                    @Html.T("مزود المحفظة", "Wallet provider") <span class="text-danger">*</span>
                                </label>
                                <select asp-for="MobileWalletProvider" class="form-select">
                                    <option value="">-- @Html.T("اختر المزود", "Choose provider") --</option>
                                    <option value="VodafoneCash">@Html.T("فودافون كاش", "Vodafone Cash")</option>
                                    <option value="InstaPay">@Html.T("انستاباي", "InstaPay")</option>
                                    <option value="OrangeMoney">@Html.T("أورنج موني", "Orange Money")</option>
                                    <option value="EtisalatCash">@Html.T("اتصالات كاش", "Etisalat Cash")</option>
                                </select>
                                <span asp-validation-for="MobileWalletProvider" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="MobileWalletNumber">
                                    @Html.T("رقم الهاتف المسجل", "Registered phone number") <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="feather-phone"></i>
                                    </span>
                                    <input asp-for="MobileWalletNumber" type="tel" class="form-control" placeholder="01xxxxxxxxx" maxlength="11" />
                                </div>
                                <span asp-validation-for="MobileWalletNumber" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("أدخل رقم الهاتف المسجل في المحفظة (11 رقم)", "Enter the phone number registered with the wallet (11 digits)")
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-success mt-4 mb-0">
                            <div class="d-flex align-items-start">
                                <i class="feather-check-circle fs-18 me-3"></i>
                                <div>
                                    <strong>@Html.T("مميزات المحفظة الإلكترونية:", "Mobile wallet benefits:")</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>@Html.T("تحويل فوري (خلال دقائق)", "Instant transfer (within minutes)")</li>
                                        <li>@Html.T("رسوم منخفضة", "Low fees")</li>
                                        <li>@Html.T("متاح 24/7", "Available 24/7")</li>
                                        <li>@Html.T("سهولة السحب النقدي", "Easy cash withdrawal")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- International Payment Details (Stripe / Wise) -->
                <div class="card stretch stretch-full mb-4 payment-details-section" id="internationalSection" style="display: none;">
                    <div class="card-header bg-soft-purple">
                        <h5 class="card-title text-purple">
                            <i class="feather-globe me-2"></i>
                            @Html.T("تفاصيل الحساب الدولي", "International account details")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-start">
                                <i class="feather-info fs-18 me-3"></i>
                                <div>
                                    @Html.T("للربط مع", "To link") <strong id="internationalProviderName">Stripe</strong>@Html.T("، ستحتاج إلى:", ", you will need:")
                                    <ul class="mb-0 mt-2">
                                        <li>@Html.T("حساب نشط على المنصة", "An active account on the platform")</li>
                                        <li>@Html.T("إكمال عملية التحقق من الهوية (KYC)", "Complete identity verification (KYC)")</li>
                                        <li>@Html.T("ربط حسابك البنكي بالمنصة", "Link your bank account to the platform")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-12" id="wiseEmailSection" style="display: none;">
                                <label class="form-label" asp-for="WiseEmail">
                                    @Html.T("البريد الإلكتروني المسجل في Wise", "Email registered with Wise") <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="feather-mail"></i>
                                    </span>
                                    <input asp-for="WiseEmail" type="email" class="form-control" id="WiseEmail" placeholder="your-email@example.com" />
                                </div>
                                <span asp-validation-for="WiseEmail" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("البريد الإلكتروني المسجل في حساب Wise الخاص بك", "The email registered with your Wise account")
                                </div>
                            </div>

                            <div class="col-12" id="stripeAccountIdSection" style="display: none;">
                                <label class="form-label" asp-for="StripeAccountId">
                                    @Html.T("معرف حساب Stripe (Account ID)", "Stripe account ID")
                                </label>
                                <input asp-for="StripeAccountId" type="text" class="form-control" id="StripeAccountId" placeholder="acct_xxxxxxxxxxxxx" />
                                <span asp-validation-for="StripeAccountId" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    @Html.T("يمكنك العثور عليه في لوحة تحكم Stripe", "You can find it in your Stripe dashboard")
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" class="btn btn-outline-primary" id="connectAccountBtn">
                                <i class="feather-link me-2"></i>
                                @Html.T("ربط الحساب الآن", "Link account now")
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Security Notice -->
                <div class="card stretch stretch-full mb-4 bg-gradient-primary text-white border-0">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="feather-shield" style="font-size: 48px;"></i>
                        </div>
                        <h5 class="text-white text-center mb-3">@Html.T("أمان معلوماتك", "Your data security")</h5>
                        <p class="text-white-75 fs-13 mb-0 text-center">
                            @Html.T("جميع بياناتك المالية محمية بتشفير عالي المستوى ولن يتم مشاركتها مع أي جهة خارجية.", "All your financial data is protected with high-level encryption and will not be shared with any third party.")
                        </p>
                    </div>
                </div>

                <!-- Processing Times -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("أوقات المعالجة المتوقعة", "Expected processing times")</h5>
                    </div>
                    <div class="card-body">
                        <div class="processing-time-item mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="feather-briefcase text-primary me-2"></i>
                                    <span>@Html.T("تحويل بنكي", "Bank transfer")</span>
                                </div>
                                <span class="badge bg-soft-primary text-primary">@Html.T("3-5 أيام", "3-5 days")</span>
                            </div>
                        </div>
                        <div class="processing-time-item mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    @{ ViewBag.CurrencyIconClass = "text-info me-2"; ViewBag.CurrencyIconStyle = "font-weight: bold;"; }
                                    @await Html.PartialAsync("_CurrencyIcon")
                                    <span>@Html.T("باي بال", "PayPal")</span>
                                </div>
                                <span class="badge bg-soft-info text-info">@Html.T("1-2 يوم", "1-2 days")</span>
                            </div>
                        </div>
                        <div class="processing-time-item mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="feather-smartphone text-success me-2"></i>
                                    <span>محفظة إلكترونية</span>
                                </div>
                                <span class="badge bg-soft-success text-success">@Html.T("فوري", "Instant")</span>
                            </div>
                        </div>
                        <div class="processing-time-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="feather-globe text-warning me-2"></i>
                                    <span>@Html.T("دولي (Stripe/Wise)", "International (Stripe/Wise)")</span>
                                </div>
                                <span class="badge bg-soft-warning text-warning">@Html.T("2-7 أيام", "2-7 days")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fees Comparison -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("مقارنة الرسوم", "Fees comparison")</h5>
                    </div>
                    <div class="card-body">
                        <div class="fee-item mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fs-13">@Html.T("تحويل بنكي", "Bank transfer")</span>
                                <span class="fs-13 fw-bold text-primary">@Html.T("رسوم البنك", "Bank fees")</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: 20%"></div>
                            </div>
                        </div>
                        <div class="fee-item mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fs-13">@Html.T("باي بال", "PayPal")</span>
                                <span class="fs-13 fw-bold text-info">@Html.T("2.9% + ثابت", "2.9% + fixed")</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: 35%"></div>
                            </div>
                        </div>
                        <div class="fee-item mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fs-13">@Html.T("محفظة إلكترونية", "Mobile wallet")</span>
                                <span class="fs-13 fw-bold text-success">1-2%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 15%"></div>
                            </div>
                        </div>
                        <div class="fee-item">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fs-13">@Html.T("Stripe/Wise", "Stripe/Wise")</span>
                                <span class="fs-13 fw-bold text-warning">0.5-3%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: 25%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Help & Support -->
                <div class="card stretch stretch-full bg-soft-warning border-0">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="feather-help-circle text-warning" style="font-size: 48px;"></i>
                        </div>
                        <h6 class="text-center mb-3">@Html.T("هل تحتاج مساعدة؟", "Need help?")</h6>
                        <p class="fs-13 text-center mb-3">
                            @Html.T("فريقنا جاهز لمساعدتك في إعداد طريقة الدفع المناسبة.", "Our team is ready to help you set up the right payment method.")
                        </p>
                        <div class="d-grid">
                            <a href="#" class="btn btn-warning">
                                <i class="feather-message-circle me-2"></i>
                                @Html.T("تواصل مع الدعم", "Contact support")
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <a href="@Url.Action("Index")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-light" onclick="validatePaymentDetails()">
                                    <i class="feather-check-circle me-2"></i>
                                    التحقق من البيانات
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="feather-save me-2"></i>
                                    حفظ الإعدادات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .payment-methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .payment-method-card {
            position: relative;
        }

        .payment-method-card input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .payment-method-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-method-label:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .payment-method-card input[type="radio"]:checked + .payment-method-label {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .payment-method-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .payment-method-info {
            flex-grow: 1;
        }

        .payment-method-check {
            font-size: 24px;
            color: #e5e7eb;
            transition: color 0.3s ease;
        }

        .payment-method-card input[type="radio"]:checked + .payment-method-label .payment-method-check {
            color: #667eea;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .text-white-75 {
            opacity: 0.85;
        }

        .bg-soft-purple {
            background-color: rgba(139, 92, 246, 0.1);
        }

        .text-purple {
            color: #8b5cf6;
        }

        .payment-details-section {
            animation: fadeInUp 0.4s ease;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Show/hide payment details sections based on selected method
            function updatePaymentSections() {
                // Hide all sections first
                $('.payment-details-section').hide();
                
                const selectedMethod = $('input[name="PayoutMethod"]:checked').val();
                
                // Show relevant section
                switch(selectedMethod) {
                    case 'BankTransfer':
                        $('#bankTransferSection').fadeIn();
                        break;
                    case 'PayPal':
                        $('#payPalSection').fadeIn();
                        break;
                    case 'VodafoneCash':
                    case 'InstaPay':
                    case 'OrangeMoney':
                    case 'EtisalatCash':
                        $('#mobileWalletSection').fadeIn();
                        break;
                    case 'Stripe':
                        $('#internationalSection').fadeIn();
                        $('#internationalProviderName').text('Stripe');
                        $('#stripeAccountIdSection').show();
                        $('#wiseEmailSection').hide();
                        break;
                    case 'Wise':
                        $('#internationalSection').fadeIn();
                        $('#internationalProviderName').text('Wise');
                        $('#wiseEmailSection').show();
                        $('#stripeAccountIdSection').hide();
                        break;
                }
            }

            // Initialize on page load
            updatePaymentSections();

            // Update on radio button change
            $('input[name="PayoutMethod"]').on('change', function() {
                updatePaymentSections();
            });

            // IBAN formatting
            $('#IBAN').on('input', function() {
                let value = $(this).val().replace(/\s/g, '').toUpperCase();
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                $(this).val(formatted);
            });

            // Centralized phone number cleaning function (matches backend logic)
            function cleanPhoneNumber(phone) {
                if (!phone) return '';
                // Remove all non-digit characters and trim
                let cleaned = phone.trim().replace(/\D/g, '');
                // Handle international format (+2 prefix) - remove if present
                if (cleaned.startsWith('2') && cleaned.length === 12) {
                    cleaned = cleaned.substring(1);
                }
                return cleaned;
            }

            // Phone number validation for mobile wallet with real-time feedback
            $('#MobileWalletNumber').on('input', function() {
                let value = cleanPhoneNumber($(this).val());
                // Limit to 11 digits
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                $(this).val(value);
                
                // Real-time validation feedback
                const isValid = value.length === 11 && value.startsWith('01');
                const $input = $(this);
                const $feedback = $input.siblings('.invalid-feedback, .valid-feedback');
                
                $input.removeClass('is-invalid is-valid');
                $feedback.remove();
                
                if (value.length > 0) {
                    if (isValid) {
                        $input.addClass('is-valid');
                    } else {
                        $input.addClass('is-invalid');
                        let errorMsg = '';
                        if (value.length !== 11) {
                            errorMsg = 'يجب أن يكون 11 رقم';
                        } else if (!value.startsWith('01')) {
                            errorMsg = 'يجب أن يبدأ بـ 01';
                        }
                        if (errorMsg) {
                            $input.after('<div class="invalid-feedback">' + errorMsg + '</div>');
                        }
                    }
                }
            });
            
            // Also clean on blur to ensure consistency
            $('#MobileWalletNumber').on('blur', function() {
                let value = cleanPhoneNumber($(this).val());
                $(this).val(value);
            });

            // Form validation
            $('#paymentSettingsForm').on('submit', function(e) {
                const selectedMethod = $('input[name="PayoutMethod"]:checked').val();
                
                if (!selectedMethod) {
                    e.preventDefault();
                    alert('يرجى اختيار طريقة الدفع');
                    return false;
                }

                // Validate based on selected method
                if (selectedMethod === 'BankTransfer') {
                    if (!$('#BankName').val() || !$('#BankAccountName').val() || !$('#BankAccountNumber').val()) {
                        e.preventDefault();
                        alert('يرجى إكمال جميع الحقول المطلوبة للحساب البنكي');
                        return false;
                    }
                    
                    // Validate SWIFT code if provided
                    const swiftCode = $('#SwiftCode').val();
                    if (swiftCode && (swiftCode.length < 8 || swiftCode.length > 11)) {
                        e.preventDefault();
                        alert('رمز SWIFT يجب أن يكون بين 8 و 11 حرف');
                        return false;
                    }
                } else if (selectedMethod === 'PayPal') {
                    const email = $('#PayPalEmail').val();
                    if (!email || !isValidEmail(email)) {
                        e.preventDefault();
                        alert('يرجى إدخال بريد إلكتروني صحيح لـ PayPal');
                        return false;
                    }
                } else if (selectedMethod === 'VodafoneCash' || selectedMethod === 'InstaPay' || selectedMethod === 'OrangeMoney' || selectedMethod === 'EtisalatCash') {
                    // Ensure mobile wallet section is visible before validation
                    if (!$('#mobileWalletSection').is(':visible')) {
                        $('#mobileWalletSection').show();
                    }
                    
                    // Clean phone number using centralized function
                    // Use ID selector (generated by asp-for) for reliability
                    const $phoneInput = $('#MobileWalletNumber');
                    let phone = cleanPhoneNumber($phoneInput.val() || '');
                    
                    // Update the input field with cleaned value BEFORE validation
                    $phoneInput.val(phone);
                    
                    // Get provider from the select dropdown - try multiple selectors for reliability
                    let $providerSelect = $('#MobileWalletProvider');
                    if ($providerSelect.length === 0) {
                        // Fallback to name attribute selector
                        $providerSelect = $('select[name="MobileWalletProvider"]').not(':hidden');
                    }
                    if ($providerSelect.length === 0) {
                        // Last fallback: find in mobileWalletSection
                        $providerSelect = $('#mobileWalletSection select[name="MobileWalletProvider"]');
                    }
                    
                    // Get provider value - also try reading from form data as fallback
                    let provider = $providerSelect.val() || '';
                    if (!provider && $providerSelect.length > 0) {
                        // Try reading selected option text as additional check
                        const selectedOption = $providerSelect.find('option:selected');
                        if (selectedOption.length > 0 && selectedOption.val()) {
                            provider = selectedOption.val();
                        }
                    }
                    
                    // Validate phone number
                    if (!phone || phone.length !== 11) {
                        e.preventDefault();
                        alert('يرجى إدخال رقم هاتف صحيح (11 رقم)');
                        $phoneInput.focus();
                        return false;
                    }
                    
                    // Validate phone starts with 01 (Egyptian mobile format)
                    if (!phone.startsWith('01')) {
                        e.preventDefault();
                        alert('رقم الهاتف يجب أن يبدأ بـ 01');
                        $phoneInput.focus();
                        return false;
                    }
                    
                    // Validate provider - check if it's empty, whitespace, or invalid
                    // Valid providers: VodafoneCash, InstaPay, OrangeMoney, EtisalatCash
                    const validProviders = ['VodafoneCash', 'InstaPay', 'OrangeMoney', 'EtisalatCash'];
                    if (!provider || provider.trim() === '' || !validProviders.includes(provider)) {
                        e.preventDefault();
                        alert('يرجى اختيار مزود المحفظة');
                        if ($providerSelect.length > 0) {
                            $providerSelect.focus();
                        }
                        return false;
                    }
                } else if (selectedMethod === 'Wise') {
                    const email = $('#WiseEmail').val();
                    if (!email || !isValidEmail(email)) {
                        e.preventDefault();
                        alert('يرجى إدخال بريد إلكتروني صحيح لـ Wise');
                        return false;
                    }
                }

                return true;
            });
        });

        // Validate payment details without submitting
        function validatePaymentDetails() {
            const selectedMethod = $('input[name="PayoutMethod"]:checked').val();
            
            if (!selectedMethod) {
                alert('يرجى اختيار طريقة الدفع أولاً');
                return;
            }

            let isValid = true;
            let message = 'تم التحقق من البيانات بنجاح! ✓\n\n';

            if (selectedMethod === 'BankTransfer') {
                const bankName = $('#BankName').val();
                const accountName = $('#BankAccountName').val();
                const accountNumber = $('#BankAccountNumber').val();
                
                if (!bankName || !accountName || !accountNumber) {
                    isValid = false;
                    message = 'يرجى إكمال جميع الحقول المطلوبة';
                } else {
                    message += 'البنك: ' + bankName + '\n';
                    message += 'صاحب الحساب: ' + accountName + '\n';
                    message += 'رقم الحساب: ' + accountNumber.replace(/\d(?=\d{4})/g, '*');
                }
            } else if (selectedMethod === 'PayPal') {
                const email = $('#PayPalEmail').val();
                if (!email || !isValidEmail(email)) {
                    isValid = false;
                    message = 'يرجى إدخال بريد إلكتروني صحيح';
                } else {
                    message += 'بريد PayPal: ' + email;
                }
            }

            if (isValid) {
                alert(message);
            } else {
                alert('⚠️ ' + message);
            }
        }

        // Email validation helper
        function isValidEmail(email) {
            const re = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            return re.test(email);
        }

        // Auto-save to localStorage (draft)
        let autoSaveTimer;
        $('#paymentSettingsForm input, #paymentSettingsForm select').on('input change', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(function() {
                const formData = $('#paymentSettingsForm').serializeArray();
                localStorage.setItem('paymentSettingsDraft', JSON.stringify(formData));
            }, 2000);
        });

        // Clear draft after successful submit
        $('#paymentSettingsForm').on('submit', function() {
            localStorage.removeItem('paymentSettingsDraft');
        });
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

