@model LMS.Areas.Instructor.ViewModels.InstructorProfileEditViewModel

@{
    ViewData["Title"] = Html.T("تعديل الملف الشخصي", "Edit Profile");
    ViewData["Subtitle"] = Html.T("قم بتحديث معلوماتك الشخصية والمهنية", "Update your personal and professional info");
}

@{
    var indexUrl = Url.Action("Index");
    var actionButtonsHtml = "<a href='" + indexUrl + "' class='btn btn-light'>" +
        "<i class='feather-arrow-right me-2'></i>" +
        "العودة للملف الشخصي" +
        "</a>";
}
@await Html.PartialAsync("_PageHeader", new ViewDataDictionary(ViewData)
{
    { "ActionButtons", Html.Raw(actionButtonsHtml) }
})

<div class="main-content">
    @await Html.PartialAsync("_AlertMessages")

    <form asp-action="Edit" method="post" id="profileEditForm">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Personal Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-user me-2 text-primary"></i>
                            المعلومات الشخصية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label" asp-for="FirstName">
                                    الاسم الأول <span class="text-danger">*</span>
                                </label>
                                <input asp-for="FirstName" class="form-control" placeholder="@Html.T("أحمد", "Ahmed")" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="LastName">
                                    الاسم الأخير <span class="text-danger">*</span>
                                </label>
                                <input asp-for="LastName" class="form-control" placeholder="@Html.T("محمد", "Mohammed")" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Headline">
                                    العنوان المهني
                                </label>
                                <input asp-for="Headline" class="form-control" placeholder="@Html.T("مثال: مطور برمجيات | خبير في ASP.NET", "e.g. Software developer | ASP.NET expert")" maxlength="200" />
                                <span asp-validation-for="Headline" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    عنوان قصير يصف خبرتك المهنية (يظهر أسفل اسمك في الملف الشخصي)
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Bio">
                                    نبذة مختصرة عنك
                                </label>
                                <textarea asp-for="Bio" class="form-control" rows="4" placeholder="@Html.T("أخبرنا عنك بشكل مختصر...", "Tell us about yourself briefly...")" maxlength="1000"></textarea>
                                <span asp-validation-for="Bio" class="text-danger"></span>
                                <div class="form-text d-flex justify-content-between">
                                    <span>
                                        <i class="feather-info me-1"></i>
                                        نبذة عامة تظهر في ملفك الشخصي
                                    </span>
                                    <span class="text-muted" id="bioCounter">0 / 1000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Professional Bio -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-briefcase me-2 text-primary"></i>
                            السيرة الذاتية المهنية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-start">
                                <i class="feather-info fs-18 me-2"></i>
                                <div>
                                    <strong>نصيحة:</strong> اكتب سيرة ذاتية شاملة تتضمن:
                                    <ul class="mb-0 mt-2">
                                        <li>خبراتك التعليمية والمهنية</li>
                                        <li>مهاراتك وتخصصاتك</li>
                                        <li>شهاداتك وإنجازاتك</li>
                                        <li>أسلوبك في التدريس</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <label class="form-label" asp-for="InstructorBio">
                            السيرة الذاتية التفصيلية
                        </label>
                        <textarea asp-for="InstructorBio" class="form-control" rows="10" id="instructorBioEditor" placeholder="@Html.T("اكتب سيرتك الذاتية التفصيلية هنا...", "Write your detailed bio here...")"></textarea>
                        <span asp-validation-for="InstructorBio" class="text-danger"></span>
                        <div class="form-text">
                            <i class="feather-alert-circle me-1"></i>
                            يجب أن تكون السيرة الذاتية 50 حرفاً على الأقل لإكمال ملفك الشخصي
                        </div>
                    </div>
                </div>

                <!-- Location & Language -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-map-pin me-2 text-primary"></i>
                            الموقع واللغة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label" asp-for="Country">
                                    الدولة
                                </label>
                                <select asp-for="Country" class="form-select" id="countrySelect">
                                    <option value="">-- اختر الدولة --</option>
                                    <option value="مصر">مصر</option>
                                    <option value="السعودية">السعودية</option>
                                    <option value="الإمارات">الإمارات العربية المتحدة</option>
                                    <option value="الكويت">الكويت</option>
                                    <option value="قطر">قطر</option>
                                    <option value="البحرين">البحرين</option>
                                    <option value="عمان">عمان</option>
                                    <option value="الأردن">الأردن</option>
                                    <option value="لبنان">لبنان</option>
                                    <option value="فلسطين">فلسطين</option>
                                    <option value="سوريا">سوريا</option>
                                    <option value="العراق">العراق</option>
                                    <option value="المغرب">المغرب</option>
                                    <option value="الجزائر">الجزائر</option>
                                    <option value="تونس">تونس</option>
                                    <option value="ليبيا">ليبيا</option>
                                    <option value="السودان">السودان</option>
                                    <option value="اليمن">اليمن</option>
                                    <option value="الصومال">الصومال</option>
                                    <option value="جيبوتي">جيبوتي</option>
                                    <option value="موريتانيا">موريتانيا</option>
                                    <option value="جزر القمر">جزر القمر</option>
                                </select>
                                <span asp-validation-for="Country" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="City">
                                    المدينة
                                </label>
                                <input asp-for="City" class="form-control" placeholder="@Html.T("القاهرة", "Cairo")" maxlength="100" />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="TimeZone">
                                    المنطقة الزمنية
                                </label>
                                <select asp-for="TimeZone" class="form-select">
                                    <option value="Africa/Cairo">القاهرة (GMT+2)</option>
                                    <option value="Asia/Riyadh">الرياض (GMT+3)</option>
                                    <option value="Asia/Dubai">دبي (GMT+4)</option>
                                    <option value="Asia/Kuwait">الكويت (GMT+3)</option>
                                    <option value="Asia/Qatar">الدوحة (GMT+3)</option>
                                    <option value="Asia/Bahrain">المنامة (GMT+3)</option>
                                    <option value="Asia/Muscat">مسقط (GMT+4)</option>
                                    <option value="Asia/Amman">عمّان (GMT+2)</option>
                                    <option value="Asia/Beirut">بيروت (GMT+2)</option>
                                    <option value="Asia/Damascus">دمشق (GMT+2)</option>
                                    <option value="Asia/Baghdad">بغداد (GMT+3)</option>
                                    <option value="Africa/Casablanca">الدار البيضاء (GMT)</option>
                                    <option value="Africa/Algiers">الجزائر (GMT+1)</option>
                                    <option value="Africa/Tunis">تونس (GMT+1)</option>
                                </select>
                                <span asp-validation-for="TimeZone" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-clock me-1"></i>
                                    تستخدم في جدولة الدروس المباشرة
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="Language">
                                    @Html.T("اللغة المفضلة", "Preferred language")
                                </label>
                                <select asp-for="Language" class="form-select">
                                    <option value="ar">@Html.T("العربية", "Arabic")</option>
                                    <option value="en">@Html.T("English", "English")</option>
                                    <option value="fr">@Html.T("Français", "French")</option>
                                </select>
                                <span asp-validation-for="Language" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-globe me-1"></i>
                                    @Html.T("لغة واجهة النظام", "Interface language")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact & Web -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-link me-2 text-primary"></i>
                            الموقع الإلكتروني وروابط التواصل
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="Website">
                                    <i class="feather-globe me-1"></i>
                                    الموقع الإلكتروني الشخصي
                                </label>
                                <input asp-for="Website" type="url" class="form-control" placeholder="https://www.example.com" />
                                <span asp-validation-for="Website" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="feather-info me-1"></i>
                                    رابط موقعك الشخصي أو محفظة أعمالك (Portfolio)
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="alert alert-soft-info mb-0">
                                    <div class="d-flex align-items-center">
                                        <i class="feather-info fs-18 me-3"></i>
                                        <div>
                                            <strong>ملاحظة:</strong> يمكنك إضافة روابط حساباتك على وسائل التواصل الاجتماعي (LinkedIn, Twitter, Facebook, YouTube) من صفحة الإعدادات الكاملة.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Profile Completion -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("اكتمال الملف الشخصي", "Profile completion")</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="progress-circle mx-auto" data-progress="75">
                                <svg viewBox="0 0 100 100" style="width: 120px; height: 120px;">
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="#667eea" stroke-width="8" 
                                            stroke-dasharray="283" stroke-dashoffset="71" 
                                            stroke-linecap="round" transform="rotate(-90 50 50)" id="progressCircle"/>
                                    <text x="50" y="50" text-anchor="middle" dy="7" class="fs-20 fw-bold" fill="#1f2937" id="progressText">75%</text>
                                </svg>
                            </div>
                        </div>
                        
                        <h6 class="text-center mb-4">@Html.T("قم بإكمال ملفك لزيادة مصداقيتك", "Complete your profile to increase credibility")</h6>

                        <div class="completion-checklist">
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <div class="avatar-text avatar-sm bg-soft-success text-success me-3">
                                    <i class="feather-check"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">@Html.T("المعلومات الأساسية", "Basic information")</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <div class="avatar-text avatar-sm bg-soft-warning text-warning me-3">
                                    <i class="feather-clock"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">@Html.T("السيرة الذاتية المهنية", "Professional bio")</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                                <div class="avatar-text avatar-sm bg-soft-secondary text-secondary me-3">
                                    <i class="feather-circle"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">@Html.T("إعدادات الدفع", "Payment settings")</p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="avatar-text avatar-sm bg-soft-secondary text-secondary me-3">
                                    <i class="feather-circle"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">@Html.T("أنشئ دورتك الأولى", "Create your first course")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("إجراءات سريعة", "Quick actions")</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="@Url.Action("PaymentSettings")" class="btn btn-light">
                                <i class="feather-credit-card me-2"></i>
                                @Html.T("إعدادات الدفع", "Payment settings")
                            </a>
                            <a href="@Url.Action("Index", "Courses")" class="btn btn-light">
                                <i class="feather-book me-2"></i>
                                @Html.T("دوراتي", "My courses")
                            </a>
                            <a href="@Url.Action("Index", "Dashboard")" class="btn btn-light">
                                <i class="feather-home me-2"></i>
                                @Html.T("لوحة التحكم", "Dashboard")
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Help & Tips -->
                <div class="card stretch stretch-full bg-soft-success border-0">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="feather-help-circle text-success" style="font-size: 48px;"></i>
                        </div>
                        <h6 class="text-center mb-3">@Html.T("نصائح لملف شخصي مميز", "Tips for a great profile")</h6>
                        <ul class="fs-13 mb-0">
                            <li class="mb-2">@Html.T("استخدم صورة احترافية", "Use a professional photo")</li>
                            <li class="mb-2">@Html.T("اكتب سيرة ذاتية مفصلة", "Write a detailed bio")</li>
                            <li class="mb-2">@Html.T("أضف خبراتك وشهاداتك", "Add your experience and certifications")</li>
                            <li class="mb-0">@Html.T("حدّث معلوماتك بانتظام", "Update your info regularly")</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <a href="@Url.Action("Index")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء", "Cancel")
                            </a>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-light" onclick="resetForm()">
                                    <i class="feather-rotate-ccw me-2"></i>
                                    إعادة تعيين
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="feather-save me-2"></i>
                                    حفظ التغييرات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .progress-circle svg {
            transform: rotate(-90deg);
        }
        
        .completion-checklist .avatar-text {
            min-width: 35px;
            width: 35px;
            height: 35px;
        }

        .bg-soft-info {
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .alert-soft-info {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: #1e40af;
        }
    </style>
}

@section Scripts {
    @await Html.PartialAsync("_TinyMCEScripts")
    
    <script>
        // Initialize TinyMCE for Instructor Bio
        initTinyMCE('#instructorBioEditor', { 
            height: 400, 
            plugins: 'lists link code wordcount' 
        });

        // Bio character counter
        const bioTextarea = document.querySelector('[name="Bio"]');
        const bioCounter = document.getElementById('bioCounter');
        
        if (bioTextarea) {
            bioTextarea.addEventListener('input', function() {
                const count = this.value.length;
                bioCounter.textContent = count + ' / 1000';
                if (count > 1000) {
                    bioCounter.classList.add('text-danger');
                } else {
                    bioCounter.classList.remove('text-danger');
                }
            });
            // Initialize counter
            bioTextarea.dispatchEvent(new Event('input'));
        }

        // Form validation
        document.getElementById('profileEditForm').addEventListener('submit', function(e) {
            // Sync TinyMCE content to textarea before submission
            try {
                const editor = tinymce.get('instructorBioEditor');
                if (editor) editor.save();
            } catch (err) {
                console.warn('TinyMCE sync warning:', err);
            }

            const firstName = document.querySelector('[name="FirstName"]').value.trim();
            const lastName = document.querySelector('[name="LastName"]').value.trim();
            
            if (!firstName || !lastName) {
                e.preventDefault();
                alert('يرجى إدخال الاسم الأول والأخير');
                return false;
            }

            // Get TinyMCE content
            let instructorBio = '';
            try {
                const editor = tinymce.get('instructorBioEditor');
                if (editor) {
                    instructorBio = editor.getContent({ format: 'text' }).trim();
                } else {
                    instructorBio = document.querySelector('[name="InstructorBio"]')?.value?.trim() || '';
                }
            } catch (err) {
                instructorBio = document.querySelector('[name="InstructorBio"]')?.value?.trim() || '';
            }
            
            if (instructorBio.length > 0 && instructorBio.length < 50) {
                e.preventDefault();
                alert('السيرة الذاتية يجب أن تكون 50 حرفاً على الأقل');
                return false;
            }

            // Validate website URL if provided
            const website = document.querySelector('[name="Website"]').value.trim();
            if (website && !isValidUrl(website)) {
                e.preventDefault();
                alert('يرجى إدخال رابط صحيح للموقع الإلكتروني (يجب أن يبدأ بـ http:// أو https://)');
                return false;
            }

            return true;
        });

        // Reset form
        function resetForm() {
            if (confirm('هل أنت متأكد من إعادة تعيين النموذج؟ سيتم فقدان جميع التغييرات غير المحفوظة.')) {
                document.getElementById('profileEditForm').reset();
                tinymce.get('instructorBioEditor').setContent('');
            }
        }

        // URL validation helper
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        // Auto-save draft (optional enhancement)
        let autoSaveTimer;
        function autoSaveDraft() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                // Save to localStorage
                const formData = {
                    firstName: document.querySelector('[name="FirstName"]').value,
                    lastName: document.querySelector('[name="LastName"]').value,
                    bio: document.querySelector('[name="Bio"]').value,
                    instructorBio: tinymce.get('instructorBioEditor').getContent(),
                    headline: document.querySelector('[name="Headline"]').value,
                    website: document.querySelector('[name="Website"]').value,
                    country: document.querySelector('[name="Country"]').value,
                    city: document.querySelector('[name="City"]').value
                };
                localStorage.setItem('instructorProfileDraft', JSON.stringify(formData));
                console.log('Draft saved automatically');
            }, 3000); // Save after 3 seconds of inactivity
        }

        // Add auto-save listeners
        document.querySelectorAll('#profileEditForm input, #profileEditForm select, #profileEditForm textarea').forEach(el => {
            el.addEventListener('input', autoSaveDraft);
        });

        // Load draft on page load if exists
        window.addEventListener('DOMContentLoaded', function() {
            const draft = localStorage.getItem('instructorProfileDraft');
            if (draft && confirm('تم العثور على مسودة محفوظة. هل تريد استعادتها؟')) {
                const data = JSON.parse(draft);
                document.querySelector('[name="FirstName"]').value = data.firstName || '';
                document.querySelector('[name="LastName"]').value = data.lastName || '';
                document.querySelector('[name="Bio"]').value = data.bio || '';
                document.querySelector('[name="Headline"]').value = data.headline || '';
                document.querySelector('[name="Website"]').value = data.website || '';
                document.querySelector('[name="Country"]').value = data.country || '';
                document.querySelector('[name="City"]').value = data.city || '';
                
                // Set TinyMCE content after it's initialized
                setTimeout(() => {
                    tinymce.get('instructorBioEditor').setContent(data.instructorBio || '');
                }, 1000);
            }
        });

        // Clear draft after successful save
        document.getElementById('profileEditForm').addEventListener('submit', function() {
            localStorage.removeItem('instructorProfileDraft');
        });
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

