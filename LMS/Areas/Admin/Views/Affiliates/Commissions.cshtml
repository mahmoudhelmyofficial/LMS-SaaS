@model IEnumerable<LMS.Areas.Admin.ViewModels.AffiliateCommissionDisplayViewModel>

@{
    ViewData["Title"] = Html.T("إدارة عمولات الشركاء", "Affiliate commissions management");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التسويق بالعمولة", "Affiliate Marketing"), null),
        (Html.T("إدارة الشركاء التابعين", "Affiliates"), Url.Action("Index", "Affiliates")),
        (Html.T("عمولات الشركاء", "Affiliate Commissions"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    ViewData["ShowStats"] = true;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("الشركاء", "Affiliates"), "feather-users", Url.Action("Index", "Affiliates"), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@section Styles {
    <link rel="stylesheet" href="~/assets/vendors/css/dataTables.bs5.min.css" />
    <style>
        .commission-amount {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .status-pending {
            color: #f7b84b;
        }
        .status-approved {
            color: #0ab39c;
        }
        .status-paid {
            color: #3454d1;
        }
        .status-rejected {
            color: #f06548;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

@section StatsCards {
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                            <i class="feather-list"></i>
                        </div>
                        <div>
                            <span class="text-muted d-block mb-1">@Html.T("إجمالي العمولات", "Total commissions")</span>
                            <h3 class="fw-bold mb-0">@Model.Count().ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-warning text-warning">
                            <i class="feather-clock"></i>
                        </div>
                        <div>
                            <span class="text-muted d-block mb-1">@Html.T("قيد الانتظار", "Pending")</span>
                            <h3 class="fw-bold mb-0">@Model.Count(c => c.Status == "Pending").ToString("N0")</h3>
                            <small class="text-muted">@Model.Where(c => c.Status == "Pending").Sum(c => c.CommissionAmount).ToEGP()</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                            <i class="feather-check-circle"></i>
                        </div>
                        <div>
                            <span class="text-muted d-block mb-1">@Html.T("معتمدة", "Approved")</span>
                            <h3 class="fw-bold mb-0">@Model.Count(c => c.Status == "Approved").ToString("N0")</h3>
                            <small class="text-muted">@Model.Where(c => c.Status == "Approved").Sum(c => c.CommissionAmount).ToEGP()</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-info text-info">
                            <i class="feather-dollar-sign"></i>
                        </div>
                        <div>
                            <span class="text-muted d-block mb-1">@Html.T("إجمالي المبلغ", "Total amount")</span>
                            <h3 class="fw-bold mb-0">@Model.Sum(c => c.CommissionAmount).ToEGP()</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section FilterDropdown {
    <a href="javascript:void(0);" class="dropdown-item filter-all">
        <i class="feather-eye me-3"></i>
        <span>@Html.T("الكل", "All")</span>
    </a>
    <a href="javascript:void(0);" class="dropdown-item filter-pending">
        <i class="feather-clock me-3"></i>
        <span>@Html.T("قيد الانتظار", "Pending")</span>
    </a>
    <a href="javascript:void(0);" class="dropdown-item filter-approved">
        <i class="feather-check-circle me-3"></i>
        <span>@Html.T("معتمدة", "Approved")</span>
    </a>
    <a href="javascript:void(0);" class="dropdown-item filter-paid">
        <i class="feather-dollar-sign me-3"></i>
        <span>@Html.T("مدفوعة", "Paid")</span>
    </a>
    <a href="javascript:void(0);" class="dropdown-item filter-rejected">
        <i class="feather-x-circle me-3"></i>
        <span>@Html.T("مرفوضة", "Rejected")</span>
    </a>
}

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("عمولات الشركاء التابعين", "Affiliate commissions")</h5>
                    <div class="card-header-action">
                        <button class="btn btn-sm btn-success" onclick="approveSelected()">
                            <i class="feather-check me-2"></i>
                            @Html.T("اعتماد المحدد", "Approve selected")
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover" id="commissionsTable">
                            <thead>
                                <tr>
                                    <th class="wd-30">
                                        <div class="custom-control custom-checkbox ms-1">
                                            <input type="checkbox" class="custom-control-input" id="checkAll">
                                            <label class="custom-control-label" for="checkAll"></label>
                                        </div>
                                    </th>
                                    <th>@Html.T("الشريك", "Affiliate")</th>
                                    <th>@Html.T("الدورة", "Course")</th>
                                    <th>@Html.T("مبلغ البيع", "Sale amount")</th>
                                    <th>@Html.T("نسبة العمولة", "Commission rate")</th>
                                    <th>@Html.T("مبلغ العمولة", "Commission amount")</th>
                                    <th>@Html.T("التاريخ", "Date")</th>
                                    <th>@Html.T("الحالة", "Status")</th>
                                    <th class="text-end">@Html.T("الإجراءات", "Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var commission in Model)
                                {
                                    <tr>
                                        <td>
                                            <div class="item-checkbox ms-1">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input checkbox" 
                                                           id="checkBox_@commission.Id" 
                                                           data-id="@commission.Id"
                                                           @(commission.Status == "Pending" ? "" : "disabled")>
                                                    <label class="custom-control-label" for="checkBox_@commission.Id"></label>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="hstack gap-3">
                                                <div class="avatar-text avatar-sm bg-soft-primary text-primary">
                                                    @commission.AffiliateName.Substring(0, 1)
                                                </div>
                                                <span class="fw-semibold">@commission.AffiliateName</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-truncate-1-line d-block" style="max-width: 250px;">@commission.CourseName</span>
                                        </td>
                                        <td>
                                            <span class="fw-semibold">@commission.SaleAmount.ToEGP()</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-soft-info text-info">@commission.CommissionRate.ToString("F1")%</span>
                                        </td>
                                        <td>
                                            <span class="commission-amount text-success">@commission.CommissionAmount.ToEGP()</span>
                                        </td>
                                        <td>
                                            <span class="text-muted">@commission.CreatedAt.ToString("dd/MM/yyyy")</span>
                                            <small class="d-block text-muted">@commission.CreatedAt.ToString("hh:mm tt")</small>
                                        </td>
                                        <td>
                                            @switch (commission.Status)
                                            {
                                                case "Pending":
                                                    <span class="badge bg-soft-warning text-warning">@Html.T("قيد الانتظار", "Pending")</span>
                                                    break;
                                                case "Approved":
                                                    <span class="badge bg-soft-success text-success">@Html.T("معتمدة", "Approved")</span>
                                                    break;
                                                case "Paid":
                                                    <span class="badge bg-soft-info text-info">@Html.T("مدفوعة", "Paid")</span>
                                                    break;
                                                case "Rejected":
                                                    <span class="badge bg-soft-danger text-danger">@Html.T("مرفوضة", "Rejected")</span>
                                                    break;
                                                default:
                                                    <span class="badge bg-soft-secondary text-secondary">@commission.Status</span>
                                                    break;
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="hstack gap-2 justify-content-end">
                                                @if (commission.Status == "Pending")
                                                {
                                                    <form asp-action="ApproveCommission" method="post" style="display:inline;">
                                                        <input type="hidden" name="id" value="@commission.Id" />
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="@Html.T("اعتماد", "Approve")">
                                                            <i class="feather-check"></i>
                                                        </button>
                                                    </form>
                                                    <button class="btn btn-sm btn-danger" onclick="rejectCommission('@commission.Id')" data-bs-toggle="tooltip" title="@Html.T("رفض", "Reject")">
                                                        <i class="feather-x"></i>
                                                    </button>
                                                }
                                                @if (commission.Status == "Approved")
                                                {
                                                    <button class="btn btn-sm btn-info" onclick="markAsPaid('@commission.Id')" data-bs-toggle="tooltip" title="@Html.T("تعيين كمدفوعة", "Mark as paid")">
                                                        <i class="feather-dollar-sign"></i>
                                                    </button>
                                                }
                                                <div class="dropdown">
                                                    <a href="javascript:void(0)" class="avatar-text avatar-md" data-bs-toggle="dropdown" data-bs-offset="0,21">
                                                        <i class="feather-more-horizontal"></i>
                                                    </a>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li>
                                                            <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteCommission('@commission.Id')">
                                                                <i class="feather-trash-2 me-3"></i>
                                                                <span>@Html.T("حذف", "Delete")</span>
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Forms for POST Actions -->
<form id="rejectForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="reason" id="rejectReason" />
</form>

<form id="markPaidForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

<form id="approveSelectedForm" method="post" asp-action="ApproveSelectedCommissions" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="ids" id="selectedIds" />
</form>

<form id="deleteCommissionForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script src="~/assets/vendors/js/dataTables.min.js"></script>
    <script src="~/assets/vendors/js/dataTables.bs5.min.js"></script>
    <script>
        window.__AffiliateCommissionsT = {
            selectOne: '@Html.Raw(Html.T("الرجاء تحديد عمولة واحدة على الأقل", "Please select at least one commission").Replace("'", "\\'"))',
            approveConfirm: '@Html.Raw(Html.T("هل تريد اعتماد", "Do you want to approve").Replace("'", "\\'"))',
            commissionCount: '@Html.Raw(Html.T("عمولة؟", "commission(s)?").Replace("'", "\\'"))',
            rejectPrompt: '@Html.Raw(Html.T("الرجاء إدخال سبب الرفض:", "Please enter rejection reason:").Replace("'", "\\'"))',
            noReason: '@Html.Raw(Html.T("لم يتم تحديد سبب", "No reason specified").Replace("'", "\\'"))',
            markPaidConfirm: '@Html.Raw(Html.T("هل تم دفع هذه العمولة بالفعل؟", "Has this commission been paid?").Replace("'", "\\'"))',
            deleteConfirm: '@Html.Raw(Html.T("هل أنت متأكد من حذف هذه العمولة؟", "Are you sure you want to delete this commission?").Replace("'", "\\'"))'
        };
        $(document).ready(function() {
            var dataTableLangUrl = "@(Html.IsRtl() ? "//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json" : "//cdn.datatables.net/plug-ins/1.13.7/i18n/en-GB.json")";
            var table = $('#commissionsTable').DataTable({
                "language": { "url": dataTableLangUrl },
                "order": [[6, "desc"]],
                "pageLength": 25
            });

            $('#checkAll').on('change', function() {
                $('.checkbox:not(:disabled)').prop('checked', $(this).prop('checked'));
            });

            $('.filter-all').on('click', function() {
                table.column(7).search('').draw();
            });

            $('.filter-pending').on('click', function() {
                table.column(7).search('@Html.Raw(Html.T("قيد الانتظار", "Pending"))').draw();
            });

            $('.filter-approved').on('click', function() {
                table.column(7).search('@Html.Raw(Html.T("معتمدة", "Approved"))').draw();
            });

            $('.filter-paid').on('click', function() {
                table.column(7).search('@Html.Raw(Html.T("مدفوعة", "Paid"))').draw();
            });

            $('.filter-rejected').on('click', function() {
                table.column(7).search('@Html.Raw(Html.T("مرفوضة", "Rejected"))').draw();
            });

            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function approveSelected() {
            var selectedIds = [];
            $('.checkbox:checked').each(function() {
                var id = $(this).data('id');
                if (id) selectedIds.push(id);
            });

            if (selectedIds.length === 0) {
                alert(window.__AffiliateCommissionsT.selectOne);
                return;
            }

            if (confirm(window.__AffiliateCommissionsT.approveConfirm + ' ' + selectedIds.length + ' ' + window.__AffiliateCommissionsT.commissionCount)) {
                document.getElementById('selectedIds').value = selectedIds.join(',');
                document.getElementById('approveSelectedForm').submit();
            }
        }

        function rejectCommission(commissionId) {
            var reason = prompt(window.__AffiliateCommissionsT.rejectPrompt);
            if (reason !== null) {
                document.getElementById('rejectReason').value = reason || window.__AffiliateCommissionsT.noReason;
                var form = document.getElementById('rejectForm');
                form.action = '@Url.Action("RejectCommission", "Affiliates")/' + commissionId;
                form.submit();
            }
        }

        function markAsPaid(commissionId) {
            if (confirm(window.__AffiliateCommissionsT.markPaidConfirm)) {
                var form = document.getElementById('markPaidForm');
                form.action = '@Url.Action("MarkAsPaid", "Affiliates")/' + commissionId;
                form.submit();
            }
        }

        function deleteCommission(commissionId) {
            if (confirm(window.__AffiliateCommissionsT.deleteConfirm)) {
                var form = document.getElementById('deleteCommissionForm');
                form.action = '@Url.Action("DeleteCommission", "Affiliates")/' + commissionId;
                form.submit();
            }
        }
    </script>
}

