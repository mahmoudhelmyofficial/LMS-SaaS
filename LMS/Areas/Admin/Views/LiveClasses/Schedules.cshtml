@model List<LMS.Domain.Entities.LiveSessions.LiveSessionSchedule>
@{
    ViewData["Title"] = Html.T("جداول الحصص", "Session Schedules");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("البث المباشر", "Live Sessions"), Url.Action("Index", "LiveClasses")),
        (Html.T("جداول الحصص", "Session Schedules"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var statusFilter = ViewBag.StatusFilter as LMS.Domain.Enums.LiveScheduleStatus?;
}

@await Html.PartialAsync("_PageHeader")

<!-- Filter -->
<div class="card stretch stretch-full mb-4">
    <div class="card-body">
        <form method="get" asp-action="Schedules" class="row align-items-end g-3">
            <div class="col-lg-4">
                <label class="form-label fw-bold">@Html.T("حالة الجدول", "Schedule Status")</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">@Html.T("الكل", "All")</option>
                    <option value="Draft" selected="@(statusFilter == LMS.Domain.Enums.LiveScheduleStatus.Draft)">@Html.T("مسودة", "Draft")</option>
                    <option value="Published" selected="@(statusFilter == LMS.Domain.Enums.LiveScheduleStatus.Published)">@Html.T("منشور", "Published")</option>
                    <option value="Active" selected="@(statusFilter == LMS.Domain.Enums.LiveScheduleStatus.Active)">@Html.T("نشط", "Active")</option>
                    <option value="Completed" selected="@(statusFilter == LMS.Domain.Enums.LiveScheduleStatus.Completed)">@Html.T("مكتمل", "Completed")</option>
                    <option value="Cancelled" selected="@(statusFilter == LMS.Domain.Enums.LiveScheduleStatus.Cancelled)">@Html.T("ملغي", "Cancelled")</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Stats -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                        <i class="feather-calendar"></i>
                    </div>
                    <div>
                        <span class="text-muted">@Html.T("إجمالي الجداول", "Total Schedules")</span>
                        <h3 class="fw-bolder d-block">@Model.Count</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                        <i class="feather-users"></i>
                    </div>
                    <div>
                        <span class="text-muted">@Html.T("إجمالي المشتركين", "Total Subscribers")</span>
                        <h3 class="fw-bolder d-block">@Model.Sum(s => s.EnrolledCount)</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-warning text-warning">
                        <i class="feather-dollar-sign"></i>
                    </div>
                    <div>
                        <span class="text-muted">@Html.T("إجمالي الإيرادات", "Total Revenue")</span>
                        <h3 class="fw-bolder d-block">@Model.Sum(s => s.TotalRevenue).ToString("N0")</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-info text-info">
                        <i class="feather-layers"></i>
                    </div>
                    <div>
                        <span class="text-muted">@Html.T("إجمالي الجلسات", "Total Sessions")</span>
                        <h3 class="fw-bolder d-block">@Model.Sum(s => s.TotalSessions)</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedules Table -->
<div class="card stretch stretch-full">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>@Html.T("العنوان", "Title")</th>
                        <th>@Html.T("المدرب", "Instructor")</th>
                        <th>@Html.T("الحالة", "Status")</th>
                        <th>@Html.T("الجلسات", "Sessions")</th>
                        <th>@Html.T("المشتركون", "Subscribers")</th>
                        <th>@Html.T("الإيرادات", "Revenue")</th>
                        <th>@Html.T("الفترة", "Period")</th>
                        <th>@Html.T("إجراءات", "Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var schedule in Model)
                    {
                        var statusBadge = schedule.Status switch
                        {
                            LMS.Domain.Enums.LiveScheduleStatus.Draft => ("bg-secondary", Html.T("مسودة", "Draft")),
                            LMS.Domain.Enums.LiveScheduleStatus.Published => ("bg-primary", Html.T("منشور", "Published")),
                            LMS.Domain.Enums.LiveScheduleStatus.Active => ("bg-success", Html.T("نشط", "Active")),
                            LMS.Domain.Enums.LiveScheduleStatus.Completed => ("bg-info", Html.T("مكتمل", "Completed")),
                            LMS.Domain.Enums.LiveScheduleStatus.Cancelled => ("bg-danger", Html.T("ملغي", "Cancelled")),
                            _ => ("bg-secondary", schedule.Status.ToString())
                        };

                        <tr>
                            <td>@schedule.Id</td>
                            <td>
                                <strong>@(schedule.TitleAr ?? schedule.Title)</strong>
                                @if (schedule.Course != null)
                                {
                                    <small class="text-muted d-block">@schedule.Course.Title</small>
                                }
                            </td>
                            <td>@(schedule.Instructor?.FullName ?? Html.T("غير محدد", "Not specified"))</td>
                            <td><span class="badge @statusBadge.Item1">@statusBadge.Item2</span></td>
                            <td>@schedule.TotalSessions</td>
                            <td>
                                @schedule.EnrolledCount
                                @if (schedule.MaxStudents.HasValue)
                                {
                                    <text>/ @schedule.MaxStudents</text>
                                }
                            </td>
                            <td><strong>@schedule.TotalRevenue.ToString("N0") @Html.T("ج.م", "EGP")</strong></td>
                            <td>
                                <small>@schedule.StartDate.ToString("dd/MM") - @schedule.EndDate.ToString("dd/MM/yy")</small>
                            </td>
                            <td>
                                <a asp-action="ScheduleDetails" asp-route-id="@schedule.Id" class="btn btn-sm btn-light">
                                    <i class="feather-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="card stretch stretch-full mt-4">
        <div class="card-body text-center py-5">
            <i class="feather-calendar fs-1 text-muted mb-3"></i>
            <h5>@Html.T("لا توجد جداول حصص", "No Session Schedules")</h5>
            <p class="text-muted">@Html.T("لم يتم إنشاء أي جداول حصص بعد", "No session schedules have been created yet")</p>
        </div>
    </div>
}
