@model LMS.Areas.Admin.ViewModels.CertificateRevokeViewModel

@{
    ViewData["Title"] = Html.T("إلغاء الشهادة", "Revoke certificate");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة الشهادات", "Certificates"), Url.Action("Index", "Certificates")),
        (Html.T("تفاصيل الشهادة", "Certificate details"), Url.Action("Details", "Certificates", new { id = Model.Id })),
        (Html.T("إلغاء الشهادة", "Revoke certificate"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Warning Alert -->
            <div class="alert alert-warning d-flex align-items-start mb-4">
                <i class="feather-alert-triangle fs-3 me-3 mt-1"></i>
                <div>
                    <h5 class="mb-2">@Html.T("تحذير: إجراء حساس", "Warning: Sensitive action")</h5>
                    <p class="mb-0">
                        @Html.T("أنت على وشك إلغاء شهادة. هذا الإجراء سيؤدي إلى:", "You are about to revoke a certificate. This action will:")
                    </p>
                    <ul class="mt-2 mb-0">
                        <li>@Html.T("إلغاء صلاحية الشهادة", "Revoke certificate validity")</li>
                        <li>@Html.T("ظهور الشهادة كملغاة عند التحقق منها", "Certificate will show as revoked when verified")</li>
                        <li>@Html.T("إرسال إشعار للطالب بإلغاء الشهادة", "Send notification to student about revocation")</li>
                        <li>@Html.T("تسجيل هذا الإجراء في سجل النشاط", "Log this action in activity log")</li>
                    </ul>
                </div>
            </div>

            <!-- Certificate Info -->
            <div class="card stretch stretch-full">
                <div class="card-header bg-soft-danger">
                    <h5 class="card-title text-danger mb-0">
                        <i class="feather-alert-circle me-2"></i>
                        @Html.T("معلومات الشهادة المراد إلغاؤها", "Certificate information to revoke")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="avatar-text avatar-md bg-soft-primary text-primary me-3">
                                    <i class="feather-hash"></i>
                                </div>
                                <div>
                                    <p class="text-muted mb-1">@Html.T("رقم الشهادة", "Certificate number")</p>
                                    <h6 class="fw-bold mb-0">@Model.CertificateNumber</h6>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="avatar-text avatar-md bg-soft-success text-success me-3">
                                    <i class="feather-user"></i>
                                </div>
                                <div>
                                    <p class="text-muted mb-1">@Html.T("اسم الطالب", "Student name")</p>
                                    <h6 class="fw-bold mb-0">@Model.StudentName</h6>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="d-flex align-items-start">
                                <div class="avatar-text avatar-md bg-soft-info text-info me-3">
                                    <i class="feather-book"></i>
                                </div>
                                <div>
                                    <p class="text-muted mb-1">@Html.T("اسم الدورة", "Course name")</p>
                                    <h6 class="fw-bold mb-0">@Model.CourseName</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revocation Form -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("سبب الإلغاء", "Revocation reason")</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Revoke" asp-controller="Certificates" method="post" id="revokeForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CertificateNumber" />
                        <input type="hidden" asp-for="StudentName" />
                        <input type="hidden" asp-for="CourseName" />

                        <div class="alert alert-info mb-4">
                            <i class="feather-info me-2"></i>
                            يرجى تحديد سبب واضح ودقيق لإلغاء الشهادة. سيتم إرسال هذا السبب إلى الطالب.
                        </div>

                        <!-- Common Reasons -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">@Html.T("أسباب شائعة (اختياري)", "Common reasons (optional)")</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="مخالفة سياسات المنصة">
                                    مخالفة السياسات
                                </button>
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="عدم إكمال متطلبات الدورة بشكل صحيح">
                                    عدم إكمال المتطلبات
                                </button>
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="تقديم معلومات خاطئة أو مزيفة">
                                    معلومات مزيفة
                                </button>
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="انتهاك حقوق الملكية الفكرية">
                                    انتهاك حقوق
                                </button>
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="غش أو محاولة غش في الاختبارات">
                                    غش في الاختبارات
                                </button>
                                <button type="button" class="btn btn-sm btn-light-brand reason-btn" 
                                        data-reason="طلب من الطالب نفسه">
                                    طلب من الطالب
                                </button>
                            </div>
                        </div>

                        <!-- Reason Text Area -->
                        <div class="mb-4">
                            <label asp-for="RevocationReason" class="form-label fw-semibold required">
                                سبب الإلغاء التفصيلي
                            </label>
                            <textarea asp-for="RevocationReason" class="form-control" rows="6" 
                                      placeholder="@Html.T("اكتب سبباً واضحاً ومفصلاً لإلغاء هذه الشهادة...", "Enter a clear and detailed reason for revoking this certificate...")" 
                                      required></textarea>
                            <span asp-validation-for="RevocationReason" class="text-danger"></span>
                            <div class="form-text">
                                <i class="feather-info me-1"></i>
                                يجب أن يكون السبب واضحاً ومفهوماً. الحد الأدنى 20 حرفاً.
                            </div>
                        </div>

                        <!-- Additional Options -->
                        <div class="border rounded p-3 mb-4">
                            <h6 class="fw-semibold mb-3">@Html.T("خيارات إضافية", "Additional options")</h6>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyStudent" name="notifyStudent" checked>
                                <label class="form-check-label" for="notifyStudent">
                                    إرسال إشعار للطالب عبر البريد الإلكتروني
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifyInstructor" name="notifyInstructor" checked>
                                <label class="form-check-label" for="notifyInstructor">
                                    إرسال إشعار للمدرس
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="addToLog" name="addToLog" checked disabled>
                                <label class="form-check-label text-muted" for="addToLog">
                                    تسجيل في سجل النشاط (إلزامي)
                                </label>
                            </div>
                        </div>

                        <!-- Confirmation Checkbox -->
                        <div class="border rounded p-3 bg-soft-danger mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmRevoke" required>
                                <label class="form-check-label fw-semibold" for="confirmRevoke">
                                    أؤكد أنني قرأت وفهمت تبعات هذا الإجراء وأرغب في المتابعة
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Details", "Certificates", new { id = Model.Id })" 
                               class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-danger" id="submitBtn" disabled>
                                <i class="feather-alert-circle me-2"></i>
                                @Html.T("تأكيد إلغاء الشهادة", "Confirm revoke certificate")
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Important Notes -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>
                        @Html.T("ملاحظات مهمة", "Important notes")
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">
                            <strong>@Html.T("لا يمكن التراجع عن الإلغاء تلقائياً:", "Revocation cannot be automatically undone:")</strong> 
                            @Html.T("سيحتاج المدير إلى استعادة الشهادة يدوياً إذا كان الإلغاء خاطئاً.", "An admin will need to manually restore the certificate if the revocation was a mistake.")
                        </li>
                        <li class="mb-2">
                            <strong>@Html.T("التحقق من الشهادة:", "Certificate verification:")</strong> 
                            @Html.T("عند محاولة التحقق من الشهادة، سيظهر أنها ملغاة مع السبب.", "When the certificate is verified, it will show as revoked with the reason.")
                        </li>
                        <li class="mb-2">
                            <strong>@Html.T("البريد الإلكتروني:", "Email:")</strong> 
                            @Html.T("سيتلقى الطالب إشعاراً يحتوي على سبب الإلغاء وتعليمات حول كيفية الاعتراض إذا لزم الأمر.", "The student will receive an email with the revocation reason and instructions on how to appeal if needed.")
                        </li>
                        <li class="mb-0">
                            <strong>@Html.T("سجل النشاط:", "Activity log:")</strong> 
                            @Html.T("يتم تسجيل جميع عمليات الإلغاء مع التفاصيل الكاملة في سجل النشاط للمراجعة والتدقيق.", "All revocations are logged with full details in the activity log for review and audit.")
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        window.__RevokeT = {
            reasonMinLength: '@Html.Raw(Html.T("يجب أن يكون سبب الإلغاء 20 حرفاً على الأقل", "Revocation reason must be at least 20 characters").Replace("'", "\\'"))',
            confirmRequired: '@Html.Raw(Html.T("يجب تأكيد الإجراء قبل المتابعة", "You must confirm the action to proceed").Replace("'", "\\'"))',
            confirmRevoke: '@Html.Raw(Html.T("هل أنت متأكد تماماً من إلغاء هذه الشهادة؟\n\nرقم الشهادة: {0}\nالطالب: {1}", "Are you sure you want to revoke this certificate?\n\nCertificate number: {0}\nStudent: {1}").Replace("'", "\\'").Replace("\r", "").Replace("\n", "\\n"))',
            charMin: '@Html.Raw(Html.T("حرف (الحد الأدنى: 20)", "characters (min: 20)").Replace("'", "\\'"))'
        };
    </script>
    <script>
        $(document).ready(function() {
            // Handle reason quick select buttons
            $('.reason-btn').on('click', function() {
                var reason = $(this).data('reason');
                var currentReason = $('#RevocationReason').val();
                
                if (currentReason) {
                    $('#RevocationReason').val(currentReason + '\n\n' + reason);
                } else {
                    $('#RevocationReason').val(reason);
                }
                
                checkFormValidity();
            });

            // Enable submit button only when confirmation is checked
            $('#confirmRevoke').on('change', function() {
                checkFormValidity();
            });

            $('#RevocationReason').on('input', function() {
                checkFormValidity();
            });

            function checkFormValidity() {
                var isConfirmed = $('#confirmRevoke').is(':checked');
                var hasReason = $('#RevocationReason').val().length >= 20;
                $('#submitBtn').prop('disabled', !(isConfirmed && hasReason));
            }

            // Form submission confirmation
            $('#revokeForm').on('submit', function(e) {
                var reason = $('#RevocationReason').val();
                if (reason.length < 20) {
                    e.preventDefault();
                    alert(window.__RevokeT.reasonMinLength);
                    return false;
                }

                if (!$('#confirmRevoke').is(':checked')) {
                    e.preventDefault();
                    alert(window.__RevokeT.confirmRequired);
                    return false;
                }

                var certNum = '@(Model.CertificateNumber?.Replace("'", "\\'") ?? "")';
                var studentName = '@(Model.StudentName != null ? Model.StudentName.Replace("'", "\\'") : "")';
                var msg = window.__RevokeT.confirmRevoke.replace(/\\n/g, '\n').replace('{0}', certNum).replace('{1}', studentName);
                return confirm(msg);
            });

            // Character counter
            $('#RevocationReason').on('input', function() {
                var length = $(this).val().length;
                var color = length >= 20 ? 'text-success' : 'text-danger';
                
                if ($(this).next('.char-counter').length === 0) {
                    $(this).after('<div class="form-text char-counter mt-1"></div>');
                }
                
                $(this).next('.char-counter').html(
                    '<span class="' + color + '">' + length + '</span> ' + window.__RevokeT.charMin
                );
            });
        });
    </script>
}

@section Styles {
    <style>
        .reason-btn {
            transition: all 0.3s ease;
        }
        
        .reason-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .required::after {
            content: " *";
            color: #dc3545;
        }
    </style>
}

