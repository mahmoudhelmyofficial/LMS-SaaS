@model LMS.Areas.Admin.ViewModels.CertificateStatisticsViewModel
@{
    ViewData["Title"] = Html.T("إحصائيات الشهادات", "Certificate statistics");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة الشهادات", "Certificates"), Url.Action("Index", "Certificates")),
        (Html.T("الإحصائيات", "Statistics"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("تصدير CSV", "Export CSV"), "feather-file-text", "/api/export/certificates?format=csv", "btn-outline-success"),
        (Html.T("تصدير Excel", "Export Excel"), "feather-file", "/api/export/certificates?format=excel", "btn-outline-primary"),
        (Html.T("تصدير PDF", "Export PDF"), "feather-file-text", "/api/export/certificates?format=pdf", "btn-outline-danger"),
        (Html.T("طباعة", "Print"), "feather-printer", "javascript:window.print()", "btn-outline-secondary"),
        (Html.T("تحديث", "Refresh"), "feather-refresh-cw", Url.Action("Statistics", "Certificates"), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form asp-action="Statistics" asp-controller="Certificates" method="get" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">@Html.T("من تاريخ", "From date")</label>
                            <input type="date" name="fromDate" class="form-control" 
                                   value="@(Model.FromDate?.ToString("yyyy-MM-dd") ?? DateTime.UtcNow.AddMonths(-1).ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">@Html.T("إلى تاريخ", "To date")</label>
                            <input type="date" name="toDate" class="form-control" 
                                   value="@(Model.ToDate?.ToString("yyyy-MM-dd") ?? DateTime.UtcNow.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="feather-filter me-2"></i>
                                تطبيق الفلتر
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Statistics Cards -->
    <div class="row">
        <div class="col-xxl-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="avatar-text avatar-lg bg-soft-primary text-primary">
                            <i class="feather-award"></i>
                        </div>
                        <div class="text-end">
                            <h2 class="fw-bold mb-1">@Model.TotalCertificates</h2>
                            <p class="text-muted mb-0">إجمالي الشهادات</p>
                        </div>
                    </div>
                    <div class="pt-3 mt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">في الفترة المحددة</span>
                            <span class="fw-bold text-primary">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="avatar-text avatar-lg bg-soft-success text-success">
                            <i class="feather-check-circle"></i>
                        </div>
                        <div class="text-end">
                            <h2 class="fw-bold mb-1">@Model.ActiveCertificates</h2>
                            <p class="text-muted mb-0">شهادات صالحة</p>
                        </div>
                    </div>
                    <div class="pt-3 mt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">نسبة الصلاحية</span>
                            <span class="fw-bold text-success">
                                @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.ActiveCertificates / Model.TotalCertificates * 100, 1) : 0)%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="avatar-text avatar-lg bg-soft-danger text-danger">
                            <i class="feather-x-circle"></i>
                        </div>
                        <div class="text-end">
                            <h2 class="fw-bold mb-1">@Model.RevokedCertificates</h2>
                            <p class="text-muted mb-0">شهادات ملغاة</p>
                        </div>
                    </div>
                    <div class="pt-3 mt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">نسبة الإلغاء</span>
                            <span class="fw-bold text-danger">
                                @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.RevokedCertificates / Model.TotalCertificates * 100, 1) : 0)%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="avatar-text avatar-lg bg-soft-info text-info">
                            <i class="feather-eye"></i>
                        </div>
                        <div class="text-end">
                            <h2 class="fw-bold mb-1">@Model.VerificationAttempts</h2>
                            <p class="text-muted mb-0">محاولات التحقق</p>
                        </div>
                    </div>
                    <div class="pt-3 mt-3 border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">متوسط لكل شهادة</span>
                            <span class="fw-bold text-info">
                                @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.VerificationAttempts / Model.TotalCertificates, 1) : 0)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mt-4">
        <!-- Certificates Trend -->
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("اتجاه إصدار الشهادات", "Certificate issuance trend")</h5>
                </div>
                <div class="card-body">
                    <canvas id="certificatesTrendChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="col-lg-4">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("توزيع حالات الشهادات", "Certificate status distribution")</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusDistributionChart"></canvas>
                    
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2"></span>
                                <span class="text-muted">صالحة</span>
                            </div>
                            <span class="fw-bold">@Model.ActiveCertificates</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-danger me-2"></span>
                                <span class="text-muted">ملغاة</span>
                            </div>
                            <span class="fw-bold">@Model.RevokedCertificates</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Courses -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("أكثر الدورات إصداراً للشهادات", "Top courses by certificates issued")</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>@Html.T("الدورة", "Course")</th>
                                    <th class="text-center">@Html.T("عدد الشهادات", "Certificates")</th>
                                    <th class="text-center">@Html.T("النسبة", "Share")</th>
                                    <th class="text-center">@Html.T("الاتجاه", "Trend")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.CertificatesByCourse != null && Model.CertificatesByCourse.Any())
                                {
                                    var rank = 1;
                                    foreach (var course in Model.CertificatesByCourse)
                                    {
                                        var percentage = Model.TotalCertificates > 0 
                                            ? Math.Round((decimal)course.Count / Model.TotalCertificates * 100, 1) 
                                            : 0;
                                        
                                        <tr>
                                            <td>
                                                <div class="avatar-text avatar-sm @(rank == 1 ? "bg-warning text-white" : rank == 2 ? "bg-soft-warning text-warning" : "bg-soft-secondary text-secondary")">
                                                    @rank
                                                </div>
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Details", "Courses", new { id = course.CourseId })" class="fw-semibold">
                                                    @course.CourseName
                                                </a>
                                            </td>
                                            <td class="text-center">
                                                <span class="fw-bold">@course.Count</span>
                                            </td>
                                            <td class="text-center">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-primary" style="width: @percentage%"></div>
                                                </div>
                                                <span class="small text-muted">@percentage%</span>
                                            </td>
                                            <td class="text-center">
                                                @if (rank <= 3)
                                                {
                                                    <i class="feather-trending-up text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="feather-minus text-muted"></i>
                                                }
                                            </td>
                                        </tr>
                                        rank++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="feather-info me-2"></i>
                                            لا توجد بيانات في الفترة المحددة
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Distribution -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("توزيع الشهادات اليومي", "Daily certificate distribution")</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyDistributionChart" height="60"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("ملخص شامل", "Overall summary")</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="avatar-text avatar-md bg-soft-primary text-primary mx-auto mb-2">
                                    <i class="feather-award"></i>
                                </div>
                                <h5 class="fw-bold mb-1">@Model.TotalCertificates</h5>
                                <p class="text-muted small mb-0">إجمالي الشهادات</p>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="avatar-text avatar-md bg-soft-success text-success mx-auto mb-2">
                                    <i class="feather-check"></i>
                                </div>
                                <h5 class="fw-bold mb-1">@Model.ActiveCertificates</h5>
                                <p class="text-muted small mb-0">صالحة</p>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="avatar-text avatar-md bg-soft-danger text-danger mx-auto mb-2">
                                    <i class="feather-x"></i>
                                </div>
                                <h5 class="fw-bold mb-1">@Model.RevokedCertificates</h5>
                                <p class="text-muted small mb-0">ملغاة</p>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="avatar-text avatar-md bg-soft-info text-info mx-auto mb-2">
                                    <i class="feather-eye"></i>
                                </div>
                                <h5 class="fw-bold mb-1">@Model.VerificationAttempts</h5>
                                <p class="text-muted small mb-0">محاولات التحقق</p>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td class="fw-semibold">معدل الإصدار اليومي</td>
                                    <td class="text-end">
                                        @if (Model.FromDate.HasValue && Model.ToDate.HasValue)
                                        {
                                            var days = (Model.ToDate.Value - Model.FromDate.Value).Days + 1;
                                            var dailyAvg = days > 0 ? Math.Round((decimal)Model.TotalCertificates / days, 1) : 0;
                                            @dailyAvg
                                            @: شهادة/يوم
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">معدل التحقق لكل شهادة</td>
                                    <td class="text-end">
                                        @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.VerificationAttempts / Model.TotalCertificates, 1) : 0) مرة
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">معدل الإلغاء</td>
                                    <td class="text-end">
                                        @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.RevokedCertificates / Model.TotalCertificates * 100, 1) : 0)%
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">معدل الصلاحية</td>
                                    <td class="text-end text-success">
                                        @(Model.TotalCertificates > 0 ? Math.Round((decimal)Model.ActiveCertificates / Model.TotalCertificates * 100, 1) : 0)%
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Certificates Trend Chart
        var trendCtx = document.getElementById('certificatesTrendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.CertificatesByDay.Select(d => $"'{d.Date.ToString("dd/MM")}'")))],
                datasets: [{
                    label: 'شهادات صادرة',
                    data: [@Html.Raw(string.Join(",", Model.CertificatesByDay.Select(d => d.Count)))],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Status Distribution Chart
        var statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['صالحة', 'ملغاة'],
                datasets: [{
                    data: [@Model.ActiveCertificates, @Model.RevokedCertificates],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Daily Distribution Chart
        var dailyCtx = document.getElementById('dailyDistributionChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.CertificatesByDay.Select(d => $"'{d.Date.ToString("dd/MM")}'")))],
                datasets: [{
                    label: 'الشهادات',
                    data: [@Html.Raw(string.Join(",", Model.CertificatesByDay.Select(d => d.Count)))],
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    </script>
}

