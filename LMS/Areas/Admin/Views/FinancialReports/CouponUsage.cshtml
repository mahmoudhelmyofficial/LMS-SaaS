@model LMS.Services.CouponUsageReport
@{
    ViewData["Title"] = Html.T("تقرير استخدام الكوبونات", "Coupon usage report");
    ViewData["ActiveMenu"] = "FinancialReports";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <nav aria-label="@Html.T("مسار التنقل", "Breadcrumb")">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a asp-action="Index">@Html.T("التقارير المالية", "Financial Reports")</a></li>
                            <li class="breadcrumb-item active">@Html.T("استخدام الكوبونات", "Coupon Usage")</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-tags text-primary me-2"></i>
                        @Html.T("تقرير استخدام الكوبونات", "Coupon Usage Report")
                    </h1>
                </div>
                <a asp-controller="Coupons" asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    @Html.T("إنشاء كوبون جديد", "Create New Coupon")
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body">
                    <h6 class="text-white-50 mb-2">@Html.T("إجمالي الخصومات", "Total Discounts")</h6>
                    <h3 class="mb-0">@Model.TotalDiscountAmount.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                    <small>@Html.T("من", "From") @Model.TotalUsages @Html.T("استخدام", "usage(s)")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Html.T("الكوبونات النشطة", "Active Coupons")</h6>
                    <h3 class="text-success mb-0">@Model.ActiveCouponsCount</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Html.T("متوسط قيمة الخصم", "Average Discount Value")</h6>
                    <h3 class="text-info mb-0">@Model.AverageDiscountValue.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">@Html.T("نسبة التحويل", "Conversion Rate")</h6>
                    <h3 class="text-warning mb-0">@Model.ConversionRate.ToString("F1")%</h3>
                    <small class="text-muted">@Html.T("من المشاهدة للشراء", "View to purchase")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Usage Over Time Chart -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        @Html.T("استخدام الكوبونات عبر الوقت", "Coupon Usage Over Time")
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="usageChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Coupons -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy text-warning me-2"></i>
                        @Html.T("الكوبونات الأكثر استخداماً", "Top Used Coupons")
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @foreach (var coupon in Model.TopCoupons.Take(5))
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <code class="fw-bold text-primary">@coupon.Code</code>
                                    <div class="small text-muted">
                                        @(coupon.DiscountType == "Percentage" 
                                            ? $"{coupon.DiscountValue}% " + Html.T("خصم", "discount") 
                                            : $"{coupon.DiscountValue} " + Html.T("ج.م", "EGP") + " " + Html.T("خصم", "discount"))
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">@coupon.UsageCount @Html.T("استخدام", "use(s)")</span>
                                    <div class="small text-muted">@coupon.TotalDiscount.ToString("N0") @Html.T("ج.م", "EGP")</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Coupons Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent">
            <h5 class="mb-0">
                <i class="fas fa-list text-primary me-2"></i>
                @Html.T("جميع الكوبونات", "All Coupons")
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>@Html.T("الكوبون", "Coupon")</th>
                            <th>@Html.T("نوع الخصم", "Discount Type")</th>
                            <th class="text-center">@Html.T("الاستخدامات", "Usages")</th>
                            <th class="text-end">@Html.T("إجمالي الخصم", "Total Discount")</th>
                            <th class="text-end">@Html.T("الإيرادات المولدة", "Revenue Generated")</th>
                            <th class="text-center">@Html.T("الحالة", "Status")</th>
                            <th class="text-end">@Html.T("تاريخ الانتهاء", "Expiry Date")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var coupon in Model.CouponsData.OrderByDescending(c => c.UsageCount))
                        {
                            var isExpired = coupon.ValidTo < DateTime.UtcNow;
                            var isExhausted = coupon.MaxUses.HasValue && coupon.UsageCount >= coupon.MaxUses;
                            
                            <tr class="@(isExpired || isExhausted ? "table-secondary" : "")">
                                <td>
                                    <code class="fw-bold fs-6 @(coupon.IsActive ? "text-primary" : "text-muted")">
                                        @coupon.Code
                                    </code>
                                    @if (!string.IsNullOrEmpty(coupon.Description))
                                    {
                                        <div class="small text-muted text-truncate" style="max-width: 200px;">
                                            @coupon.Description
                                        </div>
                                    }
                                </td>
                                <td>
                                    @if (coupon.DiscountType == "Percentage")
                                    {
                                        <span class="badge bg-info">@coupon.DiscountValue% @Html.T("نسبة", "percentage")</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@coupon.DiscountValue @Html.T("ج.م ثابت", "EGP fixed")</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <span class="fw-bold">@coupon.UsageCount</span>
                                        @if (coupon.MaxUses.HasValue)
                                        {
                                            <span class="text-muted">/ @coupon.MaxUses</span>
                                            <div class="progress" style="width: 40px; height: 6px;">
                                                <div class="progress-bar @(isExhausted ? "bg-danger" : "bg-success")" 
                                                     style="width: @((coupon.UsageCount * 100.0 / coupon.MaxUses.Value))%"></div>
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td class="text-end text-danger">@coupon.TotalDiscount.ToString("N2") @Html.T("ج.م", "EGP")</td>
                                <td class="text-end text-success">@coupon.RevenueGenerated.ToString("N2") @Html.T("ج.م", "EGP")</td>
                                <td class="text-center">
                                    @if (isExpired)
                                    {
                                        <span class="badge bg-secondary">@Html.T("منتهي", "Expired")</span>
                                    }
                                    else if (isExhausted)
                                    {
                                        <span class="badge bg-warning text-dark">@Html.T("مستنفد", "Exhausted")</span>
                                    }
                                    else if (coupon.IsActive)
                                    {
                                        <span class="badge bg-success">@Html.T("نشط", "Active")</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@Html.T("معطل", "Disabled")</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <span class="@(isExpired ? "text-danger" : "")">
                                        @coupon.ValidTo.ToString("yyyy/MM/dd")
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    new Chart(document.getElementById('usageChart'), {
        type: 'line',
        data: {
            labels: [@Html.Raw(string.Join(",", Model.UsageOverTime.Select(u => $"'{u.Date:MM/dd}'")))],
            datasets: [
                {
                    label: '@Html.Raw(Html.T("عدد الاستخدامات", "Usage Count"))',
                    data: [@string.Join(",", Model.UsageOverTime.Select(u => u.UsageCount))],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '@Html.Raw(Html.T("قيمة الخصومات", "Discount Amount"))',
                    data: [@string.Join(",", Model.UsageOverTime.Select(u => u.DiscountAmount))],
                    borderColor: '#dc3545',
                    borderDash: [5, 5],
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: '@Html.Raw(Html.T("الاستخدامات", "Usages"))' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: '@Html.Raw(Html.T("قيمة الخصم (ج.م)", "Discount (EGP)"))' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
</script>
}

