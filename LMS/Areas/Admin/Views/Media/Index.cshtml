@model IEnumerable<LMS.Domain.Entities.Content.Media>

@{
    ViewData["Title"] = Html.T("مكتبة الوسائط", "Media library");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("المحتوى", "Content"), null),
        (Html.T("مكتبة الوسائط", "Media library"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    ViewData["ShowStats"] = true;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("رفع ملفات", "Upload files"), "feather-upload", "#uploadModal", "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@section Styles {
    <style>
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .media-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .media-item:hover {
            border-color: #3454d1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }
        .media-item.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .media-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            background: #f3f4f6;
        }
        .media-icon {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            font-size: 3rem;
        }
        .checkbox-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

@section StatsCards {
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                            <i class="feather-file"></i>
                        </div>
                        <div>
                            <span class="text-truncate-1-line">@Html.T("إجمالي الملفات", "Total files")</span>
                            <h3 class="fw-bolder d-block">@Model.Count().ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                            <i class="feather-image"></i>
                        </div>
                        <div>
                            <span class="text-truncate-1-line">@Html.T("صور", "Images")</span>
                            <h3 class="fw-bolder d-block">@Model.Count(m => m.FileType == "image").ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-warning text-warning">
                            <i class="feather-video"></i>
                        </div>
                        <div>
                            <span class="text-truncate-1-line">@Html.T("فيديوهات", "Videos")</span>
                            <h3 class="fw-bolder d-block">@Model.Count(m => m.FileType == "video").ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-info text-info">
                            <i class="feather-hard-drive"></i>
                        </div>
                        <div>
                            <span class="text-truncate-1-line">@Html.T("مساحة مستخدمة", "Storage used")</span>
                            <h3 class="fw-bolder d-block">0 GB</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <!-- Filter Tabs -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <ul class="nav nav-pills">
                            <li class="nav-item">
                                <a class="nav-link active" data-filter="all" href="#">@Html.T("الكل", "All")</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-filter="image" href="#">@Html.T("صور", "Images")</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-filter="video" href="#">@Html.T("فيديوهات", "Videos")</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-filter="document" href="#">@Html.T("مستندات", "Documents")</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-filter="audio" href="#">@Html.T("صوتيات", "Audio")</a>
                            </li>
                        </ul>
                        <div class="btn-group">
                            <button class="btn btn-light" id="gridView">
                                <i class="feather-grid"></i>
                            </button>
                            <button class="btn btn-light" id="listView">
                                <i class="feather-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Media Grid -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    @if (Model != null && Model.Any())
                    {
                        <div class="media-grid" id="mediaGrid">
                            @foreach (var media in Model.OrderByDescending(m => m.CreatedAt))
                            {
                                <div class="media-item" data-type="@media.FileType" data-id="@media.Id">
                                    <div class="checkbox-overlay">
                                        <input type="checkbox" class="form-check-input" />
                                    </div>
                                    @if (media.FileType == "image")
                                    {
                                        <img src="@media.FileUrl" alt="@media.FileName" class="media-thumbnail" />
                                    }
                                    else
                                    {
                                        <div class="media-icon">
                                            @switch (media.FileType)
                                            {
                                                case "video":
                                                    <i class="feather-video"></i>
                                                    break;
                                                case "audio":
                                                    <i class="feather-music"></i>
                                                    break;
                                                case "document":
                                                    <i class="feather-file-text"></i>
                                                    break;
                                                default:
                                                    <i class="feather-file"></i>
                                                    break;
                                            }
                                        </div>
                                    }
                                    <div class="mt-2">
                                        <p class="mb-1 small fw-semibold text-truncate">@media.FileName</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">@((media.FileSize / 1024.0 / 1024.0).ToString("F2")) MB</small>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">
                                                    <i class="feather-more-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item" href="@media.FileUrl" target="_blank">
                                                            <i class="feather-eye me-3"></i>
                                                            @Html.T("عرض", "View")
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="@media.FileUrl" download>
                                                            <i class="feather-download me-3"></i>
                                                            @Html.T("تحميل", "Download")
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="javascript:void(0)" onclick="copyUrl('@media.FileUrl')">
                                                            <i class="feather-copy me-3"></i>
                                                            @Html.T("نسخ الرابط", "Copy link")
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="confirmDelete('@media.Id')">
                                                            <i class="feather-trash-2 me-3"></i>
                                                            @Html.T("حذف", "Delete")
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="feather-image fs-1 text-muted mb-3"></i>
                            <h5>@Html.T("لا توجد ملفات بعد", "No files yet")</h5>
                            <p class="text-muted mb-4">@Html.T("ابدأ برفع الملفات إلى مكتبة الوسائط", "Start by uploading files to the media library")</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="feather-upload me-2"></i>
                                @Html.T("رفع ملفات", "Upload files")
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Html.T("رفع ملفات جديدة", "Upload new files")</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="border rounded p-5 text-center" id="dropZone">
                    <i class="feather-upload-cloud fs-1 text-primary mb-3"></i>
                    <h6>@Html.T("اسحب الملفات هنا أو انقر للاختيار", "Drag files here or click to select")</h6>
                    <input type="file" id="fileInput" multiple class="d-none" />
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                        @Html.T("اختيار ملفات", "Choose files")
                    </button>
                    <p class="text-muted small mt-3 mb-0">@Html.T("الحد الأقصى: 50 ميجابايت لكل ملف", "Max: 50 MB per file")</p>
                </div>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filter functionality
            $('.nav-pills a').on('click', function(e) {
                e.preventDefault();
                $('.nav-pills a').removeClass('active');
                $(this).addClass('active');
                
                var filter = $(this).data('filter');
                if (filter === 'all') {
                    $('.media-item').show();
                } else {
                    $('.media-item').hide();
                    $('.media-item[data-type="' + filter + '"]').show();
                }
            });

            // Media item selection
            $('.media-item').on('click', function(e) {
                if (!$(e.target).closest('.dropdown').length && !$(e.target).is('input[type="checkbox"]')) {
                    $(this).toggleClass('selected');
                    $(this).find('input[type="checkbox"]').prop('checked', $(this).hasClass('selected'));
                }
            });
        });

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(function() {
                alert('@Html.Raw(Html.T("تم نسخ الرابط", "Link copied").Replace("'", "\\'"))');
            });
        }

        function confirmDelete(mediaId) {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذا الملف؟", "Are you sure you want to delete this file?").Replace("'", "\\'"))')) {
                window.location.href = '@Url.Action("Delete", "Media")?id=' + mediaId;
            }
        }
    </script>
}

