@model LMS.Areas.Admin.ViewModels.AchievementEditViewModel

@{
    ViewData["Title"] = Html.T("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", "Edit achievement");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª", "Achievements"), Url.Action("Index", "Achievements")),
        (Html.T("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", "Edit Achievement"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <style>
        .note-editor.note-frame { direction: rtl; text-align: right; }
        .icon-picker { display: flex; flex-wrap: wrap; gap: 10px; max-height: 300px; overflow-y: auto; }
        .icon-item {
            width: 60px; height: 60px; border: 2px solid #dee2e6; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s; font-size: 24px;
        }
        .icon-item:hover, .icon-item.selected { border-color: #667eea; background: #f0f2ff; }
        .stats-card { background: var(--gradient-hero, linear-gradient(135deg, #004aad 0%, #0055c4 50%, #1a5cb9 100%)); color: white; border-radius: 10px; padding: 20px; }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row">
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-edit-2 me-2"></i>
                        ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                    </h5>
                    <div class="card-header-action">
                        <span class="badge bg-soft-info text-info">
                            <i class="feather-users me-1"></i>
                            @Model.UnlockedCount Ù…Ø³ØªØ®Ø¯Ù… Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="UnlockedCount" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="form-group mb-4">
                            <label asp-for="Title" class="form-label">@Html.T("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", "Achievement title") <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control form-control-lg" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label">@Html.T("Ø§Ù„ÙˆØµÙ", "Description") <span class="text-danger">*</span></label>
                            <textarea asp-for="Description" id="descriptionEditor" class="form-control" rows="5"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Type" class="form-label">@Html.T("Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", "Achievement type") <span class="text-danger">*</span></label>
                                    <select asp-for="Type" class="form-select">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                        <option value="CourseCompletion">Ø¥ØªÙ…Ø§Ù… Ø¯ÙˆØ±Ø©</option>
                                        <option value="PathCompletion">Ø¥ØªÙ…Ø§Ù… Ù…Ø³Ø§Ø±</option>
                                        <option value="QuizScore">Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø±</option>
                                        <option value="Engagement">Ù…Ø´Ø§Ø±ÙƒØ©</option>
                                        <option value="TimeSpent">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</option>
                                        <option value="Milestone">Ø¥Ù†Ø¬Ø§Ø² Ø±Ø¦ÙŠØ³ÙŠ</option>
                                        <option value="Special">Ø®Ø§Øµ</option>
                                    </select>
                                    <span asp-validation-for="Type" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Rarity" class="form-label">@Html.T("Ø§Ù„Ù†Ø¯Ø±Ø©", "Rarity") <span class="text-danger">*</span></label>
                                    <select asp-for="Rarity" class="form-select">
                                        <option value="Common">Ø´Ø§Ø¦Ø¹</option>
                                        <option value="Uncommon">ØºÙŠØ± Ø´Ø§Ø¦Ø¹</option>
                                        <option value="Rare">Ù†Ø§Ø¯Ø±</option>
                                        <option value="Epic">Ù…Ù„Ø­Ù…ÙŠ</option>
                                        <option value="Legendary">Ø£Ø³Ø·ÙˆØ±ÙŠ</option>
                                    </select>
                                    <span asp-validation-for="Rarity" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Points" class="form-label">@Html.T("Ø§Ù„Ù†Ù‚Ø§Ø·", "Points") <span class="text-danger">*</span></label>
                                    <input asp-for="Points" type="number" class="form-control" min="1" />
                                    <span asp-validation-for="Points" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="RequiredValue" class="form-label">@Html.T("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", "Required value")</label>
                                    <input asp-for="RequiredValue" type="number" class="form-control" min="0" />
                                    <span asp-validation-for="RequiredValue" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label">@Html.T("Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", "Achievement icon") <span class="text-danger">*</span></label>
                            <input type="hidden" asp-for="Icon" id="iconInput" />
                            <div class="icon-picker border rounded p-3">
                                <div class="icon-item" data-icon="ğŸ†">ğŸ†</div>
                                <div class="icon-item" data-icon="ğŸ–ï¸">ğŸ–ï¸</div>
                                <div class="icon-item" data-icon="ğŸ¥‡">ğŸ¥‡</div>
                                <div class="icon-item" data-icon="â­">â­</div>
                                <div class="icon-item" data-icon="ğŸ’">ğŸ’</div>
                                <div class="icon-item" data-icon="ğŸ‘‘">ğŸ‘‘</div>
                                <div class="icon-item" data-icon="ğŸ¯">ğŸ¯</div>
                                <div class="icon-item" data-icon="ğŸš€">ğŸš€</div>
                                <div class="icon-item" data-icon="ğŸ“š">ğŸ“š</div>
                                <div class="icon-item" data-icon="ğŸ“">ğŸ“</div>
                            </div>
                            <span asp-validation-for="Icon" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="BadgeImageFile" class="form-label">@Html.T("ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø±Ø©", "Badge image")</label>
                            @if (!string.IsNullOrEmpty(Model.CurrentBadgeUrl))
                            {
                                <div class="mb-2">
                                    <img src="@Model.CurrentBadgeUrl" alt="Current Badge" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
                                </div>
                            }
                            <input asp-for="BadgeImageFile" type="file" class="form-control" accept="image/*" />
                            <span asp-validation-for="BadgeImageFile" class="text-danger"></span>
                        </div>

                        <div class="card border mb-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3"><i class="feather-settings me-2"></i>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                            <label class="form-check-label"><i class="feather-check-circle me-2"></i>@Html.T("Ø¥Ù†Ø¬Ø§Ø² Ù†Ø´Ø·", "Active achievement")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsSecret" class="form-check-input" type="checkbox" />
                                            <label class="form-check-label"><i class="feather-eye-off me-2"></i>@Html.T("Ø¥Ù†Ø¬Ø§Ø² Ø³Ø±ÙŠ", "Secret achievement")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsRepeatable" class="form-check-input" type="checkbox" />
                                            <label class="form-check-label"><i class="feather-repeat me-2"></i>@Html.T("Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒØ±Ø§Ø±", "Repeatable")</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="ShowNotification" class="form-check-input" type="checkbox" />
                                            <label class="form-check-label"><i class="feather-bell me-2"></i>@Html.T("Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±", "Show notification")</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-between">
                            <div class="d-flex gap-2">
                                <a asp-action="Index" class="btn btn-light"><i class="feather-x me-2"></i>@Html.T("Ø¥Ù„ØºØ§Ø¡", "Cancel")</a>
                                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary"><i class="feather-eye me-2"></i>@Html.T("Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„", "View details")</a>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="feather-save me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card stretch stretch-full mb-4">
                <div class="card-body stats-card">
                    <h6 class="text-white mb-4"><i class="feather-bar-chart me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h6>
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="text-center">
                                <h2 class="text-white mb-1">@Model.UnlockedCount</h2>
                                <small class="text-white-50">Ù…Ø³ØªØ®Ø¯Ù… Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        $(document).ready(function() {
            $('#descriptionEditor').summernote({ height: 150, direction: 'rtl' });

            // Icon picker
            $('.icon-item').click(function() {
                $('.icon-item').removeClass('selected');
                $(this).addClass('selected');
                $('#iconInput').val($(this).data('icon'));
            });

            // Select current icon
            const currentIcon = $('#iconInput').val();
            $('.icon-item[data-icon="' + currentIcon + '"]').addClass('selected');

            // Unsaved changes warning
            let hasUnsavedChanges = false;
            $('form input, form select, form textarea').on('change', function() {
                hasUnsavedChanges = true;
            });
            $('form').on('submit', function() {
                hasUnsavedChanges = false;
            });
            $(window).on('beforeunload', function() {
                if (hasUnsavedChanges) return 'Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©.';
            });
        });
    </script>
}

