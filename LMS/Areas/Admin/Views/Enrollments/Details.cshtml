@model LMS.Domain.Entities.Learning.Enrollment

@{
    ViewData["Title"] = Html.T("تفاصيل التسجيل", "Enrollment details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التسجيلات", "Enrollments"), Url.Action("Index", "Enrollments")),
        (Html.T("تفاصيل التسجيل", "Enrollment details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <!-- Enrollment Status Card -->
        <div class="col-lg-12 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body text-center py-4">
                    @switch (Model.Status)
                    {
                        case LMS.Domain.Enums.EnrollmentStatus.Active:
                            <i class="feather-play-circle fs-1 text-success mb-3"></i>
                            <h4 class="mb-2">@Html.T("تسجيل نشط", "Active enrollment")</h4>
                            <p class="text-muted mb-3">@Html.T("الطالب مسجل ويمكنه الوصول للدورة", "Student is enrolled and can access the course")</p>
                            <span class="badge bg-soft-success text-success fs-6">@Html.T("نشط", "Active")</span>
                            break;
                        case LMS.Domain.Enums.EnrollmentStatus.Completed:
                            <i class="feather-check-circle fs-1 text-primary mb-3"></i>
                            <h4 class="mb-2">@Html.T("تسجيل مكتمل", "Completed enrollment")</h4>
                            <p class="text-muted mb-3">@Html.T("أكمل الطالب الدورة بنجاح", "Student completed the course successfully")</p>
                            <span class="badge bg-soft-primary text-primary fs-6">@Html.T("مكتمل", "Completed")</span>
                            break;
                        case LMS.Domain.Enums.EnrollmentStatus.Cancelled:
                            <i class="feather-x-circle fs-1 text-danger mb-3"></i>
                            <h4 class="mb-2">@Html.T("تسجيل ملغي", "Cancelled enrollment")</h4>
                            <p class="text-muted mb-3">@Html.T("تم إلغاء هذا التسجيل", "This enrollment was cancelled")</p>
                            <span class="badge bg-soft-danger text-danger fs-6">@Html.T("ملغي", "Cancelled")</span>
                            break;
                        case LMS.Domain.Enums.EnrollmentStatus.Suspended:
                            <i class="feather-pause-circle fs-1 text-warning mb-3"></i>
                            <h4 class="mb-2">@Html.T("تسجيل معلق", "Suspended enrollment")</h4>
                            <p class="text-muted mb-3">@Html.T("تم تعليق الوصول مؤقتاً", "Access has been temporarily suspended")</p>
                            <span class="badge bg-soft-warning text-warning fs-6">@Html.T("معلق", "Suspended")</span>
                            break;
                        default:
                            <i class="feather-info fs-1 text-secondary mb-3"></i>
                            <h4 class="mb-2">@Html.T("تسجيل", "Enrollment")</h4>
                            <span class="badge bg-soft-secondary text-secondary fs-6">@Model.Status</span>
                            break;
                    }
                </div>
            </div>
        </div>

        <!-- Main Info -->
        <div class="col-lg-8 mb-4">
            <!-- Student Info -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-user me-2"></i>@Html.T("معلومات الطالب", "Student information")
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Student != null)
                    {
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar-text avatar-xl bg-soft-primary text-primary">
                                @Model.Student.FirstName?.Substring(0, 1)
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1">@Model.Student.FirstName @Model.Student.LastName</h5>
                                <p class="text-muted mb-1">
                                    <i class="feather-mail me-1"></i>@Model.Student.Email
                                </p>
                                @if (!string.IsNullOrEmpty(Model.Student.PhoneNumber))
                                {
                                    <p class="text-muted mb-0">
                                        <i class="feather-phone me-1"></i>@Model.Student.PhoneNumber
                                    </p>
                                }
                            </div>
                            <div>
                                <a href="@Url.Action("Details", "Students", new { id = Model.StudentId })" class="btn btn-light-brand">
                                    <i class="feather-external-link me-1"></i>@Html.T("عرض الملف", "View profile")
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">@Html.T("بيانات الطالب غير متوفرة", "Student data not available")</p>
                    }
                </div>
            </div>

            <!-- Course Info -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-book me-2"></i>@Html.T("معلومات الدورة", "Course information")
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Course != null)
                    {
                        <div class="d-flex align-items-start gap-3">
                            <img src="@(Model.Course.ThumbnailUrl ?? "/assets/images/course-default.png")" 
                                 alt="@Model.Course.Title" 
                                 style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px;">
                            <div class="flex-grow-1">
                                <h5 class="mb-2">@Model.Course.Title</h5>
                                @if (Model.Course.Instructor != null)
                                {
                                    <p class="text-muted mb-1">
                                        <i class="feather-user me-1"></i>
                                        @Html.T("المدرب:", "Instructor:") @Model.Course.Instructor.FirstName @Model.Course.Instructor.LastName
                                    </p>
                                }
                                <p class="text-muted mb-0">
                                    <i class="feather-layers me-1"></i>
                                    @Model.TotalLessons @Html.T("درس", "lessons")
                                </p>
                            </div>
                            <div>
                                <a href="@Url.Action("Details", "Courses", new { id = Model.CourseId })" class="btn btn-light-brand">
                                    <i class="feather-external-link me-1"></i>@Html.T("عرض الدورة", "View course")
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">@Html.T("بيانات الدورة غير متوفرة", "Course data not available")</p>
                    }
                </div>
            </div>

            <!-- Progress -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-trending-up me-2"></i>@Html.T("تقدم الطالب", "Student progress")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3 text-center">
                                <h3 class="text-primary mb-1">@Model.ProgressPercentage.ToString("N0")%</h3>
                                <small class="text-muted">@Html.T("نسبة الإتمام", "Completion %")</small>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-primary" role="progressbar" 
                                         style="width: @Model.ProgressPercentage%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 text-center">
                                <h3 class="text-success mb-1">@Model.CompletedLessons / @Model.TotalLessons</h3>
                                <small class="text-muted">@Html.T("الدروس المكتملة", "Completed lessons")</small>
                            </div>
                        </div>
                        @if (Model.FinalGrade.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3 text-center">
                                    <h3 class="text-info mb-1">@Model.FinalGrade.Value.ToString("N1")%</h3>
                                    <small class="text-muted">@Html.T("الدرجة النهائية", "Final grade")</small>
                                </div>
                            </div>
                        }
                        <div class="col-md-6">
                            <div class="border rounded p-3 text-center">
                                <h3 class="text-warning mb-1">@Model.TotalTimeSpent.ToString(@"hh\:mm")</h3>
                                <small class="text-muted">@Html.T("الوقت المستغرق", "Time spent")</small>
                            </div>
                        </div>
                    </div>

                    @if (Model.LessonProgress != null && Model.LessonProgress.Any())
                    {
                        <hr class="my-4" />
                        <h6 class="mb-3">@Html.T("آخر الدروس", "Recent lessons")</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>@Html.T("الدرس", "Lesson")</th>
                                        <th>@Html.T("الحالة", "Status")</th>
                                        <th>@Html.T("آخر مشاهدة", "Last viewed")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var progress in Model.LessonProgress.OrderByDescending(p => p.LastAccessedAt).Take(5))
                                    {
                                        <tr>
                                            <td>@progress.Lesson?.Title</td>
                                            <td>
                                                @if (progress.IsCompleted)
                                                {
                                                    <span class="badge bg-soft-success text-success">@Html.T("مكتمل", "Completed")</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-soft-warning text-warning">@Html.T("جاري", "In progress")</span>
                                                }
                                            </td>
                                            <td>@progress.LastAccessedAt.ToString("dd/MM/yyyy")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Side Info -->
        <div class="col-lg-4">
            <!-- Enrollment Details -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>@Html.T("تفاصيل التسجيل", "Enrollment details")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("رقم التسجيل:", "Enrollment #:")</span>
                            <span class="fw-semibold">#@Model.Id.ToString("D6")</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("تاريخ التسجيل:", "Enrollment date:")</span>
                            <span class="fw-semibold">@Model.EnrolledAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        @if (Model.CompletedAt.HasValue)
                        {
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("تاريخ الإكمال:", "Completion date:")</span>
                                <span class="fw-semibold">@Model.CompletedAt.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                        @if (Model.ExpiresAt.HasValue)
                        {
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("تاريخ انتهاء الصلاحية:", "Expiry date:")</span>
                                <span class="fw-semibold @(Model.ExpiresAt.Value < DateTime.UtcNow ? "text-danger" : "")">
                                    @Model.ExpiresAt.Value.ToString("dd/MM/yyyy")
                                </span>
                            </div>
                        }
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("المبلغ المدفوع:", "Amount paid:")</span>
                            <span class="fw-semibold">
                                @if (Model.IsFree)
                                {
                                    <span class="text-success">@Html.T("مجاني", "Free")</span>
                                }
                                else
                                {
                                    @Model.PaidAmount.ToString("N2") @Model.Currency
                                }
                            </span>
                        </div>
                        @if (Model.CertificateIssued)
                        {
                            <div class="alert alert-success mb-0">
                                <i class="feather-award me-2"></i>
                                @Html.T("تم إصدار الشهادة", "Certificate issued")
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-settings me-2"></i>@Html.T("إجراءات", "Actions")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.Status == LMS.Domain.Enums.EnrollmentStatus.Active)
                        {
                            <form asp-action="ChangeStatus" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <input type="hidden" name="newStatus" value="@LMS.Domain.Enums.EnrollmentStatus.Completed" />
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="feather-check me-2"></i>
                                    @Html.T("وضع علامة مكتمل", "Mark as complete")
                                </button>
                            </form>
                            <form asp-action="ChangeStatus" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <input type="hidden" name="newStatus" value="@LMS.Domain.Enums.EnrollmentStatus.Suspended" />
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="feather-pause me-2"></i>
                                    @Html.T("تعليق التسجيل", "Suspend enrollment")
                                </button>
                            </form>
                        }
                        @if (Model.Status == LMS.Domain.Enums.EnrollmentStatus.Suspended)
                        {
                            <form asp-action="ChangeStatus" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <input type="hidden" name="newStatus" value="@LMS.Domain.Enums.EnrollmentStatus.Active" />
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="feather-play me-2"></i>
                                    @Html.T("تفعيل التسجيل", "Activate enrollment")
                                </button>
                            </form>
                        }
                        @if (Model.Status != LMS.Domain.Enums.EnrollmentStatus.Cancelled)
                        {
                            <hr />
                            <form asp-action="Cancel" method="post" onsubmit="return confirm('@Html.Raw(Html.T("هل أنت متأكد من إلغاء هذا التسجيل؟", "Are you sure you want to cancel this enrollment?").Replace("'", "\\'"))')">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="feather-x me-2"></i>
                                    @Html.T("إلغاء التسجيل", "Cancel enrollment")
                                </button>
                            </form>
                        }
                        @if (!Model.CertificateIssued && Model.Status == LMS.Domain.Enums.EnrollmentStatus.Completed && Model.Course?.HasCertificate == true)
                        {
                            <hr />
                            <form asp-controller="Certificates" asp-action="IssueManually" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="enrollmentId" value="@Model.Id" />
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="feather-award me-2"></i>
                                    @Html.T("إصدار الشهادة", "Issue certificate")
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

