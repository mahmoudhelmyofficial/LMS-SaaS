@model LMS.Domain.Entities.Payments.Coupon

@{
    ViewData["Title"] = Html.T("تفاصيل الكوبون", "Coupon details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإدارة المالية", "Financial"), null),
        (Html.T("الكوبونات", "Coupons"), Url.Action("Index", "Coupons")),
        (Html.T("تفاصيل الكوبون", "Coupon details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("تعديل", "Edit"), "feather-edit", Url.Action("Edit", "Coupons", new { id = Model.Id }), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@section Styles {
    <style>
        .coupon-hero {
            background: var(--gradient-hero, linear-gradient(135deg, #004aad 0%, #0055c4 50%, #1a5cb9 100%));
            color: white;
            padding: 60px 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .coupon-code-display {
            font-size: 3.5rem;
            font-weight: bold;
            letter-spacing: 8px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.2);
            padding: 20px 40px;
            border-radius: 15px;
            display: inline-block;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="coupon-hero">
        <div class="coupon-code-display">@Model.Code</div>
        <h2 class="text-white mt-4 mb-3">
            @if (Model.DiscountType == DiscountType.Percentage)
            {
                <span>خصم @Model.DiscountValue%</span>
            }
            else
            {
                <span>خصم @Model.DiscountValue جنيه</span>
            }
        </h2>
        <div class="d-flex gap-2 justify-content-center flex-wrap">
            @if (Model.Status == CouponStatus.Active)
            {
                <span class="badge bg-success fs-6">
                    <i class="feather-check-circle me-1"></i>نشط
                </span>
            }
            else if (Model.Status == CouponStatus.Expired)
            {
                <span class="badge bg-danger fs-6">
                    <i class="feather-clock me-1"></i>منتهي
                </span>
            }
            else
            {
                <span class="badge bg-secondary fs-6">@Html.T("غير نشط", "Inactive")</span>
            }
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="avatar-text bg-soft-primary text-primary avatar-xl mb-3 mx-auto">
                        <i class="feather-shopping-cart"></i>
                    </div>
                    <h3 class="fw-bold">@Model.UsedCount</h3>
                    <small class="text-muted">@Html.T("مرات الاستخدام", "Usage count")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="avatar-text bg-soft-success text-success avatar-xl mb-3 mx-auto">
                        <i class="feather-users"></i>
                    </div>
                    <h3 class="fw-bold">@Model.Usages.Select(u => u.UserId).Distinct().Count()</h3>
                    <small class="text-muted">@Html.T("مستخدمين", "Users")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="avatar-text bg-soft-warning text-warning avatar-xl mb-3 mx-auto">
                        <i class="feather-dollar-sign"></i>
                    </div>
                    <h3 class="fw-bold">@Model.Usages.Sum(u => u.DiscountAmount).ToString("N0")</h3>
                    <small class="text-muted">@Html.T("إجمالي الخصم", "Total discount")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="avatar-text bg-soft-info text-info avatar-xl mb-3 mx-auto">
                        <i class="feather-percent"></i>
                    </div>
                    <h3 class="fw-bold">
                        @if (Model.MaxUses.HasValue)
                        {
                            @(string.Format("{0:N0}", ((double)Model.UsedCount / Model.MaxUses.Value) * 100))
                        }
                        else
                        {
                            <span>∞</span>
                        }
                    </h3>
                    <small class="text-muted">@Html.T("نسبة الاستخدام", "Usage rate")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>معلومات الكوبون
                    </h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <p class="lead mb-4">@Model.Description</p>
                    }

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("نوع الخصم", "Discount type")</small>
                                <h6 class="mb-0">
                                    @if (Model.DiscountType == DiscountType.Percentage)
                                    {
                                        <span class="badge bg-soft-success text-success">@Html.T("نسبة مئوية", "Percentage")</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-primary text-primary">@Html.T("مبلغ ثابت", "Fixed amount")</span>
                                    }
                                </h6>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("قيمة الخصم", "Discount value")</small>
                                <h6 class="mb-0 text-primary">
                                    @if (Model.DiscountType == DiscountType.Percentage)
                                    {
                                        <span>@Model.DiscountValue%</span>
                                    }
                                    else
                                    {
                                        <span>@Model.DiscountValue @Model.Currency</span>
                                    }
                                </h6>
                            </div>
                        </div>
                        @if (Model.MinimumPurchaseAmount.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("الحد الأدنى للشراء", "Minimum purchase")</small>
                                    <h6 class="mb-0">@Model.MinimumPurchaseAmount @Model.Currency</h6>
                                </div>
                            </div>
                        }
                        @if (Model.MaxDiscountAmount.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("الحد الأقصى للخصم", "Maximum discount")</small>
                                    <h6 class="mb-0">@Model.MaxDiscountAmount @Model.Currency</h6>
                                </div>
                            </div>
                        }
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("صالح من", "Valid from")</small>
                                <h6 class="mb-0">@Model.ValidFrom.ToString("dd/MM/yyyy hh:mm tt")</h6>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("صالح حتى", "Valid until")</small>
                                <h6 class="mb-0">@Model.ValidTo.ToString("dd/MM/yyyy hh:mm tt")</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.Usages.Any())
            {
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-list me-2"></i>
                            سجل الاستخدام (@Model.Usages.Count)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>@Html.T("المستخدم", "User")</th>
                                        <th>@Html.T("الدورة", "Course")</th>
                                        <th>@Html.T("الخصم", "Discount")</th>
                                        <th>@Html.T("التاريخ", "Date")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var usage in Model.Usages.OrderByDescending(u => u.UsedAt).Take(10))
                                    {
                                        <tr>
                                            <td>
                                                @if (usage.User != null)
                                                {
                                                    <a asp-area="Admin" asp-controller="Students" asp-action="Details" asp-route-id="@usage.UserId">
                                                        @($"{usage.User.FirstName} {usage.User.LastName}")
                                                    </a>
                                                }
                                            </td>
                                            <td>
                                                @if (usage.Course != null)
                                                {
                                                    <span>@usage.Course.Title</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-soft-success text-success">
                                                    @usage.DiscountAmount جنيه
                                                </span>
                                            </td>
                                            <td>@usage.UsedAt.ToString("dd/MM/yyyy")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-activity me-2"></i>حالة الكوبون
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">الحالة:</span>
                            @switch (Model.Status)
                            {
                                case CouponStatus.Active:
                                    <span class="badge bg-soft-success text-success">@Html.T("نشط", "Active")</span>
                                    break;
                                case CouponStatus.Expired:
                                    <span class="badge bg-soft-danger text-danger">@Html.T("منتهي", "Expired")</span>
                                    break;
                                case CouponStatus.Inactive:
                                    <span class="badge bg-soft-secondary text-secondary">@Html.T("معطل", "Disabled")</span>
                                    break;
                                case CouponStatus.UsedUp:
                                    <span class="badge bg-soft-warning text-warning">مستخدم بالكامل</span>
                                    break;
                            }
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">الاستخدام:</span>
                            <span class="fw-semibold">@Model.UsedCount / @(Model.MaxUses?.ToString() ?? "∞")</span>
                        </div>
                        @if (Model.FirstPurchaseOnly)
                        {
                            <div class="alert alert-warning mb-0">
                                <i class="feather-alert-triangle me-2"></i>
                                <small>للمشتريات الأولى فقط</small>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-zap me-2"></i>@Html.T("إجراءات سريعة", "Quick actions")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-light-brand">
                            <i class="feather-edit me-2"></i>تعديل الكوبون
                        </a>
                        <form asp-action="ToggleStatus" asp-route-id="@Model.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-light-brand w-100">
                                @if (Model.IsActive)
                                {
                                    <i class="feather-eye-off me-2"></i>
                                    <span>@Html.T("تعطيل", "Disable")</span>
                                }
                                else
                                {
                                    <i class="feather-eye me-2"></i>
                                    <span>تفعيل</span>
                                }
                            </button>
                        </form>
                        <button type="button" class="btn btn-light-brand" onclick="copyCode()">
                            <i class="feather-copy me-2"></i>نسخ الكود
                        </button>
                        @if (Model.UsedCount == 0)
                        {
                            <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline w-100">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-danger w-100" onclick="return confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذا الكوبون؟ لا يمكن التراجع عن هذا الإجراء.", "Are you sure you want to delete this coupon? This action cannot be undone.").ToString().Replace("'", "\\'"))')">
                                    <i class="feather-trash-2 me-2"></i>حذف الكوبون
                                </button>
                            </form>
                        }
                        else
                        {
                            <button type="button" class="btn btn-secondary w-100" disabled title="@Html.T("لا يمكن حذف كوبون تم استخدامه", "Cannot delete a coupon that has been used")">
                                <i class="feather-trash-2 me-2"></i>حذف الكوبون
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function copyCode() {
            navigator.clipboard.writeText('@Model.Code').then(function() {
                toastr.success('تم نسخ الكود: @Model.Code');
            }).catch(function() {
                // Fallback for older browsers
                var textArea = document.createElement("textarea");
                textArea.value = '@Model.Code';
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    toastr.success('تم نسخ الكود: @Model.Code');
                } catch (err) {
                    toastr.error('فشل نسخ الكود');
                }
                document.body.removeChild(textArea);
            });
        }
    </script>
}

