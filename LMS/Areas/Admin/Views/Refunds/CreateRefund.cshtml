@{
    ViewData["Title"] = Html.T("إنشاء طلب استرداد", "Create refund request");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإدارة المالية", "Financial"), null),
        (Html.T("الاسترداد", "Refunds"), Url.Action("Index", "Refunds")),
        (Html.T("طلب جديد", "New request"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    
    var payment = ViewBag.Payment as LMS.Domain.Entities.Payments.Payment;
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-rotate-ccw me-2 text-warning"></i>
                        @Html.T("إنشاء طلب استرداد", "Create refund request")
                    </h5>
                </div>
                <div class="card-body">
                    @if (payment != null)
                    {
                        <!-- Payment Info -->
                        <div class="alert alert-light border mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>رقم الدفعة:</strong> #@payment.Id</p>
                                    <p class="mb-1"><strong>الطالب:</strong> @payment.Student?.FirstName @payment.Student?.LastName</p>
                                    <p class="mb-0"><strong>البريد:</strong> @payment.Student?.Email</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>الدورة:</strong> @(payment.Course?.Title ?? "غير متاح")</p>
                                    <p class="mb-1"><strong>تاريخ الدفع:</strong> @payment.CreatedAt.ToString("dd/MM/yyyy")</p>
                                    <p class="mb-0"><strong>المبلغ المدفوع:</strong> <span class="text-success fw-bold">@payment.TotalAmount.ToString("N2") @payment.Currency</span></p>
                                </div>
                            </div>
                        </div>

                        <form asp-action="CreateRefund" method="post">
                            <input type="hidden" name="paymentId" value="@payment.Id" />
                            
                            <div class="mb-4">
                                <label class="form-label">نوع الاسترداد</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="refundType" id="fullRefund" value="full" checked onclick="togglePartialAmount(false)">
                                    <label class="form-check-label" for="fullRefund">
                                        استرداد كامل - @payment.TotalAmount.ToString("N2") @payment.Currency
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="refundType" id="partialRefund" value="partial" onclick="togglePartialAmount(true)">
                                    <label class="form-check-label" for="partialRefund">
                                        استرداد جزئي
                                    </label>
                                </div>
                            </div>

                            <div class="mb-4" id="partialAmountDiv" style="display: none;">
                                <label class="form-label">@Html.T("مبلغ الاسترداد الجزئي", "Partial refund amount")</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="partialAmount" id="partialAmount" 
                                           min="0.01" max="@payment.TotalAmount" step="0.01" 
                                           placeholder="@Html.T("أدخل المبلغ", "Enter amount")">
                                    <span class="input-group-text">@payment.Currency</span>
                                </div>
                                <small class="text-muted">@Html.T("الحد الأقصى:", "Maximum:") @payment.TotalAmount.ToString("N2") @payment.Currency</small>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">@Html.T("سبب الاسترداد", "Refund reason") <span class="text-danger">*</span></label>
                                <textarea class="form-control" name="reason" rows="4" required
                                          placeholder="@Html.T("يرجى إدخال سبب طلب الاسترداد بالتفصيل...", "Please enter the refund reason in detail...")"></textarea>
                            </div>

                            <div class="alert alert-warning">
                                <i class="feather-alert-triangle me-2"></i>
                                <strong>@Html.T("تنبيه:", "Warning:")</strong> @Html.T("بعد إنشاء طلب الاسترداد، سيتم توجيهك لصفحة المعالجة للموافقة أو الرفض.", "After creating the refund request, you will be directed to the processing page to approve or reject.")
                            </div>

                            <div class="d-flex gap-2 justify-content-end">
                                <a href="@Url.Action("Details", "Payments", new { id = payment.Id })" class="btn btn-light">
                                    <i class="feather-arrow-right me-2"></i>
                                    إلغاء
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="feather-rotate-ccw me-2"></i>
                                    إنشاء طلب الاسترداد
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <i class="feather-alert-circle me-2"></i>
                            لم يتم العثور على بيانات الدفعة
                        </div>
                        <a href="@Url.Action("Index", "Payments")" class="btn btn-primary">
                            العودة للمدفوعات
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function togglePartialAmount(show) {
        var div = document.getElementById('partialAmountDiv');
        var input = document.getElementById('partialAmount');
        if (show) {
            div.style.display = 'block';
            input.required = true;
        } else {
            div.style.display = 'none';
            input.required = false;
            input.value = '';
        }
    }
</script>
}
