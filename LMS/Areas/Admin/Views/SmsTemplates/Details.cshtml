@model LMS.Domain.Entities.Notifications.SmsTemplate

@{
    ViewData["Title"] = Html.T("تفاصيل قالب الرسالة النصية", "SMS Template Details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("قوالب الرسائل النصية", "SMS Templates"), Url.Action("Index", "SmsTemplates")),
        (Html.T("تفاصيل القالب", "Template Details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .info-row {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .sms-preview-box {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            min-height: 150px;
        }
        .variable-badge {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            font-size: 0.85rem;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <!-- Template Details -->
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">معلومات القالب</h5>
                    <div class="card-header-action">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="feather-edit me-2"></i>
                            تعديل
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">رقم القالب:</span>
                            </div>
                            <div class="col-md-9">
                                <span class="fw-bold">#@Model.Id</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">اسم القالب:</span>
                            </div>
                            <div class="col-md-9">
                                <span class="fw-bold">@Model.TemplateName</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">مفتاح القالب:</span>
                            </div>
                            <div class="col-md-9">
                                <code class="bg-light p-2 rounded">@Model.TemplateKey</code>
                            </div>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">@Html.T("اللغة:", "Language:")</span>
                            </div>
                            <div class="col-md-9">
                                <span class="badge bg-soft-info text-info">
                                    @(Model.Language switch
                                    {
                                        "ar" => Html.T("العربية", "Arabic"),
                                        "en" => Html.T("الإنجليزية", "English"),
                                        "ar-en" => Html.T("ثنائية اللغة", "Bilingual"),
                                        _ => Model.Language
                                    })
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">الحالة:</span>
                            </div>
                            <div class="col-md-9">
                                @if (Model.IsActive)
                                {
                                    <span class="badge bg-soft-success text-success">
                                        <i class="feather-check-circle me-1"></i>
                                        نشط
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-soft-secondary text-secondary">
                                        <i class="feather-pause-circle me-1"></i>
                                        معطل
                                    </span>
                                }
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="info-row">
                            <div class="row">
                                <div class="col-md-3">
                                    <span class="text-muted">الوصف:</span>
                                </div>
                                <div class="col-md-9">
                                    <p class="mb-0">@Model.Description</p>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="info-row">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="text-muted">تاريخ الإنشاء:</span>
                            </div>
                            <div class="col-md-9">
                                <span>@Model.CreatedAt.ToString("dd/MM/yyyy hh:mm tt")</span>
                            </div>
                        </div>
                    </div>

                    @if (Model.UpdatedAt.HasValue)
                    {
                        <div class="info-row">
                            <div class="row">
                                <div class="col-md-3">
                                    <span class="text-muted">آخر تحديث:</span>
                                </div>
                                <div class="col-md-9">
                                    <span>@Model.UpdatedAt.Value.ToString("dd/MM/yyyy hh:mm tt")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Message Content -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">محتوى الرسالة</h5>
                    <div class="card-header-action">
                        <span class="badge bg-soft-primary text-primary">
                            @Model.MessageContent.Length حرف
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="sms-preview-box">
                        <div class="d-flex align-items-start gap-2 mb-3">
                            <i class="feather-smartphone text-primary fs-4"></i>
                            <div>
                                <strong>رسالة نصية (SMS)</strong>
                                <br>
                                <small class="text-muted">معاينة الرسالة</small>
                            </div>
                        </div>
                        <p class="mb-0">@Model.MessageContent</p>
                    </div>

                    <!-- Extracted Variables -->
                    @{
                        var variables = System.Text.RegularExpressions.Regex.Matches(Model.MessageContent, @"\{([^}]+)\}")
                            .Cast<System.Text.RegularExpressions.Match>()
                            .Select(m => m.Groups[1].Value)
                            .Distinct()
                            .ToList();
                    }

                    @if (variables.Any())
                    {
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3">المتغيرات المستخدمة:</h6>
                            <div>
                                @foreach (var variable in variables)
                                {
                                    <span class="variable-badge">@variable</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Usage Statistics -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">إحصائيات الاستخدام</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="p-3 border rounded text-center">
                                <div class="avatar-text bg-soft-primary text-primary mx-auto mb-2">
                                    <i class="feather-send"></i>
                                </div>
                                <h5 class="fw-bold mb-1">0</h5>
                                <small class="text-muted">رسائل مرسلة</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded text-center">
                                <div class="avatar-text bg-soft-success text-success mx-auto mb-2">
                                    <i class="feather-check"></i>
                                </div>
                                <h5 class="fw-bold mb-1">0</h5>
                                <small class="text-muted">تم التسليم</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded text-center">
                                <div class="avatar-text bg-soft-danger text-danger mx-auto mb-2">
                                    <i class="feather-x"></i>
                                </div>
                                <h5 class="fw-bold mb-1">0</h5>
                                <small class="text-muted">فشل</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Sidebar -->
        <div class="col-lg-4">
            <div class="card stretch stretch-full sticky-top" style="top: 100px;">
                <div class="card-header">
                    <h5 class="card-title">الإجراءات</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                            <i class="feather-edit me-2"></i>
                            تعديل القالب
                        </a>
                        
                        <button type="button" class="btn btn-secondary" onclick="testTemplate()">
                            <i class="feather-send me-2"></i>
                            إرسال رسالة تجريبية
                        </button>

                        @if (Model.IsActive)
                        {
                            <form asp-action="ToggleStatus" asp-route-id="@Model.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="feather-pause me-2"></i>
                                    تعطيل القالب
                                </button>
                            </form>
                        }
                        else
                        {
                            <form asp-action="ToggleStatus" asp-route-id="@Model.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="feather-play me-2"></i>
                                    تفعيل القالب
                                </button>
                            </form>
                        }

                        <button type="button" class="btn btn-info" onclick="duplicateTemplate()">
                            <i class="feather-copy me-2"></i>
                            @Html.T("نسخ القالب", "Copy template")
                        </button>

                        <hr>

                        <form asp-action="Delete" asp-route-id="@Model.Id" method="post" onsubmit="return confirm(window.__SmsDetailsT.deleteConfirm);">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="feather-trash-2 me-2"></i>
                                @Html.T("حذف القالب", "Delete template")
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Quick Info Card -->
            <div class="card stretch stretch-full mt-3">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات سريعة", "Quick info")</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="feather-info me-2"></i>
                        <small>
                            @Html.T("هذا القالب يستخدم في إرسال الرسائل النصية التلقائية للمستخدمين عند حدوث أحداث معينة في النظام.", "This template is used to send automatic SMS to users when certain system events occur.")
                        </small>
                    </div>

                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="feather-check text-success me-2"></i>
                            <small>@Html.T("الحد الأقصى: 320 حرف", "Max: 320 characters")</small>
                        </li>
                        <li class="mb-2">
                            <i class="feather-check text-success me-2"></i>
                            <small>@Html.T("دعم المتغيرات الديناميكية", "Dynamic variables support")</small>
                        </li>
                        <li class="mb-0">
                            <i class="feather-check text-success me-2"></i>
                            <small>@Html.T("دعم الأحرف العربية", "Arabic characters support")</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__SmsDetailsT = { promptPhone: '@Html.Raw(Html.T("أدخل رقم الهاتف لإرسال رسالة تجريبية:", "Enter phone number to send test message:").Replace("'", "\\'"))', success: '@Html.Raw(Html.T("تم إرسال الرسالة التجريبية بنجاح!", "Test message sent successfully!").Replace("'", "\\'"))', errorLabel: '@Html.Raw(Html.T("حدث خطأ:", "Error:").Replace("'", "\\'"))', sendError: '@Html.Raw(Html.T("حدث خطأ أثناء إرسال الرسالة", "Error sending message").Replace("'", "\\'"))', confirmCopy: '@Html.Raw(Html.T("هل تريد نسخ هذا القالب؟", "Do you want to copy this template?").Replace("'", "\\'"))', deleteConfirm: '@Html.Raw(Html.T("هل أنت متأكد من حذف هذا القالب؟", "Are you sure you want to delete this template?").Replace("'", "\\'"))' };
        function testTemplate() {
            const phone = prompt(window.__SmsDetailsT.promptPhone);
            if (phone) {
                // AJAX call to send test SMS
                fetch(`/Admin/SmsTemplates/SendTest?id=@Model.Id&phone=${phone}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(window.__SmsDetailsT.success);
                    } else {
                        alert(window.__SmsDetailsT.errorLabel + ' ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(window.__SmsDetailsT.sendError);
                });
            }
        }

        function duplicateTemplate() {
            if (confirm(window.__SmsDetailsT.confirmCopy)) {
                window.location.href = `/Admin/SmsTemplates/Duplicate?id=@Model.Id`;
            }
        }
    </script>
}

