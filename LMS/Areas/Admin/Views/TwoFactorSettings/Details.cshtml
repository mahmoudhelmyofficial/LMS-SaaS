@model LMS.Domain.Entities.Security.TwoFactorSetting

@{
    ViewData["Title"] = Html.T("تفاصيل المصادقة الثنائية", "Two-factor details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("لوحة التحكم", "Dashboard"), Url.Action("Index", "Dashboard")),
        (Html.T("الأمان", "Security"), Url.Action("Dashboard", "Security")),
        (Html.T("المصادقة الثنائية", "Two-Factor Authentication"), Url.Action("Index", "TwoFactorSettings")),
        (Html.T("التفاصيل", "Details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .info-box {
            padding: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .info-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <!-- Status Card -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card @(Model.IsEnabled ? "border-success" : "border-warning")">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-text avatar-xl @(Model.IsEnabled ? "bg-soft-success text-success" : "bg-soft-warning text-warning")">
                                    <i class="feather-shield"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1">@Html.T("المصادقة الثنائية", "Two-factor authentication") @(Model.IsEnabled ? Html.T("مفعلة", "Enabled") : Html.T("معطلة", "Disabled"))</h4>
                                    <p class="text-muted mb-0">
                                        <i class="feather-user me-2"></i>
                                        @Model.User?.FirstName @Model.User?.LastName
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 text-end">
                            @if (Model.IsEnabled)
                            {
                                <form asp-controller="Security" asp-action="DisableTwoFactor" asp-route-id="@Model.Id" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('@Html.Raw(Html.T("هل أنت متأكد من تعطيل المصادقة الثنائية?", "Are you sure you want to disable two-factor authentication?").Replace("'", "\\'"))')">
                                        <i class="feather-x-circle me-2"></i>
                                        @Html.T("تعطيل", "Disable")
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Info -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات المستخدم", "User information")</h5>
                </div>
                <div class="card-body">
                    @if (Model.User != null)
                    {
                        <div class="text-center mb-4">
                            <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-3">
                                @Model.User.FirstName?.Substring(0, 1)
                            </div>
                            <h5 class="mb-1">@Model.User.FirstName @Model.User.LastName</h5>
                            <p class="text-muted mb-0">@Model.User.Email</p>
                        </div>

                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted">@Html.T("رقم الهاتف:", "Phone:")</span>
                                <span class="fw-semibold">@(Model.User.PhoneNumber ?? Html.T("غير محدد", "Not set"))</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted">@Html.T("تاريخ التسجيل:", "Registration date:")</span>
                                <span>@Model.User.CreatedAt.ToString("dd/MM/yyyy")</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("رقم المستخدم:", "User ID:")</span>
                                <code>@Model.UserId</code>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("إعدادات المصادقة الثنائية", "Two-factor settings")</h5>
                </div>
                <div class="card-body">
                    <div class="info-box bg-soft-primary mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>@Html.T("طريقة المصادقة:", "Authentication method:")</span>
                            <span class="badge bg-primary">@Model.Method</span>
                        </div>
                    </div>

                    <div class="info-box bg-soft-success mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>@Html.T("الحالة:", "Status:")</span>
                            @if (Model.IsEnabled)
                            {
                                <span class="badge bg-success">
                                    <i class="feather-check-circle me-1"></i>
                                    @Html.T("مفعل", "Enabled")
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning">
                                    <i class="feather-alert-circle me-1"></i>
                                    @Html.T("معطل", "Disabled")
                                </span>
                            }
                        </div>
                    </div>

                    <div class="info-box bg-soft-info mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>@Html.T("تاريخ التفعيل:", "Enabled at:")</span>
                            <span>@Model.EnabledAt?.ToString("dd/MM/yyyy hh:mm tt") ?? "-"</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                    {
                        <div class="info-box bg-soft-warning">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>@Html.T("رقم الهاتف المسجل:", "Registered phone:")</span>
                                <span class="fw-bold">@Model.PhoneNumber</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Codes -->
    @if (Model.IsEnabled && !string.IsNullOrEmpty(Model.BackupCodes))
    {
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-key me-2"></i>
                            @Html.T("رموز النسخ الاحتياطي", "Backup codes")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="feather-info me-2"></i>
                            @Html.T("استخدم هذه الرموز في حالة فقدان الوصول لطريقة المصادقة الأساسية", "Use these codes if you lose access to your primary authentication method")
                        </div>
                        <div class="row g-2">
                            @{
                                var codes = Model.BackupCodes.Split(',');
                                foreach (var code in codes.Take(10))
                                {
                                    <div class="col-md-3">
                                        <div class="p-3 border rounded text-center">
                                            <code class="fs-5">@code</code>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Activity Log -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-activity me-2"></i>
                        @Html.T("سجل النشاط", "Activity log")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        @if (Model.EnabledAt.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-badge bg-success">
                                    <i class="feather-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6>@Html.T("تم تفعيل المصادقة الثنائية", "Two-factor authentication was enabled")</h6>
                                    <p class="text-muted mb-0">@Model.EnabledAt.Value.ToString("dd MMMM yyyy - hh:mm tt")</p>
                                </div>
                            </div>
                        }
                        @if (Model.LastUsedAt.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-badge bg-primary">
                                    <i class="feather-key"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6>@Html.T("آخر استخدام", "Last used")</h6>
                                    <p class="text-muted mb-0">@Model.LastUsedAt.Value.ToString("dd MMMM yyyy - hh:mm tt")</p>
                                </div>
                            </div>
                        }
                        <div class="timeline-item">
                            <div class="timeline-badge bg-info">
                                <i class="feather-clock"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>@Html.T("تاريخ الإنشاء", "Created")</h6>
                                <p class="text-muted mb-0">@Model.CreatedAt.ToString("dd MMMM yyyy - hh:mm tt")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("الإجراءات", "Actions")</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <a asp-controller="Users" asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-primary">
                            <i class="feather-user me-2"></i>
                            @Html.T("عرض ملف المستخدم", "View user profile")
                        </a>
                        <a asp-controller="TwoFactorSettings" asp-action="Index" class="btn btn-light-brand">
                            <i class="feather-arrow-right me-2"></i>
                            @Html.T("العودة للقائمة", "Back to list")
                        </a>
                        @if (Model.IsEnabled)
                        {
                            <button class="btn btn-warning" onclick="regenerateBackupCodes()">
                                <i class="feather-refresh-cw me-2"></i>
                                @Html.T("إعادة توليد رموز النسخ الاحتياطي", "Regenerate backup codes")
                            </button>
                        }
                        <button class="btn btn-light" onclick="window.print()">
                            <i class="feather-printer me-2"></i>
                            @Html.T("طباعة", "Print")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function regenerateBackupCodes() {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من إعادة توليد رموز النسخ الاحتياطي? سيتم إبطال الرموز الحالية.", "Are you sure you want to regenerate backup codes? Current codes will be invalidated.").Replace("'", "\\'"))')) {
                alert('@Html.Raw(Html.T("وظيفة قيد التطوير", "Feature under development").Replace("'", "\\'"))');
            }
        }
    </script>

    <style>
        .timeline {
            position: relative;
            padding: 20px 0 20px 40px;
        }
        .timeline:before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        .timeline-badge {
            position: absolute;
            left: -30px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }
        .timeline-content {
            padding-right: 20px;
        }
    </style>
}

