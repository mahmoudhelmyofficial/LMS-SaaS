@model LMS.Areas.Admin.ViewModels.NotificationTemplateViewModel

@{
    ViewData["Title"] = Html.T("إنشاء قالب إشعار", "Create notification template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإشعارات", "Notifications"), null),
        (Html.T("القوالب", "Templates"), Url.Action("Templates", "Notifications")),
        (Html.T("إنشاء قالب", "Create template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .variable-tag {
            display: inline-block;
            padding: 4px 12px;
            margin: 4px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .variable-tag:hover {
            background: #3454d1;
            color: white;
        }
        .template-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <form asp-action="CreateTemplate" method="post">
        @Html.AntiForgeryToken()
        <div class="row">
            <!-- Form Section -->
            <div class="col-lg-8">
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("معلومات القالب", "Template information")</h5>
                    </div>
                    <div class="card-body">
                        <!-- Template Name -->
                        <div class="mb-4">
                            <label class="form-label" for="name">@Html.T("اسم القالب", "Template name") <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" asp-for="Name" placeholder="@Html.T("مثال: قالب تأكيد التسجيل", "e.g. Registration confirmation template")" required>
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <!-- Event Type -->
                        <div class="mb-4">
                            <label class="form-label" for="eventType">@Html.T("نوع الحدث", "Event type") <span class="text-danger">*</span></label>
                            <select class="form-select" id="eventType" asp-for="EventType" required>
                                <option value="">-- @Html.T("اختر نوع الحدث", "Select event type") --</option>
                                <option value="UserRegistration">@Html.T("تسجيل مستخدم جديد", "New user registration")</option>
                                <option value="CourseEnrollment">@Html.T("التسجيل في دورة", "Course enrollment")</option>
                                <option value="CourseCompletion">@Html.T("إكمال دورة", "Course completion")</option>
                                <option value="PaymentSuccess">@Html.T("دفعة ناجحة", "Successful payment")</option>
                                <option value="PaymentFailed">@Html.T("دفعة فاشلة", "Failed payment")</option>
                                <option value="NewMessage">@Html.T("رسالة جديدة", "New message")</option>
                                <option value="CertificateIssued">@Html.T("صدور شهادة", "Certificate issued")</option>
                                <option value="RefundApproved">@Html.T("الموافقة على استرداد", "Refund approved")</option>
                                <option value="WithdrawalProcessed">@Html.T("معالجة سحب", "Withdrawal processed")</option>
                                <option value="SupportTicketReply">@Html.T("رد على تذكرة دعم", "Support ticket reply")</option>
                            </select>
                            <span asp-validation-for="EventType" class="text-danger"></span>
                        </div>

                        <!-- Title -->
                        <div class="mb-4">
                            <label class="form-label" for="title">@Html.T("عنوان الإشعار", "Notification title") <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" asp-for="Title" placeholder="@Html.T("عنوان الإشعار الذي سيراه المستخدم", "Notification title that the user will see")" required>
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <small class="text-muted">@Html.T("يمكنك استخدام المتغيرات مثل: {UserName}, {CourseName}", "You can use variables like: {UserName}, {CourseName}")</small>
                        </div>

                        <!-- Content -->
                        <div class="mb-4">
                            <label class="form-label" for="content">@Html.T("محتوى الإشعار", "Notification content") <span class="text-danger">*</span></label>
                            <textarea class="form-control template-editor" id="content" asp-for="Content" rows="8" placeholder="@Html.T("اكتب محتوى القالب هنا...", "Write the template content here...")" required></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                            <small class="text-muted">@Html.T("استخدم المتغيرات في النص للتخصيص التلقائي", "Use variables in the text for automatic personalization")</small>
                        </div>

                        <!-- Is Active -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" asp-for="IsActive" checked>
                                <label class="form-check-label" for="isActive">
                                    @Html.T("تفعيل القالب", "Enable template")
                                </label>
                            </div>
                            <small class="text-muted">@Html.T("القوالب النشطة سيتم استخدامها تلقائياً عند وقوع الحدث المرتبط", "Active templates will be used automatically when the linked event occurs")</small>
                        </div>
                    </div>
                    <div class="card-footer text-end">
                        <a asp-action="Templates" class="btn btn-light me-2">
                            <i class="feather-x me-2"></i>@Html.T("إلغاء", "Cancel")
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="feather-save me-2"></i>@Html.T("حفظ القالب", "Save template")
                        </button>
                    </div>
                </div>
            </div>

            <!-- Helper Section -->
            <div class="col-lg-4">
                <div class="card stretch stretch-full sticky-top" style="top: 100px;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("المتغيرات المتاحة", "Available variables")</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">@Html.T("انقر على المتغير لنسخه", "Click on a variable to copy it")</p>
                        
                        <h6 class="fw-bold mb-3">@Html.T("متغيرات المستخدم:", "User variables:")</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{UserName}">{UserName}</span>
                            <span class="variable-tag" data-var="{UserEmail}">{UserEmail}</span>
                            <span class="variable-tag" data-var="{UserFirstName}">{UserFirstName}</span>
                            <span class="variable-tag" data-var="{UserLastName}">{UserLastName}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">@Html.T("متغيرات الدورة:", "Course variables:")</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{CourseName}">{CourseName}</span>
                            <span class="variable-tag" data-var="{CourseInstructor}">{CourseInstructor}</span>
                            <span class="variable-tag" data-var="{CoursePrice}">{CoursePrice}</span>
                            <span class="variable-tag" data-var="{CourseUrl}">{CourseUrl}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">@Html.T("متغيرات عامة:", "General variables:")</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{PlatformName}">{PlatformName}</span>
                            <span class="variable-tag" data-var="{Date}">{Date}</span>
                            <span class="variable-tag" data-var="{Time}">{Time}</span>
                            <span class="variable-tag" data-var="{SupportEmail}">{SupportEmail}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">@Html.T("متغيرات المدفوعات:", "Payment variables:")</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{Amount}">{Amount}</span>
                            <span class="variable-tag" data-var="{Currency}">{Currency}</span>
                            <span class="variable-tag" data-var="{TransactionId}">{TransactionId}</span>
                            <span class="variable-tag" data-var="{InvoiceUrl}">{InvoiceUrl}</span>
                        </div>

                        <div class="alert alert-info mt-4">
                            <i class="feather-info me-2"></i>
                            <small>
                                @Html.T("سيتم استبدال هذه المتغيرات تلقائياً بالقيم الفعلية عند إرسال الإشعار", "These variables will be automatically replaced with actual values when the notification is sent")
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Examples Card -->
                <div class="card stretch stretch-full mt-3">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("أمثلة", "Examples")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="fw-bold">@Html.T("مثال للعنوان:", "Example for title:")</h6>
                            <code class="d-block p-2 bg-light rounded">
                                مرحباً {UserFirstName}، تم تسجيلك بنجاح!
                            </code>
                        </div>

                        <div class="mb-3">
                            <h6 class="fw-bold">@Html.T("مثال للمحتوى:", "Example for content:")</h6>
                            <code class="d-block p-2 bg-light rounded">
                                عزيزي {UserName}،<br>
                                تم تسجيلك في دورة {CourseName} بنجاح.<br>
                                المدرس: {CourseInstructor}<br>
                                يمكنك البدء الآن من {CourseUrl}
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Copy variable to clipboard and insert into content
            $('.variable-tag').on('click', function() {
                const variable = $(this).data('var');
                const contentField = $('#content');
                const currentContent = contentField.val();
                const cursorPos = contentField.prop('selectionStart');
                
                // Insert variable at cursor position
                const newContent = currentContent.substring(0, cursorPos) + variable + currentContent.substring(cursorPos);
                contentField.val(newContent);
                
                // Focus back on textarea
                contentField.focus();
                
                // Show feedback
                $(this).addClass('bg-primary text-white');
                setTimeout(() => {
                    $(this).removeClass('bg-primary text-white');
                }, 300);
                
                // Show toast notification
                showToast('تم إضافة المتغير', 'success');
            });

            // Form validation
            $('form').on('submit', function(e) {
                const eventType = $('#eventType').val();
                if (!eventType) {
                    e.preventDefault();
                    alert('@Html.Raw(Html.T("يرجى اختيار نوع الحدث", "Please select an event type").Replace("'", "\\'"))');
                    return false;
                }
            });
        });

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = $(`
                <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3" role="alert" style="z-index: 9999;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('body').append(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
}

