@model LMS.Areas.Admin.ViewModels.NotificationTemplateViewModel

@{
    ViewData["Title"] = Html.T("تعديل قالب إشعار", "Edit notification template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإشعارات", "Notifications"), null),
        (Html.T("القوالب", "Templates"), Url.Action("Templates", "Notifications")),
        (Html.T("تعديل قالب", "Edit template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .variable-tag {
            display: inline-block;
            padding: 4px 12px;
            margin: 4px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .variable-tag:hover {
            background: #3454d1;
            color: white;
        }
        .template-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .preview-notification {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <form asp-action="EditTemplate" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <div class="row">
            <!-- Form Section -->
            <div class="col-lg-8">
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("تعديل معلومات القالب", "Edit template information")</h5>
                        <div class="card-header-action">
                            <span class="badge bg-soft-primary text-primary">رقم القالب: #@Model.Id</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Template Name -->
                        <div class="mb-4">
                            <label class="form-label" for="name">اسم القالب <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" asp-for="Name" required>
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <!-- Event Type -->
                        <div class="mb-4">
                            <label class="form-label" for="eventType">نوع الحدث <span class="text-danger">*</span></label>
                            <select class="form-select" id="eventType" asp-for="EventType" required>
                                <option value="">-- اختر نوع الحدث --</option>
                                <option value="UserRegistration">تسجيل مستخدم جديد</option>
                                <option value="CourseEnrollment">التسجيل في دورة</option>
                                <option value="CourseCompletion">إكمال دورة</option>
                                <option value="PaymentSuccess">دفعة ناجحة</option>
                                <option value="PaymentFailed">دفعة فاشلة</option>
                                <option value="NewMessage">رسالة جديدة</option>
                                <option value="CertificateIssued">صدور شهادة</option>
                                <option value="RefundApproved">الموافقة على استرداد</option>
                                <option value="WithdrawalProcessed">معالجة سحب</option>
                                <option value="SupportTicketReply">رد على تذكرة دعم</option>
                            </select>
                            <span asp-validation-for="EventType" class="text-danger"></span>
                        </div>

                        <!-- Title -->
                        <div class="mb-4">
                            <label class="form-label" for="title">عنوان الإشعار <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" asp-for="Title" required>
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <small class="text-muted">يمكنك استخدام المتغيرات مثل: {UserName}, {CourseName}</small>
                        </div>

                        <!-- Content -->
                        <div class="mb-4">
                            <label class="form-label" for="content">محتوى الإشعار <span class="text-danger">*</span></label>
                            <textarea class="form-control template-editor" id="content" asp-for="Content" rows="10" required></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                            <small class="text-muted">استخدم المتغيرات في النص للتخصيص التلقائي</small>
                        </div>

                        <!-- Is Active -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" asp-for="IsActive">
                                <label class="form-check-label" for="isActive">
                                    تفعيل القالب
                                </label>
                            </div>
                            <small class="text-muted">القوالب النشطة سيتم استخدامها تلقائياً عند وقوع الحدث المرتبط</small>
                        </div>

                        <!-- Preview Section -->
                        <div class="mb-4">
                            <label class="form-label">معاينة الإشعار</label>
                            <div class="preview-notification">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="avatar-text bg-soft-primary text-primary">
                                        <i class="feather-bell"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-2" id="previewTitle">@Model.Title</h6>
                                        <p class="text-muted mb-0" id="previewContent">@Model.Content</p>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">هذه معاينة لكيفية ظهور الإشعار للمستخدم</small>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <div>
                            <a asp-action="Templates" class="btn btn-light">
                                <i class="feather-arrow-right me-2"></i>رجوع
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" onclick="testTemplate()">
                                <i class="feather-send me-2"></i>اختبار القالب
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>حفظ التعديلات
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Helper Section -->
            <div class="col-lg-4">
                <div class="card stretch stretch-full sticky-top" style="top: 100px;">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("المتغيرات المتاحة", "Available variables")</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">انقر على المتغير لإضافته</p>
                        
                        <h6 class="fw-bold mb-3">متغيرات المستخدم:</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{UserName}">{UserName}</span>
                            <span class="variable-tag" data-var="{UserEmail}">{UserEmail}</span>
                            <span class="variable-tag" data-var="{UserFirstName}">{UserFirstName}</span>
                            <span class="variable-tag" data-var="{UserLastName}">{UserLastName}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">متغيرات الدورة:</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{CourseName}">{CourseName}</span>
                            <span class="variable-tag" data-var="{CourseInstructor}">{CourseInstructor}</span>
                            <span class="variable-tag" data-var="{CoursePrice}">{CoursePrice}</span>
                            <span class="variable-tag" data-var="{CourseUrl}">{CourseUrl}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">متغيرات عامة:</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{PlatformName}">{PlatformName}</span>
                            <span class="variable-tag" data-var="{Date}">{Date}</span>
                            <span class="variable-tag" data-var="{Time}">{Time}</span>
                            <span class="variable-tag" data-var="{SupportEmail}">{SupportEmail}</span>
                        </div>

                        <h6 class="fw-bold mb-3 mt-4">متغيرات المدفوعات:</h6>
                        <div class="mb-3">
                            <span class="variable-tag" data-var="{Amount}">{Amount}</span>
                            <span class="variable-tag" data-var="{Currency}">{Currency}</span>
                            <span class="variable-tag" data-var="{TransactionId}">{TransactionId}</span>
                            <span class="variable-tag" data-var="{InvoiceUrl}">{InvoiceUrl}</span>
                        </div>

                        <div class="alert alert-info mt-4">
                            <i class="feather-info me-2"></i>
                            <small>
                                سيتم استبدال هذه المتغيرات تلقائياً بالقيم الفعلية عند إرسال الإشعار
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Live preview update
            $('#title').on('input', function() {
                $('#previewTitle').text($(this).val() || 'عنوان الإشعار');
            });

            $('#content').on('input', function() {
                $('#previewContent').text($(this).val() || 'محتوى الإشعار');
            });

            // Copy variable to clipboard and insert into content
            $('.variable-tag').on('click', function() {
                const variable = $(this).data('var');
                const contentField = $('#content');
                const currentContent = contentField.val();
                const cursorPos = contentField.prop('selectionStart');
                
                // Insert variable at cursor position
                const newContent = currentContent.substring(0, cursorPos) + variable + currentContent.substring(cursorPos);
                contentField.val(newContent);
                
                // Update preview
                $('#previewContent').text(newContent);
                
                // Focus back on textarea
                contentField.focus();
                
                // Show feedback
                $(this).addClass('bg-primary text-white');
                setTimeout(() => {
                    $(this).removeClass('bg-primary text-white');
                }, 300);
            });
        });

        function testTemplate() {
            const title = $('#title').val();
            const content = $('#content').val();
            
            if (!title || !content) {
                alert('@Html.Raw(Html.T("يرجى ملء جميع الحقول أولاً", "Please fill in all fields first").Replace("'", "\\'"))');
                return;
            }

            // Simulate sending test notification
            if (confirm('@Html.Raw(Html.T("هل تريد إرسال إشعار تجريبي لنفسك؟", "Do you want to send a test notification to yourself?").Replace("'", "\\'"))')) {
                // Implement test notification logic
                alert('@Html.Raw(Html.T("سيتم إرسال إشعار تجريبي إلى بريدك الإلكتروني", "A test notification will be sent to your email").Replace("'", "\\'"))');
            }
        }
    </script>
}

