@model LMS.Areas.Admin.ViewModels.EmailTemplateEditViewModel

@{
    ViewData["Title"] = Html.T("تعديل قالب البريد الإلكتروني", "Edit Email Template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("قوالب البريد الإلكتروني", "Email Templates"), Url.Action("Index", "EmailTemplates")),
        (Html.T("تعديل القالب", "Edit Template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .note-editor.note-frame {
            direction: rtl;
            text-align: right;
        }
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            min-height: 300px;
            direction: ltr;
            text-align: left;
        }
        .stats-card {
            background: var(--gradient-hero, linear-gradient(135deg, #004aad 0%, #0055c4 50%, #1a5cb9 100%));
            color: white;
            border-radius: 10px;
            padding: 20px;
        }
        .variable-tag {
            cursor: pointer;
            transition: all 0.3s;
        }
        .variable-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row">
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-edit-2 me-2"></i>
                        تعديل معلومات القالب
                    </h5>
                    <div class="card-header-action">
                        <span class="badge bg-soft-info text-info">
                            <i class="feather-send me-1"></i>
                            @Model.SentCount إرسال
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="emailTemplateEditForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="SentCount" />
                        <input type="hidden" asp-for="OpenCount" />
                        <input type="hidden" asp-for="ClickCount" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Template Name -->
                        <div class="form-group mb-4">
                            <label asp-for="Name" class="form-label">
                                اسم القالب <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg" placeholder="@Html.T("مثال: قالب الترحيب بالمستخدمين الجدد", "e.g. Welcome template for new users")" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <!-- Subject -->
                        <div class="form-group mb-4">
                            <label asp-for="Subject" class="form-label">
                                موضوع البريد <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Subject" class="form-control" placeholder="@Html.T("مثال: مرحباً بك في منصتنا التعليمية", "e.g. Welcome to our learning platform")" />
                            <span asp-validation-for="Subject" class="text-danger"></span>
                        </div>

                        <!-- Category and Language -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Category" class="form-label">
                                        @Html.T("التصنيف", "Category") <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Category" class="form-select" id="categorySelect">
                                        <option value="">@Html.T("اختر التصنيف", "Select category")</option>
                                        <option value="Welcome">@Html.T("ترحيب", "Welcome")</option>
                                        <option value="Notification">@Html.T("إشعار", "Notification")</option>
                                        <option value="Marketing">@Html.T("تسويق", "Marketing")</option>
                                        <option value="Transactional">@Html.T("معاملات", "Transactional")</option>
                                        <option value="Educational">@Html.T("تعليمي", "Educational")</option>
                                        <option value="Support">@Html.T("دعم", "Support")</option>
                                        <option value="System">@Html.T("نظام", "System")</option>
                                    </select>
                                    <span asp-validation-for="Category" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Language" class="form-label">
                                        @Html.T("اللغة", "Language") <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Language" class="form-select">
                                        <option value="ar">@Html.T("العربية", "Arabic")</option>
                                        <option value="en">@Html.T("الإنجليزية", "English")</option>
                                    </select>
                                    <span asp-validation-for="Language" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label">
                                @Html.T("الوصف", "Description")
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="2" placeholder="@Html.T("وصف مختصر لاستخدام القالب...", "Brief description of how to use the template...")"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- Editor Type -->
                        <div class="form-group mb-4">
                            <label class="form-label">@Html.T("نوع المحرر", "Editor type")</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="editorType" id="visualEditor" value="visual" checked>
                                <label class="btn btn-outline-primary" for="visualEditor">
                                    <i class="feather-layout me-2"></i>
                                    @Html.T("محرر مرئي", "Visual editor")
                                </label>
                                <input type="radio" class="btn-check" name="editorType" id="htmlEditor" value="html">
                                <label class="btn btn-outline-primary" for="htmlEditor">
                                    <i class="feather-code me-2"></i>
                                    @Html.T("محرر HTML", "HTML editor")
                                </label>
                            </div>
                        </div>

                        <!-- Visual Editor -->
                        <div class="form-group mb-4" id="visualEditorContent">
                            <label asp-for="Body" class="form-label">
                                @Html.T("محتوى البريد", "Email content") <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Body" id="bodyEditor" class="form-control" rows="15"></textarea>
                            <span asp-validation-for="Body" class="text-danger"></span>
                        </div>

                        <!-- HTML Editor -->
                        <div class="form-group mb-4 d-none" id="htmlEditorContent">
                            <label class="form-label">
                                @Html.T("محتوى HTML", "HTML content") <span class="text-danger">*</span>
                            </label>
                            <textarea id="htmlBodyEditor" class="form-control code-editor" rows="15"></textarea>
                        </div>

                        <!-- Layout Template -->
                        <div class="form-group mb-4">
                            <label asp-for="LayoutTemplate" class="form-label">
                                @Html.T("قالب التخطيط", "Layout template")
                            </label>
                            <select asp-for="LayoutTemplate" class="form-select">
                                <option value="">@Html.T("بدون قالب (محتوى فقط)", "No template (content only)")</option>
                                <option value="Default">@Html.T("القالب الافتراضي", "Default template")</option>
                                <option value="Modern">@Html.T("عصري", "Modern")</option>
                                <option value="Minimal">@Html.T("بسيط", "Minimal")</option>
                                <option value="Professional">@Html.T("احترافي", "Professional")</option>
                            </select>
                            <span asp-validation-for="LayoutTemplate" class="text-danger"></span>
                        </div>

                        <!-- Options -->
                        <div class="card border mb-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="feather-settings me-2"></i>
                                    @Html.T("خيارات القالب", "Template options")
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" />
                                            <label class="form-check-label" for="isActiveSwitch">
                                                <i class="feather-check-circle me-2"></i>
                                                قالب نشط
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="IsDefault" class="form-check-input" type="checkbox" id="isDefaultSwitch" />
                                            <label class="form-check-label" for="isDefaultSwitch">
                                                <i class="feather-star me-2"></i>
                                                قالب افتراضي للتصنيف
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="TrackOpens" class="form-check-input" type="checkbox" id="trackOpensSwitch" />
                                            <label class="form-check-label" for="trackOpensSwitch">
                                                <i class="feather-eye me-2"></i>
                                                تتبع فتح البريد
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input asp-for="TrackClicks" class="form-check-input" type="checkbox" id="trackClicksSwitch" />
                                            <label class="form-check-label" for="trackClicksSwitch">
                                                <i class="feather-mouse-pointer me-2"></i>
                                                تتبع النقرات
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2 justify-content-between">
                            <div class="d-flex gap-2">
                                <a asp-action="Index" class="btn btn-light">
                                    <i class="feather-x me-2"></i>
                                    إلغاء
                                </a>
                                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                    <i class="feather-eye me-2"></i>
                                    @Html.T("عرض التفاصيل", "View details")
                                </a>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning" id="previewBtn">
                                    <i class="feather-eye me-2"></i>
                                    معاينة
                                </button>
                                <button type="button" class="btn btn-info" id="testBtn">
                                    <i class="feather-send me-2"></i>
                                    اختبار
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="feather-save me-2"></i>
                                    حفظ التغييرات
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Statistics Card -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-body stats-card">
                    <h6 class="text-white mb-4">
                        <i class="feather-bar-chart me-2"></i>
                        إحصائيات القالب
                    </h6>
                    <div class="row g-3">
                        <div class="col-4">
                            <div class="text-center">
                                <h3 class="text-white mb-1">@Model.SentCount</h3>
                                <small class="text-white-50">@Html.T("مرسلة", "Sent")</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <h3 class="text-white mb-1">@Model.OpenCount</h3>
                                <small class="text-white-50">@Html.T("مفتوحة", "Opened")</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <h3 class="text-white mb-1">@Model.ClickCount</h3>
                                <small class="text-white-50">@Html.T("منقورة", "Clicked")</small>
                            </div>
                        </div>
                    </div>
                    <hr class="my-3 border-white opacity-25">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-white mb-1">
                                    @(Model.SentCount > 0 ? $"{(Model.OpenCount * 100.0 / Model.SentCount):F1}%" : "0%")
                                </h4>
                                <small class="text-white-50">@Html.T("معدل الفتح", "Open rate")</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-white mb-1">
                                    @(Model.SentCount > 0 ? $"{(Model.ClickCount * 100.0 / Model.SentCount):F1}%" : "0%")
                                </h4>
                                <small class="text-white-50">@Html.T("معدل النقر", "Click rate")</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Variables Guide -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-code me-2"></i>
                        المتغيرات المتاحة
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        انقر على أي متغير لنسخه
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{UserName}}">
                            {{UserName}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{Email}}">
                            {{Email}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{CourseName}}">
                            {{CourseName}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{InstructorName}}">
                            {{InstructorName}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{CompanyName}}">
                            {{CompanyName}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{SiteUrl}}">
                            {{SiteUrl}}
                        </span>
                        <span class="badge bg-soft-primary text-primary variable-tag" data-var="{{CurrentYear}}">
                            {{CurrentYear}}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Version History -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-clock me-2"></i>
                        سجل الإصدارات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <small class="text-muted">@Html.T("تم الإنشاء", "Created")</small>
                                <p class="mb-0 small">@Model.CreatedAt.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <small class="text-muted">@Html.T("آخر تعديل", "Last modified")</small>
                                    <p class="mb-0 small">@Model.UpdatedAt.Value.ToString("dd/MM/yyyy")</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize Summernote
            $('#bodyEditor').summernote({
                height: 350,
                direction: 'rtl',
                placeholder: 'اكتب محتوى البريد الإلكتروني هنا...',
                toolbar: [
                    ['style', ['style', 'bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ]
            });

            // Initialize Select2
            $('#categorySelect').select2({ dir: 'rtl' });

            // Editor Type Toggle
            $('input[name="editorType"]').change(function() {
                if ($(this).val() === 'visual') {
                    $('#visualEditorContent').removeClass('d-none');
                    $('#htmlEditorContent').addClass('d-none');
                    $('#bodyEditor').summernote('code', $('#htmlBodyEditor').val());
                } else {
                    $('#visualEditorContent').addClass('d-none');
                    $('#htmlEditorContent').removeClass('d-none');
                    $('#htmlBodyEditor').val($('#bodyEditor').summernote('code'));
                }
            });

            // Sync editors before submit
            $('#emailTemplateEditForm').on('submit', function() {
                if ($('input[name="editorType"]:checked').val() === 'html') {
                    $('#bodyEditor').summernote('code', $('#htmlBodyEditor').val());
                }
                hasUnsavedChanges = false;
            });

            // Copy variable to clipboard
            $('.variable-tag').click(function() {
                const variable = $(this).data('var');
                navigator.clipboard.writeText(variable).then(function() {
                    const toast = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">@Html.T("تم نسخ المتغير:", "Variable copied:") ' + variable + '</div>');
                    $('body').append(toast);
                    setTimeout(function() {
                        toast.fadeOut(function() { $(this).remove(); });
                    }, 2000);
                });
            });

            // Preview functionality
            $('#previewBtn').click(function() {
                window.open('@Url.Action("Preview", "EmailTemplates", new { id = Model.Id })', '_blank');
            });

            // Test functionality
            $('#testBtn').click(function() {
                window.location.href = '@Url.Action("Test", "EmailTemplates", new { id = Model.Id })';
            });

            // Unsaved changes warning
            let hasUnsavedChanges = false;
            $('#emailTemplateEditForm input, #emailTemplateEditForm select, #emailTemplateEditForm textarea').on('change', function() {
                hasUnsavedChanges = true;
            });

            $(window).on('beforeunload', function() {
                if (hasUnsavedChanges) {
                    return 'لديك تغييرات غير محفوظة. هل أنت متأكد من المغادرة؟';
                }
            });
        });
    </script>

    <style>
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            right: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            right: -31px;
            top: 17px;
            width: 2px;
            height: calc(100% - 5px);
            background: #e5e7eb;
        }
        .timeline-item:last-child:before {
            display: none;
        }
    </style>
}

