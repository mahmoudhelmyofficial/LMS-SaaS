@model LMS.Areas.Admin.ViewModels.ScheduledReportViewModel

@{
    ViewData["Title"] = Html.T("تعديل التقرير المجدول", "Edit scheduled report");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التقارير المتقدمة", "Advanced reports"), null),
        (Html.T("التقارير المجدولة", "Scheduled reports"), Url.Action("ScheduledReports")),
        (Html.T("تعديل التقرير", "Edit report"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var templates = ViewBag.Templates as IEnumerable<dynamic>;
}

@section Styles {
    <style>
        .frequency-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .frequency-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .frequency-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.5rem;
        }
        .format-badge {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .format-badge.selected {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .recipient-tag {
            display: inline-block;
            padding: 6px 12px;
            background: #e5e7eb;
            border-radius: 20px;
            margin: 4px;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <form asp-action="EditScheduledReport" asp-route-id="@Model.Id" method="post" id="scheduleForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
        <input asp-for="Id" type="hidden" />

        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2"></i>
                            @Html.T("المعلومات الأساسية", "Basic information")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-4">
                            <label asp-for="Name" class="form-label">
                                @Html.T("اسم التقرير", "Report name") <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label">
                                @Html.T("الوصف", "Description")
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="TemplateId" class="form-label">
                                @Html.T("قالب التقرير", "Report template") <span class="text-danger">*</span>
                            </label>
                            <select asp-for="TemplateId" class="form-select form-select-lg">
                                <option value="">-- @Html.T("اختر القالب", "Select template") --</option>
                                @if (templates != null)
                                {
                                    @foreach (var template in templates)
                                    {
                                        <option value="@template.Id" selected="@(template.Id == Model.TemplateId)">@template.Name</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="TemplateId" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Schedule Configuration -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-calendar me-2"></i>
                            @Html.T("إعدادات الجدولة", "Schedule settings")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-4">
                            <label class="form-label">
                                @Html.T("التكرار", "Frequency") <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Frequency" type="hidden" id="frequencyInput" />
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="frequency-option @(Model.Frequency == "Daily" ? "selected" : "")" data-frequency="Daily">
                                        <div class="frequency-icon bg-soft-primary text-primary">
                                            <i class="feather-sun"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">@Html.T("يومي", "Daily")</h6>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="frequency-option @(Model.Frequency == "Weekly" ? "selected" : "")" data-frequency="Weekly">
                                        <div class="frequency-icon bg-soft-success text-success">
                                            <i class="feather-calendar"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">@Html.T("أسبوعي", "Weekly")</h6>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="frequency-option @(Model.Frequency == "Monthly" ? "selected" : "")" data-frequency="Monthly">
                                        <div class="frequency-icon bg-soft-warning text-warning">
                                            <i class="feather-repeat"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">@Html.T("شهري", "Monthly")</h6>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4" id="dayOfWeekSection" style="display: @(Model.Frequency == "Weekly" ? "block" : "none")">
                            <label asp-for="DayOfWeek" class="form-label">
                                @Html.T("يوم الأسبوع", "Day of week")
                            </label>
                            <select asp-for="DayOfWeek" class="form-select">
                                <option value="">-- @Html.T("اختر اليوم", "Select day") --</option>
                                <option value="0">@Html.T("الأحد", "Sunday")</option>
                                <option value="1">@Html.T("الاثنين", "Monday")</option>
                                <option value="2">@Html.T("الثلاثاء", "Tuesday")</option>
                                <option value="3">@Html.T("الأربعاء", "Wednesday")</option>
                                <option value="4">@Html.T("الخميس", "Thursday")</option>
                                <option value="5">@Html.T("الجمعة", "Friday")</option>
                                <option value="6">@Html.T("السبت", "Saturday")</option>
                            </select>
                        </div>

                        <div class="form-group mb-4" id="dayOfMonthSection" style="display: @(Model.Frequency == "Monthly" ? "block" : "none")">
                            <label asp-for="DayOfMonth" class="form-label">
                                @Html.T("يوم الشهر", "Day of month")
                            </label>
                            <input asp-for="DayOfMonth" type="number" class="form-control" min="1" max="31" />
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label">
                                @Html.T("وقت التنفيذ", "Execution time") <span class="text-danger">*</span>
                            </label>
                            <div class="d-flex gap-2 align-items-center">
                                <select id="hourSelect" class="form-select" style="width: auto;">
                                    @for (int i = 0; i < 24; i++)
                                    {
                                        <option value="@i" selected="@(Model.TimeOfDay.Hours == i)">@i.ToString("00")</option>
                                    }
                                </select>
                                <span>:</span>
                                <select id="minuteSelect" class="form-select" style="width: auto;">
                                    @for (int i = 0; i < 60; i += 15)
                                    {
                                        <option value="@i" selected="@(Model.TimeOfDay.Minutes == i)">@i.ToString("00")</option>
                                    }
                                </select>
                                <input asp-for="TimeOfDay" type="hidden" id="timeOfDayInput" value="@Model.TimeOfDay.ToString(@"hh\:mm\:ss")" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Configuration -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-file-text me-2"></i>
                            إعدادات الإخراج
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-4">
                            <label asp-for="Format" class="form-label">
                                @Html.T("تنسيق الملف", "File format") <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Format" type="hidden" id="formatInput" />
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="format-badge bg-soft-danger text-danger text-center @(Model.Format == "PDF" ? "selected" : "")" data-format="PDF" onclick="selectFormat(this, 'PDF')">
                                        <i class="feather-file-text fs-1"></i>
                                        <h6 class="fw-bold mt-2 mb-0">@Html.T("PDF", "PDF")</h6>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="format-badge bg-soft-success text-success text-center @(Model.Format == "Excel" ? "selected" : "")" data-format="Excel" onclick="selectFormat(this, 'Excel')">
                                        <i class="feather-file fs-1"></i>
                                        <h6 class="fw-bold mt-2 mb-0">@Html.T("إكسل", "Excel")</h6>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="format-badge bg-soft-info text-info text-center @(Model.Format == "CSV" ? "selected" : "")" data-format="CSV" onclick="selectFormat(this, 'CSV')">
                                        <i class="feather-database fs-1"></i>
                                        <h6 class="fw-bold mt-2 mb-0">@Html.T("CSV", "CSV")</h6>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Recipients" class="form-label">
                                @Html.T("المستلمون (البريد الإلكتروني)", "Recipients (email)")
                            </label>
                            <div id="recipientTags" class="mb-2"></div>
                            <div class="input-group">
                                <input type="email" class="form-control" id="recipientInput" placeholder="@Html.T("أدخل البريد الإلكتروني", "Enter email address")" />
                                <button type="button" class="btn btn-light" onclick="addRecipient()">
                                    <i class="feather-plus"></i>
                                </button>
                            </div>
                            <input asp-for="Recipients" type="hidden" id="recipientsHidden" value="@Model.Recipients" />
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex gap-2 justify-content-end">
                            <a asp-action="ScheduledReports" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء", "Cancel")
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-check me-2"></i>
                                @Html.T("حفظ التغييرات", "Save changes")
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-activity me-2"></i>
                            @Html.T("معلومات الجدولة", "Schedule info")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="vstack gap-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("المعرف", "ID"):</span>
                                <span class="fw-semibold">#@Model.Id</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("الحالة", "Status"):</span>
                                <span class="badge bg-soft-success text-success">@Html.T("نشط", "Active")</span>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">@Html.T("آخر تحديث", "Last updated"):</small>
                            <small class="fw-semibold">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    </div>
                </div>

                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-zap me-2"></i>
                            @Html.T("إجراءات سريعة", "Quick actions")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <form asp-action="RunNow" asp-route-id="@Model.Id" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-light-brand w-100">
                                    <i class="feather-play me-2"></i>
                                    @Html.T("تنفيذ الآن", "Run now")
                                </button>
                            </form>
                            <button type="button" class="btn btn-light-brand" onclick="viewHistory()">
                                <i class="feather-clock me-2"></i>
                                @Html.T("سجل التنفيذ", "Execution history")
                            </button>
                            <hr class="my-2">
                            <button type="button" class="btn btn-danger" onclick="deleteSchedule()">
                                <i class="feather-trash-2 me-2"></i>
                                @Html.T("حذف الجدولة", "Delete schedule")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        const recipients = '@Model.Recipients'.split(',').filter(r => r.trim());

        $(document).ready(function() {
            updateRecipientTags();

            $('.frequency-option').click(function() {
                $('.frequency-option').removeClass('selected');
                $(this).addClass('selected');
                const freq = $(this).data('frequency');
                $('#frequencyInput').val(freq);
                
                $('#dayOfWeekSection, #dayOfMonthSection').hide();
                if (freq === 'Weekly') $('#dayOfWeekSection').show();
                else if (freq === 'Monthly') $('#dayOfMonthSection').show();
            });

            $('#hourSelect, #minuteSelect').change(function() {
                const hour = $('#hourSelect').val().padStart(2, '0');
                const minute = $('#minuteSelect').val().padStart(2, '0');
                $('#timeOfDayInput').val(hour + ':' + minute + ':00');
            });

            $('#recipientInput').keypress(function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    addRecipient();
                }
            });
        });

        function selectFormat(element, format) {
            $('.format-badge').removeClass('selected');
            $(element).addClass('selected');
            $('#formatInput').val(format);
        }

        function addRecipient() {
            const email = $('#recipientInput').val().trim();
            if (email && /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email)) {
                if (!recipients.includes(email)) {
                    recipients.push(email);
                    updateRecipientTags();
                    updateRecipientsInput();
                    $('#recipientInput').val('');
                }
            }
        }

        function removeRecipient(email) {
            const index = recipients.indexOf(email);
            if (index > -1) {
                recipients.splice(index, 1);
                updateRecipientTags();
                updateRecipientsInput();
            }
        }

        function updateRecipientTags() {
            const html = recipients.map(email => 
                `<span class="recipient-tag">
                    ${email}
                    <button type="button" class="btn-close btn-close-sm ms-2" onclick="removeRecipient('${email}')"></button>
                </span>`
            ).join('');
            $('#recipientTags').html(html);
        }

        function updateRecipientsInput() {
            $('#recipientsHidden').val(recipients.join(','));
        }

        function viewHistory() {
            alert('@Html.Raw(Html.T("سجل التنفيذ قيد التطوير", "Execution history is under development").ToString().Replace("'", "\\'"))');
        }

        function deleteSchedule() {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذه الجدولة؟", "Are you sure you want to delete this schedule?").ToString().Replace("'", "\\'"))')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteScheduledReport", new { id = Model.Id })';
                
                const token = document.createElement('input');
                token.type = 'hidden';
                token.name = '__RequestVerificationToken';
                token.value = $('input[name="__RequestVerificationToken"]').val();
                form.appendChild(token);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}

