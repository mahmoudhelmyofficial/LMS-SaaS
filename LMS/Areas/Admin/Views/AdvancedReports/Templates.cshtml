@model IEnumerable<LMS.Domain.Entities.Analytics.ReportTemplate>

@{
    ViewData["Title"] = Html.T("قوالب التقارير", "Report templates");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التقارير المتقدمة", "Advanced Reports"), Url.Action("Index", "AdvancedReports")),
        (Html.T("قوالب التقارير", "Report templates"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("إنشاء قالب جديد", "Create new template"), "feather-plus", Url.Action("CreateTemplate"), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
    var page = ViewBag.Page ?? 1;
}

@section Styles {
    <link rel="stylesheet" type="text/css" href="~/assets/vendors/css/datatables.min.css" />
    <style>
        .template-card {
            transition: all 0.3s;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .template-card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }
        .template-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 1.5rem;
        }
        .report-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("إجمالي القوالب", "Total templates")</div>
                            <h3 class="fw-bold mb-0">@Model.Count()</h3>
                        </div>
                        <div class="avatar-text bg-soft-primary text-primary avatar-lg">
                            <i class="feather-file-text"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("القوالب النشطة", "Active templates")</div>
                            <h3 class="fw-bold mb-0 text-success">@Model.Count(t => t.IsActive)</h3>
                        </div>
                        <div class="avatar-text bg-soft-success text-success avatar-lg">
                            <i class="feather-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("تقارير المبيعات", "Sales reports")</div>
                            <h3 class="fw-bold mb-0 text-info">@Model.Count(t => t.ReportType == ReportType.Sales)</h3>
                        </div>
                        <div class="avatar-text bg-soft-info text-info avatar-lg">
                            <i class="feather-dollar-sign"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("تقارير المستخدمين", "User reports")</div>
                            <h3 class="fw-bold mb-0 text-warning">@Model.Count(t => t.ReportType == ReportType.Users)</h3>
                        </div>
                        <div class="avatar-text bg-soft-warning text-warning avatar-lg">
                            <i class="feather-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Grid -->
    <div class="card stretch stretch-full">
        <div class="card-header">
            <h5 class="card-title">
                <i class="feather-layout me-2"></i>
                @Html.T("قوالب التقارير المتاحة", "Available report templates")
            </h5>
            <div class="card-header-action">
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="feather-filter me-2"></i>
                        @Html.T("تصفية حسب النوع", "Filter by type")
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="@Url.Action("Templates")">@Html.T("الكل", "All")</a></li>
                        <li><a class="dropdown-item" href="@Url.Action("Templates", new { type = ReportType.Sales })">@Html.T("تقارير المبيعات", "Sales reports")</a></li>
                        <li><a class="dropdown-item" href="@Url.Action("Templates", new { type = ReportType.Users })">@Html.T("تقارير المستخدمين", "User reports")</a></li>
                        <li><a class="dropdown-item" href="@Url.Action("Templates", new { type = ReportType.Courses })">@Html.T("تقارير الدورات", "Course reports")</a></li>
                        <li><a class="dropdown-item" href="@Url.Action("Templates", new { type = ReportType.Enrollments })">@Html.T("تقارير التسجيلات", "Enrollment reports")</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="row g-4">
                    @foreach (var template in Model)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="template-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-start gap-3 mb-3">
                                        <div class="template-icon @(template.ReportType switch
                                        {
                                            ReportType.Sales => "bg-soft-success text-success",
                                            ReportType.Users => "bg-soft-primary text-primary",
                                            ReportType.Courses => "bg-soft-info text-info",
                                            ReportType.Enrollments => "bg-soft-warning text-warning",
                                            _ => "bg-soft-secondary text-secondary"
                                        })">
                                            <i class="@(template.ReportType switch
                                            {
                                                ReportType.Sales => "feather-dollar-sign",
                                                ReportType.Users => "feather-users",
                                                ReportType.Courses => "feather-book",
                                                ReportType.Enrollments => "feather-user-check",
                                                _ => "feather-file-text"
                                            })"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1">@template.Name</h6>
                                            <span class="report-type-badge @(template.ReportType switch
                                            {
                                                ReportType.Sales => "bg-soft-success text-success",
                                                ReportType.Users => "bg-soft-primary text-primary",
                                                ReportType.Courses => "bg-soft-info text-info",
                                                ReportType.Enrollments => "bg-soft-warning text-warning",
                                                _ => "bg-soft-secondary text-secondary"
                                            })">
                                                @(template.ReportType switch
                                                {
                                                    ReportType.Sales => Html.T("مبيعات", "Sales"),
                                                    ReportType.Users => Html.T("مستخدمين", "Users"),
                                                    ReportType.Courses => Html.T("دورات", "Courses"),
                                                    ReportType.Enrollments => Html.T("تسجيلات", "Enrollments"),
                                                    _ => Html.T("عام", "General")
                                                })
                                            </span>
                                        </div>
                                        @if (template.IsActive)
                                        {
                                            <span class="badge bg-soft-success text-success">
                                                <i class="feather-check-circle"></i>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-soft-secondary text-secondary">
                                                <i class="feather-x-circle"></i>
                                            </span>
                                        }
                                    </div>

                                    <p class="text-muted small mb-3">
                                        @(template.Description?.Length > 100 ? template.Description.Substring(0, 100) + "..." : template.Description)
                                    </p>

                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <small class="text-muted">
                                            <i class="feather-calendar me-1"></i>
                                            @template.CreatedAt.ToString("dd/MM/yyyy")
                                        </small>
                                        @if (template.UpdatedAt.HasValue)
                                        {
                                            <small class="text-muted">
                                                <i class="feather-refresh-cw me-1"></i>
                                                @template.UpdatedAt.Value.ToString("dd/MM/yyyy")
                                            </small>
                                        }
                                    </div>

                                    <div class="d-flex gap-2">
                                        <a asp-action="EditTemplate" asp-route-id="@template.Id" class="btn btn-sm btn-light-brand flex-fill">
                                            <i class="feather-edit me-1"></i>
                                            @Html.T("تعديل", "Edit")
                                        </a>
                                        <form asp-action="DuplicateTemplate" asp-route-id="@template.Id" method="post" style="display:inline;" class="flex-fill">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-light w-100">
                                                <i class="feather-copy me-1"></i>
                                                @Html.T("نسخ", "Copy")
                                            </button>
                                        </form>
                                        <button type="button" class="btn btn-sm btn-light text-danger" onclick="deleteTemplate(@template.Id)">
                                            <i class="feather-trash-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.Count() >= 20)
                {
                    <div class="mt-4">
                        <nav aria-label="@Html.T("تنقل الصفحة", "Page navigation")">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(page == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("Templates", new { page = page - 1 })">
                                        <i class="feather-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item active">
                                    <span class="page-link">@(page)</span>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Templates", new { page = page + 1 })">
                                        <i class="feather-chevron-left"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <div class="avatar-text bg-soft-primary text-primary avatar-xl mx-auto mb-3">
                        <i class="feather-inbox" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@Html.T("لا توجد قوالب تقارير", "No report templates")</h5>
                    <p class="text-muted mb-4">@Html.T("ابدأ بإنشاء قالب تقرير جديد لإنشاء تقارير مخصصة", "Start by creating a new report template for custom reports")</p>
                    <a asp-action="CreateTemplate" class="btn btn-primary">
                        <i class="feather-plus me-2"></i>
                        @Html.T("إنشاء قالب جديد", "Create new template")
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Form -->
<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script src="~/assets/vendors/js/datatables.min.js"></script>
    <script>
        function deleteTemplate(id) {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذا القالب؟ سيتم حذف جميع التقارير المجدولة المرتبطة بهذا القالب.", "Are you sure you want to delete this template? All scheduled reports using it will be removed.").ToString().Replace("'", "\\'"))')) {
                const form = document.getElementById('deleteForm');
                form.action = '@Url.Action("DeleteTemplate")?id=' + id;
                form.submit();
            }
        }
    </script>
}

