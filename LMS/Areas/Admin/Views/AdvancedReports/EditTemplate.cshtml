@model LMS.Areas.Admin.ViewModels.ReportTemplateViewModel

@{
    ViewData["Title"] = Html.T("تعديل قالب التقرير", "Edit report template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التقارير المتقدمة", "Advanced reports"), null),
        (Html.T("قوالب التقارير", "Report templates"), Url.Action("Templates")),
        (Html.T("تعديل القالب", "Edit template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .report-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .report-type-card:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-3px);
        }
        .report-type-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .report-type-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.5rem;
        }
        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #f9fafb;
        }
        .version-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <form asp-action="EditTemplate" asp-route-id="@Model.Id" method="post" id="templateForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
        <input asp-for="Id" type="hidden" />

        <div class="row">
            <!-- Main Form -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-info me-2"></i>
                            المعلومات الأساسية
                        </h5>
                        <div class="card-header-action">
                            <span class="version-badge bg-soft-primary text-primary">
                                <i class="feather-layers me-1"></i>
                                الإصدار 1.0
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Template Name -->
                        <div class="form-group mb-4">
                            <label asp-for="Name" class="form-label">
                                اسم القالب <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <!-- Description -->
                        <div class="form-group mb-4">
                            <label asp-for="Description" class="form-label">
                                الوصف <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Report Type Selection -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-bar-chart-2 me-2"></i>
                            نوع التقرير
                        </h5>
                    </div>
                    <div class="card-body">
                        <input asp-for="ReportType" type="hidden" id="reportTypeInput" />
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Sales ? "selected" : "")" data-type="@((int)ReportType.Sales)">
                                    <div class="report-type-icon bg-soft-success text-success">
                                        <i class="feather-dollar-sign"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">المبيعات</h6>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Users ? "selected" : "")" data-type="@((int)ReportType.Users)">
                                    <div class="report-type-icon bg-soft-primary text-primary">
                                        <i class="feather-users"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">المستخدمين</h6>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Courses ? "selected" : "")" data-type="@((int)ReportType.Courses)">
                                    <div class="report-type-icon bg-soft-info text-info">
                                        <i class="feather-book"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">الدورات</h6>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Enrollments ? "selected" : "")" data-type="@((int)ReportType.Enrollments)">
                                    <div class="report-type-icon bg-soft-warning text-warning">
                                        <i class="feather-user-check"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">التسجيلات</h6>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Financial ? "selected" : "")" data-type="@((int)ReportType.Financial)">
                                    <div class="report-type-icon bg-soft-danger text-danger">
                                        <i class="feather-credit-card"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">المالي</h6>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="report-type-card @(Model.ReportType == ReportType.Analytics ? "selected" : "")" data-type="@((int)ReportType.Analytics)">
                                    <div class="report-type-icon bg-soft-secondary text-secondary">
                                        <i class="feather-trending-up"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">التحليلات</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-settings me-2"></i>
                            إعدادات التقرير
                        </h5>
                        <div class="card-header-action">
                            <button type="button" class="btn btn-sm btn-light" onclick="formatJSON()">
                                <i class="feather-code me-1"></i>
                                تنسيق JSON
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label asp-for="Configuration" class="form-label">
                                تكوين التقرير (JSON) <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Configuration" class="form-control json-editor" rows="15" id="configEditor"></textarea>
                            <span asp-validation-for="Configuration" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button type="button" class="btn btn-sm btn-light" onclick="validateJSON()">
                                <i class="feather-check me-1"></i>
                                التحقق من الصحة
                            </button>
                            <button type="button" class="btn btn-sm btn-light" onclick="resetConfig()">
                                <i class="feather-refresh-cw me-1"></i>
                                إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex gap-2 justify-content-end">
                            <a asp-action="Templates" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                            <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">
                                <i class="feather-save me-2"></i>
                                حفظ كمسودة
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-check me-2"></i>
                                حفظ التغييرات
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Status Card -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-activity me-2"></i>
                            معلومات القالب
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="vstack gap-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">المعرف:</span>
                                <span class="fw-semibold">#@Model.Id</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">تاريخ الإنشاء:</span>
                                <span class="fw-semibold">@((ViewBag.CreatedAt as DateTime?)?.ToString("dd/MM/yyyy") ?? "-")</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">آخر تحديث:</span>
                                <span class="fw-semibold">@((ViewBag.UpdatedAt as DateTime?)?.ToString("dd/MM/yyyy") ?? "-")</span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">الحالة:</span>
                                <span class="badge bg-soft-success text-success">نشط</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Usage Statistics -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-bar-chart me-2"></i>
                            إحصائيات الاستخدام
                        </h5>
                    </div>
                    <div class="card-body">
                        @{
                            var usageCount = ViewBag.UsageCount ?? 0;
                            var scheduledCount = ViewBag.ScheduledCount ?? 0;
                            var completedExports = ViewBag.CompletedExports ?? 0;
                            var maxUsage = Math.Max(usageCount, 1);
                        }
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">مرات الاستخدام</span>
                                <span class="fw-bold text-primary">@usageCount</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: @(usageCount > 0 ? Math.Min(usageCount * 100 / maxUsage, 100) : 0)%"></div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">تقارير مجدولة</span>
                                <span class="fw-bold text-success">@scheduledCount</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: @(scheduledCount > 0 ? Math.Min(scheduledCount * 10, 100) : 0)%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">تصديرات مكتملة</span>
                                <span class="fw-bold text-info">@completedExports</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" style="width: @(completedExports > 0 ? Math.Min(completedExports, 100) : 0)%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-zap me-2"></i>
                            @Html.T("إجراءات سريعة", "Quick actions")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-light-brand" onclick="testTemplate()">
                                <i class="feather-play me-2"></i>
                                اختبار القالب
                            </button>
                            <button type="button" class="btn btn-light-brand" onclick="duplicateTemplate()">
                                <i class="feather-copy me-2"></i>
                                نسخ القالب
                            </button>
                            <button type="button" class="btn btn-light-brand" onclick="exportTemplate()">
                                <i class="feather-download me-2"></i>
                                تصدير JSON
                            </button>
                            <hr class="my-2">
                            <button type="button" class="btn btn-danger" onclick="deleteTemplate()">
                                <i class="feather-trash-2 me-2"></i>
                                حذف القالب
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        const originalConfig = $('#configEditor').val();

        $(document).ready(function() {
            // Report type selection
            $('.report-type-card').click(function() {
                $('.report-type-card').removeClass('selected');
                $(this).addClass('selected');
                $('#reportTypeInput').val($(this).data('type'));
            });
        });

        window.__AdvReportEditT = {
            jsonValid: '@Html.Raw(Html.T("✓ تنسيق JSON صحيح!", "✓ Valid JSON!").Replace("'", "\\'"))',
            fieldsLabel: '@Html.Raw(Html.T("الحقول:", "Fields:").Replace("'", "\\'"))',
            jsonError: '@Html.Raw(Html.T("✗ خطأ في تنسيق JSON:", "✗ JSON format error:").Replace("'", "\\'"))',
            jsonFormatted: '@Html.Raw(Html.T("✓ تم تنسيق JSON بنجاح", "✓ JSON formatted successfully").Replace("'", "\\'"))',
            jsonInvalid: '@Html.Raw(Html.T("✗ لا يمكن تنسيق JSON غير صالح", "✗ Cannot format invalid JSON").Replace("'", "\\'"))',
            confirmReset: '@Html.Raw(Html.T("هل تريد إعادة التكوين إلى آخر نسخة محفوظة؟", "Do you want to reset to last saved version?").Replace("'", "\\'"))',
            draftUnderDev: '@Html.Raw(Html.T("ميزة المسودة قيد التطوير", "Draft feature is under development").Replace("'", "\\'"))',
            testUnderDev: '@Html.Raw(Html.T("سيتم اختبار القالب وإنشاء تقرير تجريبي...\n\nهذه الميزة قيد التطوير", "Template will be tested and a sample report created...\n\nThis feature is under development").Replace("'", "\\'").Replace("\n", "\\n"))',
            confirmDuplicate: '@Html.Raw(Html.T("هل تريد إنشاء نسخة من هذا القالب؟", "Do you want to create a copy of this template?").Replace("'", "\\'"))',
            copyUnderDev: '@Html.Raw(Html.T("ميزة النسخ قيد التطوير", "Copy feature is under development").Replace("'", "\\'"))',
            confirmDelete: '@Html.Raw(Html.T("هل أنت متأكد من حذف هذا القالب؟\n\nسيتم حذف جميع التقارير المجدولة المرتبطة به.", "Are you sure you want to delete this template?\n\nAll scheduled reports linked to it will be deleted.").Replace("'", "\\'").Replace("\n", "\\n"))'
        };
        function validateJSON() {
            const jsonText = $('#configEditor').val();
            try {
                const parsed = JSON.parse(jsonText);
                alert(window.__AdvReportEditT.jsonValid + '\n\n' + window.__AdvReportEditT.fieldsLabel + ' ' + Object.keys(parsed).length);
                return true;
            } catch (e) {
                alert(window.__AdvReportEditT.jsonError + '\n\n' + e.message);
                return false;
            }
        }

        function formatJSON() {
            try {
                const jsonText = $('#configEditor').val();
                const parsed = JSON.parse(jsonText);
                const formatted = JSON.stringify(parsed, null, 2);
                $('#configEditor').val(formatted);
                alert(window.__AdvReportEditT.jsonFormatted);
            } catch (e) {
                alert(window.__AdvReportEditT.jsonInvalid);
            }
        }

        function resetConfig() {
            if (confirm(window.__AdvReportEditT.confirmReset)) {
                $('#configEditor').val(originalConfig);
            }
        }

        function saveAsDraft() {
            alert(window.__AdvReportEditT.draftUnderDev);
        }

        function testTemplate() {
            if (validateJSON()) {
                alert(window.__AdvReportEditT.testUnderDev.replace(/\\n/g, '\n'));
            }
        }

        function duplicateTemplate() {
            if (confirm(window.__AdvReportEditT.confirmDuplicate)) {
                alert(window.__AdvReportEditT.copyUnderDev);
            }
        }

        function exportTemplate() {
            const data = {
                name: $('#Name').val(),
                description: $('#Description').val(),
                reportType: $('#reportTypeInput').val(),
                configuration: $('#configEditor').val()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'template_' + data.name.replace(/\s+/g, '_') + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function deleteTemplate() {
            if (confirm(window.__AdvReportEditT.confirmDelete.replace(/\\n/g, '\n'))) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteTemplate", new { id = Model.Id })';
                
                const token = document.createElement('input');
                token.type = 'hidden';
                token.name = '__RequestVerificationToken';
                token.value = $('input[name="__RequestVerificationToken"]').val();
                form.appendChild(token);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}

