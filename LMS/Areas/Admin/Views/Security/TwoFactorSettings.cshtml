@model IEnumerable<LMS.Domain.Entities.Security.TwoFactorSetting>

@{
    ViewData["Title"] = Html.T("إعدادات المصادقة الثنائية", "Two-factor settings");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("لوحة التحكم", "Dashboard"), Url.Action("Index", "Dashboard")),
        (Html.T("الأمان", "Security"), Url.Action("Dashboard", "Security")),
        (Html.T("المصادقة الثنائية", "Two-factor authentication"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-2">إجمالي المستخدمين</p>
                            <h3 class="fw-bold mb-0">@Model.Count()</h3>
                        </div>
                        <div class="avatar-text avatar-lg bg-soft-primary text-primary">
                            <i class="feather-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-2">مفعلة</p>
                            <h3 class="fw-bold mb-0 text-success">@Model.Count(s => s.IsEnabled)</h3>
                        </div>
                        <div class="avatar-text avatar-lg bg-soft-success text-success">
                            <i class="feather-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-2">معطلة</p>
                            <h3 class="fw-bold mb-0 text-warning">@Model.Count(s => !s.IsEnabled)</h3>
                        </div>
                        <div class="avatar-text avatar-lg bg-soft-warning text-warning">
                            <i class="feather-x-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-2">نسبة التفعيل</p>
                            <h3 class="fw-bold mb-0 text-info">
                                @(Model.Any() ? ((Model.Count(s => s.IsEnabled) * 100.0 / Model.Count()).ToString("F1")) : "0")%
                            </h3>
                        </div>
                        <div class="avatar-text avatar-lg bg-soft-info text-info">
                            <i class="feather-shield"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Settings List -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>@Html.T("المستخدم", "User")</th>
                            <th>@Html.T("الطريقة", "Method")</th>
                            <th>@Html.T("تاريخ التفعيل", "Enabled date")</th>
                            <th>@Html.T("آخر استخدام", "Last used")</th>
                            <th>@Html.T("الحالة", "Status")</th>
                            <th>@Html.T("الإجراءات", "Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var setting in Model.OrderByDescending(s => s.CreatedAt))
                        {
                            <tr>
                                <td>
                                    @if (setting.User != null)
                                    {
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="avatar-text avatar-sm @(setting.IsEnabled ? "bg-soft-success text-success" : "bg-soft-secondary text-secondary")">
                                                @(setting.User.FirstName?.Length > 0 ? setting.User.FirstName.Substring(0, 1).ToUpper() : "")@(setting.User.LastName?.Length > 0 ? setting.User.LastName.Substring(0, 1).ToUpper() : "")
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@(setting.User.FirstName ?? "") @(setting.User.LastName ?? "")</div>
                                                <small class="text-muted">@setting.User.Email</small>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">مستخدم محذوف</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-soft-primary text-primary">
                                        <i class="feather-smartphone me-1"></i>@setting.Method
                                    </span>
                                </td>
                                <td>
                                    <div>@setting.CreatedAt.ToString("yyyy/MM/dd")</div>
                                    <small class="text-muted">@setting.CreatedAt.ToString("hh:mm tt")</small>
                                </td>
                                <td>
                                    @if (setting.LastUsedAt.HasValue)
                                    {
                                        <div>@setting.LastUsedAt.Value.ToString("yyyy/MM/dd")</div>
                                        <small class="text-muted">@setting.LastUsedAt.Value.ToString("hh:mm tt")</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">لم يستخدم بعد</span>
                                    }
                                </td>
                                <td>
                                    @if (setting.IsEnabled)
                                    {
                                        <span class="badge bg-soft-success text-success">
                                            <i class="feather-check me-1"></i>مفعلة
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-secondary text-secondary">
                                            <i class="feather-x me-1"></i>معطلة
                                        </span>
                                        @if (setting.DisabledAt.HasValue)
                                        {
                                            <br><small class="text-muted">@setting.DisabledAt.Value.ToString("yyyy/MM/dd")</small>
                                        }
                                    }
                                </td>
                                <td>
                                    <div class="hstack gap-2">
                                        <a asp-action="TwoFactorDetails" asp-route-id="@setting.Id" class="btn btn-sm btn-light" title="@Html.T("التفاصيل", "Details")">
                                            <i class="feather-eye"></i>
                                        </a>
                                        @if (setting.IsEnabled)
                                        {
                                            <form asp-action="DisableTwoFactor" asp-route-id="@setting.Id" method="post" class="d-inline" onsubmit="return confirm('@(Html.Raw(Html.T("هل أنت متأكد من تعطيل المصادقة الثنائية لهذا المستخدم؟", "Are you sure you want to disable two-factor authentication for this user?").ToString().Replace("'", "\\'")))')">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger" title="@Html.T("تعطيل", "Disable")">
                                                    <i class="feather-x-circle"></i>
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <div class="avatar-text avatar-xl bg-soft-secondary text-secondary mx-auto mb-3">
                        <i class="feather-shield" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">@Html.T("لا توجد إعدادات للمصادقة الثنائية", "No two-factor authentication settings")</h5>
                    <p class="text-muted">لم يقم أي مستخدم بتفعيل المصادقة الثنائية بعد</p>
                </div>
            }
            else
            {
                @* Pagination *@
                var currentPage = (int)(ViewBag.Page ?? 1);
                var hasMore = Model.Count() == 20;
                
                <div class="d-flex justify-content-between align-items-center mt-4 px-3 pb-3">
                    <div class="text-muted small">
                        عرض @Model.Count() إعداد - صفحة @currentPage
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            @if (currentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="TwoFactorSettings" 
                                       asp-route-page="@(currentPage - 1)" 
                                       asp-route-userId="@ViewBag.UserId">
                                        <i class="feather-chevron-right"></i> السابق
                                    </a>
                                </li>
                            }
                            <li class="page-item active"><span class="page-link">@currentPage</span></li>
                            @if (hasMore)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="TwoFactorSettings" 
                                       asp-route-page="@(currentPage + 1)" 
                                       asp-route-userId="@ViewBag.UserId">
                                        التالي <i class="feather-chevron-left"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

