@using LMS.Areas.Admin.ViewModels
@model List<PermissionViewModel>

@{
    ViewData["Title"] = Html.T("إدارة الصلاحيات", "Permission Management");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الأمان", "Security"), Url.Action("Index", "Security")),
        (Html.T("الصلاحيات", "Permissions"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var roles = ViewBag.Roles as List<Microsoft.AspNetCore.Identity.IdentityRole> ?? new List<Microsoft.AspNetCore.Identity.IdentityRole>();
    var permissionsByCategory = Model.GroupBy(p => p.Category).ToList();
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("مصفوفة الصلاحيات", "Permission Matrix")</h5>
                    <p class="text-muted small mb-0">@Html.T("تحكم في صلاحيات كل دور في النظام", "Control permissions for each role in the system")</p>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="feather-info me-2"></i>
                        <strong>@Html.T("ملاحظة:", "Note:")</strong> @Html.T("الصلاحيات هنا للعرض فقط. يتم تعيين الصلاحيات تلقائياً بناءً على الدور. لتخصيص الصلاحيات بشكل متقدم، يرجى التواصل مع المطورين.", "Permissions here are read-only. Permissions are assigned automatically based on role. For advanced permission customization, please contact developers.")
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 300px;">@Html.T("الصلاحية", "Permission")</th>
                                    @foreach (var role in roles)
                                    {
                                        <th class="text-center">@role.Name</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var category in permissionsByCategory)
                                {
                                    <tr class="table-secondary">
                                        <td colspan="@(roles.Count + 1)" class="fw-bold">
                                            <i class="feather-folder me-2"></i>
                                            @category.Key
                                        </td>
                                    </tr>
                                    @foreach (var permission in category)
                                    {
                                        <tr>
                                            <td>
                                                <span class="ms-3">@permission.DisplayName</span>
                                                <small class="text-muted d-block ms-3">@permission.Name</small>
                                            </td>
                                            @foreach (var role in roles)
                                            {
                                                var isAdmin = role.Name?.Equals("Admin", StringComparison.OrdinalIgnoreCase) ?? false;
                                                var isInstructor = role.Name?.Equals("Instructor", StringComparison.OrdinalIgnoreCase) ?? false;
                                                var isStudent = role.Name?.Equals("Student", StringComparison.OrdinalIgnoreCase) ?? false;
                                                
                                                // Admin has all permissions
                                                var hasPermission = isAdmin;
                                                
                                                // Instructor permissions
                                                if (isInstructor && (permission.Name.Contains("Courses") || permission.Name.Contains("Reports.View")))
                                                {
                                                    hasPermission = true;
                                                }
                                                
                                                <td class="text-center">
                                                    @if (hasPermission)
                                                    {
                                                        <span class="text-success">
                                                            <i class="feather-check-circle"></i>
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">
                                                            <i class="feather-x-circle"></i>
                                                        </span>
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

