@using LMS.Areas.Admin.Controllers
@{
    ViewData["Title"] = Html.T("إعدادات الإشعارات الفورية", "Push notification settings");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإعدادات", "Settings"), Url.Action("Index", "Settings")),
        (Html.T("الإشعارات الفورية", "Push notifications"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    
    var settings = ViewBag.Settings as PushNotificationSettingsViewModel ?? new PushNotificationSettingsViewModel();
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <form asp-action="Index" method="post">
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Firebase Cloud Messaging (FCM)", "Firebase Cloud Messaging (FCM)")</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-4">
                            <input type="hidden" name="Enabled" value="false" />
                            <input class="form-check-input" type="checkbox" id="enablePushNotifications" name="Enabled" value="true" @(settings.Enabled ? "checked" : "")>
                            <label class="form-check-label" for="enablePushNotifications">
                                <strong>@Html.T("تفعيل الإشعارات الفورية", "Enable push notifications")</strong>
                            </label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@Html.T("مفتاح الخادم", "Server Key")</label>
                            <input type="password" class="form-control" name="ServerKey" value="@settings.ServerKey" placeholder="AAAA......" />
                            <small class="text-muted">@Html.T("يمكنك الحصول عليه من Firebase Console", "You can get it from Firebase Console")</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@Html.T("معرف المرسل", "Sender ID")</label>
                            <input type="text" class="form-control" name="SenderId" value="@settings.SenderId" placeholder="123456789" />
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("Web Push (VAPID)", "Web Push (VAPID)")</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">@Html.T("مفاتيح VAPID مطلوبة لإشعارات الويب للمدرسين. المفتاح الخاص لا يُعرض ولا يُرسل للعميل.", "VAPID keys are required for web notifications to instructors. The private key is not displayed or sent to the client.")</p>
                        <div class="mb-3">
                            <label class="form-label">@Html.T("المفتاح العام (VAPID Public Key)", "Public key (VAPID)")</label>
                            <input type="text" class="form-control font-monospace" name="VAPIDPublicKey" value="@settings.VAPIDPublicKey" placeholder="BEl62iUYgUivxIkv69yViEuiBIa-Ib27..." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@Html.T("المفتاح الخاص (VAPID Private Key)", "Private key (VAPID)")</label>
                            <input type="password" class="form-control font-monospace" name="VAPIDPrivateKey" value="@settings.VAPIDPrivateKey" placeholder="UUd8..." autocomplete="off" />
                            <small class="text-muted">@Html.T("اتركه فارغاً إذا كنت لا تريد تغييره. استخدم \"توليد مفاتيح\" لإنشاء زوج جديد.", "Leave empty if you don't want to change it. Use \"Generate keys\" to create a new pair.")</small>
                        </div>
                        <button type="button" class="btn btn-outline-secondary" id="generateVapidKeys">
                            <i class="feather-key me-2"></i>توليد مفاتيح VAPID
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("أنواع الإشعارات", "Notification types")</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input type="hidden" name="NotifyNewCourse" value="false" />
                            <input class="form-check-input" type="checkbox" id="notifyNewCourse" name="NotifyNewCourse" value="true" @(settings.NotifyNewCourse ? "checked" : "")>
                            <label class="form-check-label" for="notifyNewCourse">
                                دورة جديدة
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input type="hidden" name="NotifyEnrollment" value="false" />
                            <input class="form-check-input" type="checkbox" id="notifyEnrollment" name="NotifyEnrollment" value="true" @(settings.NotifyEnrollment ? "checked" : "")>
                            <label class="form-check-label" for="notifyEnrollment">
                                تسجيل جديد
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input type="hidden" name="NotifyLiveClass" value="false" />
                            <input class="form-check-input" type="checkbox" id="notifyLiveClass" name="NotifyLiveClass" value="true" @(settings.NotifyLiveClass ? "checked" : "")>
                            <label class="form-check-label" for="notifyLiveClass">
                                حصة مباشرة
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input type="hidden" name="NotifyAssignment" value="false" />
                            <input class="form-check-input" type="checkbox" id="notifyAssignment" name="NotifyAssignment" value="true" @(settings.NotifyAssignment ? "checked" : "")>
                            <label class="form-check-label" for="notifyAssignment">
                                مهمة جديدة
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input type="hidden" name="NotifyCertificate" value="false" />
                            <input class="form-check-input" type="checkbox" id="notifyCertificate" name="NotifyCertificate" value="true" @(settings.NotifyCertificate ? "checked" : "")>
                            <label class="form-check-label" for="notifyCertificate">
                                شهادة جديدة
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("إجراءات", "Actions")</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>
                                @Html.T("حفظ الإعدادات", "Save settings")
                            </button>
                            <button type="button" class="btn btn-light" id="sendTestNotification">
                                <i class="feather-send me-2"></i>
                                إرسال إشعار تجريبي
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الإحصائيات", "Statistics")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small">@Html.T("إشعارات اليوم", "Notifications today")</label>
                            <h4 class="text-primary mb-0">@(ViewBag.NotificationsToday ?? 0)</h4>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">@Html.T("معدل النقر", "Click rate")</label>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" style="width: @(ViewBag.ClickRate ?? 0)%"></div>
                            </div>
                            <span class="small">@(ViewBag.ClickRate ?? 0)%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        window.__PushIndexT = {
            generating: '@Html.Raw(Html.T("جارٍ التوليد...", "Generating...").Replace("'", "\\'"))',
            sending: '@Html.Raw(Html.T("جارٍ الإرسال...", "Sending...").Replace("'", "\\'"))',
            successPrefix: '@Html.Raw(Html.T("✅ تم بنجاح:", "✅ Success:").Replace("'", "\\'"))',
            errorPrefix: '@Html.Raw(Html.T("❌ خطأ:", "❌ Error:").Replace("'", "\\'"))'
        };
        $(document).ready(function() {
            $('#generateVapidKeys').on('click', function() {
                var btn = $(this);
                if (!confirm('@Html.Raw(Html.T("سيتم توليد مفاتيح VAPID جديدة وحفظها. هل تريد المتابعة؟", "New VAPID keys will be generated and saved. Do you want to continue?").ToString().Replace("'", "\\'"))')) return;
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="feather-loader me-2"></i>' + window.__PushIndexT.generating);
                $.ajax({
                    url: '@Url.Action("GenerateVapidKeys", "PushNotificationSettings")',
                    method: 'POST',
                    data: { __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                    success: function(response) {
                        if (response.success) {
                            alert(window.__PushIndexT.successPrefix + ' ' + (response.message || ''));
                            location.reload();
                        } else {
                            alert(window.__PushIndexT.errorPrefix + ' ' + (response.message || ''));
                        }
                    },
                    error: function() { alert('@Html.Raw(Html.T("حدث خطأ أثناء توليد المفاتيح", "Error generating keys").Replace("'", "\\'"))'); },
                    complete: function() { btn.prop('disabled', false).html(originalHtml); }
                });
            });
            $('#sendTestNotification').on('click', function() {
                var btn = $(this);
                var originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="feather-loader me-2"></i>' + window.__PushIndexT.sending);
                $.ajax({
                    url: '@Url.Action("SendTestNotification", "PushNotificationSettings")',
                    method: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(window.__PushIndexT.successPrefix + ' ' + (response.message || ''));
                        } else {
                            alert(window.__PushIndexT.errorPrefix + ' ' + (response.message || ''));
                        }
                    },
                    error: function() {
                        alert('@Html.Raw(Html.T("حدث خطأ أثناء إرسال الإشعار التجريبي", "Error sending test notification").Replace("'", "\\'"))');
                    },
                    complete: function() {
                        btn.prop('disabled', false).html(originalHtml);
                    }
                });
            });
        });
    </script>
}
