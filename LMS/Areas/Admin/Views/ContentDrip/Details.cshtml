@model LMS.Domain.Entities.Courses.ContentDripRule

@{
    ViewData["Title"] = Html.T("تفاصيل قاعدة الجدولة", "Content drip rule details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة المحتوى", "Content Management"), null),
        (Html.T("جدولة المحتوى", "Content Scheduling"), Url.Action("Index", "ContentDrip")),
        (Html.T("تفاصيل القاعدة", "Rule Details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("تعديل", "Edit"), "feather-edit", Url.Action("Edit", "ContentDrip", new { id = Model.Id }), "btn-primary"),
        (Html.T("حذف", "Delete"), "feather-trash-2", "javascript:void(0)", "btn-danger delete-btn")
    };
    ViewData["HeaderActions"] = actions;
}

@section Styles {
    <style>
        .drip-info-card {
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 30px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            margin-bottom: 30px;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="drip-info-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-3">
                    <i class="feather-clock text-primary me-2"></i>
                    @(Model.DripType switch
                    {
                        ContentDripType.ByDays => "جدولة بعد " + Model.DaysAfterEnrollment + " أيام",
                        ContentDripType.ByDate => "جدولة في " + Model.SpecificDate?.ToString("dd/MM/yyyy"),
                        ContentDripType.ByWeekDay => "جدولة أسبوعية",
                        _ => "قاعدة جدولة"
                    })
                </h2>
                <div class="d-flex gap-2 flex-wrap">
                    @if (Model.IsActive)
                    {
                        <span class="badge bg-success fs-6">
                            <i class="feather-check-circle me-1"></i>نشطة
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-secondary fs-6">غير نشطة</span>
                    }
                    @if (Model.SendNotification)
                    {
                        <span class="badge bg-info fs-6">
                            <i class="feather-bell me-1"></i>مع إشعار
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>@Html.T("معلومات القاعدة", "Rule Information")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("الدورة", "Course")</small>
                                <h6 class="mb-0">
                                    <a asp-area="Admin" asp-controller="Courses" asp-action="Details" asp-route-id="@Model.CourseId">
                                        @Model.Course.Title
                                    </a>
                                </h6>
                            </div>
                        </div>
                        @if (Model.Module != null)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("الوحدة", "Module")</small>
                                    <h6 class="mb-0">@Model.Module.Title</h6>
                                </div>
                            </div>
                        }
                        @if (Model.Lesson != null)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("الدرس", "Lesson")</small>
                                    <h6 class="mb-0">@Model.Lesson.Title</h6>
                                </div>
                            </div>
                        }
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("نوع الجدولة", "Schedule Type")</small>
                                <h6 class="mb-0">
                                    @(Model.DripType switch
                                    {
                                        ContentDripType.ByDays => Html.T("بعد عدد أيام", "After X days"),
                                        ContentDripType.ByDate => Html.T("في تاريخ محدد", "On specific date"),
                                        ContentDripType.ByWeekDay => Html.T("في يوم من الأسبوع", "On a weekday"),
                                        _ => Html.T("غير محدد", "Not set")
                                    })
                                </h6>
                            </div>
                        </div>
                        @if (Model.DaysAfterEnrollment.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("عدد الأيام", "Days count")</small>
                                    <h6 class="mb-0 text-primary">@Model.DaysAfterEnrollment @Html.T("يوم", "day(s)")</h6>
                                </div>
                            </div>
                        }
                        @if (Model.SpecificDate.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("التاريخ المحدد", "Specific date")</small>
                                    <h6 class="mb-0">@Model.SpecificDate.Value.ToString("dd/MM/yyyy hh:mm tt")</h6>
                                </div>
                            </div>
                        }
                        @if (Model.DayOfWeek.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("يوم الأسبوع", "Day of week")</small>
                                    <h6 class="mb-0">
                                        @(Model.DayOfWeek.Value switch
                                        {
                                            0 => Html.T("الأحد", "Sunday"),
                                            1 => Html.T("الاثنين", "Monday"),
                                            2 => Html.T("الثلاثاء", "Tuesday"),
                                            3 => Html.T("الأربعاء", "Wednesday"),
                                            4 => Html.T("الخميس", "Thursday"),
                                            5 => Html.T("الجمعة", "Friday"),
                                            6 => Html.T("السبت", "Saturday"),
                                            _ => Html.T("غير محدد", "Not set")
                                        })
                                    </h6>
                                </div>
                            </div>
                        }
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <small class="text-muted d-block mb-1">@Html.T("ساعة الإتاحة", "Release hour")</small>
                                <h6 class="mb-0">@Model.ReleaseHour:00</h6>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.TimeZone))
                        {
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <small class="text-muted d-block mb-1">@Html.T("المنطقة الزمنية", "Time zone")</small>
                                    <h6 class="mb-0">@Model.TimeZone</h6>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (Model.SendNotification)
            {
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-bell me-2"></i>@Html.T("إعدادات الإشعار", "Notification settings")
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">@Html.T("عنوان الإشعار", "Notification title")</small>
                            <h6>@Model.NotificationTitle</h6>
                        </div>
                        <div>
                            <small class="text-muted d-block mb-1">@Html.T("رسالة الإشعار", "Notification message")</small>
                            <p class="mb-0">@Model.NotificationMessage</p>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-activity me-2"></i>@Html.T("الحالة", "Status")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("القاعدة:", "Rule:")</span>
                            @if (Model.IsActive)
                            {
                                <span class="badge bg-soft-success text-success">@Html.T("نشطة", "Active")</span>
                            }
                            else
                            {
                                <span class="badge bg-soft-secondary text-secondary">@Html.T("غير نشطة", "Inactive")</span>
                            }
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("تاريخ الإنشاء:", "Created:")</span>
                            <span class="fw-semibold">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">@Html.T("آخر تحديث:", "Last updated:")</span>
                                <span class="fw-semibold">@Model.UpdatedAt.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-zap me-2"></i>@Html.T("إجراءات سريعة", "Quick actions")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-light-brand">
                            <i class="feather-edit me-2"></i>@Html.T("تعديل القاعدة", "Edit rule")
                        </a>
                        <form asp-action="ToggleStatus" asp-route-id="@Model.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-light-brand w-100">
                                @if (Model.IsActive)
                                {
                                    <i class="feather-eye-off me-2"></i>
                                    <span>@Html.T("تعطيل", "Disable")</span>
                                }
                                else
                                {
                                    <i class="feather-eye me-2"></i>
                                    <span>@Html.T("تفعيل", "Enable")</span>
                                }
                            </button>
                        </form>
                        <hr>
                        <button type="button" class="btn btn-danger delete-btn">
                            <i class="feather-trash-2 me-2"></i>@Html.T("حذف القاعدة", "Delete rule")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form asp-action="Delete" asp-route-id="@Model.Id" method="post" id="deleteForm">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        $('.delete-btn').click(function() {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذه القاعدة؟", "Are you sure you want to delete this rule?").Replace("'", "\\'"))')) {
                $('#deleteForm').submit();
            }
        });
    </script>
}

