@model LMS.Domain.Entities.Content.Document

@{
    ViewData["Title"] = Html.T("تفاصيل المستند", "Document details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("المحتوى", "Content"), null),
        (Html.T("المستندات", "Documents"), Url.Action("Index", "Documents")),
        (Html.T("تفاصيل المستند", "Document details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .document-preview {
            background: var(--gradient-hero, linear-gradient(135deg, #004aad 0%, #0055c4 50%, #1a5cb9 100%));
            color: white;
            padding: 50px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .file-icon {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .info-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            border-right: 3px solid #e5e7eb;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .info-item:hover {
            background: white;
            border-right-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Document Preview -->
    <div class="document-preview">
        <div class="file-icon">
            <i class="@(Model.DocumentType switch
            {
                "PDF" => "feather-file-text",
                "Word" => "feather-file",
                "Excel" => "feather-grid",
                "PowerPoint" => "feather-file-text",
                "Image" => "feather-image",
                "Video" => "feather-video",
                "Audio" => "feather-music",
                _ => "feather-file"
            })" style="font-size: 5rem;"></i>
        </div>
        <h2 class="text-white mb-3">@Model.Title</h2>
        <p class="text-white-50 mb-4">@Model.Description</p>
        <div class="d-flex justify-content-center gap-3">
            <span class="badge bg-white bg-opacity-25 px-3 py-2">
                <i class="feather-file me-2"></i>
                @Model.DocumentType
            </span>
            <span class="badge bg-white bg-opacity-25 px-3 py-2">
                <i class="feather-hard-drive me-2"></i>
                @FormatFileSize(Model.FileSize)
            </span>
            <span class="badge bg-white bg-opacity-25 px-3 py-2">
                <i class="feather-download me-2"></i>
                @Model.DownloadCount تحميل
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- File Info -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>
                        معلومات الملف
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-text bg-soft-primary text-primary avatar-md">
                                        <i class="feather-file-text"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">نوع المستند</small>
                                        <h6 class="fw-bold mb-0">@Model.DocumentType</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-text bg-soft-success text-success avatar-md">
                                        <i class="feather-hard-drive"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">حجم الملف</small>
                                        <h6 class="fw-bold mb-0">@FormatFileSize(Model.FileSize)</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-text bg-soft-info text-info avatar-md">
                                        <i class="feather-calendar"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">تاريخ الرفع</small>
                                        <h6 class="fw-bold mb-0">@Model.UploadedAt.ToString("dd/MM/yyyy")</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-text bg-soft-warning text-warning avatar-md">
                                        <i class="feather-download"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">عدد التحميلات</small>
                                        <h6 class="fw-bold mb-0">@Model.DownloadCount</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-align-right me-2"></i>
                            الوصف
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="lead">@Model.Description</p>
                    </div>
                </div>
            }

            <!-- File Path & URL -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-link me-2"></i>
                        معلومات تقنية
                        </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div>
                            <label class="text-muted fw-semibold mb-2">@Html.T("مسار الملف:", "File path:")</label>
                            <div class="input-group">
                                <input type="text" class="form-control" value="@Model.FilePath" readonly id="filePath" />
                                <button class="btn btn-light" onclick="copyToClipboard('#filePath')">
                                    <i class="feather-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-muted fw-semibold mb-2">@Html.T("رابط الملف:", "File URL:")</label>
                            <div class="input-group">
                                <input type="text" class="form-control" value="@(Model.FileUrl ?? Html.T("غير متوفر", "Not available"))" readonly id="fileUrl" />
                                <button class="btn btn-light" onclick="copyToClipboard('#fileUrl')" @(string.IsNullOrEmpty(Model.FileUrl) ? "disabled" : "")>
                                    <i class="feather-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Statistics -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-bar-chart me-2"></i>
                        إحصائيات التحميل
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">إجمالي التحميلات</span>
                            <span class="fw-bold text-primary">@Model.DownloadCount</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" style="width: @(Model.DownloadCount > 0 ? Math.Min(100, Model.DownloadCount) : 5)%"></div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="feather-info me-2"></i>
                        <strong>معلومة:</strong> إحصائيات التحميل التفصيلية قيد التطوير
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-zap me-2"></i>
                        @Html.T("إجراءات سريعة", "Quick actions")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (!string.IsNullOrEmpty(Model.FileUrl))
                        {
                            <a href="@Model.FileUrl" class="btn btn-primary" download>
                                <i class="feather-download me-2"></i>
                                تحميل الملف
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-light" disabled>
                                <i class="feather-alert-circle me-2"></i>
                                الملف غير متوفر
                            </button>
                        }
                        <button type="button" class="btn btn-light-brand" onclick="previewFile()">
                            <i class="feather-eye me-2"></i>
                            معاينة الملف
                        </button>
                        <button type="button" class="btn btn-light-brand" onclick="shareDocument()">
                            <i class="feather-share-2 me-2"></i>
                            مشاركة المستند
                        </button>
                        <button type="button" class="btn btn-light-brand" onclick="generateQRCode()">
                            <i class="feather-grid me-2"></i>
                            إنشاء رمز QR
                        </button>
                        <hr class="my-2">
                        <button type="button" class="btn btn-danger" onclick="deleteDocument()">
                            <i class="feather-trash-2 me-2"></i>
                            حذف المستند
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meta Information -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>
                        معلومات إضافية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">المعرف:</span>
                            <span class="fw-semibold">#@Model.Id</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">تاريخ الرفع:</span>
                            <span class="fw-semibold">@Model.UploadedAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">وقت الرفع:</span>
                            <span class="fw-semibold">@Model.UploadedAt.ToString("HH:mm")</span>
                        </div>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">آخر تحديث:</span>
                                <span class="fw-semibold">@Model.UpdatedAt.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- File Type Info -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-file me-2"></i>
                        معلومات نوع الملف
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar-text @(Model.DocumentType switch
                        {
                            "PDF" => "bg-soft-danger text-danger",
                            "Word" => "bg-soft-primary text-primary",
                            "Excel" => "bg-soft-success text-success",
                            "PowerPoint" => "bg-soft-warning text-warning",
                            "Image" => "bg-soft-info text-info",
                            _ => "bg-soft-secondary text-secondary"
                        }) avatar-xl mx-auto mb-3">
                            <i class="@(Model.DocumentType switch
                            {
                                "PDF" => "feather-file-text",
                                "Word" => "feather-file",
                                "Excel" => "feather-grid",
                                "PowerPoint" => "feather-file-text",
                                "Image" => "feather-image",
                                _ => "feather-file"
                            })" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="fw-bold mb-1">@Model.DocumentType</h6>
                        <p class="text-muted small mb-0">نوع المستند</p>
                    </div>
                    <div class="alert alert-light mb-0">
                        <i class="feather-info me-2"></i>
                        <small>يمكن فتح هذا الملف باستخدام التطبيقات المناسبة</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Form -->
<form id="deleteForm" asp-action="Delete" asp-route-id="@Model.Id" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        window.__DocT = {
            confirmDelete: '@Html.Raw(Html.T("هل أنت متأكد من حذف هذا المستند؟ سيتم حذف الملف نهائياً من الخادم.", "Are you sure you want to delete this document? The file will be permanently deleted from the server.").Replace("'", "\\'"))',
            copiedToClipboard: '@Html.Raw(Html.T("تم نسخ النص إلى الحافظة!", "Text copied to clipboard!").Replace("'", "\\'"))',
            fileNotAvailable: '@Html.Raw(Html.T("الملف غير متوفر للمعاينة", "File is not available for preview").Replace("'", "\\'"))',
            linkCopied: '@Html.Raw(Html.T("تم نسخ الرابط إلى الحافظة!", "Link copied to clipboard!").Replace("'", "\\'"))',
            qrInDevelopment: '@Html.Raw(Html.T("ميزة إنشاء رمز QR قيد التطوير", "QR code generation feature is under development").Replace("'", "\\'"))'
        };
        function deleteDocument() {
            if (confirm(window.__DocT.confirmDelete)) {
                document.getElementById('deleteForm').submit();
            }
        }

        function copyToClipboard(selector) {
            const input = document.querySelector(selector);
            if (input && input.value && input.value !== 'غير متوفر') {
                input.select();
                document.execCommand('copy');
                alert(window.__DocT.copiedToClipboard);
            }
        }

        function previewFile() {
            @if (!string.IsNullOrEmpty(Model.FileUrl))
            {
                <text>
                window.open('@Model.FileUrl', '_blank');
                </text>
            }
            else
            {
                <text>
                alert(window.__DocT.fileNotAvailable);
                </text>
            }
        }

        function shareDocument() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: '@Model.Title',
                    text: '@Model.Description',
                    url: url
                }).catch(() => {
                    copyUrlToClipboard(url);
                });
            } else {
                copyUrlToClipboard(url);
            }
        }

        function copyUrlToClipboard(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert(window.__DocT.linkCopied);
            });
        }

        function generateQRCode() {
            alert(window.__DocT.qrInDevelopment);
        }
    </script>
}

@functions {
    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

