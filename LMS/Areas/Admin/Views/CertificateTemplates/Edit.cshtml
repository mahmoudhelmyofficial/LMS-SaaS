@model LMS.Areas.Admin.ViewModels.CertificateTemplateEditViewModel

@{
    ViewData["Title"] = Html.T("تعديل قالب الشهادة", "Edit certificate template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("قوالب الشهادات", "Certificate templates"), Url.Action("Index", "CertificateTemplates")),
        (Html.T("تعديل قالب", "Edit template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <link rel="stylesheet" href="~/assets/vendors/css/editors/quill/quill.snow.css" />
    <style>
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            min-height: 300px;
        }
        .preview-iframe {
            width: 100%;
            min-height: 400px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .usage-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    @if (Model.UsageCount > 0)
    {
        <div class="alert alert-warning d-flex align-items-center">
            <i class="feather-alert-triangle fs-4 me-3"></i>
            <div>
                <strong>@Html.T("تنبيه:", "Warning:")</strong> @Html.T("هذا القالب مستخدم في", "This template is used in") <strong>@Model.UsageCount</strong> @Html.T("شهادة. التعديلات لن تؤثر على الشهادات الصادرة سابقاً.", "certificate(s). Changes will not affect previously issued certificates.")
            </div>
        </div>
    }

    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("معلومات القالب", "Template information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="Name">@Html.T("اسم القالب", "Template name") <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="Name" placeholder="@Html.T("مثال: قالب الشهادة الأساسي", "e.g. Basic certificate template")" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Description">@Html.T("الوصف", "Description")</label>
                                <textarea class="form-control" asp-for="Description" rows="3" placeholder="@Html.T("وصف مختصر عن القالب...", "Brief description of the template...")"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" asp-for="Width">@Html.T("العرض (بكسل)", "Width (px)") <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" asp-for="Width" required />
                                <span asp-validation-for="Width" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" asp-for="Height">@Html.T("الارتفاع (بكسل)", "Height (px)") <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" asp-for="Height" required />
                                <span asp-validation-for="Height" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label" asp-for="Orientation">@Html.T("الاتجاه", "Orientation") <span class="text-danger">*</span></label>
                                <select class="form-select" asp-for="Orientation" required>
                                    <option value="">@Html.T("اختر الاتجاه", "Select orientation")</option>
                                    <option value="Landscape">@Html.T("أفقي (Landscape)", "Landscape")</option>
                                    <option value="Portrait">@Html.T("عمودي (Portrait)", "Portrait")</option>
                                </select>
                                <span asp-validation-for="Orientation" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="BackgroundImageUrl">@Html.T("رابط صورة الخلفية", "Background image URL")</label>
                                <input type="url" class="form-control" asp-for="BackgroundImageUrl" placeholder="https://example.com/background.jpg" />
                                <span asp-validation-for="BackgroundImageUrl" class="text-danger"></span>
                                <small class="text-muted">@Html.T("اترك فارغاً لاستخدام الخلفية الافتراضية", "Leave empty to use default background")</small>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="HtmlContent">@Html.T("محتوى HTML", "HTML content") <span class="text-danger">*</span></label>
                                <textarea class="form-control code-editor" asp-for="HtmlContent" rows="15" required></textarea>
                                <span asp-validation-for="HtmlContent" class="text-danger"></span>
                                <small class="text-muted">
                                    المتغيرات المتاحة: {{StudentName}}, {{CourseName}}, {{InstructorName}}, {{CompletionDate}}, {{CertificateNumber}}, {{Grade}}
                                </small>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="CssStyles">@Html.T("أنماط CSS", "CSS styles")</label>
                                <textarea class="form-control code-editor" asp-for="CssStyles" rows="10"></textarea>
                                <span asp-validation-for="CssStyles" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Settings -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("الإعدادات", "Settings")</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="IsActive" id="isActive" />
<label class="form-check-label" for="isActive">@Html.T("قالب نشط", "Active template")</label>
                                </div>
                                <small class="text-muted">@Html.T("القوالب النشطة متاحة للاستخدام", "Active templates are available for use")</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="IsDefault" id="isDefault" />
<label class="form-check-label" for="isDefault">@Html.T("قالب افتراضي", "Default template")</label>
                                </div>
                                <small class="text-muted">@Html.T("سيتم استخدامه كقالب افتراضي للشهادات الجديدة", "Will be used as default template for new certificates")</small>
                        </div>

                        @if (Model.UsageCount > 0)
                        {
                            <div class="usage-warning mt-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="feather-info text-warning"></i>
                                    <strong>@Html.T("الاستخدام", "Usage")</strong>
                                </div>
                                <p class="mb-0 fs-12">
                                    تم استخدام هذا القالب في <strong>@Model.UsageCount</strong> شهادة
                                </p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Variables Guide -->
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("دليل المتغيرات", "Variables guide")</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <small>@Html.T("استخدم هذه المتغيرات في محتوى HTML", "Use these variables in HTML content")</small>
                        </div>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{StudentName}}</code>
                                <small class="text-muted">@Html.T("اسم الطالب", "Student name")</small>
                            </div>
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{CourseName}}</code>
                                <small class="text-muted">@Html.T("اسم الدورة", "Course name")</small>
                            </div>
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{InstructorName}}</code>
                                <small class="text-muted">@Html.T("اسم المدرب", "Instructor name")</small>
                            </div>
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{CompletionDate}}</code>
                                <small class="text-muted">@Html.T("تاريخ الإتمام", "Completion date")</small>
                            </div>
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{CertificateNumber}}</code>
                                <small class="text-muted">@Html.T("رقم الشهادة", "Certificate number")</small>
                            </div>
                            <div class="list-group-item px-0 d-flex flex-column">
                                <code class="mb-1">{{Grade}}</code>
                                <small class="text-muted">@Html.T("الدرجة", "Grade")</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>
                                حفظ التعديلات
                            </button>
                            <button type="button" class="btn btn-light-brand" id="previewBtn">
                                <i class="feather-eye me-2"></i>
                                معاينة
                            </button>
                            <a href="@Url.Action("Details", "CertificateTemplates", new { id = Model.Id })" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                إلغاء
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Html.T("معاينة القالب", "Template preview")</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <iframe id="previewFrame" class="preview-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            $('#previewBtn').on('click', function() {
                var htmlContent = $('#HtmlContent').val();
                var cssStyles = $('#CssStyles').val();
                
                var previewHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        ${cssStyles}
    </style>
</head>
<body>
    ${htmlContent
        .replace(/{{StudentName}}/g, 'أحمد محمد')
        .replace(/{{CourseName}}/g, 'تطوير تطبيقات الويب')
        .replace(/{{InstructorName}}/g, 'د. محمد علي')
        .replace(/{{CompletionDate}}/g, '2024/01/15')
        .replace(/{{CertificateNumber}}/g, 'CERT-2024-001')
        .replace(/{{Grade}}/g, '95.5')
    }
</body>
</html>
                `;
                
                var iframe = document.getElementById('previewFrame');
                iframe.srcdoc = previewHtml;
                
                var modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            });
        });
    </script>
}

