@model LMS.Domain.Entities.Social.Discussion

@{
    ViewData["Title"] = Html.T("تفاصيل المناقشة", "Discussion details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التواصل الاجتماعي", "Social"), null),
        (Html.T("المناقشات", "Discussions"), Url.Action("Index", "Discussions")),
        (Html.T("تفاصيل المناقشة", "Discussion details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .discussion-header {
            background: var(--gradient-hero, linear-gradient(135deg, #004aad 0%, #0055c4 50%, #1a5cb9 100%));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .discussion-content {
            background: #f9fafb;
            padding: 30px;
            border-radius: 12px;
            border-right: 4px solid #3b82f6;
            line-height: 1.8;
            font-size: 1.05rem;
        }
        .reply-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .reply-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .pin-badge {
            animation: pulse 2s infinite;
        }
        @@keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Discussion Header -->
    <div class="discussion-header">
        <div class="d-flex align-items-start justify-content-between mb-3">
            <div class="flex-grow-1">
                <h2 class="text-white mb-2">
                    @if (Model.IsPinned)
                    {
                        <i class="feather-star pin-badge me-2"></i>
                    }
                    @Model.Title
                </h2>
                <div class="d-flex align-items-center gap-3 text-white-50">
                    <span>
                        <i class="feather-user me-1"></i>
                        @if (Model.Author != null)
                        {
                            @Model.Author.FirstName @Model.Author.LastName
                        }
                    </span>
                    <span>
                        <i class="feather-clock me-1"></i>
                        @Model.CreatedAt.ToString("dd/MM/yyyy - HH:mm")
                    </span>
                    <span>
                        <i class="feather-message-circle me-1"></i>
                        @Model.Replies.Count ردود
                    </span>
                    <span>
                        <i class="feather-eye me-1"></i>
                        @Model.ViewCount مشاهدة
                    </span>
                </div>
            </div>
            <div class="d-flex gap-2">
                @if (Model.IsPinned)
                {
                    <span class="badge bg-white text-warning">
                        <i class="feather-star me-1"></i>
                        مثبتة
                    </span>
                }
                @if (Model.IsLocked)
                {
                    <span class="badge bg-white text-danger">
                        <i class="feather-lock me-1"></i>
                        مقفلة
                    </span>
                }
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Course & Lesson Info -->
            @if (Model.Course != null || Model.Lesson != null)
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3">
                            @if (Model.Course != null)
                            {
                                <div class="avatar-text bg-soft-primary text-primary avatar-lg">
                                    <i class="feather-book"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block">الدورة</small>
                                    <h6 class="fw-bold mb-0">@Model.Course.Title</h6>
                                </div>
                                <a asp-area="Admin" asp-controller="Courses" asp-action="Details" asp-route-id="@Model.Course.Id" class="btn btn-sm btn-light">
                                    <i class="feather-external-link"></i>
                                </a>
                            }
                            @if (Model.Lesson != null)
                            {
                                <div class="ms-3 d-flex align-items-center gap-3">
                                    <div class="avatar-text bg-soft-info text-info avatar-lg">
                                        <i class="feather-file-text"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">الدرس</small>
                                        <h6 class="fw-bold mb-0">@Model.Lesson.Title</h6>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Discussion Content -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-message-square me-2"></i>
                        المحتوى
                    </h5>
                </div>
                <div class="card-body">
                    <div class="discussion-content">
                        @Html.Raw(Model.Content)
                    </div>
                </div>
            </div>

            <!-- Replies -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-message-circle me-2"></i>
                        الردود (@Model.Replies.Count)
                    </h5>
                    <div class="card-header-action">
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="feather-filter me-2"></i>
                                ترتيب
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="sortReplies('newest')">الأحدث أولاً</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sortReplies('oldest')">الأقدم أولاً</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sortReplies('mostLiked')">الأكثر إعجاباً</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.Replies.Any())
                    {
                        <div id="repliesContainer">
                            @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                            {
                                <div class="reply-item" data-reply-id="@reply.Id" data-created="@reply.CreatedAt.Ticks">
                                    <div class="d-flex align-items-start gap-3">
                                        <div class="user-avatar bg-soft-primary text-primary">
                                            @if (reply.User != null)
                                            {
                                                @reply.User.FirstName?.Substring(0, 1)
                                            }
                                            else
                                            {
                                                <i class="feather-user"></i>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <h6 class="fw-bold mb-1">
                                                        @if (reply.User != null)
                                                        {
                                                            @reply.User.FirstName @reply.User.LastName
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">مستخدم محذوف</span>
                                                        }
                                                    </h6>
                                                    <small class="text-muted">
                                                        <i class="feather-clock me-1"></i>
                                                        @reply.CreatedAt.ToString("dd/MM/yyyy - HH:mm")
                                                    </small>
                                                </div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <i class="feather-more-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="viewUserProfile('@reply.UserId')">
                                                                <i class="feather-user me-2"></i>
                                                                عرض الملف الشخصي
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <form asp-action="DeleteReply" asp-route-id="@reply.Id" asp-route-discussionId="@Model.Id" method="post" class="d-inline">
                                                                @Html.AntiForgeryToken()
                                                                <button type="submit" class="dropdown-item text-danger">
                                                                    <i class="feather-trash-2 me-2"></i>
                                                                    حذف الرد
                                                                </button>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <p class="mb-2">@reply.Content</p>
                                            <div class="d-flex gap-3 small text-muted">
                                                <span>
                                                    <i class="feather-thumbs-up me-1"></i>
                                                    @reply.LikesCount إعجاب
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="avatar-text bg-soft-secondary text-secondary avatar-xl mx-auto mb-3">
                                <i class="feather-message-circle" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="fw-bold mb-2">لا توجد ردود بعد</h5>
                            <p class="text-muted">كن أول من يرد على هذه المناقشة</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Author Info -->
            @if (Model.Author != null)
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-user me-2"></i>
                            صاحب المناقشة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="user-avatar bg-soft-primary text-primary mx-auto mb-2" style="width: 80px; height: 80px; font-size: 2rem;">
                                @Model.Author.FirstName?.Substring(0, 1)
                            </div>
                            <h6 class="fw-bold mb-1">@Model.Author.FirstName @Model.Author.LastName</h6>
                            <small class="text-muted">@Model.Author.Email</small>
                        </div>
                        <div class="d-grid">
                            <a asp-area="Admin" asp-controller="Users" asp-action="Details" asp-route-id="@Model.AuthorId" class="btn btn-light-brand btn-sm">
                                <i class="feather-external-link me-2"></i>
                                عرض الملف الشخصي
                            </a>
                        </div>
                    </div>
                </div>
            }

            <!-- Statistics -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-bar-chart me-2"></i>
                        الإحصائيات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">عدد المشاهدات:</span>
                            <span class="fw-bold text-primary">@Model.ViewCount</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">عدد الردود:</span>
                            <span class="fw-bold text-success">@Model.Replies.Count</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">الإعجابات:</span>
                            <span class="fw-bold text-danger">@Model.LikesCount</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">تاريخ الإنشاء:</span>
                            <span class="fw-semibold">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">آخر تحديث:</span>
                                <span class="fw-semibold">@Model.UpdatedAt.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-zap me-2"></i>
                        إجراءات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <form asp-action="TogglePin" asp-route-id="@Model.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn @(Model.IsPinned ? "btn-warning" : "btn-light-brand") w-100">
                                <i class="feather-star me-2"></i>
                                @(Model.IsPinned ? "إلغاء التثبيت" : "تثبيت")
                            </button>
                        </form>
                        <form asp-action="ToggleLock" asp-route-id="@Model.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn @(Model.IsLocked ? "btn-success" : "btn-light-brand") w-100">
                                <i class="feather-@(Model.IsLocked ? "unlock" : "lock") me-2"></i>
                                @(Model.IsLocked ? "فتح المناقشة" : "قفل المناقشة")
                            </button>
                        </form>
                        <button type="button" class="btn btn-light-brand" onclick="window.print()">
                            <i class="feather-printer me-2"></i>
                            طباعة
                        </button>
                        <hr class="my-2">
                        <button type="button" class="btn btn-danger" onclick="deleteDiscussion()">
                            <i class="feather-trash-2 me-2"></i>
                            حذف المناقشة
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-info me-2"></i>
                        الحالة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">مثبتة:</span>
                            @if (Model.IsPinned)
                            {
                                <span class="badge bg-soft-warning text-warning">نعم</span>
                            }
                            else
                            {
                                <span class="badge bg-soft-secondary text-secondary">لا</span>
                            }
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">مقفلة:</span>
                            @if (Model.IsLocked)
                            {
                                <span class="badge bg-soft-danger text-danger">نعم</span>
                            }
                            else
                            {
                                <span class="badge bg-soft-success text-success">لا</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Form -->
<form id="deleteForm" asp-action="Delete" asp-route-id="@Model.Id" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function deleteDiscussion() {
            if (confirm('@(Html.Raw(Html.T("هل أنت متأكد من حذف هذه المناقشة؟\n\nسيتم حذف جميع الردود المرتبطة بها أيضاً.", "Are you sure you want to delete this discussion?\n\nAll related replies will also be deleted.").Replace("'", "\\'").Replace("\n", "\\n")))'.replace(/\\n/g, '\n'))) {
                document.getElementById('deleteForm').submit();
            }
        }

        function viewUserProfile(userId) {
            window.location.href = '@Url.Action("Details", "Users")?id=' + userId;
        }

        function sortReplies(sortType) {
            const container = document.getElementById('repliesContainer');
            const replies = Array.from(container.querySelectorAll('.reply-item'));
            
            replies.sort((a, b) => {
                if (sortType === 'newest') {
                    return parseInt(b.dataset.created) - parseInt(a.dataset.created);
                } else if (sortType === 'oldest') {
                    return parseInt(a.dataset.created) - parseInt(b.dataset.created);
                }
                // mostLiked sorting would require additional data
                return 0;
            });
            
            replies.forEach(reply => container.appendChild(reply));
        }
    </script>
}

