@using LMS.Services.Interfaces
@inject ISystemConfigurationService SystemConfigService
@model List<dynamic>

@{
    ViewData["Title"] = Html.T("تقرير الطلاب", "Students report");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("لوحة التحكم", "Dashboard"), Url.Action("Index", "Dashboard")),
        (Html.T("التحليلات", "Analytics"), Url.Action("Index", "Analytics")),
        (Html.T("تقرير الطلاب", "Students report"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    ViewData["ShowStats"] = true;
    
    var page = ViewBag.Page ?? 1;
    var sortBy = ViewBag.SortBy ?? "enrollments";
    var totalStudents = ViewBag.TotalStudents ?? 0;
    
    // Get sort options from database
    var sortOptions = await SystemConfigService.GetConfigurationsByCategoryAsync("StudentSortOptions", "ar");
}

@section Styles {
    <style>
        .student-card {
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }
        .student-card:hover {
            border-right-color: #3454d1;
            background-color: #f8f9fa;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

@section StatsCards {
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                        <i class="feather-users"></i>
                    </div>
                    <div>
                        <span class="text-muted d-block mb-1">إجمالي الطلاب</span>
                        <h3 class="fw-bold mb-0">@totalStudents</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                        <i class="feather-dollar-sign"></i>
                    </div>
                    <div>
                        <span class="text-muted d-block mb-1">إجمالي الإنفاق</span>
                        <h3 class="fw-bold mb-0">@Model.Sum(s => s.TotalSpent).ToEGP()</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-warning text-warning">
                        <i class="feather-book"></i>
                    </div>
                    <div>
                        <span class="text-muted d-block mb-1">إجمالي التسجيلات</span>
                        <h3 class="fw-bold mb-0">@Model.Sum(s => s.EnrollmentsCount)</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-info text-info">
                        <i class="feather-check-circle"></i>
                    </div>
                    <div>
                        <span class="text-muted d-block mb-1">دورات مكتملة</span>
                        <h3 class="fw-bold mb-0">@Model.Sum(s => s.CompletedCourses)</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Main Content -->
<div class="main-content">
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">@Html.T("ترتيب حسب", "Sort by")</label>
                            <select class="form-select" id="sortBy" onchange="changeSortBy(this.value)">
                                @foreach (var option in sortOptions)
                                {
                                    var isSelected = sortBy == option.Key;
                                    <option value="@option.Key" selected="@(isSelected ? "selected" : null)">@option.DisplayText</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@Html.T("البحث", "Search")</label>
                            <input type="text" class="form-control" id="searchStudent" placeholder="@Html.T("ابحث عن طالب...", "Search for student...")">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@Html.T("نوع العرض", "View type")</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-light active" onclick="changeView('table')">
                                    <i class="feather-list"></i>
                                </button>
                                <button type="button" class="btn btn-light" onclick="changeView('grid')">
                                    <i class="feather-grid"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-success dropdown-toggle w-100" data-bs-toggle="dropdown">
                                    <i class="feather-download me-2"></i>@Html.T("تصدير البيانات", "Export data")
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="/api/export/enrollments?format=csv"><i class="feather-file-text me-2"></i>@Html.T("CSV", "CSV")</a></li>
                                    <li><a class="dropdown-item" href="/api/export/enrollments?format=excel"><i class="feather-file me-2"></i>@Html.T("إكسل", "Excel")</a></li>
                                    <li><a class="dropdown-item" href="/api/export/enrollments?format=pdf"><i class="feather-file-text me-2"></i>@Html.T("PDF", "PDF")</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.print()"><i class="feather-printer me-2"></i>@Html.T("طباعة", "Print")</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students Table View -->
    <div class="row" id="tableView">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("تقرير الطلاب", "Students report")</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="studentsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th>@Html.T("الطالب", "Student")</th>
                                    <th>@Html.T("البريد الإلكتروني", "Email")</th>
                                    <th>@Html.T("التسجيلات", "Enrollments")</th>
                                    <th>@Html.T("الدورات المكتملة", "Completed courses")</th>
                                    <th>@Html.T("إجمالي الإنفاق", "Total spent")</th>
                                    <th>@Html.T("متوسط التقدم", "Avg. progress")</th>
                                    <th>@Html.T("التقييمات المقدمة", "Reviews given")</th>
                                    <th>@Html.T("تاريخ الانضمام", "Join date")</th>
                                    <th>@Html.T("آخر نشاط", "Last activity")</th>
                                    <th class="text-end">@Html.T("الإجراءات", "Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in Model)
                                {
                                    <tr class="student-card">
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="avatar-text avatar-sm bg-soft-primary text-primary">
                                                    @student.Name.Substring(0, 1)
                                                </div>
                                                <div>
                                                    <span class="fw-semibold d-block">@student.Name</span>
                                                    <small class="text-muted">@Html.T("المعرف:", "ID:") @student.StudentId</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@student.Email</td>
                                        <td>
                                            <span class="badge bg-soft-primary text-primary">@student.EnrollmentsCount</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-soft-success text-success">@student.CompletedCourses</span>
                                                @if (student.EnrollmentsCount > 0)
                                                {
                                                    <small class="text-muted">(@((student.CompletedCourses * 100.0 / student.EnrollmentsCount).ToString("F0"))%)</small>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-success">@student.TotalSpent.ToEGP()</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="progress flex-grow-1" style="width: 80px; height: 8px;">
                                                    <div class="progress-bar @(student.AverageProgress >= 75 ? "bg-success" : student.AverageProgress >= 50 ? "bg-primary" : "bg-warning")" 
                                                         style="width: @student.AverageProgress%"></div>
                                                </div>
                                                <span class="fw-semibold">@student.AverageProgress.ToString("F0")%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-soft-warning text-warning">@student.ReviewsGiven</span>
                                        </td>
                                        <td>@student.JoinedDate.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @if (student.LastLoginAt != null)
                                            {
                                                <div>
                                                    <span class="d-block">@student.LastLoginAt?.ToString("dd/MM/yyyy")</span>
                                                    <small class="text-muted">@student.LastLoginAt?.ToString("hh:mm tt")</small>
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="hstack gap-2 justify-content-end">
                                                <a href="javascript:void(0);" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("عرض التفاصيل", "View details")">
                                                    <i class="feather-eye"></i>
                                                </a>
                                                <a href="javascript:void(0);" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("سجل النشاط", "Activity log")">
                                                    <i class="feather-activity"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                @if (!Model.Any())
                {
                    <div class="card-body text-center py-5">
                        <div class="avatar-text avatar-xl bg-soft-warning text-warning mx-auto mb-3">
                            <i class="feather-inbox"></i>
                        </div>
                        <h5>@Html.T("لا يوجد طلاب", "No students")</h5>
                        <p class="text-muted">لم يتم العثور على أي طلاب</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Grid View (Hidden by default) -->
    <div class="row d-none" id="gridView">
        @foreach (var student in Model)
        {
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-2">
                                @student.Name.Substring(0, 1)
                            </div>
                            <h6 class="mb-0">@student.Name</h6>
                            <small class="text-muted">@student.Email</small>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="p-2 bg-soft-primary rounded text-center">
                                    <h6 class="mb-0">@student.EnrollmentsCount</h6>
                                    <small class="text-muted">تسجيل</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-soft-success rounded text-center">
                                    <h6 class="mb-0">@student.CompletedCourses</h6>
                                    <small class="text-muted">مكتمل</small>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-soft-success rounded mb-3">
                            <h6 class="text-success mb-0">@student.TotalSpent.ToEGP()</h6>
                            <small class="text-muted">إجمالي الإنفاق</small>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small>متوسط التقدم</small>
                                <small class="fw-bold">@student.AverageProgress.ToString("F0")%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: @student.AverageProgress%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Top Students -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("أفضل الطلاب", "Top students")</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @foreach (var student in Model.OrderByDescending(s => s.TotalSpent).Take(3))
                        {
                            <div class="col-lg-4">
                                <div class="card border">
                                    <div class="card-body text-center">
                                        <div class="avatar-text avatar-xl bg-gradient-primary text-white mx-auto mb-3">
                                            @student.Name.Substring(0, 1)
                                        </div>
                                        <h5 class="mb-1">@student.Name</h5>
                                        <p class="text-muted mb-3">@student.Email</p>
                                        <div class="row g-2">
                                            <div class="col-4">
                                                <div class="p-2 bg-soft-primary rounded">
                                                    <h6 class="mb-0">@student.EnrollmentsCount</h6>
                                                    <small class="text-muted">تسجيل</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="p-2 bg-soft-success rounded">
                                                    <h6 class="mb-0">@student.CompletedCourses</h6>
                                                    <small class="text-muted">مكتمل</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="p-2 bg-soft-warning rounded">
                                                    <h6 class="mb-0">@student.AverageProgress.ToString("F0")%</h6>
                                                    <small class="text-muted">تقدم</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-3 bg-soft-success rounded">
                                            <h5 class="text-success mb-0">@student.TotalSpent.ToEGP()</h5>
                                            <small class="text-muted">إجمالي الإنفاق</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function changeSortBy(value) {
            window.location.href = '@Url.Action("StudentsReport")?sortBy=' + value + '&page=1';
        }

        function changeView(view) {
            if (view === 'grid') {
                $('#tableView').addClass('d-none');
                $('#gridView').removeClass('d-none');
            } else {
                $('#tableView').removeClass('d-none');
                $('#gridView').addClass('d-none');
            }
        }

        function exportData() {
            alert('@(await SystemConfigService.GetLocalizationAsync("DefaultValues.export_under_development", "ar", "وظيفة التصدير قيد التطوير"))');
        }

        $(document).ready(function() {
            // Search functionality
            $('#searchStudent').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#studentsTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}

