@model LMS.Domain.Entities.Users.ApplicationUser

@{
    ViewData["Title"] = Html.T("تفاصيل المستخدم", "User Details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة المستخدمين", "User Management"), Url.Action("Index", "Users")),
        (Html.T("تفاصيل المستخدم", "User Details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("تعديل", "Edit"), "feather-edit", Url.Action("Edit", "Users", new { id = Model.Id }), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <!-- User Info Card -->
        <div class="col-lg-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="text-center">
                        <div class="avatar-text avatar-xxl bg-soft-primary text-primary mx-auto mb-3">
                            @if (!string.IsNullOrEmpty(Model.FirstName))
                            {
                                <span class="fs-1">@Model.FirstName.Substring(0, 1)@(Model.LastName?.Substring(0, 1) ?? "")</span>
                            }
                            else
                            {
                                <i class="feather-user fs-1"></i>
                            }
                        </div>
                        <h4 class="fw-bold mb-2">@Model.FirstName @Model.LastName</h4>
                        <p class="text-muted mb-3">@Model.Email</p>
                        
                        <div class="d-flex gap-2 justify-content-center mb-4">
                            @if (Model.EmailConfirmed)
                            {
                                <span class="badge bg-soft-success text-success">@Html.T("البريد موثق", "Email Verified")</span>
                            }
                            else
                            {
                                <span class="badge bg-soft-warning text-warning">@Html.T("البريد غير موثق", "Email Not Verified")</span>
                            }
                            
                            @if (Model.IsDeleted)
                            {
                                <span class="badge bg-soft-danger text-danger">@Html.T("محذوف", "Deleted")</span>
                            }
                            else if (Model.IsActive && Model.EmailConfirmed)
                            {
                                <span class="badge bg-soft-success text-success">@Html.T("نشط", "Active")</span>
                            }
                            else if (!Model.EmailConfirmed)
                            {
                                <span class="badge bg-soft-warning text-warning">@Html.T("بريد غير موثق", "Email Not Verified")</span>
                            }
                            else if (!Model.IsActive)
                            {
                                <span class="badge bg-soft-danger text-danger">@Html.T("معطل", "Disabled")</span>
                            }
                            @if (ViewBag.Roles != null && ((IList<string>)ViewBag.Roles).Contains("Instructor"))
                            {
                                @if (Model.InstructorProfile != null && Model.InstructorProfile.IsApproved)
                                {
                                    <span class="badge bg-soft-success text-success">@Html.T("مدرس معتمد", "Instructor Approved")</span>
                                }
                                else
                                {
                                    <span class="badge bg-soft-warning text-warning">@Html.T("قيد المراجعة", "Under Review")</span>
                                }
                            }
                        </div>

                        <div class="d-grid gap-2">
                            <a href="@Url.Action("Index", "DirectMessages", new { area = "Admin", recipientId = Model.Id })" class="btn btn-light-brand">
                                <i class="feather-send me-2"></i>
                                @Html.T("إرسال رسالة", "Send Message")
                            </a>
                            <a href="@Url.Action("ResetPassword", "Users", new { id = Model.Id })" class="btn btn-light-brand">
                                <i class="feather-lock me-2"></i>
                                @Html.T("تغيير كلمة المرور", "Change Password")
                            </a>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="vstack gap-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-mail me-2"></i>
                                @Html.T("البريد الإلكتروني", "Email")
                            </span>
                            <span class="fw-semibold">@Model.Email</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-phone me-2"></i>
                                @Html.T("رقم الهاتف", "Phone")
                            </span>
                            <span class="fw-semibold">@(Model.PhoneNumber ?? Html.T("غير محدد", "Not set"))</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-calendar me-2"></i>
                                @Html.T("تاريخ التسجيل", "Registration Date")
                            </span>
                            <span class="fw-semibold">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-clock me-2"></i>
                                @Html.T("آخر تحديث", "Last Updated")
                            </span>
                            <span class="fw-semibold">@(Model.UpdatedAt?.ToString("dd/MM/yyyy") ?? Html.T("لا يوجد", "N/A"))</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("إجراءات سريعة", "Quick Actions")</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="@Url.Action("ManageRoles", "Users", new { id = Model.Id })" class="list-group-item list-group-item-action">
                            <i class="feather-shield me-3"></i>
                            @Html.T("إدارة الأدوار", "Manage Roles")
                        </a>
                        <a href="@Url.Action("Index", "UserActivity", new { area = "Admin", userId = Model.Id })" class="list-group-item list-group-item-action">
                            <i class="feather-activity me-3"></i>
                            @Html.T("سجل النشاط", "Activity Log")
                        </a>
                        <a href="javascript:void(0);" class="list-group-item list-group-item-action" 
                           onclick="event.preventDefault(); if(confirm('@(Html.T("هل تريد إرسال رابط إعادة تعيين كلمة المرور للمستخدم عبر البريد الإلكتروني؟", "Do you want to send a password reset link to this user via email?"))')) document.getElementById('sendResetForm').submit();">
                            <i class="feather-mail me-3"></i>
                            @Html.T("إرسال رابط التعيين بالبريد", "Send Reset Link by Email")
                        </a>
                        <form id="sendResetForm" asp-action="SendPasswordReset" asp-route-id="@Model.Id" method="post" style="display:none;">
                            @Html.AntiForgeryToken()
                        </form>
                        <a href="@Url.Action("ResetPassword", "Users", new { id = Model.Id })" class="list-group-item list-group-item-action">
                            <i class="feather-key me-3"></i>
                            @Html.T("خيارات كلمة المرور", "Password Options")
                        </a>
                        <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline w-100" 
                              onsubmit="return confirm('@(Html.T("هل أنت متأكد من حذف هذا الحساب؟ هذا الإجراء لا يمكن التراجع عنه.", "Are you sure you want to delete this account? This action cannot be undone."))');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="list-group-item list-group-item-action text-danger border-0 bg-transparent w-100 text-start">
                                <i class="feather-trash-2 me-3"></i>
                                @Html.T("حذف الحساب", "Delete Account")
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details -->
        <div class="col-lg-8">
            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#overview">
                        <i class="feather-user me-2"></i>
                        @Html.T("نظرة عامة", "Overview")
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#activity">
                        <i class="feather-activity me-2"></i>
                        @Html.T("النشاط", "Activity")
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#security">
                        <i class="feather-shield me-2"></i>
                        @Html.T("الأمان", "Security")
                    </a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview">
                    <div class="card stretch stretch-full">
                        <div class="card-header">
                            <h5 class="card-title">@Html.T("المعلومات الأساسية", "Basic Information")</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("الاسم الأول", "First Name")</label>
                                        <p class="fw-semibold">@Model.FirstName</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("الاسم الأخير", "Last Name")</label>
                                        <p class="fw-semibold">@Model.LastName</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("اسم المستخدم", "Username")</label>
                                        <p class="fw-semibold">@Model.UserName</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("البريد الإلكتروني", "Email")</label>
                                        <p class="fw-semibold">
                                            @Model.Email
                                            @if (Model.EmailConfirmed)
                                            {
                                                <i class="feather-check-circle text-success ms-2"></i>
                                            }
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("رقم الهاتف", "Phone")</label>
                                        <p class="fw-semibold">
                                            @(Model.PhoneNumber ?? Html.T("غير محدد", "Not set"))
                                            @if (Model.PhoneNumberConfirmed)
                                            {
                                                <i class="feather-check-circle text-success ms-2"></i>
                                            }
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("تاريخ الميلاد", "Date of Birth")</label>
                                        <p class="fw-semibold">@(Model.DateOfBirth?.ToString("dd/MM/yyyy") ?? Html.T("غير محدد", "Not set"))</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label text-muted mb-2">@Html.T("السيرة الذاتية", "Bio")</label>
                                        <p class="fw-semibold">@(Model.Bio ?? Html.T("لا توجد سيرة ذاتية", "No bio"))</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="card stretch stretch-full mt-4">
                        <div class="card-header">
                            <h5 class="card-title">@Html.T("الإحصائيات", "Statistics")</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="fw-bold text-primary mb-2">@(ViewBag.EnrollmentsCount ?? 0)</h3>
                                        <span class="text-muted">@Html.T("الدورات", "Courses")</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="fw-bold text-success mb-2">@(ViewBag.PaymentsCount ?? 0)</h3>
                                        <span class="text-muted">@Html.T("المدفوعات", "Payments")</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="fw-bold text-warning mb-2">@(ViewBag.CertificatesCount ?? 0)</h3>
                                        <span class="text-muted">@Html.T("الشهادات", "Certificates")</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="fw-bold text-danger mb-2">@(ViewBag.UserPoints ?? 0)</h3>
                                        <span class="text-muted">@Html.T("النقاط", "Points")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                @{
                    var userActivities = ViewBag.UserActivities as IEnumerable<LMS.Domain.Entities.Analytics.ActivityLog>;
                }
                <div class="tab-pane fade" id="activity">
                    <div class="card stretch stretch-full">
                        <div class="card-header">
                            <h5 class="card-title">@Html.T("سجل النشاط", "Activity Log")</h5>
                        </div>
                        <div class="card-body">
                            @if (userActivities != null && userActivities.Any())
                            {
                                <div class="timeline">
                                    @foreach (var activity in userActivities.Take(10))
                                    {
                                        var markerColor = activity.ActivityType switch
                                        {
                                            "Login" => "primary",
                                            "Enrollment" => "success",
                                            "ProfileUpdate" => "warning",
                                            "PasswordChanged" => "info",
                                            _ => "secondary"
                                        };
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-@markerColor"></div>
                                            <div class="timeline-content">
                                                <h6 class="mb-1">@activity.Description</h6>
                                                <p class="text-muted mb-0">@activity.Timestamp.ToRelativeTime()</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                                @if (userActivities.Count() > 10)
                                {
                                    <div class="text-center mt-3">
                                        <a href="@Url.Action("Index", "UserActivity", new { area = "Admin", userId = Model.Id })" class="btn btn-sm btn-light-brand">
                                            <i class="feather-eye me-2"></i>
                                            @Html.T("عرض جميع الأنشطة", "View All Activities") (@userActivities.Count())
                                        </a>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="feather-activity fs-1 text-muted mb-2 d-block"></i>
                                    <p class="text-muted mb-0">@Html.T("لا توجد أنشطة مسجلة", "No activities recorded")</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security">
                    <div class="card stretch stretch-full">
                        <div class="card-header">
                            <h5 class="card-title">@Html.T("إعدادات الأمان", "Security Settings")</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-4">
                                <label class="form-label">@Html.T("المصادقة الثنائية", "Two-Factor Authentication")</label>
                                <div class="d-flex align-items-center gap-3">
                                    @if (Model.TwoFactorEnabled)
                                    {
                                        <span class="badge bg-soft-success text-success">
                                            <i class="feather-check me-1"></i>
                                            @Html.T("مفعّلة", "Enabled")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-warning text-warning">
                                            <i class="feather-x me-1"></i>
                                            @Html.T("غير مفعّلة", "Disabled")
                                        </span>
                                    }
                                    <small class="text-muted">@Html.T("يتم التحكم في هذا الإعداد من قبل المستخدم", "This setting is controlled by the user")</small>
                                </div>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">@Html.T("تأكيد البريد الإلكتروني", "Email Confirmation")</label>
                                <div class="d-flex align-items-center gap-3">
                                    @if (Model.EmailConfirmed)
                                    {
                                        <span class="badge bg-soft-success text-success">
                                            <i class="feather-check me-1"></i>
                                            @Html.T("موثق", "Verified")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-warning text-warning">
                                            <i class="feather-alert-circle me-1"></i>
                                            @Html.T("غير موثق", "Not Verified")
                                        </span>
                                    }
                                </div>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">@Html.T("تأكيد رقم الهاتف", "Phone Confirmation")</label>
                                <div class="d-flex align-items-center gap-3">
                                    @if (Model.PhoneNumberConfirmed)
                                    {
                                        <span class="badge bg-soft-success text-success">
                                            <i class="feather-check me-1"></i>
                                            @Html.T("موثق", "Verified")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-warning text-warning">
                                            <i class="feather-alert-circle me-1"></i>
                                            @Html.T("غير موثق", "Not Verified")
                                        </span>
                                        @if (string.IsNullOrEmpty(Model.PhoneNumber))
                                        {
                                            <small class="text-muted">@Html.T("لم يتم إضافة رقم هاتف", "No phone number added")</small>
                                        }
                                    }
                                </div>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">@Html.T("آخر تسجيل دخول", "Last Login")</label>
                                <p class="mb-0">
                                    @if (Model.LastLoginAt.HasValue)
                                    {
                                        <span class="fw-semibold">@Model.LastLoginAt.Value.ToString("dd/MM/yyyy hh:mm tt")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">@Html.T("لم يتم تسجيل الدخول بعد", "Never logged in")</span>
                                    }
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">@Html.T("حالة الحساب", "Account Status")</label>
                                <div class="d-flex align-items-center gap-3">
                                    @if (Model.IsActive)
                                    {
                                        <span class="badge bg-soft-success text-success">
                                            <i class="feather-check-circle me-1"></i>
                                            @Html.T("نشط", "Active")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-soft-danger text-danger">
                                            <i class="feather-x-circle me-1"></i>
                                            @Html.T("معطل", "Disabled")
                                        </span>
                                    }
                                    <form asp-action="ToggleStatus" asp-route-id="@Model.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm @(Model.IsActive ? "btn-outline-warning" : "btn-outline-success")" 
                                                onclick="return confirm('@(Model.IsActive ? Html.T("هل أنت متأكد من تعطيل هذا الحساب؟", "Are you sure you want to disable this account?") : Html.T("هل أنت متأكد من تفعيل هذا الحساب؟", "Are you sure you want to enable this account?"))');">
                                            <i class="feather-@(Model.IsActive ? "user-x" : "user-check") me-1"></i>
                                            @(Model.IsActive ? Html.T("تعطيل", "Disable") : Html.T("تفعيل", "Enable"))
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            right: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            right: -31px;
            top: 17px;
            width: 2px;
            height: calc(100% - 5px);
            background: #e5e7eb;
        }
        .timeline-item:last-child:before {
            display: none;
        }
    </style>
}

