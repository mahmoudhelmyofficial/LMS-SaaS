@{
    ViewData["Title"] = Html.T("إدارة أدوار المستخدم", "Manage User Roles");
    var user = ViewBag.User as LMS.Domain.Entities.Users.ApplicationUser;
    var userRoles = ViewBag.UserRoles as IList<string>;
    var allRoles = ViewBag.AllRoles as IList<Microsoft.AspNetCore.Identity.IdentityRole>;
    
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة المستخدمين", "User Management"), Url.Action("Index", "Users")),
        (Html.T("تفاصيل المستخدم", "User Details"), Url.Action("Details", "Users", new { id = user.Id })),
        (Html.T("إدارة الأدوار", "Manage Roles"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <!-- User Info Card -->
        <div class="col-lg-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="text-center">
                        <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-3">
                            @if (!string.IsNullOrEmpty(user.FirstName))
                            {
                                <span class="fs-3">@user.FirstName.Substring(0, 1)@(user.LastName?.Substring(0, 1) ?? "")</span>
                            }
                            else
                            {
                                <i class="feather-user fs-3"></i>
                            }
                        </div>
                        <h5 class="fw-bold mb-1">@user.FirstName @user.LastName</h5>
                        <p class="text-muted mb-3">@user.Email</p>
                        
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            @if (userRoles != null && userRoles.Any())
                            {
                                foreach (var role in userRoles)
                                {
                                    <span class="badge bg-primary">@role</span>
                                }
                            }
                            else
                            {
                                <span class="badge bg-soft-secondary text-secondary">@Html.T("لا توجد أدوار", "No roles")</span>
                            }
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="vstack gap-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-calendar me-2"></i>
                                @Html.T("تاريخ التسجيل", "Registration Date")
                            </span>
                            <span class="fw-semibold">@user.CreatedAt.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="text-muted">
                                <i class="feather-shield me-2"></i>
                                @Html.T("عدد الأدوار", "Role Count")
                            </span>
                            <span class="fw-semibold">@(userRoles?.Count ?? 0)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card stretch stretch-full mt-3">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("إجراءات سريعة", "Quick Actions")</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="@Url.Action("Details", "Users", new { id = user.Id })" class="btn btn-light-brand">
                            <i class="feather-user me-2"></i>
                            @Html.T("عرض الملف الشخصي", "View Profile")
                        </a>
                        <a href="@Url.Action("Edit", "Users", new { id = user.Id })" class="btn btn-light-brand">
                            <i class="feather-edit me-2"></i>
                            @Html.T("تعديل المستخدم", "Edit User")
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Management -->
        <div class="col-lg-8">
            <!-- Current Roles -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("الأدوار الحالية", "Current Roles")</h5>
                </div>
                <div class="card-body">
                    @if (userRoles != null && userRoles.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>@Html.T("اسم الدور", "Role Name")</th>
                                        <th>@Html.T("الوصف", "Description")</th>
                                        <th class="text-center">@Html.T("الإجراءات", "Actions")</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var role in userRoles)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-text avatar-sm bg-soft-primary text-primary me-3">
                                                        <i class="feather-shield"></i>
                                                    </div>
                                                    <span class="fw-semibold">@role</span>
                                                </div>
                                            </td>
                                            <td>
                                                @switch (role)
                                                {
                                                    case "Admin":
                                                        <span class="text-muted">@Html.T("مدير النظام - وصول كامل", "System Admin - Full Access")</span>
                                                        break;
                                                    case "Instructor":
                                                        <span class="text-muted">@Html.T("مدرس - إنشاء وإدارة الدورات", "Instructor - Create & Manage Courses")</span>
                                                        break;
                                                    case "Student":
                                                        <span class="text-muted">@Html.T("طالب - التسجيل في الدورات", "Student - Enroll in Courses")</span>
                                                        break;
                                                    default:
                                                        <span class="text-muted">@Html.T("دور مخصص", "Custom Role")</span>
                                                        break;
                                                }
                                            </td>
                                            <td class="text-center">
                                                <form asp-action="RemoveRole" asp-controller="Users" method="post" class="d-inline" 
                                                      onsubmit="return confirm('@(Html.T("هل أنت متأكد من إزالة هذا الدور؟", "Are you sure you want to remove this role?"))');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="userId" value="@user.Id" />
                                                    <input type="hidden" name="roleName" value="@role" />
                                                    <button type="submit" class="btn btn-sm btn-icon btn-light-danger" 
                                                            data-bs-toggle="tooltip" title="@Html.T("إزالة الدور", "Remove Role")">
                                                        <i class="feather-trash-2"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <div class="d-flex align-items-center">
                                <i class="feather-info fs-4 me-3"></i>
                                <div>
                                    <h6 class="mb-1">@Html.T("لا توجد أدوار", "No roles assigned")</h6>
                                    <p class="mb-0">@Html.T("لم يتم تعيين أي دور لهذا المستخدم بعد. يمكنك إضافة دور من القسم أدناه.", "No role has been assigned to this user yet. You can add a role from the section below.")</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Add New Role -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("إضافة دور جديد", "Add New Role")</h5>
                </div>
                <div class="card-body">
                    <form asp-action="AddRole" asp-controller="Users" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@user.Id" />
                        
                        <div class="row g-3">
                            @if (allRoles != null)
                            {
                                foreach (var role in allRoles)
                                {
                                    var isAssigned = userRoles?.Contains(role.Name) ?? false;
                                    var cardClass = isAssigned ? "border-success" : "";
                                    
                                    <div class="col-md-6">
                                        <div class="card @cardClass mb-0">
                                            <div class="card-body">
                                                <div class="d-flex align-items-start justify-content-between">
                                                    <div class="flex-grow-1">
                                                        <h6 class="fw-bold mb-2">
                                                            @role.Name
                                                            @if (isAssigned)
                                                            {
                                                                <i class="feather-check-circle text-success ms-2"></i>
                                                            }
                                                        </h6>
                                                        <p class="text-muted mb-3">
                                                            @switch (role.Name)
                                                            {
                                                                case "Admin":
                                                                    <span>@Html.T("وصول كامل لجميع وظائف النظام وإدارة المستخدمين", "Full access to all system features and user management")</span>
                                                                    break;
                                                                case "Instructor":
                                                                    <span>@Html.T("إنشاء وإدارة الدورات، عرض الإحصائيات والأرباح", "Create and manage courses, view statistics and earnings")</span>
                                                                    break;
                                                                case "Student":
                                                                    <span>@Html.T("التسجيل في الدورات، إكمال الدروس، الحصول على الشهادات", "Enroll in courses, complete lessons, earn certificates")</span>
                                                                    break;
                                                                default:
                                                                    <span>@Html.T("دور مخصص بصلاحيات محددة", "Custom role with specific permissions")</span>
                                                                    break;
                                                            }
                                                        </p>
                                                        @if (!isAssigned)
                                                        {
                                                            <button type="submit" name="roleName" value="@role.Name" 
                                                                    class="btn btn-sm btn-primary"
                                                                    onclick="return confirm('@(Html.T("هل أنت متأكد من إضافة دور", "Are you sure you want to add role")) @role.Name @(Html.T("لهذا المستخدم؟", "to this user?"))');">
                                                                <i class="feather-plus me-2"></i>
                                                                @Html.T("إضافة الدور", "Add Role")
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-soft-success text-success">
                                                                <i class="feather-check me-1"></i>
                                                                @Html.T("تم التعيين", "Assigned")
                                                            </span>
                                                        }
                                                    </div>
                                                    <div class="avatar-text avatar-md bg-soft-primary text-primary">
                                                        <i class="feather-shield"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </form>
                </div>
            </div>

            <!-- Role Permissions Info -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">@Html.T("معلومات الصلاحيات", "Permission Information")</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="permissionsAccordion">
                        <!-- Admin Role -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#adminPermissions">
                                    <i class="feather-shield text-danger me-2"></i>
                                    @Html.T("صلاحيات دور المدير (Admin)", "Admin Role Permissions")
                                </button>
                            </h2>
                            <div id="adminPermissions" class="accordion-collapse collapse" data-bs-parent="#permissionsAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة كاملة للمستخدمين والأدوار", "Full user and role management")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("الموافقة على الدورات والمدرسين", "Approve courses and instructors")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة المدفوعات والاستردادات", "Manage payments and refunds")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("عرض جميع التقارير والإحصائيات", "View all reports and statistics")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة الإعدادات العامة للنظام", "Manage system general settings")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة المحتوى والإعلانات", "Manage content and announcements")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Instructor Role -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#instructorPermissions">
                                    <i class="feather-book text-primary me-2"></i>
                                    @Html.T("صلاحيات دور المدرس (Instructor)", "Instructor Role Permissions")
                                </button>
                            </h2>
                            <div id="instructorPermissions" class="accordion-collapse collapse" data-bs-parent="#permissionsAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إنشاء وإدارة الدورات الخاصة", "Create and manage own courses")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إضافة وتعديل الوحدات والدروس", "Add and edit modules and lessons")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة التقييمات والاختبارات", "Manage assessments and quizzes")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("عرض إحصائيات الدورات والطلاب", "View course and student statistics")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إدارة الأرباح وطلبات السحب", "Manage earnings and withdrawal requests")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("التفاعل مع الطلاب والرد على الاستفسارات", "Interact with students and answer inquiries")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Student Role -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#studentPermissions">
                                    <i class="feather-user text-success me-2"></i>
                                    @Html.T("صلاحيات دور الطالب (Student)", "Student Role Permissions")
                                </button>
                            </h2>
                            <div id="studentPermissions" class="accordion-collapse collapse" data-bs-parent="#permissionsAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("تصفح والتسجيل في الدورات", "Browse and enroll in courses")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("الوصول للدروس والمحتوى", "Access lessons and content")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("إكمال الاختبارات والتقييمات", "Complete quizzes and assessments")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("تقييم الدورات وكتابة المراجعات", "Rate courses and write reviews")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("الحصول على الشهادات", "Earn certificates")</li>
                                        <li><i class="feather-check text-success me-2"></i>@Html.T("التفاعل مع المدرسين والطلاب الآخرين", "Interact with instructors and other students")</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    </script>
}

