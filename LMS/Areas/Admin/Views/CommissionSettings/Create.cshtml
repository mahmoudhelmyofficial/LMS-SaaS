@model LMS.Areas.Admin.ViewModels.CommissionSettingCreateViewModel

@{
    ViewData["Title"] = Html.T("إضافة إعداد عمولة جديد", "Add new commission setting");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإدارة المالية", "Financial"), null),
        (Html.T("إعدادات العمولات", "Commission settings"), Url.Action("Index", "CommissionSettings")),
        (Html.T("إضافة جديد", "Add new"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<!-- Alert Messages -->
@await Html.PartialAsync("_Messages")

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <div class="col-lg-12">
            <form asp-action="Create" method="post" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()
                
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("المعلومات الأساسية", "Basic information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="Name" class="form-label required">@Html.T("اسم الإعداد", "Setting name")</label>
                                <input asp-for="Name" class="form-control" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Type" class="form-label required">@Html.T("نوع الإعداد", "Setting type")</label>
                                <select asp-for="Type" class="form-select" id="typeSelect" required>
                                    <option value="">@Html.T("-- اختر النوع --", "-- Select type --")</option>
                                    <option value="Global">@Html.T("عامة (على جميع الدورات)", "Global (all courses)")</option>
                                    <option value="Category">@Html.T("حسب الفئة", "By category")</option>
                                    <option value="Course">@Html.T("حسب الدورة", "By course")</option>
                                    <option value="Instructor">@Html.T("حسب المدرب", "By instructor")</option>
                                </select>
                                <span asp-validation-for="Type" class="text-danger"></span>
                            </div>

                            @{
                                var categories = ViewBag.Categories as IEnumerable<SelectListItem> ?? new List<SelectListItem>();
                                var courses = ViewBag.Courses as IEnumerable<SelectListItem> ?? new List<SelectListItem>();
                                var instructors = ViewBag.Instructors as IEnumerable<SelectListItem> ?? new List<SelectListItem>();
                            }
                            <div class="col-md-4" id="categoryDiv" style="display:none;">
                                <label asp-for="CategoryId" class="form-label">@Html.T("الفئة", "Category")</label>
                                <select asp-for="CategoryId" asp-items="categories" class="form-select">
                                    <option value="">@Html.T("-- اختر الفئة --", "-- Select category --")</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4" id="courseDiv" style="display:none;">
                                <label asp-for="CourseId" class="form-label">@Html.T("الدورة", "Course")</label>
                                <select asp-for="CourseId" asp-items="courses" class="form-select">
                                    <option value="">@Html.T("-- اختر الدورة --", "-- Select course --")</option>
                                </select>
                                <span asp-validation-for="CourseId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4" id="instructorDiv" style="display:none;">
                                <label asp-for="InstructorId" class="form-label">@Html.T("المدرب", "Instructor")</label>
                                <select asp-for="InstructorId" asp-items="instructors" class="form-select">
                                    <option value="">@Html.T("-- اختر المدرب --", "-- Select instructor --")</option>
                                </select>
                                <span asp-validation-for="InstructorId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Priority" class="form-label required">@Html.T("الأولوية", "Priority")</label>
                                <input asp-for="Priority" type="number" class="form-control" required />
                                <span asp-validation-for="Priority" class="text-danger"></span>
                                <small class="text-muted">@Html.T("رقم أعلى = أولوية أعلى", "Higher number = higher priority")</small>
                            </div>

                            <div class="col-12">
                                <label asp-for="Description" class="form-label">@Html.T("الوصف", "Description")</label>
                                <textarea asp-for="Description" class="form-control" rows="2"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("نسب العمولة", "Commission rates")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="PlatformRate" class="form-label required">@Html.T("نسبة المنصة", "Platform rate")</label>
                                <div class="input-group">
                                    <input asp-for="PlatformRate" type="number" step="0.01" class="form-control" id="platformRate" required />
                                    <span class="input-group-text">%</span>
                                </div>
                                <span asp-validation-for="PlatformRate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="InstructorRate" class="form-label required">@Html.T("نسبة المدرب", "Instructor rate")</label>
                                <div class="input-group">
                                    <input asp-for="InstructorRate" type="number" step="0.01" class="form-control" id="instructorRate" required />
                                    <span class="input-group-text">%</span>
                                </div>
                                <span asp-validation-for="InstructorRate" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <div class="alert alert-info" id="totalAlert">
                                    <i class="feather-info me-2"></i>
                                    <strong>@Html.T("المجموع:", "Total:")</strong> <span id="totalRate">0</span>%
                                    <span id="validationMsg" class="ms-2"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="HoldPeriodDays" class="form-label required">@Html.T("فترة حجز الأموال (بالأيام)", "Funds hold period (days)")</label>
                                <input asp-for="HoldPeriodDays" type="number" class="form-control" required />
                                <span asp-validation-for="HoldPeriodDays" class="text-danger"></span>
                                <small class="text-muted">@Html.T("عدد الأيام قبل تحويل الأموال للمدرب", "Number of days before transferring funds to instructor")</small>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="MinimumSaleAmount" class="form-label">@Html.T("الحد الأدنى للبيع", "Minimum sale amount")</label>
                                <div class="input-group">
                                    <input asp-for="MinimumSaleAmount" type="number" step="0.01" class="form-control" />
                                    <span class="input-group-text">@Html.T("ر.س", "SAR")</span>
                                </div>
                                <span asp-validation-for="MinimumSaleAmount" class="text-danger"></span>
                                <small class="text-muted">@Html.T("0 = بدون حد أدنى", "0 = no minimum")</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("فترة الصلاحية", "Validity period")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="StartDate" class="form-label">@Html.T("تاريخ البداية", "Start date")</label>
                                <input asp-for="StartDate" type="date" class="form-control" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                                <small class="text-muted">@Html.T("اترك فارغاً للبدء فوراً", "Leave empty to start immediately")</small>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="EndDate" class="form-label">@Html.T("تاريخ النهاية", "End date")</label>
                                <input asp-for="EndDate" type="date" class="form-control" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                                <small class="text-muted">@Html.T("اترك فارغاً للإعداد الدائم", "Leave empty for permanent setting")</small>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" checked />
                                    <label class="form-check-label" for="isActiveSwitch">
                                        @Html.T("تفعيل الإعداد", "Enable setting")
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Index", "CommissionSettings")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء", "Cancel")
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>
                                @Html.T("حفظ الإعداد", "Save setting")
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        var _rateValid = '@Html.Raw(Html.T("صحيح", "Valid"))';
        var _rateBelow = '@Html.Raw(Html.T("المجموع أقل من 100%", "Total is less than 100%"))';
        var _rateAbove = '@Html.Raw(Html.T("المجموع أكبر من 100%", "Total exceeds 100%"))';
        var _rateMustBe100 = '@Html.Raw(Html.T("يجب أن يكون مجموع النسب = 100%", "Total rate must equal 100%"))';
        $(document).ready(function() {
            // Show/hide dropdowns based on type
            $('#typeSelect').on('change', function() {
                var type = $(this).val();
                $('#categoryDiv, #courseDiv, #instructorDiv').hide();
                
                if (type === 'Category') {
                    $('#categoryDiv').show();
                } else if (type === 'Course') {
                    $('#courseDiv').show();
                } else if (type === 'Instructor') {
                    $('#instructorDiv').show();
                }
            });

            // Calculate and validate total rate
            function updateTotalRate() {
                var platformRate = parseFloat($('#platformRate').val()) || 0;
                var instructorRate = parseFloat($('#instructorRate').val()) || 0;
                var total = platformRate + instructorRate;
                
                $('#totalRate').text(total.toFixed(2));
                
                if (total === 100) {
                    $('#totalAlert').removeClass('alert-warning alert-danger').addClass('alert-success');
                    $('#validationMsg').html('<i class="feather-check-circle"></i> ' + _rateValid).removeClass('text-danger').addClass('text-success');
                } else if (total < 100) {
                    $('#totalAlert').removeClass('alert-success alert-danger').addClass('alert-warning');
                    $('#validationMsg').html('<i class="feather-alert-triangle"></i> ' + _rateBelow).removeClass('text-success').addClass('text-warning');
                } else {
                    $('#totalAlert').removeClass('alert-success alert-warning').addClass('alert-danger');
                    $('#validationMsg').html('<i class="feather-x-circle"></i> ' + _rateAbove).removeClass('text-success').addClass('text-danger');
                }
            }

            $('#platformRate, #instructorRate').on('input', updateTotalRate);
            updateTotalRate();

            // Form validation
            (function () {
                'use strict'
                var forms = document.querySelectorAll('.needs-validation')
                Array.prototype.slice.call(forms)
                    .forEach(function (form) {
                        form.addEventListener('submit', function (event) {
                            var total = parseFloat($('#platformRate').val() || 0) + parseFloat($('#instructorRate').val() || 0);
                            if (total !== 100) {
                                event.preventDefault();
                                event.stopPropagation();
                                alert(_rateMustBe100);
                                return false;
                            }
                            
                            if (!form.checkValidity()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false)
                    })
            })()
        });
    </script>
}

