@model LMS.Areas.Admin.ViewModels.ReportTemplateEditViewModel

@{
    ViewData["Title"] = Html.T("تعديل قالب التقرير", "Edit report template");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("قوالب التقارير", "Report templates"), Url.Action("Index", "ReportTemplates")),
        (Html.T("تعديل قالب", "Edit template"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("معلومات القالب", "Template information")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label" asp-for="Name">@Html.T("اسم القالب", "Template name") <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" asp-for="Name" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="Description">@Html.T("الوصف", "Description")</label>
                                <textarea class="form-control" asp-for="Description" rows="3"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label" asp-for="ReportType">@Html.T("نوع التقرير", "Report type") <span class="text-danger">*</span></label>
                                <select class="form-select" asp-for="ReportType" required>
                                    <option value="">@Html.T("اختر نوع التقرير", "Select report type")</option>
                                    <option value="Sales">@Html.T("المبيعات", "Sales")</option>
                                    <option value="Revenue">@Html.T("الإيرادات", "Revenue")</option>
                                    <option value="Enrollments">@Html.T("التسجيلات", "Enrollments")</option>
                                    <option value="Users">@Html.T("المستخدمين", "Users")</option>
                                    <option value="Courses">@Html.T("الدورات", "Courses")</option>
                                    <option value="Instructors">@Html.T("المدرسين", "Instructors")</option>
                                    <option value="Custom">@Html.T("مخصص", "Custom")</option>
                                </select>
                                <span asp-validation-for="ReportType" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" asp-for="IsActive" id="isActive" />
                                    <label class="form-check-label" for="isActive">@Html.T("قالب نشط", "Active template")</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="FiltersJson">@Html.T("الفلاتر (JSON)", "Filters (JSON)")</label>
                                <textarea class="form-control code-editor" asp-for="FiltersJson" rows="8"></textarea>
                                <span asp-validation-for="FiltersJson" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="ColumnsJson">@Html.T("الأعمدة (JSON)", "Columns (JSON)")</label>
                                <textarea class="form-control code-editor" asp-for="ColumnsJson" rows="8"></textarea>
                                <span asp-validation-for="ColumnsJson" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label class="form-label" asp-for="SortingJson">@Html.T("الترتيب (JSON)", "Sorting (JSON)")</label>
                                <textarea class="form-control code-editor" asp-for="SortingJson" rows="4"></textarea>
                                <span asp-validation-for="SortingJson" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">@Html.T("إرشادات", "Guidelines")</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <p class="fs-12 mb-0">@Html.T("تأكد من صحة تنسيق JSON قبل الحفظ", "Ensure JSON format is valid before saving")</p>
                        </div>
                    </div>
                </div>

                <div class="card stretch stretch-full">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>
                                @Html.T("حفظ التعديلات", "Save changes")
                            </button>
                            <a href="@Url.Action("Index", "ReportTemplates")" class="btn btn-light">
                                <i class="feather-x me-2"></i>
                                @Html.T("إلغاء", "Cancel")
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            $('.code-editor').on('blur', function() {
                try {
                    var value = $(this).val().trim();
                    if (value) {
                        JSON.parse(value);
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    }
                } catch (e) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                    alert('@Html.Raw(Html.T("خطأ في تنسيق JSON", "JSON format error").Replace("'", "\\'"))' + ': ' + e.message);
                }
            });
        });
    </script>
}

@section Styles {
    <style>
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
    </style>
}

