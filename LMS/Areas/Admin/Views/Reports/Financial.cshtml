@{
    ViewData["Title"] = Html.T("التقرير المالي", "Financial report");
    ViewData["Breadcrumbs"] = new List<(string Name, string Url)>
    {
        (Html.T("التقارير", "Reports"), Url.Action("Index")),
        (Html.T("التقرير المالي", "Financial report"), "")
    };
}

<div class="main-content">
    <!-- Date Filter -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">@Html.T("من تاريخ", "From date")</label>
                    <input type="date" name="from" class="form-control" value="@(((DateTime)ViewBag.FromDate).ToString("yyyy-MM-dd"))">
                </div>
                <div class="col-md-3">
                    <label class="form-label">@Html.T("إلى تاريخ", "To date")</label>
                    <input type="date" name="to" class="form-control" value="@(((DateTime)ViewBag.ToDate).ToString("yyyy-MM-dd"))">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="feather-filter me-2"></i>@Html.T("تصفية", "Filter")
                    </button>
                </div>
                <div class="col-md-3">
                    <div class="dropdown">
                        <button type="button" class="btn btn-success w-100 dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="feather-download me-2"></i>@Html.T("تصدير", "Export")
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" asp-action="ExportFinancial" asp-route-from="@(((DateTime)ViewBag.FromDate).ToString("yyyy-MM-dd"))" asp-route-to="@(((DateTime)ViewBag.ToDate).ToString("yyyy-MM-dd"))"><i class="feather-file-text me-2"></i>@Html.T("CSV", "CSV")</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="window.print()"><i class="feather-printer me-2"></i>@Html.T("طباعة", "Print")</a></li>
                        </ul>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Financial Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">@Html.T("إجمالي الإيرادات", "Total revenue")</h6>
                            <h3 class="mb-0">@ViewBag.TotalRevenue.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                            @if (ViewBag.RevenueGrowth > 0)
                            {
                                <small><i class="feather-trending-up me-1"></i>+@ViewBag.RevenueGrowth.ToString("N1")%</small>
                            }
                            else if (ViewBag.RevenueGrowth < 0)
                            {
                                <small><i class="feather-trending-down me-1"></i>@ViewBag.RevenueGrowth.ToString("N1")%</small>
                            }
                        </div>
                        <div class="avatar avatar-lg bg-white-10 rounded">
                            <i class="feather-dollar-sign fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">@Html.T("عمولات المدرسين", "Instructor commissions")</h6>
                            <h3 class="mb-0">@ViewBag.TotalCommissions.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                        </div>
                        <div class="avatar avatar-lg bg-white-10 rounded">
                            <i class="feather-users fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">@Html.T("المبالغ المستردة", "Refunds")</h6>
                            <h3 class="mb-0">@ViewBag.TotalRefunds.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                        </div>
                        <div class="avatar avatar-lg bg-white-10 rounded">
                            <i class="feather-rotate-ccw fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">@Html.T("صافي الربح", "Net profit")</h6>
                            <h3 class="mb-0">@ViewBag.NetProfit.ToString("N0") @Html.T("ج.م", "EGP")</h3>
                            <small>@Html.T("هامش", "Margin") @ViewBag.ProfitMargin.ToString("N1")%</small>
                        </div>
                        <div class="avatar avatar-lg bg-white-10 rounded">
                            <i class="feather-trending-up fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Revenue Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="feather-bar-chart-2 me-2"></i>@Html.T("الإيرادات الشهرية", "Monthly revenue")</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="feather-pie-chart me-2"></i>@Html.T("طرق الدفع", "Payment methods")</h5>
                </div>
                <div class="card-body">
                    @{
                        var paymentStats = ViewBag.PaymentMethodStats as IEnumerable<dynamic>;
                        var hasPaymentStats = paymentStats != null && paymentStats.Any();
                    }
                    @if (hasPaymentStats)
                    {
                        <canvas id="paymentMethodsChart" height="200"></canvas>
                        <div class="mt-3">
                            @foreach (var method in paymentStats!)
                            {
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <span>@method.Method</span>
                                    <div class="text-end">
                                        <strong>@(((decimal)method.Amount).ToString("N0")) @Html.T("ج.م", "EGP")</strong>
                                        <small class="text-muted d-block">@method.Count @Html.T("معاملة", "transaction(s)")</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">@Html.T("لا توجد بيانات", "No data")</p>
                    }
                </div>
            </div>
        </div>

        <!-- Monthly Data Table -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="feather-calendar me-2"></i>@Html.T("التفاصيل الشهرية", "Monthly details")</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>@Html.T("الشهر", "Month")</th>
                                    <th>@Html.T("الإيرادات", "Revenue")</th>
                                    <th>@Html.T("عدد المعاملات", "Transactions")</th>
                                    <th>@Html.T("متوسط المعاملة", "Avg. transaction")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var monthlyStats = ViewBag.MonthlyData as IEnumerable<dynamic>;
                                }
                                @if (monthlyStats != null)
                                {
                                    foreach (var month in monthlyStats)
                                    {
                                        var monthName = new DateTime((int)month.Year, (int)month.Month, 1).ToString("MMMM yyyy", new System.Globalization.CultureInfo("ar-EG"));
                                        var revenue = (decimal)month.Revenue;
                                        var transactions = (int)month.Transactions;
                                        <tr>
                                            <td>@monthName</td>
                                            <td><strong>@revenue.ToString("N0") @Html.T("ج.م", "EGP")</strong></td>
                                            <td>@transactions</td>
                                            <td>@((transactions > 0 ? revenue / transactions : 0).ToString("N0")) @Html.T("ج.م", "EGP")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Revenue Chart
        const monthlyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyData ?? new List<object>()));
        const revenueLabel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Html.T("الإيرادات", "Revenue").ToString()));
        if (monthlyData.length > 0) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => {
                        const date = new Date(d.Year, d.Month - 1);
                        return date.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                    }),
                    datasets: [{
                        label: revenueLabel,
                        data: monthlyData.map(d => d.Revenue),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Payment Methods Chart
        const paymentMethods = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.PaymentMethodStats ?? new List<object>()));
        
        if (paymentMethods.length > 0) {
            const ctx2 = document.getElementById('paymentMethodsChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: paymentMethods.map(d => d.Method),
                    datasets: [{
                        data: paymentMethods.map(d => d.Amount),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    </script>
}

