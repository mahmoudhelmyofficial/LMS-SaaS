@model List<LMS.Domain.Entities.Settings.PlatformSetting>
@{
    ViewData["Title"] = Html.T("إعدادات الأمان", "Security settings");
    ViewData["Breadcrumbs"] = new List<(string Name, string Url)>
    {
        (Html.T("الإعدادات", "Settings"), Url.Action("Index", "Settings")),
        (Html.T("الأمان", "Security"), "")
    };
}

<div class="main-content">
    <!-- Security Score & Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="avatar avatar-xl mx-auto mb-3 @(ViewBag.SecurityScore >= 80 ? "bg-soft-success" : ViewBag.SecurityScore >= 50 ? "bg-soft-warning" : "bg-soft-danger") rounded-circle">
                        <span class="fs-4 @(ViewBag.SecurityScore >= 80 ? "text-success" : ViewBag.SecurityScore >= 50 ? "text-warning" : "text-danger")">@ViewBag.SecurityScore</span>
                    </div>
                    <h6 class="mb-0">@Html.T("مؤشر الأمان", "Security score")</h6>
                    <small class="text-muted">@Html.T("من 100", "out of 100")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-lg bg-soft-danger rounded">
                            <i class="feather-alert-triangle fs-4 text-danger"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0">@ViewBag.FailedLoginsToday</h3>
                            <span class="text-muted fs-12">@Html.T("محاولات فاشلة اليوم", "Failed attempts today")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-lg bg-soft-warning rounded">
                            <i class="feather-shield-off fs-4 text-warning"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0">@ViewBag.BlockedIpsCount</h3>
                            <span class="text-muted fs-12">@Html.T("عناوين IP محظورة", "Blocked IPs")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar avatar-lg bg-soft-success rounded">
                            <i class="feather-smartphone fs-4 text-success"></i>
                        </div>
                        <div class="ms-3">
                            <h3 class="mb-0">@ViewBag.TwoFactorEnabledUsers</h3>
                            <span class="text-muted fs-12">@Html.T("مستخدمي 2FA", "2FA users")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Save" method="post">
        @Html.AntiForgeryToken()
        
        <div class="row g-4">
            <!-- Password Policy -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-key me-2"></i>@Html.T("سياسة كلمات المرور", "Password policy")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("الحد الأدنى للطول", "Minimum length")</label>
                                <input type="number" name="PasswordMinLength" class="form-control" min="6" max="32"
                                       value="@(Model?.FirstOrDefault(s => s.Key == "PasswordMinLength")?.Value ?? "8")">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("انتهاء الصلاحية (أيام)", "Expiration (days)")</label>
                                <input type="number" name="PasswordExpirationDays" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "PasswordExpirationDays")?.Value ?? "90")">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("تذكر كلمات المرور السابقة", "Remember previous passwords")</label>
                                <input type="number" name="PasswordHistoryCount" class="form-control" min="0" max="24"
                                       value="@(Model?.FirstOrDefault(s => s.Key == "PasswordHistoryCount")?.Value ?? "5")">
                            </div>
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input type="hidden" name="PasswordRequireUppercase" value="false" />
                                            <input type="checkbox" name="PasswordRequireUppercase" value="true" class="form-check-input" 
                                                   @(Model?.FirstOrDefault(s => s.Key == "PasswordRequireUppercase")?.Value != "false" ? "checked" : "")>
                                            <label class="form-check-label">@Html.T("أحرف كبيرة", "Uppercase")</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input type="hidden" name="PasswordRequireLowercase" value="false" />
                                            <input type="checkbox" name="PasswordRequireLowercase" value="true" class="form-check-input" 
                                                   @(Model?.FirstOrDefault(s => s.Key == "PasswordRequireLowercase")?.Value != "false" ? "checked" : "")>
                                            <label class="form-check-label">@Html.T("أحرف صغيرة", "Lowercase")</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input type="hidden" name="PasswordRequireDigit" value="false" />
                                            <input type="checkbox" name="PasswordRequireDigit" value="true" class="form-check-input" 
                                                   @(Model?.FirstOrDefault(s => s.Key == "PasswordRequireDigit")?.Value != "false" ? "checked" : "")>
                                            <label class="form-check-label">@Html.T("أرقام", "Numbers")</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check form-switch">
                                            <input type="hidden" name="PasswordRequireSpecialChar" value="false" />
                                            <input type="checkbox" name="PasswordRequireSpecialChar" value="true" class="form-check-input" 
                                                   @(Model?.FirstOrDefault(s => s.Key == "PasswordRequireSpecialChar")?.Value != "false" ? "checked" : "")>
                                            <label class="form-check-label">@Html.T("رموز خاصة", "Special characters")</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Security -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-log-in me-2"></i>@Html.T("أمان تسجيل الدخول", "Login security")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("الحد الأقصى للمحاولات", "Max attempts")</label>
                                <input type="number" name="MaxLoginAttempts" class="form-control" min="1" max="10"
                                       value="@(Model?.FirstOrDefault(s => s.Key == "MaxLoginAttempts")?.Value ?? "5")">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("مدة الحظر (دقائق)", "Lockout duration (min)")</label>
                                <input type="number" name="LockoutDurationMinutes" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "LockoutDurationMinutes")?.Value ?? "30")">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("مهلة الجلسة (دقائق)", "Session timeout (min)")</label>
                                <input type="number" name="SessionTimeoutMinutes" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "SessionTimeoutMinutes")?.Value ?? "60")">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input type="hidden" name="SingleSessionOnly" value="false" />
                                    <input type="checkbox" name="SingleSessionOnly" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "SingleSessionOnly")?.Value == "true" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("جلسة واحدة فقط لكل مستخدم", "Single session per user")</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="hidden" name="RequireEmailVerification" value="false" />
                                    <input type="checkbox" name="RequireEmailVerification" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "RequireEmailVerification")?.Value != "false" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("التحقق من البريد الإلكتروني", "Email verification required")</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two-Factor Authentication -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-smartphone me-2"></i>@Html.T("المصادقة الثنائية", "Two-factor authentication")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">@Html.T("طرق المصادقة المتاحة", "Available auth methods")</label>
                                <input type="text" name="TwoFactorMethods" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "TwoFactorMethods")?.Value ?? "Email,Authenticator")"
                                       placeholder="@Html.T("البريد،المصادقة،SMS", "Email,Authenticator,SMS")">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input type="hidden" name="TwoFactorEnabled" value="false" />
                                    <input type="checkbox" name="TwoFactorEnabled" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "TwoFactorEnabled")?.Value != "false" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("تفعيل المصادقة الثنائية", "Enable two-factor")</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="hidden" name="TwoFactorRequired" value="false" />
                                    <input type="checkbox" name="TwoFactorRequired" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "TwoFactorRequired")?.Value == "true" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("إلزامية للجميع", "Required for all")</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IP Security -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-globe me-2"></i>@Html.T("أمان IP", "IP security")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">@Html.T("عناوين IP المسموحة", "Allowed IPs")</label>
                                <textarea name="IpWhitelist" class="form-control" rows="2" 
                                          placeholder="@Html.T("192.168.1.1, 10.0.0.0/24", "192.168.1.1, 10.0.0.0/24")">@Model?.FirstOrDefault(s => s.Key == "IpWhitelist")?.Value</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("حد المحاولات المشبوهة", "Suspicious attempt threshold")</label>
                                <input type="number" name="SuspiciousAttemptThreshold" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "SuspiciousAttemptThreshold")?.Value ?? "10")">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input type="hidden" name="IpWhitelistEnabled" value="false" />
                                    <input type="checkbox" name="IpWhitelistEnabled" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "IpWhitelistEnabled")?.Value == "true" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("تفعيل القائمة البيضاء", "Enable whitelist")</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="hidden" name="AutoBlockSuspiciousIps" value="false" />
                                    <input type="checkbox" name="AutoBlockSuspiciousIps" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "AutoBlockSuspiciousIps")?.Value != "false" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("حظر تلقائي للعناوين المشبوهة", "Auto-block suspicious IPs")</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SSL/HTTPS -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-lock me-2"></i>@Html.T("SSL/HTTPS", "SSL/HTTPS")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("HSTS Max Age (أيام)", "HSTS Max Age (days)")</label>
                                <input type="number" name="HstsMaxAgeDays" class="form-control" 
                                       value="@(Model?.FirstOrDefault(s => s.Key == "HstsMaxAge")?.Value ?? "365")">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input type="hidden" name="ForceHttps" value="false" />
                                    <input type="checkbox" name="ForceHttps" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "ForceHttps")?.Value != "false" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("فرض HTTPS", "Force HTTPS")</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="hidden" name="HstsEnabled" value="false" />
                                    <input type="checkbox" name="HstsEnabled" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "HstsEnabled")?.Value != "false" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("تفعيل HSTS", "Enable HSTS")</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CAPTCHA -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="feather-shield me-2"></i>@Html.T("CAPTCHA", "CAPTCHA")</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("مزود CAPTCHA", "CAPTCHA provider")</label>
                                @{
                                    var captchaProvider = Model?.FirstOrDefault(s => s.Key == "CaptchaProvider")?.Value;
                                }
                                <select name="CaptchaProvider" class="form-select">
                                    <option value="reCAPTCHA" selected="@(captchaProvider == "reCAPTCHA")">@Html.T("Google reCAPTCHA", "Google reCAPTCHA")</option>
                                    <option value="hCaptcha" selected="@(captchaProvider == "hCaptcha")">@Html.T("hCaptcha", "hCaptcha")</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mt-4">
                                    <input type="hidden" name="CaptchaEnabled" value="false" />
                                    <input type="checkbox" name="CaptchaEnabled" value="true" class="form-check-input" 
                                           @(Model?.FirstOrDefault(s => s.Key == "CaptchaEnabled")?.Value == "true" ? "checked" : "")>
                                    <label class="form-check-label">@Html.T("تفعيل CAPTCHA", "Enable CAPTCHA")</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("مفتاح الموقع", "Site Key")</label>
                                <input type="text" name="CaptchaSiteKey" class="form-control" 
                                       value="@Model?.FirstOrDefault(s => s.Key == "CaptchaSiteKey")?.Value">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Html.T("المفتاح السري", "Secret Key")</label>
                                <input type="password" name="CaptchaSecretKey" class="form-control" 
                                       value="@Model?.FirstOrDefault(s => s.Key == "CaptchaSecretKey")?.Value">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="feather-save me-2"></i>@Html.T("حفظ الإعدادات", "Save settings")
            </button>
            <a asp-action="AuditLog" class="btn btn-outline-secondary">
                <i class="feather-file-text me-2"></i>@Html.T("سجل الأمان", "Security log")
            </a>
        </div>
    </form>
</div>

