@model IEnumerable<LMS.Domain.Entities.Financial.InstructorEarning>

@{
    var instructor = ViewBag.Instructor as LMS.Domain.Entities.Users.InstructorProfile;
    ViewData["Title"] = Html.T("أرباح المدرس", "Instructor Earnings") + $" - {instructor?.User?.FirstName} {instructor?.User?.LastName}";
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة المدرسين", "Instructors"), Url.Action("Index", "Instructors")),
        ($"{instructor?.User?.FirstName} {instructor?.User?.LastName}", Url.Action("Details", "Instructors", new { id = instructor?.UserId })),
        (Html.T("الأرباح", "Earnings"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl bg-soft-primary text-primary">
                        @(instructor?.User?.FirstName?.Substring(0, 1) ?? "")@(instructor?.User?.LastName?.Substring(0, 1) ?? "")
                    </div>
                    <div>
                        <h4 class="mb-1">@instructor?.User?.FirstName @instructor?.User?.LastName</h4>
                        <p class="text-muted mb-0">@Html.T("نسبة العمولة", "Commission rate"): @(instructor?.CommissionRate ?? 70)%</p>
                    </div>
                </div>
                <a href="@Url.Action("Details", "Instructors", new { id = instructor?.UserId })" class="btn btn-light-brand">
                    <i class="feather-arrow-right me-2"></i>
                    @Html.T("عودة للتفاصيل", "Back to details")
                </a>
            </div>
        </div>
    </div>

    <!-- Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <input type="hidden" name="id" value="@instructor?.UserId" />
                <div class="col-md-4">
                    <label class="form-label">@Html.T("من تاريخ", "From date")</label>
                    <input type="date" name="from" class="form-control" value="@(((DateTime?)ViewBag.From)?.ToString("yyyy-MM-dd"))" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">@Html.T("إلى تاريخ", "To date")</label>
                    <input type="date" name="to" class="form-control" value="@(((DateTime?)ViewBag.To)?.ToString("yyyy-MM-dd"))" />
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="feather-filter me-2"></i>@Html.T("تصفية", "Filter")
                    </button>
                    <a href="@Url.Action("Earnings", new { id = instructor?.UserId })" class="btn btn-light">@Html.T("إعادة تعيين", "Reset")</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Stats -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                            <i class="feather-dollar-sign"></i>
                        </div>
                        <div>
                            <span class="text-muted">@Html.T("إجمالي الأرباح", "Total earnings")</span>
                            <h3 class="fw-bold text-success mb-0">$@(((decimal?)ViewBag.TotalNetAmount ?? 0).ToString("N2"))</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                            <i class="feather-credit-card"></i>
                        </div>
                        <div>
                            <span class="text-muted">@Html.T("إجمالي المبيعات", "Total sales")</span>
                            <h3 class="fw-bold mb-0">$@(((decimal?)ViewBag.TotalGrossAmount ?? 0).ToString("N2"))</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-info text-info">
                            <i class="feather-trending-up"></i>
                        </div>
                        <div>
                            <span class="text-muted">@Html.T("الرصيد المتاح", "Available balance")</span>
                            <h3 class="fw-bold mb-0">$@(instructor?.AvailableBalance.ToString("N2") ?? "0.00")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings Table -->
    <div class="card stretch stretch-full">
        <div class="card-header">
            <h5 class="card-title">@Html.T("سجل الأرباح", "Earnings log")</h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>@Html.T("الدورة", "Course")</th>
                                <th>@Html.T("الطالب", "Student")</th>
                                <th>@Html.T("المبلغ الإجمالي", "Gross amount")</th>
                                <th>@Html.T("صافي الربح", "Net profit")</th>
                                <th>@Html.T("التاريخ", "Date")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var earning in Model)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("Details", "Courses", new { id = earning.CourseId })" class="fw-semibold">
                                            @(earning.Course?.Title ?? Html.T("دورة محذوفة", "Deleted course"))
                                        </a>
                                    </td>
                                    <td>
                                        @if (earning.Enrollment?.Student != null)
                                        {
                                            <span>@earning.Enrollment.Student.FirstName @earning.Enrollment.Student.LastName</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@Html.T("غير محدد", "Not specified")</span>
                                        }
                                    </td>
                                    <td>$@earning.GrossAmount.ToString("N2")</td>
                                    <td class="text-success fw-semibold">$@earning.NetAmount.ToString("N2")</td>
                                    <td>@earning.EarnedAt.ToString("dd/MM/yyyy hh:mm tt")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="avatar-text avatar-xl bg-soft-secondary text-secondary mx-auto mb-3">
                        <i class="feather-dollar-sign"></i>
                    </div>
                    <h5>@Html.T("لا توجد أرباح", "No earnings")</h5>
                    <p class="text-muted">@Html.T("لا توجد أرباح مسجلة في الفترة المحددة", "No earnings recorded for the selected period")</p>
                </div>
            }
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(ViewBag.Page == i ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Earnings", new { id = instructor?.UserId, from = ViewBag.From, to = ViewBag.To, page = i })">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

