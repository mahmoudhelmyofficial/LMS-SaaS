@model IEnumerable<LMS.Domain.Entities.Social.Review>

@{
    var instructor = ViewBag.Instructor as LMS.Domain.Entities.Users.InstructorProfile;
    ViewData["Title"] = Html.T("تقييمات المدرس", "Instructor Reviews") + $" - {instructor?.User?.FirstName} {instructor?.User?.LastName}";
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("إدارة المدرسين", "Instructors"), Url.Action("Index", "Instructors")),
        ($"{instructor?.User?.FirstName} {instructor?.User?.LastName}", Url.Action("Details", "Instructors", new { id = instructor?.UserId })),
        (Html.T("التقييمات", "Reviews"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl bg-soft-primary text-primary">
                        @(instructor?.User?.FirstName?.Substring(0, 1) ?? "")@(instructor?.User?.LastName?.Substring(0, 1) ?? "")
                    </div>
                    <div>
                        <h4 class="mb-1">@instructor?.User?.FirstName @instructor?.User?.LastName</h4>
                        <p class="text-muted mb-0">
                            <i class="feather-star text-warning me-1"></i>
                            @(((double?)ViewBag.AverageRating ?? 0).ToString("F1")) (@ViewBag.TotalReviews @Html.T("تقييم", "review(s)"))
                        </p>
                    </div>
                </div>
                <a href="@Url.Action("Details", "Instructors", new { id = instructor?.UserId })" class="btn btn-light-brand">
                    <i class="feather-arrow-right me-2"></i>
                    @Html.T("عودة للتفاصيل", "Back to details")
                </a>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body text-center">
                    <h1 class="display-4 fw-bold text-warning mb-0">@(((double?)ViewBag.AverageRating ?? 0).ToString("F1"))</h1>
                    <div class="mb-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= (int)Math.Round((double)(ViewBag.AverageRating ?? 0)))
                            {
                                <i class="feather-star text-warning"></i>
                            }
                            else
                            {
                                <i class="feather-star text-muted"></i>
                            }
                        }
                    </div>
                    <span class="text-muted">@ViewBag.TotalReviews @Html.T("تقييم", "review(s)")</span>
                </div>
            </div>
        </div>
        <div class="col-md-9 mb-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    @{
                        var reviews = Model.ToList();
                        var totalReviews = reviews.Count > 0 ? reviews.Count : 1;
                    }
                    @for (int rating = 5; rating >= 1; rating--)
                    {
                        var count = reviews.Count(r => (int)r.Rating == rating);
                        var percentage = (count * 100.0 / totalReviews);
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <span class="text-nowrap" style="width: 60px;">@rating @Html.T("نجوم", "stars")</span>
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: @percentage%"></div>
                            </div>
                            <span class="text-muted" style="width: 40px;">@count</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews List -->
    <div class="card stretch stretch-full">
        <div class="card-header">
            <h5 class="card-title">@Html.T("جميع التقييمات", "All reviews")</h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var review in Model)
                    {
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between mb-2">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-text avatar-md bg-soft-primary text-primary">
                                        @(review.Student?.FirstName?.Substring(0, 1) ?? "")@(review.Student?.LastName?.Substring(0, 1) ?? "")
                                    </div>
                                    <div>
                                        <h6 class="mb-0">@review.Student?.FirstName @review.Student?.LastName</h6>
                                        <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                                    </div>
                                </div>
                                <div>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= review.Rating)
                                        {
                                            <i class="feather-star text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="feather-star text-muted"></i>
                                        }
                                    }
                                </div>
                            </div>
                            <div class="mb-2">
                                <a href="@Url.Action("Details", "Courses", new { id = review.CourseId })" class="badge bg-soft-primary text-primary">
                                    @(review.Course?.Title ?? Html.T("دورة", "Course"))
                                </a>
                            </div>
                            @if (!string.IsNullOrEmpty(review.Comment))
                            {
                                <p class="mb-0 text-muted">@review.Comment</p>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="avatar-text avatar-xl bg-soft-secondary text-secondary mx-auto mb-3">
                        <i class="feather-star"></i>
                    </div>
                    <h5>@Html.T("لا توجد تقييمات", "No reviews")</h5>
                    <p class="text-muted">@Html.T("لم يحصل هذا المدرس على أي تقييمات بعد", "This instructor has no reviews yet")</p>
                </div>
            }
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(ViewBag.Page == i ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Reviews", new { id = instructor?.UserId, page = i })">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

