@model LMS.Domain.Entities.Social.Review

@{
    ViewData["Title"] = Html.T("تفاصيل التقييم", "Review details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التقييمات", "Reviews"), Url.Action("Index", "Reviews")),
        (Html.T("تفاصيل التقييم", "Review details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .review-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 1.5rem;
        }
        .review-comment {
            font-size: 1.1rem;
            line-height: 1.8;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-right: 4px solid #667eea;
        }
        .spam-indicator {
            animation: blink 2s infinite;
        }
        @@keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .helpfulness-badge {
            font-size: 0.85rem;
            padding: 5px 12px;
        }
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        .action-card {
            transition: all 0.3s;
        }
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Review Header -->
    <div class="review-header">
        <div class="d-flex align-items-start justify-content-between">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="rating-stars">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Model.Rating)
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            }
                        }
                    </div>
                    <h3 class="text-white mb-0">@Model.Rating / 5.0</h3>
                </div>
                <div class="d-flex align-items-center gap-2 mb-3">
                    @if (Model.IsApproved)
                    {
                        <span class="status-badge bg-success">
                            <i class="feather-check-circle"></i>
                            موافق عليه
                        </span>
                    }
                    else if (Model.IsRejected)
                    {
                        <span class="status-badge bg-danger">
                            <i class="feather-x-circle"></i>
                            مرفوض
                        </span>
                    }
                    else
                    {
                        <span class="status-badge bg-warning">
                            <i class="feather-clock"></i>
                            في الانتظار
                        </span>
                    }
                    @if (Model.IsPinned)
                    {
                        <span class="status-badge bg-info">
                            <i class="feather-anchor"></i>
                            مثبت
                        </span>
                    }
                </div>
            </div>
        </div>
        <div class="row g-3 text-white">
            <div class="col-md-3">
                <small class="text-white-50 d-block">@Html.T("الطالب", "Student")</small>
                <div class="d-flex align-items-center gap-2">
                    <i class="feather-user"></i>
                    <span class="fw-semibold">@Model.Student.FirstName @Model.Student.LastName</span>
                </div>
            </div>
            <div class="col-md-3">
                <small class="text-white-50 d-block">الدورة</small>
                <div class="d-flex align-items-center gap-2">
                    <i class="feather-book"></i>
                    <span class="fw-semibold">@Model.Course.Title</span>
                </div>
            </div>
            <div class="col-md-3">
                <small class="text-white-50 d-block">تاريخ التقييم</small>
                <div class="d-flex align-items-center gap-2">
                    <i class="feather-calendar"></i>
                    <span class="fw-semibold">@Model.CreatedAt.ToString("dd/MM/yyyy")</span>
                </div>
            </div>
            <div class="col-md-3">
                <small class="text-white-50 d-block">الفائدة</small>
                <div class="d-flex align-items-center gap-2">
                    <i class="feather-thumbs-up"></i>
                    <span class="fw-semibold">@Model.HelpfulCount مفيد</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Review Comment -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-message-square me-2"></i>
                        نص التقييم
                    </h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Comment))
                    {
                        <div class="review-comment">
                            <p class="mb-0">@Model.Comment</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="feather-info me-2"></i>
                            لم يترك الطالب تعليقاً مكتوباً
                        </div>
                    }
                </div>
            </div>

            <!-- Student & Course Info -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card stretch stretch-full">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="feather-user me-2"></i>
                                معلومات الطالب
                            </h5>
                        </div>
                        <div class="card-body">
                                            <div class="d-flex align-items-center gap-3 mb-4">
                                                <div class="avatar-text avatar-xl bg-soft-primary text-primary">
                                                    @(Model.Student?.FirstName?.Length > 0 ? Model.Student.FirstName.Substring(0, 1) : "")@(Model.Student?.LastName?.Length > 0 ? Model.Student.LastName.Substring(0, 1) : "")
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">@Model.Student?.FirstName @Model.Student?.LastName</h6>
                                                    <p class="text-muted mb-0">@Model.Student?.Email</p>
                                                </div>
                                            </div>
                            <div class="vstack gap-2">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">التقييمات السابقة:</span>
                                    <span class="fw-semibold">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">متوسط التقييمات:</span>
                                    <span class="fw-semibold">@Model.Rating / 5</span>
                                </div>
                                <a asp-controller="Users" asp-action="Details" asp-route-id="@Model.StudentId" class="btn btn-light-brand btn-sm mt-2">
                                    <i class="feather-external-link me-2"></i>
                                    عرض ملف الطالب
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card stretch stretch-full">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="feather-book me-2"></i>
                                معلومات الدورة
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6 class="mb-3">@Model.Course.Title</h6>
                            <div class="vstack gap-2">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">المدرس:</span>
                                    <span class="fw-semibold">@(Model.Course?.Instructor != null ? $"{Model.Course.Instructor.FirstName} {Model.Course.Instructor.LastName}" : "غير معروف")</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">متوسط التقييم:</span>
                                    <span class="fw-semibold">@Model.Course.AverageRating.ToString("F1") / 5</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">عدد التقييمات:</span>
                                    <span class="fw-semibold">@Model.Course.TotalReviews</span>
                                </div>
                                <a asp-controller="Courses" asp-action="Details" asp-route-id="@Model.CourseId" class="btn btn-light-brand btn-sm mt-2">
                                    <i class="feather-external-link me-2"></i>
                                    عرض الدورة
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Helpfulness Votes -->
            @if (Model.HelpfulnessVotes.Any())
            {
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-thumbs-up me-2"></i>
                            تصويتات الفائدة (@Model.HelpfulnessVotes.Count)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-center p-3 bg-soft-success rounded">
                                    <h3 class="text-success mb-1">@Model.HelpfulCount</h3>
                                    <small class="text-muted">صوتوا بـ "مفيد"</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3 bg-soft-danger rounded">
                                    <h3 class="text-danger mb-1">@Model.NotHelpfulCount</h3>
                                    <small class="text-muted">صوتوا بـ "غير مفيد"</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Approval/Rejection Info -->
            @if (Model.IsApproved || Model.IsRejected)
            {
                <div class="card stretch stretch-full">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-shield me-2"></i>
                            معلومات المراجعة
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.IsApproved)
                        {
                            <div class="alert alert-success mb-0">
                                <div class="d-flex align-items-start gap-3">
                                    <i class="feather-check-circle fs-3"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">تمت الموافقة على التقييم</h6>
                                        <p class="mb-1">التاريخ: @Model.ApprovedAt?.ToString("dd/MM/yyyy hh:mm tt")</p>
                                        <p class="mb-0">بواسطة: @(Model.ApprovedBy ?? "النظام")</p>
                                    </div>
                                </div>
                            </div>
                        }
                        @if (Model.IsRejected)
                        {
                            <div class="alert alert-danger mb-0">
                                <div class="d-flex align-items-start gap-3">
                                    <i class="feather-x-circle fs-3"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">تم رفض التقييم</h6>
                                        <p class="mb-1">التاريخ: @Model.RejectedAt?.ToString("dd/MM/yyyy hh:mm tt")</p>
                                        <p class="mb-1">بواسطة: @(Model.RejectedBy ?? "النظام")</p>
                                        @if (!string.IsNullOrEmpty(Model.RejectionReason))
                                        {
                                            <p class="mb-0"><strong>السبب:</strong> @Model.RejectionReason</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            @if (!Model.IsApproved && !Model.IsRejected)
            {
                <div class="card stretch stretch-full action-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title text-white mb-0">
                            <i class="feather-check me-2"></i>
                            الموافقة على التقييم
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">الموافقة على هذا التقييم ستجعله مرئياً لجميع المستخدمين</p>
                        <form asp-action="Approve" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success w-100">
                                <i class="feather-check-circle me-2"></i>
                                موافقة
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card stretch stretch-full action-card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title text-white mb-0">
                            <i class="feather-x me-2"></i>
                            رفض التقييم
                        </h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="Reject" asp-route-id="@Model.Id" method="post" id="rejectForm">
                            @Html.AntiForgeryToken()
                            <div class="form-group mb-3">
                                <label class="form-label">سبب الرفض <span class="text-danger">*</span></label>
                                <textarea name="reason" class="form-control" rows="3" placeholder="@Html.T("أدخل سبب رفض التقييم...", "Enter reason for rejecting the review...")" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="feather-x-circle me-2"></i>
                                رفض التقييم
                            </button>
                        </form>
                    </div>
                </div>
            }

            <!-- Pin/Unpin -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-anchor me-2"></i>
                        تثبيت التقييم
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.IsPinned)
                    {
                        <p class="text-muted mb-3">التقييم مثبت حالياً في أعلى قائمة التقييمات</p>
                        <form asp-action="TogglePin" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="feather-anchor me-2"></i>
                                إلغاء التثبيت
                            </button>
                        </form>
                    }
                    else
                    {
                        <p class="text-muted mb-3">تثبيت هذا التقييم سيجعله يظهر في الأعلى</p>
                        <form asp-action="TogglePin" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="feather-anchor me-2"></i>
                                تثبيت التقييم
                            </button>
                        </form>
                    }
                </div>
            </div>

            <!-- Statistics -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-bar-chart me-2"></i>
                        الإحصائيات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">التقييم:</span>
                            <div class="rating-stars" style="font-size: 1rem;">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Model.Rating)
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    }
                                }
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">مفيد:</span>
                            <span class="badge bg-soft-success text-success">@Model.HelpfulCount</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">غير مفيد:</span>
                            <span class="badge bg-soft-danger text-danger">@Model.NotHelpfulCount</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">الطول:</span>
                            <span class="fw-semibold">@(Model.Comment?.Length ?? 0) حرف</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Action -->
            <div class="card stretch stretch-full border-danger">
                <div class="card-header bg-soft-danger">
                    <h5 class="card-title text-danger mb-0">
                        <i class="feather-trash-2 me-2"></i>
                        منطقة الخطر
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">حذف هذا التقييم سيؤثر على تقييم الدورة الإجمالي</p>
                    <button type="button" class="btn btn-danger w-100" id="deleteBtn">
                        <i class="feather-trash-2 me-2"></i>
                        حذف التقييم
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation -->
<form asp-action="Delete" asp-route-id="@Model.Id" method="post" id="deleteForm">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        window.__ReviewsDetailsT = {
            deleteConfirm: '@Html.Raw(Html.T("هل أنت متأكد من حذف هذا التقييم؟ سيؤثر ذلك على تقييم الدورة الإجمالي ولا يمكن التراجع عن هذا الإجراء.", "Are you sure you want to delete this review? This will affect the course overall rating and cannot be undone.").Replace("'", "\\'"))',
            rejectConfirm: '@Html.Raw(Html.T("هل أنت متأكد من رفض هذا التقييم؟", "Are you sure you want to reject this review?").Replace("'", "\\'"))',
            rejectReason: '@Html.Raw(Html.T("يرجى إدخال سبب الرفض", "Please enter rejection reason").Replace("'", "\\'"))'
        };
        $(document).ready(function() {
            // Delete confirmation
            $('#deleteBtn').click(function() {
                if (confirm(window.__ReviewsDetailsT.deleteConfirm)) {
                $('#deleteForm').submit();
                }
            });

            // Reject form validation
            $('#rejectForm').on('submit', function(e) {
                const reason = $(this).find('textarea[name="reason"]').val().trim();
                if (!reason) {
                    e.preventDefault();
                    alert(window.__ReviewsDetailsT.rejectReason);
                    return false;
                }
                
                if (!confirm(window.__ReviewsDetailsT.rejectConfirm)) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

