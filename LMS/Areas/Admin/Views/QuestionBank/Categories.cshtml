@model IEnumerable<LMS.Domain.Entities.Assessments.QuestionCategory>

@{
    ViewData["Title"] = Html.T("تصنيفات الأسئلة", "Question Categories");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("التقييمات", "Assessments"), null),
        (Html.T("بنك الأسئلة", "Question Bank"), Url.Action("Index", "QuestionBank")),
        (Html.T("التصنيفات", "Categories"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .category-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }
        .category-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            transform: translateY(-3px);
            border-color: #3b82f6;
        }
        .category-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 1.5rem;
            margin: 0 auto 15px;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("إجمالي التصنيفات", "Total Categories")</div>
                            <h3 class="fw-bold mb-0">@Model.Count()</h3>
                        </div>
                        <div class="avatar-text bg-soft-primary text-primary avatar-lg">
                            <i class="feather-folder"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("بنوك الأسئلة", "Question Banks")</div>
                            <h3 class="fw-bold mb-0 text-success">@Model.Sum(c => c.QuestionBanks.Count)</h3>
                        </div>
                        <div class="avatar-text bg-soft-success text-success avatar-lg">
                            <i class="feather-database"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stretch stretch-full">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted mb-1">@Html.T("متوسط البنوك", "Avg. Banks")</div>
                            <h3 class="fw-bold mb-0 text-info">@(Model.Any() ? (Model.Sum(c => c.QuestionBanks.Count) / Model.Count()).ToString("0.0") : "0")</h3>
                        </div>
                        <div class="avatar-text bg-soft-info text-info avatar-lg">
                            <i class="feather-bar-chart"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Categories List -->
        <div class="col-lg-8">
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-list me-2"></i>
                        @Html.T("التصنيفات", "Categories") (@Model.Count())
                    </h5>
                    <div class="card-header-action">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                            <i class="feather-plus me-2"></i>
                            @Html.T("إضافة تصنيف", "Add Category")
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="row g-3">
                            @foreach (var category in Model.OrderBy(c => c.Name))
                            {
                                <div class="col-md-6">
                                    <div class="category-card">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="category-icon @(category.QuestionBanks.Count > 5 ? "bg-soft-success text-success" : "bg-soft-primary text-primary")">
                                                <i class="feather-folder"></i>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="feather-more-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <button type="button" class="dropdown-item" onclick="editCategory(@category.Id, '@category.Name', '@(category.Description ?? "")')">
                                                            <i class="feather-edit me-2"></i>
                                                            @Html.T("تعديل", "Edit")
                                                        </button>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" asp-action="Index" asp-route-categoryId="@category.Id">
                                                            <i class="feather-eye me-2"></i>
                                                            @Html.T("عرض البنوك", "View Banks")
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <button type="button" class="dropdown-item text-danger" onclick="deleteCategory(@category.Id)">
                                                            <i class="feather-trash-2 me-2"></i>
                                                            @Html.T("حذف", "Delete")
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <h6 class="fw-bold mb-2">@category.Name</h6>
                                        @if (!string.IsNullOrEmpty(category.Description))
                                        {
                                            <p class="text-muted small mb-3">@category.Description</p>
                                        }
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-soft-primary text-primary">
                                                <i class="feather-database me-1"></i>
                                                @category.QuestionBanks.Count @Html.T("بنك", "bank")
                                            </span>
                                            <small class="text-muted">
                                                <i class="feather-calendar me-1"></i>
                                                @category.CreatedAt.ToString("dd/MM/yyyy")
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="avatar-text bg-soft-secondary text-secondary avatar-xl mx-auto mb-3">
                                <i class="feather-folder" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="fw-bold mb-2">@Html.T("لا توجد تصنيفات", "No categories")</h5>
                            <p class="text-muted mb-4">@Html.T("ابدأ بإضافة تصنيف لتنظيم بنوك الأسئلة", "Start by adding a category to organize question banks")</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                <i class="feather-plus me-2"></i>
                                @Html.T("إضافة تصنيف جديد", "Add New Category")
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-pie-chart me-2"></i>
                        @Html.T("إحصائيات سريعة", "Quick Stats")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("إجمالي التصنيفات", "Total Categories"):</span>
                            <span class="fw-bold text-primary">@Model.Count()</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">@Html.T("إجمالي البنوك", "Total Banks"):</span>
                            <span class="fw-bold text-success">@Model.Sum(c => c.QuestionBanks.Count)</span>
                        </div>
                        @if (Model.Any())
                        {
                            var topCategory = Model.OrderByDescending(c => c.QuestionBanks.Count).FirstOrDefault();
                            if (topCategory != null)
                            {
                                <hr class="my-2">
                                <div>
                                    <small class="text-muted d-block mb-2">@Html.T("الأكثر استخداماً", "Most used"):</small>
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-semibold">@topCategory.Name</span>
                                        <span class="badge bg-soft-primary text-primary">@topCategory.QuestionBanks.Count</span>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-lightbulb me-2"></i>
                        @Html.T("نصائح", "Tips")
                    </h5>
                </div>
                <div class="card-body">
                    <div class="vstack gap-2">
                        <div class="alert alert-light mb-0">
                            <i class="feather-check me-2 text-success"></i>
                            <small>@Html.T("استخدم تصنيفات واضحة ومحددة", "Use clear and specific categories")</small>
                        </div>
                        <div class="alert alert-light mb-0">
                            <i class="feather-check me-2 text-success"></i>
                            <small>@Html.T("نظّم البنوك حسب المواضيع", "Organize banks by topic")</small>
                        </div>
                        <div class="alert alert-light mb-0">
                            <i class="feather-check me-2 text-success"></i>
                            <small>@Html.T("يمكنك تعديل التصنيفات لاحقاً", "You can edit categories later")</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-plus me-2"></i>
                    إضافة تصنيف جديد
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddCategory" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label">
                            @Html.T("اسم التصنيف", "Category Name") <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="name" class="form-control" placeholder="@Html.T("مثال: الرياضيات", "e.g. Mathematics")" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">@Html.T("الوصف", "Description")</label>
                        <textarea name="description" class="form-control" rows="3" placeholder="@Html.T("وصف مختصر للتصنيف (اختياري)", "Brief description (optional)")"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="feather-check me-2"></i>
                        @Html.T("حفظ", "Save")
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather-edit me-2"></i>
                    @Html.T("تعديل التصنيف", "Edit Category")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="EditCategory" method="post" id="editCategoryForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editCategoryId" />
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label">
                            @Html.T("اسم التصنيف", "Category Name") <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="name" id="editCategoryName" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">@Html.T("الوصف", "Description")</label>
                        <textarea name="description" id="editCategoryDescription" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">@Html.T("إلغاء", "Cancel")</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="feather-check me-2"></i>
                        @Html.T("حفظ التغييرات", "Save Changes")
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Form -->
<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function editCategory(id, name, description) {
            $('#editCategoryId').val(id);
            $('#editCategoryName').val(name);
            $('#editCategoryDescription').val(description || '');
            
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        }

        function deleteCategory(id) {
            if (confirm('@Html.Raw(Html.T("هل أنت متأكد من حذف هذا التصنيف؟ سيتم إلغاء ربط جميع البنوك المرتبطة به.", "Are you sure you want to delete this category? All linked banks will be unlinked.").Replace("'", "\\'"))')) {
                const form = document.getElementById('deleteForm');
                form.action = '@Url.Action("DeleteCategory", "QuestionBank")/' + id;
                form.submit();
            }
        }
    </script>
}

