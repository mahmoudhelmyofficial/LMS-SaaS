@model LMS.Areas.Admin.ViewModels.SmsSettingViewModel

@{
    ViewData["Title"] = Html.T("إعداد خدمة الرسائل النصية", "SMS service setup");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("الإعدادات", "Settings"), Url.Action("Index", "Settings")),
        (Html.T("إعدادات الرسائل النصية", "SMS settings"), Url.Action("Index", "SmsSettings")),
        (Html.T("إعداد جديد", "New setting"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .provider-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            height: 100%;
        }
        .provider-card:hover {
            border-color: #3454d1;
            box-shadow: 0 5px 15px rgba(52, 84, 209, 0.1);
        }
        .provider-card.selected {
            border-color: #3454d1;
            background: #f0f4ff;
        }
        .provider-logo {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            border-radius: 50%;
            font-size: 2rem;
        }
        .config-section {
            display: none;
        }
        .config-section.active {
            display: block;
        }
        .sms-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            position: sticky;
            top: 20px;
        }
        .phone-mockup {
            background: white;
            border-radius: 30px;
            padding: 40px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 300px;
            margin: 0 auto;
        }
        .message-bubble {
            background: #dcf8c6;
            color: #000;
            padding: 12px 15px;
            border-radius: 15px 15px 15px 0;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row">
        <div class="col-lg-8">
            <!-- Provider Selection -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-smartphone me-2"></i>اختر مزود الخدمة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="Twilio">
                                <div class="provider-logo bg-soft-danger text-danger">
                                    <i class="feather-message-circle"></i>
                                </div>
                                <h6 class="text-center mb-2">Twilio</h6>
                                <p class="text-muted small text-center mb-0">الأكثر شهرة عالمياً</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="Nexmo">
                                <div class="provider-logo bg-soft-primary text-primary">
                                    <i class="feather-send"></i>
                                </div>
                                <h6 class="text-center mb-2">Vonage (Nexmo)</h6>
                                <p class="text-muted small text-center mb-0">@Html.T("موثوق وسريع", "Reliable and fast")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="AWS SNS">
                                <div class="provider-logo bg-soft-warning text-warning">
                                    <i class="feather-cloud"></i>
                                </div>
                                <h6 class="text-center mb-2">AWS SNS</h6>
                                <p class="text-muted small text-center mb-0">Amazon Web Services</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="MessageBird">
                                <div class="provider-logo bg-soft-success text-success">
                                    <i class="feather-message-square"></i>
                                </div>
                                <h6 class="text-center mb-2">MessageBird</h6>
                                <p class="text-muted small text-center mb-0">@Html.T("أوروبي موثوق", "Reliable European")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="Plivo">
                                <div class="provider-logo bg-soft-info text-info">
                                    <i class="feather-phone"></i>
                                </div>
                                <h6 class="text-center mb-2">Plivo</h6>
                                <p class="text-muted small text-center mb-0">@Html.T("أسعار تنافسية", "Competitive pricing")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="provider-card" data-provider="Custom">
                                <div class="provider-logo bg-soft-secondary text-secondary">
                                    <i class="feather-settings"></i>
                                </div>
                                <h6 class="text-center mb-2">@Html.T("مخصص", "Custom")</h6>
                                <p class="text-muted small text-center mb-0">API مخصص</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-settings me-2"></i>إعدادات الاتصال
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="SaveSmsSetting" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Provider" id="providerInput" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="alert alert-info mb-4">
                            <i class="feather-info me-2"></i>
                            اختر مزود الخدمة أولاً لإظهار حقول الإعداد المناسبة
                        </div>

                        <!-- Common Fields -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="SenderName" class="form-label">
                                    اسم المرسل <span class="text-danger">*</span>
                                </label>
                                <input asp-for="SenderName" class="form-control" placeholder="@Html.T("مثال: MyLMS", "e.g. MyLMS")" maxlength="11" />
                                <span asp-validation-for="SenderName" class="text-danger"></span>
                                <small class="text-muted">الاسم الذي سيظهر للمستلم (حتى 11 حرف)</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="PhoneNumber" class="form-label">
                                    رقم الهاتف
                                </label>
                                <input asp-for="PhoneNumber" class="form-control" placeholder="+201234567890" />
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                <small class="text-muted">@Html.T("رقم الهاتف المسجل لدى المزود", "Phone number registered with the provider")</small>
                            </div>
                        </div>

                        <!-- Twilio Configuration -->
                        <div class="config-section" id="twilioConfig">
                            <h6 class="mb-3 text-primary">
                                <i class="feather-key me-2"></i>بيانات Twilio
                            </h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label asp-for="AccountSid" class="form-label">@Html.T("معرف الحساب", "Account SID")</label>
                                    <input asp-for="AccountSid" class="form-control" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                                    <span asp-validation-for="AccountSid" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ApiKey" class="form-label">@Html.T("رمز المصادقة", "Auth Token")</label>
                                    <input asp-for="ApiKey" type="password" class="form-control" />
                                    <span asp-validation-for="ApiKey" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Nexmo/Vonage Configuration -->
                        <div class="config-section" id="nexmoConfig">
                            <h6 class="mb-3 text-primary">
                                <i class="feather-key me-2"></i>بيانات Vonage (Nexmo)
                            </h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label asp-for="ApiKey" class="form-label">@Html.T("مفتاح API", "API Key")</label>
                                    <input asp-for="ApiKey" class="form-control" />
                                    <span asp-validation-for="ApiKey" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ApiSecret" class="form-label">@Html.T("سر API", "API Secret")</label>
                                    <input asp-for="ApiSecret" type="password" class="form-control" />
                                    <span asp-validation-for="ApiSecret" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- AWS SNS Configuration -->
                        <div class="config-section" id="awsConfig">
                            <h6 class="mb-3 text-primary">
                                <i class="feather-key me-2"></i>بيانات AWS SNS
                            </h6>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label asp-for="ApiKey" class="form-label">@Html.T("معرف مفتاح الوصول", "Access Key ID")</label>
                                    <input asp-for="ApiKey" class="form-control" />
                                    <span asp-validation-for="ApiKey" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ApiSecret" class="form-label">@Html.T("مفتاح الوصول السري", "Secret Access Key")</label>
                                    <input asp-for="ApiSecret" type="password" class="form-control" />
                                    <span asp-validation-for="ApiSecret" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- General Configuration -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="DefaultMessageType" class="form-label">@Html.T("نوع الرسالة الافتراضي", "Default message type")</label>
                                <select asp-for="DefaultMessageType" class="form-select">
                                    <option value="Transactional">معاملات (Transactional)</option>
                                    <option value="Promotional">ترويجية (Promotional)</option>
                                    <option value="OTP">رمز التحقق (OTP)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="MaxMessageLength" class="form-label">@Html.T("الحد الأقصى لطول الرسالة", "Maximum message length")</label>
                                <input asp-for="MaxMessageLength" type="number" class="form-control" value="160" min="70" max="1600" />
                                <small class="text-muted">عدد الأحرف المسموح (160 = رسالة واحدة)</small>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="DailyLimitPerUser" class="form-label">@Html.T("الحد اليومي لكل مستخدم", "Daily limit per user")</label>
                                <input asp-for="DailyLimitPerUser" type="number" class="form-control" value="10" min="1" max="100" />
                                <small class="text-muted">عدد الرسائل المسموح بها يومياً لكل مستخدم</small>
                            </div>
                            <div class="col-md-6">
                                <div class="mt-4 pt-2">
                                    <div class="form-check form-switch mb-2">
                                        <input asp-for="SupportsUnicode" class="form-check-input" type="checkbox" checked />
                                        <label class="form-check-label" asp-for="SupportsUnicode">
                                            @Html.T("دعم Unicode (العربية)", "Unicode Support (Arabic)")
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input asp-for="EnableDeliveryReports" class="form-check-input" type="checkbox" checked />
                                        <label class="form-check-label" asp-for="EnableDeliveryReports">
                                            تقارير التسليم
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Notes" class="form-label">@Html.T("ملاحظات", "Notes")</label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="@Html.T("أي ملاحظات إضافية حول الإعداد...", "Any additional notes about the setup...")"></textarea>
                        </div>

                        <div class="form-check form-switch mb-4">
                            <input asp-for="IsEnabled" class="form-check-input" type="checkbox" />
                            <label class="form-check-label" asp-for="IsEnabled">
                                تفعيل خدمة الرسائل النصية
                            </label>
                        </div>

                        <div class="alert alert-warning">
                            <i class="feather-alert-triangle me-2"></i>
                            <strong>تنبيه:</strong> تأكد من صحة البيانات قبل الحفظ. الإعدادات الخاطئة قد تمنع إرسال الرسائل.
                        </div>

                        <div class="d-flex gap-2 justify-content-end">
                            <a asp-action="SmsSettings" class="btn btn-light">
                                <i class="feather-x me-2"></i>إلغاء
                            </a>
                            <button type="button" class="btn btn-info" id="testBtn">
                                <i class="feather-zap me-2"></i>اختبار الاتصال
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="feather-save me-2"></i>@Html.T("حفظ الإعدادات", "Save settings")
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="sms-preview">
                <h5 class="text-white mb-4">
                    <i class="feather-smartphone me-2"></i>معاينة الرسالة
                </h5>
                
                <div class="phone-mockup">
                    <div class="text-center mb-3">
                        <small class="text-muted">10:30 AM</small>
                    </div>
                    <div class="message-bubble">
                        <strong id="previewSender">MyLMS</strong><br>
                        مرحباً! رمز التحقق الخاص بك هو: 123456<br>
                        <small class="text-muted">صالح لمدة 10 دقائق</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">تم التسليم ✓✓</small>
                    </div>
                </div>

                <div class="mt-4 bg-white bg-opacity-10 rounded p-3">
                    <h6 class="text-white mb-3">@Html.T("معلومات المزود", "Provider information")</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>@Html.T("المزود:", "Provider:")</span>
                        <span class="fw-bold" id="selectedProvider">@Html.T("لم يتم الاختيار", "Not selected")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>@Html.T("الحد اليومي:", "Daily limit:")</span>
                        <span class="fw-bold">10 رسائل</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>@Html.T("طول الرسالة:", "Message length:")</span>
                        <span class="fw-bold">160 حرف</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Provider selection
            $('.provider-card').on('click', function() {
                $('.provider-card').removeClass('selected');
                $(this).addClass('selected');
                
                const provider = $(this).data('provider');
                $('#providerInput').val(provider);
                $('#selectedProvider').text(provider);
                
                // Hide all config sections
                $('.config-section').removeClass('active');
                
                // Show relevant config section
                if (provider === 'Twilio') {
                    $('#twilioConfig').addClass('active');
                } else if (provider === 'Nexmo') {
                    $('#nexmoConfig').addClass('active');
                } else if (provider === 'AWS SNS') {
                    $('#awsConfig').addClass('active');
                }
            });

            // Update preview
            $('input[name="SenderName"]').on('input', function() {
                $('#previewSender').text($(this).val() || 'MyLMS');
            });

            // Test connection
            $('#testBtn').on('click', function() {
                const provider = $('#providerInput').val();
                if (!provider) {
                    alert('@Html.Raw(Html.T("يرجى اختيار مزود الخدمة أولاً", "Please select a service provider first").Replace("'", "\\'"))');
                    return;
                }
                
                $(this).prop('disabled', true).html('<i class="feather-loader me-2"></i>@Html.Raw(Html.T("جاري الاختبار...", "Testing...").Replace("'", "\\'"))');
                
                // Simulate test
                setTimeout(() => {
                    $(this).prop('disabled', false).html('<i class="feather-zap me-2"></i>@Html.Raw(Html.T("اختبار الاتصال", "Test connection").Replace("'", "\\'"))');
                    alert('@Html.Raw(Html.T("تم الاتصال بنجاح! ✓", "Connection successful! ✓").Replace("'", "\\'"))');
                }, 2000);
            });
        });
    </script>
}

