@model LMS.Domain.Entities.Analytics.ActivityLog

@{
    ViewData["Title"] = Html.T("تفاصيل سجل النشاط", "Activity log details");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("لوحة التحكم", "Dashboard"), Url.Action("Index", "Dashboard")),
        (Html.T("سجلات النشاط", "Activity logs"), Url.Action("Index", "ActivityLogs")),
        (Html.T("التفاصيل", "Details"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Styles {
    <style>
        .detail-card {
            border-left: 4px solid var(--bs-primary);
        }
        .json-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
    </style>
}

@await Html.PartialAsync("_PageHeader")

<div class="main-content">
    <div class="row">
        <!-- Main Details -->
        <div class="col-lg-8">
            <!-- Activity Overview -->
            <div class="card detail-card stretch stretch-full mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-start gap-3 mb-4">
                        <div class="activity-icon bg-soft-primary text-primary">
                            <i class="feather-activity"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h4 class="fw-bold mb-2">@Model.ActivityType</h4>
                            <p class="text-muted mb-3">@Model.Description</p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-soft-primary text-primary">
                                    <i class="feather-layers me-1"></i>@Model.EntityType
                                </span>
                                @if (!string.IsNullOrEmpty(Model.IpAddress))
                                {
                                    <span class="badge bg-soft-info text-info">
                                        <i class="feather-globe me-1"></i>@Model.IpAddress
                                    </span>
                                }
                                @if (!string.IsNullOrEmpty(Model.UserAgent))
                                {
                                    <span class="badge bg-soft-secondary text-secondary">
                                        <i class="feather-monitor me-1"></i>متصفح
                                    </span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2 p-3 bg-light rounded">
                                <i class="feather-calendar text-primary"></i>
                                <div>
                                    <p class="text-muted small mb-0">التاريخ والوقت</p>
                                    <p class="fw-semibold mb-0">@Model.Timestamp.ToString("yyyy/MM/dd - hh:mm:ss tt")</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2 p-3 bg-light rounded">
                                <i class="feather-user text-success"></i>
                                <div>
                                    <p class="text-muted small mb-0">المستخدم</p>
                                    <p class="fw-semibold mb-0">
                                        @if (Model.User != null)
                                        {
                                            @Model.User.FirstName @Model.User.LastName
                                        }
                                        else
                                        {
                                            <span class="text-muted">غير محدد</span>
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entity Information -->
            <div class="card stretch stretch-full mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-database me-2"></i>معلومات الكائن
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="text-muted" style="width: 200px;">نوع الكائن:</td>
                                    <td class="fw-semibold">@Model.EntityType</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">معرف الكائن:</td>
                                    <td class="fw-semibold">@(Model.EntityId?.ToString() ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">نوع النشاط:</td>
                                    <td>
                                        <span class="badge bg-primary">@Model.ActivityType</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Additional Data -->
            @if (!string.IsNullOrEmpty(Model.AdditionalData))
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-code me-2"></i>بيانات إضافية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="json-viewer">@Model.AdditionalData</div>
                    </div>
                </div>
            }

            <!-- User Agent Details -->
            @if (!string.IsNullOrEmpty(Model.UserAgent))
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-monitor me-2"></i>معلومات المتصفح
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="font-monospace small text-break">@Model.UserAgent</p>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="card stretch stretch-full mb-4" style="position: sticky; top: 20px;">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-settings me-2"></i>إجراءات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Index" class="btn btn-light">
                            <i class="feather-arrow-right me-2"></i>العودة للقائمة
                        </a>
                        @if (Model.User != null)
                        {
                            <a asp-controller="Users" asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-outline-primary">
                                <i class="feather-user me-2"></i>عرض المستخدم
                            </a>
                        }
                        @if (Model.EntityId != null)
                        {
                            <button class="btn btn-outline-info" onclick="copyEntityId()">
                                <i class="feather-copy me-2"></i>نسخ معرف الكائن
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- User Info Card -->
            @if (Model.User != null)
            {
                <div class="card stretch stretch-full mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="feather-user me-2"></i>المستخدم
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="avatar-text avatar-xl bg-soft-primary text-primary mx-auto mb-3">
                            <span class="fs-4">@Model.User.FirstName.Substring(0, 1)@Model.User.LastName.Substring(0, 1)</span>
                        </div>
                        <h6 class="fw-bold mb-1">@Model.User.FirstName @Model.User.LastName</h6>
                        <p class="text-muted small mb-3">@Model.User.Email</p>
                        <a asp-controller="Users" asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-sm btn-primary">
                            عرض الملف الشخصي
                        </a>
                    </div>
                </div>
            }

            <!-- Timeline Context -->
            <div class="card stretch stretch-full">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-clock me-2"></i>السياق الزمني
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted small">منذ</span>
                        <strong class="small">@((DateTime.UtcNow - Model.Timestamp).Days) يوم</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted small">التاريخ</span>
                        <strong class="small">@Model.Timestamp.ToString("yyyy/MM/dd")</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted small">الوقت</span>
                        <strong class="small">@Model.Timestamp.ToString("hh:mm:ss tt")</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function copyEntityId() {
            const entityId = '@Model.EntityId';
            navigator.clipboard.writeText(entityId).then(function() {
                alert('@Html.Raw(Html.T("تم نسخ معرف الكائن:", "Entity ID copied:").Replace("'", "\\'"))' + ' ' + entityId);
            }, function(err) {
                console.error('فشل النسخ: ', err);
            });
        }

        // Format JSON if exists
        $(document).ready(function() {
            $('.json-viewer').each(function() {
                try {
                    const content = $(this).text();
                    const parsed = JSON.parse(content);
                    $(this).text(JSON.stringify(parsed, null, 2));
                } catch(e) {
                    // Not JSON, keep as is
                }
            });
        });
    </script>
}

