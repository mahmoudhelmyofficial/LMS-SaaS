@model IEnumerable<LMS.Domain.Entities.Settings.PaymentGatewaySetting>

@{
    ViewData["Title"] = Html.T("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹", "Payment gateway settings");
    var breadcrumbs = new List<(string Name, string? Url)>
    {
        (Html.T("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "Settings"), null),
        (Html.T("Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹", "Payment gateways"), null)
    };
    ViewData["Breadcrumbs"] = breadcrumbs;
    ViewData["ShowStats"] = true;
    var actions = new List<(string Text, string Icon, string Url, string? CssClass)>
    {
        (Html.T("Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹", "Add payment gateway"), "feather-plus", Url.Action("Create", "PaymentGatewaySettings"), "btn-primary")
    };
    ViewData["HeaderActions"] = actions;
}

@await Html.PartialAsync("_PageHeader")

@section StatsCards {
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-text avatar-xl rounded bg-soft-primary text-primary">
                            <i class="feather-credit-card"></i>
                        </div>
                        <div>
                            <span class="text-truncate-1-line">@Html.T("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª", "Total gateways")</span>
                            <h3 class="fw-bolder d-block">@Model.Count().ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-success text-success">
                        <i class="feather-check-circle"></i>
                    </div>
                    <div>
                        <span class="text-truncate-1-line">@Html.T("Ù…ÙØ¹Ù„Ø©", "Enabled")</span>
                        <h3 class="fw-bolder d-block">@Model.Count(g => g.IsEnabled).ToString("N0")</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-warning text-warning">
                        <i class="feather-settings"></i>
                    </div>
                    <div>
                        <span class="text-truncate-1-line">@Html.T("ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø©", "Test mode")</span>
                        <h3 class="fw-bolder d-block">@Model.Count(g => g.IsTestMode).ToString("N0")</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-md-6">
        <div class="card stretch stretch-full">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="avatar-text avatar-xl rounded bg-soft-danger text-danger">
                        <i class="feather-x-circle"></i>
                    </div>
                    <div>
                        <span class="text-truncate-1-line">@Html.T("Ù…Ø¹Ø·Ù„Ø©", "Disabled")</span>
                        <h3 class="fw-bolder d-block">@Model.Count(g => !g.IsEnabled).ToString("N0")</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Main Content -->
<div class="main-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="card stretch stretch-full">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>@Html.T("Ø§Ù„ØªØ±ØªÙŠØ¨", "Order")</th>
                                    <th>@Html.T("Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©", "Gateway")</th>
                                    <th>@Html.T("Ø§Ù„Ù†ÙˆØ¹", "Type")</th>
                                    <th>@Html.T("Ø§Ù„Ø­Ø¯ÙˆØ¯", "Limits")</th>
                                    <th>@Html.T("Ø§Ù„Ø±Ø³ÙˆÙ…", "Fees")</th>
                                    <th>@Html.T("Ø§Ù„ÙˆØ¶Ø¹", "Mode")</th>
                                    <th>@Html.T("Ø§Ù„Ø­Ø§Ù„Ø©", "Status")</th>
                                    <th class="text-end">@Html.T("Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", "Actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var gateway in Model.OrderBy(g => g.DisplayOrder))
                                {
                                    <tr>
                                        <td>
                                            <span class="fw-bold">#@gateway.DisplayOrder</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-3">
                                            <div class="avatar-text avatar-md bg-soft-primary text-primary">
                                                @switch (gateway.GatewayType)
                                                {
                                                    case LMS.Domain.Enums.PaymentGatewayType.Stripe:
                                                        <i class="feather-credit-card"></i>
                                                        break;
                                                    case LMS.Domain.Enums.PaymentGatewayType.PayPal:
                                                        <i class="feather-dollar-sign"></i>
                                                        break;
                                                    default:
                                                        <i class="feather-shopping-cart"></i>
                                                        break;
                                                }
                                            </div>
                                                <div>
                                                    <div class="fw-bold text-dark">@gateway.DisplayName</div>
                                                    <div class="fs-12 text-muted">@gateway.GatewayName</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-soft-info text-info">@gateway.GatewayType</span>
                                        </td>
                                        <td>
                                            <div class="fs-12">
                                                <div><strong>@Html.T("Ø£Ø¯Ù†Ù‰", "Min"):</strong> @gateway.MinimumAmount.ToEGP()</div>
                                                <div><strong>@Html.T("Ø£Ù‚ØµÙ‰", "Max"):</strong> @gateway.MaximumAmount.ToEGP()</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                @if (gateway.TransactionFeePercentage > 0)
                                                {
                                                    <span class="badge bg-soft-warning text-warning">@gateway.TransactionFeePercentage%</span>
                                                }
                                                @if (gateway.TransactionFeeFixed > 0)
                                                {
                                                    <span class="badge bg-soft-warning text-warning">+@gateway.TransactionFeeFixed.ToEGP()</span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            @if (gateway.IsTestMode)
                                            {
                                                <span class="badge bg-soft-warning text-warning">
                                                    <i class="feather-alert-triangle fs-12 me-1"></i>
                                                    ØªØ¬Ø±ÙŠØ¨ÙŠ
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-soft-success text-success">
                                                    <i class="feather-zap fs-12 me-1"></i>
                                                    Ù…Ø¨Ø§Ø´Ø±
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (gateway.IsEnabled)
                                            {
                                                <span class="badge bg-soft-success text-success">
                                                    <i class="feather-check-circle fs-12 me-1"></i>
                                                    Ù…ÙØ¹Ù„Ø©
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-soft-danger text-danger">
                                                    <i class="feather-x-circle fs-12 me-1"></i>
                                                    Ù…Ø¹Ø·Ù„Ø©
                                                </span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="hstack gap-2 justify-content-end">
                                                <a href="@Url.Action("Edit", "PaymentGatewaySettings", new { id = gateway.Id })" class="avatar-text avatar-md" data-bs-toggle="tooltip" title="@Html.T("ØªØ¹Ø¯ÙŠÙ„", "Edit")">
                                                    <i class="feather-edit"></i>
                                                </a>
                                                <button type="button" class="avatar-text avatar-md border-0 bg-transparent test-gateway-btn" 
                                                        data-gateway-id="@gateway.Id" 
                                                        data-bs-toggle="tooltip" 
                                                        title="@Html.T("Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„", "Test connection")">
                                                    <i class="feather-wifi"></i>
                                                </button>
                                                <form method="post" action="@Url.Action("ToggleStatus", "PaymentGatewaySettings", new { id = gateway.Id })" style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="avatar-text avatar-md border-0 bg-transparent" data-bs-toggle="tooltip" title="@(gateway.IsEnabled ? Html.T("ØªØ¹Ø·ÙŠÙ„", "Disable") : Html.T("ØªÙØ¹ÙŠÙ„", "Enable"))">
                                                        <i class="feather-@(gateway.IsEnabled ? "toggle-right text-success" : "toggle-left text-muted")"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Setup Card -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="feather-zap me-2 text-warning"></i>
                        Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù†Ø·Ù‚Ø©
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-primary test-all-btn">
                        <i class="feather-check-circle me-1"></i>
                        Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">@Html.T("Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚ØªÙƒ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹", "Choose your target region to add recommended payment gateways automatically")</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <form method="post" action="@Url.Action("QuickSetup", new { region = "egypt" })">
                                @Html.AntiForgeryToken()
                                <div class="p-3 border rounded h-100">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="fs-3">ğŸ‡ªğŸ‡¬</span>
                                        <h6 class="mb-0">Ù…ØµØ±</h6>
                                    </div>
                                    <p class="text-muted fs-12 mb-2">Paymob + ÙÙˆØ±ÙŠ + ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</p>
                                    <button type="submit" class="btn btn-sm btn-primary w-100">
                                        <i class="feather-plus me-1"></i>
                                        Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø¨Ø§Øª Ù…ØµØ±
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <form method="post" action="@Url.Action("QuickSetup", new { region = "gulf" })">
                                @Html.AntiForgeryToken()
                                <div class="p-3 border rounded h-100">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="fs-3">ğŸ‡¸ğŸ‡¦</span>
                                        <h6 class="mb-0">@Html.T("Ø§Ù„Ø®Ù„ÙŠØ¬", "Gulf")</h6>
                                    </div>
                                    <p class="text-muted fs-12 mb-2">Tap + MyFatoorah + Hyperpay</p>
                                    <button type="submit" class="btn btn-sm btn-success w-100">
                                        <i class="feather-plus me-1"></i>
                                        Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø®Ù„ÙŠØ¬
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <form method="post" action="@Url.Action("QuickSetup", new { region = "international" })">
                                @Html.AntiForgeryToken()
                                <div class="p-3 border rounded h-100">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="fs-3">ğŸŒ</span>
                                        <h6 class="mb-0">@Html.T("Ø¯ÙˆÙ„ÙŠ", "International")</h6>
                                    </div>
                                    <p class="text-muted fs-12 mb-2">Stripe + PayPal</p>
                                    <button type="submit" class="btn btn-sm btn-info w-100">
                                        <i class="feather-plus me-1"></i>
                                        Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø¨Ø§Øª Ø¯ÙˆÙ„ÙŠØ©
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gateway Configuration Instructions -->
            <div class="card stretch stretch-full mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="feather-book-open me-2 text-info"></i>
                        ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="feather-credit-card text-primary"></i>
                                    <h6 class="mb-0">Paymob ğŸ‡ªğŸ‡¬</h6>
                                </div>
                                <p class="text-muted fs-12 mb-2">@Html.T("Ø¨Ø·Ø§Ù‚Ø§Øª + ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ + ÙÙˆØ±ÙŠ", "Cards + Vodafone Cash + Fawry")</p>
                                <a href="https://accept.paymob.com/portal2/en/settings" target="_blank" class="btn btn-sm btn-light w-100">
                                    <i class="feather-external-link me-1"></i>
                                    Paymob Portal
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="feather-shopping-bag text-success"></i>
                                    <h6 class="mb-0">Tap ğŸ‡¸ğŸ‡¦</h6>
                                </div>
                                <p class="text-muted fs-12 mb-2">@Html.T("Ø¬Ù…ÙŠØ¹ Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬ + Ù…Ø¯Ù‰ + Apple Pay", "All Gulf countries + Mada + Apple Pay")</p>
                                <a href="https://business.tap.company/" target="_blank" class="btn btn-sm btn-light w-100">
                                    <i class="feather-external-link me-1"></i>
                                    Tap Business
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="feather-file-text text-warning"></i>
                                    <h6 class="mb-0">MyFatoorah</h6>
                                </div>
                                <p class="text-muted fs-12 mb-2">KNET + Benefit + ÙƒÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬</p>
                                <a href="https://portal.myfatoorah.com/" target="_blank" class="btn btn-sm btn-light w-100">
                                    <i class="feather-external-link me-1"></i>
                                    MyFatoorah
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="feather-shield text-danger"></i>
                                    <h6 class="mb-0">@Html.T("Ø§Ù„Ø£Ù…Ø§Ù†", "Security")</h6>
                                </div>
                                <p class="text-muted fs-12 mb-2">@Html.T("Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ø´ÙØ±Ø© ÙˆÙ…Ø­ÙÙˆØ¸Ø©", "Keys are encrypted and stored")</p>
                                <span class="badge bg-soft-success text-success w-100 py-2">
                                    <i class="feather-lock me-1"></i>
                                    @Html.T("Ø¢Ù…Ù† 100%", "100% Secure")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.__GatewayT = {
            connectionSuccess: '@Html.Raw(Html.T("Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­! Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", "Connection successful! Gateway is working properly.").Replace("'", "\\'"))',
            connectionFailed: '@Html.Raw(Html.T("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„", "Connection failed").Replace("'", "\\'"))',
            errorTesting: '@Html.Raw(Html.T("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„", "An error occurred while testing the connection").Replace("'", "\\'"))',
            testing: '@Html.Raw(Html.T("Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...", "Testing...").Replace("'", "\\'"))',
            resultsTitle: '@Html.Raw(Html.T("Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª:", "Gateway test results:").Replace("'", "\\'"))',
            successLabel: '@Html.Raw(Html.T("Ù†Ø§Ø¬Ø­", "Success").Replace("'", "\\'"))',
            failLabel: '@Html.Raw(Html.T("ÙØ´Ù„", "Failed").Replace("'", "\\'"))',
            totalLabel: '@Html.Raw(Html.T("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Total").Replace("'", "\\'"))',
            noGateways: '@Html.Raw(Html.T("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙˆØ§Ø¨Ø§Øª Ø¯ÙØ¹ Ù…ÙØ¹Ù‘Ù„Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±", "No payment gateways enabled for testing").Replace("'", "\\'"))',
            errorTestingAll: '@Html.Raw(Html.T("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª", "An error occurred while testing gateways").Replace("'", "\\'"))'
        };
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();

            // Test gateway connection
            $('.test-gateway-btn').on('click', function() {
                var gatewayId = $(this).data('gateway-id');
                var btn = $(this);
                var originalHtml = btn.html();

                btn.html('<i class="feather-loader"></i>').prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("TestConnection", "PaymentGatewaySettings")',
                    method: 'POST',
                    data: { 
                        id: gatewayId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('âœ… ' + window.__GatewayT.connectionSuccess);
                        } else {
                            alert('âŒ ' + window.__GatewayT.connectionFailed + ': ' + (response.message || ''));
                        }
                    },
                    error: function() {
                        alert('âŒ ' + window.__GatewayT.errorTesting);
                    },
                    complete: function() {
                        btn.html(originalHtml).prop('disabled', false);
                    }
                });
            });

            // Test all gateways
            $('.test-all-btn').on('click', function() {
                var btn = $(this);
                var originalHtml = btn.html();

                btn.prop('disabled', true).html('<i class="feather-loader me-1"></i>' + window.__GatewayT.testing);

                $.ajax({
                    url: '@Url.Action("TestAll", "PaymentGatewaySettings")',
                    method: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').first().val()
                    },
                    success: function(response) {
                        if (response.results && response.results.length > 0) {
                            var message = window.__GatewayT.resultsTitle + '\n\n';
                            var successCount = 0;
                            var failCount = 0;
                            
                            response.results.forEach(function(r) {
                                if (r.success) {
                                    message += 'âœ… ' + r.name + ': ' + window.__GatewayT.successLabel;
                                    if (r.responseTimeMs) {
                                        message += ' (' + r.responseTimeMs + 'ms)';
                                    }
                                    successCount++;
                                } else {
                                    message += 'âŒ ' + r.name + ': ' + window.__GatewayT.failLabel;
                                    if (r.error) {
                                        message += ' - ' + r.error;
                                    }
                                    failCount++;
                                }
                                message += '\n';
                            });
                            
                            message += '\n---\n';
                            message += window.__GatewayT.totalLabel + ': ' + successCount + ' ' + window.__GatewayT.successLabel + 'ØŒ ' + failCount + ' ' + window.__GatewayT.failLabel;
                            
                            alert(message);
                        } else {
                            alert(window.__GatewayT.noGateways);
                        }
                    },
                    error: function() {
                        alert('âŒ ' + window.__GatewayT.errorTestingAll);
                    },
                    complete: function() {
                        btn.prop('disabled', false).html(originalHtml);
                    }
                });
            });
        });
    </script>
}

