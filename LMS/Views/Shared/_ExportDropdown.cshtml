@*
    Shared Export Dropdown Component
    قائمة تصدير منسدلة مشتركة
    
    Usage / الاستخدام:
    @await Html.PartialAsync("_ExportDropdown", new ExportDropdownModel 
    { 
        ExportUrl = "/api/export/users",
        EntityType = "users",
        AdditionalParams = new Dictionary<string, string> { { "courseId", courseId.ToString() } }
    })
*@

@model LMS.Views.Shared.ExportDropdownModel

@{
    var exportUrl = Model.ExportUrl ?? "";
    var buttonClass = Model.ButtonClass ?? "btn-light";
    var buttonText = Model.ButtonText ?? Html.T("تصدير", "Export");
    var showIcon = Model.ShowIcon;
    var dropdownAlign = Model.AlignRight ? "dropdown-menu-end" : "";
    
    // Build query string from additional params
    var queryString = "";
    if (Model.AdditionalParams != null && Model.AdditionalParams.Any())
    {
        queryString = "&" + string.Join("&", Model.AdditionalParams.Select(p => $"{p.Key}={p.Value}"));
    }
}

<div class="btn-group">
    <button type="button" class="btn @buttonClass dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        @if (showIcon)
        {
            <i class="feather-download me-2"></i>
        }
        @buttonText
    </button>
    <ul class="dropdown-menu @dropdownAlign">
        <li>
            <a class="dropdown-item export-link" href="@(exportUrl)?format=csv@(queryString)" data-format="csv">
                <i class="feather-file-text me-2 text-success"></i> 
                <span>CSV</span>
                <small class="text-muted ms-2">(@Html.T("Excel متوافق", "Excel compatible"))</small>
            </a>
        </li>
        <li>
            <a class="dropdown-item export-link" href="@(exportUrl)?format=excel@(queryString)" data-format="excel">
                <i class="feather-file me-2 text-primary"></i> 
                <span>Excel</span>
                <small class="text-muted ms-2">(.xlsx)</small>
            </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
            <a class="dropdown-item export-link" href="@(exportUrl)?format=pdf@(queryString)" data-format="pdf">
                <i class="feather-file-text me-2 text-danger"></i> 
                <span>PDF</span>
                <small class="text-muted ms-2">(@Html.T("للطباعة", "for printing"))</small>
            </a>
        </li>
    </ul>
</div>

@* Optional: Loading state script *@
@if (Model.ShowLoadingState)
{
    <script>
        document.querySelectorAll('.export-link').forEach(link => {
            link.addEventListener('click', function(e) {
                const btn = this.closest('.btn-group').querySelector('.dropdown-toggle');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>@Html.T("جاري التصدير...", "Exporting...")';
                btn.disabled = true;
                
                // Reset after download starts (approximate timing)
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            });
        });
    </script>
}

